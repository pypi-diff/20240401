# Comparing `tmp/distributed-2024.3.1.tar.gz` & `tmp/distributed-2024.4.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "distributed-2024.3.1.tar", last modified: Fri Mar 15 09:21:45 2024, max compression
+gzip compressed data, was "distributed-2024.4.0.tar", last modified: Mon Apr  1 19:35:18 2024, max compression
```

## Comparing `distributed-2024.3.1.tar` & `distributed-2024.4.0.tar`

### file list

```diff
@@ -1,308 +1,308 @@
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.896338 distributed-2024.3.1/
--rw-r--r--   0 fjetter    (501) staff       (20)      104 2023-03-15 12:38:26.000000 distributed-2024.3.1/AUTHORS.md
--rw-r--r--   0 fjetter    (501) staff       (20)     1533 2023-03-15 12:38:26.000000 distributed-2024.3.1/LICENSE.txt
--rw-r--r--   0 fjetter    (501) staff       (20)      633 2024-01-09 08:57:33.000000 distributed-2024.3.1/MANIFEST.in
--rw-r--r--   0 fjetter    (501) staff       (20)     3344 2024-03-15 09:21:45.896127 distributed-2024.3.1/PKG-INFO
--rw-r--r--   0 fjetter    (501) staff       (20)     1801 2023-04-24 12:42:45.000000 distributed-2024.3.1/README.rst
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.848478 distributed-2024.3.1/distributed/
--rw-r--r--   0 fjetter    (501) staff       (20)     4265 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2090 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/_asyncio.py
--rw-r--r--   0 fjetter    (501) staff       (20)     5528 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/_concurrent_futures_thread.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1325 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/_signals.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1459 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/_stories.py
--rw-r--r--   0 fjetter    (501) staff       (20)      500 2024-03-15 09:21:45.896475 distributed-2024.3.1/distributed/_version.py
--rw-r--r--   0 fjetter    (501) staff       (20)    29675 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/active_memory_manager.py
--rw-r--r--   0 fjetter    (501) staff       (20)     9538 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/actor.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7342 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/batched.py
--rw-r--r--   0 fjetter    (501) staff       (20)      121 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/bokeh.py
--rw-r--r--   0 fjetter    (501) staff       (20)     5742 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/cfexecutor.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1947 2023-08-07 15:14:12.000000 distributed-2024.3.1/distributed/chaos.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.852059 distributed-2024.3.1/distributed/cli/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/cli/__init__.py
--rwxr-xr-x   0 fjetter    (501) staff       (20)     7242 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/cli/dask_scheduler.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2104 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/cli/dask_spec.py
--rwxr-xr-x   0 fjetter    (501) staff       (20)     5468 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/cli/dask_ssh.py
--rwxr-xr-x   0 fjetter    (501) staff       (20)    16153 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/cli/dask_worker.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1092 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/cli/utils.py
--rw-r--r--   0 fjetter    (501) staff       (20)   213159 2024-03-15 08:40:36.000000 distributed-2024.3.1/distributed/client.py
--rw-r--r--   0 fjetter    (501) staff       (20)    10995 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/cluster_dump.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7099 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/collections.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.854443 distributed-2024.3.1/distributed/comm/
--rw-r--r--   0 fjetter    (501) staff       (20)      759 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/comm/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     8597 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/comm/addressing.py
--rw-r--r--   0 fjetter    (501) staff       (20)    12721 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/comm/core.py
--rw-r--r--   0 fjetter    (501) staff       (20)    10518 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/comm/inproc.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2815 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/comm/registry.py
--rw-r--r--   0 fjetter    (501) staff       (20)    26549 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/comm/tcp.py
--rw-r--r--   0 fjetter    (501) staff       (20)    23014 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/comm/ucx.py
--rw-r--r--   0 fjetter    (501) staff       (20)     3758 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/comm/utils.py
--rw-r--r--   0 fjetter    (501) staff       (20)    14903 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/comm/ws.py
--rw-r--r--   0 fjetter    (501) staff       (20)    10114 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/compatibility.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7826 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/config.py
--rw-r--r--   0 fjetter    (501) staff       (20)    61536 2024-03-11 09:50:24.000000 distributed-2024.3.1/distributed/core.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2134 2024-03-11 09:50:24.000000 distributed-2024.3.1/distributed/counter.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.856177 distributed-2024.3.1/distributed/dashboard/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/dashboard/__init__.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.857990 distributed-2024.3.1/distributed/dashboard/components/
--rw-r--r--   0 fjetter    (501) staff       (20)     1550 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/dashboard/components/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     5818 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/dashboard/components/nvml.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7154 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/dashboard/components/rmm.py
--rw-r--r--   0 fjetter    (501) staff       (20)   162551 2024-03-11 09:20:45.000000 distributed-2024.3.1/distributed/dashboard/components/scheduler.py
--rw-r--r--   0 fjetter    (501) staff       (20)    19429 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/dashboard/components/shared.py
--rw-r--r--   0 fjetter    (501) staff       (20)    15424 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/dashboard/components/worker.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2232 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/dashboard/core.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2313 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/dashboard/export_tool.js
--rw-r--r--   0 fjetter    (501) staff       (20)      763 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/dashboard/export_tool.py
--rw-r--r--   0 fjetter    (501) staff       (20)     5908 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/dashboard/scheduler.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.858270 distributed-2024.3.1/distributed/dashboard/templates/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/dashboard/templates/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)      241 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/dashboard/templates/performance_report.html
--rw-r--r--   0 fjetter    (501) staff       (20)      199 2023-09-11 13:57:10.000000 distributed-2024.3.1/distributed/dashboard/theme.yaml
--rw-r--r--   0 fjetter    (501) staff       (20)     1732 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/dashboard/utils.py
--rw-r--r--   0 fjetter    (501) staff       (20)      840 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/dashboard/worker.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.859868 distributed-2024.3.1/distributed/deploy/
--rw-r--r--   0 fjetter    (501) staff       (20)      466 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/deploy/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     6702 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/deploy/adaptive.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7895 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/deploy/adaptive_core.py
--rw-r--r--   0 fjetter    (501) staff       (20)    21271 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/deploy/cluster.py
--rw-r--r--   0 fjetter    (501) staff       (20)    10452 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/deploy/local.py
--rw-r--r--   0 fjetter    (501) staff       (20)    15514 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/deploy/old_ssh.py
--rw-r--r--   0 fjetter    (501) staff       (20)    23933 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/deploy/spec.py
--rw-r--r--   0 fjetter    (501) staff       (20)    15265 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/deploy/ssh.py
--rw-r--r--   0 fjetter    (501) staff       (20)     8543 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/deploy/subprocess.py
--rw-r--r--   0 fjetter    (501) staff       (20)      888 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/deploy/utils.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.862645 distributed-2024.3.1/distributed/diagnostics/
--rw-r--r--   0 fjetter    (501) staff       (20)      221 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/diagnostics/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1302 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/diagnostics/cluster_dump.py
--rw-r--r--   0 fjetter    (501) staff       (20)      564 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/diagnostics/cudf.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2190 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/diagnostics/eventstream.py
--rw-r--r--   0 fjetter    (501) staff       (20)     5207 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/diagnostics/graph_layout.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7017 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/diagnostics/memory_sampler.py
--rw-r--r--   0 fjetter    (501) staff       (20)     8138 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/diagnostics/memray.py
--rw-r--r--   0 fjetter    (501) staff       (20)    10781 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/diagnostics/nvml.py
--rw-r--r--   0 fjetter    (501) staff       (20)    33240 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/diagnostics/plugin.py
--rw-r--r--   0 fjetter    (501) staff       (20)    13904 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/diagnostics/progress.py
--rw-r--r--   0 fjetter    (501) staff       (20)     6063 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/diagnostics/progress_stream.py
--rw-r--r--   0 fjetter    (501) staff       (20)    15800 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/diagnostics/progressbar.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1124 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/diagnostics/rmm.py
--rw-r--r--   0 fjetter    (501) staff       (20)     5677 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/diagnostics/task_stream.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2513 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/diagnostics/websocket.py
--rw-r--r--   0 fjetter    (501) staff       (20)     9407 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/diskutils.py
--rw-r--r--   0 fjetter    (501) staff       (20)    48005 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/distributed-schema.yaml
--rw-r--r--   0 fjetter    (501) staff       (20)    15035 2024-03-11 09:20:45.000000 distributed-2024.3.1/distributed/distributed.yaml
--rw-r--r--   0 fjetter    (501) staff       (20)     8536 2024-01-23 10:57:05.000000 distributed-2024.3.1/distributed/event.py
--rw-r--r--   0 fjetter    (501) staff       (20)      586 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/exceptions.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.864381 distributed-2024.3.1/distributed/http/
--rw-r--r--   0 fjetter    (501) staff       (20)       84 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/http/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)      273 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/http/health.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1480 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/prometheus.py
--rw-r--r--   0 fjetter    (501) staff       (20)     4925 2024-03-15 08:51:38.000000 distributed-2024.3.1/distributed/http/proxy.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2548 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/routing.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.865402 distributed-2024.3.1/distributed/http/scheduler/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/scheduler/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2914 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/http/scheduler/api.py
--rw-r--r--   0 fjetter    (501) staff       (20)     8359 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/http/scheduler/info.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2159 2024-01-23 10:57:05.000000 distributed-2024.3.1/distributed/http/scheduler/json.py
--rw-r--r--   0 fjetter    (501) staff       (20)      625 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/scheduler/missing_bokeh.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.866053 distributed-2024.3.1/distributed/http/scheduler/prometheus/
--rw-r--r--   0 fjetter    (501) staff       (20)      291 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/scheduler/prometheus/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7080 2024-03-11 09:20:45.000000 distributed-2024.3.1/distributed/http/scheduler/prometheus/core.py
--rw-r--r--   0 fjetter    (501) staff       (20)     3514 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/scheduler/prometheus/semaphore.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1617 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/scheduler/prometheus/stealing.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.866283 distributed-2024.3.1/distributed/http/static/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/static/__init__.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.867369 distributed-2024.3.1/distributed/http/static/css/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/static/css/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2260 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/static/css/base.css
--rw-r--r--   0 fjetter    (501) staff       (20)      250 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/css/gpu.css
--rw-r--r--   0 fjetter    (501) staff       (20)      840 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/css/individual-cluster-map.css
--rw-r--r--   0 fjetter    (501) staff       (20)     1557 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/static/css/sortable.min.css
--rw-r--r--   0 fjetter    (501) staff       (20)     1012 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/css/status.css
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.868550 distributed-2024.3.1/distributed/http/static/images/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/static/images/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1607 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/http/static/images/dask-logo.svg
--rw-r--r--   0 fjetter    (501) staff       (20)      552 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/images/fa-bars.svg
--rw-r--r--   0 fjetter    (501) staff       (20)    15086 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/http/static/images/favicon.ico
--rw-r--r--   0 fjetter    (501) staff       (20)    11002 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/static/images/jupyter.svg
--rw-r--r--   0 fjetter    (501) staff       (20)    18663 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/images/numpy.png
--rw-r--r--   0 fjetter    (501) staff       (20)     1213 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/images/pandas.png
--rw-r--r--   0 fjetter    (501) staff       (20)   830916 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/images/python.png
--rw-r--r--   0 fjetter    (501) staff       (20)      667 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/individual-cluster-map.html
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.870889 distributed-2024.3.1/distributed/http/static/js/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/static/js/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)    17271 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/js/anime.min.js
--rw-r--r--   0 fjetter    (501) staff       (20)     9337 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/js/individual-cluster-map.js
--rw-r--r--   0 fjetter    (501) staff       (20)     3276 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/static/js/reconnecting-websocket.min.js
--rw-r--r--   0 fjetter    (501) staff       (20)     1194 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/static/js/sortable.min.js
--rw-r--r--   0 fjetter    (501) staff       (20)      223 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/http/statics.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.872764 distributed-2024.3.1/distributed/http/templates/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/templates/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2930 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/templates/base.html
--rw-r--r--   0 fjetter    (501) staff       (20)      388 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/templates/call-stack.html
--rw-r--r--   0 fjetter    (501) staff       (20)     1351 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/templates/exceptions.html
--rw-r--r--   0 fjetter    (501) staff       (20)      404 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/templates/gpu.html
--rw-r--r--   0 fjetter    (501) staff       (20)      276 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/templates/json-index.html
--rw-r--r--   0 fjetter    (501) staff       (20)      116 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/templates/logs.html
--rw-r--r--   0 fjetter    (501) staff       (20)      522 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/templates/main.html
--rw-r--r--   0 fjetter    (501) staff       (20)       95 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/templates/simple.html
--rw-r--r--   0 fjetter    (501) staff       (20)      635 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/templates/status.html
--rw-r--r--   0 fjetter    (501) staff       (20)     5726 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/templates/task.html
--rw-r--r--   0 fjetter    (501) staff       (20)     1601 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/templates/worker-table.html
--rw-r--r--   0 fjetter    (501) staff       (20)     2034 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/templates/worker.html
--rw-r--r--   0 fjetter    (501) staff       (20)      457 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/templates/workers.html
--rw-r--r--   0 fjetter    (501) staff       (20)     1184 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/http/utils.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.872908 distributed-2024.3.1/distributed/http/worker/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/http/worker/__init__.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.873143 distributed-2024.3.1/distributed/http/worker/prometheus/
--rw-r--r--   0 fjetter    (501) staff       (20)      288 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/http/worker/prometheus/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)    10039 2024-03-11 09:20:45.000000 distributed-2024.3.1/distributed/http/worker/prometheus/core.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1170 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/itertools.py
--rw-r--r--   0 fjetter    (501) staff       (20)     5599 2024-01-23 10:57:05.000000 distributed-2024.3.1/distributed/lock.py
--rwxr-xr-x   0 fjetter    (501) staff       (20)    14386 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/metrics.py
--rw-r--r--   0 fjetter    (501) staff       (20)     8044 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/multi_lock.py
--rw-r--r--   0 fjetter    (501) staff       (20)    35124 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/nanny.py
--rw-r--r--   0 fjetter    (501) staff       (20)     6710 2024-01-23 10:57:05.000000 distributed-2024.3.1/distributed/node.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1449 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/objects.py
--rw-r--r--   0 fjetter    (501) staff       (20)     8356 2024-01-23 10:57:05.000000 distributed-2024.3.1/distributed/preloading.py
--rw-r--r--   0 fjetter    (501) staff       (20)    12887 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/process.py
--rw-r--r--   0 fjetter    (501) staff       (20)      931 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/proctitle.py
--rw-r--r--   0 fjetter    (501) staff       (20)    16996 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/profile.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.878176 distributed-2024.3.1/distributed/protocol/
--rw-r--r--   0 fjetter    (501) staff       (20)     3363 2024-01-17 17:06:15.000000 distributed-2024.3.1/distributed/protocol/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1336 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/protocol/arrow.py
--rw-r--r--   0 fjetter    (501) staff       (20)     6671 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/protocol/compression.py
--rw-r--r--   0 fjetter    (501) staff       (20)     6831 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/protocol/core.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1181 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/protocol/cuda.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2931 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/protocol/cupy.py
--rw-r--r--   0 fjetter    (501) staff       (20)      836 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/protocol/h5py.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1127 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/protocol/keras.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1466 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/protocol/netcdf4.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2139 2024-01-17 17:06:12.000000 distributed-2024.3.1/distributed/protocol/numba.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7030 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/protocol/numpy.py
--rw-r--r--   0 fjetter    (501) staff       (20)     3041 2024-01-17 17:06:14.000000 distributed-2024.3.1/distributed/protocol/pickle.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1507 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/protocol/rmm.py
--rw-r--r--   0 fjetter    (501) staff       (20)      792 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/protocol/scipy.py
--rw-r--r--   0 fjetter    (501) staff       (20)    29225 2024-02-15 10:26:13.000000 distributed-2024.3.1/distributed/protocol/serialize.py
--rw-r--r--   0 fjetter    (501) staff       (20)      955 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/protocol/sparse.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1993 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/protocol/torch.py
--rw-r--r--   0 fjetter    (501) staff       (20)     8314 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/protocol/utils.py
--rw-r--r--   0 fjetter    (501) staff       (20)      795 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/protocol/utils_test.py
--rw-r--r--   0 fjetter    (501) staff       (20)     3733 2024-03-13 14:29:11.000000 distributed-2024.3.1/distributed/publish.py
--rw-r--r--   0 fjetter    (501) staff       (20)    15643 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/pubsub.py
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/py.typed
--rw-r--r--   0 fjetter    (501) staff       (20)    10054 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/queues.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7419 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/recreate_tasks.py
--rw-r--r--   0 fjetter    (501) staff       (20)   324216 2024-03-15 08:40:36.000000 distributed-2024.3.1/distributed/scheduler.py
--rw-r--r--   0 fjetter    (501) staff       (20)    13867 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/security.py
--rw-r--r--   0 fjetter    (501) staff       (20)    20568 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/semaphore.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.881831 distributed-2024.3.1/distributed/shuffle/
--rw-r--r--   0 fjetter    (501) staff       (20)      674 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/shuffle/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     6287 2024-03-06 10:21:34.000000 distributed-2024.3.1/distributed/shuffle/_arrow.py
--rw-r--r--   0 fjetter    (501) staff       (20)     9330 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/shuffle/_buffer.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2481 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/shuffle/_comms.py
--rw-r--r--   0 fjetter    (501) staff       (20)    17734 2024-03-06 10:21:34.000000 distributed-2024.3.1/distributed/shuffle/_core.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7924 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/shuffle/_disk.py
--rw-r--r--   0 fjetter    (501) staff       (20)      180 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/shuffle/_exceptions.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2798 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/shuffle/_limiter.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1531 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/shuffle/_memory.py
--rw-r--r--   0 fjetter    (501) staff       (20)    14022 2024-03-06 10:21:34.000000 distributed-2024.3.1/distributed/shuffle/_merge.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1186 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/shuffle/_pickle.py
--rw-r--r--   0 fjetter    (501) staff       (20)    26857 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/shuffle/_rechunk.py
--rw-r--r--   0 fjetter    (501) staff       (20)    18440 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/shuffle/_scheduler_plugin.py
--rw-r--r--   0 fjetter    (501) staff       (20)    18581 2024-03-06 10:21:34.000000 distributed-2024.3.1/distributed/shuffle/_shuffle.py
--rw-r--r--   0 fjetter    (501) staff       (20)    14591 2024-03-06 10:21:31.000000 distributed-2024.3.1/distributed/shuffle/_worker_plugin.py
--rw-r--r--   0 fjetter    (501) staff       (20)      607 2023-04-24 12:42:45.000000 distributed-2024.3.1/distributed/sizeof.py
--rw-r--r--   0 fjetter    (501) staff       (20)    23191 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/spans.py
--rw-r--r--   0 fjetter    (501) staff       (20)    13767 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/spill.py
--rw-r--r--   0 fjetter    (501) staff       (20)    19711 2024-03-11 09:20:45.000000 distributed-2024.3.1/distributed/stealing.py
--rw-r--r--   0 fjetter    (501) staff       (20)     1952 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/system.py
--rw-r--r--   0 fjetter    (501) staff       (20)     8842 2024-03-11 09:20:45.000000 distributed-2024.3.1/distributed/system_monitor.py
--rw-r--r--   0 fjetter    (501) staff       (20)     7104 2023-05-16 09:36:16.000000 distributed-2024.3.1/distributed/threadpoolexecutor.py
--rw-r--r--   0 fjetter    (501) staff       (20)    57774 2024-03-06 10:21:34.000000 distributed-2024.3.1/distributed/utils.py
--rw-r--r--   0 fjetter    (501) staff       (20)    14792 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/utils_comm.py
--rw-r--r--   0 fjetter    (501) staff       (20)     8050 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/utils_perf.py
--rw-r--r--   0 fjetter    (501) staff       (20)    83093 2024-03-11 13:26:48.000000 distributed-2024.3.1/distributed/utils_test.py
--rw-r--r--   0 fjetter    (501) staff       (20)     8411 2024-01-23 10:57:05.000000 distributed-2024.3.1/distributed/variable.py
--rw-r--r--   0 fjetter    (501) staff       (20)     5165 2024-03-11 13:26:48.000000 distributed-2024.3.1/distributed/versions.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.881977 distributed-2024.3.1/distributed/widgets/
--rw-r--r--   0 fjetter    (501) staff       (20)      267 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/widgets/__init__.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.884909 distributed-2024.3.1/distributed/widgets/templates/
--rw-r--r--   0 fjetter    (501) staff       (20)        0 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/widgets/templates/__init__.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2265 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/widgets/templates/client.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)     1589 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/cluster.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)     1270 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/widgets/templates/computation.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)      518 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/future.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)      544 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/has_what.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)      234 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/local_cluster.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)      636 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/log.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)      168 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/logs.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)     1290 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/process_interface.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)      317 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/scheduler.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)     6705 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/widgets/templates/scheduler_info.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)      407 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/security.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)      448 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/task_state.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)      295 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/who_has.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)      407 2023-03-15 12:38:26.000000 distributed-2024.3.1/distributed/widgets/templates/worker_state.html.j2
--rw-r--r--   0 fjetter    (501) staff       (20)   124786 2024-03-11 17:45:13.000000 distributed-2024.3.1/distributed/worker.py
--rw-r--r--   0 fjetter    (501) staff       (20)     2568 2024-01-09 08:57:33.000000 distributed-2024.3.1/distributed/worker_client.py
--rw-r--r--   0 fjetter    (501) staff       (20)    21243 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/worker_memory.py
--rw-r--r--   0 fjetter    (501) staff       (20)   142682 2024-02-14 13:07:10.000000 distributed-2024.3.1/distributed/worker_state_machine.py
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.895863 distributed-2024.3.1/distributed.egg-info/
--rw-r--r--   0 fjetter    (501) staff       (20)     3344 2024-03-15 09:21:45.000000 distributed-2024.3.1/distributed.egg-info/PKG-INFO
--rw-r--r--   0 fjetter    (501) staff       (20)     8983 2024-03-15 09:21:45.000000 distributed-2024.3.1/distributed.egg-info/SOURCES.txt
--rw-r--r--   0 fjetter    (501) staff       (20)        1 2024-03-15 09:21:45.000000 distributed-2024.3.1/distributed.egg-info/dependency_links.txt
--rw-r--r--   0 fjetter    (501) staff       (20)      335 2024-03-15 09:21:45.000000 distributed-2024.3.1/distributed.egg-info/entry_points.txt
--rw-r--r--   0 fjetter    (501) staff       (20)        1 2024-03-15 09:21:45.000000 distributed-2024.3.1/distributed.egg-info/not-zip-safe
--rw-r--r--   0 fjetter    (501) staff       (20)      227 2024-03-15 09:21:45.000000 distributed-2024.3.1/distributed.egg-info/requires.txt
--rw-r--r--   0 fjetter    (501) staff       (20)       12 2024-03-15 09:21:45.000000 distributed-2024.3.1/distributed.egg-info/top_level.txt
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.823382 distributed-2024.3.1/docs/
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.895505 distributed-2024.3.1/docs/source/
--rw-r--r--   0 fjetter    (501) staff       (20)    11754 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/active_memory_manager.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     8000 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/actors.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     4343 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/api.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     3519 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/asynchronous.rst
--rw-r--r--   0 fjetter    (501) staff       (20)   275148 2024-02-14 13:07:10.000000 distributed-2024.3.1/docs/source/changelog.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     7137 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/client.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     3770 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/communications.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     7049 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/develop.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     6823 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/diagnosing-performance.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     3392 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/efficiency.rst
-drwxr-xr-x   0 fjetter    (501) staff       (20)        0 2024-03-15 09:21:45.895653 distributed-2024.3.1/docs/source/examples/
--rw-r--r--   0 fjetter    (501) staff       (20)     8953 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/examples/word-count.rst
--rw-r--r--   0 fjetter    (501) staff       (20)       75 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/examples-overview.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     4228 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/faq.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     9303 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/fine-performance-metrics.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     4613 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/foundations.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     4016 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/http_services.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     4460 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/index.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     1182 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/install.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     7293 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/journey.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     6470 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/killed.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     1828 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/limitations.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     6458 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/locality.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     2807 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/logging.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     6546 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/manage-computation.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     8550 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/memory.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     4282 2024-02-14 13:07:10.000000 distributed-2024.3.1/docs/source/plugins.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     3265 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/priority.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     7800 2024-03-11 09:20:45.000000 distributed-2024.3.1/docs/source/prometheus.rst
--rw-r--r--   0 fjetter    (501) staff       (20)    11199 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/protocol.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     3107 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/publish.rst
--rw-r--r--   0 fjetter    (501) staff       (20)      402 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/queues.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     2942 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/quickstart.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     8773 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/related-work.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     3418 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/resilience.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     6049 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/resources.rst
--rw-r--r--   0 fjetter    (501) staff       (20)    16084 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/scheduling-policies.rst
--rw-r--r--   0 fjetter    (501) staff       (20)    16893 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/scheduling-state.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     6518 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/serialization.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     4307 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/spans.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     8343 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/task-launch.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     4190 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/tls.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     5557 2023-03-15 12:38:26.000000 distributed-2024.3.1/docs/source/work-stealing.rst
--rw-r--r--   0 fjetter    (501) staff       (20)    13489 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/worker-memory.rst
--rw-r--r--   0 fjetter    (501) staff       (20)    22542 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/worker-state.rst
--rw-r--r--   0 fjetter    (501) staff       (20)     3467 2024-01-09 08:57:33.000000 distributed-2024.3.1/docs/source/worker.rst
--rw-r--r--   0 fjetter    (501) staff       (20)    10199 2024-03-15 08:56:03.000000 distributed-2024.3.1/pyproject.toml
--rw-r--r--   0 fjetter    (501) staff       (20)       38 2024-03-15 09:21:45.896372 distributed-2024.3.1/setup.cfg
--rw-r--r--   0 fjetter    (501) staff       (20)      171 2024-01-09 08:57:33.000000 distributed-2024.3.1/setup.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.144368 distributed-2024.4.0/
+-rw-r--r--   0 james      (501) staff       (20)      104 2023-07-17 19:50:47.000000 distributed-2024.4.0/AUTHORS.md
+-rw-r--r--   0 james      (501) staff       (20)     1533 2023-07-17 19:51:10.000000 distributed-2024.4.0/LICENSE.txt
+-rw-r--r--   0 james      (501) staff       (20)      633 2023-07-17 19:51:10.000000 distributed-2024.4.0/MANIFEST.in
+-rw-r--r--   0 james      (501) staff       (20)     3344 2024-04-01 19:35:18.144070 distributed-2024.4.0/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     1801 2023-07-17 19:51:10.000000 distributed-2024.4.0/README.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.092669 distributed-2024.4.0/distributed/
+-rw-r--r--   0 james      (501) staff       (20)     4265 2024-01-26 22:03:47.000000 distributed-2024.4.0/distributed/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2090 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/_asyncio.py
+-rw-r--r--   0 james      (501) staff       (20)     5528 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/_concurrent_futures_thread.py
+-rw-r--r--   0 james      (501) staff       (20)     1325 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/_signals.py
+-rw-r--r--   0 james      (501) staff       (20)     1459 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/_stories.py
+-rw-r--r--   0 james      (501) staff       (20)      500 2024-04-01 19:35:18.144754 distributed-2024.4.0/distributed/_version.py
+-rw-r--r--   0 james      (501) staff       (20)    29675 2023-12-01 22:10:13.000000 distributed-2024.4.0/distributed/active_memory_manager.py
+-rw-r--r--   0 james      (501) staff       (20)     9538 2024-01-12 19:19:58.000000 distributed-2024.4.0/distributed/actor.py
+-rw-r--r--   0 james      (501) staff       (20)     7342 2023-09-27 18:27:06.000000 distributed-2024.4.0/distributed/batched.py
+-rw-r--r--   0 james      (501) staff       (20)      121 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/bokeh.py
+-rw-r--r--   0 james      (501) staff       (20)     5742 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/cfexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)     1947 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/chaos.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.095509 distributed-2024.4.0/distributed/cli/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/cli/__init__.py
+-rwxr-xr-x   0 james      (501) staff       (20)     7242 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/cli/dask_scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)     2104 2023-10-23 15:00:29.000000 distributed-2024.4.0/distributed/cli/dask_spec.py
+-rwxr-xr-x   0 james      (501) staff       (20)     5468 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/cli/dask_ssh.py
+-rwxr-xr-x   0 james      (501) staff       (20)    16153 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/cli/dask_worker.py
+-rw-r--r--   0 james      (501) staff       (20)     1092 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/cli/utils.py
+-rw-r--r--   0 james      (501) staff       (20)   213262 2024-04-01 19:12:54.000000 distributed-2024.4.0/distributed/client.py
+-rw-r--r--   0 james      (501) staff       (20)    10995 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)     7099 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/collections.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.098050 distributed-2024.4.0/distributed/comm/
+-rw-r--r--   0 james      (501) staff       (20)      759 2023-12-01 22:10:13.000000 distributed-2024.4.0/distributed/comm/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     8597 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/comm/addressing.py
+-rw-r--r--   0 james      (501) staff       (20)    12721 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/comm/core.py
+-rw-r--r--   0 james      (501) staff       (20)    10518 2024-01-26 22:03:47.000000 distributed-2024.4.0/distributed/comm/inproc.py
+-rw-r--r--   0 james      (501) staff       (20)     2815 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/comm/registry.py
+-rw-r--r--   0 james      (501) staff       (20)    26549 2024-03-13 20:03:34.000000 distributed-2024.4.0/distributed/comm/tcp.py
+-rw-r--r--   0 james      (501) staff       (20)    23014 2023-11-07 17:11:41.000000 distributed-2024.4.0/distributed/comm/ucx.py
+-rw-r--r--   0 james      (501) staff       (20)     3758 2023-11-07 17:11:41.000000 distributed-2024.4.0/distributed/comm/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    14903 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/comm/ws.py
+-rw-r--r--   0 james      (501) staff       (20)    10114 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/compatibility.py
+-rw-r--r--   0 james      (501) staff       (20)     7826 2023-09-27 18:27:06.000000 distributed-2024.4.0/distributed/config.py
+-rw-r--r--   0 james      (501) staff       (20)    61536 2024-01-26 22:03:47.000000 distributed-2024.4.0/distributed/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2134 2023-10-23 15:00:29.000000 distributed-2024.4.0/distributed/counter.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.099918 distributed-2024.4.0/distributed/dashboard/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/dashboard/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.101951 distributed-2024.4.0/distributed/dashboard/components/
+-rw-r--r--   0 james      (501) staff       (20)     1550 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/dashboard/components/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     5775 2024-04-01 19:12:58.000000 distributed-2024.4.0/distributed/dashboard/components/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)     7154 2024-01-12 19:19:58.000000 distributed-2024.4.0/distributed/dashboard/components/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)   162585 2024-04-01 19:12:54.000000 distributed-2024.4.0/distributed/dashboard/components/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    19429 2023-12-01 22:10:13.000000 distributed-2024.4.0/distributed/dashboard/components/shared.py
+-rw-r--r--   0 james      (501) staff       (20)    15424 2023-10-27 21:35:57.000000 distributed-2024.4.0/distributed/dashboard/components/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     2232 2023-12-01 22:10:13.000000 distributed-2024.4.0/distributed/dashboard/core.py
+-rw-r--r--   0 james      (501) staff       (20)     2313 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/dashboard/export_tool.js
+-rw-r--r--   0 james      (501) staff       (20)      763 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/dashboard/export_tool.py
+-rw-r--r--   0 james      (501) staff       (20)     5908 2023-11-07 17:11:41.000000 distributed-2024.4.0/distributed/dashboard/scheduler.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.102430 distributed-2024.4.0/distributed/dashboard/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/dashboard/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      241 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/dashboard/templates/performance_report.html
+-rw-r--r--   0 james      (501) staff       (20)      199 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/dashboard/theme.yaml
+-rw-r--r--   0 james      (501) staff       (20)     1732 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/dashboard/utils.py
+-rw-r--r--   0 james      (501) staff       (20)      840 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/dashboard/worker.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.104813 distributed-2024.4.0/distributed/deploy/
+-rw-r--r--   0 james      (501) staff       (20)      466 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/deploy/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     6702 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/deploy/adaptive.py
+-rw-r--r--   0 james      (501) staff       (20)     7895 2023-09-27 18:27:06.000000 distributed-2024.4.0/distributed/deploy/adaptive_core.py
+-rw-r--r--   0 james      (501) staff       (20)    21271 2023-12-01 22:10:13.000000 distributed-2024.4.0/distributed/deploy/cluster.py
+-rw-r--r--   0 james      (501) staff       (20)    10452 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/deploy/local.py
+-rw-r--r--   0 james      (501) staff       (20)    15514 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/deploy/old_ssh.py
+-rw-r--r--   0 james      (501) staff       (20)    23933 2023-12-01 22:10:13.000000 distributed-2024.4.0/distributed/deploy/spec.py
+-rw-r--r--   0 james      (501) staff       (20)    15265 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/deploy/ssh.py
+-rw-r--r--   0 james      (501) staff       (20)     8543 2023-12-15 20:02:12.000000 distributed-2024.4.0/distributed/deploy/subprocess.py
+-rw-r--r--   0 james      (501) staff       (20)      888 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/deploy/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.108091 distributed-2024.4.0/distributed/diagnostics/
+-rw-r--r--   0 james      (501) staff       (20)      221 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/diagnostics/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1302 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/diagnostics/cluster_dump.py
+-rw-r--r--   0 james      (501) staff       (20)      564 2024-01-12 19:19:58.000000 distributed-2024.4.0/distributed/diagnostics/cudf.py
+-rw-r--r--   0 james      (501) staff       (20)     2190 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/diagnostics/eventstream.py
+-rw-r--r--   0 james      (501) staff       (20)     5207 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/diagnostics/graph_layout.py
+-rw-r--r--   0 james      (501) staff       (20)     7017 2023-09-13 17:55:47.000000 distributed-2024.4.0/distributed/diagnostics/memory_sampler.py
+-rw-r--r--   0 james      (501) staff       (20)     8138 2023-08-21 21:55:47.000000 distributed-2024.4.0/distributed/diagnostics/memray.py
+-rw-r--r--   0 james      (501) staff       (20)    10781 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/diagnostics/nvml.py
+-rw-r--r--   0 james      (501) staff       (20)    33240 2023-12-01 22:10:13.000000 distributed-2024.4.0/distributed/diagnostics/plugin.py
+-rw-r--r--   0 james      (501) staff       (20)    13904 2023-10-23 15:00:29.000000 distributed-2024.4.0/distributed/diagnostics/progress.py
+-rw-r--r--   0 james      (501) staff       (20)     6063 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/diagnostics/progress_stream.py
+-rw-r--r--   0 james      (501) staff       (20)    15800 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/diagnostics/progressbar.py
+-rw-r--r--   0 james      (501) staff       (20)     1124 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/diagnostics/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)     5677 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/diagnostics/task_stream.py
+-rw-r--r--   0 james      (501) staff       (20)     2513 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/diagnostics/websocket.py
+-rw-r--r--   0 james      (501) staff       (20)     9407 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/diskutils.py
+-rw-r--r--   0 james      (501) staff       (20)    48005 2024-03-13 20:03:34.000000 distributed-2024.4.0/distributed/distributed-schema.yaml
+-rw-r--r--   0 james      (501) staff       (20)    15035 2024-03-15 18:22:29.000000 distributed-2024.4.0/distributed/distributed.yaml
+-rw-r--r--   0 james      (501) staff       (20)     8536 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/event.py
+-rw-r--r--   0 james      (501) staff       (20)      586 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/exceptions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.109744 distributed-2024.4.0/distributed/http/
+-rw-r--r--   0 james      (501) staff       (20)       84 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)      273 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/http/health.py
+-rw-r--r--   0 james      (501) staff       (20)     1480 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/prometheus.py
+-rw-r--r--   0 james      (501) staff       (20)     4925 2024-04-01 19:12:54.000000 distributed-2024.4.0/distributed/http/proxy.py
+-rw-r--r--   0 james      (501) staff       (20)     2548 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/routing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.110715 distributed-2024.4.0/distributed/http/scheduler/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/scheduler/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2914 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/http/scheduler/api.py
+-rw-r--r--   0 james      (501) staff       (20)     8359 2023-12-01 22:10:13.000000 distributed-2024.4.0/distributed/http/scheduler/info.py
+-rw-r--r--   0 james      (501) staff       (20)     2159 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/scheduler/json.py
+-rw-r--r--   0 james      (501) staff       (20)      625 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/scheduler/missing_bokeh.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.111842 distributed-2024.4.0/distributed/http/scheduler/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      291 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/scheduler/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     7080 2024-03-15 18:22:29.000000 distributed-2024.4.0/distributed/http/scheduler/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     3514 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/scheduler/prometheus/semaphore.py
+-rw-r--r--   0 james      (501) staff       (20)     1617 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/scheduler/prometheus/stealing.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.112126 distributed-2024.4.0/distributed/http/static/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.113600 distributed-2024.4.0/distributed/http/static/css/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/css/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2260 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/css/base.css
+-rw-r--r--   0 james      (501) staff       (20)      250 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/css/gpu.css
+-rw-r--r--   0 james      (501) staff       (20)      840 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/static/css/individual-cluster-map.css
+-rw-r--r--   0 james      (501) staff       (20)     1557 2023-09-13 17:55:47.000000 distributed-2024.4.0/distributed/http/static/css/sortable.min.css
+-rw-r--r--   0 james      (501) staff       (20)     1012 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/css/status.css
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.115146 distributed-2024.4.0/distributed/http/static/images/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/images/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1607 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/images/dask-logo.svg
+-rw-r--r--   0 james      (501) staff       (20)      552 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/static/images/fa-bars.svg
+-rw-r--r--   0 james      (501) staff       (20)    15086 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/images/favicon.ico
+-rw-r--r--   0 james      (501) staff       (20)    11002 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/images/jupyter.svg
+-rw-r--r--   0 james      (501) staff       (20)    18663 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/images/numpy.png
+-rw-r--r--   0 james      (501) staff       (20)     1213 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/images/pandas.png
+-rw-r--r--   0 james      (501) staff       (20)   830916 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/images/python.png
+-rw-r--r--   0 james      (501) staff       (20)      667 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/static/individual-cluster-map.html
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.118382 distributed-2024.4.0/distributed/http/static/js/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/static/js/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)    17271 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/static/js/anime.min.js
+-rw-r--r--   0 james      (501) staff       (20)     9337 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/static/js/individual-cluster-map.js
+-rw-r--r--   0 james      (501) staff       (20)     3276 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/static/js/reconnecting-websocket.min.js
+-rw-r--r--   0 james      (501) staff       (20)     1194 2023-09-13 17:55:47.000000 distributed-2024.4.0/distributed/http/static/js/sortable.min.js
+-rw-r--r--   0 james      (501) staff       (20)      223 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/statics.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.121247 distributed-2024.4.0/distributed/http/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2930 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/templates/base.html
+-rw-r--r--   0 james      (501) staff       (20)      388 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/templates/call-stack.html
+-rw-r--r--   0 james      (501) staff       (20)     1351 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/templates/exceptions.html
+-rw-r--r--   0 james      (501) staff       (20)      404 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/templates/gpu.html
+-rw-r--r--   0 james      (501) staff       (20)      276 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/templates/json-index.html
+-rw-r--r--   0 james      (501) staff       (20)      116 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/templates/logs.html
+-rw-r--r--   0 james      (501) staff       (20)      522 2023-09-13 17:55:47.000000 distributed-2024.4.0/distributed/http/templates/main.html
+-rw-r--r--   0 james      (501) staff       (20)       95 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/templates/simple.html
+-rw-r--r--   0 james      (501) staff       (20)      635 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/templates/status.html
+-rw-r--r--   0 james      (501) staff       (20)     5726 2023-09-13 17:55:47.000000 distributed-2024.4.0/distributed/http/templates/task.html
+-rw-r--r--   0 james      (501) staff       (20)     1601 2023-09-13 17:55:47.000000 distributed-2024.4.0/distributed/http/templates/worker-table.html
+-rw-r--r--   0 james      (501) staff       (20)     2034 2023-09-13 17:55:47.000000 distributed-2024.4.0/distributed/http/templates/worker.html
+-rw-r--r--   0 james      (501) staff       (20)      457 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/templates/workers.html
+-rw-r--r--   0 james      (501) staff       (20)     1184 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/utils.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.121411 distributed-2024.4.0/distributed/http/worker/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:50:47.000000 distributed-2024.4.0/distributed/http/worker/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.121686 distributed-2024.4.0/distributed/http/worker/prometheus/
+-rw-r--r--   0 james      (501) staff       (20)      288 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/http/worker/prometheus/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)    10039 2024-03-15 18:22:29.000000 distributed-2024.4.0/distributed/http/worker/prometheus/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1170 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/itertools.py
+-rw-r--r--   0 james      (501) staff       (20)     5599 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/lock.py
+-rwxr-xr-x   0 james      (501) staff       (20)    14386 2023-12-01 22:10:13.000000 distributed-2024.4.0/distributed/metrics.py
+-rw-r--r--   0 james      (501) staff       (20)     8044 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/multi_lock.py
+-rw-r--r--   0 james      (501) staff       (20)    35163 2024-04-01 19:12:54.000000 distributed-2024.4.0/distributed/nanny.py
+-rw-r--r--   0 james      (501) staff       (20)     6710 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/node.py
+-rw-r--r--   0 james      (501) staff       (20)     1449 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/objects.py
+-rw-r--r--   0 james      (501) staff       (20)     8356 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/preloading.py
+-rw-r--r--   0 james      (501) staff       (20)    12887 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/process.py
+-rw-r--r--   0 james      (501) staff       (20)      931 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/proctitle.py
+-rw-r--r--   0 james      (501) staff       (20)    16996 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/profile.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.126003 distributed-2024.4.0/distributed/protocol/
+-rw-r--r--   0 james      (501) staff       (20)     3363 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     1336 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     6671 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/compression.py
+-rw-r--r--   0 james      (501) staff       (20)     6831 2024-01-12 19:19:58.000000 distributed-2024.4.0/distributed/protocol/core.py
+-rw-r--r--   0 james      (501) staff       (20)     1181 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/cuda.py
+-rw-r--r--   0 james      (501) staff       (20)     2931 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/cupy.py
+-rw-r--r--   0 james      (501) staff       (20)      836 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/h5py.py
+-rw-r--r--   0 james      (501) staff       (20)     1127 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/keras.py
+-rw-r--r--   0 james      (501) staff       (20)     1466 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/netcdf4.py
+-rw-r--r--   0 james      (501) staff       (20)     2139 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/numba.py
+-rw-r--r--   0 james      (501) staff       (20)     7030 2024-01-26 22:03:47.000000 distributed-2024.4.0/distributed/protocol/numpy.py
+-rw-r--r--   0 james      (501) staff       (20)     3041 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/protocol/pickle.py
+-rw-r--r--   0 james      (501) staff       (20)     1507 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/rmm.py
+-rw-r--r--   0 james      (501) staff       (20)      792 2024-01-26 22:03:47.000000 distributed-2024.4.0/distributed/protocol/scipy.py
+-rw-r--r--   0 james      (501) staff       (20)    29225 2023-12-15 20:02:12.000000 distributed-2024.4.0/distributed/protocol/serialize.py
+-rw-r--r--   0 james      (501) staff       (20)      955 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/sparse.py
+-rw-r--r--   0 james      (501) staff       (20)     1993 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/protocol/torch.py
+-rw-r--r--   0 james      (501) staff       (20)     8314 2024-03-13 20:03:34.000000 distributed-2024.4.0/distributed/protocol/utils.py
+-rw-r--r--   0 james      (501) staff       (20)      795 2023-11-07 17:11:41.000000 distributed-2024.4.0/distributed/protocol/utils_test.py
+-rw-r--r--   0 james      (501) staff       (20)     3733 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/publish.py
+-rw-r--r--   0 james      (501) staff       (20)    15643 2023-10-23 15:00:29.000000 distributed-2024.4.0/distributed/pubsub.py
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/py.typed
+-rw-r--r--   0 james      (501) staff       (20)    10054 2023-10-23 15:00:29.000000 distributed-2024.4.0/distributed/queues.py
+-rw-r--r--   0 james      (501) staff       (20)     7419 2023-09-13 17:55:47.000000 distributed-2024.4.0/distributed/recreate_tasks.py
+-rw-r--r--   0 james      (501) staff       (20)   327306 2024-04-01 19:12:54.000000 distributed-2024.4.0/distributed/scheduler.py
+-rw-r--r--   0 james      (501) staff       (20)    13867 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/security.py
+-rw-r--r--   0 james      (501) staff       (20)    20568 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/semaphore.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.129721 distributed-2024.4.0/distributed/shuffle/
+-rw-r--r--   0 james      (501) staff       (20)      674 2023-08-21 21:39:28.000000 distributed-2024.4.0/distributed/shuffle/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     6394 2024-04-01 19:12:58.000000 distributed-2024.4.0/distributed/shuffle/_arrow.py
+-rw-r--r--   0 james      (501) staff       (20)     9330 2024-01-12 19:19:58.000000 distributed-2024.4.0/distributed/shuffle/_buffer.py
+-rw-r--r--   0 james      (501) staff       (20)     2481 2024-01-12 19:19:58.000000 distributed-2024.4.0/distributed/shuffle/_comms.py
+-rw-r--r--   0 james      (501) staff       (20)    17734 2024-03-13 20:03:34.000000 distributed-2024.4.0/distributed/shuffle/_core.py
+-rw-r--r--   0 james      (501) staff       (20)     7924 2024-03-13 20:03:34.000000 distributed-2024.4.0/distributed/shuffle/_disk.py
+-rw-r--r--   0 james      (501) staff       (20)      180 2024-03-13 20:03:34.000000 distributed-2024.4.0/distributed/shuffle/_exceptions.py
+-rw-r--r--   0 james      (501) staff       (20)     2798 2024-01-12 19:19:58.000000 distributed-2024.4.0/distributed/shuffle/_limiter.py
+-rw-r--r--   0 james      (501) staff       (20)     1531 2024-03-13 20:03:34.000000 distributed-2024.4.0/distributed/shuffle/_memory.py
+-rw-r--r--   0 james      (501) staff       (20)    14022 2024-03-15 18:22:29.000000 distributed-2024.4.0/distributed/shuffle/_merge.py
+-rw-r--r--   0 james      (501) staff       (20)     1186 2023-11-07 17:11:41.000000 distributed-2024.4.0/distributed/shuffle/_pickle.py
+-rw-r--r--   0 james      (501) staff       (20)    26857 2024-01-12 19:19:58.000000 distributed-2024.4.0/distributed/shuffle/_rechunk.py
+-rw-r--r--   0 james      (501) staff       (20)    18440 2024-01-12 19:19:58.000000 distributed-2024.4.0/distributed/shuffle/_scheduler_plugin.py
+-rw-r--r--   0 james      (501) staff       (20)    18581 2024-03-15 18:22:29.000000 distributed-2024.4.0/distributed/shuffle/_shuffle.py
+-rw-r--r--   0 james      (501) staff       (20)    14591 2024-03-13 20:03:34.000000 distributed-2024.4.0/distributed/shuffle/_worker_plugin.py
+-rw-r--r--   0 james      (501) staff       (20)      670 2024-04-01 19:12:54.000000 distributed-2024.4.0/distributed/sizeof.py
+-rw-r--r--   0 james      (501) staff       (20)    23191 2024-01-12 19:19:58.000000 distributed-2024.4.0/distributed/spans.py
+-rw-r--r--   0 james      (501) staff       (20)    13767 2023-12-15 20:02:12.000000 distributed-2024.4.0/distributed/spill.py
+-rw-r--r--   0 james      (501) staff       (20)    19711 2024-03-15 18:22:29.000000 distributed-2024.4.0/distributed/stealing.py
+-rw-r--r--   0 james      (501) staff       (20)     1952 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/system.py
+-rw-r--r--   0 james      (501) staff       (20)     8971 2024-04-01 19:12:58.000000 distributed-2024.4.0/distributed/system_monitor.py
+-rw-r--r--   0 james      (501) staff       (20)     7104 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/threadpoolexecutor.py
+-rw-r--r--   0 james      (501) staff       (20)    58512 2024-04-01 19:12:54.000000 distributed-2024.4.0/distributed/utils.py
+-rw-r--r--   0 james      (501) staff       (20)    14792 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/utils_comm.py
+-rw-r--r--   0 james      (501) staff       (20)     8050 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/utils_perf.py
+-rw-r--r--   0 james      (501) staff       (20)    83804 2024-04-01 19:12:54.000000 distributed-2024.4.0/distributed/utils_test.py
+-rw-r--r--   0 james      (501) staff       (20)     8411 2023-08-31 20:57:51.000000 distributed-2024.4.0/distributed/variable.py
+-rw-r--r--   0 james      (501) staff       (20)     5165 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/versions.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.129899 distributed-2024.4.0/distributed/widgets/
+-rw-r--r--   0 james      (501) staff       (20)      267 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/__init__.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.132420 distributed-2024.4.0/distributed/widgets/templates/
+-rw-r--r--   0 james      (501) staff       (20)        0 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/__init__.py
+-rw-r--r--   0 james      (501) staff       (20)     2265 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/client.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1589 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1270 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/computation.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      518 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/future.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      544 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/has_what.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      234 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/local_cluster.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      636 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/log.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      168 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/logs.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     1290 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/process_interface.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      317 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/scheduler.html.j2
+-rw-r--r--   0 james      (501) staff       (20)     6705 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/scheduler_info.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/security.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      448 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/task_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      295 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/who_has.html.j2
+-rw-r--r--   0 james      (501) staff       (20)      407 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/widgets/templates/worker_state.html.j2
+-rw-r--r--   0 james      (501) staff       (20)   124786 2024-04-01 19:12:54.000000 distributed-2024.4.0/distributed/worker.py
+-rw-r--r--   0 james      (501) staff       (20)     2568 2023-07-17 19:51:10.000000 distributed-2024.4.0/distributed/worker_client.py
+-rw-r--r--   0 james      (501) staff       (20)    21243 2023-10-13 21:59:50.000000 distributed-2024.4.0/distributed/worker_memory.py
+-rw-r--r--   0 james      (501) staff       (20)   142682 2023-12-01 22:10:13.000000 distributed-2024.4.0/distributed/worker_state_machine.py
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.143738 distributed-2024.4.0/distributed.egg-info/
+-rw-r--r--   0 james      (501) staff       (20)     3344 2024-04-01 19:35:18.000000 distributed-2024.4.0/distributed.egg-info/PKG-INFO
+-rw-r--r--   0 james      (501) staff       (20)     8983 2024-04-01 19:35:18.000000 distributed-2024.4.0/distributed.egg-info/SOURCES.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2024-04-01 19:35:18.000000 distributed-2024.4.0/distributed.egg-info/dependency_links.txt
+-rw-r--r--   0 james      (501) staff       (20)      335 2024-04-01 19:35:18.000000 distributed-2024.4.0/distributed.egg-info/entry_points.txt
+-rw-r--r--   0 james      (501) staff       (20)        1 2024-04-01 19:35:17.000000 distributed-2024.4.0/distributed.egg-info/not-zip-safe
+-rw-r--r--   0 james      (501) staff       (20)      227 2024-04-01 19:35:18.000000 distributed-2024.4.0/distributed.egg-info/requires.txt
+-rw-r--r--   0 james      (501) staff       (20)       12 2024-04-01 19:35:18.000000 distributed-2024.4.0/distributed.egg-info/top_level.txt
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.068858 distributed-2024.4.0/docs/
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.143230 distributed-2024.4.0/docs/source/
+-rw-r--r--   0 james      (501) staff       (20)    11754 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/active_memory_manager.rst
+-rw-r--r--   0 james      (501) staff       (20)     8000 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/actors.rst
+-rw-r--r--   0 james      (501) staff       (20)     4343 2023-08-21 21:55:47.000000 distributed-2024.4.0/docs/source/api.rst
+-rw-r--r--   0 james      (501) staff       (20)     3519 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/asynchronous.rst
+-rw-r--r--   0 james      (501) staff       (20)   275148 2023-10-13 22:40:21.000000 distributed-2024.4.0/docs/source/changelog.rst
+-rw-r--r--   0 james      (501) staff       (20)     7137 2023-08-21 21:39:28.000000 distributed-2024.4.0/docs/source/client.rst
+-rw-r--r--   0 james      (501) staff       (20)     3770 2023-07-17 19:50:47.000000 distributed-2024.4.0/docs/source/communications.rst
+-rw-r--r--   0 james      (501) staff       (20)     7049 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/develop.rst
+-rw-r--r--   0 james      (501) staff       (20)     6823 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/diagnosing-performance.rst
+-rw-r--r--   0 james      (501) staff       (20)     3392 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/efficiency.rst
+drwxr-xr-x   0 james      (501) staff       (20)        0 2024-04-01 19:35:18.143394 distributed-2024.4.0/docs/source/examples/
+-rw-r--r--   0 james      (501) staff       (20)     8953 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/examples/word-count.rst
+-rw-r--r--   0 james      (501) staff       (20)       75 2023-07-17 19:50:47.000000 distributed-2024.4.0/docs/source/examples-overview.rst
+-rw-r--r--   0 james      (501) staff       (20)     4228 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/faq.rst
+-rw-r--r--   0 james      (501) staff       (20)     9303 2023-08-21 21:39:28.000000 distributed-2024.4.0/docs/source/fine-performance-metrics.rst
+-rw-r--r--   0 james      (501) staff       (20)     4613 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/foundations.rst
+-rw-r--r--   0 james      (501) staff       (20)     4016 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/http_services.rst
+-rw-r--r--   0 james      (501) staff       (20)     4460 2023-08-21 21:39:28.000000 distributed-2024.4.0/docs/source/index.rst
+-rw-r--r--   0 james      (501) staff       (20)     1182 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/install.rst
+-rw-r--r--   0 james      (501) staff       (20)     7293 2023-07-17 19:50:47.000000 distributed-2024.4.0/docs/source/journey.rst
+-rw-r--r--   0 james      (501) staff       (20)     6470 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/killed.rst
+-rw-r--r--   0 james      (501) staff       (20)     1828 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/limitations.rst
+-rw-r--r--   0 james      (501) staff       (20)     6458 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/locality.rst
+-rw-r--r--   0 james      (501) staff       (20)     2807 2023-07-17 19:50:47.000000 distributed-2024.4.0/docs/source/logging.rst
+-rw-r--r--   0 james      (501) staff       (20)     6546 2023-07-17 19:50:47.000000 distributed-2024.4.0/docs/source/manage-computation.rst
+-rw-r--r--   0 james      (501) staff       (20)     8550 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/memory.rst
+-rw-r--r--   0 james      (501) staff       (20)     4282 2023-12-01 22:10:13.000000 distributed-2024.4.0/docs/source/plugins.rst
+-rw-r--r--   0 james      (501) staff       (20)     3265 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/priority.rst
+-rw-r--r--   0 james      (501) staff       (20)     7800 2024-03-15 18:22:29.000000 distributed-2024.4.0/docs/source/prometheus.rst
+-rw-r--r--   0 james      (501) staff       (20)    11199 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/protocol.rst
+-rw-r--r--   0 james      (501) staff       (20)     3107 2023-07-17 19:50:47.000000 distributed-2024.4.0/docs/source/publish.rst
+-rw-r--r--   0 james      (501) staff       (20)      402 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/queues.rst
+-rw-r--r--   0 james      (501) staff       (20)     2942 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/quickstart.rst
+-rw-r--r--   0 james      (501) staff       (20)     8773 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/related-work.rst
+-rw-r--r--   0 james      (501) staff       (20)     3418 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/resilience.rst
+-rw-r--r--   0 james      (501) staff       (20)     7021 2024-04-01 19:12:58.000000 distributed-2024.4.0/docs/source/resources.rst
+-rw-r--r--   0 james      (501) staff       (20)    16084 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/scheduling-policies.rst
+-rw-r--r--   0 james      (501) staff       (20)    16893 2023-08-31 20:57:51.000000 distributed-2024.4.0/docs/source/scheduling-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     6518 2023-07-17 19:50:47.000000 distributed-2024.4.0/docs/source/serialization.rst
+-rw-r--r--   0 james      (501) staff       (20)     5463 2024-04-01 19:12:58.000000 distributed-2024.4.0/docs/source/spans.rst
+-rw-r--r--   0 james      (501) staff       (20)     8343 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/task-launch.rst
+-rw-r--r--   0 james      (501) staff       (20)     4190 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/tls.rst
+-rw-r--r--   0 james      (501) staff       (20)     5557 2023-07-17 19:50:47.000000 distributed-2024.4.0/docs/source/work-stealing.rst
+-rw-r--r--   0 james      (501) staff       (20)    13489 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/worker-memory.rst
+-rw-r--r--   0 james      (501) staff       (20)    22542 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/worker-state.rst
+-rw-r--r--   0 james      (501) staff       (20)     3467 2023-07-17 19:51:10.000000 distributed-2024.4.0/docs/source/worker.rst
+-rw-r--r--   0 james      (501) staff       (20)    10199 2024-04-01 19:28:50.000000 distributed-2024.4.0/pyproject.toml
+-rw-r--r--   0 james      (501) staff       (20)       38 2024-04-01 19:35:18.144446 distributed-2024.4.0/setup.cfg
+-rw-r--r--   0 james      (501) staff       (20)      171 2023-07-17 19:51:10.000000 distributed-2024.4.0/setup.py
```

### Comparing `distributed-2024.3.1/LICENSE.txt` & `distributed-2024.4.0/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/MANIFEST.in` & `distributed-2024.4.0/MANIFEST.in`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/PKG-INFO` & `distributed-2024.4.0/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2024.3.1
+Version: 2024.4.0
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD-3-Clause
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
@@ -22,15 +22,15 @@
 Classifier: Topic :: System :: Distributed Computing
 Requires-Python: >=3.9
 Description-Content-Type: text/x-rst
 License-File: LICENSE.txt
 License-File: AUTHORS.md
 Requires-Dist: click>=8.0
 Requires-Dist: cloudpickle>=1.5.0
-Requires-Dist: dask==2024.3.1
+Requires-Dist: dask==2024.4.0
 Requires-Dist: jinja2>=2.10.3
 Requires-Dist: locket>=1.0.0
 Requires-Dist: msgpack>=1.0.0
 Requires-Dist: packaging>=20.0
 Requires-Dist: psutil>=5.7.2
 Requires-Dist: pyyaml>=5.3.1
 Requires-Dist: sortedcontainers>=2.0.5
```

### Comparing `distributed-2024.3.1/README.rst` & `distributed-2024.4.0/README.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/__init__.py` & `distributed-2024.4.0/distributed/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/_asyncio.py` & `distributed-2024.4.0/distributed/_asyncio.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/_concurrent_futures_thread.py` & `distributed-2024.4.0/distributed/_concurrent_futures_thread.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/_signals.py` & `distributed-2024.4.0/distributed/_signals.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/_stories.py` & `distributed-2024.4.0/distributed/_stories.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/active_memory_manager.py` & `distributed-2024.4.0/distributed/active_memory_manager.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/actor.py` & `distributed-2024.4.0/distributed/actor.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/batched.py` & `distributed-2024.4.0/distributed/batched.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/cfexecutor.py` & `distributed-2024.4.0/distributed/cfexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/chaos.py` & `distributed-2024.4.0/distributed/chaos.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/cli/dask_scheduler.py` & `distributed-2024.4.0/distributed/cli/dask_scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/cli/dask_spec.py` & `distributed-2024.4.0/distributed/cli/dask_spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/cli/dask_ssh.py` & `distributed-2024.4.0/distributed/cli/dask_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/cli/dask_worker.py` & `distributed-2024.4.0/distributed/cli/dask_worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/cli/utils.py` & `distributed-2024.4.0/distributed/cli/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/client.py` & `distributed-2024.4.0/distributed/client.py`

 * *Files 0% similar despite different names*

```diff
@@ -32,28 +32,28 @@
 from tlz import first, groupby, merge, partition_all, valmap
 
 import dask
 from dask.base import collections_to_dsk, tokenize
 from dask.core import flatten, validate_key
 from dask.highlevelgraph import HighLevelGraph
 from dask.optimization import SubgraphCallable
-from dask.typing import no_default
+from dask.typing import NoDefault, no_default
 from dask.utils import (
     apply,
     ensure_dict,
     format_bytes,
     funcname,
     parse_bytes,
     parse_timedelta,
     shorten_traceback,
     typename,
 )
 from dask.widgets import get_template
 
-from distributed.core import ErrorMessage, OKMessage
+from distributed.core import OKMessage
 from distributed.protocol.serialize import _is_dumpable
 from distributed.utils import Deadline, wait_for
 
 try:
     from dask.delayed import single_key
 except ImportError:
     single_key = first
@@ -855,16 +855,17 @@
         extensions=DEFAULT_EXTENSIONS,
         direct_to_workers=None,
         connection_limit=512,
         **kwargs,
     ):
         if timeout is no_default:
             timeout = dask.config.get("distributed.comm.timeouts.connect")
-        if timeout is not None:
-            timeout = parse_timedelta(timeout, "s")
+        timeout = parse_timedelta(timeout, "s")
+        if timeout is None:
+            raise ValueError("None is an invalid value for global client timeout")
         self._timeout = timeout
 
         self.futures = dict()
         self.refcount = defaultdict(int)
         self._handle_report_task = None
         if name is None:
             name = dask.config.get("client-name", None)
@@ -1249,16 +1250,15 @@
     async def _start(self, timeout=no_default, **kwargs):
         self.status = "connecting"
 
         await self.rpc.start()
 
         if timeout is no_default:
             timeout = self._timeout
-        if timeout is not None:
-            timeout = parse_timedelta(timeout, "s")
+        timeout = parse_timedelta(timeout, "s")
 
         address = self._start_arg
         if self.cluster is not None:
             # Ensure the cluster is started (no-op if already running)
             try:
                 await self.cluster
             except Exception:
@@ -3592,24 +3592,32 @@
         ]
 
         if singleton:
             return first(result)
         else:
             return result
 
-    async def _restart(self, timeout=no_default, wait_for_workers=True):
+    async def _restart(
+        self, timeout: str | int | float | NoDefault, wait_for_workers: bool
+    ) -> None:
         if timeout is no_default:
             timeout = self._timeout * 4
-        if timeout is not None:
-            timeout = parse_timedelta(timeout, "s")
+        timeout = parse_timedelta(cast("str|int|float", timeout), "s")
 
-        await self.scheduler.restart(timeout=timeout, wait_for_workers=wait_for_workers)
-        return self
+        await self.scheduler.restart(
+            timeout=timeout,
+            wait_for_workers=wait_for_workers,
+            stimulus_id=f"client-restart-{time()}",
+        )
 
-    def restart(self, timeout=no_default, wait_for_workers=True):
+    def restart(
+        self,
+        timeout: str | int | float | NoDefault = no_default,
+        wait_for_workers: bool = True,
+    ):
         """
         Restart all workers. Reset local state. Optionally wait for workers to return.
 
         Workers without nannies are shut down, hoping an external deployment system
         will restart them. Therefore, if not using nannies and your deployment system
         does not automatically restart workers, ``restart`` will just shut down all
         workers, then time out!
@@ -3638,69 +3646,66 @@
         return self.sync(
             self._restart, timeout=timeout, wait_for_workers=wait_for_workers
         )
 
     async def _restart_workers(
         self,
         workers: list[str],
-        timeout: int | float | None = None,
-        raise_for_error: bool = True,
-    ) -> dict[str, str | ErrorMessage]:
+        timeout: str | int | float | NoDefault,
+        raise_for_error: bool,
+    ) -> dict[str, Literal["OK", "removed", "timed out"]]:
+        if timeout is no_default:
+            timeout = self._timeout * 4
+        timeout = parse_timedelta(cast("str|int|float", timeout), "s")
+
         info = self.scheduler_info()
         name_to_addr = {meta["name"]: addr for addr, meta in info["workers"].items()}
         worker_addrs = [name_to_addr.get(w, w) for w in workers]
 
-        restart_out: dict[str, str | ErrorMessage] = await self.scheduler.broadcast(
-            msg={"op": "restart", "timeout": timeout},
+        out: dict[
+            str, Literal["OK", "removed", "timed out"]
+        ] = await self.scheduler.restart_workers(
             workers=worker_addrs,
-            nanny=True,
+            timeout=timeout,
+            on_error="raise" if raise_for_error else "return",
+            stimulus_id=f"client-restart-workers-{time()}",
         )
-
         # Map keys back to original `workers` input names/addresses
-        results = {w: restart_out[w_addr] for w, w_addr in zip(workers, worker_addrs)}
-
-        timeout_workers = [w for w, status in results.items() if status == "timed out"]
-        if timeout_workers and raise_for_error:
-            raise TimeoutError(
-                f"The following workers failed to restart with {timeout} seconds: {timeout_workers}"
-            )
-
-        errored: list[ErrorMessage] = [m for m in results.values() if "exception" in m]  # type: ignore
-        if errored and raise_for_error:
-            raise pickle.loads(errored[0]["exception"])  # type: ignore
-        return results
+        out = {w: out[w_addr] for w, w_addr in zip(workers, worker_addrs)}
+        if raise_for_error:
+            assert all(v == "OK" for v in out.values()), out
+        return out
 
     def restart_workers(
         self,
         workers: list[str],
-        timeout: int | float | None = None,
+        timeout: str | int | float | NoDefault = no_default,
         raise_for_error: bool = True,
-    ) -> dict[str, str]:
+    ):
         """Restart a specified set of workers
 
         .. note::
 
             Only workers being monitored by a :class:`distributed.Nanny` can be restarted.
-
-        See ``Nanny.restart`` for more details.
+            See ``Nanny.restart`` for more details.
 
         Parameters
         ----------
         workers : list[str]
             Workers to restart. This can be a list of worker addresses, names, or a both.
         timeout : int | float | None
             Number of seconds to wait
         raise_for_error: bool (default True)
             Whether to raise a :py:class:`TimeoutError` if restarting worker(s) doesn't
             finish within ``timeout``, or another exception caused from restarting
             worker(s).
 
         Returns
         -------
-        dict[str, str]
+        dict[str, "OK" | "removed" | "timed out"]
             Mapping of worker and restart status, the keys will match the original
             values passed in via ``workers``.
 
         Notes
         -----
         This method differs from :meth:`Client.restart` in that this method
         simply restarts the specified set of workers, while ``Client.restart``
@@ -3726,15 +3731,16 @@
         Client.restart
         """
         info = self.scheduler_info()
 
         for worker, meta in info["workers"].items():
             if (worker in workers or meta["name"] in workers) and meta["nanny"] is None:
                 raise ValueError(
-                    f"Restarting workers requires a nanny to be used. Worker {worker} has type {info['workers'][worker]['type']}."
+                    f"Restarting workers requires a nanny to be used. Worker "
+                    f"{worker} has type {info['workers'][worker]['type']}."
                 )
         return self.sync(
             self._restart_workers,
             workers=workers,
             timeout=timeout,
             raise_for_error=raise_for_error,
         )
```

### Comparing `distributed-2024.3.1/distributed/cluster_dump.py` & `distributed-2024.4.0/distributed/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/collections.py` & `distributed-2024.4.0/distributed/collections.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/comm/__init__.py` & `distributed-2024.4.0/distributed/comm/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/comm/addressing.py` & `distributed-2024.4.0/distributed/comm/addressing.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/comm/core.py` & `distributed-2024.4.0/distributed/comm/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/comm/inproc.py` & `distributed-2024.4.0/distributed/comm/inproc.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/comm/registry.py` & `distributed-2024.4.0/distributed/comm/registry.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/comm/tcp.py` & `distributed-2024.4.0/distributed/comm/tcp.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/comm/ucx.py` & `distributed-2024.4.0/distributed/comm/ucx.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/comm/utils.py` & `distributed-2024.4.0/distributed/comm/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/comm/ws.py` & `distributed-2024.4.0/distributed/comm/ws.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/compatibility.py` & `distributed-2024.4.0/distributed/compatibility.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/config.py` & `distributed-2024.4.0/distributed/config.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/core.py` & `distributed-2024.4.0/distributed/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/counter.py` & `distributed-2024.4.0/distributed/counter.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/dashboard/components/__init__.py` & `distributed-2024.4.0/distributed/dashboard/components/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/dashboard/components/nvml.py` & `distributed-2024.4.0/distributed/dashboard/components/nvml.py`

 * *Files 3% similar despite different names*

```diff
@@ -121,21 +121,19 @@
         y = []
         memory_total = 0
         memory_max = 0
         worker = []
 
         for idx, ws in enumerate(workers):
             try:
-                info = ws.extra["gpu"]
+                mem_used = ws.metrics["gpu_memory_used"]
+                mem_total = ws.metrics["gpu-memory-total"]
+                u = ws.metrics["gpu_utilization"]
             except KeyError:
                 continue
-            metrics = ws.metrics["gpu"]
-            u = metrics["utilization"]
-            mem_used = metrics["memory-used"]
-            mem_total = info["memory-total"]
             memory_max = max(memory_max, mem_total)
             memory_total += mem_total
             utilization.append(int(u))
             memory.append(mem_used)
             worker.append(ws.address)
             gpu_index.append(idx)
             y.append(idx)
```

### Comparing `distributed-2024.3.1/distributed/dashboard/components/rmm.py` & `distributed-2024.4.0/distributed/dashboard/components/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/dashboard/components/scheduler.py` & `distributed-2024.4.0/distributed/dashboard/components/scheduler.py`

 * *Files 0% similar despite different names*

```diff
@@ -3872,6289 +3872,6291 @@
 0000f1f0: 7479 7065 3d22 6461 7465 7469 6d65 222c  type="datetime",
 0000f200: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
 0000f210: 6c73 3d22 222c 0a20 2020 2020 2020 2020  ls="",.         
 0000f220: 2020 2078 5f72 616e 6765 3d78 5f72 616e     x_range=x_ran
 0000f230: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
 0000f240: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
 0000f250: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-0000f260: 662e 726f 6f74 2e63 6972 636c 6528 0a20  f.root.circle(. 
-0000f270: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
-0000f280: 653d 7365 6c66 2e73 6f75 7263 652c 0a20  e=self.source,. 
-0000f290: 2020 2020 2020 2020 2020 2078 3d22 7469             x="ti
-0000f2a0: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
-0000f2b0: 2079 3d22 6c65 7665 6c22 2c0a 2020 2020   y="level",.    
-0000f2c0: 2020 2020 2020 2020 636f 6c6f 723d 2263          color="c
-0000f2d0: 6f6c 6f72 222c 0a20 2020 2020 2020 2020  olor",.         
-0000f2e0: 2020 2073 697a 653d 2272 6164 6975 7322     size="radius"
-0000f2f0: 2c0a 2020 2020 2020 2020 2020 2020 616c  ,.            al
-0000f300: 7068 613d 302e 352c 0a20 2020 2020 2020  pha=0.5,.       
-0000f310: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-0000f320: 726f 6f74 2e79 6178 6973 2e61 7869 735f  root.yaxis.axis_
-0000f330: 6c61 6265 6c20 3d20 224c 6576 656c 220a  label = "Level".
-0000f340: 0a20 2020 2020 2020 2068 6f76 6572 203d  .        hover =
-0000f350: 2048 6f76 6572 546f 6f6c 2829 0a20 2020   HoverTool().   
-0000f360: 2020 2020 2068 6f76 6572 2e74 6f6f 6c74       hover.toolt
-0000f370: 6970 7320 3d20 224c 6576 656c 3a20 406c  ips = "Level: @l
-0000f380: 6576 656c 2c20 4475 7261 7469 6f6e 3a20  evel, Duration: 
-0000f390: 4064 7572 6174 696f 6e2c 2043 6f75 6e74  @duration, Count
-0000f3a0: 3a20 4063 6f75 6e74 2c20 436f 7374 2066  : @count, Cost f
-0000f3b0: 6163 746f 723a 2040 636f 7374 5f66 6163  actor: @cost_fac
-0000f3c0: 746f 7222 0a20 2020 2020 2020 2068 6f76  tor".        hov
-0000f3d0: 6572 2e70 6f69 6e74 5f70 6f6c 6963 7920  er.point_policy 
-0000f3e0: 3d20 2266 6f6c 6c6f 775f 6d6f 7573 6522  = "follow_mouse"
-0000f3f0: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-0000f400: 6f6f 742e 6164 645f 746f 6f6c 7328 0a20  oot.add_tools(. 
-0000f410: 2020 2020 2020 2020 2020 2068 6f76 6572             hover
-0000f420: 2c0a 2020 2020 2020 2020 2020 2020 5265  ,.            Re
-0000f430: 7365 7454 6f6f 6c28 292c 0a20 2020 2020  setTool(),.     
-0000f440: 2020 2020 2020 2050 616e 546f 6f6c 2864         PanTool(d
-0000f450: 696d 656e 7369 6f6e 733d 2277 6964 7468  imensions="width
-0000f460: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-0000f470: 5768 6565 6c5a 6f6f 6d54 6f6f 6c28 6469  WheelZoomTool(di
-0000f480: 6d65 6e73 696f 6e73 3d22 7769 6474 6822  mensions="width"
-0000f490: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
-0000f4a0: 2020 6465 6620 636f 6e76 6572 7428 7365    def convert(se
-0000f4b0: 6c66 2c20 6d73 6773 293a 0a20 2020 2020  lf, msgs):.     
-0000f4c0: 2020 2022 2222 436f 6e76 6572 7420 6120     """Convert a 
-0000f4d0: 6c6f 6720 6d65 7373 6167 6520 746f 2061  log message to a
-0000f4e0: 2067 6c79 7068 2222 220a 2020 2020 2020   glyph""".      
-0000f4f0: 2020 746f 7461 6c5f 6475 7261 7469 6f6e    total_duration
-0000f500: 203d 2030 0a20 2020 2020 2020 2066 6f72   = 0.        for
-0000f510: 206d 7367 2069 6e20 6d73 6773 3a0a 2020   msg in msgs:.  
-0000f520: 2020 2020 2020 2020 2020 7469 6d65 2c20            time, 
-0000f530: 6c65 7665 6c2c 206b 6579 2c20 6475 7261  level, key, dura
-0000f540: 7469 6f6e 2c20 7361 742c 206f 6363 5f73  tion, sat, occ_s
-0000f550: 6174 2c20 6964 6c2c 206f 6363 5f69 646c  at, idl, occ_idl
-0000f560: 203d 206d 7367 5b3a 385d 0a20 2020 2020   = msg[:8].     
-0000f570: 2020 2020 2020 2074 6f74 616c 5f64 7572         total_dur
-0000f580: 6174 696f 6e20 2b3d 2064 7572 6174 696f  ation += duratio
-0000f590: 6e0a 0a20 2020 2020 2020 2074 7279 3a0a  n..        try:.
-0000f5a0: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-0000f5b0: 7220 3d20 5669 7269 6469 7331 315b 6c65  r = Viridis11[le
-0000f5c0: 7665 6c5d 0a20 2020 2020 2020 2065 7863  vel].        exc
-0000f5d0: 6570 7420 284b 6579 4572 726f 722c 2049  ept (KeyError, I
-0000f5e0: 6e64 6578 4572 726f 7229 3a0a 2020 2020  ndexError):.    
-0000f5f0: 2020 2020 2020 2020 636f 6c6f 7220 3d20          color = 
-0000f600: 2262 6c61 636b 220a 0a20 2020 2020 2020  "black"..       
-0000f610: 2072 6164 6975 7320 3d20 6d61 7468 2e73   radius = math.s
-0000f620: 7172 7428 6d69 6e28 746f 7461 6c5f 6475  qrt(min(total_du
-0000f630: 7261 7469 6f6e 2c20 3130 2929 202a 2033  ration, 10)) * 3
-0000f640: 3020 2b20 320a 0a20 2020 2020 2020 2064  0 + 2..        d
-0000f650: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0000f660: 2022 7469 6d65 223a 2074 696d 6520 2a20   "time": time * 
-0000f670: 3130 3030 2c0a 2020 2020 2020 2020 2020  1000,.          
-0000f680: 2020 226c 6576 656c 223a 206c 6576 656c    "level": level
-0000f690: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
-0000f6a0: 6f75 6e74 223a 206c 656e 286d 7367 7329  ount": len(msgs)
-0000f6b0: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
-0000f6c0: 6f6c 6f72 223a 2063 6f6c 6f72 2c0a 2020  olor": color,.  
-0000f6d0: 2020 2020 2020 2020 2020 2264 7572 6174            "durat
-0000f6e0: 696f 6e22 3a20 746f 7461 6c5f 6475 7261  ion": total_dura
-0000f6f0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-0000f700: 2020 2272 6164 6975 7322 3a20 7261 6469    "radius": radi
-0000f710: 7573 2c0a 2020 2020 2020 2020 2020 2020  us,.            
-0000f720: 2263 6f73 745f 6661 6374 6f72 223a 2073  "cost_factor": s
-0000f730: 656c 662e 7374 6561 6c2e 636f 7374 5f6d  elf.steal.cost_m
-0000f740: 756c 7469 706c 6965 7273 5b6c 6576 656c  ultipliers[level
-0000f750: 5d2c 0a20 2020 2020 2020 207d 0a0a 2020  ],.        }..  
-0000f760: 2020 2020 2020 7265 7475 726e 2064 0a0a        return d..
-0000f770: 2020 2020 4077 6974 686f 7574 5f70 726f      @without_pro
-0000f780: 7065 7274 795f 7661 6c69 6461 7469 6f6e  perty_validation
-0000f790: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-0000f7a0: 0a20 2020 2064 6566 2075 7064 6174 6528  .    def update(
-0000f7b0: 7365 6c66 293a 0a20 2020 2020 2020 206c  self):.        l
-0000f7c0: 6f67 203d 2073 656c 662e 7363 6865 6475  og = self.schedu
-0000f7d0: 6c65 722e 6765 745f 6576 656e 7473 2874  ler.get_events(t
-0000f7e0: 6f70 6963 3d22 7374 6561 6c69 6e67 2229  opic="stealing")
-0000f7f0: 0a20 2020 2020 2020 2063 7572 7265 6e74  .        current
-0000f800: 203d 206c 656e 2873 656c 662e 7363 6865   = len(self.sche
-0000f810: 6475 6c65 722e 6576 656e 7473 5b22 7374  duler.events["st
-0000f820: 6561 6c69 6e67 225d 290a 2020 2020 2020  ealing"]).      
-0000f830: 2020 6e20 3d20 6375 7272 656e 7420 2d20    n = current - 
-0000f840: 7365 6c66 2e6c 6173 740a 0a20 2020 2020  self.last..     
-0000f850: 2020 206c 6f67 203d 205b 6c6f 675b 2d69     log = [log[-i
-0000f860: 5d5b 315d 5b31 5d20 666f 7220 6920 696e  ][1][1] for i in
-0000f870: 2072 616e 6765 2831 2c20 6e20 2b20 3129   range(1, n + 1)
-0000f880: 2069 6620 6c6f 675b 2d69 5d5b 315d 5b30   if log[-i][1][0
-0000f890: 5d20 3d3d 2022 7265 7175 6573 7422 5d0a  ] == "request"].
-0000f8a0: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
-0000f8b0: 7420 3d20 6375 7272 656e 740a 0a20 2020  t = current..   
-0000f8c0: 2020 2020 2069 6620 6c6f 673a 0a20 2020       if log:.   
-0000f8d0: 2020 2020 2020 2020 206e 6577 203d 2070           new = p
-0000f8e0: 6970 6528 0a20 2020 2020 2020 2020 2020  ipe(.           
-0000f8f0: 2020 2020 206c 6f67 2c0a 2020 2020 2020       log,.      
-0000f900: 2020 2020 2020 2020 2020 6d61 7028 6772            map(gr
-0000f910: 6f75 7062 7928 3129 292c 0a20 2020 2020  oupby(1)),.     
-0000f920: 2020 2020 2020 2020 2020 206d 6170 2864             map(d
-0000f930: 6963 742e 7661 6c75 6573 292c 0a20 2020  ict.values),.   
-0000f940: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0000f950: 6361 742c 0a20 2020 2020 2020 2020 2020  cat,.           
-0000f960: 2020 2020 206d 6170 2873 656c 662e 636f       map(self.co
-0000f970: 6e76 6572 7429 2c0a 2020 2020 2020 2020  nvert),.        
-0000f980: 2020 2020 2020 2020 6c69 7374 2c0a 2020          list,.  
-0000f990: 2020 2020 2020 2020 2020 2020 2020 7472                tr
-0000f9a0: 616e 7370 6f73 652c 0a20 2020 2020 2020  anspose,.       
-0000f9b0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0000f9c0: 2020 2069 6620 5052 4f46 494c 494e 473a     if PROFILING:
-0000f9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f9e0: 2063 7572 646f 6328 292e 6164 645f 6e65   curdoc().add_ne
-0000f9f0: 7874 5f74 6963 6b5f 6361 6c6c 6261 636b  xt_tick_callback
-0000fa00: 286c 616d 6264 613a 2073 656c 662e 736f  (lambda: self.so
-0000fa10: 7572 6365 2e73 7472 6561 6d28 6e65 772c  urce.stream(new,
-0000fa20: 2031 3030 3030 2929 0a20 2020 2020 2020   10000)).       
-0000fa30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0000fa40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000fa50: 736f 7572 6365 2e73 7472 6561 6d28 6e65  source.stream(ne
-0000fa60: 772c 2031 3030 3030 290a 0a0a 636c 6173  w, 10000)...clas
-0000fa70: 7320 4576 656e 7473 2844 6173 6862 6f61  s Events(Dashboa
-0000fa80: 7264 436f 6d70 6f6e 656e 7429 3a0a 2020  rdComponent):.  
-0000fa90: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-0000faa0: 656c 662c 2073 6368 6564 756c 6572 2c20  elf, scheduler, 
-0000fab0: 6e61 6d65 2c20 6865 6967 6874 3d31 3530  name, height=150
-0000fac0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
-0000fad0: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-0000fae0: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-0000faf0: 2020 2020 2020 2020 7365 6c66 2e61 6374          self.act
-0000fb00: 696f 6e5f 7973 203d 2064 6963 7428 290a  ion_ys = dict().
-0000fb10: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
-0000fb20: 7420 3d20 300a 2020 2020 2020 2020 7365  t = 0.        se
-0000fb30: 6c66 2e6e 616d 6520 3d20 6e61 6d65 0a20  lf.name = name. 
-0000fb40: 2020 2020 2020 2073 656c 662e 736f 7572         self.sour
-0000fb50: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
-0000fb60: 6f75 7263 6528 0a20 2020 2020 2020 2020  ource(.         
-0000fb70: 2020 207b 2274 696d 6522 3a20 5b5d 2c20     {"time": [], 
-0000fb80: 2261 6374 696f 6e22 3a20 5b5d 2c20 2268  "action": [], "h
-0000fb90: 6f76 6572 223a 205b 5d2c 2022 7922 3a20  over": [], "y": 
-0000fba0: 5b5d 2c20 2263 6f6c 6f72 223a 205b 5d7d  [], "color": []}
-0000fbb0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0000fbc0: 2020 2020 785f 7261 6e67 6520 3d20 4461      x_range = Da
-0000fbd0: 7461 5261 6e67 6531 6428 666f 6c6c 6f77  taRange1d(follow
-0000fbe0: 3d22 656e 6422 2c20 666f 6c6c 6f77 5f69  ="end", follow_i
-0000fbf0: 6e74 6572 7661 6c3d 3230 3030 3030 290a  nterval=200000).
-0000fc00: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0000fc10: 6f74 203d 2066 6967 7572 6528 0a20 2020  ot = figure(.   
-0000fc20: 2020 2020 2020 2020 2074 6974 6c65 3d6e           title=n
-0000fc30: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-0000fc40: 2078 5f61 7869 735f 7479 7065 3d22 6461   x_axis_type="da
-0000fc50: 7465 7469 6d65 222c 0a20 2020 2020 2020  tetime",.       
-0000fc60: 2020 2020 2068 6569 6768 743d 6865 6967       height=heig
-0000fc70: 6874 2c0a 2020 2020 2020 2020 2020 2020  ht,.            
-0000fc80: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-0000fc90: 2020 2020 2020 785f 7261 6e67 653d 785f        x_range=x_
-0000fca0: 7261 6e67 652c 0a20 2020 2020 2020 2020  range,.         
-0000fcb0: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
-0000fcc0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0000fcd0: 7365 6c66 2e72 6f6f 742e 6369 7263 6c65  self.root.circle
-0000fce0: 280a 2020 2020 2020 2020 2020 2020 736f  (.            so
-0000fcf0: 7572 6365 3d73 656c 662e 736f 7572 6365  urce=self.source
-0000fd00: 2c0a 2020 2020 2020 2020 2020 2020 783d  ,.            x=
-0000fd10: 2274 696d 6522 2c0a 2020 2020 2020 2020  "time",.        
-0000fd20: 2020 2020 793d 2279 222c 0a20 2020 2020      y="y",.     
-0000fd30: 2020 2020 2020 2063 6f6c 6f72 3d22 636f         color="co
-0000fd40: 6c6f 7222 2c0a 2020 2020 2020 2020 2020  lor",.          
-0000fd50: 2020 7369 7a65 3d35 302c 0a20 2020 2020    size=50,.     
-0000fd60: 2020 2020 2020 2061 6c70 6861 3d30 2e35         alpha=0.5
-0000fd70: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
-0000fd80: 6765 6e64 5f66 6965 6c64 3d22 6163 7469  gend_field="acti
-0000fd90: 6f6e 222c 0a20 2020 2020 2020 2029 0a20  on",.        ). 
-0000fda0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0000fdb0: 2e79 6178 6973 2e61 7869 735f 6c61 6265  .yaxis.axis_labe
-0000fdc0: 6c20 3d20 2241 6374 696f 6e22 0a20 2020  l = "Action".   
-0000fdd0: 2020 2020 2073 656c 662e 726f 6f74 2e6c       self.root.l
-0000fde0: 6567 656e 642e 6c6f 6361 7469 6f6e 203d  egend.location =
-0000fdf0: 2022 746f 705f 6c65 6674 220a 0a20 2020   "top_left"..   
-0000fe00: 2020 2020 2068 6f76 6572 203d 2048 6f76       hover = Hov
-0000fe10: 6572 546f 6f6c 2829 0a20 2020 2020 2020  erTool().       
-0000fe20: 2068 6f76 6572 2e74 6f6f 6c74 6970 7320   hover.tooltips 
-0000fe30: 3d20 2240 6163 7469 6f6e 3c62 723e 4068  = "@action<br>@h
-0000fe40: 6f76 6572 220a 2020 2020 2020 2020 686f  over".        ho
-0000fe50: 7665 722e 706f 696e 745f 706f 6c69 6379  ver.point_policy
-0000fe60: 203d 2022 666f 6c6c 6f77 5f6d 6f75 7365   = "follow_mouse
-0000fe70: 220a 0a20 2020 2020 2020 2073 656c 662e  "..        self.
-0000fe80: 726f 6f74 2e61 6464 5f74 6f6f 6c73 280a  root.add_tools(.
-0000fe90: 2020 2020 2020 2020 2020 2020 686f 7665              hove
-0000fea0: 722c 0a20 2020 2020 2020 2020 2020 2052  r,.            R
-0000feb0: 6573 6574 546f 6f6c 2829 2c0a 2020 2020  esetTool(),.    
-0000fec0: 2020 2020 2020 2020 5061 6e54 6f6f 6c28          PanTool(
-0000fed0: 6469 6d65 6e73 696f 6e73 3d22 7769 6474  dimensions="widt
-0000fee0: 6822 292c 0a20 2020 2020 2020 2020 2020  h"),.           
-0000fef0: 2057 6865 656c 5a6f 6f6d 546f 6f6c 2864   WheelZoomTool(d
-0000ff00: 696d 656e 7369 6f6e 733d 2277 6964 7468  imensions="width
-0000ff10: 2229 2c0a 2020 2020 2020 2020 290a 0a20  "),.        ).. 
-0000ff20: 2020 2040 7769 7468 6f75 745f 7072 6f70     @without_prop
-0000ff30: 6572 7479 5f76 616c 6964 6174 696f 6e0a  erty_validation.
-0000ff40: 2020 2020 406c 6f67 5f65 7272 6f72 730a      @log_errors.
-0000ff50: 2020 2020 6465 6620 7570 6461 7465 2873      def update(s
-0000ff60: 656c 6629 3a0a 2020 2020 2020 2020 6c6f  elf):.        lo
-0000ff70: 6720 3d20 7365 6c66 2e73 6368 6564 756c  g = self.schedul
-0000ff80: 6572 2e65 7665 6e74 735b 7365 6c66 2e6e  er.events[self.n
-0000ff90: 616d 655d 0a20 2020 2020 2020 206e 203d  ame].        n =
-0000ffa0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-0000ffb0: 6576 656e 745f 636f 756e 7473 5b73 656c  event_counts[sel
-0000ffc0: 662e 6e61 6d65 5d20 2d20 7365 6c66 2e6c  f.name] - self.l
-0000ffd0: 6173 740a 2020 2020 2020 2020 6966 206c  ast.        if l
-0000ffe0: 6f67 3a0a 2020 2020 2020 2020 2020 2020  og:.            
-0000fff0: 6c6f 6720 3d20 5b6c 6f67 5b2d 695d 2066  log = [log[-i] f
-00010000: 6f72 2069 2069 6e20 7261 6e67 6528 312c  or i in range(1,
-00010010: 206e 202b 2031 295d 0a20 2020 2020 2020   n + 1)].       
-00010020: 2073 656c 662e 6c61 7374 203d 2073 656c   self.last = sel
-00010030: 662e 7363 6865 6475 6c65 722e 6576 656e  f.scheduler.even
-00010040: 745f 636f 756e 7473 5b73 656c 662e 6e61  t_counts[self.na
-00010050: 6d65 5d0a 0a20 2020 2020 2020 2069 6620  me]..        if 
-00010060: 6c6f 673a 0a20 2020 2020 2020 2020 2020  log:.           
-00010070: 2061 6374 696f 6e73 203d 205b 5d0a 2020   actions = [].  
-00010080: 2020 2020 2020 2020 2020 7469 6d65 7320            times 
-00010090: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-000100a0: 2068 6f76 6572 7320 3d20 5b5d 0a20 2020   hovers = [].   
-000100b0: 2020 2020 2020 2020 2079 7320 3d20 5b5d           ys = []
-000100c0: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
-000100d0: 6f72 7320 3d20 5b5d 0a20 2020 2020 2020  ors = [].       
-000100e0: 2020 2020 2066 6f72 206d 7367 5f74 696d       for msg_tim
-000100f0: 652c 206d 7367 2069 6e20 6c6f 673a 0a20  e, msg in log:. 
-00010100: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00010110: 696d 6573 2e61 7070 656e 6428 6d73 675f  imes.append(msg_
-00010120: 7469 6d65 202a 2031 3030 3029 0a20 2020  time * 1000).   
-00010130: 2020 2020 2020 2020 2020 2020 2061 6374               act
-00010140: 696f 6e20 3d20 6d73 675b 2261 6374 696f  ion = msg["actio
-00010150: 6e22 5d0a 2020 2020 2020 2020 2020 2020  n"].            
-00010160: 2020 2020 6163 7469 6f6e 732e 6170 7065      actions.appe
-00010170: 6e64 2861 6374 696f 6e29 0a20 2020 2020  nd(action).     
-00010180: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00010190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000101a0: 2020 2020 7973 2e61 7070 656e 6428 7365      ys.append(se
-000101b0: 6c66 2e61 6374 696f 6e5f 7973 5b61 6374  lf.action_ys[act
-000101c0: 696f 6e5d 290a 2020 2020 2020 2020 2020  ion]).          
-000101d0: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
-000101e0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-000101f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00010200: 6163 7469 6f6e 5f79 735b 6163 7469 6f6e  action_ys[action
-00010210: 5d20 3d20 6c65 6e28 7365 6c66 2e61 6374  ] = len(self.act
-00010220: 696f 6e5f 7973 290a 2020 2020 2020 2020  ion_ys).        
-00010230: 2020 2020 2020 2020 2020 2020 7973 2e61              ys.a
-00010240: 7070 656e 6428 7365 6c66 2e61 6374 696f  ppend(self.actio
-00010250: 6e5f 7973 5b61 6374 696f 6e5d 290a 2020  n_ys[action]).  
-00010260: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00010270: 6c6f 7273 2e61 7070 656e 6428 636f 6c6f  lors.append(colo
-00010280: 725f 6f66 2861 6374 696f 6e29 290a 2020  r_of(action)).  
-00010290: 2020 2020 2020 2020 2020 2020 2020 686f                ho
-000102a0: 7665 7273 2e61 7070 656e 6428 2254 4f44  vers.append("TOD
-000102b0: 4f22 290a 0a20 2020 2020 2020 2020 2020  O")..           
-000102c0: 206e 6577 203d 207b 0a20 2020 2020 2020   new = {.       
-000102d0: 2020 2020 2020 2020 2022 7469 6d65 223a           "time":
-000102e0: 2074 696d 6573 2c0a 2020 2020 2020 2020   times,.        
-000102f0: 2020 2020 2020 2020 2261 6374 696f 6e22          "action"
-00010300: 3a20 6163 7469 6f6e 732c 0a20 2020 2020  : actions,.     
-00010310: 2020 2020 2020 2020 2020 2022 686f 7665             "hove
-00010320: 7222 3a20 686f 7665 7273 2c0a 2020 2020  r": hovers,.    
-00010330: 2020 2020 2020 2020 2020 2020 2279 223a              "y":
-00010340: 2079 732c 0a20 2020 2020 2020 2020 2020   ys,.           
-00010350: 2020 2020 2022 636f 6c6f 7222 3a20 636f       "color": co
-00010360: 6c6f 7273 2c0a 2020 2020 2020 2020 2020  lors,.          
-00010370: 2020 7d0a 0a20 2020 2020 2020 2020 2020    }..           
-00010380: 2069 6620 5052 4f46 494c 494e 473a 0a20   if PROFILING:. 
-00010390: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-000103a0: 7572 646f 6328 292e 6164 645f 6e65 7874  urdoc().add_next
-000103b0: 5f74 6963 6b5f 6361 6c6c 6261 636b 286c  _tick_callback(l
-000103c0: 616d 6264 613a 2073 656c 662e 736f 7572  ambda: self.sour
-000103d0: 6365 2e73 7472 6561 6d28 6e65 772c 2031  ce.stream(new, 1
-000103e0: 3030 3030 2929 0a20 2020 2020 2020 2020  0000)).         
-000103f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00010400: 2020 2020 2020 2020 2073 656c 662e 736f           self.so
-00010410: 7572 6365 2e73 7472 6561 6d28 6e65 772c  urce.stream(new,
-00010420: 2031 3030 3030 290a 0a0a 636c 6173 7320   10000)...class 
-00010430: 5461 736b 5374 7265 616d 2844 6173 6862  TaskStream(Dashb
-00010440: 6f61 7264 436f 6d70 6f6e 656e 7429 3a0a  oardComponent):.
-00010450: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
-00010460: 2873 656c 662c 2073 6368 6564 756c 6572  (self, scheduler
-00010470: 2c20 6e5f 7265 6374 616e 676c 6573 3d31  , n_rectangles=1
-00010480: 3030 302c 2063 6c65 6172 5f69 6e74 6572  000, clear_inter
-00010490: 7661 6c3d 2232 3073 222c 202a 2a6b 7761  val="20s", **kwa
-000104a0: 7267 7329 3a0a 2020 2020 2020 2020 7365  rgs):.        se
-000104b0: 6c66 2e73 6368 6564 756c 6572 203d 2073  lf.scheduler = s
-000104c0: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
-000104d0: 2073 656c 662e 6f66 6673 6574 203d 2030   self.offset = 0
-000104e0: 0a0a 2020 2020 2020 2020 6966 2054 6173  ..        if Tas
-000104f0: 6b53 7472 6561 6d50 6c75 6769 6e2e 6e61  kStreamPlugin.na
-00010500: 6d65 206e 6f74 2069 6e20 7365 6c66 2e73  me not in self.s
-00010510: 6368 6564 756c 6572 2e70 6c75 6769 6e73  cheduler.plugins
-00010520: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00010530: 6c66 2e73 6368 6564 756c 6572 2e61 6464  lf.scheduler.add
-00010540: 5f70 6c75 6769 6e28 5461 736b 5374 7265  _plugin(TaskStre
-00010550: 616d 506c 7567 696e 2873 656c 662e 7363  amPlugin(self.sc
-00010560: 6865 6475 6c65 7229 290a 2020 2020 2020  heduler)).      
-00010570: 2020 7365 6c66 2e70 6c75 6769 6e20 3d20    self.plugin = 
-00010580: 7365 6c66 2e73 6368 6564 756c 6572 2e70  self.scheduler.p
-00010590: 6c75 6769 6e73 5b54 6173 6b53 7472 6561  lugins[TaskStrea
-000105a0: 6d50 6c75 6769 6e2e 6e61 6d65 5d0a 0a20  mPlugin.name].. 
-000105b0: 2020 2020 2020 2073 656c 662e 696e 6465         self.inde
-000105c0: 7820 3d20 6d61 7828 302c 2073 656c 662e  x = max(0, self.
-000105d0: 706c 7567 696e 2e69 6e64 6578 202d 206e  plugin.index - n
-000105e0: 5f72 6563 7461 6e67 6c65 7329 0a20 2020  _rectangles).   
-000105f0: 2020 2020 2073 656c 662e 776f 726b 6572       self.worker
-00010600: 7320 3d20 6469 6374 2829 0a20 2020 2020  s = dict().     
-00010610: 2020 2073 656c 662e 6e5f 7265 6374 616e     self.n_rectan
-00010620: 676c 6573 203d 206e 5f72 6563 7461 6e67  gles = n_rectang
-00010630: 6c65 730a 2020 2020 2020 2020 636c 6561  les.        clea
-00010640: 725f 696e 7465 7276 616c 203d 2070 6172  r_interval = par
-00010650: 7365 5f74 696d 6564 656c 7461 2863 6c65  se_timedelta(cle
-00010660: 6172 5f69 6e74 6572 7661 6c2c 2064 6566  ar_interval, def
-00010670: 6175 6c74 3d22 6d73 2229 0a20 2020 2020  ault="ms").     
-00010680: 2020 2073 656c 662e 636c 6561 725f 696e     self.clear_in
-00010690: 7465 7276 616c 203d 2063 6c65 6172 5f69  terval = clear_i
-000106a0: 6e74 6572 7661 6c0a 2020 2020 2020 2020  nterval.        
-000106b0: 7365 6c66 2e6c 6173 7420 3d20 300a 2020  self.last = 0.  
-000106c0: 2020 2020 2020 7365 6c66 2e6c 6173 745f        self.last_
-000106d0: 7365 656e 203d 2030 0a0a 2020 2020 2020  seen = 0..      
-000106e0: 2020 7365 6c66 2e73 6f75 7263 652c 2073    self.source, s
-000106f0: 656c 662e 726f 6f74 203d 2074 6173 6b5f  elf.root = task_
-00010700: 7374 7265 616d 5f66 6967 7572 6528 636c  stream_figure(cl
-00010710: 6561 725f 696e 7465 7276 616c 2c20 2a2a  ear_interval, **
-00010720: 6b77 6172 6773 290a 0a20 2020 2020 2020  kwargs)..       
-00010730: 2023 2052 6571 7569 7265 6420 666f 7220   # Required for 
-00010740: 7570 6461 7465 2063 616c 6c62 6163 6b0a  update callback.
-00010750: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-00010760: 6b5f 7374 7265 616d 5f69 6e64 6578 203d  k_stream_index =
-00010770: 205b 305d 0a0a 2020 2020 4077 6974 686f   [0]..    @witho
-00010780: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-00010790: 6461 7469 6f6e 0a20 2020 2040 6c6f 675f  dation.    @log_
-000107a0: 6572 726f 7273 0a20 2020 2064 6566 2075  errors.    def u
-000107b0: 7064 6174 6528 7365 6c66 293a 0a20 2020  pdate(self):.   
-000107c0: 2020 2020 2069 6620 7365 6c66 2e69 6e64       if self.ind
-000107d0: 6578 203d 3d20 7365 6c66 2e70 6c75 6769  ex == self.plugi
-000107e0: 6e2e 696e 6465 783a 0a20 2020 2020 2020  n.index:.       
-000107f0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-00010800: 2020 2020 2069 6620 7365 6c66 2e69 6e64       if self.ind
-00010810: 6578 2061 6e64 206c 656e 2873 656c 662e  ex and len(self.
-00010820: 736f 7572 6365 2e64 6174 615b 2273 7461  source.data["sta
-00010830: 7274 225d 293a 0a20 2020 2020 2020 2020  rt"]):.         
-00010840: 2020 2073 7461 7274 203d 206d 696e 2873     start = min(s
-00010850: 656c 662e 736f 7572 6365 2e64 6174 615b  elf.source.data[
-00010860: 2273 7461 7274 225d 290a 2020 2020 2020  "start"]).      
-00010870: 2020 2020 2020 6475 7261 7469 6f6e 203d        duration =
-00010880: 206d 6178 2873 656c 662e 736f 7572 6365   max(self.source
-00010890: 2e64 6174 615b 2264 7572 6174 696f 6e22  .data["duration"
-000108a0: 5d29 0a20 2020 2020 2020 2020 2020 2062  ]).            b
-000108b0: 6f75 6e64 6172 7920 3d20 2873 656c 662e  oundary = (self.
-000108c0: 6f66 6673 6574 202b 2073 7461 7274 202d  offset + start -
-000108d0: 2064 7572 6174 696f 6e29 202f 2031 3030   duration) / 100
-000108e0: 300a 2020 2020 2020 2020 656c 7365 3a0a  0.        else:.
-000108f0: 2020 2020 2020 2020 2020 2020 626f 756e              boun
-00010900: 6461 7279 203d 2073 656c 662e 6f66 6673  dary = self.offs
-00010910: 6574 0a20 2020 2020 2020 2072 6563 7461  et.        recta
-00010920: 6e67 6c65 7320 3d20 7365 6c66 2e70 6c75  ngles = self.plu
-00010930: 6769 6e2e 7265 6374 616e 676c 6573 280a  gin.rectangles(.
-00010940: 2020 2020 2020 2020 2020 2020 6973 7461              ista
-00010950: 7274 3d73 656c 662e 696e 6465 782c 2077  rt=self.index, w
-00010960: 6f72 6b65 7273 3d73 656c 662e 776f 726b  orkers=self.work
-00010970: 6572 732c 2073 7461 7274 5f62 6f75 6e64  ers, start_bound
-00010980: 6172 793d 626f 756e 6461 7279 0a20 2020  ary=boundary.   
-00010990: 2020 2020 2029 0a20 2020 2020 2020 206e       ).        n
-000109a0: 203d 206c 656e 2872 6563 7461 6e67 6c65   = len(rectangle
-000109b0: 735b 226e 616d 6522 5d29 0a20 2020 2020  s["name"]).     
-000109c0: 2020 2073 656c 662e 696e 6465 7820 3d20     self.index = 
-000109d0: 7365 6c66 2e70 6c75 6769 6e2e 696e 6465  self.plugin.inde
-000109e0: 780a 0a20 2020 2020 2020 2069 6620 6e6f  x..        if no
-000109f0: 7420 7265 6374 616e 676c 6573 5b22 7374  t rectangles["st
-00010a00: 6172 7422 5d3a 0a20 2020 2020 2020 2020  art"]:.         
-00010a10: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-00010a20: 2020 2023 2049 6620 6974 2068 6173 2062     # If it has b
-00010a30: 6565 6e20 6120 7768 696c 6520 7369 6e63  een a while sinc
-00010a40: 6520 7765 2776 6520 7570 6461 7465 6420  e we've updated 
-00010a50: 7468 6520 706c 6f74 0a20 2020 2020 2020  the plot.       
-00010a60: 2069 6620 7469 6d65 2829 203e 2073 656c   if time() > sel
-00010a70: 662e 6c61 7374 5f73 6565 6e20 2b20 7365  f.last_seen + se
-00010a80: 6c66 2e63 6c65 6172 5f69 6e74 6572 7661  lf.clear_interva
-00010a90: 6c3a 0a20 2020 2020 2020 2020 2020 206e  l:.            n
-00010aa0: 6577 5f73 7461 7274 203d 206d 696e 2872  ew_start = min(r
-00010ab0: 6563 7461 6e67 6c65 735b 2273 7461 7274  ectangles["start
-00010ac0: 225d 2920 2d20 7365 6c66 2e6f 6666 7365  "]) - self.offse
-00010ad0: 740a 2020 2020 2020 2020 2020 2020 6f6c  t.            ol
-00010ae0: 645f 7374 6172 7420 3d20 6d69 6e28 7365  d_start = min(se
-00010af0: 6c66 2e73 6f75 7263 652e 6461 7461 5b22  lf.source.data["
-00010b00: 7374 6172 7422 5d29 0a20 2020 2020 2020  start"]).       
-00010b10: 2020 2020 206f 6c64 5f65 6e64 203d 206d       old_end = m
-00010b20: 6178 280a 2020 2020 2020 2020 2020 2020  ax(.            
-00010b30: 2020 2020 6d61 7028 0a20 2020 2020 2020      map(.       
-00010b40: 2020 2020 2020 2020 2020 2020 206f 7065               ope
-00010b50: 7261 746f 722e 6164 642c 0a20 2020 2020  rator.add,.     
-00010b60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00010b70: 656c 662e 736f 7572 6365 2e64 6174 615b  elf.source.data[
-00010b80: 2273 7461 7274 225d 2c0a 2020 2020 2020  "start"],.      
-00010b90: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00010ba0: 6c66 2e73 6f75 7263 652e 6461 7461 5b22  lf.source.data["
-00010bb0: 6475 7261 7469 6f6e 225d 2c0a 2020 2020  duration"],.    
-00010bc0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00010bd0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00010be0: 2020 2020 2020 2020 2064 656e 7369 7479           density
-00010bf0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00010c00: 2020 2020 2073 756d 2873 656c 662e 736f       sum(self.so
-00010c10: 7572 6365 2e64 6174 615b 2264 7572 6174  urce.data["durat
-00010c20: 696f 6e22 5d29 0a20 2020 2020 2020 2020  ion"]).         
-00010c30: 2020 2020 2020 202f 206c 656e 2873 656c         / len(sel
-00010c40: 662e 776f 726b 6572 7329 0a20 2020 2020  f.workers).     
-00010c50: 2020 2020 2020 2020 2020 202f 2028 6f6c             / (ol
-00010c60: 645f 656e 6420 2d20 6f6c 645f 7374 6172  d_end - old_star
-00010c70: 7429 0a20 2020 2020 2020 2020 2020 2029  t).            )
-00010c80: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00010c90: 4966 2077 6869 7465 7370 6163 6520 6973  If whitespace is
-00010ca0: 206d 6f72 6520 7468 616e 2033 7820 7468   more than 3x th
-00010cb0: 6520 6f6c 6420 7769 6474 680a 2020 2020  e old width.    
-00010cc0: 2020 2020 2020 2020 6966 2028 6e65 775f          if (new_
-00010cd0: 7374 6172 7420 2d20 6f6c 645f 656e 6429  start - old_end)
-00010ce0: 203e 2028 6f6c 645f 656e 6420 2d20 6f6c   > (old_end - ol
-00010cf0: 645f 7374 6172 7429 202a 2032 206f 7220  d_start) * 2 or 
-00010d00: 6465 6e73 6974 7920 3c20 302e 3035 3a0a  density < 0.05:.
-00010d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010d20: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
-00010d30: 2e75 7064 6174 6528 7b6b 3a20 5b5d 2066  .update({k: [] f
-00010d40: 6f72 206b 2069 6e20 7265 6374 616e 676c  or k in rectangl
-00010d50: 6573 7d29 2020 2320 636c 6561 720a 2020  es})  # clear.  
-00010d60: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00010d70: 6c66 2e6f 6666 7365 7420 3d20 6d69 6e28  lf.offset = min(
-00010d80: 7265 6374 616e 676c 6573 5b22 7374 6172  rectangles["star
-00010d90: 7422 5d29 2020 2320 7265 6465 6669 6e65  t"])  # redefine
-00010da0: 206f 6666 7365 740a 0a20 2020 2020 2020   offset..       
-00010db0: 2072 6563 7461 6e67 6c65 735b 2273 7461   rectangles["sta
-00010dc0: 7274 225d 203d 205b 7820 2d20 7365 6c66  rt"] = [x - self
-00010dd0: 2e6f 6666 7365 7420 666f 7220 7820 696e  .offset for x in
-00010de0: 2072 6563 7461 6e67 6c65 735b 2273 7461   rectangles["sta
-00010df0: 7274 225d 5d0a 2020 2020 2020 2020 7365  rt"]].        se
-00010e00: 6c66 2e6c 6173 745f 7365 656e 203d 2074  lf.last_seen = t
-00010e10: 696d 6528 290a 0a20 2020 2020 2020 2023  ime()..        #
-00010e20: 2043 6f6e 7665 7274 2074 6f20 6e75 6d70   Convert to nump
-00010e30: 7920 666f 7220 7365 7269 616c 697a 6174  y for serializat
-00010e40: 696f 6e20 7370 6565 640a 2020 2020 2020  ion speed.      
-00010e50: 2020 6966 206e 203e 3d20 3130 2061 6e64    if n >= 10 and
-00010e60: 206e 703a 0a20 2020 2020 2020 2020 2020   np:.           
-00010e70: 2066 6f72 206b 2c20 7620 696e 2072 6563   for k, v in rec
-00010e80: 7461 6e67 6c65 732e 6974 656d 7328 293a  tangles.items():
-00010e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010ea0: 2069 6620 6973 696e 7374 616e 6365 2876   if isinstance(v
-00010eb0: 5b30 5d2c 204e 756d 6265 7229 3a0a 2020  [0], Number):.  
+0000f260: 662e 726f 6f74 2e73 6361 7474 6572 280a  f.root.scatter(.
+0000f270: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+0000f280: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
+0000f290: 2020 2020 2020 2020 2020 2020 783d 2274              x="t
+0000f2a0: 696d 6522 2c0a 2020 2020 2020 2020 2020  ime",.          
+0000f2b0: 2020 793d 226c 6576 656c 222c 0a20 2020    y="level",.   
+0000f2c0: 2020 2020 2020 2020 2063 6f6c 6f72 3d22           color="
+0000f2d0: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
+0000f2e0: 2020 2020 7369 7a65 3d22 7261 6469 7573      size="radius
+0000f2f0: 222c 0a20 2020 2020 2020 2020 2020 2061  ",.            a
+0000f300: 6c70 6861 3d30 2e35 2c0a 2020 2020 2020  lpha=0.5,.      
+0000f310: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0000f320: 2e72 6f6f 742e 7961 7869 732e 6178 6973  .root.yaxis.axis
+0000f330: 5f6c 6162 656c 203d 2022 4c65 7665 6c22  _label = "Level"
+0000f340: 0a0a 2020 2020 2020 2020 686f 7665 7220  ..        hover 
+0000f350: 3d20 486f 7665 7254 6f6f 6c28 290a 2020  = HoverTool().  
+0000f360: 2020 2020 2020 686f 7665 722e 746f 6f6c        hover.tool
+0000f370: 7469 7073 203d 2022 4c65 7665 6c3a 2040  tips = "Level: @
+0000f380: 6c65 7665 6c2c 2044 7572 6174 696f 6e3a  level, Duration:
+0000f390: 2040 6475 7261 7469 6f6e 2c20 436f 756e   @duration, Coun
+0000f3a0: 743a 2040 636f 756e 742c 2043 6f73 7420  t: @count, Cost 
+0000f3b0: 6661 6374 6f72 3a20 4063 6f73 745f 6661  factor: @cost_fa
+0000f3c0: 6374 6f72 220a 2020 2020 2020 2020 686f  ctor".        ho
+0000f3d0: 7665 722e 706f 696e 745f 706f 6c69 6379  ver.point_policy
+0000f3e0: 203d 2022 666f 6c6c 6f77 5f6d 6f75 7365   = "follow_mouse
+0000f3f0: 220a 0a20 2020 2020 2020 2073 656c 662e  "..        self.
+0000f400: 726f 6f74 2e61 6464 5f74 6f6f 6c73 280a  root.add_tools(.
+0000f410: 2020 2020 2020 2020 2020 2020 686f 7665              hove
+0000f420: 722c 0a20 2020 2020 2020 2020 2020 2052  r,.            R
+0000f430: 6573 6574 546f 6f6c 2829 2c0a 2020 2020  esetTool(),.    
+0000f440: 2020 2020 2020 2020 5061 6e54 6f6f 6c28          PanTool(
+0000f450: 6469 6d65 6e73 696f 6e73 3d22 7769 6474  dimensions="widt
+0000f460: 6822 292c 0a20 2020 2020 2020 2020 2020  h"),.           
+0000f470: 2057 6865 656c 5a6f 6f6d 546f 6f6c 2864   WheelZoomTool(d
+0000f480: 696d 656e 7369 6f6e 733d 2277 6964 7468  imensions="width
+0000f490: 2229 2c0a 2020 2020 2020 2020 290a 0a20  "),.        ).. 
+0000f4a0: 2020 2064 6566 2063 6f6e 7665 7274 2873     def convert(s
+0000f4b0: 656c 662c 206d 7367 7329 3a0a 2020 2020  elf, msgs):.    
+0000f4c0: 2020 2020 2222 2243 6f6e 7665 7274 2061      """Convert a
+0000f4d0: 206c 6f67 206d 6573 7361 6765 2074 6f20   log message to 
+0000f4e0: 6120 676c 7970 6822 2222 0a20 2020 2020  a glyph""".     
+0000f4f0: 2020 2074 6f74 616c 5f64 7572 6174 696f     total_duratio
+0000f500: 6e20 3d20 300a 2020 2020 2020 2020 666f  n = 0.        fo
+0000f510: 7220 6d73 6720 696e 206d 7367 733a 0a20  r msg in msgs:. 
+0000f520: 2020 2020 2020 2020 2020 2074 696d 652c             time,
+0000f530: 206c 6576 656c 2c20 6b65 792c 2064 7572   level, key, dur
+0000f540: 6174 696f 6e2c 2073 6174 2c20 6f63 635f  ation, sat, occ_
+0000f550: 7361 742c 2069 646c 2c20 6f63 635f 6964  sat, idl, occ_id
+0000f560: 6c20 3d20 6d73 675b 3a38 5d0a 2020 2020  l = msg[:8].    
+0000f570: 2020 2020 2020 2020 746f 7461 6c5f 6475          total_du
+0000f580: 7261 7469 6f6e 202b 3d20 6475 7261 7469  ration += durati
+0000f590: 6f6e 0a0a 2020 2020 2020 2020 7472 793a  on..        try:
+0000f5a0: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
+0000f5b0: 6f72 203d 2056 6972 6964 6973 3131 5b6c  or = Viridis11[l
+0000f5c0: 6576 656c 5d0a 2020 2020 2020 2020 6578  evel].        ex
+0000f5d0: 6365 7074 2028 4b65 7945 7272 6f72 2c20  cept (KeyError, 
+0000f5e0: 496e 6465 7845 7272 6f72 293a 0a20 2020  IndexError):.   
+0000f5f0: 2020 2020 2020 2020 2063 6f6c 6f72 203d           color =
+0000f600: 2022 626c 6163 6b22 0a0a 2020 2020 2020   "black"..      
+0000f610: 2020 7261 6469 7573 203d 206d 6174 682e    radius = math.
+0000f620: 7371 7274 286d 696e 2874 6f74 616c 5f64  sqrt(min(total_d
+0000f630: 7572 6174 696f 6e2c 2031 3029 2920 2a20  uration, 10)) * 
+0000f640: 3330 202b 2032 0a0a 2020 2020 2020 2020  30 + 2..        
+0000f650: 6420 3d20 7b0a 2020 2020 2020 2020 2020  d = {.          
+0000f660: 2020 2274 696d 6522 3a20 7469 6d65 202a    "time": time *
+0000f670: 2031 3030 302c 0a20 2020 2020 2020 2020   1000,.         
+0000f680: 2020 2022 6c65 7665 6c22 3a20 6c65 7665     "level": leve
+0000f690: 6c2c 0a20 2020 2020 2020 2020 2020 2022  l,.            "
+0000f6a0: 636f 756e 7422 3a20 6c65 6e28 6d73 6773  count": len(msgs
+0000f6b0: 292c 0a20 2020 2020 2020 2020 2020 2022  ),.            "
+0000f6c0: 636f 6c6f 7222 3a20 636f 6c6f 722c 0a20  color": color,. 
+0000f6d0: 2020 2020 2020 2020 2020 2022 6475 7261             "dura
+0000f6e0: 7469 6f6e 223a 2074 6f74 616c 5f64 7572  tion": total_dur
+0000f6f0: 6174 696f 6e2c 0a20 2020 2020 2020 2020  ation,.         
+0000f700: 2020 2022 7261 6469 7573 223a 2072 6164     "radius": rad
+0000f710: 6975 732c 0a20 2020 2020 2020 2020 2020  ius,.           
+0000f720: 2022 636f 7374 5f66 6163 746f 7222 3a20   "cost_factor": 
+0000f730: 7365 6c66 2e73 7465 616c 2e63 6f73 745f  self.steal.cost_
+0000f740: 6d75 6c74 6970 6c69 6572 735b 6c65 7665  multipliers[leve
+0000f750: 6c5d 2c0a 2020 2020 2020 2020 7d0a 0a20  l],.        }.. 
+0000f760: 2020 2020 2020 2072 6574 7572 6e20 640a         return d.
+0000f770: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
+0000f780: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
+0000f790: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
+0000f7a0: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
+0000f7b0: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000f7c0: 6c6f 6720 3d20 7365 6c66 2e73 6368 6564  log = self.sched
+0000f7d0: 756c 6572 2e67 6574 5f65 7665 6e74 7328  uler.get_events(
+0000f7e0: 746f 7069 633d 2273 7465 616c 696e 6722  topic="stealing"
+0000f7f0: 290a 2020 2020 2020 2020 6375 7272 656e  ).        curren
+0000f800: 7420 3d20 6c65 6e28 7365 6c66 2e73 6368  t = len(self.sch
+0000f810: 6564 756c 6572 2e65 7665 6e74 735b 2273  eduler.events["s
+0000f820: 7465 616c 696e 6722 5d29 0a20 2020 2020  tealing"]).     
+0000f830: 2020 206e 203d 2063 7572 7265 6e74 202d     n = current -
+0000f840: 2073 656c 662e 6c61 7374 0a0a 2020 2020   self.last..    
+0000f850: 2020 2020 6c6f 6720 3d20 5b6c 6f67 5b2d      log = [log[-
+0000f860: 695d 5b31 5d5b 315d 2066 6f72 2069 2069  i][1][1] for i i
+0000f870: 6e20 7261 6e67 6528 312c 206e 202b 2031  n range(1, n + 1
+0000f880: 2920 6966 206c 6f67 5b2d 695d 5b31 5d5b  ) if log[-i][1][
+0000f890: 305d 203d 3d20 2272 6571 7565 7374 225d  0] == "request"]
+0000f8a0: 0a20 2020 2020 2020 2073 656c 662e 6c61  .        self.la
+0000f8b0: 7374 203d 2063 7572 7265 6e74 0a0a 2020  st = current..  
+0000f8c0: 2020 2020 2020 6966 206c 6f67 3a0a 2020        if log:.  
+0000f8d0: 2020 2020 2020 2020 2020 6e65 7720 3d20            new = 
+0000f8e0: 7069 7065 280a 2020 2020 2020 2020 2020  pipe(.          
+0000f8f0: 2020 2020 2020 6c6f 672c 0a20 2020 2020        log,.     
+0000f900: 2020 2020 2020 2020 2020 206d 6170 2867             map(g
+0000f910: 726f 7570 6279 2831 2929 2c0a 2020 2020  roupby(1)),.    
+0000f920: 2020 2020 2020 2020 2020 2020 6d61 7028              map(
+0000f930: 6469 6374 2e76 616c 7565 7329 2c0a 2020  dict.values),.  
+0000f940: 2020 2020 2020 2020 2020 2020 2020 636f                co
+0000f950: 6e63 6174 2c0a 2020 2020 2020 2020 2020  ncat,.          
+0000f960: 2020 2020 2020 6d61 7028 7365 6c66 2e63        map(self.c
+0000f970: 6f6e 7665 7274 292c 0a20 2020 2020 2020  onvert),.       
+0000f980: 2020 2020 2020 2020 206c 6973 742c 0a20           list,. 
+0000f990: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0000f9a0: 7261 6e73 706f 7365 2c0a 2020 2020 2020  ranspose,.      
+0000f9b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000f9c0: 2020 2020 6966 2050 524f 4649 4c49 4e47      if PROFILING
+0000f9d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000f9e0: 2020 6375 7264 6f63 2829 2e61 6464 5f6e    curdoc().add_n
+0000f9f0: 6578 745f 7469 636b 5f63 616c 6c62 6163  ext_tick_callbac
+0000fa00: 6b28 6c61 6d62 6461 3a20 7365 6c66 2e73  k(lambda: self.s
+0000fa10: 6f75 7263 652e 7374 7265 616d 286e 6577  ource.stream(new
+0000fa20: 2c20 3130 3030 3029 290a 2020 2020 2020  , 10000)).      
+0000fa30: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000fa40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000fa50: 2e73 6f75 7263 652e 7374 7265 616d 286e  .source.stream(n
+0000fa60: 6577 2c20 3130 3030 3029 0a0a 0a63 6c61  ew, 10000)...cla
+0000fa70: 7373 2045 7665 6e74 7328 4461 7368 626f  ss Events(Dashbo
+0000fa80: 6172 6443 6f6d 706f 6e65 6e74 293a 0a20  ardComponent):. 
+0000fa90: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
+0000faa0: 7365 6c66 2c20 7363 6865 6475 6c65 722c  self, scheduler,
+0000fab0: 206e 616d 652c 2068 6569 6768 743d 3135   name, height=15
+0000fac0: 302c 202a 2a6b 7761 7267 7329 3a0a 2020  0, **kwargs):.  
+0000fad0: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+0000fae0: 756c 6572 203d 2073 6368 6564 756c 6572  uler = scheduler
+0000faf0: 0a20 2020 2020 2020 2073 656c 662e 6163  .        self.ac
+0000fb00: 7469 6f6e 5f79 7320 3d20 6469 6374 2829  tion_ys = dict()
+0000fb10: 0a20 2020 2020 2020 2073 656c 662e 6c61  .        self.la
+0000fb20: 7374 203d 2030 0a20 2020 2020 2020 2073  st = 0.        s
+0000fb30: 656c 662e 6e61 6d65 203d 206e 616d 650a  elf.name = name.
+0000fb40: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
+0000fb50: 7263 6520 3d20 436f 6c75 6d6e 4461 7461  rce = ColumnData
+0000fb60: 536f 7572 6365 280a 2020 2020 2020 2020  Source(.        
+0000fb70: 2020 2020 7b22 7469 6d65 223a 205b 5d2c      {"time": [],
+0000fb80: 2022 6163 7469 6f6e 223a 205b 5d2c 2022   "action": [], "
+0000fb90: 686f 7665 7222 3a20 5b5d 2c20 2279 223a  hover": [], "y":
+0000fba0: 205b 5d2c 2022 636f 6c6f 7222 3a20 5b5d   [], "color": []
+0000fbb0: 7d0a 2020 2020 2020 2020 290a 0a20 2020  }.        )..   
+0000fbc0: 2020 2020 2078 5f72 616e 6765 203d 2044       x_range = D
+0000fbd0: 6174 6152 616e 6765 3164 2866 6f6c 6c6f  ataRange1d(follo
+0000fbe0: 773d 2265 6e64 222c 2066 6f6c 6c6f 775f  w="end", follow_
+0000fbf0: 696e 7465 7276 616c 3d32 3030 3030 3029  interval=200000)
+0000fc00: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+0000fc10: 6f6f 7420 3d20 6669 6775 7265 280a 2020  oot = figure(.  
+0000fc20: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+0000fc30: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
+0000fc40: 2020 785f 6178 6973 5f74 7970 653d 2264    x_axis_type="d
+0000fc50: 6174 6574 696d 6522 2c0a 2020 2020 2020  atetime",.      
+0000fc60: 2020 2020 2020 6865 6967 6874 3d68 6569        height=hei
+0000fc70: 6768 742c 0a20 2020 2020 2020 2020 2020  ght,.           
+0000fc80: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
+0000fc90: 2020 2020 2020 2078 5f72 616e 6765 3d78         x_range=x
+0000fca0: 5f72 616e 6765 2c0a 2020 2020 2020 2020  _range,.        
+0000fcb0: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+0000fcc0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0000fcd0: 2073 656c 662e 726f 6f74 2e73 6361 7474   self.root.scatt
+0000fce0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+0000fcf0: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+0000fd00: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0000fd10: 783d 2274 696d 6522 2c0a 2020 2020 2020  x="time",.      
+0000fd20: 2020 2020 2020 793d 2279 222c 0a20 2020        y="y",.   
+0000fd30: 2020 2020 2020 2020 2063 6f6c 6f72 3d22           color="
+0000fd40: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
+0000fd50: 2020 2020 7369 7a65 3d35 302c 0a20 2020      size=50,.   
+0000fd60: 2020 2020 2020 2020 2061 6c70 6861 3d30           alpha=0
+0000fd70: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
+0000fd80: 6c65 6765 6e64 5f66 6965 6c64 3d22 6163  legend_field="ac
+0000fd90: 7469 6f6e 222c 0a20 2020 2020 2020 2029  tion",.        )
+0000fda0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0000fdb0: 6f74 2e79 6178 6973 2e61 7869 735f 6c61  ot.yaxis.axis_la
+0000fdc0: 6265 6c20 3d20 2241 6374 696f 6e22 0a20  bel = "Action". 
+0000fdd0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0000fde0: 2e6c 6567 656e 642e 6c6f 6361 7469 6f6e  .legend.location
+0000fdf0: 203d 2022 746f 705f 6c65 6674 220a 0a20   = "top_left".. 
+0000fe00: 2020 2020 2020 2068 6f76 6572 203d 2048         hover = H
+0000fe10: 6f76 6572 546f 6f6c 2829 0a20 2020 2020  overTool().     
+0000fe20: 2020 2068 6f76 6572 2e74 6f6f 6c74 6970     hover.tooltip
+0000fe30: 7320 3d20 2240 6163 7469 6f6e 3c62 723e  s = "@action<br>
+0000fe40: 4068 6f76 6572 220a 2020 2020 2020 2020  @hover".        
+0000fe50: 686f 7665 722e 706f 696e 745f 706f 6c69  hover.point_poli
+0000fe60: 6379 203d 2022 666f 6c6c 6f77 5f6d 6f75  cy = "follow_mou
+0000fe70: 7365 220a 0a20 2020 2020 2020 2073 656c  se"..        sel
+0000fe80: 662e 726f 6f74 2e61 6464 5f74 6f6f 6c73  f.root.add_tools
+0000fe90: 280a 2020 2020 2020 2020 2020 2020 686f  (.            ho
+0000fea0: 7665 722c 0a20 2020 2020 2020 2020 2020  ver,.           
+0000feb0: 2052 6573 6574 546f 6f6c 2829 2c0a 2020   ResetTool(),.  
+0000fec0: 2020 2020 2020 2020 2020 5061 6e54 6f6f            PanToo
+0000fed0: 6c28 6469 6d65 6e73 696f 6e73 3d22 7769  l(dimensions="wi
+0000fee0: 6474 6822 292c 0a20 2020 2020 2020 2020  dth"),.         
+0000fef0: 2020 2057 6865 656c 5a6f 6f6d 546f 6f6c     WheelZoomTool
+0000ff00: 2864 696d 656e 7369 6f6e 733d 2277 6964  (dimensions="wid
+0000ff10: 7468 2229 2c0a 2020 2020 2020 2020 290a  th"),.        ).
+0000ff20: 0a20 2020 2040 7769 7468 6f75 745f 7072  .    @without_pr
+0000ff30: 6f70 6572 7479 5f76 616c 6964 6174 696f  operty_validatio
+0000ff40: 6e0a 2020 2020 406c 6f67 5f65 7272 6f72  n.    @log_error
+0000ff50: 730a 2020 2020 6465 6620 7570 6461 7465  s.    def update
+0000ff60: 2873 656c 6629 3a0a 2020 2020 2020 2020  (self):.        
+0000ff70: 6c6f 6720 3d20 7365 6c66 2e73 6368 6564  log = self.sched
+0000ff80: 756c 6572 2e65 7665 6e74 735b 7365 6c66  uler.events[self
+0000ff90: 2e6e 616d 655d 0a20 2020 2020 2020 206e  .name].        n
+0000ffa0: 203d 2073 656c 662e 7363 6865 6475 6c65   = self.schedule
+0000ffb0: 722e 6576 656e 745f 636f 756e 7473 5b73  r.event_counts[s
+0000ffc0: 656c 662e 6e61 6d65 5d20 2d20 7365 6c66  elf.name] - self
+0000ffd0: 2e6c 6173 740a 2020 2020 2020 2020 6966  .last.        if
+0000ffe0: 206c 6f67 3a0a 2020 2020 2020 2020 2020   log:.          
+0000fff0: 2020 6c6f 6720 3d20 5b6c 6f67 5b2d 695d    log = [log[-i]
+00010000: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+00010010: 312c 206e 202b 2031 295d 0a20 2020 2020  1, n + 1)].     
+00010020: 2020 2073 656c 662e 6c61 7374 203d 2073     self.last = s
+00010030: 656c 662e 7363 6865 6475 6c65 722e 6576  elf.scheduler.ev
+00010040: 656e 745f 636f 756e 7473 5b73 656c 662e  ent_counts[self.
+00010050: 6e61 6d65 5d0a 0a20 2020 2020 2020 2069  name]..        i
+00010060: 6620 6c6f 673a 0a20 2020 2020 2020 2020  f log:.         
+00010070: 2020 2061 6374 696f 6e73 203d 205b 5d0a     actions = [].
+00010080: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+00010090: 7320 3d20 5b5d 0a20 2020 2020 2020 2020  s = [].         
+000100a0: 2020 2068 6f76 6572 7320 3d20 5b5d 0a20     hovers = []. 
+000100b0: 2020 2020 2020 2020 2020 2079 7320 3d20             ys = 
+000100c0: 5b5d 0a20 2020 2020 2020 2020 2020 2063  [].            c
+000100d0: 6f6c 6f72 7320 3d20 5b5d 0a20 2020 2020  olors = [].     
+000100e0: 2020 2020 2020 2066 6f72 206d 7367 5f74         for msg_t
+000100f0: 696d 652c 206d 7367 2069 6e20 6c6f 673a  ime, msg in log:
+00010100: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010110: 2074 696d 6573 2e61 7070 656e 6428 6d73   times.append(ms
+00010120: 675f 7469 6d65 202a 2031 3030 3029 0a20  g_time * 1000). 
+00010130: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00010140: 6374 696f 6e20 3d20 6d73 675b 2261 6374  ction = msg["act
+00010150: 696f 6e22 5d0a 2020 2020 2020 2020 2020  ion"].          
+00010160: 2020 2020 2020 6163 7469 6f6e 732e 6170        actions.ap
+00010170: 7065 6e64 2861 6374 696f 6e29 0a20 2020  pend(action).   
+00010180: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00010190: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000101a0: 2020 2020 2020 7973 2e61 7070 656e 6428        ys.append(
+000101b0: 7365 6c66 2e61 6374 696f 6e5f 7973 5b61  self.action_ys[a
+000101c0: 6374 696f 6e5d 290a 2020 2020 2020 2020  ction]).        
+000101d0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+000101e0: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+000101f0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00010200: 662e 6163 7469 6f6e 5f79 735b 6163 7469  f.action_ys[acti
+00010210: 6f6e 5d20 3d20 6c65 6e28 7365 6c66 2e61  on] = len(self.a
+00010220: 6374 696f 6e5f 7973 290a 2020 2020 2020  ction_ys).      
+00010230: 2020 2020 2020 2020 2020 2020 2020 7973                ys
+00010240: 2e61 7070 656e 6428 7365 6c66 2e61 6374  .append(self.act
+00010250: 696f 6e5f 7973 5b61 6374 696f 6e5d 290a  ion_ys[action]).
+00010260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010270: 636f 6c6f 7273 2e61 7070 656e 6428 636f  colors.append(co
+00010280: 6c6f 725f 6f66 2861 6374 696f 6e29 290a  lor_of(action)).
+00010290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000102a0: 686f 7665 7273 2e61 7070 656e 6428 2254  hovers.append("T
+000102b0: 4f44 4f22 290a 0a20 2020 2020 2020 2020  ODO")..         
+000102c0: 2020 206e 6577 203d 207b 0a20 2020 2020     new = {.     
+000102d0: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
+000102e0: 223a 2074 696d 6573 2c0a 2020 2020 2020  ": times,.      
+000102f0: 2020 2020 2020 2020 2020 2261 6374 696f            "actio
+00010300: 6e22 3a20 6163 7469 6f6e 732c 0a20 2020  n": actions,.   
+00010310: 2020 2020 2020 2020 2020 2020 2022 686f               "ho
+00010320: 7665 7222 3a20 686f 7665 7273 2c0a 2020  ver": hovers,.  
+00010330: 2020 2020 2020 2020 2020 2020 2020 2279                "y
+00010340: 223a 2079 732c 0a20 2020 2020 2020 2020  ": ys,.         
+00010350: 2020 2020 2020 2022 636f 6c6f 7222 3a20         "color": 
+00010360: 636f 6c6f 7273 2c0a 2020 2020 2020 2020  colors,.        
+00010370: 2020 2020 7d0a 0a20 2020 2020 2020 2020      }..         
+00010380: 2020 2069 6620 5052 4f46 494c 494e 473a     if PROFILING:
+00010390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000103a0: 2063 7572 646f 6328 292e 6164 645f 6e65   curdoc().add_ne
+000103b0: 7874 5f74 6963 6b5f 6361 6c6c 6261 636b  xt_tick_callback
+000103c0: 286c 616d 6264 613a 2073 656c 662e 736f  (lambda: self.so
+000103d0: 7572 6365 2e73 7472 6561 6d28 6e65 772c  urce.stream(new,
+000103e0: 2031 3030 3030 2929 0a20 2020 2020 2020   10000)).       
+000103f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00010400: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00010410: 736f 7572 6365 2e73 7472 6561 6d28 6e65  source.stream(ne
+00010420: 772c 2031 3030 3030 290a 0a0a 636c 6173  w, 10000)...clas
+00010430: 7320 5461 736b 5374 7265 616d 2844 6173  s TaskStream(Das
+00010440: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
+00010450: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
+00010460: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
+00010470: 6572 2c20 6e5f 7265 6374 616e 676c 6573  er, n_rectangles
+00010480: 3d31 3030 302c 2063 6c65 6172 5f69 6e74  =1000, clear_int
+00010490: 6572 7661 6c3d 2232 3073 222c 202a 2a6b  erval="20s", **k
+000104a0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+000104b0: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
+000104c0: 2073 6368 6564 756c 6572 0a20 2020 2020   scheduler.     
+000104d0: 2020 2073 656c 662e 6f66 6673 6574 203d     self.offset =
+000104e0: 2030 0a0a 2020 2020 2020 2020 6966 2054   0..        if T
+000104f0: 6173 6b53 7472 6561 6d50 6c75 6769 6e2e  askStreamPlugin.
+00010500: 6e61 6d65 206e 6f74 2069 6e20 7365 6c66  name not in self
+00010510: 2e73 6368 6564 756c 6572 2e70 6c75 6769  .scheduler.plugi
+00010520: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00010530: 7365 6c66 2e73 6368 6564 756c 6572 2e61  self.scheduler.a
+00010540: 6464 5f70 6c75 6769 6e28 5461 736b 5374  dd_plugin(TaskSt
+00010550: 7265 616d 506c 7567 696e 2873 656c 662e  reamPlugin(self.
+00010560: 7363 6865 6475 6c65 7229 290a 2020 2020  scheduler)).    
+00010570: 2020 2020 7365 6c66 2e70 6c75 6769 6e20      self.plugin 
+00010580: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
+00010590: 2e70 6c75 6769 6e73 5b54 6173 6b53 7472  .plugins[TaskStr
+000105a0: 6561 6d50 6c75 6769 6e2e 6e61 6d65 5d0a  eamPlugin.name].
+000105b0: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
+000105c0: 6465 7820 3d20 6d61 7828 302c 2073 656c  dex = max(0, sel
+000105d0: 662e 706c 7567 696e 2e69 6e64 6578 202d  f.plugin.index -
+000105e0: 206e 5f72 6563 7461 6e67 6c65 7329 0a20   n_rectangles). 
+000105f0: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
+00010600: 6572 7320 3d20 6469 6374 2829 0a20 2020  ers = dict().   
+00010610: 2020 2020 2073 656c 662e 6e5f 7265 6374       self.n_rect
+00010620: 616e 676c 6573 203d 206e 5f72 6563 7461  angles = n_recta
+00010630: 6e67 6c65 730a 2020 2020 2020 2020 636c  ngles.        cl
+00010640: 6561 725f 696e 7465 7276 616c 203d 2070  ear_interval = p
+00010650: 6172 7365 5f74 696d 6564 656c 7461 2863  arse_timedelta(c
+00010660: 6c65 6172 5f69 6e74 6572 7661 6c2c 2064  lear_interval, d
+00010670: 6566 6175 6c74 3d22 6d73 2229 0a20 2020  efault="ms").   
+00010680: 2020 2020 2073 656c 662e 636c 6561 725f       self.clear_
+00010690: 696e 7465 7276 616c 203d 2063 6c65 6172  interval = clear
+000106a0: 5f69 6e74 6572 7661 6c0a 2020 2020 2020  _interval.      
+000106b0: 2020 7365 6c66 2e6c 6173 7420 3d20 300a    self.last = 0.
+000106c0: 2020 2020 2020 2020 7365 6c66 2e6c 6173          self.las
+000106d0: 745f 7365 656e 203d 2030 0a0a 2020 2020  t_seen = 0..    
+000106e0: 2020 2020 7365 6c66 2e73 6f75 7263 652c      self.source,
+000106f0: 2073 656c 662e 726f 6f74 203d 2074 6173   self.root = tas
+00010700: 6b5f 7374 7265 616d 5f66 6967 7572 6528  k_stream_figure(
+00010710: 636c 6561 725f 696e 7465 7276 616c 2c20  clear_interval, 
+00010720: 2a2a 6b77 6172 6773 290a 0a20 2020 2020  **kwargs)..     
+00010730: 2020 2023 2052 6571 7569 7265 6420 666f     # Required fo
+00010740: 7220 7570 6461 7465 2063 616c 6c62 6163  r update callbac
+00010750: 6b0a 2020 2020 2020 2020 7365 6c66 2e74  k.        self.t
+00010760: 6173 6b5f 7374 7265 616d 5f69 6e64 6578  ask_stream_index
+00010770: 203d 205b 305d 0a0a 2020 2020 4077 6974   = [0]..    @wit
+00010780: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+00010790: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
+000107a0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+000107b0: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
+000107c0: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+000107d0: 6e64 6578 203d 3d20 7365 6c66 2e70 6c75  ndex == self.plu
+000107e0: 6769 6e2e 696e 6465 783a 0a20 2020 2020  gin.index:.     
+000107f0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00010800: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
+00010810: 6e64 6578 2061 6e64 206c 656e 2873 656c  ndex and len(sel
+00010820: 662e 736f 7572 6365 2e64 6174 615b 2273  f.source.data["s
+00010830: 7461 7274 225d 293a 0a20 2020 2020 2020  tart"]):.       
+00010840: 2020 2020 2073 7461 7274 203d 206d 696e       start = min
+00010850: 2873 656c 662e 736f 7572 6365 2e64 6174  (self.source.dat
+00010860: 615b 2273 7461 7274 225d 290a 2020 2020  a["start"]).    
+00010870: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
+00010880: 203d 206d 6178 2873 656c 662e 736f 7572   = max(self.sour
+00010890: 6365 2e64 6174 615b 2264 7572 6174 696f  ce.data["duratio
+000108a0: 6e22 5d29 0a20 2020 2020 2020 2020 2020  n"]).           
+000108b0: 2062 6f75 6e64 6172 7920 3d20 2873 656c   boundary = (sel
+000108c0: 662e 6f66 6673 6574 202b 2073 7461 7274  f.offset + start
+000108d0: 202d 2064 7572 6174 696f 6e29 202f 2031   - duration) / 1
+000108e0: 3030 300a 2020 2020 2020 2020 656c 7365  000.        else
+000108f0: 3a0a 2020 2020 2020 2020 2020 2020 626f  :.            bo
+00010900: 756e 6461 7279 203d 2073 656c 662e 6f66  undary = self.of
+00010910: 6673 6574 0a20 2020 2020 2020 2072 6563  fset.        rec
+00010920: 7461 6e67 6c65 7320 3d20 7365 6c66 2e70  tangles = self.p
+00010930: 6c75 6769 6e2e 7265 6374 616e 676c 6573  lugin.rectangles
+00010940: 280a 2020 2020 2020 2020 2020 2020 6973  (.            is
+00010950: 7461 7274 3d73 656c 662e 696e 6465 782c  tart=self.index,
+00010960: 2077 6f72 6b65 7273 3d73 656c 662e 776f   workers=self.wo
+00010970: 726b 6572 732c 2073 7461 7274 5f62 6f75  rkers, start_bou
+00010980: 6e64 6172 793d 626f 756e 6461 7279 0a20  ndary=boundary. 
+00010990: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000109a0: 206e 203d 206c 656e 2872 6563 7461 6e67   n = len(rectang
+000109b0: 6c65 735b 226e 616d 6522 5d29 0a20 2020  les["name"]).   
+000109c0: 2020 2020 2073 656c 662e 696e 6465 7820       self.index 
+000109d0: 3d20 7365 6c66 2e70 6c75 6769 6e2e 696e  = self.plugin.in
+000109e0: 6465 780a 0a20 2020 2020 2020 2069 6620  dex..        if 
+000109f0: 6e6f 7420 7265 6374 616e 676c 6573 5b22  not rectangles["
+00010a00: 7374 6172 7422 5d3a 0a20 2020 2020 2020  start"]:.       
+00010a10: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+00010a20: 2020 2020 2023 2049 6620 6974 2068 6173       # If it has
+00010a30: 2062 6565 6e20 6120 7768 696c 6520 7369   been a while si
+00010a40: 6e63 6520 7765 2776 6520 7570 6461 7465  nce we've update
+00010a50: 6420 7468 6520 706c 6f74 0a20 2020 2020  d the plot.     
+00010a60: 2020 2069 6620 7469 6d65 2829 203e 2073     if time() > s
+00010a70: 656c 662e 6c61 7374 5f73 6565 6e20 2b20  elf.last_seen + 
+00010a80: 7365 6c66 2e63 6c65 6172 5f69 6e74 6572  self.clear_inter
+00010a90: 7661 6c3a 0a20 2020 2020 2020 2020 2020  val:.           
+00010aa0: 206e 6577 5f73 7461 7274 203d 206d 696e   new_start = min
+00010ab0: 2872 6563 7461 6e67 6c65 735b 2273 7461  (rectangles["sta
+00010ac0: 7274 225d 2920 2d20 7365 6c66 2e6f 6666  rt"]) - self.off
+00010ad0: 7365 740a 2020 2020 2020 2020 2020 2020  set.            
+00010ae0: 6f6c 645f 7374 6172 7420 3d20 6d69 6e28  old_start = min(
+00010af0: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
+00010b00: 5b22 7374 6172 7422 5d29 0a20 2020 2020  ["start"]).     
+00010b10: 2020 2020 2020 206f 6c64 5f65 6e64 203d         old_end =
+00010b20: 206d 6178 280a 2020 2020 2020 2020 2020   max(.          
+00010b30: 2020 2020 2020 6d61 7028 0a20 2020 2020        map(.     
+00010b40: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+00010b50: 7065 7261 746f 722e 6164 642c 0a20 2020  perator.add,.   
+00010b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010b70: 2073 656c 662e 736f 7572 6365 2e64 6174   self.source.dat
+00010b80: 615b 2273 7461 7274 225d 2c0a 2020 2020  a["start"],.    
+00010b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ba0: 7365 6c66 2e73 6f75 7263 652e 6461 7461  self.source.data
+00010bb0: 5b22 6475 7261 7469 6f6e 225d 2c0a 2020  ["duration"],.  
+00010bc0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00010bd0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00010be0: 2020 2020 2020 2020 2020 2064 656e 7369             densi
+00010bf0: 7479 203d 2028 0a20 2020 2020 2020 2020  ty = (.         
+00010c00: 2020 2020 2020 2073 756d 2873 656c 662e         sum(self.
+00010c10: 736f 7572 6365 2e64 6174 615b 2264 7572  source.data["dur
+00010c20: 6174 696f 6e22 5d29 0a20 2020 2020 2020  ation"]).       
+00010c30: 2020 2020 2020 2020 202f 206c 656e 2873           / len(s
+00010c40: 656c 662e 776f 726b 6572 7329 0a20 2020  elf.workers).   
+00010c50: 2020 2020 2020 2020 2020 2020 202f 2028               / (
+00010c60: 6f6c 645f 656e 6420 2d20 6f6c 645f 7374  old_end - old_st
+00010c70: 6172 7429 0a20 2020 2020 2020 2020 2020  art).           
+00010c80: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+00010c90: 2320 4966 2077 6869 7465 7370 6163 6520  # If whitespace 
+00010ca0: 6973 206d 6f72 6520 7468 616e 2033 7820  is more than 3x 
+00010cb0: 7468 6520 6f6c 6420 7769 6474 680a 2020  the old width.  
+00010cc0: 2020 2020 2020 2020 2020 6966 2028 6e65            if (ne
+00010cd0: 775f 7374 6172 7420 2d20 6f6c 645f 656e  w_start - old_en
+00010ce0: 6429 203e 2028 6f6c 645f 656e 6420 2d20  d) > (old_end - 
+00010cf0: 6f6c 645f 7374 6172 7429 202a 2032 206f  old_start) * 2 o
+00010d00: 7220 6465 6e73 6974 7920 3c20 302e 3035  r density < 0.05
+00010d10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010d20: 2020 7365 6c66 2e73 6f75 7263 652e 6461    self.source.da
+00010d30: 7461 2e75 7064 6174 6528 7b6b 3a20 5b5d  ta.update({k: []
+00010d40: 2066 6f72 206b 2069 6e20 7265 6374 616e   for k in rectan
+00010d50: 676c 6573 7d29 2020 2320 636c 6561 720a  gles})  # clear.
+00010d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d70: 7365 6c66 2e6f 6666 7365 7420 3d20 6d69  self.offset = mi
+00010d80: 6e28 7265 6374 616e 676c 6573 5b22 7374  n(rectangles["st
+00010d90: 6172 7422 5d29 2020 2320 7265 6465 6669  art"])  # redefi
+00010da0: 6e65 206f 6666 7365 740a 0a20 2020 2020  ne offset..     
+00010db0: 2020 2072 6563 7461 6e67 6c65 735b 2273     rectangles["s
+00010dc0: 7461 7274 225d 203d 205b 7820 2d20 7365  tart"] = [x - se
+00010dd0: 6c66 2e6f 6666 7365 7420 666f 7220 7820  lf.offset for x 
+00010de0: 696e 2072 6563 7461 6e67 6c65 735b 2273  in rectangles["s
+00010df0: 7461 7274 225d 5d0a 2020 2020 2020 2020  tart"]].        
+00010e00: 7365 6c66 2e6c 6173 745f 7365 656e 203d  self.last_seen =
+00010e10: 2074 696d 6528 290a 0a20 2020 2020 2020   time()..       
+00010e20: 2023 2043 6f6e 7665 7274 2074 6f20 6e75   # Convert to nu
+00010e30: 6d70 7920 666f 7220 7365 7269 616c 697a  mpy for serializ
+00010e40: 6174 696f 6e20 7370 6565 640a 2020 2020  ation speed.    
+00010e50: 2020 2020 6966 206e 203e 3d20 3130 2061      if n >= 10 a
+00010e60: 6e64 206e 703a 0a20 2020 2020 2020 2020  nd np:.         
+00010e70: 2020 2066 6f72 206b 2c20 7620 696e 2072     for k, v in r
+00010e80: 6563 7461 6e67 6c65 732e 6974 656d 7328  ectangles.items(
+00010e90: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00010ea0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00010eb0: 2876 5b30 5d2c 204e 756d 6265 7229 3a0a  (v[0], Number):.
 00010ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010ed0: 2020 7265 6374 616e 676c 6573 5b6b 5d20    rectangles[k] 
-00010ee0: 3d20 6e70 2e61 7272 6179 2876 290a 0a20  = np.array(v).. 
-00010ef0: 2020 2020 2020 2069 6620 5052 4f46 494c         if PROFIL
-00010f00: 494e 473a 0a20 2020 2020 2020 2020 2020  ING:.           
-00010f10: 2063 7572 646f 6328 292e 6164 645f 6e65   curdoc().add_ne
-00010f20: 7874 5f74 6963 6b5f 6361 6c6c 6261 636b  xt_tick_callback
-00010f30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00010f40: 2020 6c61 6d62 6461 3a20 7365 6c66 2e73    lambda: self.s
-00010f50: 6f75 7263 652e 7374 7265 616d 2872 6563  ource.stream(rec
-00010f60: 7461 6e67 6c65 732c 2073 656c 662e 6e5f  tangles, self.n_
-00010f70: 7265 6374 616e 676c 6573 290a 2020 2020  rectangles).    
-00010f80: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00010f90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00010fa0: 2020 2020 7365 6c66 2e73 6f75 7263 652e      self.source.
-00010fb0: 7374 7265 616d 2872 6563 7461 6e67 6c65  stream(rectangle
-00010fc0: 732c 2073 656c 662e 6e5f 7265 6374 616e  s, self.n_rectan
-00010fd0: 676c 6573 290a 0a0a 6465 6620 7461 736b  gles)...def task
-00010fe0: 5f73 7472 6561 6d5f 6669 6775 7265 2863  _stream_figure(c
-00010ff0: 6c65 6172 5f69 6e74 6572 7661 6c3d 2232  lear_interval="2
-00011000: 3073 222c 202a 2a6b 7761 7267 7329 3a0a  0s", **kwargs):.
-00011010: 2020 2020 2222 220a 2020 2020 6b77 6172      """.    kwar
-00011020: 6773 2061 7265 2061 7070 6c69 6564 2074  gs are applied t
-00011030: 6f20 7468 6520 626f 6b65 682e 6d6f 6465  o the bokeh.mode
-00011040: 6c73 2e70 6c6f 7473 2e50 6c6f 7420 636f  ls.plots.Plot co
-00011050: 6e73 7472 7563 746f 720a 2020 2020 2222  nstructor.    ""
-00011060: 220a 2020 2020 636c 6561 725f 696e 7465  ".    clear_inte
-00011070: 7276 616c 203d 2070 6172 7365 5f74 696d  rval = parse_tim
-00011080: 6564 656c 7461 2863 6c65 6172 5f69 6e74  edelta(clear_int
-00011090: 6572 7661 6c2c 2064 6566 6175 6c74 3d22  erval, default="
-000110a0: 6d73 2229 0a0a 2020 2020 736f 7572 6365  ms")..    source
-000110b0: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
-000110c0: 7263 6528 0a20 2020 2020 2020 2064 6174  rce(.        dat
-000110d0: 613d 6469 6374 280a 2020 2020 2020 2020  a=dict(.        
-000110e0: 2020 2020 7374 6172 743d 5b74 696d 6528      start=[time(
-000110f0: 2920 2d20 636c 6561 725f 696e 7465 7276  ) - clear_interv
-00011100: 616c 5d2c 0a20 2020 2020 2020 2020 2020  al],.           
-00011110: 2064 7572 6174 696f 6e3d 5b30 2e31 5d2c   duration=[0.1],
-00011120: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
-00011130: 3d5b 2273 7461 7274 225d 2c0a 2020 2020  =["start"],.    
-00011140: 2020 2020 2020 2020 6e61 6d65 3d5b 2273          name=["s
-00011150: 7461 7274 225d 2c0a 2020 2020 2020 2020  tart"],.        
-00011160: 2020 2020 636f 6c6f 723d 5b22 7768 6974      color=["whit
-00011170: 6522 5d2c 0a20 2020 2020 2020 2020 2020  e"],.           
-00011180: 2064 7572 6174 696f 6e5f 7465 7874 3d5b   duration_text=[
-00011190: 2231 3030 206d 7322 5d2c 0a20 2020 2020  "100 ms"],.     
-000111a0: 2020 2020 2020 2077 6f72 6b65 723d 5b22         worker=["
-000111b0: 666f 6f22 5d2c 0a20 2020 2020 2020 2020  foo"],.         
-000111c0: 2020 2079 3d5b 305d 2c0a 2020 2020 2020     y=[0],.      
-000111d0: 2020 2020 2020 776f 726b 6572 5f74 6872        worker_thr
-000111e0: 6561 643d 5b31 5d2c 0a20 2020 2020 2020  ead=[1],.       
-000111f0: 2020 2020 2061 6c70 6861 3d5b 302e 305d       alpha=[0.0]
-00011200: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00011210: 290a 0a20 2020 2078 5f72 616e 6765 203d  )..    x_range =
-00011220: 2044 6174 6152 616e 6765 3164 2872 616e   DataRange1d(ran
-00011230: 6765 5f70 6164 6469 6e67 3d30 290a 2020  ge_padding=0).  
-00011240: 2020 795f 7261 6e67 6520 3d20 4461 7461    y_range = Data
-00011250: 5261 6e67 6531 6428 7261 6e67 655f 7061  Range1d(range_pa
-00011260: 6464 696e 673d 3029 0a0a 2020 2020 726f  dding=0)..    ro
-00011270: 6f74 203d 2066 6967 7572 6528 0a20 2020  ot = figure(.   
-00011280: 2020 2020 206e 616d 653d 2274 6173 6b5f       name="task_
-00011290: 7374 7265 616d 222c 0a20 2020 2020 2020  stream",.       
-000112a0: 2074 6974 6c65 3d22 5461 736b 2053 7472   title="Task Str
-000112b0: 6561 6d22 2c0a 2020 2020 2020 2020 785f  eam",.        x_
-000112c0: 7261 6e67 653d 785f 7261 6e67 652c 0a20  range=x_range,. 
-000112d0: 2020 2020 2020 2079 5f72 616e 6765 3d79         y_range=y
-000112e0: 5f72 616e 6765 2c0a 2020 2020 2020 2020  _range,.        
-000112f0: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
-00011300: 3d22 6162 6f76 6522 2c0a 2020 2020 2020  ="above",.      
-00011310: 2020 785f 6178 6973 5f74 7970 653d 2264    x_axis_type="d
-00011320: 6174 6574 696d 6522 2c0a 2020 2020 2020  atetime",.      
-00011330: 2020 795f 6178 6973 5f6c 6f63 6174 696f    y_axis_locatio
-00011340: 6e3d 4e6f 6e65 2c0a 2020 2020 2020 2020  n=None,.        
-00011350: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
-00011360: 2020 6d69 6e5f 626f 7264 6572 5f62 6f74    min_border_bot
-00011370: 746f 6d3d 3530 2c0a 2020 2020 2020 2020  tom=50,.        
-00011380: 2a2a 6b77 6172 6773 2c0a 2020 2020 290a  **kwargs,.    ).
-00011390: 0a20 2020 2072 6563 7420 3d20 726f 6f74  .    rect = root
-000113a0: 2e72 6563 7428 0a20 2020 2020 2020 2073  .rect(.        s
-000113b0: 6f75 7263 653d 736f 7572 6365 2c0a 2020  ource=source,.  
-000113c0: 2020 2020 2020 783d 2273 7461 7274 222c        x="start",
-000113d0: 0a20 2020 2020 2020 2079 3d22 7922 2c0a  .        y="y",.
-000113e0: 2020 2020 2020 2020 7769 6474 683d 2264          width="d
-000113f0: 7572 6174 696f 6e22 2c0a 2020 2020 2020  uration",.      
-00011400: 2020 6865 6967 6874 3d30 2e34 2c0a 2020    height=0.4,.  
-00011410: 2020 2020 2020 6669 6c6c 5f63 6f6c 6f72        fill_color
-00011420: 3d22 636f 6c6f 7222 2c0a 2020 2020 2020  ="color",.      
-00011430: 2020 6c69 6e65 5f63 6f6c 6f72 3d22 636f    line_color="co
-00011440: 6c6f 7222 2c0a 2020 2020 2020 2020 6c69  lor",.        li
-00011450: 6e65 5f61 6c70 6861 3d30 2e36 2c0a 2020  ne_alpha=0.6,.  
-00011460: 2020 2020 2020 6669 6c6c 5f61 6c70 6861        fill_alpha
-00011470: 3d22 616c 7068 6122 2c0a 2020 2020 2020  ="alpha",.      
-00011480: 2020 6c69 6e65 5f77 6964 7468 3d33 2c0a    line_width=3,.
-00011490: 2020 2020 290a 2020 2020 7265 6374 2e6e      ).    rect.n
-000114a0: 6f6e 7365 6c65 6374 696f 6e5f 676c 7970  onselection_glyp
-000114b0: 6820 3d20 4e6f 6e65 0a0a 2020 2020 726f  h = None..    ro
-000114c0: 6f74 2e79 6178 6973 2e6d 616a 6f72 5f6c  ot.yaxis.major_l
-000114d0: 6162 656c 5f74 6578 745f 616c 7068 6120  abel_text_alpha 
-000114e0: 3d20 300a 2020 2020 726f 6f74 2e79 6178  = 0.    root.yax
-000114f0: 6973 2e6d 696e 6f72 5f74 6963 6b5f 6c69  is.minor_tick_li
-00011500: 6e65 5f61 6c70 6861 203d 2030 0a20 2020  ne_alpha = 0.   
-00011510: 2072 6f6f 742e 7961 7869 732e 6d61 6a6f   root.yaxis.majo
-00011520: 725f 7469 636b 5f6c 696e 655f 616c 7068  r_tick_line_alph
-00011530: 6120 3d20 300a 2020 2020 726f 6f74 2e78  a = 0.    root.x
-00011540: 6772 6964 2e76 6973 6962 6c65 203d 2046  grid.visible = F
-00011550: 616c 7365 0a0a 2020 2020 686f 7665 7220  alse..    hover 
-00011560: 3d20 486f 7665 7254 6f6f 6c28 0a20 2020  = HoverTool(.   
-00011570: 2020 2020 2070 6f69 6e74 5f70 6f6c 6963       point_polic
-00011580: 793d 2266 6f6c 6c6f 775f 6d6f 7573 6522  y="follow_mouse"
-00011590: 2c0a 2020 2020 2020 2020 746f 6f6c 7469  ,.        toolti
-000115a0: 7073 3d22 2222 0a20 2020 2020 2020 2020  ps=""".         
-000115b0: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
-000115c0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-000115d0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-000115e0: 2031 3270 783b 2066 6f6e 742d 7765 6967   12px; font-weig
-000115f0: 6874 3a20 626f 6c64 3b22 3e40 6e61 6d65  ht: bold;">@name
-00011600: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
-00011610: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00011620: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-00011630: 2d73 697a 653a 2031 3070 783b 2066 6f6e  -size: 10px; fon
-00011640: 742d 6661 6d69 6c79 3a20 4d6f 6e61 636f  t-family: Monaco
-00011650: 2c20 6d6f 6e6f 7370 6163 653b 223e 4064  , monospace;">@d
-00011660: 7572 6174 696f 6e5f 7465 7874 3c2f 7370  uration_text</sp
-00011670: 616e 3e0a 2020 2020 2020 2020 2020 2020  an>.            
-00011680: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
-00011690: 2020 2022 2222 2c0a 2020 2020 290a 0a20     """,.    ).. 
-000116a0: 2020 2074 6170 203d 2054 6170 546f 6f6c     tap = TapTool
-000116b0: 2863 616c 6c62 6163 6b3d 4f70 656e 5552  (callback=OpenUR
-000116c0: 4c28 7572 6c3d 222e 2f70 726f 6669 6c65  L(url="./profile
-000116d0: 3f6b 6579 3d40 6e61 6d65 2229 290a 2020  ?key=@name")).  
-000116e0: 2020 6865 6c70 5f20 3d20 4865 6c70 546f    help_ = HelpTo
-000116f0: 6f6c 280a 2020 2020 2020 2020 7265 6469  ol(.        redi
-00011700: 7265 6374 3d22 6874 7470 733a 2f2f 646f  rect="https://do
-00011710: 6373 2e64 6173 6b2e 6f72 672f 656e 2f73  cs.dask.org/en/s
-00011720: 7461 626c 652f 6461 7368 626f 6172 642e  table/dashboard.
-00011730: 6874 6d6c 2374 6173 6b2d 7374 7265 616d  html#task-stream
-00011740: 222c 0a20 2020 2020 2020 2064 6573 6372  ",.        descr
-00011750: 6970 7469 6f6e 3d22 4120 6465 7363 7269  iption="A descri
-00011760: 7074 696f 6e20 6f66 2074 6865 2054 6173  ption of the Tas
-00011770: 6b53 7472 6561 6d20 616e 6420 6974 7320  kStream and its 
-00011780: 636f 6c6f 7220 7061 6c65 7474 652e 222c  color palette.",
-00011790: 0a20 2020 2029 0a20 2020 2072 6f6f 742e  .    ).    root.
-000117a0: 6164 645f 746f 6f6c 7328 0a20 2020 2020  add_tools(.     
-000117b0: 2020 2068 6f76 6572 2c0a 2020 2020 2020     hover,.      
-000117c0: 2020 7461 702c 0a20 2020 2020 2020 2042    tap,.        B
-000117d0: 6f78 5a6f 6f6d 546f 6f6c 2829 2c0a 2020  oxZoomTool(),.  
-000117e0: 2020 2020 2020 5265 7365 7454 6f6f 6c28        ResetTool(
-000117f0: 292c 0a20 2020 2020 2020 2050 616e 546f  ),.        PanTo
-00011800: 6f6c 2864 696d 656e 7369 6f6e 733d 2277  ol(dimensions="w
-00011810: 6964 7468 2229 2c0a 2020 2020 2020 2020  idth"),.        
-00011820: 5768 6565 6c5a 6f6f 6d54 6f6f 6c28 6469  WheelZoomTool(di
-00011830: 6d65 6e73 696f 6e73 3d22 7769 6474 6822  mensions="width"
-00011840: 292c 0a20 2020 2020 2020 2068 656c 705f  ),.        help_
-00011850: 2c0a 2020 2020 290a 2020 2020 6966 2045  ,.    ).    if E
-00011860: 7870 6f72 7454 6f6f 6c3a 2020 2320 7479  xportTool:  # ty
-00011870: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-00011880: 2020 2065 7870 6f72 7420 3d20 4578 706f     export = Expo
-00011890: 7274 546f 6f6c 2829 0a20 2020 2020 2020  rtTool().       
-000118a0: 2065 7870 6f72 742e 7265 6769 7374 6572   export.register
-000118b0: 5f70 6c6f 7428 726f 6f74 290a 2020 2020  _plot(root).    
-000118c0: 2020 2020 726f 6f74 2e61 6464 5f74 6f6f      root.add_too
-000118d0: 6c73 2865 7870 6f72 7429 0a0a 2020 2020  ls(export)..    
-000118e0: 7265 7475 726e 2073 6f75 7263 652c 2072  return source, r
-000118f0: 6f6f 740a 0a0a 636c 6173 7320 5461 736b  oot...class Task
-00011900: 4772 6170 6828 4461 7368 626f 6172 6443  Graph(DashboardC
-00011910: 6f6d 706f 6e65 6e74 293a 0a20 2020 2022  omponent):.    "
-00011920: 2222 0a20 2020 2041 2064 796e 616d 6963  "".    A dynamic
-00011930: 206e 6f64 652d 6c69 6e6b 2064 6961 6772   node-link diagr
-00011940: 616d 2066 6f72 2074 6865 2074 6173 6b20  am for the task 
-00011950: 6772 6170 6820 6f6e 2074 6865 2073 6368  graph on the sch
-00011960: 6564 756c 6572 0a0a 2020 2020 5365 6520  eduler..    See 
-00011970: 616c 736f 2074 6865 2047 7261 7068 4c61  also the GraphLa
-00011980: 796f 7574 2064 6961 676e 6f73 7469 6320  yout diagnostic 
-00011990: 6174 0a20 2020 2064 6973 7472 6962 7574  at.    distribut
-000119a0: 6564 2f64 6961 676e 6f73 7469 6373 2f67  ed/diagnostics/g
-000119b0: 7261 7068 5f6c 6179 6f75 742e 7079 0a20  raph_layout.py. 
-000119c0: 2020 2022 2222 0a0a 2020 2020 6465 6620     """..    def 
-000119d0: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
-000119e0: 6368 6564 756c 6572 2c20 2a2a 6b77 6172  cheduler, **kwar
-000119f0: 6773 293a 0a20 2020 2020 2020 2073 656c  gs):.        sel
-00011a00: 662e 7363 6865 6475 6c65 7220 3d20 7363  f.scheduler = sc
-00011a10: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
-00011a20: 7365 6c66 2e6c 6179 6f75 7420 3d20 4772  self.layout = Gr
-00011a30: 6170 684c 6179 6f75 7428 7363 6865 6475  aphLayout(schedu
-00011a40: 6c65 7229 0a20 2020 2020 2020 2073 6368  ler).        sch
-00011a50: 6564 756c 6572 2e61 6464 5f70 6c75 6769  eduler.add_plugi
-00011a60: 6e28 7365 6c66 2e6c 6179 6f75 7429 0a20  n(self.layout). 
-00011a70: 2020 2020 2020 2073 656c 662e 696e 7669         self.invi
-00011a80: 7369 626c 655f 636f 756e 7420 3d20 3020  sible_count = 0 
-00011a90: 2023 206e 756d 6265 7220 6f66 2069 6e76   # number of inv
-00011aa0: 6973 6962 6c65 206e 6f64 6573 0a0a 2020  isible nodes..  
-00011ab0: 2020 2020 2020 7365 6c66 2e6e 6f64 655f        self.node_
-00011ac0: 736f 7572 6365 203d 2043 6f6c 756d 6e44  source = ColumnD
-00011ad0: 6174 6153 6f75 7263 6528 0a20 2020 2020  ataSource(.     
-00011ae0: 2020 2020 2020 207b 2278 223a 205b 5d2c         {"x": [],
-00011af0: 2022 7922 3a20 5b5d 2c20 226e 616d 6522   "y": [], "name"
-00011b00: 3a20 5b5d 2c20 2273 7461 7465 223a 205b  : [], "state": [
-00011b10: 5d2c 2022 7669 7369 626c 6522 3a20 5b5d  ], "visible": []
-00011b20: 2c20 226b 6579 223a 205b 5d7d 0a20 2020  , "key": []}.   
-00011b30: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-00011b40: 656c 662e 6564 6765 5f73 6f75 7263 6520  elf.edge_source 
-00011b50: 3d20 436f 6c75 6d6e 4461 7461 536f 7572  = ColumnDataSour
-00011b60: 6365 287b 2278 223a 205b 5d2c 2022 7922  ce({"x": [], "y"
-00011b70: 3a20 5b5d 2c20 2276 6973 6962 6c65 223a  : [], "visible":
-00011b80: 205b 5d7d 290a 0a20 2020 2020 2020 2066   []})..        f
-00011b90: 696c 7465 7220 3d20 4772 6f75 7046 696c  ilter = GroupFil
-00011ba0: 7465 7228 636f 6c75 6d6e 5f6e 616d 653d  ter(column_name=
-00011bb0: 2276 6973 6962 6c65 222c 2067 726f 7570  "visible", group
-00011bc0: 3d22 5472 7565 2229 0a20 2020 2020 2020  ="True").       
-00011bd0: 2069 6620 424f 4b45 485f 5645 5253 494f   if BOKEH_VERSIO
-00011be0: 4e2e 6d61 6a6f 7220 3c20 333a 0a20 2020  N.major < 3:.   
-00011bf0: 2020 2020 2020 2020 2066 696c 7465 725f           filter_
-00011c00: 6b77 6172 6773 203d 207b 2266 696c 7465  kwargs = {"filte
-00011c10: 7273 223a 205b 6669 6c74 6572 5d7d 0a20  rs": [filter]}. 
-00011c20: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00011c30: 2020 2020 2020 2020 2066 696c 7465 725f           filter_
-00011c40: 6b77 6172 6773 203d 207b 2266 696c 7465  kwargs = {"filte
-00011c50: 7222 3a20 6669 6c74 6572 7d0a 2020 2020  r": filter}.    
-00011c60: 2020 2020 6e6f 6465 5f76 6965 7720 3d20      node_view = 
-00011c70: 4344 5356 6965 7728 2a2a 6669 6c74 6572  CDSView(**filter
-00011c80: 5f6b 7761 7267 7329 0a20 2020 2020 2020  _kwargs).       
-00011c90: 2065 6467 655f 7669 6577 203d 2043 4453   edge_view = CDS
-00011ca0: 5669 6577 282a 2a66 696c 7465 725f 6b77  View(**filter_kw
-00011cb0: 6172 6773 290a 0a20 2020 2020 2020 2023  args)..        #
-00011cc0: 2042 6f6b 6568 203e 3d20 332e 3020 6175   Bokeh >= 3.0 au
-00011cd0: 746f 6d61 7469 6361 6c6c 7920 696e 6665  tomatically infe
-00011ce0: 7273 2074 6865 2073 6f75 7263 6520 746f  rs the source to
-00011cf0: 2075 7365 0a20 2020 2020 2020 2069 6620   use.        if 
-00011d00: 424f 4b45 485f 5645 5253 494f 4e2e 6d61  BOKEH_VERSION.ma
-00011d10: 6a6f 7220 3c20 333a 0a20 2020 2020 2020  jor < 3:.       
-00011d20: 2020 2020 206e 6f64 655f 7669 6577 2e73       node_view.s
-00011d30: 6f75 7263 6520 3d20 7365 6c66 2e6e 6f64  ource = self.nod
-00011d40: 655f 736f 7572 6365 0a20 2020 2020 2020  e_source.       
-00011d50: 2020 2020 2065 6467 655f 7669 6577 2e73       edge_view.s
-00011d60: 6f75 7263 6520 3d20 7365 6c66 2e65 6467  ource = self.edg
-00011d70: 655f 736f 7572 6365 0a0a 2020 2020 2020  e_source..      
-00011d80: 2020 6e6f 6465 5f63 6f6c 6f72 7320 3d20    node_colors = 
-00011d90: 6661 6374 6f72 5f63 6d61 7028 0a20 2020  factor_cmap(.   
-00011da0: 2020 2020 2020 2020 2022 7374 6174 6522           "state"
-00011db0: 2c0a 2020 2020 2020 2020 2020 2020 6661  ,.            fa
-00011dc0: 6374 6f72 733d 5b22 7761 6974 696e 6722  ctors=["waiting"
-00011dd0: 2c20 2271 7565 7565 6422 2c20 2270 726f  , "queued", "pro
-00011de0: 6365 7373 696e 6722 2c20 226d 656d 6f72  cessing", "memor
-00011df0: 7922 2c20 2272 656c 6561 7365 6422 2c20  y", "released", 
-00011e00: 2265 7272 6564 225d 2c0a 2020 2020 2020  "erred"],.      
-00011e10: 2020 2020 2020 7061 6c65 7474 653d 5b22        palette=["
-00011e20: 6772 6179 222c 2022 7965 6c6c 6f77 222c  gray", "yellow",
-00011e30: 2022 6772 6565 6e22 2c20 2272 6564 222c   "green", "red",
-00011e40: 2022 626c 7565 222c 2022 626c 6163 6b22   "blue", "black"
-00011e50: 5d2c 0a20 2020 2020 2020 2029 0a0a 2020  ],.        )..  
-00011e60: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
-00011e70: 3d20 6669 6775 7265 2874 6974 6c65 3d22  = figure(title="
-00011e80: 5461 736b 2047 7261 7068 222c 202a 2a6b  Task Graph", **k
-00011e90: 7761 7267 7329 0a20 2020 2020 2020 2073  wargs).        s
-00011ea0: 656c 662e 7375 6274 6974 6c65 203d 2054  elf.subtitle = T
-00011eb0: 6974 6c65 2874 6578 743d 2220 222c 2074  itle(text=" ", t
-00011ec0: 6578 745f 666f 6e74 5f73 7479 6c65 3d22  ext_font_style="
-00011ed0: 6974 616c 6963 2229 0a20 2020 2020 2020  italic").       
-00011ee0: 2073 656c 662e 726f 6f74 2e61 6464 5f6c   self.root.add_l
-00011ef0: 6179 6f75 7428 7365 6c66 2e73 7562 7469  ayout(self.subti
-00011f00: 746c 652c 2022 6162 6f76 6522 290a 0a20  tle, "above").. 
-00011f10: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-00011f20: 2e6d 756c 7469 5f6c 696e 6528 0a20 2020  .multi_line(.   
-00011f30: 2020 2020 2020 2020 2078 733d 2278 222c           xs="x",
-00011f40: 0a20 2020 2020 2020 2020 2020 2079 733d  .            ys=
-00011f50: 2279 222c 0a20 2020 2020 2020 2020 2020  "y",.           
-00011f60: 2073 6f75 7263 653d 7365 6c66 2e65 6467   source=self.edg
-00011f70: 655f 736f 7572 6365 2c0a 2020 2020 2020  e_source,.      
-00011f80: 2020 2020 2020 6c69 6e65 5f77 6964 7468        line_width
-00011f90: 3d31 2c0a 2020 2020 2020 2020 2020 2020  =1,.            
-00011fa0: 7669 6577 3d65 6467 655f 7669 6577 2c0a  view=edge_view,.
-00011fb0: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-00011fc0: 723d 2262 6c61 636b 222c 0a20 2020 2020  r="black",.     
-00011fd0: 2020 2020 2020 2061 6c70 6861 3d30 2e33         alpha=0.3
-00011fe0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00011ff0: 2020 2020 7265 6374 203d 2073 656c 662e      rect = self.
-00012000: 726f 6f74 2e73 7175 6172 6528 0a20 2020  root.square(.   
-00012010: 2020 2020 2020 2020 2078 3d22 7822 2c0a           x="x",.
-00012020: 2020 2020 2020 2020 2020 2020 793d 2279              y="y
-00012030: 222c 0a20 2020 2020 2020 2020 2020 2073  ",.            s
-00012040: 697a 653d 3130 2c0a 2020 2020 2020 2020  ize=10,.        
-00012050: 2020 2020 636f 6c6f 723d 6e6f 6465 5f63      color=node_c
-00012060: 6f6c 6f72 732c 0a20 2020 2020 2020 2020  olors,.         
-00012070: 2020 2073 6f75 7263 653d 7365 6c66 2e6e     source=self.n
-00012080: 6f64 655f 736f 7572 6365 2c0a 2020 2020  ode_source,.    
-00012090: 2020 2020 2020 2020 7669 6577 3d6e 6f64          view=nod
-000120a0: 655f 7669 6577 2c0a 2020 2020 2020 2020  e_view,.        
-000120b0: 2020 2020 6c65 6765 6e64 5f66 6965 6c64      legend_field
-000120c0: 3d22 7374 6174 6522 2c0a 2020 2020 2020  ="state",.      
-000120d0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-000120e0: 2e72 6f6f 742e 7867 7269 642e 6772 6964  .root.xgrid.grid
-000120f0: 5f6c 696e 655f 636f 6c6f 7220 3d20 4e6f  _line_color = No
-00012100: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-00012110: 726f 6f74 2e79 6772 6964 2e67 7269 645f  root.ygrid.grid_
-00012120: 6c69 6e65 5f63 6f6c 6f72 203d 204e 6f6e  line_color = Non
-00012130: 650a 2020 2020 2020 2020 7365 6c66 2e72  e.        self.r
-00012140: 6f6f 742e 7861 7869 732e 7669 7369 626c  oot.xaxis.visibl
-00012150: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
-00012160: 2020 7365 6c66 2e72 6f6f 742e 7961 7869    self.root.yaxi
-00012170: 732e 7669 7369 626c 6520 3d20 4661 6c73  s.visible = Fals
-00012180: 650a 0a20 2020 2020 2020 2068 6f76 6572  e..        hover
-00012190: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
-000121a0: 2020 2020 2020 2020 2020 706f 696e 745f            point_
-000121b0: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
-000121c0: 6f75 7365 222c 0a20 2020 2020 2020 2020  ouse",.         
-000121d0: 2020 2074 6f6f 6c74 6970 733d 223c 623e     tooltips="<b>
-000121e0: 406e 616d 653c 2f62 3e3a 2040 7374 6174  @name</b>: @stat
-000121f0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
-00012200: 7265 6e64 6572 6572 733d 5b72 6563 745d  renderers=[rect]
-00012210: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-00012220: 2020 2020 7461 7020 3d20 5461 7054 6f6f      tap = TapToo
-00012230: 6c28 6361 6c6c 6261 636b 3d4f 7065 6e55  l(callback=OpenU
-00012240: 524c 2875 726c 3d22 696e 666f 2f74 6173  RL(url="info/tas
-00012250: 6b2f 406b 6579 2e68 746d 6c22 292c 2072  k/@key.html"), r
-00012260: 656e 6465 7265 7273 3d5b 7265 6374 5d29  enderers=[rect])
-00012270: 0a20 2020 2020 2020 2072 6563 742e 6e6f  .        rect.no
-00012280: 6e73 656c 6563 7469 6f6e 5f67 6c79 7068  nselection_glyph
-00012290: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-000122a0: 7365 6c66 2e72 6f6f 742e 6164 645f 746f  self.root.add_to
-000122b0: 6f6c 7328 686f 7665 722c 2074 6170 290a  ols(hover, tap).
-000122c0: 2020 2020 2020 2020 7365 6c66 2e6d 6178          self.max
-000122d0: 5f69 7465 6d73 203d 2063 6f6e 6669 672e  _items = config.
-000122e0: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-000122f0: 2e64 6173 6862 6f61 7264 2e67 7261 7068  .dashboard.graph
-00012300: 2d6d 6178 2d69 7465 6d73 222c 2035 3030  -max-items", 500
-00012310: 3029 0a0a 2020 2020 4077 6974 686f 7574  0)..    @without
-00012320: 5f70 726f 7065 7274 795f 7661 6c69 6461  _property_valida
-00012330: 7469 6f6e 0a20 2020 2040 6c6f 675f 6572  tion.    @log_er
-00012340: 726f 7273 0a20 2020 2064 6566 2075 7064  rors.    def upd
-00012350: 6174 6528 7365 6c66 293a 0a20 2020 2020  ate(self):.     
-00012360: 2020 2023 2049 6620 7468 6572 6520 6172     # If there ar
-00012370: 6520 746f 6f20 6d61 6e79 2074 6173 6b73  e too many tasks
-00012380: 2069 6e20 7468 6520 7363 6865 6475 6c65   in the schedule
-00012390: 7220 7765 276c 6c20 6469 7361 626c 6520  r we'll disable 
-000123a0: 7468 6973 0a20 2020 2020 2020 2023 2063  this.        # c
-000123b0: 6f6d 706f 6f6e 656e 7473 2074 6f20 6e6f  ompoonents to no
-000123c0: 7420 6f76 6572 6c6f 6164 2073 6368 6564  t overload sched
-000123d0: 756c 6572 206f 7220 636c 6965 6e74 2e20  uler or client. 
-000123e0: 4f6e 6365 2077 6520 6472 6f70 0a20 2020  Once we drop.   
-000123f0: 2020 2020 2023 2062 656c 6f77 2074 6865       # below the
-00012400: 2074 6872 6573 686f 6c64 2c20 7468 6520   threshold, the 
-00012410: 6461 7461 2069 7320 6669 6c6c 6564 2075  data is filled u
-00012420: 7020 6167 6169 6e20 6173 2075 7375 616c  p again as usual
-00012430: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-00012440: 7365 6c66 2e73 6368 6564 756c 6572 2e74  self.scheduler.t
-00012450: 6173 6b73 2920 3e20 7365 6c66 2e6d 6178  asks) > self.max
-00012460: 5f69 7465 6d73 3a0a 2020 2020 2020 2020  _items:.        
-00012470: 2020 2020 7365 6c66 2e73 7562 7469 746c      self.subtitl
-00012480: 652e 7465 7874 203d 2022 5363 6865 6475  e.text = "Schedu
-00012490: 6c65 7220 6861 7320 746f 6f20 6d61 6e79  ler has too many
-000124a0: 2074 6173 6b73 2074 6f20 6469 7370 6c61   tasks to displa
-000124b0: 792e 220a 2020 2020 2020 2020 2020 2020  y.".            
-000124c0: 666f 7220 636f 6e74 6169 6e65 7220 696e  for container in
-000124d0: 205b 7365 6c66 2e6e 6f64 655f 736f 7572   [self.node_sour
-000124e0: 6365 2c20 7365 6c66 2e65 6467 655f 736f  ce, self.edge_so
-000124f0: 7572 6365 5d3a 0a20 2020 2020 2020 2020  urce]:.         
-00012500: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
-00012510: 2e64 6174 6120 3d20 7b63 6f6c 3a20 5b5d  .data = {col: []
-00012520: 2066 6f72 2063 6f6c 2069 6e20 636f 6e74   for col in cont
-00012530: 6169 6e65 722e 636f 6c75 6d6e 5f6e 616d  ainer.column_nam
-00012540: 6573 7d0a 2020 2020 2020 2020 656c 7365  es}.        else
-00012550: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00012560: 6f63 6361 7369 6f6e 616c 6c79 2072 6573  occasionally res
-00012570: 6574 2074 6865 2063 6f6c 756d 6e20 6461  et the column da
-00012580: 7461 2073 6f75 7263 6520 746f 2072 656d  ta source to rem
-00012590: 6f76 6520 6f6c 6420 6e6f 6465 730a 2020  ove old nodes.  
-000125a0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-000125b0: 662e 696e 7669 7369 626c 655f 636f 756e  f.invisible_coun
-000125c0: 7420 3e20 6c65 6e28 7365 6c66 2e6e 6f64  t > len(self.nod
-000125d0: 655f 736f 7572 6365 2e64 6174 615b 2278  e_source.data["x
-000125e0: 225d 2920 2f20 323a 0a20 2020 2020 2020  "]) / 2:.       
-000125f0: 2020 2020 2020 2020 2073 656c 662e 6c61           self.la
-00012600: 796f 7574 2e72 6573 6574 5f69 6e64 6578  yout.reset_index
-00012610: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
-00012620: 2020 2073 656c 662e 696e 7669 7369 626c     self.invisibl
-00012630: 655f 636f 756e 7420 3d20 300a 2020 2020  e_count = 0.    
-00012640: 2020 2020 2020 2020 2020 2020 7570 6461              upda
-00012650: 7465 203d 2054 7275 650a 2020 2020 2020  te = True.      
-00012660: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00012670: 2020 2020 2020 2020 2020 2020 7570 6461              upda
-00012680: 7465 203d 2046 616c 7365 0a0a 2020 2020  te = False..    
-00012690: 2020 2020 2020 2020 6e65 772c 2073 656c          new, sel
-000126a0: 662e 6c61 796f 7574 2e6e 6577 203d 2073  f.layout.new = s
-000126b0: 656c 662e 6c61 796f 7574 2e6e 6577 2c20  elf.layout.new, 
-000126c0: 5b5d 0a20 2020 2020 2020 2020 2020 206e  [].            n
-000126d0: 6577 5f65 6467 6573 203d 2073 656c 662e  ew_edges = self.
-000126e0: 6c61 796f 7574 2e6e 6577 5f65 6467 6573  layout.new_edges
-000126f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00012700: 662e 6c61 796f 7574 2e6e 6577 5f65 6467  f.layout.new_edg
-00012710: 6573 203d 205b 5d0a 0a20 2020 2020 2020  es = []..       
-00012720: 2020 2020 2073 656c 662e 6164 645f 6e65       self.add_ne
-00012730: 775f 6e6f 6465 735f 6564 6765 7328 6e65  w_nodes_edges(ne
-00012740: 772c 206e 6577 5f65 6467 6573 2c20 7570  w, new_edges, up
-00012750: 6461 7465 3d75 7064 6174 6529 0a0a 2020  date=update)..  
-00012760: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-00012770: 6174 6368 5f75 7064 6174 6573 2829 0a0a  atch_updates()..
-00012780: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-00012790: 656e 2873 656c 662e 7363 6865 6475 6c65  en(self.schedule
-000127a0: 722e 7461 736b 7329 203d 3d20 303a 0a20  r.tasks) == 0:. 
-000127b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000127c0: 656c 662e 7375 6274 6974 6c65 2e74 6578  elf.subtitle.tex
-000127d0: 7420 3d20 2253 6368 6564 756c 6572 2069  t = "Scheduler i
-000127e0: 7320 656d 7074 792e 220a 2020 2020 2020  s empty.".      
-000127f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00012800: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012810: 2e73 7562 7469 746c 652e 7465 7874 203d  .subtitle.text =
-00012820: 2022 2022 0a0a 2020 2020 4077 6974 686f   " "..    @witho
-00012830: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
-00012840: 6461 7469 6f6e 0a20 2020 2064 6566 2061  dation.    def a
-00012850: 6464 5f6e 6577 5f6e 6f64 6573 5f65 6467  dd_new_nodes_edg
-00012860: 6573 2873 656c 662c 206e 6577 2c20 6e65  es(self, new, ne
-00012870: 775f 6564 6765 732c 2075 7064 6174 653d  w_edges, update=
-00012880: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
-00012890: 6966 206e 6577 206f 7220 7570 6461 7465  if new or update
-000128a0: 3a0a 2020 2020 2020 2020 2020 2020 6e6f  :.            no
-000128b0: 6465 5f6b 6579 203d 205b 5d0a 2020 2020  de_key = [].    
-000128c0: 2020 2020 2020 2020 6e6f 6465 5f78 203d          node_x =
-000128d0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-000128e0: 6e6f 6465 5f79 203d 205b 5d0a 2020 2020  node_y = [].    
-000128f0: 2020 2020 2020 2020 6e6f 6465 5f73 7461          node_sta
-00012900: 7465 203d 205b 5d0a 2020 2020 2020 2020  te = [].        
-00012910: 2020 2020 6e6f 6465 5f6e 616d 6520 3d20      node_name = 
-00012920: 5b5d 0a20 2020 2020 2020 2020 2020 2065  [].            e
-00012930: 6467 655f 7820 3d20 5b5d 0a20 2020 2020  dge_x = [].     
-00012940: 2020 2020 2020 2065 6467 655f 7920 3d20         edge_y = 
-00012950: 5b5d 0a0a 2020 2020 2020 2020 2020 2020  []..            
-00012960: 7820 3d20 7365 6c66 2e6c 6179 6f75 742e  x = self.layout.
-00012970: 780a 2020 2020 2020 2020 2020 2020 7920  x.            y 
-00012980: 3d20 7365 6c66 2e6c 6179 6f75 742e 790a  = self.layout.y.
-00012990: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
-000129a0: 6b73 203d 2073 656c 662e 7363 6865 6475  ks = self.schedu
-000129b0: 6c65 722e 7461 736b 730a 2020 2020 2020  ler.tasks.      
-000129c0: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-000129d0: 206e 6577 3a0a 2020 2020 2020 2020 2020   new:.          
-000129e0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000129f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00012a00: 6173 6b20 3d20 7461 736b 735b 6b65 795d  ask = tasks[key]
-00012a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012a20: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
-00012a30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012a40: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
-00012a50: 2020 2020 2020 2020 2020 2020 2020 2078                 x
-00012a60: 7820 3d20 785b 6b65 795d 0a20 2020 2020  x = x[key].     
-00012a70: 2020 2020 2020 2020 2020 2079 7920 3d20             yy = 
-00012a80: 795b 6b65 795d 0a20 2020 2020 2020 2020  y[key].         
-00012a90: 2020 2020 2020 206e 6f64 655f 6b65 792e         node_key.
-00012aa0: 6170 7065 6e64 2865 7363 6170 652e 7572  append(escape.ur
-00012ab0: 6c5f 6573 6361 7065 2873 7472 286b 6579  l_escape(str(key
-00012ac0: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
-00012ad0: 2020 2020 6e6f 6465 5f78 2e61 7070 656e      node_x.appen
-00012ae0: 6428 7878 290a 2020 2020 2020 2020 2020  d(xx).          
-00012af0: 2020 2020 2020 6e6f 6465 5f79 2e61 7070        node_y.app
-00012b00: 656e 6428 7979 290a 2020 2020 2020 2020  end(yy).        
-00012b10: 2020 2020 2020 2020 6e6f 6465 5f73 7461          node_sta
-00012b20: 7465 2e61 7070 656e 6428 7461 736b 2e73  te.append(task.s
-00012b30: 7461 7465 290a 2020 2020 2020 2020 2020  tate).          
-00012b40: 2020 2020 2020 6e6f 6465 5f6e 616d 652e        node_name.
-00012b50: 6170 7065 6e64 2874 6173 6b2e 7072 6566  append(task.pref
-00012b60: 6978 2e6e 616d 6529 0a0a 2020 2020 2020  ix.name)..      
-00012b70: 2020 2020 2020 666f 7220 612c 2062 2069        for a, b i
-00012b80: 6e20 6e65 775f 6564 6765 733a 0a20 2020  n new_edges:.   
-00012b90: 2020 2020 2020 2020 2020 2020 2074 7279               try
-00012ba0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012bb0: 2020 2020 2020 6564 6765 5f78 2e61 7070        edge_x.app
-00012bc0: 656e 6428 5b78 5b61 5d2c 2078 5b62 5d5d  end([x[a], x[b]]
-00012bd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012be0: 2020 2020 2020 6564 6765 5f79 2e61 7070        edge_y.app
-00012bf0: 656e 6428 5b79 5b61 5d2c 2079 5b62 5d5d  end([y[a], y[b]]
-00012c00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012c10: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
-00012c20: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-00012c30: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
-00012c40: 2020 2020 2020 2020 206e 6f64 6520 3d20           node = 
-00012c50: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-00012c60: 2020 2278 223a 206e 6f64 655f 782c 0a20    "x": node_x,. 
-00012c70: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00012c80: 7922 3a20 6e6f 6465 5f79 2c0a 2020 2020  y": node_y,.    
-00012c90: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-00012ca0: 7465 223a 206e 6f64 655f 7374 6174 652c  te": node_state,
-00012cb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012cc0: 2022 6e61 6d65 223a 206e 6f64 655f 6e61   "name": node_na
-00012cd0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-00012ce0: 2020 2020 226b 6579 223a 206e 6f64 655f      "key": node_
-00012cf0: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
-00012d00: 2020 2020 2022 7669 7369 626c 6522 3a20       "visible": 
-00012d10: 5b22 5472 7565 225d 202a 206c 656e 286e  ["True"] * len(n
-00012d20: 6f64 655f 7829 2c0a 2020 2020 2020 2020  ode_x),.        
-00012d30: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00012d40: 2020 6564 6765 203d 207b 2278 223a 2065    edge = {"x": e
-00012d50: 6467 655f 782c 2022 7922 3a20 6564 6765  dge_x, "y": edge
-00012d60: 5f79 2c20 2276 6973 6962 6c65 223a 205b  _y, "visible": [
-00012d70: 2254 7275 6522 5d20 2a20 6c65 6e28 6564  "True"] * len(ed
-00012d80: 6765 5f78 297d 0a0a 2020 2020 2020 2020  ge_x)}..        
-00012d90: 2020 2020 6966 2075 7064 6174 6520 6f72      if update or
-00012da0: 206e 6f74 206c 656e 2873 656c 662e 6e6f   not len(self.no
-00012db0: 6465 5f73 6f75 7263 652e 6461 7461 5b22  de_source.data["
-00012dc0: 7822 5d29 3a0a 2020 2020 2020 2020 2020  x"]):.          
-00012dd0: 2020 2020 2020 2320 7365 6520 6874 7470        # see http
-00012de0: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f62  s://github.com/b
-00012df0: 6f6b 6568 2f62 6f6b 6568 2f69 7373 7565  okeh/bokeh/issue
-00012e00: 732f 3735 3233 0a20 2020 2020 2020 2020  s/7523.         
-00012e10: 2020 2020 2020 2073 656c 662e 6e6f 6465         self.node
-00012e20: 5f73 6f75 7263 652e 6461 7461 2e75 7064  _source.data.upd
-00012e30: 6174 6528 6e6f 6465 290a 2020 2020 2020  ate(node).      
-00012e40: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
-00012e50: 6467 655f 736f 7572 6365 2e64 6174 612e  dge_source.data.
-00012e60: 7570 6461 7465 2865 6467 6529 0a20 2020  update(edge).   
-00012e70: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00012e80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00012e90: 656c 662e 6e6f 6465 5f73 6f75 7263 652e  elf.node_source.
-00012ea0: 7374 7265 616d 286e 6f64 6529 0a20 2020  stream(node).   
-00012eb0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00012ec0: 662e 6564 6765 5f73 6f75 7263 652e 7374  f.edge_source.st
-00012ed0: 7265 616d 2865 6467 6529 0a0a 2020 2020  ream(edge)..    
-00012ee0: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
-00012ef0: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
-00012f00: 2064 6566 2070 6174 6368 5f75 7064 6174   def patch_updat
-00012f10: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
-00012f20: 2020 2222 220a 2020 2020 2020 2020 536d    """.        Sm
-00012f30: 616c 6c20 7570 6461 7465 7320 6c69 6b65  all updates like
-00012f40: 2063 6f6c 6f72 2063 6861 6e67 6573 206f   color changes o
-00012f50: 7220 6c6f 7374 206e 6f64 6573 2066 726f  r lost nodes fro
-00012f60: 6d20 7461 736b 2074 7261 6e73 6974 696f  m task transitio
-00012f70: 6e73 0a20 2020 2020 2020 2022 2222 0a20  ns.        """. 
-00012f80: 2020 2020 2020 206e 203d 206c 656e 2873         n = len(s
-00012f90: 656c 662e 6e6f 6465 5f73 6f75 7263 652e  elf.node_source.
-00012fa0: 6461 7461 5b22 7822 5d29 0a20 2020 2020  data["x"]).     
-00012fb0: 2020 206d 203d 206c 656e 2873 656c 662e     m = len(self.
-00012fc0: 6564 6765 5f73 6f75 7263 652e 6461 7461  edge_source.data
-00012fd0: 5b22 7822 5d29 0a0a 2020 2020 2020 2020  ["x"])..        
-00012fe0: 6966 2073 656c 662e 6c61 796f 7574 2e73  if self.layout.s
-00012ff0: 7461 7465 5f75 7064 6174 6573 3a0a 2020  tate_updates:.  
-00013000: 2020 2020 2020 2020 2020 7374 6174 655f            state_
-00013010: 7570 6461 7465 7320 3d20 7365 6c66 2e6c  updates = self.l
-00013020: 6179 6f75 742e 7374 6174 655f 7570 6461  ayout.state_upda
-00013030: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
-00013040: 7365 6c66 2e6c 6179 6f75 742e 7374 6174  self.layout.stat
-00013050: 655f 7570 6461 7465 7320 3d20 5b5d 0a20  e_updates = []. 
-00013060: 2020 2020 2020 2020 2020 2075 7064 6174             updat
-00013070: 6573 203d 205b 2869 2c20 6329 2066 6f72  es = [(i, c) for
-00013080: 2069 2c20 6320 696e 2073 7461 7465 5f75   i, c in state_u
-00013090: 7064 6174 6573 2069 6620 6920 3c20 6e5d  pdates if i < n]
-000130a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000130b0: 662e 6e6f 6465 5f73 6f75 7263 652e 7061  f.node_source.pa
-000130c0: 7463 6828 7b22 7374 6174 6522 3a20 7570  tch({"state": up
-000130d0: 6461 7465 737d 290a 0a20 2020 2020 2020  dates})..       
-000130e0: 2069 6620 7365 6c66 2e6c 6179 6f75 742e   if self.layout.
-000130f0: 7669 7369 626c 655f 7570 6461 7465 733a  visible_updates:
-00013100: 0a20 2020 2020 2020 2020 2020 2075 7064  .            upd
-00013110: 6174 6573 203d 2073 656c 662e 6c61 796f  ates = self.layo
-00013120: 7574 2e76 6973 6962 6c65 5f75 7064 6174  ut.visible_updat
-00013130: 6573 0a20 2020 2020 2020 2020 2020 2075  es.            u
-00013140: 7064 6174 6573 203d 205b 2869 2c20 6329  pdates = [(i, c)
-00013150: 2066 6f72 2069 2c20 6320 696e 2075 7064   for i, c in upd
-00013160: 6174 6573 2069 6620 6920 3c20 6e5d 0a20  ates if i < n]. 
-00013170: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00013180: 6c61 796f 7574 2e76 6973 6962 6c65 5f75  layout.visible_u
-00013190: 7064 6174 6573 203d 205b 5d0a 2020 2020  pdates = [].    
-000131a0: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
-000131b0: 655f 736f 7572 6365 2e70 6174 6368 287b  e_source.patch({
-000131c0: 2276 6973 6962 6c65 223a 2075 7064 6174  "visible": updat
-000131d0: 6573 7d29 0a20 2020 2020 2020 2020 2020  es}).           
-000131e0: 2073 656c 662e 696e 7669 7369 626c 655f   self.invisible_
-000131f0: 636f 756e 7420 2b3d 206c 656e 2875 7064  count += len(upd
-00013200: 6174 6573 290a 0a20 2020 2020 2020 2069  ates)..        i
-00013210: 6620 7365 6c66 2e6c 6179 6f75 742e 7669  f self.layout.vi
-00013220: 7369 626c 655f 6564 6765 5f75 7064 6174  sible_edge_updat
-00013230: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00013240: 7570 6461 7465 7320 3d20 7365 6c66 2e6c  updates = self.l
-00013250: 6179 6f75 742e 7669 7369 626c 655f 6564  ayout.visible_ed
-00013260: 6765 5f75 7064 6174 6573 0a20 2020 2020  ge_updates.     
-00013270: 2020 2020 2020 2075 7064 6174 6573 203d         updates =
-00013280: 205b 2869 2c20 6329 2066 6f72 2069 2c20   [(i, c) for i, 
-00013290: 6320 696e 2075 7064 6174 6573 2069 6620  c in updates if 
-000132a0: 6920 3c20 6d5d 0a20 2020 2020 2020 2020  i < m].         
-000132b0: 2020 2073 656c 662e 6c61 796f 7574 2e76     self.layout.v
-000132c0: 6973 6962 6c65 5f65 6467 655f 7570 6461  isible_edge_upda
-000132d0: 7465 7320 3d20 5b5d 0a20 2020 2020 2020  tes = [].       
-000132e0: 2020 2020 2073 656c 662e 6564 6765 5f73       self.edge_s
-000132f0: 6f75 7263 652e 7061 7463 6828 7b22 7669  ource.patch({"vi
-00013300: 7369 626c 6522 3a20 7570 6461 7465 737d  sible": updates}
-00013310: 290a 0a20 2020 2064 6566 205f 5f64 656c  )..    def __del
-00013320: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
-00013330: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
-00013340: 2e72 656d 6f76 655f 706c 7567 696e 286e  .remove_plugin(n
-00013350: 616d 653d 7365 6c66 2e6c 6179 6f75 742e  ame=self.layout.
-00013360: 6e61 6d65 290a 0a0a 636c 6173 7320 5461  name)...class Ta
-00013370: 736b 4772 6f75 7047 7261 7068 2844 6173  skGroupGraph(Das
-00013380: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
-00013390: 3a0a 2020 2020 2222 220a 2020 2020 5461  :.    """.    Ta
-000133a0: 736b 2047 726f 7570 2047 7261 7068 0a0a  sk Group Graph..
-000133b0: 2020 2020 4372 6561 7465 7320 6120 6772      Creates a gr
-000133c0: 6170 6820 6c61 796f 7574 2066 6f72 2054  aph layout for T
-000133d0: 6173 6b47 726f 7570 7320 6f6e 2074 6865  askGroups on the
-000133e0: 2073 6368 6564 756c 6572 2e20 2049 7420   scheduler.  It 
-000133f0: 6173 7369 676e 730a 2020 2020 2878 2c20  assigns.    (x, 
-00013400: 7929 206c 6f63 6174 696f 6e73 2074 6f20  y) locations to 
-00013410: 616c 6c20 7468 6520 5461 736b 4772 6f75  all the TaskGrou
-00013420: 7073 2061 6e64 206c 6179 7320 7468 656d  ps and lays them
-00013430: 206f 7574 2062 7920 6163 636f 7264 696e   out by accordin
-00013440: 670a 2020 2020 746f 2074 6865 6972 2064  g.    to their d
-00013450: 6570 656e 6465 6e63 6965 732e 2054 6865  ependencies. The
-00013460: 206c 6179 6f75 7420 6765 7473 2075 7064   layout gets upd
-00013470: 6174 6564 2065 7665 7279 2074 696d 6520  ated every time 
-00013480: 7468 6174 206e 6577 0a20 2020 2054 6173  that new.    Tas
-00013490: 6b47 726f 7570 7320 6172 6520 6164 6465  kGroups are adde
-000134a0: 642e 0a0a 2020 2020 4561 6368 2074 6173  d...    Each tas
-000134b0: 6b20 6772 6f75 7020 6e6f 6465 2069 6e63  k group node inc
-000134c0: 6f64 6573 2069 6e66 6f72 6d61 7469 6f6e  odes information
-000134d0: 2061 626f 7574 2074 6173 6b20 7072 6f67   about task prog
-000134e0: 7265 7373 2c20 6d65 6d6f 7279 2c0a 2020  ress, memory,.  
-000134f0: 2020 616e 6420 6f75 7470 7574 2074 7970    and output typ
-00013500: 6520 696e 746f 2067 6c79 7068 732c 2061  e into glyphs, a
-00013510: 7320 7765 6c6c 2061 7320 6120 686f 7665  s well as a hove
-00013520: 7220 746f 6f6c 7469 7020 7769 7468 206d  r tooltip with m
-00013530: 6f72 6520 6465 7461 696c 6564 0a20 2020  ore detailed.   
-00013540: 2069 6e66 6f72 6d61 7469 6f6e 206f 6e20   information on 
-00013550: 6e61 6d65 2c20 636f 6d70 7574 6174 696f  name, computatio
-00013560: 6e20 7469 6d65 2c20 6d65 6d6f 7279 2c20  n time, memory, 
-00013570: 616e 6420 7461 736b 7320 7374 6174 7573  and tasks status
-00013580: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
-00013590: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-000135a0: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
-000135b0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-000135c0: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
-000135d0: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
-000135e0: 2020 2020 7365 6c66 2e6e 6f64 6573 5f6c      self.nodes_l
-000135f0: 6179 6f75 7420 3d20 7b7d 0a20 2020 2020  ayout = {}.     
-00013600: 2020 2073 656c 662e 6172 726f 7773 5f6c     self.arrows_l
-00013610: 6179 6f75 7420 3d20 7b7d 0a0a 2020 2020  ayout = {}..    
-00013620: 2020 2020 7365 6c66 2e6f 6c64 5f63 6f75      self.old_cou
-00013630: 6e74 6572 203d 202d 310a 0a20 2020 2020  nter = -1..     
-00013640: 2020 2073 656c 662e 6e6f 6465 735f 736f     self.nodes_so
-00013650: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
-00013660: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
-00013670: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00013680: 2020 2020 2020 2022 7822 3a20 5b5d 2c0a         "x": [],.
-00013690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136a0: 2279 223a 205b 5d2c 0a20 2020 2020 2020  "y": [],.       
-000136b0: 2020 2020 2020 2020 2022 775f 626f 7822           "w_box"
-000136c0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-000136d0: 2020 2020 2020 2268 5f62 6f78 223a 205b        "h_box": [
-000136e0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-000136f0: 2020 2022 6e61 6d65 223a 205b 5d2c 0a20     "name": [],. 
-00013700: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00013710: 746f 745f 7461 736b 7322 3a20 5b5d 2c0a  tot_tasks": [],.
-00013720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013730: 2263 6f6c 6f72 223a 205b 5d2c 0a20 2020  "color": [],.   
-00013740: 2020 2020 2020 2020 2020 2020 2022 785f               "x_
-00013750: 7374 6172 7422 3a20 5b5d 2c0a 2020 2020  start": [],.    
-00013760: 2020 2020 2020 2020 2020 2020 2278 5f65              "x_e
-00013770: 6e64 223a 205b 5d2c 0a20 2020 2020 2020  nd": [],.       
-00013780: 2020 2020 2020 2020 2022 795f 7374 6172           "y_star
-00013790: 7422 3a20 5b5d 2c0a 2020 2020 2020 2020  t": [],.        
-000137a0: 2020 2020 2020 2020 2279 5f65 6e64 223a          "y_end":
-000137b0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-000137c0: 2020 2020 2022 785f 656e 645f 7072 6f67       "x_end_prog
-000137d0: 7265 7373 223a 205b 5d2c 0a20 2020 2020  ress": [],.     
-000137e0: 2020 2020 2020 2020 2020 2022 6d65 6d5f             "mem_
-000137f0: 616c 7068 6122 3a20 5b5d 2c0a 2020 2020  alpha": [],.    
-00013800: 2020 2020 2020 2020 2020 2020 226e 6f64              "nod
-00013810: 655f 6c69 6e65 5f77 6964 7468 223a 205b  e_line_width": [
-00013820: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00013830: 2020 2022 636f 6d70 5f74 6173 6b73 223a     "comp_tasks":
-00013840: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00013850: 2020 2020 2022 7572 6c5f 6c6f 676f 223a       "url_logo":
+00010ed0: 2020 2020 7265 6374 616e 676c 6573 5b6b      rectangles[k
+00010ee0: 5d20 3d20 6e70 2e61 7272 6179 2876 290a  ] = np.array(v).
+00010ef0: 0a20 2020 2020 2020 2069 6620 5052 4f46  .        if PROF
+00010f00: 494c 494e 473a 0a20 2020 2020 2020 2020  ILING:.         
+00010f10: 2020 2063 7572 646f 6328 292e 6164 645f     curdoc().add_
+00010f20: 6e65 7874 5f74 6963 6b5f 6361 6c6c 6261  next_tick_callba
+00010f30: 636b 280a 2020 2020 2020 2020 2020 2020  ck(.            
+00010f40: 2020 2020 6c61 6d62 6461 3a20 7365 6c66      lambda: self
+00010f50: 2e73 6f75 7263 652e 7374 7265 616d 2872  .source.stream(r
+00010f60: 6563 7461 6e67 6c65 732c 2073 656c 662e  ectangles, self.
+00010f70: 6e5f 7265 6374 616e 676c 6573 290a 2020  n_rectangles).  
+00010f80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00010f90: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00010fa0: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
+00010fb0: 652e 7374 7265 616d 2872 6563 7461 6e67  e.stream(rectang
+00010fc0: 6c65 732c 2073 656c 662e 6e5f 7265 6374  les, self.n_rect
+00010fd0: 616e 676c 6573 290a 0a0a 6465 6620 7461  angles)...def ta
+00010fe0: 736b 5f73 7472 6561 6d5f 6669 6775 7265  sk_stream_figure
+00010ff0: 2863 6c65 6172 5f69 6e74 6572 7661 6c3d  (clear_interval=
+00011000: 2232 3073 222c 202a 2a6b 7761 7267 7329  "20s", **kwargs)
+00011010: 3a0a 2020 2020 2222 220a 2020 2020 6b77  :.    """.    kw
+00011020: 6172 6773 2061 7265 2061 7070 6c69 6564  args are applied
+00011030: 2074 6f20 7468 6520 626f 6b65 682e 6d6f   to the bokeh.mo
+00011040: 6465 6c73 2e70 6c6f 7473 2e50 6c6f 7420  dels.plots.Plot 
+00011050: 636f 6e73 7472 7563 746f 720a 2020 2020  constructor.    
+00011060: 2222 220a 2020 2020 636c 6561 725f 696e  """.    clear_in
+00011070: 7465 7276 616c 203d 2070 6172 7365 5f74  terval = parse_t
+00011080: 696d 6564 656c 7461 2863 6c65 6172 5f69  imedelta(clear_i
+00011090: 6e74 6572 7661 6c2c 2064 6566 6175 6c74  nterval, default
+000110a0: 3d22 6d73 2229 0a0a 2020 2020 736f 7572  ="ms")..    sour
+000110b0: 6365 203d 2043 6f6c 756d 6e44 6174 6153  ce = ColumnDataS
+000110c0: 6f75 7263 6528 0a20 2020 2020 2020 2064  ource(.        d
+000110d0: 6174 613d 6469 6374 280a 2020 2020 2020  ata=dict(.      
+000110e0: 2020 2020 2020 7374 6172 743d 5b74 696d        start=[tim
+000110f0: 6528 2920 2d20 636c 6561 725f 696e 7465  e() - clear_inte
+00011100: 7276 616c 5d2c 0a20 2020 2020 2020 2020  rval],.         
+00011110: 2020 2064 7572 6174 696f 6e3d 5b30 2e31     duration=[0.1
+00011120: 5d2c 0a20 2020 2020 2020 2020 2020 206b  ],.            k
+00011130: 6579 3d5b 2273 7461 7274 225d 2c0a 2020  ey=["start"],.  
+00011140: 2020 2020 2020 2020 2020 6e61 6d65 3d5b            name=[
+00011150: 2273 7461 7274 225d 2c0a 2020 2020 2020  "start"],.      
+00011160: 2020 2020 2020 636f 6c6f 723d 5b22 7768        color=["wh
+00011170: 6974 6522 5d2c 0a20 2020 2020 2020 2020  ite"],.         
+00011180: 2020 2064 7572 6174 696f 6e5f 7465 7874     duration_text
+00011190: 3d5b 2231 3030 206d 7322 5d2c 0a20 2020  =["100 ms"],.   
+000111a0: 2020 2020 2020 2020 2077 6f72 6b65 723d           worker=
+000111b0: 5b22 666f 6f22 5d2c 0a20 2020 2020 2020  ["foo"],.       
+000111c0: 2020 2020 2079 3d5b 305d 2c0a 2020 2020       y=[0],.    
+000111d0: 2020 2020 2020 2020 776f 726b 6572 5f74          worker_t
+000111e0: 6872 6561 643d 5b31 5d2c 0a20 2020 2020  hread=[1],.     
+000111f0: 2020 2020 2020 2061 6c70 6861 3d5b 302e         alpha=[0.
+00011200: 305d 2c0a 2020 2020 2020 2020 290a 2020  0],.        ).  
+00011210: 2020 290a 0a20 2020 2078 5f72 616e 6765    )..    x_range
+00011220: 203d 2044 6174 6152 616e 6765 3164 2872   = DataRange1d(r
+00011230: 616e 6765 5f70 6164 6469 6e67 3d30 290a  ange_padding=0).
+00011240: 2020 2020 795f 7261 6e67 6520 3d20 4461      y_range = Da
+00011250: 7461 5261 6e67 6531 6428 7261 6e67 655f  taRange1d(range_
+00011260: 7061 6464 696e 673d 3029 0a0a 2020 2020  padding=0)..    
+00011270: 726f 6f74 203d 2066 6967 7572 6528 0a20  root = figure(. 
+00011280: 2020 2020 2020 206e 616d 653d 2274 6173         name="tas
+00011290: 6b5f 7374 7265 616d 222c 0a20 2020 2020  k_stream",.     
+000112a0: 2020 2074 6974 6c65 3d22 5461 736b 2053     title="Task S
+000112b0: 7472 6561 6d22 2c0a 2020 2020 2020 2020  tream",.        
+000112c0: 785f 7261 6e67 653d 785f 7261 6e67 652c  x_range=x_range,
+000112d0: 0a20 2020 2020 2020 2079 5f72 616e 6765  .        y_range
+000112e0: 3d79 5f72 616e 6765 2c0a 2020 2020 2020  =y_range,.      
+000112f0: 2020 746f 6f6c 6261 725f 6c6f 6361 7469    toolbar_locati
+00011300: 6f6e 3d22 6162 6f76 6522 2c0a 2020 2020  on="above",.    
+00011310: 2020 2020 785f 6178 6973 5f74 7970 653d      x_axis_type=
+00011320: 2264 6174 6574 696d 6522 2c0a 2020 2020  "datetime",.    
+00011330: 2020 2020 795f 6178 6973 5f6c 6f63 6174      y_axis_locat
+00011340: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
+00011350: 2020 746f 6f6c 733d 2222 2c0a 2020 2020    tools="",.    
+00011360: 2020 2020 6d69 6e5f 626f 7264 6572 5f62      min_border_b
+00011370: 6f74 746f 6d3d 3530 2c0a 2020 2020 2020  ottom=50,.      
+00011380: 2020 2a2a 6b77 6172 6773 2c0a 2020 2020    **kwargs,.    
+00011390: 290a 0a20 2020 2072 6563 7420 3d20 726f  )..    rect = ro
+000113a0: 6f74 2e72 6563 7428 0a20 2020 2020 2020  ot.rect(.       
+000113b0: 2073 6f75 7263 653d 736f 7572 6365 2c0a   source=source,.
+000113c0: 2020 2020 2020 2020 783d 2273 7461 7274          x="start
+000113d0: 222c 0a20 2020 2020 2020 2079 3d22 7922  ",.        y="y"
+000113e0: 2c0a 2020 2020 2020 2020 7769 6474 683d  ,.        width=
+000113f0: 2264 7572 6174 696f 6e22 2c0a 2020 2020  "duration",.    
+00011400: 2020 2020 6865 6967 6874 3d30 2e34 2c0a      height=0.4,.
+00011410: 2020 2020 2020 2020 6669 6c6c 5f63 6f6c          fill_col
+00011420: 6f72 3d22 636f 6c6f 7222 2c0a 2020 2020  or="color",.    
+00011430: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
+00011440: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
+00011450: 6c69 6e65 5f61 6c70 6861 3d30 2e36 2c0a  line_alpha=0.6,.
+00011460: 2020 2020 2020 2020 6669 6c6c 5f61 6c70          fill_alp
+00011470: 6861 3d22 616c 7068 6122 2c0a 2020 2020  ha="alpha",.    
+00011480: 2020 2020 6c69 6e65 5f77 6964 7468 3d33      line_width=3
+00011490: 2c0a 2020 2020 290a 2020 2020 7265 6374  ,.    ).    rect
+000114a0: 2e6e 6f6e 7365 6c65 6374 696f 6e5f 676c  .nonselection_gl
+000114b0: 7970 6820 3d20 4e6f 6e65 0a0a 2020 2020  yph = None..    
+000114c0: 726f 6f74 2e79 6178 6973 2e6d 616a 6f72  root.yaxis.major
+000114d0: 5f6c 6162 656c 5f74 6578 745f 616c 7068  _label_text_alph
+000114e0: 6120 3d20 300a 2020 2020 726f 6f74 2e79  a = 0.    root.y
+000114f0: 6178 6973 2e6d 696e 6f72 5f74 6963 6b5f  axis.minor_tick_
+00011500: 6c69 6e65 5f61 6c70 6861 203d 2030 0a20  line_alpha = 0. 
+00011510: 2020 2072 6f6f 742e 7961 7869 732e 6d61     root.yaxis.ma
+00011520: 6a6f 725f 7469 636b 5f6c 696e 655f 616c  jor_tick_line_al
+00011530: 7068 6120 3d20 300a 2020 2020 726f 6f74  pha = 0.    root
+00011540: 2e78 6772 6964 2e76 6973 6962 6c65 203d  .xgrid.visible =
+00011550: 2046 616c 7365 0a0a 2020 2020 686f 7665   False..    hove
+00011560: 7220 3d20 486f 7665 7254 6f6f 6c28 0a20  r = HoverTool(. 
+00011570: 2020 2020 2020 2070 6f69 6e74 5f70 6f6c         point_pol
+00011580: 6963 793d 2266 6f6c 6c6f 775f 6d6f 7573  icy="follow_mous
+00011590: 6522 2c0a 2020 2020 2020 2020 746f 6f6c  e",.        tool
+000115a0: 7469 7073 3d22 2222 0a20 2020 2020 2020  tips=""".       
+000115b0: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
+000115c0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+000115d0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+000115e0: 653a 2031 3270 783b 2066 6f6e 742d 7765  e: 12px; font-we
+000115f0: 6967 6874 3a20 626f 6c64 3b22 3e40 6e61  ight: bold;">@na
+00011600: 6d65 3a3c 2f73 7061 6e3e 266e 6273 703b  me:</span>&nbsp;
+00011610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011620: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+00011630: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
+00011640: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
+00011650: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
+00011660: 4064 7572 6174 696f 6e5f 7465 7874 3c2f  @duration_text</
+00011670: 7370 616e 3e0a 2020 2020 2020 2020 2020  span>.          
+00011680: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
+00011690: 2020 2020 2022 2222 2c0a 2020 2020 290a       """,.    ).
+000116a0: 0a20 2020 2074 6170 203d 2054 6170 546f  .    tap = TapTo
+000116b0: 6f6c 2863 616c 6c62 6163 6b3d 4f70 656e  ol(callback=Open
+000116c0: 5552 4c28 7572 6c3d 222e 2f70 726f 6669  URL(url="./profi
+000116d0: 6c65 3f6b 6579 3d40 6e61 6d65 2229 290a  le?key=@name")).
+000116e0: 2020 2020 6865 6c70 5f20 3d20 4865 6c70      help_ = Help
+000116f0: 546f 6f6c 280a 2020 2020 2020 2020 7265  Tool(.        re
+00011700: 6469 7265 6374 3d22 6874 7470 733a 2f2f  direct="https://
+00011710: 646f 6373 2e64 6173 6b2e 6f72 672f 656e  docs.dask.org/en
+00011720: 2f73 7461 626c 652f 6461 7368 626f 6172  /stable/dashboar
+00011730: 642e 6874 6d6c 2374 6173 6b2d 7374 7265  d.html#task-stre
+00011740: 616d 222c 0a20 2020 2020 2020 2064 6573  am",.        des
+00011750: 6372 6970 7469 6f6e 3d22 4120 6465 7363  cription="A desc
+00011760: 7269 7074 696f 6e20 6f66 2074 6865 2054  ription of the T
+00011770: 6173 6b53 7472 6561 6d20 616e 6420 6974  askStream and it
+00011780: 7320 636f 6c6f 7220 7061 6c65 7474 652e  s color palette.
+00011790: 222c 0a20 2020 2029 0a20 2020 2072 6f6f  ",.    ).    roo
+000117a0: 742e 6164 645f 746f 6f6c 7328 0a20 2020  t.add_tools(.   
+000117b0: 2020 2020 2068 6f76 6572 2c0a 2020 2020       hover,.    
+000117c0: 2020 2020 7461 702c 0a20 2020 2020 2020      tap,.       
+000117d0: 2042 6f78 5a6f 6f6d 546f 6f6c 2829 2c0a   BoxZoomTool(),.
+000117e0: 2020 2020 2020 2020 5265 7365 7454 6f6f          ResetToo
+000117f0: 6c28 292c 0a20 2020 2020 2020 2050 616e  l(),.        Pan
+00011800: 546f 6f6c 2864 696d 656e 7369 6f6e 733d  Tool(dimensions=
+00011810: 2277 6964 7468 2229 2c0a 2020 2020 2020  "width"),.      
+00011820: 2020 5768 6565 6c5a 6f6f 6d54 6f6f 6c28    WheelZoomTool(
+00011830: 6469 6d65 6e73 696f 6e73 3d22 7769 6474  dimensions="widt
+00011840: 6822 292c 0a20 2020 2020 2020 2068 656c  h"),.        hel
+00011850: 705f 2c0a 2020 2020 290a 2020 2020 6966  p_,.    ).    if
+00011860: 2045 7870 6f72 7454 6f6f 6c3a 2020 2320   ExportTool:  # 
+00011870: 7479 7065 3a20 6967 6e6f 7265 0a20 2020  type: ignore.   
+00011880: 2020 2020 2065 7870 6f72 7420 3d20 4578       export = Ex
+00011890: 706f 7274 546f 6f6c 2829 0a20 2020 2020  portTool().     
+000118a0: 2020 2065 7870 6f72 742e 7265 6769 7374     export.regist
+000118b0: 6572 5f70 6c6f 7428 726f 6f74 290a 2020  er_plot(root).  
+000118c0: 2020 2020 2020 726f 6f74 2e61 6464 5f74        root.add_t
+000118d0: 6f6f 6c73 2865 7870 6f72 7429 0a0a 2020  ools(export)..  
+000118e0: 2020 7265 7475 726e 2073 6f75 7263 652c    return source,
+000118f0: 2072 6f6f 740a 0a0a 636c 6173 7320 5461   root...class Ta
+00011900: 736b 4772 6170 6828 4461 7368 626f 6172  skGraph(Dashboar
+00011910: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
+00011920: 2022 2222 0a20 2020 2041 2064 796e 616d   """.    A dynam
+00011930: 6963 206e 6f64 652d 6c69 6e6b 2064 6961  ic node-link dia
+00011940: 6772 616d 2066 6f72 2074 6865 2074 6173  gram for the tas
+00011950: 6b20 6772 6170 6820 6f6e 2074 6865 2073  k graph on the s
+00011960: 6368 6564 756c 6572 0a0a 2020 2020 5365  cheduler..    Se
+00011970: 6520 616c 736f 2074 6865 2047 7261 7068  e also the Graph
+00011980: 4c61 796f 7574 2064 6961 676e 6f73 7469  Layout diagnosti
+00011990: 6320 6174 0a20 2020 2064 6973 7472 6962  c at.    distrib
+000119a0: 7574 6564 2f64 6961 676e 6f73 7469 6373  uted/diagnostics
+000119b0: 2f67 7261 7068 5f6c 6179 6f75 742e 7079  /graph_layout.py
+000119c0: 0a20 2020 2022 2222 0a0a 2020 2020 6465  .    """..    de
+000119d0: 6620 5f5f 696e 6974 5f5f 2873 656c 662c  f __init__(self,
+000119e0: 2073 6368 6564 756c 6572 2c20 2a2a 6b77   scheduler, **kw
+000119f0: 6172 6773 293a 0a20 2020 2020 2020 2073  args):.        s
+00011a00: 656c 662e 7363 6865 6475 6c65 7220 3d20  elf.scheduler = 
+00011a10: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
+00011a20: 2020 7365 6c66 2e6c 6179 6f75 7420 3d20    self.layout = 
+00011a30: 4772 6170 684c 6179 6f75 7428 7363 6865  GraphLayout(sche
+00011a40: 6475 6c65 7229 0a20 2020 2020 2020 2073  duler).        s
+00011a50: 6368 6564 756c 6572 2e61 6464 5f70 6c75  cheduler.add_plu
+00011a60: 6769 6e28 7365 6c66 2e6c 6179 6f75 7429  gin(self.layout)
+00011a70: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
+00011a80: 7669 7369 626c 655f 636f 756e 7420 3d20  visible_count = 
+00011a90: 3020 2023 206e 756d 6265 7220 6f66 2069  0  # number of i
+00011aa0: 6e76 6973 6962 6c65 206e 6f64 6573 0a0a  nvisible nodes..
+00011ab0: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
+00011ac0: 655f 736f 7572 6365 203d 2043 6f6c 756d  e_source = Colum
+00011ad0: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
+00011ae0: 2020 2020 2020 2020 207b 2278 223a 205b           {"x": [
+00011af0: 5d2c 2022 7922 3a20 5b5d 2c20 226e 616d  ], "y": [], "nam
+00011b00: 6522 3a20 5b5d 2c20 2273 7461 7465 223a  e": [], "state":
+00011b10: 205b 5d2c 2022 7669 7369 626c 6522 3a20   [], "visible": 
+00011b20: 5b5d 2c20 226b 6579 223a 205b 5d7d 0a20  [], "key": []}. 
+00011b30: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00011b40: 2073 656c 662e 6564 6765 5f73 6f75 7263   self.edge_sourc
+00011b50: 6520 3d20 436f 6c75 6d6e 4461 7461 536f  e = ColumnDataSo
+00011b60: 7572 6365 287b 2278 223a 205b 5d2c 2022  urce({"x": [], "
+00011b70: 7922 3a20 5b5d 2c20 2276 6973 6962 6c65  y": [], "visible
+00011b80: 223a 205b 5d7d 290a 0a20 2020 2020 2020  ": []})..       
+00011b90: 2066 696c 7465 7220 3d20 4772 6f75 7046   filter = GroupF
+00011ba0: 696c 7465 7228 636f 6c75 6d6e 5f6e 616d  ilter(column_nam
+00011bb0: 653d 2276 6973 6962 6c65 222c 2067 726f  e="visible", gro
+00011bc0: 7570 3d22 5472 7565 2229 0a20 2020 2020  up="True").     
+00011bd0: 2020 2069 6620 424f 4b45 485f 5645 5253     if BOKEH_VERS
+00011be0: 494f 4e2e 6d61 6a6f 7220 3c20 333a 0a20  ION.major < 3:. 
+00011bf0: 2020 2020 2020 2020 2020 2066 696c 7465             filte
+00011c00: 725f 6b77 6172 6773 203d 207b 2266 696c  r_kwargs = {"fil
+00011c10: 7465 7273 223a 205b 6669 6c74 6572 5d7d  ters": [filter]}
+00011c20: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00011c30: 2020 2020 2020 2020 2020 2066 696c 7465             filte
+00011c40: 725f 6b77 6172 6773 203d 207b 2266 696c  r_kwargs = {"fil
+00011c50: 7465 7222 3a20 6669 6c74 6572 7d0a 2020  ter": filter}.  
+00011c60: 2020 2020 2020 6e6f 6465 5f76 6965 7720        node_view 
+00011c70: 3d20 4344 5356 6965 7728 2a2a 6669 6c74  = CDSView(**filt
+00011c80: 6572 5f6b 7761 7267 7329 0a20 2020 2020  er_kwargs).     
+00011c90: 2020 2065 6467 655f 7669 6577 203d 2043     edge_view = C
+00011ca0: 4453 5669 6577 282a 2a66 696c 7465 725f  DSView(**filter_
+00011cb0: 6b77 6172 6773 290a 0a20 2020 2020 2020  kwargs)..       
+00011cc0: 2023 2042 6f6b 6568 203e 3d20 332e 3020   # Bokeh >= 3.0 
+00011cd0: 6175 746f 6d61 7469 6361 6c6c 7920 696e  automatically in
+00011ce0: 6665 7273 2074 6865 2073 6f75 7263 6520  fers the source 
+00011cf0: 746f 2075 7365 0a20 2020 2020 2020 2069  to use.        i
+00011d00: 6620 424f 4b45 485f 5645 5253 494f 4e2e  f BOKEH_VERSION.
+00011d10: 6d61 6a6f 7220 3c20 333a 0a20 2020 2020  major < 3:.     
+00011d20: 2020 2020 2020 206e 6f64 655f 7669 6577         node_view
+00011d30: 2e73 6f75 7263 6520 3d20 7365 6c66 2e6e  .source = self.n
+00011d40: 6f64 655f 736f 7572 6365 0a20 2020 2020  ode_source.     
+00011d50: 2020 2020 2020 2065 6467 655f 7669 6577         edge_view
+00011d60: 2e73 6f75 7263 6520 3d20 7365 6c66 2e65  .source = self.e
+00011d70: 6467 655f 736f 7572 6365 0a0a 2020 2020  dge_source..    
+00011d80: 2020 2020 6e6f 6465 5f63 6f6c 6f72 7320      node_colors 
+00011d90: 3d20 6661 6374 6f72 5f63 6d61 7028 0a20  = factor_cmap(. 
+00011da0: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+00011db0: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00011dc0: 6661 6374 6f72 733d 5b22 7761 6974 696e  factors=["waitin
+00011dd0: 6722 2c20 2271 7565 7565 6422 2c20 2270  g", "queued", "p
+00011de0: 726f 6365 7373 696e 6722 2c20 226d 656d  rocessing", "mem
+00011df0: 6f72 7922 2c20 2272 656c 6561 7365 6422  ory", "released"
+00011e00: 2c20 2265 7272 6564 225d 2c0a 2020 2020  , "erred"],.    
+00011e10: 2020 2020 2020 2020 7061 6c65 7474 653d          palette=
+00011e20: 5b22 6772 6179 222c 2022 7965 6c6c 6f77  ["gray", "yellow
+00011e30: 222c 2022 6772 6565 6e22 2c20 2272 6564  ", "green", "red
+00011e40: 222c 2022 626c 7565 222c 2022 626c 6163  ", "blue", "blac
+00011e50: 6b22 5d2c 0a20 2020 2020 2020 2029 0a0a  k"],.        )..
+00011e60: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00011e70: 7420 3d20 6669 6775 7265 2874 6974 6c65  t = figure(title
+00011e80: 3d22 5461 736b 2047 7261 7068 222c 202a  ="Task Graph", *
+00011e90: 2a6b 7761 7267 7329 0a20 2020 2020 2020  *kwargs).       
+00011ea0: 2073 656c 662e 7375 6274 6974 6c65 203d   self.subtitle =
+00011eb0: 2054 6974 6c65 2874 6578 743d 2220 222c   Title(text=" ",
+00011ec0: 2074 6578 745f 666f 6e74 5f73 7479 6c65   text_font_style
+00011ed0: 3d22 6974 616c 6963 2229 0a20 2020 2020  ="italic").     
+00011ee0: 2020 2073 656c 662e 726f 6f74 2e61 6464     self.root.add
+00011ef0: 5f6c 6179 6f75 7428 7365 6c66 2e73 7562  _layout(self.sub
+00011f00: 7469 746c 652c 2022 6162 6f76 6522 290a  title, "above").
+00011f10: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+00011f20: 6f74 2e6d 756c 7469 5f6c 696e 6528 0a20  ot.multi_line(. 
+00011f30: 2020 2020 2020 2020 2020 2078 733d 2278             xs="x
+00011f40: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
+00011f50: 733d 2279 222c 0a20 2020 2020 2020 2020  s="y",.         
+00011f60: 2020 2073 6f75 7263 653d 7365 6c66 2e65     source=self.e
+00011f70: 6467 655f 736f 7572 6365 2c0a 2020 2020  dge_source,.    
+00011f80: 2020 2020 2020 2020 6c69 6e65 5f77 6964          line_wid
+00011f90: 7468 3d31 2c0a 2020 2020 2020 2020 2020  th=1,.          
+00011fa0: 2020 7669 6577 3d65 6467 655f 7669 6577    view=edge_view
+00011fb0: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+00011fc0: 6c6f 723d 2262 6c61 636b 222c 0a20 2020  lor="black",.   
+00011fd0: 2020 2020 2020 2020 2061 6c70 6861 3d30           alpha=0
+00011fe0: 2e33 2c0a 2020 2020 2020 2020 290a 2020  .3,.        ).  
+00011ff0: 2020 2020 2020 7265 6374 203d 2073 656c        rect = sel
+00012000: 662e 726f 6f74 2e73 6361 7474 6572 280a  f.root.scatter(.
+00012010: 2020 2020 2020 2020 2020 2020 783d 2278              x="x
+00012020: 222c 0a20 2020 2020 2020 2020 2020 2079  ",.            y
+00012030: 3d22 7922 2c0a 2020 2020 2020 2020 2020  ="y",.          
+00012040: 2020 7369 7a65 3d31 302c 0a20 2020 2020    size=10,.     
+00012050: 2020 2020 2020 2063 6f6c 6f72 3d6e 6f64         color=nod
+00012060: 655f 636f 6c6f 7273 2c0a 2020 2020 2020  e_colors,.      
+00012070: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
+00012080: 662e 6e6f 6465 5f73 6f75 7263 652c 0a20  f.node_source,. 
+00012090: 2020 2020 2020 2020 2020 2076 6965 773d             view=
+000120a0: 6e6f 6465 5f76 6965 772c 0a20 2020 2020  node_view,.     
+000120b0: 2020 2020 2020 206c 6567 656e 645f 6669         legend_fi
+000120c0: 656c 643d 2273 7461 7465 222c 0a20 2020  eld="state",.   
+000120d0: 2020 2020 2020 2020 206d 6172 6b65 723d           marker=
+000120e0: 2273 7175 6172 6522 2c0a 2020 2020 2020  "square",.      
+000120f0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+00012100: 2e72 6f6f 742e 7867 7269 642e 6772 6964  .root.xgrid.grid
+00012110: 5f6c 696e 655f 636f 6c6f 7220 3d20 4e6f  _line_color = No
+00012120: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
+00012130: 726f 6f74 2e79 6772 6964 2e67 7269 645f  root.ygrid.grid_
+00012140: 6c69 6e65 5f63 6f6c 6f72 203d 204e 6f6e  line_color = Non
+00012150: 650a 2020 2020 2020 2020 7365 6c66 2e72  e.        self.r
+00012160: 6f6f 742e 7861 7869 732e 7669 7369 626c  oot.xaxis.visibl
+00012170: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
+00012180: 2020 7365 6c66 2e72 6f6f 742e 7961 7869    self.root.yaxi
+00012190: 732e 7669 7369 626c 6520 3d20 4661 6c73  s.visible = Fals
+000121a0: 650a 0a20 2020 2020 2020 2068 6f76 6572  e..        hover
+000121b0: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
+000121c0: 2020 2020 2020 2020 2020 706f 696e 745f            point_
+000121d0: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
+000121e0: 6f75 7365 222c 0a20 2020 2020 2020 2020  ouse",.         
+000121f0: 2020 2074 6f6f 6c74 6970 733d 223c 623e     tooltips="<b>
+00012200: 406e 616d 653c 2f62 3e3a 2040 7374 6174  @name</b>: @stat
+00012210: 6522 2c0a 2020 2020 2020 2020 2020 2020  e",.            
+00012220: 7265 6e64 6572 6572 733d 5b72 6563 745d  renderers=[rect]
+00012230: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00012240: 2020 2020 7461 7020 3d20 5461 7054 6f6f      tap = TapToo
+00012250: 6c28 6361 6c6c 6261 636b 3d4f 7065 6e55  l(callback=OpenU
+00012260: 524c 2875 726c 3d22 696e 666f 2f74 6173  RL(url="info/tas
+00012270: 6b2f 406b 6579 2e68 746d 6c22 292c 2072  k/@key.html"), r
+00012280: 656e 6465 7265 7273 3d5b 7265 6374 5d29  enderers=[rect])
+00012290: 0a20 2020 2020 2020 2072 6563 742e 6e6f  .        rect.no
+000122a0: 6e73 656c 6563 7469 6f6e 5f67 6c79 7068  nselection_glyph
+000122b0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000122c0: 7365 6c66 2e72 6f6f 742e 6164 645f 746f  self.root.add_to
+000122d0: 6f6c 7328 686f 7665 722c 2074 6170 290a  ols(hover, tap).
+000122e0: 2020 2020 2020 2020 7365 6c66 2e6d 6178          self.max
+000122f0: 5f69 7465 6d73 203d 2063 6f6e 6669 672e  _items = config.
+00012300: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+00012310: 2e64 6173 6862 6f61 7264 2e67 7261 7068  .dashboard.graph
+00012320: 2d6d 6178 2d69 7465 6d73 222c 2035 3030  -max-items", 500
+00012330: 3029 0a0a 2020 2020 4077 6974 686f 7574  0)..    @without
+00012340: 5f70 726f 7065 7274 795f 7661 6c69 6461  _property_valida
+00012350: 7469 6f6e 0a20 2020 2040 6c6f 675f 6572  tion.    @log_er
+00012360: 726f 7273 0a20 2020 2064 6566 2075 7064  rors.    def upd
+00012370: 6174 6528 7365 6c66 293a 0a20 2020 2020  ate(self):.     
+00012380: 2020 2023 2049 6620 7468 6572 6520 6172     # If there ar
+00012390: 6520 746f 6f20 6d61 6e79 2074 6173 6b73  e too many tasks
+000123a0: 2069 6e20 7468 6520 7363 6865 6475 6c65   in the schedule
+000123b0: 7220 7765 276c 6c20 6469 7361 626c 6520  r we'll disable 
+000123c0: 7468 6973 0a20 2020 2020 2020 2023 2063  this.        # c
+000123d0: 6f6d 706f 6f6e 656e 7473 2074 6f20 6e6f  ompoonents to no
+000123e0: 7420 6f76 6572 6c6f 6164 2073 6368 6564  t overload sched
+000123f0: 756c 6572 206f 7220 636c 6965 6e74 2e20  uler or client. 
+00012400: 4f6e 6365 2077 6520 6472 6f70 0a20 2020  Once we drop.   
+00012410: 2020 2020 2023 2062 656c 6f77 2074 6865       # below the
+00012420: 2074 6872 6573 686f 6c64 2c20 7468 6520   threshold, the 
+00012430: 6461 7461 2069 7320 6669 6c6c 6564 2075  data is filled u
+00012440: 7020 6167 6169 6e20 6173 2075 7375 616c  p again as usual
+00012450: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00012460: 7365 6c66 2e73 6368 6564 756c 6572 2e74  self.scheduler.t
+00012470: 6173 6b73 2920 3e20 7365 6c66 2e6d 6178  asks) > self.max
+00012480: 5f69 7465 6d73 3a0a 2020 2020 2020 2020  _items:.        
+00012490: 2020 2020 7365 6c66 2e73 7562 7469 746c      self.subtitl
+000124a0: 652e 7465 7874 203d 2022 5363 6865 6475  e.text = "Schedu
+000124b0: 6c65 7220 6861 7320 746f 6f20 6d61 6e79  ler has too many
+000124c0: 2074 6173 6b73 2074 6f20 6469 7370 6c61   tasks to displa
+000124d0: 792e 220a 2020 2020 2020 2020 2020 2020  y.".            
+000124e0: 666f 7220 636f 6e74 6169 6e65 7220 696e  for container in
+000124f0: 205b 7365 6c66 2e6e 6f64 655f 736f 7572   [self.node_sour
+00012500: 6365 2c20 7365 6c66 2e65 6467 655f 736f  ce, self.edge_so
+00012510: 7572 6365 5d3a 0a20 2020 2020 2020 2020  urce]:.         
+00012520: 2020 2020 2020 2063 6f6e 7461 696e 6572         container
+00012530: 2e64 6174 6120 3d20 7b63 6f6c 3a20 5b5d  .data = {col: []
+00012540: 2066 6f72 2063 6f6c 2069 6e20 636f 6e74   for col in cont
+00012550: 6169 6e65 722e 636f 6c75 6d6e 5f6e 616d  ainer.column_nam
+00012560: 6573 7d0a 2020 2020 2020 2020 656c 7365  es}.        else
+00012570: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00012580: 6f63 6361 7369 6f6e 616c 6c79 2072 6573  occasionally res
+00012590: 6574 2074 6865 2063 6f6c 756d 6e20 6461  et the column da
+000125a0: 7461 2073 6f75 7263 6520 746f 2072 656d  ta source to rem
+000125b0: 6f76 6520 6f6c 6420 6e6f 6465 730a 2020  ove old nodes.  
+000125c0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+000125d0: 662e 696e 7669 7369 626c 655f 636f 756e  f.invisible_coun
+000125e0: 7420 3e20 6c65 6e28 7365 6c66 2e6e 6f64  t > len(self.nod
+000125f0: 655f 736f 7572 6365 2e64 6174 615b 2278  e_source.data["x
+00012600: 225d 2920 2f20 323a 0a20 2020 2020 2020  "]) / 2:.       
+00012610: 2020 2020 2020 2020 2073 656c 662e 6c61           self.la
+00012620: 796f 7574 2e72 6573 6574 5f69 6e64 6578  yout.reset_index
+00012630: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+00012640: 2020 2073 656c 662e 696e 7669 7369 626c     self.invisibl
+00012650: 655f 636f 756e 7420 3d20 300a 2020 2020  e_count = 0.    
+00012660: 2020 2020 2020 2020 2020 2020 7570 6461              upda
+00012670: 7465 203d 2054 7275 650a 2020 2020 2020  te = True.      
+00012680: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00012690: 2020 2020 2020 2020 2020 2020 7570 6461              upda
+000126a0: 7465 203d 2046 616c 7365 0a0a 2020 2020  te = False..    
+000126b0: 2020 2020 2020 2020 6e65 772c 2073 656c          new, sel
+000126c0: 662e 6c61 796f 7574 2e6e 6577 203d 2073  f.layout.new = s
+000126d0: 656c 662e 6c61 796f 7574 2e6e 6577 2c20  elf.layout.new, 
+000126e0: 5b5d 0a20 2020 2020 2020 2020 2020 206e  [].            n
+000126f0: 6577 5f65 6467 6573 203d 2073 656c 662e  ew_edges = self.
+00012700: 6c61 796f 7574 2e6e 6577 5f65 6467 6573  layout.new_edges
+00012710: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00012720: 662e 6c61 796f 7574 2e6e 6577 5f65 6467  f.layout.new_edg
+00012730: 6573 203d 205b 5d0a 0a20 2020 2020 2020  es = []..       
+00012740: 2020 2020 2073 656c 662e 6164 645f 6e65       self.add_ne
+00012750: 775f 6e6f 6465 735f 6564 6765 7328 6e65  w_nodes_edges(ne
+00012760: 772c 206e 6577 5f65 6467 6573 2c20 7570  w, new_edges, up
+00012770: 6461 7465 3d75 7064 6174 6529 0a0a 2020  date=update)..  
+00012780: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
+00012790: 6174 6368 5f75 7064 6174 6573 2829 0a0a  atch_updates()..
+000127a0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+000127b0: 656e 2873 656c 662e 7363 6865 6475 6c65  en(self.schedule
+000127c0: 722e 7461 736b 7329 203d 3d20 303a 0a20  r.tasks) == 0:. 
+000127d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000127e0: 656c 662e 7375 6274 6974 6c65 2e74 6578  elf.subtitle.tex
+000127f0: 7420 3d20 2253 6368 6564 756c 6572 2069  t = "Scheduler i
+00012800: 7320 656d 7074 792e 220a 2020 2020 2020  s empty.".      
+00012810: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00012820: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00012830: 2e73 7562 7469 746c 652e 7465 7874 203d  .subtitle.text =
+00012840: 2022 2022 0a0a 2020 2020 4077 6974 686f   " "..    @witho
+00012850: 7574 5f70 726f 7065 7274 795f 7661 6c69  ut_property_vali
+00012860: 6461 7469 6f6e 0a20 2020 2064 6566 2061  dation.    def a
+00012870: 6464 5f6e 6577 5f6e 6f64 6573 5f65 6467  dd_new_nodes_edg
+00012880: 6573 2873 656c 662c 206e 6577 2c20 6e65  es(self, new, ne
+00012890: 775f 6564 6765 732c 2075 7064 6174 653d  w_edges, update=
+000128a0: 4661 6c73 6529 3a0a 2020 2020 2020 2020  False):.        
+000128b0: 6966 206e 6577 206f 7220 7570 6461 7465  if new or update
+000128c0: 3a0a 2020 2020 2020 2020 2020 2020 6e6f  :.            no
+000128d0: 6465 5f6b 6579 203d 205b 5d0a 2020 2020  de_key = [].    
+000128e0: 2020 2020 2020 2020 6e6f 6465 5f78 203d          node_x =
+000128f0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00012900: 6e6f 6465 5f79 203d 205b 5d0a 2020 2020  node_y = [].    
+00012910: 2020 2020 2020 2020 6e6f 6465 5f73 7461          node_sta
+00012920: 7465 203d 205b 5d0a 2020 2020 2020 2020  te = [].        
+00012930: 2020 2020 6e6f 6465 5f6e 616d 6520 3d20      node_name = 
+00012940: 5b5d 0a20 2020 2020 2020 2020 2020 2065  [].            e
+00012950: 6467 655f 7820 3d20 5b5d 0a20 2020 2020  dge_x = [].     
+00012960: 2020 2020 2020 2065 6467 655f 7920 3d20         edge_y = 
+00012970: 5b5d 0a0a 2020 2020 2020 2020 2020 2020  []..            
+00012980: 7820 3d20 7365 6c66 2e6c 6179 6f75 742e  x = self.layout.
+00012990: 780a 2020 2020 2020 2020 2020 2020 7920  x.            y 
+000129a0: 3d20 7365 6c66 2e6c 6179 6f75 742e 790a  = self.layout.y.
+000129b0: 0a20 2020 2020 2020 2020 2020 2074 6173  .            tas
+000129c0: 6b73 203d 2073 656c 662e 7363 6865 6475  ks = self.schedu
+000129d0: 6c65 722e 7461 736b 730a 2020 2020 2020  ler.tasks.      
+000129e0: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+000129f0: 206e 6577 3a0a 2020 2020 2020 2020 2020   new:.          
+00012a00: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00012a10: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00012a20: 6173 6b20 3d20 7461 736b 735b 6b65 795d  ask = tasks[key]
+00012a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012a40: 2065 7863 6570 7420 4b65 7945 7272 6f72   except KeyError
+00012a50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012a60: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00012a70: 2020 2020 2020 2020 2020 2020 2020 2078                 x
+00012a80: 7820 3d20 785b 6b65 795d 0a20 2020 2020  x = x[key].     
+00012a90: 2020 2020 2020 2020 2020 2079 7920 3d20             yy = 
+00012aa0: 795b 6b65 795d 0a20 2020 2020 2020 2020  y[key].         
+00012ab0: 2020 2020 2020 206e 6f64 655f 6b65 792e         node_key.
+00012ac0: 6170 7065 6e64 2865 7363 6170 652e 7572  append(escape.ur
+00012ad0: 6c5f 6573 6361 7065 2873 7472 286b 6579  l_escape(str(key
+00012ae0: 2929 290a 2020 2020 2020 2020 2020 2020  ))).            
+00012af0: 2020 2020 6e6f 6465 5f78 2e61 7070 656e      node_x.appen
+00012b00: 6428 7878 290a 2020 2020 2020 2020 2020  d(xx).          
+00012b10: 2020 2020 2020 6e6f 6465 5f79 2e61 7070        node_y.app
+00012b20: 656e 6428 7979 290a 2020 2020 2020 2020  end(yy).        
+00012b30: 2020 2020 2020 2020 6e6f 6465 5f73 7461          node_sta
+00012b40: 7465 2e61 7070 656e 6428 7461 736b 2e73  te.append(task.s
+00012b50: 7461 7465 290a 2020 2020 2020 2020 2020  tate).          
+00012b60: 2020 2020 2020 6e6f 6465 5f6e 616d 652e        node_name.
+00012b70: 6170 7065 6e64 2874 6173 6b2e 7072 6566  append(task.pref
+00012b80: 6978 2e6e 616d 6529 0a0a 2020 2020 2020  ix.name)..      
+00012b90: 2020 2020 2020 666f 7220 612c 2062 2069        for a, b i
+00012ba0: 6e20 6e65 775f 6564 6765 733a 0a20 2020  n new_edges:.   
+00012bb0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00012bc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012bd0: 2020 2020 2020 6564 6765 5f78 2e61 7070        edge_x.app
+00012be0: 656e 6428 5b78 5b61 5d2c 2078 5b62 5d5d  end([x[a], x[b]]
+00012bf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012c00: 2020 2020 2020 6564 6765 5f79 2e61 7070        edge_y.app
+00012c10: 656e 6428 5b79 5b61 5d2c 2079 5b62 5d5d  end([y[a], y[b]]
+00012c20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00012c30: 2020 6578 6365 7074 204b 6579 4572 726f    except KeyErro
+00012c40: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00012c50: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+00012c60: 2020 2020 2020 2020 206e 6f64 6520 3d20           node = 
+00012c70: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+00012c80: 2020 2278 223a 206e 6f64 655f 782c 0a20    "x": node_x,. 
+00012c90: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00012ca0: 7922 3a20 6e6f 6465 5f79 2c0a 2020 2020  y": node_y,.    
+00012cb0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00012cc0: 7465 223a 206e 6f64 655f 7374 6174 652c  te": node_state,
+00012cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012ce0: 2022 6e61 6d65 223a 206e 6f64 655f 6e61   "name": node_na
+00012cf0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
+00012d00: 2020 2020 226b 6579 223a 206e 6f64 655f      "key": node_
+00012d10: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
+00012d20: 2020 2020 2022 7669 7369 626c 6522 3a20       "visible": 
+00012d30: 5b22 5472 7565 225d 202a 206c 656e 286e  ["True"] * len(n
+00012d40: 6f64 655f 7829 2c0a 2020 2020 2020 2020  ode_x),.        
+00012d50: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
+00012d60: 2020 6564 6765 203d 207b 2278 223a 2065    edge = {"x": e
+00012d70: 6467 655f 782c 2022 7922 3a20 6564 6765  dge_x, "y": edge
+00012d80: 5f79 2c20 2276 6973 6962 6c65 223a 205b  _y, "visible": [
+00012d90: 2254 7275 6522 5d20 2a20 6c65 6e28 6564  "True"] * len(ed
+00012da0: 6765 5f78 297d 0a0a 2020 2020 2020 2020  ge_x)}..        
+00012db0: 2020 2020 6966 2075 7064 6174 6520 6f72      if update or
+00012dc0: 206e 6f74 206c 656e 2873 656c 662e 6e6f   not len(self.no
+00012dd0: 6465 5f73 6f75 7263 652e 6461 7461 5b22  de_source.data["
+00012de0: 7822 5d29 3a0a 2020 2020 2020 2020 2020  x"]):.          
+00012df0: 2020 2020 2020 2320 7365 6520 6874 7470        # see http
+00012e00: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f62  s://github.com/b
+00012e10: 6f6b 6568 2f62 6f6b 6568 2f69 7373 7565  okeh/bokeh/issue
+00012e20: 732f 3735 3233 0a20 2020 2020 2020 2020  s/7523.         
+00012e30: 2020 2020 2020 2073 656c 662e 6e6f 6465         self.node
+00012e40: 5f73 6f75 7263 652e 6461 7461 2e75 7064  _source.data.upd
+00012e50: 6174 6528 6e6f 6465 290a 2020 2020 2020  ate(node).      
+00012e60: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+00012e70: 6467 655f 736f 7572 6365 2e64 6174 612e  dge_source.data.
+00012e80: 7570 6461 7465 2865 6467 6529 0a20 2020  update(edge).   
+00012e90: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00012ea0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00012eb0: 656c 662e 6e6f 6465 5f73 6f75 7263 652e  elf.node_source.
+00012ec0: 7374 7265 616d 286e 6f64 6529 0a20 2020  stream(node).   
+00012ed0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00012ee0: 662e 6564 6765 5f73 6f75 7263 652e 7374  f.edge_source.st
+00012ef0: 7265 616d 2865 6467 6529 0a0a 2020 2020  ream(edge)..    
+00012f00: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
+00012f10: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
+00012f20: 2064 6566 2070 6174 6368 5f75 7064 6174   def patch_updat
+00012f30: 6573 2873 656c 6629 3a0a 2020 2020 2020  es(self):.      
+00012f40: 2020 2222 220a 2020 2020 2020 2020 536d    """.        Sm
+00012f50: 616c 6c20 7570 6461 7465 7320 6c69 6b65  all updates like
+00012f60: 2063 6f6c 6f72 2063 6861 6e67 6573 206f   color changes o
+00012f70: 7220 6c6f 7374 206e 6f64 6573 2066 726f  r lost nodes fro
+00012f80: 6d20 7461 736b 2074 7261 6e73 6974 696f  m task transitio
+00012f90: 6e73 0a20 2020 2020 2020 2022 2222 0a20  ns.        """. 
+00012fa0: 2020 2020 2020 206e 203d 206c 656e 2873         n = len(s
+00012fb0: 656c 662e 6e6f 6465 5f73 6f75 7263 652e  elf.node_source.
+00012fc0: 6461 7461 5b22 7822 5d29 0a20 2020 2020  data["x"]).     
+00012fd0: 2020 206d 203d 206c 656e 2873 656c 662e     m = len(self.
+00012fe0: 6564 6765 5f73 6f75 7263 652e 6461 7461  edge_source.data
+00012ff0: 5b22 7822 5d29 0a0a 2020 2020 2020 2020  ["x"])..        
+00013000: 6966 2073 656c 662e 6c61 796f 7574 2e73  if self.layout.s
+00013010: 7461 7465 5f75 7064 6174 6573 3a0a 2020  tate_updates:.  
+00013020: 2020 2020 2020 2020 2020 7374 6174 655f            state_
+00013030: 7570 6461 7465 7320 3d20 7365 6c66 2e6c  updates = self.l
+00013040: 6179 6f75 742e 7374 6174 655f 7570 6461  ayout.state_upda
+00013050: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+00013060: 7365 6c66 2e6c 6179 6f75 742e 7374 6174  self.layout.stat
+00013070: 655f 7570 6461 7465 7320 3d20 5b5d 0a20  e_updates = []. 
+00013080: 2020 2020 2020 2020 2020 2075 7064 6174             updat
+00013090: 6573 203d 205b 2869 2c20 6329 2066 6f72  es = [(i, c) for
+000130a0: 2069 2c20 6320 696e 2073 7461 7465 5f75   i, c in state_u
+000130b0: 7064 6174 6573 2069 6620 6920 3c20 6e5d  pdates if i < n]
+000130c0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000130d0: 662e 6e6f 6465 5f73 6f75 7263 652e 7061  f.node_source.pa
+000130e0: 7463 6828 7b22 7374 6174 6522 3a20 7570  tch({"state": up
+000130f0: 6461 7465 737d 290a 0a20 2020 2020 2020  dates})..       
+00013100: 2069 6620 7365 6c66 2e6c 6179 6f75 742e   if self.layout.
+00013110: 7669 7369 626c 655f 7570 6461 7465 733a  visible_updates:
+00013120: 0a20 2020 2020 2020 2020 2020 2075 7064  .            upd
+00013130: 6174 6573 203d 2073 656c 662e 6c61 796f  ates = self.layo
+00013140: 7574 2e76 6973 6962 6c65 5f75 7064 6174  ut.visible_updat
+00013150: 6573 0a20 2020 2020 2020 2020 2020 2075  es.            u
+00013160: 7064 6174 6573 203d 205b 2869 2c20 6329  pdates = [(i, c)
+00013170: 2066 6f72 2069 2c20 6320 696e 2075 7064   for i, c in upd
+00013180: 6174 6573 2069 6620 6920 3c20 6e5d 0a20  ates if i < n]. 
+00013190: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000131a0: 6c61 796f 7574 2e76 6973 6962 6c65 5f75  layout.visible_u
+000131b0: 7064 6174 6573 203d 205b 5d0a 2020 2020  pdates = [].    
+000131c0: 2020 2020 2020 2020 7365 6c66 2e6e 6f64          self.nod
+000131d0: 655f 736f 7572 6365 2e70 6174 6368 287b  e_source.patch({
+000131e0: 2276 6973 6962 6c65 223a 2075 7064 6174  "visible": updat
+000131f0: 6573 7d29 0a20 2020 2020 2020 2020 2020  es}).           
+00013200: 2073 656c 662e 696e 7669 7369 626c 655f   self.invisible_
+00013210: 636f 756e 7420 2b3d 206c 656e 2875 7064  count += len(upd
+00013220: 6174 6573 290a 0a20 2020 2020 2020 2069  ates)..        i
+00013230: 6620 7365 6c66 2e6c 6179 6f75 742e 7669  f self.layout.vi
+00013240: 7369 626c 655f 6564 6765 5f75 7064 6174  sible_edge_updat
+00013250: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00013260: 7570 6461 7465 7320 3d20 7365 6c66 2e6c  updates = self.l
+00013270: 6179 6f75 742e 7669 7369 626c 655f 6564  ayout.visible_ed
+00013280: 6765 5f75 7064 6174 6573 0a20 2020 2020  ge_updates.     
+00013290: 2020 2020 2020 2075 7064 6174 6573 203d         updates =
+000132a0: 205b 2869 2c20 6329 2066 6f72 2069 2c20   [(i, c) for i, 
+000132b0: 6320 696e 2075 7064 6174 6573 2069 6620  c in updates if 
+000132c0: 6920 3c20 6d5d 0a20 2020 2020 2020 2020  i < m].         
+000132d0: 2020 2073 656c 662e 6c61 796f 7574 2e76     self.layout.v
+000132e0: 6973 6962 6c65 5f65 6467 655f 7570 6461  isible_edge_upda
+000132f0: 7465 7320 3d20 5b5d 0a20 2020 2020 2020  tes = [].       
+00013300: 2020 2020 2073 656c 662e 6564 6765 5f73       self.edge_s
+00013310: 6f75 7263 652e 7061 7463 6828 7b22 7669  ource.patch({"vi
+00013320: 7369 626c 6522 3a20 7570 6461 7465 737d  sible": updates}
+00013330: 290a 0a20 2020 2064 6566 205f 5f64 656c  )..    def __del
+00013340: 5f5f 2873 656c 6629 3a0a 2020 2020 2020  __(self):.      
+00013350: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+00013360: 2e72 656d 6f76 655f 706c 7567 696e 286e  .remove_plugin(n
+00013370: 616d 653d 7365 6c66 2e6c 6179 6f75 742e  ame=self.layout.
+00013380: 6e61 6d65 290a 0a0a 636c 6173 7320 5461  name)...class Ta
+00013390: 736b 4772 6f75 7047 7261 7068 2844 6173  skGroupGraph(Das
+000133a0: 6862 6f61 7264 436f 6d70 6f6e 656e 7429  hboardComponent)
+000133b0: 3a0a 2020 2020 2222 220a 2020 2020 5461  :.    """.    Ta
+000133c0: 736b 2047 726f 7570 2047 7261 7068 0a0a  sk Group Graph..
+000133d0: 2020 2020 4372 6561 7465 7320 6120 6772      Creates a gr
+000133e0: 6170 6820 6c61 796f 7574 2066 6f72 2054  aph layout for T
+000133f0: 6173 6b47 726f 7570 7320 6f6e 2074 6865  askGroups on the
+00013400: 2073 6368 6564 756c 6572 2e20 2049 7420   scheduler.  It 
+00013410: 6173 7369 676e 730a 2020 2020 2878 2c20  assigns.    (x, 
+00013420: 7929 206c 6f63 6174 696f 6e73 2074 6f20  y) locations to 
+00013430: 616c 6c20 7468 6520 5461 736b 4772 6f75  all the TaskGrou
+00013440: 7073 2061 6e64 206c 6179 7320 7468 656d  ps and lays them
+00013450: 206f 7574 2062 7920 6163 636f 7264 696e   out by accordin
+00013460: 670a 2020 2020 746f 2074 6865 6972 2064  g.    to their d
+00013470: 6570 656e 6465 6e63 6965 732e 2054 6865  ependencies. The
+00013480: 206c 6179 6f75 7420 6765 7473 2075 7064   layout gets upd
+00013490: 6174 6564 2065 7665 7279 2074 696d 6520  ated every time 
+000134a0: 7468 6174 206e 6577 0a20 2020 2054 6173  that new.    Tas
+000134b0: 6b47 726f 7570 7320 6172 6520 6164 6465  kGroups are adde
+000134c0: 642e 0a0a 2020 2020 4561 6368 2074 6173  d...    Each tas
+000134d0: 6b20 6772 6f75 7020 6e6f 6465 2069 6e63  k group node inc
+000134e0: 6f64 6573 2069 6e66 6f72 6d61 7469 6f6e  odes information
+000134f0: 2061 626f 7574 2074 6173 6b20 7072 6f67   about task prog
+00013500: 7265 7373 2c20 6d65 6d6f 7279 2c0a 2020  ress, memory,.  
+00013510: 2020 616e 6420 6f75 7470 7574 2074 7970    and output typ
+00013520: 6520 696e 746f 2067 6c79 7068 732c 2061  e into glyphs, a
+00013530: 7320 7765 6c6c 2061 7320 6120 686f 7665  s well as a hove
+00013540: 7220 746f 6f6c 7469 7020 7769 7468 206d  r tooltip with m
+00013550: 6f72 6520 6465 7461 696c 6564 0a20 2020  ore detailed.   
+00013560: 2069 6e66 6f72 6d61 7469 6f6e 206f 6e20   information on 
+00013570: 6e61 6d65 2c20 636f 6d70 7574 6174 696f  name, computatio
+00013580: 6e20 7469 6d65 2c20 6d65 6d6f 7279 2c20  n time, memory, 
+00013590: 616e 6420 7461 736b 7320 7374 6174 7573  and tasks status
+000135a0: 2e0a 2020 2020 2222 220a 0a20 2020 2064  ..    """..    d
+000135b0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+000135c0: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
+000135d0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+000135e0: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
+000135f0: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
+00013600: 2020 2020 7365 6c66 2e6e 6f64 6573 5f6c      self.nodes_l
+00013610: 6179 6f75 7420 3d20 7b7d 0a20 2020 2020  ayout = {}.     
+00013620: 2020 2073 656c 662e 6172 726f 7773 5f6c     self.arrows_l
+00013630: 6179 6f75 7420 3d20 7b7d 0a0a 2020 2020  ayout = {}..    
+00013640: 2020 2020 7365 6c66 2e6f 6c64 5f63 6f75      self.old_cou
+00013650: 6e74 6572 203d 202d 310a 0a20 2020 2020  nter = -1..     
+00013660: 2020 2073 656c 662e 6e6f 6465 735f 736f     self.nodes_so
+00013670: 7572 6365 203d 2043 6f6c 756d 6e44 6174  urce = ColumnDat
+00013680: 6153 6f75 7263 6528 0a20 2020 2020 2020  aSource(.       
+00013690: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
+000136a0: 2020 2020 2020 2022 7822 3a20 5b5d 2c0a         "x": [],.
+000136b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000136c0: 2279 223a 205b 5d2c 0a20 2020 2020 2020  "y": [],.       
+000136d0: 2020 2020 2020 2020 2022 775f 626f 7822           "w_box"
+000136e0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+000136f0: 2020 2020 2020 2268 5f62 6f78 223a 205b        "h_box": [
+00013700: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00013710: 2020 2022 6e61 6d65 223a 205b 5d2c 0a20     "name": [],. 
+00013720: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00013730: 746f 745f 7461 736b 7322 3a20 5b5d 2c0a  tot_tasks": [],.
+00013740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013750: 2263 6f6c 6f72 223a 205b 5d2c 0a20 2020  "color": [],.   
+00013760: 2020 2020 2020 2020 2020 2020 2022 785f               "x_
+00013770: 7374 6172 7422 3a20 5b5d 2c0a 2020 2020  start": [],.    
+00013780: 2020 2020 2020 2020 2020 2020 2278 5f65              "x_e
+00013790: 6e64 223a 205b 5d2c 0a20 2020 2020 2020  nd": [],.       
+000137a0: 2020 2020 2020 2020 2022 795f 7374 6172           "y_star
+000137b0: 7422 3a20 5b5d 2c0a 2020 2020 2020 2020  t": [],.        
+000137c0: 2020 2020 2020 2020 2279 5f65 6e64 223a          "y_end":
+000137d0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000137e0: 2020 2020 2022 785f 656e 645f 7072 6f67       "x_end_prog
+000137f0: 7265 7373 223a 205b 5d2c 0a20 2020 2020  ress": [],.     
+00013800: 2020 2020 2020 2020 2020 2022 6d65 6d5f             "mem_
+00013810: 616c 7068 6122 3a20 5b5d 2c0a 2020 2020  alpha": [],.    
+00013820: 2020 2020 2020 2020 2020 2020 226e 6f64              "nod
+00013830: 655f 6c69 6e65 5f77 6964 7468 223a 205b  e_line_width": [
+00013840: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00013850: 2020 2022 636f 6d70 5f74 6173 6b73 223a     "comp_tasks":
 00013860: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00013870: 2020 2020 2022 785f 6c6f 676f 223a 205b       "x_logo": [
-00013880: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00013890: 2020 2022 795f 6c6f 676f 223a 205b 5d2c     "y_logo": [],
-000138a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000138b0: 2022 775f 6c6f 676f 223a 205b 5d2c 0a20   "w_logo": [],. 
-000138c0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000138d0: 685f 6c6f 676f 223a 205b 5d2c 0a20 2020  h_logo": [],.   
-000138e0: 2020 2020 2020 2020 2020 2020 2022 696e               "in
-000138f0: 5f70 726f 6365 7373 696e 6722 3a20 5b5d  _processing": []
-00013900: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00013910: 2020 2269 6e5f 6d65 6d6f 7279 223a 205b    "in_memory": [
-00013920: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00013930: 2020 2022 696e 5f72 656c 6561 7365 6422     "in_released"
-00013940: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00013950: 2020 2020 2020 2269 6e5f 6572 7265 6422        "in_erred"
+00013870: 2020 2020 2022 7572 6c5f 6c6f 676f 223a       "url_logo":
+00013880: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00013890: 2020 2020 2022 785f 6c6f 676f 223a 205b       "x_logo": [
+000138a0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+000138b0: 2020 2022 795f 6c6f 676f 223a 205b 5d2c     "y_logo": [],
+000138c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000138d0: 2022 775f 6c6f 676f 223a 205b 5d2c 0a20   "w_logo": [],. 
+000138e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+000138f0: 685f 6c6f 676f 223a 205b 5d2c 0a20 2020  h_logo": [],.   
+00013900: 2020 2020 2020 2020 2020 2020 2022 696e               "in
+00013910: 5f70 726f 6365 7373 696e 6722 3a20 5b5d  _processing": []
+00013920: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013930: 2020 2269 6e5f 6d65 6d6f 7279 223a 205b    "in_memory": [
+00013940: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00013950: 2020 2022 696e 5f72 656c 6561 7365 6422     "in_released"
 00013960: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00013970: 2020 2020 2020 2263 6f6d 7075 7465 5f74        "compute_t
-00013980: 696d 6522 3a20 5b5d 2c0a 2020 2020 2020  ime": [],.      
-00013990: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-000139a0: 7922 3a20 5b5d 2c0a 2020 2020 2020 2020  y": [],.        
-000139b0: 2020 2020 7d0a 2020 2020 2020 2020 290a      }.        ).
-000139c0: 0a20 2020 2020 2020 2073 656c 662e 6172  .        self.ar
-000139d0: 726f 7773 5f73 6f75 7263 6520 3d20 436f  rows_source = Co
-000139e0: 6c75 6d6e 4461 7461 536f 7572 6365 287b  lumnDataSource({
-000139f0: 2278 7322 3a20 5b5d 2c20 2279 7322 3a20  "xs": [], "ys": 
-00013a00: 5b5d 2c20 2278 6522 3a20 5b5d 2c20 2279  [], "xe": [], "y
-00013a10: 6522 3a20 5b5d 7d29 0a0a 2020 2020 2020  e": []})..      
-00013a20: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
-00013a30: 6775 7265 2874 6974 6c65 3d22 5461 736b  gure(title="Task
-00013a40: 2047 726f 7570 7320 4772 6170 6822 2c20   Groups Graph", 
-00013a50: 6d61 7463 685f 6173 7065 6374 3d54 7275  match_aspect=Tru
-00013a60: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
-00013a70: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
-00013a80: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
-00013a90: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
-00013aa0: 2e73 7562 7469 746c 6520 3d20 5469 746c  .subtitle = Titl
-00013ab0: 6528 7465 7874 3d22 2022 2c20 7465 7874  e(text=" ", text
-00013ac0: 5f66 6f6e 745f 7374 796c 653d 2269 7461  _font_style="ita
-00013ad0: 6c69 6322 290a 2020 2020 2020 2020 7365  lic").        se
-00013ae0: 6c66 2e72 6f6f 742e 6164 645f 6c61 796f  lf.root.add_layo
-00013af0: 7574 2873 656c 662e 7375 6274 6974 6c65  ut(self.subtitle
-00013b00: 2c20 2261 626f 7665 2229 0a0a 2020 2020  , "above")..    
-00013b10: 2020 2020 7265 6374 203d 2073 656c 662e      rect = self.
-00013b20: 726f 6f74 2e72 6563 7428 0a20 2020 2020  root.rect(.     
-00013b30: 2020 2020 2020 2078 3d22 7822 2c0a 2020         x="x",.  
-00013b40: 2020 2020 2020 2020 2020 793d 2279 222c            y="y",
-00013b50: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
-00013b60: 7468 3d22 775f 626f 7822 2c0a 2020 2020  th="w_box",.    
-00013b70: 2020 2020 2020 2020 6865 6967 6874 3d22          height="
-00013b80: 685f 626f 7822 2c0a 2020 2020 2020 2020  h_box",.        
-00013b90: 2020 2020 636f 6c6f 723d 2263 6f6c 6f72      color="color
-00013ba0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
-00013bb0: 696c 6c5f 616c 7068 613d 226d 656d 5f61  ill_alpha="mem_a
-00013bc0: 6c70 6861 222c 0a20 2020 2020 2020 2020  lpha",.         
-00013bd0: 2020 206c 696e 655f 636f 6c6f 723d 2262     line_color="b
-00013be0: 6c61 636b 222c 0a20 2020 2020 2020 2020  lack",.         
-00013bf0: 2020 206c 696e 655f 7769 6474 683d 226e     line_width="n
-00013c00: 6f64 655f 6c69 6e65 5f77 6964 7468 222c  ode_line_width",
-00013c10: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-00013c20: 7263 653d 7365 6c66 2e6e 6f64 6573 5f73  rce=self.nodes_s
-00013c30: 6f75 7263 652c 0a20 2020 2020 2020 2029  ource,.        )
-00013c40: 0a0a 2020 2020 2020 2020 2320 706c 6f74  ..        # plot
-00013c50: 2074 6720 6c6f 670a 2020 2020 2020 2020   tg log.        
-00013c60: 7365 6c66 2e72 6f6f 742e 696d 6167 655f  self.root.image_
-00013c70: 7572 6c28 0a20 2020 2020 2020 2020 2020  url(.           
-00013c80: 2075 726c 3d22 7572 6c5f 6c6f 676f 222c   url="url_logo",
-00013c90: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
-00013ca0: 785f 6c6f 676f 222c 0a20 2020 2020 2020  x_logo",.       
-00013cb0: 2020 2020 2079 3d22 795f 6c6f 676f 222c       y="y_logo",
-00013cc0: 0a20 2020 2020 2020 2020 2020 2077 3d22  .            w="
-00013cd0: 775f 6c6f 676f 222c 0a20 2020 2020 2020  w_logo",.       
-00013ce0: 2020 2020 2068 3d22 685f 6c6f 676f 222c       h="h_logo",
-00013cf0: 0a20 2020 2020 2020 2020 2020 2061 6e63  .            anc
-00013d00: 686f 723d 2263 656e 7465 7222 2c0a 2020  hor="center",.  
-00013d10: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00013d20: 3d73 656c 662e 6e6f 6465 735f 736f 7572  =self.nodes_sour
-00013d30: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
-00013d40: 2020 2020 2020 2023 2070 726f 6772 6573         # progres
-00013d50: 7320 6261 7220 706c 6169 6e20 626f 780a  s bar plain box.
-00013d60: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-00013d70: 742e 7175 6164 280a 2020 2020 2020 2020  t.quad(.        
-00013d80: 2020 2020 6c65 6674 3d22 785f 7374 6172      left="x_star
-00013d90: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-00013da0: 7269 6768 743d 2278 5f65 6e64 222c 0a20  right="x_end",. 
-00013db0: 2020 2020 2020 2020 2020 2062 6f74 746f             botto
-00013dc0: 6d3d 2279 5f73 7461 7274 222c 0a20 2020  m="y_start",.   
-00013dd0: 2020 2020 2020 2020 2074 6f70 3d22 795f           top="y_
-00013de0: 656e 6422 2c0a 2020 2020 2020 2020 2020  end",.          
-00013df0: 2020 636f 6c6f 723d 4e6f 6e65 2c0a 2020    color=None,.  
-00013e00: 2020 2020 2020 2020 2020 6c69 6e65 5f63            line_c
-00013e10: 6f6c 6f72 3d22 626c 6163 6b22 2c0a 2020  olor="black",.  
-00013e20: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00013e30: 3d73 656c 662e 6e6f 6465 735f 736f 7572  =self.nodes_sour
-00013e40: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
-00013e50: 2020 2020 2020 2023 2070 726f 6772 6573         # progres
-00013e60: 7320 6261 720a 2020 2020 2020 2020 7365  s bar.        se
-00013e70: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
-00013e80: 2020 2020 2020 2020 2020 6c65 6674 3d22            left="
-00013e90: 785f 7374 6172 7422 2c0a 2020 2020 2020  x_start",.      
-00013ea0: 2020 2020 2020 7269 6768 743d 2278 5f65        right="x_e
-00013eb0: 6e64 5f70 726f 6772 6573 7322 2c0a 2020  nd_progress",.  
-00013ec0: 2020 2020 2020 2020 2020 626f 7474 6f6d            bottom
-00013ed0: 3d22 795f 7374 6172 7422 2c0a 2020 2020  ="y_start",.    
-00013ee0: 2020 2020 2020 2020 746f 703d 2279 5f65          top="y_e
-00013ef0: 6e64 222c 0a20 2020 2020 2020 2020 2020  nd",.           
-00013f00: 2063 6f6c 6f72 3d22 636f 6c6f 7222 2c0a   color="color",.
-00013f10: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-00013f20: 5f63 6f6c 6f72 3d4e 6f6e 652c 0a20 2020  _color=None,.   
-00013f30: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
-00013f40: 7068 613d 302e 362c 0a20 2020 2020 2020  pha=0.6,.       
-00013f50: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-00013f60: 2e6e 6f64 6573 5f73 6f75 7263 652c 0a20  .nodes_source,. 
-00013f70: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00013f80: 2020 7365 6c66 2e61 7272 6f77 7320 3d20    self.arrows = 
-00013f90: 4172 726f 7728 0a20 2020 2020 2020 2020  Arrow(.         
-00013fa0: 2020 2065 6e64 3d56 6565 4865 6164 2873     end=VeeHead(s
-00013fb0: 697a 653d 3829 2c0a 2020 2020 2020 2020  ize=8),.        
-00013fc0: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
-00013fd0: 626c 6163 6b22 2c0a 2020 2020 2020 2020  black",.        
-00013fe0: 2020 2020 6c69 6e65 5f61 6c70 6861 3d30      line_alpha=0
-00013ff0: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
-00014000: 6c69 6e65 5f77 6964 7468 3d31 2c0a 2020  line_width=1,.  
-00014010: 2020 2020 2020 2020 2020 785f 7374 6172            x_star
-00014020: 743d 2278 7322 2c0a 2020 2020 2020 2020  t="xs",.        
-00014030: 2020 2020 795f 7374 6172 743d 2279 7322      y_start="ys"
-00014040: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
-00014050: 656e 643d 2278 6522 2c0a 2020 2020 2020  end="xe",.      
-00014060: 2020 2020 2020 795f 656e 643d 2279 6522        y_end="ye"
-00014070: 2c0a 2020 2020 2020 2020 2020 2020 736f  ,.            so
-00014080: 7572 6365 3d73 656c 662e 6172 726f 7773  urce=self.arrows
-00014090: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
-000140a0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-000140b0: 726f 6f74 2e61 6464 5f6c 6179 6f75 7428  root.add_layout(
-000140c0: 7365 6c66 2e61 7272 6f77 7329 0a0a 2020  self.arrows)..  
-000140d0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-000140e0: 7867 7269 642e 6772 6964 5f6c 696e 655f  xgrid.grid_line_
-000140f0: 636f 6c6f 7220 3d20 4e6f 6e65 0a20 2020  color = None.   
-00014100: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-00014110: 6772 6964 2e67 7269 645f 6c69 6e65 5f63  grid.grid_line_c
-00014120: 6f6c 6f72 203d 204e 6f6e 650a 2020 2020  olor = None.    
-00014130: 2020 2020 7365 6c66 2e72 6f6f 742e 785f      self.root.x_
-00014140: 7261 6e67 652e 7261 6e67 655f 7061 6464  range.range_padd
-00014150: 696e 6720 3d20 302e 350a 2020 2020 2020  ing = 0.5.      
-00014160: 2020 7365 6c66 2e72 6f6f 742e 795f 7261    self.root.y_ra
-00014170: 6e67 652e 7261 6e67 655f 7061 6464 696e  nge.range_paddin
-00014180: 6720 3d20 302e 350a 0a20 2020 2020 2020  g = 0.5..       
-00014190: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
-000141a0: 6f6c 280a 2020 2020 2020 2020 2020 2020  ol(.            
-000141b0: 706f 696e 745f 706f 6c69 6379 3d22 666f  point_policy="fo
-000141c0: 6c6c 6f77 5f6d 6f75 7365 222c 0a20 2020  llow_mouse",.   
-000141d0: 2020 2020 2020 2020 2074 6f6f 6c74 6970           tooltip
-000141e0: 733d 2222 220a 2020 2020 2020 2020 2020  s=""".          
-000141f0: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
-00014200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014210: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-00014220: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
-00014230: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
-00014240: 223e 4e61 6d65 3a3c 2f73 7061 6e3e 266e  ">Name:</span>&n
-00014250: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
-00014260: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-00014270: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-00014280: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
-00014290: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
-000142a0: 7370 6163 653b 223e 406e 616d 653c 2f73  space;">@name</s
-000142b0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
-000142c0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-000142d0: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-000142e0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000142f0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-00014300: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
-00014310: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
-00014320: 2062 6f6c 643b 223e 436f 6d70 7574 6520   bold;">Compute 
-00014330: 7469 6d65 3a3c 2f73 7061 6e3e 266e 6273  time:</span>&nbs
-00014340: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
-00014350: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-00014360: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00014370: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
-00014380: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
-00014390: 6163 653b 223e 4063 6f6d 7075 7465 5f74  ace;">@compute_t
-000143a0: 696d 653c 2f73 7061 6e3e 0a20 2020 2020  ime</span>.     
-000143b0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
-000143c0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000143d0: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
-000143e0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-000143f0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-00014400: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
-00014410: 6569 6768 743a 2062 6f6c 643b 223e 4d65  eight: bold;">Me
-00014420: 6d6f 7279 3a3c 2f73 7061 6e3e 266e 6273  mory:</span>&nbs
-00014430: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
-00014440: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-00014450: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00014460: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
-00014470: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
-00014480: 6163 653b 223e 406d 656d 6f72 793c 2f73  ace;">@memory</s
-00014490: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
-000144a0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-000144b0: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-000144c0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000144d0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-000144e0: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
-000144f0: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
-00014500: 2062 6f6c 643b 223e 5461 736b 733a 3c2f   bold;">Tasks:</
-00014510: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
-00014520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014530: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-00014540: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
-00014550: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
-00014560: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
-00014570: 746f 745f 7461 736b 733c 2f73 7061 6e3e  tot_tasks</span>
-00014580: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014590: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
-000145a0: 2020 2020 2020 2020 3c64 6976 2073 7479          <div sty
-000145b0: 6c65 3d22 6d61 7267 696e 2d6c 6566 743a  le="margin-left:
-000145c0: 2032 656d 3b22 3e0a 2020 2020 2020 2020   2em;">.        
-000145d0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-000145e0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-000145f0: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
-00014600: 6569 6768 743a 2062 6f6c 643b 223e 436f  eight: bold;">Co
-00014610: 6d70 6c65 7465 643a 3c2f 7370 616e 3e26  mpleted:</span>&
-00014620: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
-00014630: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-00014640: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-00014650: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
-00014660: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
-00014670: 6f73 7061 6365 3b22 3e40 636f 6d70 5f74  ospace;">@comp_t
-00014680: 6173 6b73 3c2f 7370 616e 3e0a 2020 2020  asks</span>.    
-00014690: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
-000146a0: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-000146b0: 2020 203c 6469 7620 7374 796c 653d 226d     <div style="m
-000146c0: 6172 6769 6e2d 6c65 6674 3a20 3265 6d3b  argin-left: 2em;
-000146d0: 223e 0a20 2020 2020 2020 2020 2020 2020  ">.             
-000146e0: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-000146f0: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00014700: 3270 783b 2066 6f6e 742d 7765 6967 6874  2px; font-weight
-00014710: 3a20 626f 6c64 3b22 3e50 726f 6365 7373  : bold;">Process
-00014720: 696e 673a 3c2f 7370 616e 3e26 6e62 7370  ing:</span>&nbsp
-00014730: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
-00014740: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-00014750: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
-00014760: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
-00014770: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
-00014780: 6365 3b22 3e40 696e 5f70 726f 6365 7373  ce;">@in_process
-00014790: 696e 673c 2f73 7061 6e3e 0a20 2020 2020  ing</span>.     
-000147a0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
-000147b0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000147c0: 2020 3c64 6976 2073 7479 6c65 3d22 6d61    <div style="ma
-000147d0: 7267 696e 2d6c 6566 743a 2032 656d 3b22  rgin-left: 2em;"
-000147e0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-000147f0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
-00014800: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
-00014810: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
-00014820: 2062 6f6c 643b 223e 496e 206d 656d 6f72   bold;">In memor
-00014830: 793a 3c2f 7370 616e 3e26 6e62 7370 3b0a  y:</span>&nbsp;.
-00014840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014850: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
-00014860: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
-00014870: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
-00014880: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
-00014890: 3b22 3e40 696e 5f6d 656d 6f72 793c 2f73  ;">@in_memory</s
-000148a0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
-000148b0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-000148c0: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
-000148d0: 2073 7479 6c65 3d22 6d61 7267 696e 2d6c   style="margin-l
-000148e0: 6566 743a 2032 656d 3b22 3e0a 2020 2020  eft: 2em;">.    
-000148f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014900: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-00014910: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
-00014920: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
-00014930: 223e 4572 7265 643a 3c2f 7370 616e 3e26  ">Erred:</span>&
-00014940: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
-00014950: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-00014960: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-00014970: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
-00014980: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
-00014990: 6f73 7061 6365 3b22 3e40 696e 5f65 7272  ospace;">@in_err
-000149a0: 6564 3c2f 7370 616e 3e0a 2020 2020 2020  ed</span>.      
-000149b0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-000149c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000149d0: 203c 6469 7620 7374 796c 653d 226d 6172   <div style="mar
-000149e0: 6769 6e2d 6c65 6674 3a20 3265 6d3b 223e  gin-left: 2em;">
-000149f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014a00: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
-00014a10: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
-00014a20: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
-00014a30: 626f 6c64 3b22 3e52 656c 6561 7365 643a  bold;">Released:
-00014a40: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
-00014a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014a60: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
-00014a70: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
-00014a80: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
-00014a90: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
-00014aa0: 3e40 696e 5f72 656c 6561 7365 643c 2f73  >@in_released</s
-00014ab0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
-00014ac0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
-00014ad0: 2020 2020 2020 2020 2020 2020 2222 222c              """,
-00014ae0: 0a20 2020 2020 2020 2020 2020 2072 656e  .            ren
-00014af0: 6465 7265 7273 3d5b 7265 6374 5d2c 0a20  derers=[rect],. 
-00014b00: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00014b10: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
-00014b20: 746f 6f6c 7328 686f 7665 7229 0a0a 2020  tools(hover)..  
-00014b30: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
-00014b40: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
-00014b50: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
-00014b60: 2020 2064 6566 2075 7064 6174 655f 6c61     def update_la
-00014b70: 796f 7574 2873 656c 6629 3a0a 2020 2020  yout(self):.    
-00014b80: 2020 2020 2320 4765 7420 6465 7065 6e64      # Get depend
-00014b90: 656e 6369 6573 2070 6572 2074 6173 6b20  encies per task 
-00014ba0: 6772 6f75 702e 0a20 2020 2020 2020 2023  group..        #
-00014bb0: 2049 6e20 736f 6d65 2063 6173 6573 2074   In some cases t
-00014bc0: 6865 7265 2061 7265 2074 6720 7468 6174  here are tg that
-00014bd0: 2068 6176 6520 7468 656d 7365 6c76 6573   have themselves
-00014be0: 2061 7320 6465 7065 6e64 656e 6369 6573   as dependencies
-00014bf0: 202d 2077 6520 7265 6d6f 7665 2074 686f   - we remove tho
-00014c00: 7365 2e0a 2020 2020 2020 2020 6465 7065  se..        depe
-00014c10: 6e64 656e 6369 6573 203d 207b 0a20 2020  ndencies = {.   
-00014c20: 2020 2020 2020 2020 206b 3a20 7b64 732e           k: {ds.
-00014c30: 6e61 6d65 2066 6f72 2064 7320 696e 2074  name for ds in t
-00014c40: 732e 6465 7065 6e64 656e 6369 6573 2069  s.dependencies i
-00014c50: 6620 6473 2e6e 616d 6520 213d 206b 7d0a  f ds.name != k}.
-00014c60: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00014c70: 6b2c 2074 7320 696e 2073 656c 662e 7363  k, ts in self.sc
-00014c80: 6865 6475 6c65 722e 7461 736b 5f67 726f  heduler.task_gro
-00014c90: 7570 732e 6974 656d 7328 290a 2020 2020  ups.items().    
-00014ca0: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
-00014cb0: 6d70 6f72 7420 6461 736b 0a0a 2020 2020  mport dask..    
-00014cc0: 2020 2020 6f72 6465 7220 3d20 6461 736b      order = dask
-00014cd0: 2e6f 7264 6572 2e6f 7264 6572 280a 2020  .order.order(.  
-00014ce0: 2020 2020 2020 2020 2020 6473 6b3d 7b67            dsk={g
-00014cf0: 726f 7570 2e6e 616d 653a 2031 2066 6f72  roup.name: 1 for
-00014d00: 206b 2c20 6772 6f75 7020 696e 2073 656c   k, group in sel
-00014d10: 662e 7363 6865 6475 6c65 722e 7461 736b  f.scheduler.task
-00014d20: 5f67 726f 7570 732e 6974 656d 7328 297d  _groups.items()}
-00014d30: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
-00014d40: 7065 6e64 656e 6369 6573 3d64 6570 656e  pendencies=depen
-00014d50: 6465 6e63 6965 732c 0a20 2020 2020 2020  dencies,.       
-00014d60: 2029 0a0a 2020 2020 2020 2020 6f72 6465   )..        orde
-00014d70: 7265 6420 3d20 736f 7274 6564 2873 656c  red = sorted(sel
-00014d80: 662e 7363 6865 6475 6c65 722e 7461 736b  f.scheduler.task
-00014d90: 5f67 726f 7570 732c 206b 6579 3d6f 7264  _groups, key=ord
-00014da0: 6572 2e67 6574 290a 0a20 2020 2020 2020  er.get)..       
-00014db0: 2078 7320 3d20 7b7d 0a20 2020 2020 2020   xs = {}.       
-00014dc0: 2079 7320 3d20 7b7d 0a20 2020 2020 2020   ys = {}.       
-00014dd0: 206c 6f63 6174 696f 6e73 203d 2073 6574   locations = set
-00014de0: 2829 0a20 2020 2020 2020 206e 6f64 6573  ().        nodes
-00014df0: 5f6c 6179 6f75 7420 3d20 7b7d 0a20 2020  _layout = {}.   
-00014e00: 2020 2020 2061 7272 6f77 735f 6c61 796f       arrows_layo
-00014e10: 7574 203d 207b 7d0a 2020 2020 2020 2020  ut = {}.        
-00014e20: 666f 7220 7467 2069 6e20 6f72 6465 7265  for tg in ordere
-00014e30: 643a 0a20 2020 2020 2020 2020 2020 2069  d:.            i
-00014e40: 6620 6465 7065 6e64 656e 6369 6573 5b74  f dependencies[t
-00014e50: 675d 3a0a 2020 2020 2020 2020 2020 2020  g]:.            
-00014e60: 2020 2020 7820 3d20 6d61 7828 7873 5b64      x = max(xs[d
-00014e70: 6570 5d20 666f 7220 6465 7020 696e 2064  ep] for dep in d
-00014e80: 6570 656e 6465 6e63 6965 735b 7467 5d29  ependencies[tg])
-00014e90: 202b 2031 0a20 2020 2020 2020 2020 2020   + 1.           
-00014ea0: 2020 2020 2079 203d 206d 6178 2879 735b       y = max(ys[
-00014eb0: 6465 705d 2066 6f72 2064 6570 2069 6e20  dep] for dep in 
-00014ec0: 6465 7065 6e64 656e 6369 6573 5b74 675d  dependencies[tg]
-00014ed0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00014ee0: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
-00014ef0: 2020 2020 2020 2020 2020 206c 656e 2864             len(d
-00014f00: 6570 656e 6465 6e63 6965 735b 7467 5d29  ependencies[tg])
-00014f10: 203e 2031 0a20 2020 2020 2020 2020 2020   > 1.           
-00014f20: 2020 2020 2020 2020 2061 6e64 206c 656e           and len
-00014f30: 287b 7973 5b64 6570 5d20 666f 7220 6465  ({ys[dep] for de
-00014f40: 7020 696e 2064 6570 656e 6465 6e63 6965  p in dependencie
-00014f50: 735b 7467 5d7d 2920 3d3d 2031 0a20 2020  s[tg]}) == 1.   
-00014f60: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
-00014f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f80: 2020 2020 7920 2b3d 2031 0a20 2020 2020      y += 1.     
-00014f90: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00014fa0: 2020 2020 2020 2020 2020 2020 2078 203d               x =
-00014fb0: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-00014fc0: 2020 2079 203d 206d 6178 2879 732e 7661     y = max(ys.va
-00014fd0: 6c75 6573 2829 2920 2b20 3120 6966 2079  lues()) + 1 if y
-00014fe0: 7320 656c 7365 2030 0a0a 2020 2020 2020  s else 0..      
-00014ff0: 2020 2020 2020 7768 696c 6520 2878 2c20        while (x, 
-00015000: 7929 2069 6e20 6c6f 6361 7469 6f6e 733a  y) in locations:
-00015010: 2020 2320 6176 6f69 6420 636f 6c6c 6973    # avoid collis
-00015020: 696f 6e73 2062 7920 6d6f 7669 6e67 2075  ions by moving u
-00015030: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
-00015040: 2020 7920 2b3d 2031 0a0a 2020 2020 2020    y += 1..      
-00015050: 2020 2020 2020 6c6f 6361 7469 6f6e 732e        locations.
-00015060: 6164 6428 2878 2c20 7929 290a 0a20 2020  add((x, y))..   
-00015070: 2020 2020 2020 2020 2078 735b 7467 5d2c           xs[tg],
-00015080: 2079 735b 7467 5d20 3d20 782c 2079 0a0a   ys[tg] = x, y..
-00015090: 2020 2020 2020 2020 2020 2020 2320 696e              # in
-000150a0: 666f 206e 6565 6465 6420 666f 7220 6e6f  fo needed for no
-000150b0: 6465 206c 6179 6f75 7420 746f 2063 6f6c  de layout to col
-000150c0: 756d 6e20 6461 7461 2073 6f75 7263 650a  umn data source.
-000150d0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-000150e0: 735f 6c61 796f 7574 5b74 675d 203d 207b  s_layout[tg] = {
-000150f0: 2278 223a 2078 735b 7467 5d2c 2022 7922  "x": xs[tg], "y"
-00015100: 3a20 7973 5b74 675d 7d0a 0a20 2020 2020  : ys[tg]}..     
-00015110: 2020 2020 2020 2023 2069 6e66 6f20 6e65         # info ne
-00015120: 6564 6564 2066 6f72 2061 7272 6f77 206c  eded for arrow l
-00015130: 6179 6f75 740a 2020 2020 2020 2020 2020  ayout.          
-00015140: 2020 6172 726f 7773 5f6c 6179 6f75 745b    arrows_layout[
-00015150: 7467 5d20 3d20 7b0a 2020 2020 2020 2020  tg] = {.        
-00015160: 2020 2020 2020 2020 226e 7374 6172 7422          "nstart"
-00015170: 3a20 6465 7065 6e64 656e 6369 6573 5b74  : dependencies[t
-00015180: 675d 2c0a 2020 2020 2020 2020 2020 2020  g],.            
-00015190: 2020 2020 226e 656e 6422 3a20 5b74 675d      "nend": [tg]
-000151a0: 202a 206c 656e 2864 6570 656e 6465 6e63   * len(dependenc
-000151b0: 6965 735b 7467 5d29 2c0a 2020 2020 2020  ies[tg]),.      
-000151c0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-000151d0: 2072 6574 7572 6e20 6e6f 6465 735f 6c61   return nodes_la
-000151e0: 796f 7574 2c20 6172 726f 7773 5f6c 6179  yout, arrows_lay
-000151f0: 6f75 740a 0a20 2020 2064 6566 2063 6f6d  out..    def com
-00015200: 7075 7465 5f73 697a 6528 7365 6c66 2c20  pute_size(self, 
-00015210: 782c 206d 696e 5f62 6f78 2c20 6d61 785f  x, min_box, max_
-00015220: 626f 7829 3a0a 2020 2020 2020 2020 7374  box):.        st
-00015230: 6172 7420 3d20 302e 340a 2020 2020 2020  art = 0.4.      
-00015240: 2020 656e 6420 3d20 302e 380a 0a20 2020    end = 0.8..   
-00015250: 2020 2020 2079 203d 2028 656e 6420 2d20       y = (end - 
-00015260: 7374 6172 7429 202f 2028 6d61 785f 626f  start) / (max_bo
-00015270: 7820 2d20 6d69 6e5f 626f 7829 202a 2028  x - min_box) * (
-00015280: 7820 2d20 6d69 6e5f 626f 7829 202b 2073  x - min_box) + s
-00015290: 7461 7274 0a0a 2020 2020 2020 2020 7265  tart..        re
-000152a0: 7475 726e 2079 0a0a 2020 2020 4077 6974  turn y..    @wit
-000152b0: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-000152c0: 6c69 6461 7469 6f6e 0a20 2020 2064 6566  lidation.    def
-000152d0: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
-000152e0: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
-000152f0: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
-00015300: 696f 6e5f 636f 756e 7465 7220 3d3d 2073  ion_counter == s
-00015310: 656c 662e 6f6c 645f 636f 756e 7465 723a  elf.old_counter:
-00015320: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00015330: 7572 6e0a 2020 2020 2020 2020 7365 6c66  urn.        self
-00015340: 2e6f 6c64 5f63 6f75 6e74 6572 203d 2073  .old_counter = s
-00015350: 656c 662e 7363 6865 6475 6c65 722e 7472  elf.scheduler.tr
-00015360: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-00015370: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00015380: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-00015390: 7461 736b 5f67 726f 7570 733a 0a20 2020  task_groups:.   
-000153a0: 2020 2020 2020 2020 2073 656c 662e 7375           self.su
-000153b0: 6274 6974 6c65 2e74 6578 7420 3d20 2253  btitle.text = "S
-000153c0: 6368 6564 756c 6572 2069 7320 656d 7074  cheduler is empt
-000153d0: 792e 220a 2020 2020 2020 2020 656c 7365  y.".        else
-000153e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000153f0: 6c66 2e73 7562 7469 746c 652e 7465 7874  lf.subtitle.text
-00015400: 203d 2022 2022 0a0a 2020 2020 2020 2020   = " "..        
-00015410: 6966 2073 656c 662e 6e6f 6465 735f 6c61  if self.nodes_la
-00015420: 796f 7574 2e6b 6579 7328 2920 213d 2073  yout.keys() != s
-00015430: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
-00015440: 736b 5f67 726f 7570 732e 6b65 7973 2829  sk_groups.keys()
-00015450: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00015460: 6c66 2e6e 6f64 6573 5f6c 6179 6f75 742c  lf.nodes_layout,
-00015470: 2073 656c 662e 6172 726f 7773 5f6c 6179   self.arrows_lay
-00015480: 6f75 7420 3d20 7365 6c66 2e75 7064 6174  out = self.updat
-00015490: 655f 6c61 796f 7574 2829 0a0a 2020 2020  e_layout()..    
-000154a0: 2020 2020 6e6f 6465 735f 6461 7461 203d      nodes_data =
-000154b0: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
-000154c0: 7822 3a20 5b5d 2c0a 2020 2020 2020 2020  x": [],.        
-000154d0: 2020 2020 2279 223a 205b 5d2c 0a20 2020      "y": [],.   
-000154e0: 2020 2020 2020 2020 2022 775f 626f 7822           "w_box"
-000154f0: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00015500: 2020 2268 5f62 6f78 223a 205b 5d2c 0a20    "h_box": [],. 
-00015510: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
-00015520: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00015530: 2020 2022 636f 6c6f 7222 3a20 5b5d 2c0a     "color": [],.
-00015540: 2020 2020 2020 2020 2020 2020 2274 6f74              "tot
-00015550: 5f74 6173 6b73 223a 205b 5d2c 0a20 2020  _tasks": [],.   
-00015560: 2020 2020 2020 2020 2022 785f 7374 6172           "x_star
-00015570: 7422 3a20 5b5d 2c0a 2020 2020 2020 2020  t": [],.        
-00015580: 2020 2020 2278 5f65 6e64 223a 205b 5d2c      "x_end": [],
-00015590: 0a20 2020 2020 2020 2020 2020 2022 795f  .            "y_
-000155a0: 7374 6172 7422 3a20 5b5d 2c0a 2020 2020  start": [],.    
-000155b0: 2020 2020 2020 2020 2279 5f65 6e64 223a          "y_end":
-000155c0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-000155d0: 2022 785f 656e 645f 7072 6f67 7265 7373   "x_end_progress
-000155e0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-000155f0: 2020 2022 6d65 6d5f 616c 7068 6122 3a20     "mem_alpha": 
-00015600: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
-00015610: 226e 6f64 655f 6c69 6e65 5f77 6964 7468  "node_line_width
-00015620: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00015630: 2020 2022 636f 6d70 5f74 6173 6b73 223a     "comp_tasks":
-00015640: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00015650: 2022 7572 6c5f 6c6f 676f 223a 205b 5d2c   "url_logo": [],
-00015660: 0a20 2020 2020 2020 2020 2020 2022 785f  .            "x_
-00015670: 6c6f 676f 223a 205b 5d2c 0a20 2020 2020  logo": [],.     
-00015680: 2020 2020 2020 2022 795f 6c6f 676f 223a         "y_logo":
-00015690: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-000156a0: 2022 775f 6c6f 676f 223a 205b 5d2c 0a20   "w_logo": [],. 
-000156b0: 2020 2020 2020 2020 2020 2022 685f 6c6f             "h_lo
-000156c0: 676f 223a 205b 5d2c 0a20 2020 2020 2020  go": [],.       
-000156d0: 2020 2020 2022 696e 5f70 726f 6365 7373       "in_process
-000156e0: 696e 6722 3a20 5b5d 2c0a 2020 2020 2020  ing": [],.      
-000156f0: 2020 2020 2020 2269 6e5f 6d65 6d6f 7279        "in_memory
-00015700: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00015710: 2020 2022 696e 5f72 656c 6561 7365 6422     "in_released"
-00015720: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00015730: 2020 2269 6e5f 6572 7265 6422 3a20 5b5d    "in_erred": []
-00015740: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
-00015750: 6f6d 7075 7465 5f74 696d 6522 3a20 5b5d  ompute_time": []
-00015760: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
-00015770: 656d 6f72 7922 3a20 5b5d 2c0a 2020 2020  emory": [],.    
-00015780: 2020 2020 7d0a 0a20 2020 2020 2020 2061      }..        a
-00015790: 7272 6f77 735f 6461 7461 203d 207b 0a20  rrows_data = {. 
-000157a0: 2020 2020 2020 2020 2020 2022 7873 223a             "xs":
-000157b0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-000157c0: 2022 7973 223a 205b 5d2c 0a20 2020 2020   "ys": [],.     
-000157d0: 2020 2020 2020 2022 7865 223a 205b 5d2c         "xe": [],
-000157e0: 0a20 2020 2020 2020 2020 2020 2022 7965  .            "ye
-000157f0: 223a 205b 5d2c 0a20 2020 2020 2020 207d  ": [],.        }
-00015800: 0a0a 2020 2020 2020 2020 6475 7261 7469  ..        durati
-00015810: 6f6e 7320 3d20 7365 7428 290a 2020 2020  ons = set().    
-00015820: 2020 2020 6e62 7974 6573 203d 2073 6574      nbytes = set
-00015830: 2829 0a20 2020 2020 2020 2066 6f72 2074  ().        for t
-00015840: 6720 696e 2073 656c 662e 7363 6865 6475  g in self.schedu
-00015850: 6c65 722e 7461 736b 5f67 726f 7570 732e  ler.task_groups.
-00015860: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
-00015870: 2020 2020 2020 6966 2074 672e 6475 7261        if tg.dura
-00015880: 7469 6f6e 2061 6e64 2074 672e 6e62 7974  tion and tg.nbyt
-00015890: 6573 5f74 6f74 616c 3a0a 2020 2020 2020  es_total:.      
-000158a0: 2020 2020 2020 2020 2020 6475 7261 7469            durati
-000158b0: 6f6e 732e 6164 6428 7467 2e64 7572 6174  ons.add(tg.durat
-000158c0: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
-000158d0: 2020 2020 206e 6279 7465 732e 6164 6428       nbytes.add(
-000158e0: 7467 2e6e 6279 7465 735f 746f 7461 6c29  tg.nbytes_total)
-000158f0: 0a0a 2020 2020 2020 2020 6475 7261 7469  ..        durati
-00015900: 6f6e 735f 6d69 6e20 3d20 6d69 6e28 6475  ons_min = min(du
-00015910: 7261 7469 6f6e 732c 2064 6566 6175 6c74  rations, default
-00015920: 3d30 290a 2020 2020 2020 2020 6475 7261  =0).        dura
-00015930: 7469 6f6e 735f 6d61 7820 3d20 6d61 7828  tions_max = max(
-00015940: 6475 7261 7469 6f6e 732c 2064 6566 6175  durations, defau
-00015950: 6c74 3d30 290a 2020 2020 2020 2020 6e62  lt=0).        nb
-00015960: 7974 6573 5f6d 696e 203d 206d 696e 286e  ytes_min = min(n
-00015970: 6279 7465 732c 2064 6566 6175 6c74 3d30  bytes, default=0
-00015980: 290a 2020 2020 2020 2020 6e62 7974 6573  ).        nbytes
-00015990: 5f6d 6178 203d 206d 6178 286e 6279 7465  _max = max(nbyte
-000159a0: 732c 2064 6566 6175 6c74 3d30 290a 0a20  s, default=0).. 
-000159b0: 2020 2020 2020 2062 6f78 5f64 696d 203d         box_dim =
-000159c0: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
-000159d0: 6b65 792c 2074 6720 696e 2073 656c 662e  key, tg in self.
-000159e0: 7363 6865 6475 6c65 722e 7461 736b 5f67  scheduler.task_g
-000159f0: 726f 7570 732e 6974 656d 7328 293a 0a20  roups.items():. 
-00015a00: 2020 2020 2020 2020 2020 2063 6f6d 705f             comp_
-00015a10: 7461 736b 7320 3d20 280a 2020 2020 2020  tasks = (.      
-00015a20: 2020 2020 2020 2020 2020 7467 2e73 7461            tg.sta
-00015a30: 7465 735b 2272 656c 6561 7365 6422 5d20  tes["released"] 
-00015a40: 2b20 7467 2e73 7461 7465 735b 226d 656d  + tg.states["mem
-00015a50: 6f72 7922 5d20 2b20 7467 2e73 7461 7465  ory"] + tg.state
-00015a60: 735b 2265 7272 6564 225d 0a20 2020 2020  s["erred"].     
-00015a70: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00015a80: 2020 2020 2074 6f74 5f74 6173 6b73 203d       tot_tasks =
-00015a90: 2073 756d 2874 672e 7374 6174 6573 2e76   sum(tg.states.v
-00015aa0: 616c 7565 7328 2929 0a0a 2020 2020 2020  alues())..      
-00015ab0: 2020 2020 2020 2320 636f 6d70 7574 6520        # compute 
-00015ac0: 7769 6474 6820 616e 6420 6865 6967 6874  width and height
-00015ad0: 206f 6620 626f 7865 730a 2020 2020 2020   of boxes.      
-00015ae0: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-00015af0: 2020 2020 2020 2020 2020 2074 672e 6475             tg.du
-00015b00: 7261 7469 6f6e 0a20 2020 2020 2020 2020  ration.         
-00015b10: 2020 2020 2020 2061 6e64 2074 672e 6e62         and tg.nb
-00015b20: 7974 6573 5f74 6f74 616c 0a20 2020 2020  ytes_total.     
-00015b30: 2020 2020 2020 2020 2020 2061 6e64 2063             and c
-00015b40: 6f6d 705f 7461 736b 730a 2020 2020 2020  omp_tasks.      
-00015b50: 2020 2020 2020 2020 2020 616e 6420 6c65            and le
-00015b60: 6e28 6475 7261 7469 6f6e 7329 203e 2031  n(durations) > 1
-00015b70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015b80: 2061 6e64 206c 656e 286e 6279 7465 7329   and len(nbytes)
-00015b90: 203e 2031 0a20 2020 2020 2020 2020 2020   > 1.           
-00015ba0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00015bb0: 2020 2020 2320 7363 616c 6520 6475 7261      # scale dura
-00015bc0: 7469 6f6e 2028 7769 6474 6829 0a20 2020  tion (width).   
-00015bd0: 2020 2020 2020 2020 2020 2020 2077 6964               wid
-00015be0: 7468 5f62 6f78 203d 2073 656c 662e 636f  th_box = self.co
-00015bf0: 6d70 7574 655f 7369 7a65 280a 2020 2020  mpute_size(.    
-00015c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015c10: 7467 2e64 7572 6174 696f 6e20 2f20 636f  tg.duration / co
-00015c20: 6d70 5f74 6173 6b73 202a 2074 6f74 5f74  mp_tasks * tot_t
-00015c30: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
-00015c40: 2020 2020 2020 2020 2020 6d69 6e5f 626f            min_bo
-00015c50: 783d 6475 7261 7469 6f6e 735f 6d69 6e20  x=durations_min 
-00015c60: 2f20 636f 6d70 5f74 6173 6b73 202a 2074  / comp_tasks * t
-00015c70: 6f74 5f74 6173 6b73 2c0a 2020 2020 2020  ot_tasks,.      
-00015c80: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00015c90: 785f 626f 783d 6475 7261 7469 6f6e 735f  x_box=durations_
-00015ca0: 6d61 7820 2f20 636f 6d70 5f74 6173 6b73  max / comp_tasks
-00015cb0: 202a 2074 6f74 5f74 6173 6b73 2c0a 2020   * tot_tasks,.  
-00015cc0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00015cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015ce0: 2023 206e 6565 6420 746f 2073 6361 6c65   # need to scale
-00015cf0: 206d 656d 6f72 7920 2868 6569 6768 7429   memory (height)
-00015d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015d10: 2068 6569 6768 745f 626f 7820 3d20 7365   height_box = se
-00015d20: 6c66 2e63 6f6d 7075 7465 5f73 697a 6528  lf.compute_size(
-00015d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015d40: 2020 2020 2074 672e 6e62 7974 6573 5f74       tg.nbytes_t
-00015d50: 6f74 616c 202f 2063 6f6d 705f 7461 736b  otal / comp_task
-00015d60: 7320 2a20 746f 745f 7461 736b 732c 0a20  s * tot_tasks,. 
-00015d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015d80: 2020 206d 696e 5f62 6f78 3d6e 6279 7465     min_box=nbyte
-00015d90: 735f 6d69 6e20 2f20 636f 6d70 5f74 6173  s_min / comp_tas
-00015da0: 6b73 202a 2074 6f74 5f74 6173 6b73 2c0a  ks * tot_tasks,.
-00015db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015dc0: 2020 2020 6d61 785f 626f 783d 6e62 7974      max_box=nbyt
-00015dd0: 6573 5f6d 6178 202f 2063 6f6d 705f 7461  es_max / comp_ta
-00015de0: 736b 7320 2a20 746f 745f 7461 736b 732c  sks * tot_tasks,
-00015df0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015e00: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00015e10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00015e20: 2020 2020 2020 7769 6474 685f 626f 7820        width_box 
-00015e30: 3d20 302e 360a 2020 2020 2020 2020 2020  = 0.6.          
-00015e40: 2020 2020 2020 6865 6967 6874 5f62 6f78        height_box
-00015e50: 203d 2077 6964 7468 5f62 6f78 202f 2032   = width_box / 2
-00015e60: 0a0a 2020 2020 2020 2020 2020 2020 626f  ..            bo
-00015e70: 785f 6469 6d5b 6b65 795d 203d 207b 2277  x_dim[key] = {"w
-00015e80: 6964 7468 223a 2077 6964 7468 5f62 6f78  idth": width_box
-00015e90: 2c20 2268 6569 6768 7422 3a20 6865 6967  , "height": heig
-00015ea0: 6874 5f62 6f78 7d0a 0a20 2020 2020 2020  ht_box}..       
-00015eb0: 2066 6f72 206b 6579 2c20 7467 2069 6e20   for key, tg in 
-00015ec0: 7365 6c66 2e73 6368 6564 756c 6572 2e74  self.scheduler.t
-00015ed0: 6173 6b5f 6772 6f75 7073 2e69 7465 6d73  ask_groups.items
-00015ee0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00015ef0: 7820 3d20 7365 6c66 2e6e 6f64 6573 5f6c  x = self.nodes_l
-00015f00: 6179 6f75 745b 6b65 795d 5b22 7822 5d0a  ayout[key]["x"].
-00015f10: 2020 2020 2020 2020 2020 2020 7920 3d20              y = 
-00015f20: 7365 6c66 2e6e 6f64 6573 5f6c 6179 6f75  self.nodes_layou
-00015f30: 745b 6b65 795d 5b22 7922 5d0a 2020 2020  t[key]["y"].    
-00015f40: 2020 2020 2020 2020 7769 6474 6820 3d20          width = 
-00015f50: 626f 785f 6469 6d5b 6b65 795d 5b22 7769  box_dim[key]["wi
-00015f60: 6474 6822 5d0a 2020 2020 2020 2020 2020  dth"].          
-00015f70: 2020 6865 6967 6874 203d 2062 6f78 5f64    height = box_d
-00015f80: 696d 5b6b 6579 5d5b 2268 6569 6768 7422  im[key]["height"
-00015f90: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
-00015fa0: 206d 6169 6e20 626f 7865 7320 6c61 796f   main boxes layo
-00015fb0: 7574 0a20 2020 2020 2020 2020 2020 206e  ut.            n
-00015fc0: 6f64 6573 5f64 6174 615b 2278 225d 2e61  odes_data["x"].a
-00015fd0: 7070 656e 6428 7829 0a20 2020 2020 2020  ppend(x).       
-00015fe0: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
-00015ff0: 2279 225d 2e61 7070 656e 6428 7929 0a20  "y"].append(y). 
-00016000: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
-00016010: 5f64 6174 615b 2277 5f62 6f78 225d 2e61  _data["w_box"].a
-00016020: 7070 656e 6428 7769 6474 6829 0a20 2020  ppend(width).   
-00016030: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-00016040: 6174 615b 2268 5f62 6f78 225d 2e61 7070  ata["h_box"].app
-00016050: 656e 6428 6865 6967 6874 290a 0a20 2020  end(height)..   
-00016060: 2020 2020 2020 2020 2063 6f6d 705f 7461           comp_ta
-00016070: 736b 7320 3d20 280a 2020 2020 2020 2020  sks = (.        
-00016080: 2020 2020 2020 2020 7467 2e73 7461 7465          tg.state
-00016090: 735b 2272 656c 6561 7365 6422 5d20 2b20  s["released"] + 
-000160a0: 7467 2e73 7461 7465 735b 226d 656d 6f72  tg.states["memor
-000160b0: 7922 5d20 2b20 7467 2e73 7461 7465 735b  y"] + tg.states[
-000160c0: 2265 7272 6564 225d 0a20 2020 2020 2020  "erred"].       
-000160d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000160e0: 2020 2074 6f74 5f74 6173 6b73 203d 2073     tot_tasks = s
-000160f0: 756d 2874 672e 7374 6174 6573 2e76 616c  um(tg.states.val
-00016100: 7565 7328 2929 0a0a 2020 2020 2020 2020  ues())..        
-00016110: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
-00016120: 6e61 6d65 225d 2e61 7070 656e 6428 7467  name"].append(tg
-00016130: 2e70 7265 6669 782e 6e61 6d65 290a 0a20  .prefix.name).. 
-00016140: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
-00016150: 5f64 6174 615b 2263 6f6c 6f72 225d 2e61  _data["color"].a
-00016160: 7070 656e 6428 636f 6c6f 725f 6f66 2874  ppend(color_of(t
-00016170: 672e 7072 6566 6978 2e6e 616d 6529 290a  g.prefix.name)).
-00016180: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00016190: 735f 6461 7461 5b22 746f 745f 7461 736b  s_data["tot_task
-000161a0: 7322 5d2e 6170 7065 6e64 2874 6f74 5f74  s"].append(tot_t
-000161b0: 6173 6b73 290a 0a20 2020 2020 2020 2020  asks)..         
-000161c0: 2020 2023 206d 656d 6f72 7920 616c 7068     # memory alph
-000161d0: 6120 6661 6374 6f72 2062 7920 302e 3420  a factor by 0.4 
-000161e0: 6966 206e 6f74 2067 6574 2773 2074 6f6f  if not get's too
-000161f0: 2064 6172 6b0a 2020 2020 2020 2020 2020   dark.          
-00016200: 2020 6e6f 6465 735f 6461 7461 5b22 6d65    nodes_data["me
-00016210: 6d5f 616c 7068 6122 5d2e 6170 7065 6e64  m_alpha"].append
-00016220: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00016230: 2020 2874 672e 7374 6174 6573 5b22 6d65    (tg.states["me
-00016240: 6d6f 7279 225d 202f 2073 756d 2874 672e  mory"] / sum(tg.
-00016250: 7374 6174 6573 2e76 616c 7565 7328 2929  states.values())
-00016260: 2920 2a20 302e 340a 2020 2020 2020 2020  ) * 0.4.        
-00016270: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00016280: 2020 2023 206d 6169 6e20 626f 7820 6c69     # main box li
-00016290: 6e65 2077 6964 7468 0a20 2020 2020 2020  ne width.       
-000162a0: 2020 2020 2069 6620 7467 2e73 7461 7465       if tg.state
-000162b0: 735b 2270 726f 6365 7373 696e 6722 5d3a  s["processing"]:
-000162c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000162d0: 206e 6f64 6573 5f64 6174 615b 226e 6f64   nodes_data["nod
-000162e0: 655f 6c69 6e65 5f77 6964 7468 225d 2e61  e_line_width"].a
-000162f0: 7070 656e 6428 3529 0a20 2020 2020 2020  ppend(5).       
-00016300: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00016310: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
-00016320: 5f64 6174 615b 226e 6f64 655f 6c69 6e65  _data["node_line
-00016330: 5f77 6964 7468 225d 2e61 7070 656e 6428  _width"].append(
-00016340: 3129 0a0a 2020 2020 2020 2020 2020 2020  1)..            
-00016350: 2320 7072 6f67 7265 7373 2062 6172 2064  # progress bar d
-00016360: 6174 6120 7570 6461 7465 0a20 2020 2020  ata update.     
-00016370: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
-00016380: 615b 2278 5f73 7461 7274 225d 2e61 7070  a["x_start"].app
-00016390: 656e 6428 7820 2d20 7769 6474 6820 2f20  end(x - width / 
-000163a0: 3229 0a20 2020 2020 2020 2020 2020 206e  2).            n
-000163b0: 6f64 6573 5f64 6174 615b 2278 5f65 6e64  odes_data["x_end
-000163c0: 225d 2e61 7070 656e 6428 7820 2b20 7769  "].append(x + wi
-000163d0: 6474 6820 2f20 3229 0a0a 2020 2020 2020  dth / 2)..      
-000163e0: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
-000163f0: 5b22 795f 7374 6172 7422 5d2e 6170 7065  ["y_start"].appe
-00016400: 6e64 2879 202d 2068 6569 6768 7420 2f20  nd(y - height / 
-00016410: 3229 0a20 2020 2020 2020 2020 2020 206e  2).            n
-00016420: 6f64 6573 5f64 6174 615b 2279 5f65 6e64  odes_data["y_end
-00016430: 225d 2e61 7070 656e 6428 7920 2d20 6865  "].append(y - he
-00016440: 6967 6874 202f 2032 202b 2068 6569 6768  ight / 2 + heigh
-00016450: 7420 2a20 302e 3429 0a0a 2020 2020 2020  t * 0.4)..      
-00016460: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
-00016470: 5b22 785f 656e 645f 7072 6f67 7265 7373  ["x_end_progress
-00016480: 225d 2e61 7070 656e 6428 0a20 2020 2020  "].append(.     
-00016490: 2020 2020 2020 2020 2020 2078 202d 2077             x - w
-000164a0: 6964 7468 202f 2032 202b 2077 6964 7468  idth / 2 + width
-000164b0: 202a 2063 6f6d 705f 7461 736b 7320 2f20   * comp_tasks / 
-000164c0: 746f 745f 7461 736b 730a 2020 2020 2020  tot_tasks.      
-000164d0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000164e0: 2020 2020 2023 2061 7272 6f77 730a 2020       # arrows.  
-000164f0: 2020 2020 2020 2020 2020 6172 726f 7773            arrows
-00016500: 5f64 6174 615b 2278 7322 5d20 2b3d 205b  _data["xs"] += [
-00016510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016520: 2073 656c 662e 6e6f 6465 735f 6c61 796f   self.nodes_layo
-00016530: 7574 5b6b 5d5b 2278 225d 202b 2062 6f78  ut[k]["x"] + box
-00016540: 5f64 696d 5b6b 5d5b 2277 6964 7468 225d  _dim[k]["width"]
-00016550: 202f 2032 0a20 2020 2020 2020 2020 2020   / 2.           
-00016560: 2020 2020 2066 6f72 206b 2069 6e20 7365       for k in se
-00016570: 6c66 2e61 7272 6f77 735f 6c61 796f 7574  lf.arrows_layout
-00016580: 5b6b 6579 5d5b 226e 7374 6172 7422 5d0a  [key]["nstart"].
-00016590: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-000165a0: 2020 2020 2020 2020 2020 6172 726f 7773            arrows
-000165b0: 5f64 6174 615b 2279 7322 5d20 2b3d 205b  _data["ys"] += [
-000165c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000165d0: 2073 656c 662e 6e6f 6465 735f 6c61 796f   self.nodes_layo
-000165e0: 7574 5b6b 5d5b 2279 225d 2066 6f72 206b  ut[k]["y"] for k
-000165f0: 2069 6e20 7365 6c66 2e61 7272 6f77 735f   in self.arrows_
-00016600: 6c61 796f 7574 5b6b 6579 5d5b 226e 7374  layout[key]["nst
-00016610: 6172 7422 5d0a 2020 2020 2020 2020 2020  art"].          
-00016620: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
-00016630: 6172 726f 7773 5f64 6174 615b 2278 6522  arrows_data["xe"
-00016640: 5d20 2b3d 205b 0a20 2020 2020 2020 2020  ] += [.         
-00016650: 2020 2020 2020 2073 656c 662e 6e6f 6465         self.node
-00016660: 735f 6c61 796f 7574 5b6b 5d5b 2278 225d  s_layout[k]["x"]
-00016670: 202d 2062 6f78 5f64 696d 5b6b 5d5b 2277   - box_dim[k]["w
-00016680: 6964 7468 225d 202f 2032 0a20 2020 2020  idth"] / 2.     
-00016690: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-000166a0: 2069 6e20 7365 6c66 2e61 7272 6f77 735f   in self.arrows_
-000166b0: 6c61 796f 7574 5b6b 6579 5d5b 226e 656e  layout[key]["nen
-000166c0: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
-000166d0: 5d0a 2020 2020 2020 2020 2020 2020 6172  ].            ar
-000166e0: 726f 7773 5f64 6174 615b 2279 6522 5d20  rows_data["ye"] 
-000166f0: 2b3d 205b 0a20 2020 2020 2020 2020 2020  += [.           
-00016700: 2020 2020 2073 656c 662e 6e6f 6465 735f       self.nodes_
-00016710: 6c61 796f 7574 5b6b 5d5b 2279 225d 2066  layout[k]["y"] f
-00016720: 6f72 206b 2069 6e20 7365 6c66 2e61 7272  or k in self.arr
-00016730: 6f77 735f 6c61 796f 7574 5b6b 6579 5d5b  ows_layout[key][
-00016740: 226e 656e 6422 5d0a 2020 2020 2020 2020  "nend"].        
-00016750: 2020 2020 5d0a 0a20 2020 2020 2020 2020      ]..         
-00016760: 2020 2023 204c 4f47 4f53 0a20 2020 2020     # LOGOS.     
-00016770: 2020 2020 2020 2069 6620 6c65 6e28 7467         if len(tg
-00016780: 2e74 7970 6573 2920 3d3d 2031 3a0a 2020  .types) == 1:.  
-00016790: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-000167a0: 676f 5f74 7970 6520 3d20 6e65 7874 2869  go_type = next(i
-000167b0: 7465 7228 7467 2e74 7970 6573 2929 2e73  ter(tg.types)).s
-000167c0: 706c 6974 2822 2e22 295b 305d 0a20 2020  plit(".")[0].   
-000167d0: 2020 2020 2020 2020 2020 2020 2074 7279               try
-000167e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000167f0: 2020 2020 2020 7572 6c5f 6c6f 676f 203d        url_logo =
-00016800: 206c 6f67 6f73 5f64 6963 745b 6c6f 676f   logos_dict[logo
-00016810: 5f74 7970 655d 0a20 2020 2020 2020 2020  _type].         
-00016820: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
-00016830: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
-00016840: 2020 2020 2020 2020 2020 2020 7572 6c5f              url_
-00016850: 6c6f 676f 203d 2022 220a 2020 2020 2020  logo = "".      
-00016860: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00016870: 2020 2020 2020 2020 2020 2020 7572 6c5f              url_
-00016880: 6c6f 676f 203d 2022 220a 0a20 2020 2020  logo = ""..     
-00016890: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
-000168a0: 615b 2275 726c 5f6c 6f67 6f22 5d2e 6170  a["url_logo"].ap
-000168b0: 7065 6e64 2875 726c 5f6c 6f67 6f29 0a0a  pend(url_logo)..
-000168c0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-000168d0: 735f 6461 7461 5b22 785f 6c6f 676f 225d  s_data["x_logo"]
-000168e0: 2e61 7070 656e 6428 7820 2b20 7769 6474  .append(x + widt
-000168f0: 6820 2f20 3329 0a20 2020 2020 2020 2020  h / 3).         
-00016900: 2020 206e 6f64 6573 5f64 6174 615b 2279     nodes_data["y
-00016910: 5f6c 6f67 6f22 5d2e 6170 7065 6e64 2879  _logo"].append(y
-00016920: 202b 2068 6569 6768 7420 2f20 3329 0a0a   + height / 3)..
-00016930: 2020 2020 2020 2020 2020 2020 7261 7469              rati
-00016940: 6f20 3d20 7769 6474 6820 2f20 6865 6967  o = width / heig
-00016950: 6874 0a0a 2020 2020 2020 2020 2020 2020  ht..            
-00016960: 6966 2072 6174 696f 203e 2031 3a0a 2020  if ratio > 1:.  
-00016970: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
-00016980: 6465 735f 6461 7461 5b22 685f 6c6f 676f  des_data["h_logo
-00016990: 225d 2e61 7070 656e 6428 6865 6967 6874  "].append(height
-000169a0: 202a 2030 2e33 290a 2020 2020 2020 2020   * 0.3).        
-000169b0: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
-000169c0: 7461 5b22 775f 6c6f 676f 225d 2e61 7070  ta["w_logo"].app
-000169d0: 656e 6428 7769 6474 6820 2a20 302e 3320  end(width * 0.3 
-000169e0: 2f20 7261 7469 6f29 0a20 2020 2020 2020  / ratio).       
-000169f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00016a00: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
-00016a10: 5f64 6174 615b 2268 5f6c 6f67 6f22 5d2e  _data["h_logo"].
-00016a20: 6170 7065 6e64 2868 6569 6768 7420 2a20  append(height * 
-00016a30: 302e 3320 2a20 7261 7469 6f29 0a20 2020  0.3 * ratio).   
-00016a40: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00016a50: 6573 5f64 6174 615b 2277 5f6c 6f67 6f22  es_data["w_logo"
-00016a60: 5d2e 6170 7065 6e64 2877 6964 7468 202a  ].append(width *
-00016a70: 2030 2e33 290a 0a20 2020 2020 2020 2020   0.3)..         
-00016a80: 2020 2023 2063 6f6d 7075 7465 5f74 696d     # compute_tim
-00016a90: 6520 616e 6420 6d65 6d6f 7279 0a20 2020  e and memory.   
-00016aa0: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-00016ab0: 6174 615b 2263 6f6d 7075 7465 5f74 696d  ata["compute_tim
-00016ac0: 6522 5d2e 6170 7065 6e64 2866 6f72 6d61  e"].append(forma
-00016ad0: 745f 7469 6d65 2874 672e 6475 7261 7469  t_time(tg.durati
-00016ae0: 6f6e 2929 0a20 2020 2020 2020 2020 2020  on)).           
-00016af0: 206e 6f64 6573 5f64 6174 615b 226d 656d   nodes_data["mem
-00016b00: 6f72 7922 5d2e 6170 7065 6e64 2866 6f72  ory"].append(for
-00016b10: 6d61 745f 6279 7465 7328 7467 2e6e 6279  mat_bytes(tg.nby
-00016b20: 7465 735f 746f 7461 6c29 290a 0a20 2020  tes_total))..   
-00016b30: 2020 2020 2020 2020 2023 2041 6464 2073           # Add s
-00016b40: 6f6d 6520 7374 6174 7573 2074 6f20 686f  ome status to ho
-00016b50: 7665 720a 2020 2020 2020 2020 2020 2020  ver.            
-00016b60: 7461 736b 735f 7072 6f63 6573 7369 6e67  tasks_processing
-00016b70: 203d 2074 672e 7374 6174 6573 5b22 7072   = tg.states["pr
-00016b80: 6f63 6573 7369 6e67 225d 0a20 2020 2020  ocessing"].     
-00016b90: 2020 2020 2020 2074 6173 6b73 5f6d 656d         tasks_mem
-00016ba0: 6f72 7920 3d20 7467 2e73 7461 7465 735b  ory = tg.states[
-00016bb0: 226d 656d 6f72 7922 5d0a 2020 2020 2020  "memory"].      
-00016bc0: 2020 2020 2020 7461 736b 735f 7265 6c61        tasks_rela
-00016bd0: 7365 6420 3d20 7467 2e73 7461 7465 735b  sed = tg.states[
-00016be0: 2272 656c 6561 7365 6422 5d0a 2020 2020  "released"].    
-00016bf0: 2020 2020 2020 2020 7461 736b 735f 6572          tasks_er
-00016c00: 7265 6420 3d20 7467 2e73 7461 7465 735b  red = tg.states[
-00016c10: 2265 7272 6564 225d 0a0a 2020 2020 2020  "erred"]..      
-00016c20: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
-00016c30: 5b22 636f 6d70 5f74 6173 6b73 225d 2e61  ["comp_tasks"].a
-00016c40: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
-00016c50: 2020 2020 2020 2066 227b 636f 6d70 5f74         f"{comp_t
-00016c60: 6173 6b73 7d20 287b 636f 6d70 5f74 6173  asks} ({comp_tas
-00016c70: 6b73 202f 2074 6f74 5f74 6173 6b73 202a  ks / tot_tasks *
-00016c80: 2031 3030 3a2e 3066 7d20 2529 220a 2020   100:.0f} %)".  
-00016c90: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00016ca0: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
-00016cb0: 7461 5b22 696e 5f70 726f 6365 7373 696e  ta["in_processin
-00016cc0: 6722 5d2e 6170 7065 6e64 280a 2020 2020  g"].append(.    
-00016cd0: 2020 2020 2020 2020 2020 2020 6622 7b74              f"{t
-00016ce0: 6173 6b73 5f70 726f 6365 7373 696e 677d  asks_processing}
-00016cf0: 2028 7b74 6173 6b73 5f70 726f 6365 7373   ({tasks_process
-00016d00: 696e 6720 2f20 746f 745f 7461 736b 7320  ing / tot_tasks 
-00016d10: 2a20 3130 303a 2e30 667d 2025 2922 0a20  * 100:.0f} %)". 
-00016d20: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00016d30: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
-00016d40: 6174 615b 2269 6e5f 6d65 6d6f 7279 225d  ata["in_memory"]
-00016d50: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
-00016d60: 2020 2020 2020 2020 2066 227b 7461 736b           f"{task
-00016d70: 735f 6d65 6d6f 7279 7d20 287b 7461 736b  s_memory} ({task
-00016d80: 735f 6d65 6d6f 7279 202f 2074 6f74 5f74  s_memory / tot_t
-00016d90: 6173 6b73 202a 2031 3030 3a2e 3066 7d20  asks * 100:.0f} 
-00016da0: 2529 220a 2020 2020 2020 2020 2020 2020  %)".            
-00016db0: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
-00016dc0: 6465 735f 6461 7461 5b22 696e 5f72 656c  des_data["in_rel
-00016dd0: 6561 7365 6422 5d2e 6170 7065 6e64 280a  eased"].append(.
-00016de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016df0: 6622 7b74 6173 6b73 5f72 656c 6173 6564  f"{tasks_relased
-00016e00: 7d20 287b 7461 736b 735f 7265 6c61 7365  } ({tasks_relase
-00016e10: 6420 2f20 746f 745f 7461 736b 7320 2a20  d / tot_tasks * 
-00016e20: 3130 303a 2e30 667d 2025 2922 0a20 2020  100:.0f} %)".   
-00016e30: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00016e40: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
-00016e50: 615b 2269 6e5f 6572 7265 6422 5d2e 6170  a["in_erred"].ap
-00016e60: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
-00016e70: 2020 2020 2020 6622 7b74 6173 6b73 5f65        f"{tasks_e
-00016e80: 7272 6564 7d20 287b 7461 736b 735f 6572  rred} ({tasks_er
-00016e90: 7265 6420 2f20 746f 745f 7461 736b 7320  red / tot_tasks 
-00016ea0: 2a20 3130 303a 2e30 667d 2025 2922 0a20  * 100:.0f} %)". 
-00016eb0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
-00016ec0: 2020 2020 2020 7365 6c66 2e6e 6f64 6573        self.nodes
-00016ed0: 5f73 6f75 7263 652e 6461 7461 2e75 7064  _source.data.upd
-00016ee0: 6174 6528 6e6f 6465 735f 6461 7461 290a  ate(nodes_data).
-00016ef0: 2020 2020 2020 2020 7365 6c66 2e61 7272          self.arr
-00016f00: 6f77 735f 736f 7572 6365 2e64 6174 612e  ows_source.data.
-00016f10: 7570 6461 7465 2861 7272 6f77 735f 6461  update(arrows_da
-00016f20: 7461 290a 0a0a 636c 6173 7320 5461 736b  ta)...class Task
-00016f30: 4772 6f75 7050 726f 6772 6573 7328 4461  GroupProgress(Da
-00016f40: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
-00016f50: 293a 0a20 2020 2022 2222 5374 6163 6b65  ):.    """Stacke
-00016f60: 6420 6172 6561 2063 6861 7274 2073 686f  d area chart sho
-00016f70: 7769 6e67 2074 6173 6b20 6772 6f75 7073  wing task groups
-00016f80: 2074 6872 6f75 6768 2074 696d 6522 2222   through time"""
-00016f90: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00016fa0: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-00016fb0: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
-00016fc0: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
-00016fd0: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
-00016fe0: 720a 2020 2020 2020 2020 7365 6c66 2e73  r.        self.s
-00016ff0: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
-00017000: 7461 536f 7572 6365 2829 0a20 2020 2020  taSource().     
-00017010: 2020 2023 2054 6865 206c 656e 6774 6820     # The length 
-00017020: 6f66 2074 696d 6573 6572 6965 7320 746f  of timeseries to
-00017030: 2063 6861 7274 2028 696e 2075 6e69 7473   chart (in units
-00017040: 206f 6620 706c 7567 696e 2e64 7429 0a20   of plugin.dt). 
-00017050: 2020 2020 2020 2073 656c 662e 6e70 7473         self.npts
-00017060: 203d 2031 3830 0a0a 2020 2020 2020 2020   = 180..        
-00017070: 6966 2047 726f 7570 5469 6d69 6e67 2e6e  if GroupTiming.n
-00017080: 616d 6520 6e6f 7420 696e 2073 6368 6564  ame not in sched
-00017090: 756c 6572 2e70 6c75 6769 6e73 3a0a 2020  uler.plugins:.  
-000170a0: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
-000170b0: 6c65 722e 6164 645f 706c 7567 696e 2870  ler.add_plugin(p
-000170c0: 6c75 6769 6e3d 4772 6f75 7054 696d 696e  lugin=GroupTimin
-000170d0: 6728 7363 6865 6475 6c65 7229 290a 0a20  g(scheduler)).. 
-000170e0: 2020 2020 2020 2073 656c 662e 706c 7567         self.plug
-000170f0: 696e 203d 2073 6368 6564 756c 6572 2e70  in = scheduler.p
-00017100: 6c75 6769 6e73 5b47 726f 7570 5469 6d69  lugins[GroupTimi
-00017110: 6e67 2e6e 616d 655d 0a0a 2020 2020 2020  ng.name]..      
-00017120: 2020 7365 6c66 2e73 6f75 7263 652e 6164    self.source.ad
-00017130: 6428 6e70 2e61 7272 6179 2873 656c 662e  d(np.array(self.
-00017140: 706c 7567 696e 2e74 696d 6529 202a 2031  plugin.time) * 1
-00017150: 3030 302e 302c 2022 7469 6d65 2229 0a0a  000.0, "time")..
-00017160: 2020 2020 2020 2020 785f 7261 6e67 6520          x_range 
-00017170: 3d20 4461 7461 5261 6e67 6531 6428 7261  = DataRange1d(ra
-00017180: 6e67 655f 7061 6464 696e 673d 3029 0a20  nge_padding=0). 
-00017190: 2020 2020 2020 2079 5f72 616e 6765 203d         y_range =
-000171a0: 2052 616e 6765 3164 2830 2c20 6d61 7828   Range1d(0, max(
-000171b0: 7365 6c66 2e70 6c75 6769 6e2e 6e74 6872  self.plugin.nthr
-000171c0: 6561 6473 2929 0a0a 2020 2020 2020 2020  eads))..        
-000171d0: 7365 6c66 2e72 6f6f 7420 3d20 6669 6775  self.root = figu
-000171e0: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
-000171f0: 7469 746c 653d 2254 6173 6b20 4772 6f75  title="Task Grou
-00017200: 7020 5072 6f67 7265 7373 222c 0a20 2020  p Progress",.   
-00017210: 2020 2020 2020 2020 206e 616d 653d 2274           name="t
-00017220: 6173 6b5f 6772 6f75 705f 7072 6f67 7265  ask_group_progre
-00017230: 7373 222c 0a20 2020 2020 2020 2020 2020  ss",.           
-00017240: 2074 6f6f 6c62 6172 5f6c 6f63 6174 696f   toolbar_locatio
-00017250: 6e3d 2261 626f 7665 222c 0a20 2020 2020  n="above",.     
-00017260: 2020 2020 2020 206d 696e 5f62 6f72 6465         min_borde
-00017270: 725f 626f 7474 6f6d 3d35 302c 0a20 2020  r_bottom=50,.   
-00017280: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
-00017290: 3d78 5f72 616e 6765 2c0a 2020 2020 2020  =x_range,.      
-000172a0: 2020 2020 2020 795f 7261 6e67 653d 795f        y_range=y_
-000172b0: 7261 6e67 652c 0a20 2020 2020 2020 2020  range,.         
-000172c0: 2020 2074 6f6f 6c73 3d22 222c 0a20 2020     tools="",.   
-000172d0: 2020 2020 2020 2020 2078 5f61 7869 735f           x_axis_
-000172e0: 7479 7065 3d22 6461 7465 7469 6d65 222c  type="datetime",
-000172f0: 0a20 2020 2020 2020 2020 2020 2079 5f61  .            y_a
-00017300: 7869 735f 6c6f 6361 7469 6f6e 3d4e 6f6e  xis_location=Non
-00017310: 652c 0a20 2020 2020 2020 2020 2020 202a  e,.            *
-00017320: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
-00017330: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-00017340: 726f 6f74 2e79 6178 6973 2e6d 616a 6f72  root.yaxis.major
-00017350: 5f6c 6162 656c 5f74 6578 745f 616c 7068  _label_text_alph
-00017360: 6120 3d20 300a 2020 2020 2020 2020 7365  a = 0.        se
-00017370: 6c66 2e72 6f6f 742e 7961 7869 732e 6d69  lf.root.yaxis.mi
-00017380: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
-00017390: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
-000173a0: 7365 6c66 2e72 6f6f 742e 7961 7869 732e  self.root.yaxis.
-000173b0: 6d61 6a6f 725f 7469 636b 5f6c 696e 655f  major_tick_line_
-000173c0: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
-000173d0: 2020 7365 6c66 2e72 6f6f 742e 7867 7269    self.root.xgri
-000173e0: 642e 7669 7369 626c 6520 3d20 4661 6c73  d.visible = Fals
-000173f0: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
-00017400: 726f 6f74 2e61 6464 5f74 6f6f 6c73 280a  root.add_tools(.
-00017410: 2020 2020 2020 2020 2020 2020 426f 785a              BoxZ
-00017420: 6f6f 6d54 6f6f 6c28 292c 0a20 2020 2020  oomTool(),.     
-00017430: 2020 2020 2020 2052 6573 6574 546f 6f6c         ResetTool
-00017440: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
-00017450: 5061 6e54 6f6f 6c28 6469 6d65 6e73 696f  PanTool(dimensio
-00017460: 6e73 3d22 7769 6474 6822 292c 0a20 2020  ns="width"),.   
-00017470: 2020 2020 2020 2020 2057 6865 656c 5a6f           WheelZo
-00017480: 6f6d 546f 6f6c 2864 696d 656e 7369 6f6e  omTool(dimension
-00017490: 733d 2277 6964 7468 2229 2c0a 2020 2020  s="width"),.    
-000174a0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-000174b0: 6c66 2e5f 686f 7665 7220 3d20 4e6f 6e65  lf._hover = None
-000174c0: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
-000174d0: 6173 745f 6472 6177 6e20 3d20 4e6f 6e65  ast_drawn = None
-000174e0: 0a20 2020 2020 2020 2073 656c 662e 5f6f  .        self._o
-000174f0: 6666 7365 7420 3d20 7469 6d65 2829 0a20  ffset = time(). 
-00017500: 2020 2020 2020 2073 656c 662e 5f6c 6173         self._las
-00017510: 745f 7472 616e 7369 7469 6f6e 5f63 6f75  t_transition_cou
-00017520: 6e74 203d 2073 6368 6564 756c 6572 2e74  nt = scheduler.t
-00017530: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
-00017540: 720a 2020 2020 2020 2020 2320 4f72 6465  r.        # Orde
-00017550: 7265 6444 6963 7420 736f 2077 6520 6361  redDict so we ca
-00017560: 6e20 6d61 6b65 2061 2072 6576 6572 7365  n make a reverse
-00017570: 2069 7465 7261 746f 7220 6c61 7465 7220   iterator later 
-00017580: 616e 6420 6765 7420 7468 650a 2020 2020  and get the.    
-00017590: 2020 2020 2320 6d6f 7374 2d72 6563 656e      # most-recen
-000175a0: 746c 792d 6164 6465 6420 676c 7970 6873  tly-added glyphs
-000175b0: 2e0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-000175c0: 7265 6e64 6572 6572 7320 3d20 4f72 6465  renderers = Orde
-000175d0: 7265 6444 6963 7428 290a 2020 2020 2020  redDict().      
-000175e0: 2020 7365 6c66 2e5f 6c69 6e65 5f72 656e    self._line_ren
-000175f0: 6465 7265 7273 203d 204f 7264 6572 6564  derers = Ordered
-00017600: 4469 6374 2829 0a0a 2020 2020 6465 6620  Dict()..    def 
-00017610: 5f73 686f 756c 645f 6164 645f 6e65 775f  _should_add_new_
-00017620: 7265 6e64 6572 6572 7328 7365 6c66 2920  renderers(self) 
-00017630: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
-00017640: 2022 2222 0a20 2020 2020 2020 2057 6865   """.        Whe
-00017650: 7468 6572 2074 6f20 6164 6420 6e65 7720  ther to add new 
-00017660: 7265 6e64 6572 6572 7320 746f 2074 6865  renderers to the
-00017670: 2063 6861 7274 2e0a 0a20 2020 2020 2020   chart...       
-00017680: 2057 6865 6e20 6120 6e65 7720 7365 7420   When a new set 
-00017690: 6f66 2074 6173 6b20 6772 6f75 7073 2065  of task groups e
-000176a0: 6e74 6572 7320 7468 6520 7363 6865 6475  nters the schedu
-000176b0: 6c65 7220 7765 2764 206c 696b 6520 746f  ler we'd like to
-000176c0: 2073 7461 7274 2072 656e 6465 7269 6e67   start rendering
-000176d0: 0a20 2020 2020 2020 2074 6865 6d2e 2042  .        them. B
-000176e0: 7574 2069 7420 6361 6e20 6265 2065 7870  ut it can be exp
-000176f0: 656e 7369 7665 2074 6f20 6164 6420 6e65  ensive to add ne
-00017700: 7720 676c 7970 732c 2073 6f20 7765 2064  w glyps, so we d
-00017710: 6f20 6974 2064 656c 6962 6572 6174 656c  o it deliberatel
-00017720: 792c 0a20 2020 2020 2020 2063 6865 636b  y,.        check
-00017730: 696e 6720 7768 6574 6865 7220 7765 2068  ing whether we h
-00017740: 6176 6520 746f 2064 6f20 6974 2061 6e64  ave to do it and
-00017750: 2077 6865 7468 6572 2074 6865 2073 6368   whether the sch
-00017760: 6564 756c 6572 2073 6565 6d73 2062 7573  eduler seems bus
-00017770: 792e 0a20 2020 2020 2020 2022 2222 0a20  y..        """. 
-00017780: 2020 2020 2020 2023 2041 6c77 6179 7320         # Always 
-00017790: 6472 6177 2069 6620 7765 2068 6176 6520  draw if we have 
-000177a0: 6e6f 7420 6265 666f 7265 0a20 2020 2020  not before.     
-000177b0: 2020 2069 6620 6e6f 7420 7365 6c66 2e5f     if not self._
-000177c0: 6c61 7374 5f64 7261 776e 3a0a 2020 2020  last_drawn:.    
-000177d0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-000177e0: 7275 650a 2020 2020 2020 2020 2320 446f  rue.        # Do
-000177f0: 6e27 7420 6472 6177 2069 6620 7468 6572  n't draw if ther
-00017800: 6520 6861 7665 2062 6565 6e20 6e6f 206e  e have been no n
-00017810: 6577 2074 6173 6b73 2063 6f6d 706c 6574  ew tasks complet
-00017820: 6564 2073 696e 6365 2074 6865 206c 6173  ed since the las
-00017830: 7420 7570 6461 7465 2c0a 2020 2020 2020  t update,.      
-00017840: 2020 2320 6f72 2069 6620 7468 6520 7363    # or if the sc
-00017850: 6865 6475 6c65 7220 4350 5520 6973 206f  heduler CPU is o
-00017860: 6363 7570 6965 642e 0a20 2020 2020 2020  ccupied..       
-00017870: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
-00017880: 2020 7365 6c66 2e5f 6c61 7374 5f74 7261    self._last_tra
-00017890: 6e73 6974 696f 6e5f 636f 756e 7420 3d3d  nsition_count ==
-000178a0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-000178b0: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
-000178c0: 6572 0a20 2020 2020 2020 2020 2020 206f  er.            o
-000178d0: 7220 7365 6c66 2e73 6368 6564 756c 6572  r self.scheduler
-000178e0: 2e70 726f 632e 6370 755f 7065 7263 656e  .proc.cpu_percen
-000178f0: 7428 2920 3e20 3530 0a20 2020 2020 2020  t() > 50.       
-00017900: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00017910: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
-00017920: 2020 2020 2020 2320 4f6e 6c79 2072 6574        # Only ret
-00017930: 7572 6e20 7472 7565 2069 6620 7468 6572  urn true if ther
-00017940: 6520 6172 6520 6e65 7720 7461 736b 2067  e are new task g
-00017950: 726f 7570 7320 7468 6174 2077 6520 6861  roups that we ha
-00017960: 7665 206e 6f74 2079 6574 2061 6464 6564  ve not yet added
-00017970: 0a20 2020 2020 2020 2023 2074 6f20 7468  .        # to th
-00017980: 6520 436f 6c75 6d6e 4461 7461 536f 7572  e ColumnDataSour
-00017990: 6365 2e0a 2020 2020 2020 2020 7265 7475  ce..        retu
-000179a0: 726e 206e 6f74 2073 6574 2873 656c 662e  rn not set(self.
-000179b0: 706c 7567 696e 2e63 6f6d 7075 7465 2e6b  plugin.compute.k
-000179c0: 6579 7328 2929 203c 3d20 7365 7428 7365  eys()) <= set(se
-000179d0: 6c66 2e73 6f75 7263 652e 6461 7461 2e6b  lf.source.data.k
-000179e0: 6579 7328 2929 0a0a 2020 2020 6465 6620  eys())..    def 
-000179f0: 5f73 686f 756c 645f 7570 6461 7465 2873  _should_update(s
-00017a00: 656c 6629 202d 3e20 626f 6f6c 3a0a 2020  elf) -> bool:.  
-00017a10: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00017a20: 2020 5768 6574 6865 7220 746f 2075 7064    Whether to upd
-00017a30: 6174 6520 7468 6520 436f 6c75 6d6e 4461  ate the ColumnDa
-00017a40: 7461 536f 7572 6365 2e20 5468 6973 2069  taSource. This i
-00017a50: 7320 6368 6561 7065 7220 7468 616e 2072  s cheaper than r
-00017a60: 6564 7261 7769 6e67 2c0a 2020 2020 2020  edrawing,.      
-00017a70: 2020 6275 7420 7374 696c 6c20 6e6f 7420    but still not 
-00017a80: 6672 6565 2c20 736f 2077 6520 6368 6563  free, so we chec
-00017a90: 6b20 7768 6574 6865 7220 7765 206e 6565  k whether we nee
-00017aa0: 6420 6974 2061 6e64 2077 6865 7468 6572  d it and whether
-00017ab0: 2074 6865 2073 6368 6575 646c 6572 0a20   the scheudler. 
-00017ac0: 2020 2020 2020 2069 7320 6275 7379 2e0a         is busy..
-00017ad0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00017ae0: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
-00017af0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
-00017b00: 6173 745f 7472 616e 7369 7469 6f6e 5f63  ast_transition_c
-00017b10: 6f75 6e74 2021 3d20 7365 6c66 2e73 6368  ount != self.sch
-00017b20: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
-00017b30: 6e5f 636f 756e 7465 720a 2020 2020 2020  n_counter.      
-00017b40: 2020 2020 2020 616e 6420 7365 6c66 2e73        and self.s
-00017b50: 6368 6564 756c 6572 2e70 726f 632e 6370  cheduler.proc.cp
-00017b60: 755f 7065 7263 656e 7428 2920 3c20 3530  u_percent() < 50
-00017b70: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-00017b80: 6465 6620 5f67 6574 5f74 696d 6573 6572  def _get_timeser
-00017b90: 6965 7328 7365 6c66 2c20 7265 7374 7269  ies(self, restri
-00017ba0: 6374 5f74 6f5f 6578 6973 7469 6e67 3d46  ct_to_existing=F
-00017bb0: 616c 7365 293a 0a20 2020 2020 2020 2022  alse):.        "
-00017bc0: 2222 0a20 2020 2020 2020 2055 7064 6174  "".        Updat
-00017bd0: 6520 7468 6520 436f 6c75 6d6e 4461 7461  e the ColumnData
-00017be0: 536f 7572 6365 2077 6974 6820 6f75 7220  Source with our 
-00017bf0: 7469 6d65 2073 6572 6965 7320 6461 7461  time series data
-00017c00: 2e0a 0a20 2020 2020 2020 2072 6573 7472  ...        restr
-00017c10: 6963 745f 746f 5f65 7869 7374 696e 6720  ict_to_existing 
-00017c20: 6465 7465 726d 696e 6573 2077 6865 7468  determines wheth
-00017c30: 6572 2074 6f20 6164 6420 6e65 7720 7461  er to add new ta
-00017c40: 736b 2067 726f 7570 730a 2020 2020 2020  sk groups.      
-00017c50: 2020 7768 6963 6820 6d69 6768 7420 6861    which might ha
-00017c60: 7665 2062 6565 6e20 6164 6465 6420 7369  ve been added si
-00017c70: 6e63 6520 7468 6520 6c61 7374 2074 696d  nce the last tim
-00017c80: 6520 7765 2072 656e 6465 7265 642e 0a20  e we rendered.. 
-00017c90: 2020 2020 2020 2054 6869 7320 6973 2069         This is i
-00017ca0: 6d70 6f72 7461 6e74 2061 7320 7765 2077  mportant as we w
-00017cb0: 616e 7420 746f 2061 6464 206e 6577 2073  ant to add new s
-00017cc0: 7461 636b 6572 7320 7665 7279 2064 656c  tackers very del
-00017cd0: 6962 6572 6174 656c 792e 0a20 2020 2020  iberately..     
-00017ce0: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
-00017cf0: 2047 6574 2074 6865 2066 726f 6e74 2f62   Get the front/b
-00017d00: 6163 6b20 696e 6469 6365 7320 666f 7220  ack indices for 
-00017d10: 6d6f 7374 2072 6563 656e 7420 6e70 7473  most recent npts
-00017d20: 2062 696e 7320 6f75 7420 6f66 2074 6865   bins out of the
-00017d30: 2074 696d 6573 6572 6965 730a 2020 2020   timeseries.    
-00017d40: 2020 2020 6672 6f6e 7420 3d20 6d61 7828      front = max(
-00017d50: 6c65 6e28 7365 6c66 2e70 6c75 6769 6e2e  len(self.plugin.
-00017d60: 7469 6d65 2920 2d20 7365 6c66 2e6e 7074  time) - self.npt
-00017d70: 732c 2030 290a 2020 2020 2020 2020 6261  s, 0).        ba
-00017d80: 636b 203d 204e 6f6e 650a 2020 2020 2020  ck = None.      
-00017d90: 2020 2320 5265 6d6f 7665 2061 6e79 2070    # Remove any p
-00017da0: 6572 696f 6473 206f 6620 7a65 726f 2063  eriods of zero c
-00017db0: 6f6d 7075 7465 2061 7420 7468 6520 6672  ompute at the fr
-00017dc0: 6f6e 7420 6f72 2062 6163 6b20 6f66 2074  ont or back of t
-00017dd0: 6865 2074 696d 6573 6572 6965 730a 2020  he timeseries.  
-00017de0: 2020 2020 2020 6966 206c 656e 2873 656c        if len(sel
-00017df0: 662e 706c 7567 696e 2e63 6f6d 7075 7465  f.plugin.compute
-00017e00: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
-00017e10: 6767 203d 2073 756d 286e 702e 6172 7261  gg = sum(np.arra
-00017e20: 7928 765b 6672 6f6e 743a 5d29 2066 6f72  y(v[front:]) for
-00017e30: 2076 2069 6e20 7365 6c66 2e70 6c75 6769   v in self.plugi
-00017e40: 6e2e 636f 6d70 7574 652e 7661 6c75 6573  n.compute.values
-00017e50: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-00017e60: 6672 6f6e 7432 203d 206c 656e 2861 6767  front2 = len(agg
-00017e70: 2920 2d20 6c65 6e28 6e70 2e74 7269 6d5f  ) - len(np.trim_
-00017e80: 7a65 726f 7328 6167 672c 2074 7269 6d3d  zeros(agg, trim=
-00017e90: 2266 2229 290a 2020 2020 2020 2020 2020  "f")).          
-00017ea0: 2020 6672 6f6e 7420 2b3d 2066 726f 6e74    front += front
-00017eb0: 320a 2020 2020 2020 2020 2020 2020 6261  2.            ba
-00017ec0: 636b 203d 206c 656e 286e 702e 7472 696d  ck = len(np.trim
-00017ed0: 5f7a 6572 6f73 2861 6767 2c20 7472 696d  _zeros(agg, trim
-00017ee0: 3d22 6222 2929 202d 206c 656e 2861 6767  ="b")) - len(agg
-00017ef0: 2920 6f72 204e 6f6e 650a 0a20 2020 2020  ) or None..     
-00017f00: 2020 2070 7265 7065 6e64 203d 2028 0a20     prepend = (. 
-00017f10: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00017f20: 706c 7567 696e 2e74 696d 655b 6672 6f6e  plugin.time[fron
-00017f30: 7420 2d20 315d 0a20 2020 2020 2020 2020  t - 1].         
-00017f40: 2020 2069 6620 6672 6f6e 7420 3e3d 2031     if front >= 1
-00017f50: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00017f60: 6520 7365 6c66 2e70 6c75 6769 6e2e 7469  e self.plugin.ti
-00017f70: 6d65 5b66 726f 6e74 5d20 2d20 7365 6c66  me[front] - self
-00017f80: 2e70 6c75 6769 6e2e 6474 0a20 2020 2020  .plugin.dt.     
-00017f90: 2020 2029 0a20 2020 2020 2020 2074 696d     ).        tim
-00017fa0: 6573 7461 6d70 7320 3d20 6e70 2e61 7272  estamps = np.arr
-00017fb0: 6179 2873 656c 662e 706c 7567 696e 2e74  ay(self.plugin.t
-00017fc0: 696d 655b 6672 6f6e 743a 6261 636b 5d29  ime[front:back])
-00017fd0: 0a20 2020 2020 2020 2064 7420 3d20 6e70  .        dt = np
-00017fe0: 2e64 6966 6628 7469 6d65 7374 616d 7073  .diff(timestamps
-00017ff0: 2c20 7072 6570 656e 643d 7072 6570 656e  , prepend=prepen
-00018000: 6429 0a0a 2020 2020 2020 2020 6966 2072  d)..        if r
-00018010: 6573 7472 6963 745f 746f 5f65 7869 7374  estrict_to_exist
-00018020: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00018030: 206e 6577 5f64 6174 6120 3d20 7b0a 2020   new_data = {.  
-00018040: 2020 2020 2020 2020 2020 2020 2020 6b3a                k:
-00018050: 206e 702e 6172 7261 7928 765b 6672 6f6e   np.array(v[fron
-00018060: 743a 6261 636b 5d29 202f 2064 740a 2020  t:back]) / dt.  
-00018070: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00018080: 7220 6b2c 2076 2069 6e20 7365 6c66 2e70  r k, v in self.p
-00018090: 6c75 6769 6e2e 636f 6d70 7574 652e 6974  lugin.compute.it
-000180a0: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
-000180b0: 2020 2020 2020 6966 206b 2069 6e20 7365        if k in se
-000180c0: 6c66 2e73 6f75 7263 652e 6461 7461 0a20  lf.source.data. 
-000180d0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
-000180e0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000180f0: 2020 2020 2020 206e 6577 5f64 6174 6120         new_data 
-00018100: 3d20 7661 6c6d 6170 280a 2020 2020 2020  = valmap(.      
-00018110: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
-00018120: 2078 3a20 6e70 2e61 7272 6179 2878 5b66   x: np.array(x[f
-00018130: 726f 6e74 3a62 6163 6b5d 2920 2f20 6474  ront:back]) / dt
-00018140: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018150: 2020 7365 6c66 2e70 6c75 6769 6e2e 636f    self.plugin.co
-00018160: 6d70 7574 652c 0a20 2020 2020 2020 2020  mpute,.         
-00018170: 2020 2029 0a0a 2020 2020 2020 2020 6e65     )..        ne
-00018180: 775f 6461 7461 5b22 7469 6d65 225d 203d  w_data["time"] =
-00018190: 2028 0a20 2020 2020 2020 2020 2020 2074   (.            t
-000181a0: 696d 6573 7461 6d70 7320 2d20 7365 6c66  imestamps - self
-000181b0: 2e5f 6f66 6673 6574 0a20 2020 2020 2020  ._offset.       
-000181c0: 2029 202a 2031 3030 302e 3020 2023 2062   ) * 1000.0  # b
-000181d0: 6f6b 6568 206c 696b 6573 206d 696c 6c69  okeh likes milli
-000181e0: 7365 636f 6e64 730a 2020 2020 2020 2020  seconds.        
-000181f0: 6e65 775f 6461 7461 5b22 6e74 6872 6561  new_data["nthrea
-00018200: 6473 225d 203d 206e 702e 6172 7261 7928  ds"] = np.array(
-00018210: 7365 6c66 2e70 6c75 6769 6e2e 6e74 6872  self.plugin.nthr
-00018220: 6561 6473 5b66 726f 6e74 3a62 6163 6b5d  eads[front:back]
-00018230: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00018240: 6e20 6e65 775f 6461 7461 0a0a 2020 2020  n new_data..    
-00018250: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
-00018260: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
-00018270: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
-00018280: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
-00018290: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
-000182a0: 2020 2020 2020 204d 6179 6265 2075 7064         Maybe upd
-000182b0: 6174 6520 7468 6520 6368 6172 742e 2054  ate the chart. T
-000182c0: 6869 7320 6973 2073 6f6d 6577 6861 7420  his is somewhat 
-000182d0: 6578 7065 6e73 6976 6520 746f 2064 7261  expensive to dra
-000182e0: 772c 2073 6f20 7765 2075 7064 6174 650a  w, so we update.
-000182f0: 2020 2020 2020 2020 6974 2070 7265 7474          it prett
-00018300: 7920 6465 6665 6e73 6976 656c 792e 0a20  y defensively.. 
-00018310: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00018320: 2020 2069 6620 7365 6c66 2e5f 7368 6f75     if self._shou
-00018330: 6c64 5f61 6464 5f6e 6577 5f72 656e 6465  ld_add_new_rende
-00018340: 7265 7273 2829 3a0a 2020 2020 2020 2020  rers():.        
-00018350: 2020 2020 2320 5570 6461 7465 2074 6865      # Update the
-00018360: 2063 6861 7274 2c20 616c 6c6f 7769 6e67   chart, allowing
-00018370: 2066 6f72 206e 6577 2074 6173 6b20 6772   for new task gr
-00018380: 6f75 7073 2074 6f20 6265 2061 6464 6564  oups to be added
-00018390: 2e0a 2020 2020 2020 2020 2020 2020 6e65  ..            ne
-000183a0: 775f 6461 7461 203d 2073 656c 662e 5f67  w_data = self._g
-000183b0: 6574 5f74 696d 6573 6572 6965 7328 7265  et_timeseries(re
-000183c0: 7374 7269 6374 5f74 6f5f 6578 6973 7469  strict_to_existi
-000183d0: 6e67 3d46 616c 7365 290a 2020 2020 2020  ng=False).      
-000183e0: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
-000183f0: 652e 6461 7461 203d 206e 6577 5f64 6174  e.data = new_dat
-00018400: 610a 0a20 2020 2020 2020 2020 2020 2023  a..            #
-00018410: 2050 6f73 7369 626c 7920 7570 6461 7465   Possibly update
-00018420: 2074 6865 2079 2072 616e 6765 2069 6620   the y range if 
-00018430: 7468 6520 6e75 6d62 6572 206f 6620 7468  the number of th
-00018440: 7265 6164 7320 6861 7320 696e 6372 6561  reads has increa
-00018450: 7365 642e 0a20 2020 2020 2020 2020 2020  sed..           
-00018460: 206d 6178 5f6e 7468 7265 6164 7320 3d20   max_nthreads = 
-00018470: 6d61 7828 7365 6c66 2e70 6c75 6769 6e2e  max(self.plugin.
-00018480: 6e74 6872 6561 6473 290a 2020 2020 2020  nthreads).      
-00018490: 2020 2020 2020 6966 2073 656c 662e 726f        if self.ro
-000184a0: 6f74 2e79 5f72 616e 6765 2e65 6e64 2021  ot.y_range.end !
-000184b0: 3d20 6d61 785f 6e74 6872 6561 6473 3a0a  = max_nthreads:.
-000184c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000184d0: 7365 6c66 2e72 6f6f 742e 795f 7261 6e67  self.root.y_rang
-000184e0: 652e 656e 6420 3d20 6d61 785f 6e74 6872  e.end = max_nthr
-000184f0: 6561 6473 0a0a 2020 2020 2020 2020 2020  eads..          
-00018500: 2020 7374 6163 6b65 7273 203d 206c 6973    stackers = lis
-00018510: 7428 7365 6c66 2e70 6c75 6769 6e2e 636f  t(self.plugin.co
-00018520: 6d70 7574 652e 6b65 7973 2829 290a 2020  mpute.keys()).  
-00018530: 2020 2020 2020 2020 2020 636f 6c6f 7273            colors
-00018540: 203d 205b 636f 6c6f 725f 6f66 286b 6579   = [color_of(key
-00018550: 5f73 706c 6974 286b 2929 2066 6f72 206b  _split(k)) for k
-00018560: 2069 6e20 7374 6163 6b65 7273 5d0a 0a20   in stackers].. 
-00018570: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00018580: 2c20 2867 726f 7570 2c20 636f 6c6f 7229  , (group, color)
-00018590: 2069 6e20 656e 756d 6572 6174 6528 7a69   in enumerate(zi
-000185a0: 7028 7374 6163 6b65 7273 2c20 636f 6c6f  p(stackers, colo
-000185b0: 7273 2929 3a0a 2020 2020 2020 2020 2020  rs)):.          
-000185c0: 2020 2020 2020 2320 4966 2077 6520 6861        # If we ha
-000185d0: 7665 2061 6c72 6561 6479 2064 7261 776e  ve already drawn
-000185e0: 2074 6865 2067 726f 7570 2c20 6275 7420   the group, but 
-000185f0: 6974 2069 7320 616c 6c20 7a65 726f 2c0a  it is all zero,.
-00018600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018610: 2320 7365 7420 6974 2074 6f20 6265 2069  # set it to be i
-00018620: 6e76 6973 6962 6c65 2e0a 2020 2020 2020  nvisible..      
-00018630: 2020 2020 2020 2020 2020 6966 2067 726f            if gro
-00018640: 7570 2069 6e20 7365 6c66 2e5f 7265 6e64  up in self._rend
-00018650: 6572 6572 733a 0a20 2020 2020 2020 2020  erers:.         
-00018660: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00018670: 7420 6e70 2e63 6f75 6e74 5f6e 6f6e 7a65  t np.count_nonze
-00018680: 726f 286e 6577 5f64 6174 615b 6772 6f75  ro(new_data[grou
-00018690: 705d 2920 3e20 303a 0a20 2020 2020 2020  p]) > 0:.       
-000186a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000186b0: 2073 656c 662e 5f72 656e 6465 7265 7273   self._renderers
-000186c0: 5b67 726f 7570 5d2e 7669 7369 626c 6520  [group].visible 
-000186d0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-000186e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000186f0: 7365 6c66 2e5f 6c69 6e65 5f72 656e 6465  self._line_rende
-00018700: 7265 7273 5b67 726f 7570 5d2e 7669 7369  rers[group].visi
-00018710: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
-00018720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018730: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00018740: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00018750: 6c66 2e5f 7265 6e64 6572 6572 735b 6772  lf._renderers[gr
-00018760: 6f75 705d 2e76 6973 6962 6c65 203d 2054  oup].visible = T
-00018770: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-00018780: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00018790: 2e5f 6c69 6e65 5f72 656e 6465 7265 7273  ._line_renderers
-000187a0: 5b67 726f 7570 5d2e 7669 7369 626c 6520  [group].visible 
-000187b0: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
-000187c0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-000187d0: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-000187e0: 2020 2020 2020 2320 4472 6177 2074 6865        # Draw the
-000187f0: 206e 6577 2061 7265 6120 616e 6420 6c69   new area and li
-00018800: 6e65 2067 6c79 7068 732e 0a20 2020 2020  ne glyphs..     
-00018810: 2020 2020 2020 2020 2020 2072 656e 6465             rende
-00018820: 7265 7220 3d20 7365 6c66 2e72 6f6f 742e  rer = self.root.
-00018830: 7661 7265 6128 0a20 2020 2020 2020 2020  varea(.         
-00018840: 2020 2020 2020 2020 2020 2078 3d22 7469             x="ti
-00018850: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
-00018860: 2020 2020 2020 2020 2079 313d 7374 6163           y1=stac
-00018870: 6b28 2a73 7461 636b 6572 735b 3a69 5d29  k(*stackers[:i])
-00018880: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00018890: 2020 2020 2020 7932 3d73 7461 636b 282a        y2=stack(*
-000188a0: 7374 6163 6b65 7273 5b3a 2069 202b 2031  stackers[: i + 1
-000188b0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-000188c0: 2020 2020 2020 2020 636f 6c6f 723d 636f          color=co
-000188d0: 6c6f 722c 0a20 2020 2020 2020 2020 2020  lor,.           
-000188e0: 2020 2020 2020 2020 2061 6c70 6861 3d30           alpha=0
-000188f0: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
-00018900: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-00018910: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
-00018920: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00018930: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00018940: 6c66 2e5f 7265 6e64 6572 6572 735b 6772  lf._renderers[gr
-00018950: 6f75 705d 203d 2072 656e 6465 7265 720a  oup] = renderer.
-00018960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018970: 206c 696e 655f 7265 6e64 6572 6572 203d   line_renderer =
-00018980: 2073 656c 662e 726f 6f74 2e6c 696e 6528   self.root.line(
-00018990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000189a0: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
-000189b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000189c0: 2020 2079 3d73 7461 636b 282a 7374 6163     y=stack(*stac
-000189d0: 6b65 7273 5b3a 2069 202b 2031 5d29 2c0a  kers[: i + 1]),.
-000189e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000189f0: 2020 2020 636f 6c6f 723d 636f 6c6f 722c      color=color,
-00018a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018a10: 2020 2020 2061 6c70 6861 3d31 2e30 2c0a       alpha=1.0,.
-00018a20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018a30: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-00018a40: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-00018a50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00018a60: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00018a70: 6c69 6e65 5f72 656e 6465 7265 7273 5b67  line_renderers[g
-00018a80: 726f 7570 5d20 3d20 6c69 6e65 5f72 656e  roup] = line_ren
-00018a90: 6465 7265 720a 0a20 2020 2020 2020 2020  derer..         
-00018aa0: 2020 2023 2044 6f6e 2774 2061 6464 2068     # Don't add h
-00018ab0: 6f76 6572 2075 6e74 696c 2074 6865 7265  over until there
-00018ac0: 2069 7320 736f 6d65 7468 696e 6720 746f   is something to
-00018ad0: 2073 686f 772c 2061 7320 626f 6b65 686a   show, as bokehj
-00018ae0: 7320 7365 656d 7320 746f 0a20 2020 2020  s seems to.     
-00018af0: 2020 2020 2020 2023 2068 6176 6520 7472         # have tr
-00018b00: 6f75 626c 6520 7769 7468 2063 7573 746f  ouble with custo
-00018b10: 6d20 686f 7665 7273 2077 6865 6e20 7468  m hovers when th
-00018b20: 6572 6520 6172 6520 6e6f 2072 656e 6465  ere are no rende
-00018b30: 7265 7273 2e0a 2020 2020 2020 2020 2020  rers..          
-00018b40: 2020 6966 2073 656c 662e 706c 7567 696e    if self.plugin
-00018b50: 2e63 6f6d 7075 7465 2061 6e64 2073 656c  .compute and sel
-00018b60: 662e 5f68 6f76 6572 2069 7320 4e6f 6e65  f._hover is None
-00018b70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018b80: 2020 2320 4164 6420 6120 686f 7665 7220    # Add a hover 
-00018b90: 7468 6174 2077 696c 6c20 7368 6f77 206f  that will show o
-00018ba0: 6363 7570 616e 6379 2066 6f72 2061 6c6c  ccupancy for all
-00018bb0: 2063 7572 7265 6e74 6c79 2061 6374 6976   currently activ
-00018bc0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00018bd0: 2020 2320 7461 736b 2067 726f 7570 732e    # task groups.
-00018be0: 2054 6869 7320 6973 2061 206c 6974 746c   This is a littl
-00018bf0: 6520 7472 6963 6b79 2c20 626f 6b65 6820  e tricky, bokeh 
-00018c00: 646f 6573 6e27 7420 2879 6574 2920 7375  doesn't (yet) su
-00018c10: 7070 6f72 740a 2020 2020 2020 2020 2020  pport.          
-00018c20: 2020 2020 2020 2320 6869 7420 7465 7374        # hit test
-00018c30: 7320 666f 7220 7374 6163 6b65 6420 6172  s for stacked ar
-00018c40: 6561 2063 6861 7274 733a 2068 7474 7073  ea charts: https
-00018c50: 3a2f 2f67 6974 6875 622e 636f 6d2f 626f  ://github.com/bo
-00018c60: 6b65 682f 626f 6b65 682f 6973 7375 6573  keh/bokeh/issues
-00018c70: 2f39 3138 320a 2020 2020 2020 2020 2020  /9182.          
-00018c80: 2020 2020 2020 2320 496e 7374 6561 642c        # Instead,
-00018c90: 2073 686f 7720 6120 7369 6e67 6c65 2076   show a single v
-00018ca0: 6c69 6e65 2068 6f76 6572 2077 6869 6368  line hover which
-00018cb0: 206c 6973 7473 2074 6865 2063 7572 7265   lists the curre
-00018cc0: 6e74 6c79 2061 6374 6976 6520 7461 736b  ntly active task
-00018cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018ce0: 2023 2067 726f 7570 732e 2041 2063 7573   # groups. A cus
-00018cf0: 746f 6d20 666f 726d 6174 7465 7220 696e  tom formatter in
-00018d00: 204a 532d 6c61 6e64 2070 756c 6c73 2074   JS-land pulls t
-00018d10: 6865 2072 656c 6576 616e 7420 6461 7461  he relevant data
-00018d20: 2069 6e64 6578 2061 6e64 0a20 2020 2020   index and.     
-00018d30: 2020 2020 2020 2020 2020 2023 2061 7373             # ass
-00018d40: 656d 626c 6573 2074 6865 2074 6f6f 6c74  embles the toolt
-00018d50: 6970 2e0a 2020 2020 2020 2020 2020 2020  ip..            
-00018d60: 2020 2020 666f 726d 6174 7465 7220 3d20      formatter = 
-00018d70: 4375 7374 6f6d 4a53 486f 7665 7228 636f  CustomJSHover(co
-00018d80: 6465 3d22 7265 7475 726e 2027 273b 2229  de="return '';")
-00018d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018da0: 2073 656c 662e 5f68 6f76 6572 203d 2048   self._hover = H
-00018db0: 6f76 6572 546f 6f6c 280a 2020 2020 2020  overTool(.      
-00018dc0: 2020 2020 2020 2020 2020 2020 2020 746f                to
-00018dd0: 6f6c 7469 7073 3d22 2222 0a20 2020 2020  oltips=""".     
-00018de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018df0: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
+00013970: 2020 2020 2020 2269 6e5f 6572 7265 6422        "in_erred"
+00013980: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00013990: 2020 2020 2020 2263 6f6d 7075 7465 5f74        "compute_t
+000139a0: 696d 6522 3a20 5b5d 2c0a 2020 2020 2020  ime": [],.      
+000139b0: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+000139c0: 7922 3a20 5b5d 2c0a 2020 2020 2020 2020  y": [],.        
+000139d0: 2020 2020 7d0a 2020 2020 2020 2020 290a      }.        ).
+000139e0: 0a20 2020 2020 2020 2073 656c 662e 6172  .        self.ar
+000139f0: 726f 7773 5f73 6f75 7263 6520 3d20 436f  rows_source = Co
+00013a00: 6c75 6d6e 4461 7461 536f 7572 6365 287b  lumnDataSource({
+00013a10: 2278 7322 3a20 5b5d 2c20 2279 7322 3a20  "xs": [], "ys": 
+00013a20: 5b5d 2c20 2278 6522 3a20 5b5d 2c20 2279  [], "xe": [], "y
+00013a30: 6522 3a20 5b5d 7d29 0a0a 2020 2020 2020  e": []})..      
+00013a40: 2020 7365 6c66 2e72 6f6f 7420 3d20 6669    self.root = fi
+00013a50: 6775 7265 2874 6974 6c65 3d22 5461 736b  gure(title="Task
+00013a60: 2047 726f 7570 7320 4772 6170 6822 2c20   Groups Graph", 
+00013a70: 6d61 7463 685f 6173 7065 6374 3d54 7275  match_aspect=Tru
+00013a80: 652c 202a 2a6b 7761 7267 7329 0a20 2020  e, **kwargs).   
+00013a90: 2020 2020 2073 656c 662e 726f 6f74 2e61       self.root.a
+00013aa0: 7869 732e 7669 7369 626c 6520 3d20 4661  xis.visible = Fa
+00013ab0: 6c73 650a 2020 2020 2020 2020 7365 6c66  lse.        self
+00013ac0: 2e73 7562 7469 746c 6520 3d20 5469 746c  .subtitle = Titl
+00013ad0: 6528 7465 7874 3d22 2022 2c20 7465 7874  e(text=" ", text
+00013ae0: 5f66 6f6e 745f 7374 796c 653d 2269 7461  _font_style="ita
+00013af0: 6c69 6322 290a 2020 2020 2020 2020 7365  lic").        se
+00013b00: 6c66 2e72 6f6f 742e 6164 645f 6c61 796f  lf.root.add_layo
+00013b10: 7574 2873 656c 662e 7375 6274 6974 6c65  ut(self.subtitle
+00013b20: 2c20 2261 626f 7665 2229 0a0a 2020 2020  , "above")..    
+00013b30: 2020 2020 7265 6374 203d 2073 656c 662e      rect = self.
+00013b40: 726f 6f74 2e72 6563 7428 0a20 2020 2020  root.rect(.     
+00013b50: 2020 2020 2020 2078 3d22 7822 2c0a 2020         x="x",.  
+00013b60: 2020 2020 2020 2020 2020 793d 2279 222c            y="y",
+00013b70: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
+00013b80: 7468 3d22 775f 626f 7822 2c0a 2020 2020  th="w_box",.    
+00013b90: 2020 2020 2020 2020 6865 6967 6874 3d22          height="
+00013ba0: 685f 626f 7822 2c0a 2020 2020 2020 2020  h_box",.        
+00013bb0: 2020 2020 636f 6c6f 723d 2263 6f6c 6f72      color="color
+00013bc0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+00013bd0: 696c 6c5f 616c 7068 613d 226d 656d 5f61  ill_alpha="mem_a
+00013be0: 6c70 6861 222c 0a20 2020 2020 2020 2020  lpha",.         
+00013bf0: 2020 206c 696e 655f 636f 6c6f 723d 2262     line_color="b
+00013c00: 6c61 636b 222c 0a20 2020 2020 2020 2020  lack",.         
+00013c10: 2020 206c 696e 655f 7769 6474 683d 226e     line_width="n
+00013c20: 6f64 655f 6c69 6e65 5f77 6964 7468 222c  ode_line_width",
+00013c30: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+00013c40: 7263 653d 7365 6c66 2e6e 6f64 6573 5f73  rce=self.nodes_s
+00013c50: 6f75 7263 652c 0a20 2020 2020 2020 2029  ource,.        )
+00013c60: 0a0a 2020 2020 2020 2020 2320 706c 6f74  ..        # plot
+00013c70: 2074 6720 6c6f 670a 2020 2020 2020 2020   tg log.        
+00013c80: 7365 6c66 2e72 6f6f 742e 696d 6167 655f  self.root.image_
+00013c90: 7572 6c28 0a20 2020 2020 2020 2020 2020  url(.           
+00013ca0: 2075 726c 3d22 7572 6c5f 6c6f 676f 222c   url="url_logo",
+00013cb0: 0a20 2020 2020 2020 2020 2020 2078 3d22  .            x="
+00013cc0: 785f 6c6f 676f 222c 0a20 2020 2020 2020  x_logo",.       
+00013cd0: 2020 2020 2079 3d22 795f 6c6f 676f 222c       y="y_logo",
+00013ce0: 0a20 2020 2020 2020 2020 2020 2077 3d22  .            w="
+00013cf0: 775f 6c6f 676f 222c 0a20 2020 2020 2020  w_logo",.       
+00013d00: 2020 2020 2068 3d22 685f 6c6f 676f 222c       h="h_logo",
+00013d10: 0a20 2020 2020 2020 2020 2020 2061 6e63  .            anc
+00013d20: 686f 723d 2263 656e 7465 7222 2c0a 2020  hor="center",.  
+00013d30: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00013d40: 3d73 656c 662e 6e6f 6465 735f 736f 7572  =self.nodes_sour
+00013d50: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
+00013d60: 2020 2020 2020 2023 2070 726f 6772 6573         # progres
+00013d70: 7320 6261 7220 706c 6169 6e20 626f 780a  s bar plain box.
+00013d80: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00013d90: 742e 7175 6164 280a 2020 2020 2020 2020  t.quad(.        
+00013da0: 2020 2020 6c65 6674 3d22 785f 7374 6172      left="x_star
+00013db0: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+00013dc0: 7269 6768 743d 2278 5f65 6e64 222c 0a20  right="x_end",. 
+00013dd0: 2020 2020 2020 2020 2020 2062 6f74 746f             botto
+00013de0: 6d3d 2279 5f73 7461 7274 222c 0a20 2020  m="y_start",.   
+00013df0: 2020 2020 2020 2020 2074 6f70 3d22 795f           top="y_
+00013e00: 656e 6422 2c0a 2020 2020 2020 2020 2020  end",.          
+00013e10: 2020 636f 6c6f 723d 4e6f 6e65 2c0a 2020    color=None,.  
+00013e20: 2020 2020 2020 2020 2020 6c69 6e65 5f63            line_c
+00013e30: 6f6c 6f72 3d22 626c 6163 6b22 2c0a 2020  olor="black",.  
+00013e40: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00013e50: 3d73 656c 662e 6e6f 6465 735f 736f 7572  =self.nodes_sour
+00013e60: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
+00013e70: 2020 2020 2020 2023 2070 726f 6772 6573         # progres
+00013e80: 7320 6261 720a 2020 2020 2020 2020 7365  s bar.        se
+00013e90: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
+00013ea0: 2020 2020 2020 2020 2020 6c65 6674 3d22            left="
+00013eb0: 785f 7374 6172 7422 2c0a 2020 2020 2020  x_start",.      
+00013ec0: 2020 2020 2020 7269 6768 743d 2278 5f65        right="x_e
+00013ed0: 6e64 5f70 726f 6772 6573 7322 2c0a 2020  nd_progress",.  
+00013ee0: 2020 2020 2020 2020 2020 626f 7474 6f6d            bottom
+00013ef0: 3d22 795f 7374 6172 7422 2c0a 2020 2020  ="y_start",.    
+00013f00: 2020 2020 2020 2020 746f 703d 2279 5f65          top="y_e
+00013f10: 6e64 222c 0a20 2020 2020 2020 2020 2020  nd",.           
+00013f20: 2063 6f6c 6f72 3d22 636f 6c6f 7222 2c0a   color="color",.
+00013f30: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+00013f40: 5f63 6f6c 6f72 3d4e 6f6e 652c 0a20 2020  _color=None,.   
+00013f50: 2020 2020 2020 2020 2066 696c 6c5f 616c           fill_al
+00013f60: 7068 613d 302e 362c 0a20 2020 2020 2020  pha=0.6,.       
+00013f70: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+00013f80: 2e6e 6f64 6573 5f73 6f75 7263 652c 0a20  .nodes_source,. 
+00013f90: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00013fa0: 2020 7365 6c66 2e61 7272 6f77 7320 3d20    self.arrows = 
+00013fb0: 4172 726f 7728 0a20 2020 2020 2020 2020  Arrow(.         
+00013fc0: 2020 2065 6e64 3d56 6565 4865 6164 2873     end=VeeHead(s
+00013fd0: 697a 653d 3829 2c0a 2020 2020 2020 2020  ize=8),.        
+00013fe0: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
+00013ff0: 626c 6163 6b22 2c0a 2020 2020 2020 2020  black",.        
+00014000: 2020 2020 6c69 6e65 5f61 6c70 6861 3d30      line_alpha=0
+00014010: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
+00014020: 6c69 6e65 5f77 6964 7468 3d31 2c0a 2020  line_width=1,.  
+00014030: 2020 2020 2020 2020 2020 785f 7374 6172            x_star
+00014040: 743d 2278 7322 2c0a 2020 2020 2020 2020  t="xs",.        
+00014050: 2020 2020 795f 7374 6172 743d 2279 7322      y_start="ys"
+00014060: 2c0a 2020 2020 2020 2020 2020 2020 785f  ,.            x_
+00014070: 656e 643d 2278 6522 2c0a 2020 2020 2020  end="xe",.      
+00014080: 2020 2020 2020 795f 656e 643d 2279 6522        y_end="ye"
+00014090: 2c0a 2020 2020 2020 2020 2020 2020 736f  ,.            so
+000140a0: 7572 6365 3d73 656c 662e 6172 726f 7773  urce=self.arrows
+000140b0: 5f73 6f75 7263 652c 0a20 2020 2020 2020  _source,.       
+000140c0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+000140d0: 726f 6f74 2e61 6464 5f6c 6179 6f75 7428  root.add_layout(
+000140e0: 7365 6c66 2e61 7272 6f77 7329 0a0a 2020  self.arrows)..  
+000140f0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+00014100: 7867 7269 642e 6772 6964 5f6c 696e 655f  xgrid.grid_line_
+00014110: 636f 6c6f 7220 3d20 4e6f 6e65 0a20 2020  color = None.   
+00014120: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+00014130: 6772 6964 2e67 7269 645f 6c69 6e65 5f63  grid.grid_line_c
+00014140: 6f6c 6f72 203d 204e 6f6e 650a 2020 2020  olor = None.    
+00014150: 2020 2020 7365 6c66 2e72 6f6f 742e 785f      self.root.x_
+00014160: 7261 6e67 652e 7261 6e67 655f 7061 6464  range.range_padd
+00014170: 696e 6720 3d20 302e 350a 2020 2020 2020  ing = 0.5.      
+00014180: 2020 7365 6c66 2e72 6f6f 742e 795f 7261    self.root.y_ra
+00014190: 6e67 652e 7261 6e67 655f 7061 6464 696e  nge.range_paddin
+000141a0: 6720 3d20 302e 350a 0a20 2020 2020 2020  g = 0.5..       
+000141b0: 2068 6f76 6572 203d 2048 6f76 6572 546f   hover = HoverTo
+000141c0: 6f6c 280a 2020 2020 2020 2020 2020 2020  ol(.            
+000141d0: 706f 696e 745f 706f 6c69 6379 3d22 666f  point_policy="fo
+000141e0: 6c6c 6f77 5f6d 6f75 7365 222c 0a20 2020  llow_mouse",.   
+000141f0: 2020 2020 2020 2020 2074 6f6f 6c74 6970           tooltip
+00014200: 733d 2222 220a 2020 2020 2020 2020 2020  s=""".          
+00014210: 2020 2020 2020 3c64 6976 3e0a 2020 2020        <div>.    
+00014220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014230: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00014240: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
+00014250: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+00014260: 223e 4e61 6d65 3a3c 2f73 7061 6e3e 266e  ">Name:</span>&n
+00014270: 6273 703b 0a20 2020 2020 2020 2020 2020  bsp;.           
+00014280: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+00014290: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+000142a0: 2031 3070 783b 2066 6f6e 742d 6661 6d69   10px; font-fami
+000142b0: 6c79 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f  ly: Monaco, mono
+000142c0: 7370 6163 653b 223e 406e 616d 653c 2f73  space;">@name</s
+000142d0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+000142e0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+000142f0: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+00014300: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00014310: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00014320: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
+00014330: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+00014340: 2062 6f6c 643b 223e 436f 6d70 7574 6520   bold;">Compute 
+00014350: 7469 6d65 3a3c 2f73 7061 6e3e 266e 6273  time:</span>&nbs
+00014360: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
+00014370: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+00014380: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+00014390: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
+000143a0: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
+000143b0: 6163 653b 223e 4063 6f6d 7075 7465 5f74  ace;">@compute_t
+000143c0: 696d 653c 2f73 7061 6e3e 0a20 2020 2020  ime</span>.     
+000143d0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+000143e0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+000143f0: 2020 3c64 6976 3e0a 2020 2020 2020 2020    <div>.        
+00014400: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00014410: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00014420: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
+00014430: 6569 6768 743a 2062 6f6c 643b 223e 4d65  eight: bold;">Me
+00014440: 6d6f 7279 3a3c 2f73 7061 6e3e 266e 6273  mory:</span>&nbs
+00014450: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
+00014460: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+00014470: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+00014480: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
+00014490: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
+000144a0: 6163 653b 223e 406d 656d 6f72 793c 2f73  ace;">@memory</s
+000144b0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+000144c0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+000144d0: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+000144e0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+000144f0: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00014500: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
+00014510: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+00014520: 2062 6f6c 643b 223e 5461 736b 733a 3c2f   bold;">Tasks:</
+00014530: 7370 616e 3e26 6e62 7370 3b0a 2020 2020  span>&nbsp;.    
+00014540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014550: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00014560: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
+00014570: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
+00014580: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
+00014590: 746f 745f 7461 736b 733c 2f73 7061 6e3e  tot_tasks</span>
+000145a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000145b0: 203c 2f64 6976 3e0a 2020 2020 2020 2020   </div>.        
+000145c0: 2020 2020 2020 2020 3c64 6976 2073 7479          <div sty
+000145d0: 6c65 3d22 6d61 7267 696e 2d6c 6566 743a  le="margin-left:
+000145e0: 2032 656d 3b22 3e0a 2020 2020 2020 2020   2em;">.        
+000145f0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+00014600: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+00014610: 7a65 3a20 3132 7078 3b20 666f 6e74 2d77  ze: 12px; font-w
+00014620: 6569 6768 743a 2062 6f6c 643b 223e 436f  eight: bold;">Co
+00014630: 6d70 6c65 7465 643a 3c2f 7370 616e 3e26  mpleted:</span>&
+00014640: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
+00014650: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+00014660: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+00014670: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
+00014680: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
+00014690: 6f73 7061 6365 3b22 3e40 636f 6d70 5f74  ospace;">@comp_t
+000146a0: 6173 6b73 3c2f 7370 616e 3e0a 2020 2020  asks</span>.    
+000146b0: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
+000146c0: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
+000146d0: 2020 203c 6469 7620 7374 796c 653d 226d     <div style="m
+000146e0: 6172 6769 6e2d 6c65 6674 3a20 3265 6d3b  argin-left: 2em;
+000146f0: 223e 0a20 2020 2020 2020 2020 2020 2020  ">.             
+00014700: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+00014710: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+00014720: 3270 783b 2066 6f6e 742d 7765 6967 6874  2px; font-weight
+00014730: 3a20 626f 6c64 3b22 3e50 726f 6365 7373  : bold;">Process
+00014740: 696e 673a 3c2f 7370 616e 3e26 6e62 7370  ing:</span>&nbsp
+00014750: 3b0a 2020 2020 2020 2020 2020 2020 2020  ;.              
+00014760: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00014770: 653d 2266 6f6e 742d 7369 7a65 3a20 3130  e="font-size: 10
+00014780: 7078 3b20 666f 6e74 2d66 616d 696c 793a  px; font-family:
+00014790: 204d 6f6e 6163 6f2c 206d 6f6e 6f73 7061   Monaco, monospa
+000147a0: 6365 3b22 3e40 696e 5f70 726f 6365 7373  ce;">@in_process
+000147b0: 696e 673c 2f73 7061 6e3e 0a20 2020 2020  ing</span>.     
+000147c0: 2020 2020 2020 2020 2020 203c 2f64 6976             </div
+000147d0: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+000147e0: 2020 3c64 6976 2073 7479 6c65 3d22 6d61    <div style="ma
+000147f0: 7267 696e 2d6c 6566 743a 2032 656d 3b22  rgin-left: 2em;"
+00014800: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+00014810: 2020 2020 2020 3c73 7061 6e20 7374 796c        <span styl
+00014820: 653d 2266 6f6e 742d 7369 7a65 3a20 3132  e="font-size: 12
+00014830: 7078 3b20 666f 6e74 2d77 6569 6768 743a  px; font-weight:
+00014840: 2062 6f6c 643b 223e 496e 206d 656d 6f72   bold;">In memor
+00014850: 793a 3c2f 7370 616e 3e26 6e62 7370 3b0a  y:</span>&nbsp;.
+00014860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014870: 2020 2020 3c73 7061 6e20 7374 796c 653d      <span style=
+00014880: 2266 6f6e 742d 7369 7a65 3a20 3130 7078  "font-size: 10px
+00014890: 3b20 666f 6e74 2d66 616d 696c 793a 204d  ; font-family: M
+000148a0: 6f6e 6163 6f2c 206d 6f6e 6f73 7061 6365  onaco, monospace
+000148b0: 3b22 3e40 696e 5f6d 656d 6f72 793c 2f73  ;">@in_memory</s
+000148c0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+000148d0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+000148e0: 2020 2020 2020 2020 2020 2020 3c64 6976              <div
+000148f0: 2073 7479 6c65 3d22 6d61 7267 696e 2d6c   style="margin-l
+00014900: 6566 743a 2032 656d 3b22 3e0a 2020 2020  eft: 2em;">.    
+00014910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014920: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
+00014930: 742d 7369 7a65 3a20 3132 7078 3b20 666f  t-size: 12px; fo
+00014940: 6e74 2d77 6569 6768 743a 2062 6f6c 643b  nt-weight: bold;
+00014950: 223e 4572 7265 643a 3c2f 7370 616e 3e26  ">Erred:</span>&
+00014960: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
+00014970: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+00014980: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+00014990: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
+000149a0: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
+000149b0: 6f73 7061 6365 3b22 3e40 696e 5f65 7272  ospace;">@in_err
+000149c0: 6564 3c2f 7370 616e 3e0a 2020 2020 2020  ed</span>.      
+000149d0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+000149e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000149f0: 203c 6469 7620 7374 796c 653d 226d 6172   <div style="mar
+00014a00: 6769 6e2d 6c65 6674 3a20 3265 6d3b 223e  gin-left: 2em;">
+00014a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014a20: 2020 2020 203c 7370 616e 2073 7479 6c65       <span style
+00014a30: 3d22 666f 6e74 2d73 697a 653a 2031 3270  ="font-size: 12p
+00014a40: 783b 2066 6f6e 742d 7765 6967 6874 3a20  x; font-weight: 
+00014a50: 626f 6c64 3b22 3e52 656c 6561 7365 643a  bold;">Released:
+00014a60: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
+00014a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014a80: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
+00014a90: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
+00014aa0: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
+00014ab0: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
+00014ac0: 3e40 696e 5f72 656c 6561 7365 643c 2f73  >@in_released</s
+00014ad0: 7061 6e3e 0a20 2020 2020 2020 2020 2020  pan>.           
+00014ae0: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00014af0: 2020 2020 2020 2020 2020 2020 2222 222c              """,
+00014b00: 0a20 2020 2020 2020 2020 2020 2072 656e  .            ren
+00014b10: 6465 7265 7273 3d5b 7265 6374 5d2c 0a20  derers=[rect],. 
+00014b20: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00014b30: 2020 7365 6c66 2e72 6f6f 742e 6164 645f    self.root.add_
+00014b40: 746f 6f6c 7328 686f 7665 7229 0a0a 2020  tools(hover)..  
+00014b50: 2020 4077 6974 686f 7574 5f70 726f 7065    @without_prope
+00014b60: 7274 795f 7661 6c69 6461 7469 6f6e 0a20  rty_validation. 
+00014b70: 2020 2040 6c6f 675f 6572 726f 7273 0a20     @log_errors. 
+00014b80: 2020 2064 6566 2075 7064 6174 655f 6c61     def update_la
+00014b90: 796f 7574 2873 656c 6629 3a0a 2020 2020  yout(self):.    
+00014ba0: 2020 2020 2320 4765 7420 6465 7065 6e64      # Get depend
+00014bb0: 656e 6369 6573 2070 6572 2074 6173 6b20  encies per task 
+00014bc0: 6772 6f75 702e 0a20 2020 2020 2020 2023  group..        #
+00014bd0: 2049 6e20 736f 6d65 2063 6173 6573 2074   In some cases t
+00014be0: 6865 7265 2061 7265 2074 6720 7468 6174  here are tg that
+00014bf0: 2068 6176 6520 7468 656d 7365 6c76 6573   have themselves
+00014c00: 2061 7320 6465 7065 6e64 656e 6369 6573   as dependencies
+00014c10: 202d 2077 6520 7265 6d6f 7665 2074 686f   - we remove tho
+00014c20: 7365 2e0a 2020 2020 2020 2020 6465 7065  se..        depe
+00014c30: 6e64 656e 6369 6573 203d 207b 0a20 2020  ndencies = {.   
+00014c40: 2020 2020 2020 2020 206b 3a20 7b64 732e           k: {ds.
+00014c50: 6e61 6d65 2066 6f72 2064 7320 696e 2074  name for ds in t
+00014c60: 732e 6465 7065 6e64 656e 6369 6573 2069  s.dependencies i
+00014c70: 6620 6473 2e6e 616d 6520 213d 206b 7d0a  f ds.name != k}.
+00014c80: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00014c90: 6b2c 2074 7320 696e 2073 656c 662e 7363  k, ts in self.sc
+00014ca0: 6865 6475 6c65 722e 7461 736b 5f67 726f  heduler.task_gro
+00014cb0: 7570 732e 6974 656d 7328 290a 2020 2020  ups.items().    
+00014cc0: 2020 2020 7d0a 0a20 2020 2020 2020 2069      }..        i
+00014cd0: 6d70 6f72 7420 6461 736b 0a0a 2020 2020  mport dask..    
+00014ce0: 2020 2020 6f72 6465 7220 3d20 6461 736b      order = dask
+00014cf0: 2e6f 7264 6572 2e6f 7264 6572 280a 2020  .order.order(.  
+00014d00: 2020 2020 2020 2020 2020 6473 6b3d 7b67            dsk={g
+00014d10: 726f 7570 2e6e 616d 653a 2031 2066 6f72  roup.name: 1 for
+00014d20: 206b 2c20 6772 6f75 7020 696e 2073 656c   k, group in sel
+00014d30: 662e 7363 6865 6475 6c65 722e 7461 736b  f.scheduler.task
+00014d40: 5f67 726f 7570 732e 6974 656d 7328 297d  _groups.items()}
+00014d50: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
+00014d60: 7065 6e64 656e 6369 6573 3d64 6570 656e  pendencies=depen
+00014d70: 6465 6e63 6965 732c 0a20 2020 2020 2020  dencies,.       
+00014d80: 2029 0a0a 2020 2020 2020 2020 6f72 6465   )..        orde
+00014d90: 7265 6420 3d20 736f 7274 6564 2873 656c  red = sorted(sel
+00014da0: 662e 7363 6865 6475 6c65 722e 7461 736b  f.scheduler.task
+00014db0: 5f67 726f 7570 732c 206b 6579 3d6f 7264  _groups, key=ord
+00014dc0: 6572 2e67 6574 290a 0a20 2020 2020 2020  er.get)..       
+00014dd0: 2078 7320 3d20 7b7d 0a20 2020 2020 2020   xs = {}.       
+00014de0: 2079 7320 3d20 7b7d 0a20 2020 2020 2020   ys = {}.       
+00014df0: 206c 6f63 6174 696f 6e73 203d 2073 6574   locations = set
+00014e00: 2829 0a20 2020 2020 2020 206e 6f64 6573  ().        nodes
+00014e10: 5f6c 6179 6f75 7420 3d20 7b7d 0a20 2020  _layout = {}.   
+00014e20: 2020 2020 2061 7272 6f77 735f 6c61 796f       arrows_layo
+00014e30: 7574 203d 207b 7d0a 2020 2020 2020 2020  ut = {}.        
+00014e40: 666f 7220 7467 2069 6e20 6f72 6465 7265  for tg in ordere
+00014e50: 643a 0a20 2020 2020 2020 2020 2020 2069  d:.            i
+00014e60: 6620 6465 7065 6e64 656e 6369 6573 5b74  f dependencies[t
+00014e70: 675d 3a0a 2020 2020 2020 2020 2020 2020  g]:.            
+00014e80: 2020 2020 7820 3d20 6d61 7828 7873 5b64      x = max(xs[d
+00014e90: 6570 5d20 666f 7220 6465 7020 696e 2064  ep] for dep in d
+00014ea0: 6570 656e 6465 6e63 6965 735b 7467 5d29  ependencies[tg])
+00014eb0: 202b 2031 0a20 2020 2020 2020 2020 2020   + 1.           
+00014ec0: 2020 2020 2079 203d 206d 6178 2879 735b       y = max(ys[
+00014ed0: 6465 705d 2066 6f72 2064 6570 2069 6e20  dep] for dep in 
+00014ee0: 6465 7065 6e64 656e 6369 6573 5b74 675d  dependencies[tg]
+00014ef0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00014f00: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
+00014f10: 2020 2020 2020 2020 2020 206c 656e 2864             len(d
+00014f20: 6570 656e 6465 6e63 6965 735b 7467 5d29  ependencies[tg])
+00014f30: 203e 2031 0a20 2020 2020 2020 2020 2020   > 1.           
+00014f40: 2020 2020 2020 2020 2061 6e64 206c 656e           and len
+00014f50: 287b 7973 5b64 6570 5d20 666f 7220 6465  ({ys[dep] for de
+00014f60: 7020 696e 2064 6570 656e 6465 6e63 6965  p in dependencie
+00014f70: 735b 7467 5d7d 2920 3d3d 2031 0a20 2020  s[tg]}) == 1.   
+00014f80: 2020 2020 2020 2020 2020 2020 2029 3a0a               ):.
+00014f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014fa0: 2020 2020 7920 2b3d 2031 0a20 2020 2020      y += 1.     
+00014fb0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00014fc0: 2020 2020 2020 2020 2020 2020 2078 203d               x =
+00014fd0: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
+00014fe0: 2020 2079 203d 206d 6178 2879 732e 7661     y = max(ys.va
+00014ff0: 6c75 6573 2829 2920 2b20 3120 6966 2079  lues()) + 1 if y
+00015000: 7320 656c 7365 2030 0a0a 2020 2020 2020  s else 0..      
+00015010: 2020 2020 2020 7768 696c 6520 2878 2c20        while (x, 
+00015020: 7929 2069 6e20 6c6f 6361 7469 6f6e 733a  y) in locations:
+00015030: 2020 2320 6176 6f69 6420 636f 6c6c 6973    # avoid collis
+00015040: 696f 6e73 2062 7920 6d6f 7669 6e67 2075  ions by moving u
+00015050: 700a 2020 2020 2020 2020 2020 2020 2020  p.              
+00015060: 2020 7920 2b3d 2031 0a0a 2020 2020 2020    y += 1..      
+00015070: 2020 2020 2020 6c6f 6361 7469 6f6e 732e        locations.
+00015080: 6164 6428 2878 2c20 7929 290a 0a20 2020  add((x, y))..   
+00015090: 2020 2020 2020 2020 2078 735b 7467 5d2c           xs[tg],
+000150a0: 2079 735b 7467 5d20 3d20 782c 2079 0a0a   ys[tg] = x, y..
+000150b0: 2020 2020 2020 2020 2020 2020 2320 696e              # in
+000150c0: 666f 206e 6565 6465 6420 666f 7220 6e6f  fo needed for no
+000150d0: 6465 206c 6179 6f75 7420 746f 2063 6f6c  de layout to col
+000150e0: 756d 6e20 6461 7461 2073 6f75 7263 650a  umn data source.
+000150f0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+00015100: 735f 6c61 796f 7574 5b74 675d 203d 207b  s_layout[tg] = {
+00015110: 2278 223a 2078 735b 7467 5d2c 2022 7922  "x": xs[tg], "y"
+00015120: 3a20 7973 5b74 675d 7d0a 0a20 2020 2020  : ys[tg]}..     
+00015130: 2020 2020 2020 2023 2069 6e66 6f20 6e65         # info ne
+00015140: 6564 6564 2066 6f72 2061 7272 6f77 206c  eded for arrow l
+00015150: 6179 6f75 740a 2020 2020 2020 2020 2020  ayout.          
+00015160: 2020 6172 726f 7773 5f6c 6179 6f75 745b    arrows_layout[
+00015170: 7467 5d20 3d20 7b0a 2020 2020 2020 2020  tg] = {.        
+00015180: 2020 2020 2020 2020 226e 7374 6172 7422          "nstart"
+00015190: 3a20 6465 7065 6e64 656e 6369 6573 5b74  : dependencies[t
+000151a0: 675d 2c0a 2020 2020 2020 2020 2020 2020  g],.            
+000151b0: 2020 2020 226e 656e 6422 3a20 5b74 675d      "nend": [tg]
+000151c0: 202a 206c 656e 2864 6570 656e 6465 6e63   * len(dependenc
+000151d0: 6965 735b 7467 5d29 2c0a 2020 2020 2020  ies[tg]),.      
+000151e0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+000151f0: 2072 6574 7572 6e20 6e6f 6465 735f 6c61   return nodes_la
+00015200: 796f 7574 2c20 6172 726f 7773 5f6c 6179  yout, arrows_lay
+00015210: 6f75 740a 0a20 2020 2064 6566 2063 6f6d  out..    def com
+00015220: 7075 7465 5f73 697a 6528 7365 6c66 2c20  pute_size(self, 
+00015230: 782c 206d 696e 5f62 6f78 2c20 6d61 785f  x, min_box, max_
+00015240: 626f 7829 3a0a 2020 2020 2020 2020 7374  box):.        st
+00015250: 6172 7420 3d20 302e 340a 2020 2020 2020  art = 0.4.      
+00015260: 2020 656e 6420 3d20 302e 380a 0a20 2020    end = 0.8..   
+00015270: 2020 2020 2079 203d 2028 656e 6420 2d20       y = (end - 
+00015280: 7374 6172 7429 202f 2028 6d61 785f 626f  start) / (max_bo
+00015290: 7820 2d20 6d69 6e5f 626f 7829 202a 2028  x - min_box) * (
+000152a0: 7820 2d20 6d69 6e5f 626f 7829 202b 2073  x - min_box) + s
+000152b0: 7461 7274 0a0a 2020 2020 2020 2020 7265  tart..        re
+000152c0: 7475 726e 2079 0a0a 2020 2020 4077 6974  turn y..    @wit
+000152d0: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+000152e0: 6c69 6461 7469 6f6e 0a20 2020 2064 6566  lidation.    def
+000152f0: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
+00015300: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+00015310: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
+00015320: 696f 6e5f 636f 756e 7465 7220 3d3d 2073  ion_counter == s
+00015330: 656c 662e 6f6c 645f 636f 756e 7465 723a  elf.old_counter:
+00015340: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00015350: 7572 6e0a 2020 2020 2020 2020 7365 6c66  urn.        self
+00015360: 2e6f 6c64 5f63 6f75 6e74 6572 203d 2073  .old_counter = s
+00015370: 656c 662e 7363 6865 6475 6c65 722e 7472  elf.scheduler.tr
+00015380: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00015390: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+000153a0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+000153b0: 7461 736b 5f67 726f 7570 733a 0a20 2020  task_groups:.   
+000153c0: 2020 2020 2020 2020 2073 656c 662e 7375           self.su
+000153d0: 6274 6974 6c65 2e74 6578 7420 3d20 2253  btitle.text = "S
+000153e0: 6368 6564 756c 6572 2069 7320 656d 7074  cheduler is empt
+000153f0: 792e 220a 2020 2020 2020 2020 656c 7365  y.".        else
+00015400: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00015410: 6c66 2e73 7562 7469 746c 652e 7465 7874  lf.subtitle.text
+00015420: 203d 2022 2022 0a0a 2020 2020 2020 2020   = " "..        
+00015430: 6966 2073 656c 662e 6e6f 6465 735f 6c61  if self.nodes_la
+00015440: 796f 7574 2e6b 6579 7328 2920 213d 2073  yout.keys() != s
+00015450: 656c 662e 7363 6865 6475 6c65 722e 7461  elf.scheduler.ta
+00015460: 736b 5f67 726f 7570 732e 6b65 7973 2829  sk_groups.keys()
+00015470: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00015480: 6c66 2e6e 6f64 6573 5f6c 6179 6f75 742c  lf.nodes_layout,
+00015490: 2073 656c 662e 6172 726f 7773 5f6c 6179   self.arrows_lay
+000154a0: 6f75 7420 3d20 7365 6c66 2e75 7064 6174  out = self.updat
+000154b0: 655f 6c61 796f 7574 2829 0a0a 2020 2020  e_layout()..    
+000154c0: 2020 2020 6e6f 6465 735f 6461 7461 203d      nodes_data =
+000154d0: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+000154e0: 7822 3a20 5b5d 2c0a 2020 2020 2020 2020  x": [],.        
+000154f0: 2020 2020 2279 223a 205b 5d2c 0a20 2020      "y": [],.   
+00015500: 2020 2020 2020 2020 2022 775f 626f 7822           "w_box"
+00015510: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00015520: 2020 2268 5f62 6f78 223a 205b 5d2c 0a20    "h_box": [],. 
+00015530: 2020 2020 2020 2020 2020 2022 6e61 6d65             "name
+00015540: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00015550: 2020 2022 636f 6c6f 7222 3a20 5b5d 2c0a     "color": [],.
+00015560: 2020 2020 2020 2020 2020 2020 2274 6f74              "tot
+00015570: 5f74 6173 6b73 223a 205b 5d2c 0a20 2020  _tasks": [],.   
+00015580: 2020 2020 2020 2020 2022 785f 7374 6172           "x_star
+00015590: 7422 3a20 5b5d 2c0a 2020 2020 2020 2020  t": [],.        
+000155a0: 2020 2020 2278 5f65 6e64 223a 205b 5d2c      "x_end": [],
+000155b0: 0a20 2020 2020 2020 2020 2020 2022 795f  .            "y_
+000155c0: 7374 6172 7422 3a20 5b5d 2c0a 2020 2020  start": [],.    
+000155d0: 2020 2020 2020 2020 2279 5f65 6e64 223a          "y_end":
+000155e0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000155f0: 2022 785f 656e 645f 7072 6f67 7265 7373   "x_end_progress
+00015600: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00015610: 2020 2022 6d65 6d5f 616c 7068 6122 3a20     "mem_alpha": 
+00015620: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00015630: 226e 6f64 655f 6c69 6e65 5f77 6964 7468  "node_line_width
+00015640: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00015650: 2020 2022 636f 6d70 5f74 6173 6b73 223a     "comp_tasks":
+00015660: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00015670: 2022 7572 6c5f 6c6f 676f 223a 205b 5d2c   "url_logo": [],
+00015680: 0a20 2020 2020 2020 2020 2020 2022 785f  .            "x_
+00015690: 6c6f 676f 223a 205b 5d2c 0a20 2020 2020  logo": [],.     
+000156a0: 2020 2020 2020 2022 795f 6c6f 676f 223a         "y_logo":
+000156b0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000156c0: 2022 775f 6c6f 676f 223a 205b 5d2c 0a20   "w_logo": [],. 
+000156d0: 2020 2020 2020 2020 2020 2022 685f 6c6f             "h_lo
+000156e0: 676f 223a 205b 5d2c 0a20 2020 2020 2020  go": [],.       
+000156f0: 2020 2020 2022 696e 5f70 726f 6365 7373       "in_process
+00015700: 696e 6722 3a20 5b5d 2c0a 2020 2020 2020  ing": [],.      
+00015710: 2020 2020 2020 2269 6e5f 6d65 6d6f 7279        "in_memory
+00015720: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00015730: 2020 2022 696e 5f72 656c 6561 7365 6422     "in_released"
+00015740: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
+00015750: 2020 2269 6e5f 6572 7265 6422 3a20 5b5d    "in_erred": []
+00015760: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
+00015770: 6f6d 7075 7465 5f74 696d 6522 3a20 5b5d  ompute_time": []
+00015780: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+00015790: 656d 6f72 7922 3a20 5b5d 2c0a 2020 2020  emory": [],.    
+000157a0: 2020 2020 7d0a 0a20 2020 2020 2020 2061      }..        a
+000157b0: 7272 6f77 735f 6461 7461 203d 207b 0a20  rrows_data = {. 
+000157c0: 2020 2020 2020 2020 2020 2022 7873 223a             "xs":
+000157d0: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+000157e0: 2022 7973 223a 205b 5d2c 0a20 2020 2020   "ys": [],.     
+000157f0: 2020 2020 2020 2022 7865 223a 205b 5d2c         "xe": [],
+00015800: 0a20 2020 2020 2020 2020 2020 2022 7965  .            "ye
+00015810: 223a 205b 5d2c 0a20 2020 2020 2020 207d  ": [],.        }
+00015820: 0a0a 2020 2020 2020 2020 6475 7261 7469  ..        durati
+00015830: 6f6e 7320 3d20 7365 7428 290a 2020 2020  ons = set().    
+00015840: 2020 2020 6e62 7974 6573 203d 2073 6574      nbytes = set
+00015850: 2829 0a20 2020 2020 2020 2066 6f72 2074  ().        for t
+00015860: 6720 696e 2073 656c 662e 7363 6865 6475  g in self.schedu
+00015870: 6c65 722e 7461 736b 5f67 726f 7570 732e  ler.task_groups.
+00015880: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
+00015890: 2020 2020 2020 6966 2074 672e 6475 7261        if tg.dura
+000158a0: 7469 6f6e 2061 6e64 2074 672e 6e62 7974  tion and tg.nbyt
+000158b0: 6573 5f74 6f74 616c 3a0a 2020 2020 2020  es_total:.      
+000158c0: 2020 2020 2020 2020 2020 6475 7261 7469            durati
+000158d0: 6f6e 732e 6164 6428 7467 2e64 7572 6174  ons.add(tg.durat
+000158e0: 696f 6e29 0a20 2020 2020 2020 2020 2020  ion).           
+000158f0: 2020 2020 206e 6279 7465 732e 6164 6428       nbytes.add(
+00015900: 7467 2e6e 6279 7465 735f 746f 7461 6c29  tg.nbytes_total)
+00015910: 0a0a 2020 2020 2020 2020 6475 7261 7469  ..        durati
+00015920: 6f6e 735f 6d69 6e20 3d20 6d69 6e28 6475  ons_min = min(du
+00015930: 7261 7469 6f6e 732c 2064 6566 6175 6c74  rations, default
+00015940: 3d30 290a 2020 2020 2020 2020 6475 7261  =0).        dura
+00015950: 7469 6f6e 735f 6d61 7820 3d20 6d61 7828  tions_max = max(
+00015960: 6475 7261 7469 6f6e 732c 2064 6566 6175  durations, defau
+00015970: 6c74 3d30 290a 2020 2020 2020 2020 6e62  lt=0).        nb
+00015980: 7974 6573 5f6d 696e 203d 206d 696e 286e  ytes_min = min(n
+00015990: 6279 7465 732c 2064 6566 6175 6c74 3d30  bytes, default=0
+000159a0: 290a 2020 2020 2020 2020 6e62 7974 6573  ).        nbytes
+000159b0: 5f6d 6178 203d 206d 6178 286e 6279 7465  _max = max(nbyte
+000159c0: 732c 2064 6566 6175 6c74 3d30 290a 0a20  s, default=0).. 
+000159d0: 2020 2020 2020 2062 6f78 5f64 696d 203d         box_dim =
+000159e0: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
+000159f0: 6b65 792c 2074 6720 696e 2073 656c 662e  key, tg in self.
+00015a00: 7363 6865 6475 6c65 722e 7461 736b 5f67  scheduler.task_g
+00015a10: 726f 7570 732e 6974 656d 7328 293a 0a20  roups.items():. 
+00015a20: 2020 2020 2020 2020 2020 2063 6f6d 705f             comp_
+00015a30: 7461 736b 7320 3d20 280a 2020 2020 2020  tasks = (.      
+00015a40: 2020 2020 2020 2020 2020 7467 2e73 7461            tg.sta
+00015a50: 7465 735b 2272 656c 6561 7365 6422 5d20  tes["released"] 
+00015a60: 2b20 7467 2e73 7461 7465 735b 226d 656d  + tg.states["mem
+00015a70: 6f72 7922 5d20 2b20 7467 2e73 7461 7465  ory"] + tg.state
+00015a80: 735b 2265 7272 6564 225d 0a20 2020 2020  s["erred"].     
+00015a90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00015aa0: 2020 2020 2074 6f74 5f74 6173 6b73 203d       tot_tasks =
+00015ab0: 2073 756d 2874 672e 7374 6174 6573 2e76   sum(tg.states.v
+00015ac0: 616c 7565 7328 2929 0a0a 2020 2020 2020  alues())..      
+00015ad0: 2020 2020 2020 2320 636f 6d70 7574 6520        # compute 
+00015ae0: 7769 6474 6820 616e 6420 6865 6967 6874  width and height
+00015af0: 206f 6620 626f 7865 730a 2020 2020 2020   of boxes.      
+00015b00: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
+00015b10: 2020 2020 2020 2020 2020 2074 672e 6475             tg.du
+00015b20: 7261 7469 6f6e 0a20 2020 2020 2020 2020  ration.         
+00015b30: 2020 2020 2020 2061 6e64 2074 672e 6e62         and tg.nb
+00015b40: 7974 6573 5f74 6f74 616c 0a20 2020 2020  ytes_total.     
+00015b50: 2020 2020 2020 2020 2020 2061 6e64 2063             and c
+00015b60: 6f6d 705f 7461 736b 730a 2020 2020 2020  omp_tasks.      
+00015b70: 2020 2020 2020 2020 2020 616e 6420 6c65            and le
+00015b80: 6e28 6475 7261 7469 6f6e 7329 203e 2031  n(durations) > 1
+00015b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015ba0: 2061 6e64 206c 656e 286e 6279 7465 7329   and len(nbytes)
+00015bb0: 203e 2031 0a20 2020 2020 2020 2020 2020   > 1.           
+00015bc0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00015bd0: 2020 2020 2320 7363 616c 6520 6475 7261      # scale dura
+00015be0: 7469 6f6e 2028 7769 6474 6829 0a20 2020  tion (width).   
+00015bf0: 2020 2020 2020 2020 2020 2020 2077 6964               wid
+00015c00: 7468 5f62 6f78 203d 2073 656c 662e 636f  th_box = self.co
+00015c10: 6d70 7574 655f 7369 7a65 280a 2020 2020  mpute_size(.    
+00015c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015c30: 7467 2e64 7572 6174 696f 6e20 2f20 636f  tg.duration / co
+00015c40: 6d70 5f74 6173 6b73 202a 2074 6f74 5f74  mp_tasks * tot_t
+00015c50: 6173 6b73 2c0a 2020 2020 2020 2020 2020  asks,.          
+00015c60: 2020 2020 2020 2020 2020 6d69 6e5f 626f            min_bo
+00015c70: 783d 6475 7261 7469 6f6e 735f 6d69 6e20  x=durations_min 
+00015c80: 2f20 636f 6d70 5f74 6173 6b73 202a 2074  / comp_tasks * t
+00015c90: 6f74 5f74 6173 6b73 2c0a 2020 2020 2020  ot_tasks,.      
+00015ca0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00015cb0: 785f 626f 783d 6475 7261 7469 6f6e 735f  x_box=durations_
+00015cc0: 6d61 7820 2f20 636f 6d70 5f74 6173 6b73  max / comp_tasks
+00015cd0: 202a 2074 6f74 5f74 6173 6b73 2c0a 2020   * tot_tasks,.  
+00015ce0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00015cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015d00: 2023 206e 6565 6420 746f 2073 6361 6c65   # need to scale
+00015d10: 206d 656d 6f72 7920 2868 6569 6768 7429   memory (height)
+00015d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015d30: 2068 6569 6768 745f 626f 7820 3d20 7365   height_box = se
+00015d40: 6c66 2e63 6f6d 7075 7465 5f73 697a 6528  lf.compute_size(
+00015d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015d60: 2020 2020 2074 672e 6e62 7974 6573 5f74       tg.nbytes_t
+00015d70: 6f74 616c 202f 2063 6f6d 705f 7461 736b  otal / comp_task
+00015d80: 7320 2a20 746f 745f 7461 736b 732c 0a20  s * tot_tasks,. 
+00015d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015da0: 2020 206d 696e 5f62 6f78 3d6e 6279 7465     min_box=nbyte
+00015db0: 735f 6d69 6e20 2f20 636f 6d70 5f74 6173  s_min / comp_tas
+00015dc0: 6b73 202a 2074 6f74 5f74 6173 6b73 2c0a  ks * tot_tasks,.
+00015dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015de0: 2020 2020 6d61 785f 626f 783d 6e62 7974      max_box=nbyt
+00015df0: 6573 5f6d 6178 202f 2063 6f6d 705f 7461  es_max / comp_ta
+00015e00: 736b 7320 2a20 746f 745f 7461 736b 732c  sks * tot_tasks,
+00015e10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015e20: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
+00015e30: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00015e40: 2020 2020 2020 7769 6474 685f 626f 7820        width_box 
+00015e50: 3d20 302e 360a 2020 2020 2020 2020 2020  = 0.6.          
+00015e60: 2020 2020 2020 6865 6967 6874 5f62 6f78        height_box
+00015e70: 203d 2077 6964 7468 5f62 6f78 202f 2032   = width_box / 2
+00015e80: 0a0a 2020 2020 2020 2020 2020 2020 626f  ..            bo
+00015e90: 785f 6469 6d5b 6b65 795d 203d 207b 2277  x_dim[key] = {"w
+00015ea0: 6964 7468 223a 2077 6964 7468 5f62 6f78  idth": width_box
+00015eb0: 2c20 2268 6569 6768 7422 3a20 6865 6967  , "height": heig
+00015ec0: 6874 5f62 6f78 7d0a 0a20 2020 2020 2020  ht_box}..       
+00015ed0: 2066 6f72 206b 6579 2c20 7467 2069 6e20   for key, tg in 
+00015ee0: 7365 6c66 2e73 6368 6564 756c 6572 2e74  self.scheduler.t
+00015ef0: 6173 6b5f 6772 6f75 7073 2e69 7465 6d73  ask_groups.items
+00015f00: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00015f10: 7820 3d20 7365 6c66 2e6e 6f64 6573 5f6c  x = self.nodes_l
+00015f20: 6179 6f75 745b 6b65 795d 5b22 7822 5d0a  ayout[key]["x"].
+00015f30: 2020 2020 2020 2020 2020 2020 7920 3d20              y = 
+00015f40: 7365 6c66 2e6e 6f64 6573 5f6c 6179 6f75  self.nodes_layou
+00015f50: 745b 6b65 795d 5b22 7922 5d0a 2020 2020  t[key]["y"].    
+00015f60: 2020 2020 2020 2020 7769 6474 6820 3d20          width = 
+00015f70: 626f 785f 6469 6d5b 6b65 795d 5b22 7769  box_dim[key]["wi
+00015f80: 6474 6822 5d0a 2020 2020 2020 2020 2020  dth"].          
+00015f90: 2020 6865 6967 6874 203d 2062 6f78 5f64    height = box_d
+00015fa0: 696d 5b6b 6579 5d5b 2268 6569 6768 7422  im[key]["height"
+00015fb0: 5d0a 0a20 2020 2020 2020 2020 2020 2023  ]..            #
+00015fc0: 206d 6169 6e20 626f 7865 7320 6c61 796f   main boxes layo
+00015fd0: 7574 0a20 2020 2020 2020 2020 2020 206e  ut.            n
+00015fe0: 6f64 6573 5f64 6174 615b 2278 225d 2e61  odes_data["x"].a
+00015ff0: 7070 656e 6428 7829 0a20 2020 2020 2020  ppend(x).       
+00016000: 2020 2020 206e 6f64 6573 5f64 6174 615b       nodes_data[
+00016010: 2279 225d 2e61 7070 656e 6428 7929 0a20  "y"].append(y). 
+00016020: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00016030: 5f64 6174 615b 2277 5f62 6f78 225d 2e61  _data["w_box"].a
+00016040: 7070 656e 6428 7769 6474 6829 0a20 2020  ppend(width).   
+00016050: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
+00016060: 6174 615b 2268 5f62 6f78 225d 2e61 7070  ata["h_box"].app
+00016070: 656e 6428 6865 6967 6874 290a 0a20 2020  end(height)..   
+00016080: 2020 2020 2020 2020 2063 6f6d 705f 7461           comp_ta
+00016090: 736b 7320 3d20 280a 2020 2020 2020 2020  sks = (.        
+000160a0: 2020 2020 2020 2020 7467 2e73 7461 7465          tg.state
+000160b0: 735b 2272 656c 6561 7365 6422 5d20 2b20  s["released"] + 
+000160c0: 7467 2e73 7461 7465 735b 226d 656d 6f72  tg.states["memor
+000160d0: 7922 5d20 2b20 7467 2e73 7461 7465 735b  y"] + tg.states[
+000160e0: 2265 7272 6564 225d 0a20 2020 2020 2020  "erred"].       
+000160f0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00016100: 2020 2074 6f74 5f74 6173 6b73 203d 2073     tot_tasks = s
+00016110: 756d 2874 672e 7374 6174 6573 2e76 616c  um(tg.states.val
+00016120: 7565 7328 2929 0a0a 2020 2020 2020 2020  ues())..        
+00016130: 2020 2020 6e6f 6465 735f 6461 7461 5b22      nodes_data["
+00016140: 6e61 6d65 225d 2e61 7070 656e 6428 7467  name"].append(tg
+00016150: 2e70 7265 6669 782e 6e61 6d65 290a 0a20  .prefix.name).. 
+00016160: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00016170: 5f64 6174 615b 2263 6f6c 6f72 225d 2e61  _data["color"].a
+00016180: 7070 656e 6428 636f 6c6f 725f 6f66 2874  ppend(color_of(t
+00016190: 672e 7072 6566 6978 2e6e 616d 6529 290a  g.prefix.name)).
+000161a0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+000161b0: 735f 6461 7461 5b22 746f 745f 7461 736b  s_data["tot_task
+000161c0: 7322 5d2e 6170 7065 6e64 2874 6f74 5f74  s"].append(tot_t
+000161d0: 6173 6b73 290a 0a20 2020 2020 2020 2020  asks)..         
+000161e0: 2020 2023 206d 656d 6f72 7920 616c 7068     # memory alph
+000161f0: 6120 6661 6374 6f72 2062 7920 302e 3420  a factor by 0.4 
+00016200: 6966 206e 6f74 2067 6574 2773 2074 6f6f  if not get's too
+00016210: 2064 6172 6b0a 2020 2020 2020 2020 2020   dark.          
+00016220: 2020 6e6f 6465 735f 6461 7461 5b22 6d65    nodes_data["me
+00016230: 6d5f 616c 7068 6122 5d2e 6170 7065 6e64  m_alpha"].append
+00016240: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00016250: 2020 2874 672e 7374 6174 6573 5b22 6d65    (tg.states["me
+00016260: 6d6f 7279 225d 202f 2073 756d 2874 672e  mory"] / sum(tg.
+00016270: 7374 6174 6573 2e76 616c 7565 7328 2929  states.values())
+00016280: 2920 2a20 302e 340a 2020 2020 2020 2020  ) * 0.4.        
+00016290: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
+000162a0: 2020 2023 206d 6169 6e20 626f 7820 6c69     # main box li
+000162b0: 6e65 2077 6964 7468 0a20 2020 2020 2020  ne width.       
+000162c0: 2020 2020 2069 6620 7467 2e73 7461 7465       if tg.state
+000162d0: 735b 2270 726f 6365 7373 696e 6722 5d3a  s["processing"]:
+000162e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000162f0: 206e 6f64 6573 5f64 6174 615b 226e 6f64   nodes_data["nod
+00016300: 655f 6c69 6e65 5f77 6964 7468 225d 2e61  e_line_width"].a
+00016310: 7070 656e 6428 3529 0a20 2020 2020 2020  ppend(5).       
+00016320: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00016330: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00016340: 5f64 6174 615b 226e 6f64 655f 6c69 6e65  _data["node_line
+00016350: 5f77 6964 7468 225d 2e61 7070 656e 6428  _width"].append(
+00016360: 3129 0a0a 2020 2020 2020 2020 2020 2020  1)..            
+00016370: 2320 7072 6f67 7265 7373 2062 6172 2064  # progress bar d
+00016380: 6174 6120 7570 6461 7465 0a20 2020 2020  ata update.     
+00016390: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
+000163a0: 615b 2278 5f73 7461 7274 225d 2e61 7070  a["x_start"].app
+000163b0: 656e 6428 7820 2d20 7769 6474 6820 2f20  end(x - width / 
+000163c0: 3229 0a20 2020 2020 2020 2020 2020 206e  2).            n
+000163d0: 6f64 6573 5f64 6174 615b 2278 5f65 6e64  odes_data["x_end
+000163e0: 225d 2e61 7070 656e 6428 7820 2b20 7769  "].append(x + wi
+000163f0: 6474 6820 2f20 3229 0a0a 2020 2020 2020  dth / 2)..      
+00016400: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+00016410: 5b22 795f 7374 6172 7422 5d2e 6170 7065  ["y_start"].appe
+00016420: 6e64 2879 202d 2068 6569 6768 7420 2f20  nd(y - height / 
+00016430: 3229 0a20 2020 2020 2020 2020 2020 206e  2).            n
+00016440: 6f64 6573 5f64 6174 615b 2279 5f65 6e64  odes_data["y_end
+00016450: 225d 2e61 7070 656e 6428 7920 2d20 6865  "].append(y - he
+00016460: 6967 6874 202f 2032 202b 2068 6569 6768  ight / 2 + heigh
+00016470: 7420 2a20 302e 3429 0a0a 2020 2020 2020  t * 0.4)..      
+00016480: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+00016490: 5b22 785f 656e 645f 7072 6f67 7265 7373  ["x_end_progress
+000164a0: 225d 2e61 7070 656e 6428 0a20 2020 2020  "].append(.     
+000164b0: 2020 2020 2020 2020 2020 2078 202d 2077             x - w
+000164c0: 6964 7468 202f 2032 202b 2077 6964 7468  idth / 2 + width
+000164d0: 202a 2063 6f6d 705f 7461 736b 7320 2f20   * comp_tasks / 
+000164e0: 746f 745f 7461 736b 730a 2020 2020 2020  tot_tasks.      
+000164f0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00016500: 2020 2020 2023 2061 7272 6f77 730a 2020       # arrows.  
+00016510: 2020 2020 2020 2020 2020 6172 726f 7773            arrows
+00016520: 5f64 6174 615b 2278 7322 5d20 2b3d 205b  _data["xs"] += [
+00016530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016540: 2073 656c 662e 6e6f 6465 735f 6c61 796f   self.nodes_layo
+00016550: 7574 5b6b 5d5b 2278 225d 202b 2062 6f78  ut[k]["x"] + box
+00016560: 5f64 696d 5b6b 5d5b 2277 6964 7468 225d  _dim[k]["width"]
+00016570: 202f 2032 0a20 2020 2020 2020 2020 2020   / 2.           
+00016580: 2020 2020 2066 6f72 206b 2069 6e20 7365       for k in se
+00016590: 6c66 2e61 7272 6f77 735f 6c61 796f 7574  lf.arrows_layout
+000165a0: 5b6b 6579 5d5b 226e 7374 6172 7422 5d0a  [key]["nstart"].
+000165b0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+000165c0: 2020 2020 2020 2020 2020 6172 726f 7773            arrows
+000165d0: 5f64 6174 615b 2279 7322 5d20 2b3d 205b  _data["ys"] += [
+000165e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000165f0: 2073 656c 662e 6e6f 6465 735f 6c61 796f   self.nodes_layo
+00016600: 7574 5b6b 5d5b 2279 225d 2066 6f72 206b  ut[k]["y"] for k
+00016610: 2069 6e20 7365 6c66 2e61 7272 6f77 735f   in self.arrows_
+00016620: 6c61 796f 7574 5b6b 6579 5d5b 226e 7374  layout[key]["nst
+00016630: 6172 7422 5d0a 2020 2020 2020 2020 2020  art"].          
+00016640: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+00016650: 6172 726f 7773 5f64 6174 615b 2278 6522  arrows_data["xe"
+00016660: 5d20 2b3d 205b 0a20 2020 2020 2020 2020  ] += [.         
+00016670: 2020 2020 2020 2073 656c 662e 6e6f 6465         self.node
+00016680: 735f 6c61 796f 7574 5b6b 5d5b 2278 225d  s_layout[k]["x"]
+00016690: 202d 2062 6f78 5f64 696d 5b6b 5d5b 2277   - box_dim[k]["w
+000166a0: 6964 7468 225d 202f 2032 0a20 2020 2020  idth"] / 2.     
+000166b0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+000166c0: 2069 6e20 7365 6c66 2e61 7272 6f77 735f   in self.arrows_
+000166d0: 6c61 796f 7574 5b6b 6579 5d5b 226e 656e  layout[key]["nen
+000166e0: 6422 5d0a 2020 2020 2020 2020 2020 2020  d"].            
+000166f0: 5d0a 2020 2020 2020 2020 2020 2020 6172  ].            ar
+00016700: 726f 7773 5f64 6174 615b 2279 6522 5d20  rows_data["ye"] 
+00016710: 2b3d 205b 0a20 2020 2020 2020 2020 2020  += [.           
+00016720: 2020 2020 2073 656c 662e 6e6f 6465 735f       self.nodes_
+00016730: 6c61 796f 7574 5b6b 5d5b 2279 225d 2066  layout[k]["y"] f
+00016740: 6f72 206b 2069 6e20 7365 6c66 2e61 7272  or k in self.arr
+00016750: 6f77 735f 6c61 796f 7574 5b6b 6579 5d5b  ows_layout[key][
+00016760: 226e 656e 6422 5d0a 2020 2020 2020 2020  "nend"].        
+00016770: 2020 2020 5d0a 0a20 2020 2020 2020 2020      ]..         
+00016780: 2020 2023 204c 4f47 4f53 0a20 2020 2020     # LOGOS.     
+00016790: 2020 2020 2020 2069 6620 6c65 6e28 7467         if len(tg
+000167a0: 2e74 7970 6573 2920 3d3d 2031 3a0a 2020  .types) == 1:.  
+000167b0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+000167c0: 676f 5f74 7970 6520 3d20 6e65 7874 2869  go_type = next(i
+000167d0: 7465 7228 7467 2e74 7970 6573 2929 2e73  ter(tg.types)).s
+000167e0: 706c 6974 2822 2e22 295b 305d 0a20 2020  plit(".")[0].   
+000167f0: 2020 2020 2020 2020 2020 2020 2074 7279               try
+00016800: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016810: 2020 2020 2020 7572 6c5f 6c6f 676f 203d        url_logo =
+00016820: 206c 6f67 6f73 5f64 6963 745b 6c6f 676f   logos_dict[logo
+00016830: 5f74 7970 655d 0a20 2020 2020 2020 2020  _type].         
+00016840: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+00016850: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+00016860: 2020 2020 2020 2020 2020 2020 7572 6c5f              url_
+00016870: 6c6f 676f 203d 2022 220a 2020 2020 2020  logo = "".      
+00016880: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00016890: 2020 2020 2020 2020 2020 2020 7572 6c5f              url_
+000168a0: 6c6f 676f 203d 2022 220a 0a20 2020 2020  logo = ""..     
+000168b0: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
+000168c0: 615b 2275 726c 5f6c 6f67 6f22 5d2e 6170  a["url_logo"].ap
+000168d0: 7065 6e64 2875 726c 5f6c 6f67 6f29 0a0a  pend(url_logo)..
+000168e0: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
+000168f0: 735f 6461 7461 5b22 785f 6c6f 676f 225d  s_data["x_logo"]
+00016900: 2e61 7070 656e 6428 7820 2b20 7769 6474  .append(x + widt
+00016910: 6820 2f20 3329 0a20 2020 2020 2020 2020  h / 3).         
+00016920: 2020 206e 6f64 6573 5f64 6174 615b 2279     nodes_data["y
+00016930: 5f6c 6f67 6f22 5d2e 6170 7065 6e64 2879  _logo"].append(y
+00016940: 202b 2068 6569 6768 7420 2f20 3329 0a0a   + height / 3)..
+00016950: 2020 2020 2020 2020 2020 2020 7261 7469              rati
+00016960: 6f20 3d20 7769 6474 6820 2f20 6865 6967  o = width / heig
+00016970: 6874 0a0a 2020 2020 2020 2020 2020 2020  ht..            
+00016980: 6966 2072 6174 696f 203e 2031 3a0a 2020  if ratio > 1:.  
+00016990: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+000169a0: 6465 735f 6461 7461 5b22 685f 6c6f 676f  des_data["h_logo
+000169b0: 225d 2e61 7070 656e 6428 6865 6967 6874  "].append(height
+000169c0: 202a 2030 2e33 290a 2020 2020 2020 2020   * 0.3).        
+000169d0: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
+000169e0: 7461 5b22 775f 6c6f 676f 225d 2e61 7070  ta["w_logo"].app
+000169f0: 656e 6428 7769 6474 6820 2a20 302e 3320  end(width * 0.3 
+00016a00: 2f20 7261 7469 6f29 0a20 2020 2020 2020  / ratio).       
+00016a10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00016a20: 2020 2020 2020 2020 2020 206e 6f64 6573             nodes
+00016a30: 5f64 6174 615b 2268 5f6c 6f67 6f22 5d2e  _data["h_logo"].
+00016a40: 6170 7065 6e64 2868 6569 6768 7420 2a20  append(height * 
+00016a50: 302e 3320 2a20 7261 7469 6f29 0a20 2020  0.3 * ratio).   
+00016a60: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
+00016a70: 6573 5f64 6174 615b 2277 5f6c 6f67 6f22  es_data["w_logo"
+00016a80: 5d2e 6170 7065 6e64 2877 6964 7468 202a  ].append(width *
+00016a90: 2030 2e33 290a 0a20 2020 2020 2020 2020   0.3)..         
+00016aa0: 2020 2023 2063 6f6d 7075 7465 5f74 696d     # compute_tim
+00016ab0: 6520 616e 6420 6d65 6d6f 7279 0a20 2020  e and memory.   
+00016ac0: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
+00016ad0: 6174 615b 2263 6f6d 7075 7465 5f74 696d  ata["compute_tim
+00016ae0: 6522 5d2e 6170 7065 6e64 2866 6f72 6d61  e"].append(forma
+00016af0: 745f 7469 6d65 2874 672e 6475 7261 7469  t_time(tg.durati
+00016b00: 6f6e 2929 0a20 2020 2020 2020 2020 2020  on)).           
+00016b10: 206e 6f64 6573 5f64 6174 615b 226d 656d   nodes_data["mem
+00016b20: 6f72 7922 5d2e 6170 7065 6e64 2866 6f72  ory"].append(for
+00016b30: 6d61 745f 6279 7465 7328 7467 2e6e 6279  mat_bytes(tg.nby
+00016b40: 7465 735f 746f 7461 6c29 290a 0a20 2020  tes_total))..   
+00016b50: 2020 2020 2020 2020 2023 2041 6464 2073           # Add s
+00016b60: 6f6d 6520 7374 6174 7573 2074 6f20 686f  ome status to ho
+00016b70: 7665 720a 2020 2020 2020 2020 2020 2020  ver.            
+00016b80: 7461 736b 735f 7072 6f63 6573 7369 6e67  tasks_processing
+00016b90: 203d 2074 672e 7374 6174 6573 5b22 7072   = tg.states["pr
+00016ba0: 6f63 6573 7369 6e67 225d 0a20 2020 2020  ocessing"].     
+00016bb0: 2020 2020 2020 2074 6173 6b73 5f6d 656d         tasks_mem
+00016bc0: 6f72 7920 3d20 7467 2e73 7461 7465 735b  ory = tg.states[
+00016bd0: 226d 656d 6f72 7922 5d0a 2020 2020 2020  "memory"].      
+00016be0: 2020 2020 2020 7461 736b 735f 7265 6c61        tasks_rela
+00016bf0: 7365 6420 3d20 7467 2e73 7461 7465 735b  sed = tg.states[
+00016c00: 2272 656c 6561 7365 6422 5d0a 2020 2020  "released"].    
+00016c10: 2020 2020 2020 2020 7461 736b 735f 6572          tasks_er
+00016c20: 7265 6420 3d20 7467 2e73 7461 7465 735b  red = tg.states[
+00016c30: 2265 7272 6564 225d 0a0a 2020 2020 2020  "erred"]..      
+00016c40: 2020 2020 2020 6e6f 6465 735f 6461 7461        nodes_data
+00016c50: 5b22 636f 6d70 5f74 6173 6b73 225d 2e61  ["comp_tasks"].a
+00016c60: 7070 656e 6428 0a20 2020 2020 2020 2020  ppend(.         
+00016c70: 2020 2020 2020 2066 227b 636f 6d70 5f74         f"{comp_t
+00016c80: 6173 6b73 7d20 287b 636f 6d70 5f74 6173  asks} ({comp_tas
+00016c90: 6b73 202f 2074 6f74 5f74 6173 6b73 202a  ks / tot_tasks *
+00016ca0: 2031 3030 3a2e 3066 7d20 2529 220a 2020   100:.0f} %)".  
+00016cb0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00016cc0: 2020 2020 2020 2020 6e6f 6465 735f 6461          nodes_da
+00016cd0: 7461 5b22 696e 5f70 726f 6365 7373 696e  ta["in_processin
+00016ce0: 6722 5d2e 6170 7065 6e64 280a 2020 2020  g"].append(.    
+00016cf0: 2020 2020 2020 2020 2020 2020 6622 7b74              f"{t
+00016d00: 6173 6b73 5f70 726f 6365 7373 696e 677d  asks_processing}
+00016d10: 2028 7b74 6173 6b73 5f70 726f 6365 7373   ({tasks_process
+00016d20: 696e 6720 2f20 746f 745f 7461 736b 7320  ing / tot_tasks 
+00016d30: 2a20 3130 303a 2e30 667d 2025 2922 0a20  * 100:.0f} %)". 
+00016d40: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00016d50: 2020 2020 2020 2020 206e 6f64 6573 5f64           nodes_d
+00016d60: 6174 615b 2269 6e5f 6d65 6d6f 7279 225d  ata["in_memory"]
+00016d70: 2e61 7070 656e 6428 0a20 2020 2020 2020  .append(.       
+00016d80: 2020 2020 2020 2020 2066 227b 7461 736b           f"{task
+00016d90: 735f 6d65 6d6f 7279 7d20 287b 7461 736b  s_memory} ({task
+00016da0: 735f 6d65 6d6f 7279 202f 2074 6f74 5f74  s_memory / tot_t
+00016db0: 6173 6b73 202a 2031 3030 3a2e 3066 7d20  asks * 100:.0f} 
+00016dc0: 2529 220a 2020 2020 2020 2020 2020 2020  %)".            
+00016dd0: 290a 2020 2020 2020 2020 2020 2020 6e6f  ).            no
+00016de0: 6465 735f 6461 7461 5b22 696e 5f72 656c  des_data["in_rel
+00016df0: 6561 7365 6422 5d2e 6170 7065 6e64 280a  eased"].append(.
+00016e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016e10: 6622 7b74 6173 6b73 5f72 656c 6173 6564  f"{tasks_relased
+00016e20: 7d20 287b 7461 736b 735f 7265 6c61 7365  } ({tasks_relase
+00016e30: 6420 2f20 746f 745f 7461 736b 7320 2a20  d / tot_tasks * 
+00016e40: 3130 303a 2e30 667d 2025 2922 0a20 2020  100:.0f} %)".   
+00016e50: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00016e60: 2020 2020 2020 206e 6f64 6573 5f64 6174         nodes_dat
+00016e70: 615b 2269 6e5f 6572 7265 6422 5d2e 6170  a["in_erred"].ap
+00016e80: 7065 6e64 280a 2020 2020 2020 2020 2020  pend(.          
+00016e90: 2020 2020 2020 6622 7b74 6173 6b73 5f65        f"{tasks_e
+00016ea0: 7272 6564 7d20 287b 7461 736b 735f 6572  rred} ({tasks_er
+00016eb0: 7265 6420 2f20 746f 745f 7461 736b 7320  red / tot_tasks 
+00016ec0: 2a20 3130 303a 2e30 667d 2025 2922 0a20  * 100:.0f} %)". 
+00016ed0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00016ee0: 2020 2020 2020 7365 6c66 2e6e 6f64 6573        self.nodes
+00016ef0: 5f73 6f75 7263 652e 6461 7461 2e75 7064  _source.data.upd
+00016f00: 6174 6528 6e6f 6465 735f 6461 7461 290a  ate(nodes_data).
+00016f10: 2020 2020 2020 2020 7365 6c66 2e61 7272          self.arr
+00016f20: 6f77 735f 736f 7572 6365 2e64 6174 612e  ows_source.data.
+00016f30: 7570 6461 7465 2861 7272 6f77 735f 6461  update(arrows_da
+00016f40: 7461 290a 0a0a 636c 6173 7320 5461 736b  ta)...class Task
+00016f50: 4772 6f75 7050 726f 6772 6573 7328 4461  GroupProgress(Da
+00016f60: 7368 626f 6172 6443 6f6d 706f 6e65 6e74  shboardComponent
+00016f70: 293a 0a20 2020 2022 2222 5374 6163 6b65  ):.    """Stacke
+00016f80: 6420 6172 6561 2063 6861 7274 2073 686f  d area chart sho
+00016f90: 7769 6e67 2074 6173 6b20 6772 6f75 7073  wing task groups
+00016fa0: 2074 6872 6f75 6768 2074 696d 6522 2222   through time"""
+00016fb0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
+00016fc0: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
+00016fd0: 6572 2c20 2a2a 6b77 6172 6773 293a 0a20  er, **kwargs):. 
+00016fe0: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+00016ff0: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
+00017000: 720a 2020 2020 2020 2020 7365 6c66 2e73  r.        self.s
+00017010: 6f75 7263 6520 3d20 436f 6c75 6d6e 4461  ource = ColumnDa
+00017020: 7461 536f 7572 6365 2829 0a20 2020 2020  taSource().     
+00017030: 2020 2023 2054 6865 206c 656e 6774 6820     # The length 
+00017040: 6f66 2074 696d 6573 6572 6965 7320 746f  of timeseries to
+00017050: 2063 6861 7274 2028 696e 2075 6e69 7473   chart (in units
+00017060: 206f 6620 706c 7567 696e 2e64 7429 0a20   of plugin.dt). 
+00017070: 2020 2020 2020 2073 656c 662e 6e70 7473         self.npts
+00017080: 203d 2031 3830 0a0a 2020 2020 2020 2020   = 180..        
+00017090: 6966 2047 726f 7570 5469 6d69 6e67 2e6e  if GroupTiming.n
+000170a0: 616d 6520 6e6f 7420 696e 2073 6368 6564  ame not in sched
+000170b0: 756c 6572 2e70 6c75 6769 6e73 3a0a 2020  uler.plugins:.  
+000170c0: 2020 2020 2020 2020 2020 7363 6865 6475            schedu
+000170d0: 6c65 722e 6164 645f 706c 7567 696e 2870  ler.add_plugin(p
+000170e0: 6c75 6769 6e3d 4772 6f75 7054 696d 696e  lugin=GroupTimin
+000170f0: 6728 7363 6865 6475 6c65 7229 290a 0a20  g(scheduler)).. 
+00017100: 2020 2020 2020 2073 656c 662e 706c 7567         self.plug
+00017110: 696e 203d 2073 6368 6564 756c 6572 2e70  in = scheduler.p
+00017120: 6c75 6769 6e73 5b47 726f 7570 5469 6d69  lugins[GroupTimi
+00017130: 6e67 2e6e 616d 655d 0a0a 2020 2020 2020  ng.name]..      
+00017140: 2020 7365 6c66 2e73 6f75 7263 652e 6164    self.source.ad
+00017150: 6428 6e70 2e61 7272 6179 2873 656c 662e  d(np.array(self.
+00017160: 706c 7567 696e 2e74 696d 6529 202a 2031  plugin.time) * 1
+00017170: 3030 302e 302c 2022 7469 6d65 2229 0a0a  000.0, "time")..
+00017180: 2020 2020 2020 2020 785f 7261 6e67 6520          x_range 
+00017190: 3d20 4461 7461 5261 6e67 6531 6428 7261  = DataRange1d(ra
+000171a0: 6e67 655f 7061 6464 696e 673d 3029 0a20  nge_padding=0). 
+000171b0: 2020 2020 2020 2079 5f72 616e 6765 203d         y_range =
+000171c0: 2052 616e 6765 3164 2830 2c20 6d61 7828   Range1d(0, max(
+000171d0: 7365 6c66 2e70 6c75 6769 6e2e 6e74 6872  self.plugin.nthr
+000171e0: 6561 6473 2929 0a0a 2020 2020 2020 2020  eads))..        
+000171f0: 7365 6c66 2e72 6f6f 7420 3d20 6669 6775  self.root = figu
+00017200: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+00017210: 7469 746c 653d 2254 6173 6b20 4772 6f75  title="Task Grou
+00017220: 7020 5072 6f67 7265 7373 222c 0a20 2020  p Progress",.   
+00017230: 2020 2020 2020 2020 206e 616d 653d 2274           name="t
+00017240: 6173 6b5f 6772 6f75 705f 7072 6f67 7265  ask_group_progre
+00017250: 7373 222c 0a20 2020 2020 2020 2020 2020  ss",.           
+00017260: 2074 6f6f 6c62 6172 5f6c 6f63 6174 696f   toolbar_locatio
+00017270: 6e3d 2261 626f 7665 222c 0a20 2020 2020  n="above",.     
+00017280: 2020 2020 2020 206d 696e 5f62 6f72 6465         min_borde
+00017290: 725f 626f 7474 6f6d 3d35 302c 0a20 2020  r_bottom=50,.   
+000172a0: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
+000172b0: 3d78 5f72 616e 6765 2c0a 2020 2020 2020  =x_range,.      
+000172c0: 2020 2020 2020 795f 7261 6e67 653d 795f        y_range=y_
+000172d0: 7261 6e67 652c 0a20 2020 2020 2020 2020  range,.         
+000172e0: 2020 2074 6f6f 6c73 3d22 222c 0a20 2020     tools="",.   
+000172f0: 2020 2020 2020 2020 2078 5f61 7869 735f           x_axis_
+00017300: 7479 7065 3d22 6461 7465 7469 6d65 222c  type="datetime",
+00017310: 0a20 2020 2020 2020 2020 2020 2079 5f61  .            y_a
+00017320: 7869 735f 6c6f 6361 7469 6f6e 3d4e 6f6e  xis_location=Non
+00017330: 652c 0a20 2020 2020 2020 2020 2020 202a  e,.            *
+00017340: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+00017350: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+00017360: 726f 6f74 2e79 6178 6973 2e6d 616a 6f72  root.yaxis.major
+00017370: 5f6c 6162 656c 5f74 6578 745f 616c 7068  _label_text_alph
+00017380: 6120 3d20 300a 2020 2020 2020 2020 7365  a = 0.        se
+00017390: 6c66 2e72 6f6f 742e 7961 7869 732e 6d69  lf.root.yaxis.mi
+000173a0: 6e6f 725f 7469 636b 5f6c 696e 655f 616c  nor_tick_line_al
+000173b0: 7068 6120 3d20 300a 2020 2020 2020 2020  pha = 0.        
+000173c0: 7365 6c66 2e72 6f6f 742e 7961 7869 732e  self.root.yaxis.
+000173d0: 6d61 6a6f 725f 7469 636b 5f6c 696e 655f  major_tick_line_
+000173e0: 616c 7068 6120 3d20 300a 2020 2020 2020  alpha = 0.      
+000173f0: 2020 7365 6c66 2e72 6f6f 742e 7867 7269    self.root.xgri
+00017400: 642e 7669 7369 626c 6520 3d20 4661 6c73  d.visible = Fals
+00017410: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
+00017420: 726f 6f74 2e61 6464 5f74 6f6f 6c73 280a  root.add_tools(.
+00017430: 2020 2020 2020 2020 2020 2020 426f 785a              BoxZ
+00017440: 6f6f 6d54 6f6f 6c28 292c 0a20 2020 2020  oomTool(),.     
+00017450: 2020 2020 2020 2052 6573 6574 546f 6f6c         ResetTool
+00017460: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00017470: 5061 6e54 6f6f 6c28 6469 6d65 6e73 696f  PanTool(dimensio
+00017480: 6e73 3d22 7769 6474 6822 292c 0a20 2020  ns="width"),.   
+00017490: 2020 2020 2020 2020 2057 6865 656c 5a6f           WheelZo
+000174a0: 6f6d 546f 6f6c 2864 696d 656e 7369 6f6e  omTool(dimension
+000174b0: 733d 2277 6964 7468 2229 2c0a 2020 2020  s="width"),.    
+000174c0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+000174d0: 6c66 2e5f 686f 7665 7220 3d20 4e6f 6e65  lf._hover = None
+000174e0: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+000174f0: 6173 745f 6472 6177 6e20 3d20 4e6f 6e65  ast_drawn = None
+00017500: 0a20 2020 2020 2020 2073 656c 662e 5f6f  .        self._o
+00017510: 6666 7365 7420 3d20 7469 6d65 2829 0a20  ffset = time(). 
+00017520: 2020 2020 2020 2073 656c 662e 5f6c 6173         self._las
+00017530: 745f 7472 616e 7369 7469 6f6e 5f63 6f75  t_transition_cou
+00017540: 6e74 203d 2073 6368 6564 756c 6572 2e74  nt = scheduler.t
+00017550: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
+00017560: 720a 2020 2020 2020 2020 2320 4f72 6465  r.        # Orde
+00017570: 7265 6444 6963 7420 736f 2077 6520 6361  redDict so we ca
+00017580: 6e20 6d61 6b65 2061 2072 6576 6572 7365  n make a reverse
+00017590: 2069 7465 7261 746f 7220 6c61 7465 7220   iterator later 
+000175a0: 616e 6420 6765 7420 7468 650a 2020 2020  and get the.    
+000175b0: 2020 2020 2320 6d6f 7374 2d72 6563 656e      # most-recen
+000175c0: 746c 792d 6164 6465 6420 676c 7970 6873  tly-added glyphs
+000175d0: 2e0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+000175e0: 7265 6e64 6572 6572 7320 3d20 4f72 6465  renderers = Orde
+000175f0: 7265 6444 6963 7428 290a 2020 2020 2020  redDict().      
+00017600: 2020 7365 6c66 2e5f 6c69 6e65 5f72 656e    self._line_ren
+00017610: 6465 7265 7273 203d 204f 7264 6572 6564  derers = Ordered
+00017620: 4469 6374 2829 0a0a 2020 2020 6465 6620  Dict()..    def 
+00017630: 5f73 686f 756c 645f 6164 645f 6e65 775f  _should_add_new_
+00017640: 7265 6e64 6572 6572 7328 7365 6c66 2920  renderers(self) 
+00017650: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+00017660: 2022 2222 0a20 2020 2020 2020 2057 6865   """.        Whe
+00017670: 7468 6572 2074 6f20 6164 6420 6e65 7720  ther to add new 
+00017680: 7265 6e64 6572 6572 7320 746f 2074 6865  renderers to the
+00017690: 2063 6861 7274 2e0a 0a20 2020 2020 2020   chart...       
+000176a0: 2057 6865 6e20 6120 6e65 7720 7365 7420   When a new set 
+000176b0: 6f66 2074 6173 6b20 6772 6f75 7073 2065  of task groups e
+000176c0: 6e74 6572 7320 7468 6520 7363 6865 6475  nters the schedu
+000176d0: 6c65 7220 7765 2764 206c 696b 6520 746f  ler we'd like to
+000176e0: 2073 7461 7274 2072 656e 6465 7269 6e67   start rendering
+000176f0: 0a20 2020 2020 2020 2074 6865 6d2e 2042  .        them. B
+00017700: 7574 2069 7420 6361 6e20 6265 2065 7870  ut it can be exp
+00017710: 656e 7369 7665 2074 6f20 6164 6420 6e65  ensive to add ne
+00017720: 7720 676c 7970 732c 2073 6f20 7765 2064  w glyps, so we d
+00017730: 6f20 6974 2064 656c 6962 6572 6174 656c  o it deliberatel
+00017740: 792c 0a20 2020 2020 2020 2063 6865 636b  y,.        check
+00017750: 696e 6720 7768 6574 6865 7220 7765 2068  ing whether we h
+00017760: 6176 6520 746f 2064 6f20 6974 2061 6e64  ave to do it and
+00017770: 2077 6865 7468 6572 2074 6865 2073 6368   whether the sch
+00017780: 6564 756c 6572 2073 6565 6d73 2062 7573  eduler seems bus
+00017790: 792e 0a20 2020 2020 2020 2022 2222 0a20  y..        """. 
+000177a0: 2020 2020 2020 2023 2041 6c77 6179 7320         # Always 
+000177b0: 6472 6177 2069 6620 7765 2068 6176 6520  draw if we have 
+000177c0: 6e6f 7420 6265 666f 7265 0a20 2020 2020  not before.     
+000177d0: 2020 2069 6620 6e6f 7420 7365 6c66 2e5f     if not self._
+000177e0: 6c61 7374 5f64 7261 776e 3a0a 2020 2020  last_drawn:.    
+000177f0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+00017800: 7275 650a 2020 2020 2020 2020 2320 446f  rue.        # Do
+00017810: 6e27 7420 6472 6177 2069 6620 7468 6572  n't draw if ther
+00017820: 6520 6861 7665 2062 6565 6e20 6e6f 206e  e have been no n
+00017830: 6577 2074 6173 6b73 2063 6f6d 706c 6574  ew tasks complet
+00017840: 6564 2073 696e 6365 2074 6865 206c 6173  ed since the las
+00017850: 7420 7570 6461 7465 2c0a 2020 2020 2020  t update,.      
+00017860: 2020 2320 6f72 2069 6620 7468 6520 7363    # or if the sc
+00017870: 6865 6475 6c65 7220 4350 5520 6973 206f  heduler CPU is o
+00017880: 6363 7570 6965 642e 0a20 2020 2020 2020  ccupied..       
+00017890: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
+000178a0: 2020 7365 6c66 2e5f 6c61 7374 5f74 7261    self._last_tra
+000178b0: 6e73 6974 696f 6e5f 636f 756e 7420 3d3d  nsition_count ==
+000178c0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+000178d0: 7472 616e 7369 7469 6f6e 5f63 6f75 6e74  transition_count
+000178e0: 6572 0a20 2020 2020 2020 2020 2020 206f  er.            o
+000178f0: 7220 7365 6c66 2e73 6368 6564 756c 6572  r self.scheduler
+00017900: 2e70 726f 632e 6370 755f 7065 7263 656e  .proc.cpu_percen
+00017910: 7428 2920 3e20 3530 0a20 2020 2020 2020  t() > 50.       
+00017920: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+00017930: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
+00017940: 2020 2020 2020 2320 4f6e 6c79 2072 6574        # Only ret
+00017950: 7572 6e20 7472 7565 2069 6620 7468 6572  urn true if ther
+00017960: 6520 6172 6520 6e65 7720 7461 736b 2067  e are new task g
+00017970: 726f 7570 7320 7468 6174 2077 6520 6861  roups that we ha
+00017980: 7665 206e 6f74 2079 6574 2061 6464 6564  ve not yet added
+00017990: 0a20 2020 2020 2020 2023 2074 6f20 7468  .        # to th
+000179a0: 6520 436f 6c75 6d6e 4461 7461 536f 7572  e ColumnDataSour
+000179b0: 6365 2e0a 2020 2020 2020 2020 7265 7475  ce..        retu
+000179c0: 726e 206e 6f74 2073 6574 2873 656c 662e  rn not set(self.
+000179d0: 706c 7567 696e 2e63 6f6d 7075 7465 2e6b  plugin.compute.k
+000179e0: 6579 7328 2929 203c 3d20 7365 7428 7365  eys()) <= set(se
+000179f0: 6c66 2e73 6f75 7263 652e 6461 7461 2e6b  lf.source.data.k
+00017a00: 6579 7328 2929 0a0a 2020 2020 6465 6620  eys())..    def 
+00017a10: 5f73 686f 756c 645f 7570 6461 7465 2873  _should_update(s
+00017a20: 656c 6629 202d 3e20 626f 6f6c 3a0a 2020  elf) -> bool:.  
+00017a30: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00017a40: 2020 5768 6574 6865 7220 746f 2075 7064    Whether to upd
+00017a50: 6174 6520 7468 6520 436f 6c75 6d6e 4461  ate the ColumnDa
+00017a60: 7461 536f 7572 6365 2e20 5468 6973 2069  taSource. This i
+00017a70: 7320 6368 6561 7065 7220 7468 616e 2072  s cheaper than r
+00017a80: 6564 7261 7769 6e67 2c0a 2020 2020 2020  edrawing,.      
+00017a90: 2020 6275 7420 7374 696c 6c20 6e6f 7420    but still not 
+00017aa0: 6672 6565 2c20 736f 2077 6520 6368 6563  free, so we chec
+00017ab0: 6b20 7768 6574 6865 7220 7765 206e 6565  k whether we nee
+00017ac0: 6420 6974 2061 6e64 2077 6865 7468 6572  d it and whether
+00017ad0: 2074 6865 2073 6368 6575 646c 6572 0a20   the scheudler. 
+00017ae0: 2020 2020 2020 2069 7320 6275 7379 2e0a         is busy..
+00017af0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00017b00: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+00017b10: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+00017b20: 6173 745f 7472 616e 7369 7469 6f6e 5f63  ast_transition_c
+00017b30: 6f75 6e74 2021 3d20 7365 6c66 2e73 6368  ount != self.sch
+00017b40: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
+00017b50: 6e5f 636f 756e 7465 720a 2020 2020 2020  n_counter.      
+00017b60: 2020 2020 2020 616e 6420 7365 6c66 2e73        and self.s
+00017b70: 6368 6564 756c 6572 2e70 726f 632e 6370  cheduler.proc.cp
+00017b80: 755f 7065 7263 656e 7428 2920 3c20 3530  u_percent() < 50
+00017b90: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00017ba0: 6465 6620 5f67 6574 5f74 696d 6573 6572  def _get_timeser
+00017bb0: 6965 7328 7365 6c66 2c20 7265 7374 7269  ies(self, restri
+00017bc0: 6374 5f74 6f5f 6578 6973 7469 6e67 3d46  ct_to_existing=F
+00017bd0: 616c 7365 293a 0a20 2020 2020 2020 2022  alse):.        "
+00017be0: 2222 0a20 2020 2020 2020 2055 7064 6174  "".        Updat
+00017bf0: 6520 7468 6520 436f 6c75 6d6e 4461 7461  e the ColumnData
+00017c00: 536f 7572 6365 2077 6974 6820 6f75 7220  Source with our 
+00017c10: 7469 6d65 2073 6572 6965 7320 6461 7461  time series data
+00017c20: 2e0a 0a20 2020 2020 2020 2072 6573 7472  ...        restr
+00017c30: 6963 745f 746f 5f65 7869 7374 696e 6720  ict_to_existing 
+00017c40: 6465 7465 726d 696e 6573 2077 6865 7468  determines wheth
+00017c50: 6572 2074 6f20 6164 6420 6e65 7720 7461  er to add new ta
+00017c60: 736b 2067 726f 7570 730a 2020 2020 2020  sk groups.      
+00017c70: 2020 7768 6963 6820 6d69 6768 7420 6861    which might ha
+00017c80: 7665 2062 6565 6e20 6164 6465 6420 7369  ve been added si
+00017c90: 6e63 6520 7468 6520 6c61 7374 2074 696d  nce the last tim
+00017ca0: 6520 7765 2072 656e 6465 7265 642e 0a20  e we rendered.. 
+00017cb0: 2020 2020 2020 2054 6869 7320 6973 2069         This is i
+00017cc0: 6d70 6f72 7461 6e74 2061 7320 7765 2077  mportant as we w
+00017cd0: 616e 7420 746f 2061 6464 206e 6577 2073  ant to add new s
+00017ce0: 7461 636b 6572 7320 7665 7279 2064 656c  tackers very del
+00017cf0: 6962 6572 6174 656c 792e 0a20 2020 2020  iberately..     
+00017d00: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+00017d10: 2047 6574 2074 6865 2066 726f 6e74 2f62   Get the front/b
+00017d20: 6163 6b20 696e 6469 6365 7320 666f 7220  ack indices for 
+00017d30: 6d6f 7374 2072 6563 656e 7420 6e70 7473  most recent npts
+00017d40: 2062 696e 7320 6f75 7420 6f66 2074 6865   bins out of the
+00017d50: 2074 696d 6573 6572 6965 730a 2020 2020   timeseries.    
+00017d60: 2020 2020 6672 6f6e 7420 3d20 6d61 7828      front = max(
+00017d70: 6c65 6e28 7365 6c66 2e70 6c75 6769 6e2e  len(self.plugin.
+00017d80: 7469 6d65 2920 2d20 7365 6c66 2e6e 7074  time) - self.npt
+00017d90: 732c 2030 290a 2020 2020 2020 2020 6261  s, 0).        ba
+00017da0: 636b 203d 204e 6f6e 650a 2020 2020 2020  ck = None.      
+00017db0: 2020 2320 5265 6d6f 7665 2061 6e79 2070    # Remove any p
+00017dc0: 6572 696f 6473 206f 6620 7a65 726f 2063  eriods of zero c
+00017dd0: 6f6d 7075 7465 2061 7420 7468 6520 6672  ompute at the fr
+00017de0: 6f6e 7420 6f72 2062 6163 6b20 6f66 2074  ont or back of t
+00017df0: 6865 2074 696d 6573 6572 6965 730a 2020  he timeseries.  
+00017e00: 2020 2020 2020 6966 206c 656e 2873 656c        if len(sel
+00017e10: 662e 706c 7567 696e 2e63 6f6d 7075 7465  f.plugin.compute
+00017e20: 293a 0a20 2020 2020 2020 2020 2020 2061  ):.            a
+00017e30: 6767 203d 2073 756d 286e 702e 6172 7261  gg = sum(np.arra
+00017e40: 7928 765b 6672 6f6e 743a 5d29 2066 6f72  y(v[front:]) for
+00017e50: 2076 2069 6e20 7365 6c66 2e70 6c75 6769   v in self.plugi
+00017e60: 6e2e 636f 6d70 7574 652e 7661 6c75 6573  n.compute.values
+00017e70: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+00017e80: 6672 6f6e 7432 203d 206c 656e 2861 6767  front2 = len(agg
+00017e90: 2920 2d20 6c65 6e28 6e70 2e74 7269 6d5f  ) - len(np.trim_
+00017ea0: 7a65 726f 7328 6167 672c 2074 7269 6d3d  zeros(agg, trim=
+00017eb0: 2266 2229 290a 2020 2020 2020 2020 2020  "f")).          
+00017ec0: 2020 6672 6f6e 7420 2b3d 2066 726f 6e74    front += front
+00017ed0: 320a 2020 2020 2020 2020 2020 2020 6261  2.            ba
+00017ee0: 636b 203d 206c 656e 286e 702e 7472 696d  ck = len(np.trim
+00017ef0: 5f7a 6572 6f73 2861 6767 2c20 7472 696d  _zeros(agg, trim
+00017f00: 3d22 6222 2929 202d 206c 656e 2861 6767  ="b")) - len(agg
+00017f10: 2920 6f72 204e 6f6e 650a 0a20 2020 2020  ) or None..     
+00017f20: 2020 2070 7265 7065 6e64 203d 2028 0a20     prepend = (. 
+00017f30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00017f40: 706c 7567 696e 2e74 696d 655b 6672 6f6e  plugin.time[fron
+00017f50: 7420 2d20 315d 0a20 2020 2020 2020 2020  t - 1].         
+00017f60: 2020 2069 6620 6672 6f6e 7420 3e3d 2031     if front >= 1
+00017f70: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00017f80: 6520 7365 6c66 2e70 6c75 6769 6e2e 7469  e self.plugin.ti
+00017f90: 6d65 5b66 726f 6e74 5d20 2d20 7365 6c66  me[front] - self
+00017fa0: 2e70 6c75 6769 6e2e 6474 0a20 2020 2020  .plugin.dt.     
+00017fb0: 2020 2029 0a20 2020 2020 2020 2074 696d     ).        tim
+00017fc0: 6573 7461 6d70 7320 3d20 6e70 2e61 7272  estamps = np.arr
+00017fd0: 6179 2873 656c 662e 706c 7567 696e 2e74  ay(self.plugin.t
+00017fe0: 696d 655b 6672 6f6e 743a 6261 636b 5d29  ime[front:back])
+00017ff0: 0a20 2020 2020 2020 2064 7420 3d20 6e70  .        dt = np
+00018000: 2e64 6966 6628 7469 6d65 7374 616d 7073  .diff(timestamps
+00018010: 2c20 7072 6570 656e 643d 7072 6570 656e  , prepend=prepen
+00018020: 6429 0a0a 2020 2020 2020 2020 6966 2072  d)..        if r
+00018030: 6573 7472 6963 745f 746f 5f65 7869 7374  estrict_to_exist
+00018040: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
+00018050: 206e 6577 5f64 6174 6120 3d20 7b0a 2020   new_data = {.  
+00018060: 2020 2020 2020 2020 2020 2020 2020 6b3a                k:
+00018070: 206e 702e 6172 7261 7928 765b 6672 6f6e   np.array(v[fron
+00018080: 743a 6261 636b 5d29 202f 2064 740a 2020  t:back]) / dt.  
+00018090: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+000180a0: 7220 6b2c 2076 2069 6e20 7365 6c66 2e70  r k, v in self.p
+000180b0: 6c75 6769 6e2e 636f 6d70 7574 652e 6974  lugin.compute.it
+000180c0: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
+000180d0: 2020 2020 2020 6966 206b 2069 6e20 7365        if k in se
+000180e0: 6c66 2e73 6f75 7263 652e 6461 7461 0a20  lf.source.data. 
+000180f0: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00018100: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00018110: 2020 2020 2020 206e 6577 5f64 6174 6120         new_data 
+00018120: 3d20 7661 6c6d 6170 280a 2020 2020 2020  = valmap(.      
+00018130: 2020 2020 2020 2020 2020 6c61 6d62 6461            lambda
+00018140: 2078 3a20 6e70 2e61 7272 6179 2878 5b66   x: np.array(x[f
+00018150: 726f 6e74 3a62 6163 6b5d 2920 2f20 6474  ront:back]) / dt
+00018160: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00018170: 2020 7365 6c66 2e70 6c75 6769 6e2e 636f    self.plugin.co
+00018180: 6d70 7574 652c 0a20 2020 2020 2020 2020  mpute,.         
+00018190: 2020 2029 0a0a 2020 2020 2020 2020 6e65     )..        ne
+000181a0: 775f 6461 7461 5b22 7469 6d65 225d 203d  w_data["time"] =
+000181b0: 2028 0a20 2020 2020 2020 2020 2020 2074   (.            t
+000181c0: 696d 6573 7461 6d70 7320 2d20 7365 6c66  imestamps - self
+000181d0: 2e5f 6f66 6673 6574 0a20 2020 2020 2020  ._offset.       
+000181e0: 2029 202a 2031 3030 302e 3020 2023 2062   ) * 1000.0  # b
+000181f0: 6f6b 6568 206c 696b 6573 206d 696c 6c69  okeh likes milli
+00018200: 7365 636f 6e64 730a 2020 2020 2020 2020  seconds.        
+00018210: 6e65 775f 6461 7461 5b22 6e74 6872 6561  new_data["nthrea
+00018220: 6473 225d 203d 206e 702e 6172 7261 7928  ds"] = np.array(
+00018230: 7365 6c66 2e70 6c75 6769 6e2e 6e74 6872  self.plugin.nthr
+00018240: 6561 6473 5b66 726f 6e74 3a62 6163 6b5d  eads[front:back]
+00018250: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00018260: 6e20 6e65 775f 6461 7461 0a0a 2020 2020  n new_data..    
+00018270: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
+00018280: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
+00018290: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+000182a0: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
+000182b0: 293a 0a20 2020 2020 2020 2022 2222 0a20  ):.        """. 
+000182c0: 2020 2020 2020 204d 6179 6265 2075 7064         Maybe upd
+000182d0: 6174 6520 7468 6520 6368 6172 742e 2054  ate the chart. T
+000182e0: 6869 7320 6973 2073 6f6d 6577 6861 7420  his is somewhat 
+000182f0: 6578 7065 6e73 6976 6520 746f 2064 7261  expensive to dra
+00018300: 772c 2073 6f20 7765 2075 7064 6174 650a  w, so we update.
+00018310: 2020 2020 2020 2020 6974 2070 7265 7474          it prett
+00018320: 7920 6465 6665 6e73 6976 656c 792e 0a20  y defensively.. 
+00018330: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00018340: 2020 2069 6620 7365 6c66 2e5f 7368 6f75     if self._shou
+00018350: 6c64 5f61 6464 5f6e 6577 5f72 656e 6465  ld_add_new_rende
+00018360: 7265 7273 2829 3a0a 2020 2020 2020 2020  rers():.        
+00018370: 2020 2020 2320 5570 6461 7465 2074 6865      # Update the
+00018380: 2063 6861 7274 2c20 616c 6c6f 7769 6e67   chart, allowing
+00018390: 2066 6f72 206e 6577 2074 6173 6b20 6772   for new task gr
+000183a0: 6f75 7073 2074 6f20 6265 2061 6464 6564  oups to be added
+000183b0: 2e0a 2020 2020 2020 2020 2020 2020 6e65  ..            ne
+000183c0: 775f 6461 7461 203d 2073 656c 662e 5f67  w_data = self._g
+000183d0: 6574 5f74 696d 6573 6572 6965 7328 7265  et_timeseries(re
+000183e0: 7374 7269 6374 5f74 6f5f 6578 6973 7469  strict_to_existi
+000183f0: 6e67 3d46 616c 7365 290a 2020 2020 2020  ng=False).      
+00018400: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
+00018410: 652e 6461 7461 203d 206e 6577 5f64 6174  e.data = new_dat
+00018420: 610a 0a20 2020 2020 2020 2020 2020 2023  a..            #
+00018430: 2050 6f73 7369 626c 7920 7570 6461 7465   Possibly update
+00018440: 2074 6865 2079 2072 616e 6765 2069 6620   the y range if 
+00018450: 7468 6520 6e75 6d62 6572 206f 6620 7468  the number of th
+00018460: 7265 6164 7320 6861 7320 696e 6372 6561  reads has increa
+00018470: 7365 642e 0a20 2020 2020 2020 2020 2020  sed..           
+00018480: 206d 6178 5f6e 7468 7265 6164 7320 3d20   max_nthreads = 
+00018490: 6d61 7828 7365 6c66 2e70 6c75 6769 6e2e  max(self.plugin.
+000184a0: 6e74 6872 6561 6473 290a 2020 2020 2020  nthreads).      
+000184b0: 2020 2020 2020 6966 2073 656c 662e 726f        if self.ro
+000184c0: 6f74 2e79 5f72 616e 6765 2e65 6e64 2021  ot.y_range.end !
+000184d0: 3d20 6d61 785f 6e74 6872 6561 6473 3a0a  = max_nthreads:.
+000184e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000184f0: 7365 6c66 2e72 6f6f 742e 795f 7261 6e67  self.root.y_rang
+00018500: 652e 656e 6420 3d20 6d61 785f 6e74 6872  e.end = max_nthr
+00018510: 6561 6473 0a0a 2020 2020 2020 2020 2020  eads..          
+00018520: 2020 7374 6163 6b65 7273 203d 206c 6973    stackers = lis
+00018530: 7428 7365 6c66 2e70 6c75 6769 6e2e 636f  t(self.plugin.co
+00018540: 6d70 7574 652e 6b65 7973 2829 290a 2020  mpute.keys()).  
+00018550: 2020 2020 2020 2020 2020 636f 6c6f 7273            colors
+00018560: 203d 205b 636f 6c6f 725f 6f66 286b 6579   = [color_of(key
+00018570: 5f73 706c 6974 286b 2929 2066 6f72 206b  _split(k)) for k
+00018580: 2069 6e20 7374 6163 6b65 7273 5d0a 0a20   in stackers].. 
+00018590: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+000185a0: 2c20 2867 726f 7570 2c20 636f 6c6f 7229  , (group, color)
+000185b0: 2069 6e20 656e 756d 6572 6174 6528 7a69   in enumerate(zi
+000185c0: 7028 7374 6163 6b65 7273 2c20 636f 6c6f  p(stackers, colo
+000185d0: 7273 2929 3a0a 2020 2020 2020 2020 2020  rs)):.          
+000185e0: 2020 2020 2020 2320 4966 2077 6520 6861        # If we ha
+000185f0: 7665 2061 6c72 6561 6479 2064 7261 776e  ve already drawn
+00018600: 2074 6865 2067 726f 7570 2c20 6275 7420   the group, but 
+00018610: 6974 2069 7320 616c 6c20 7a65 726f 2c0a  it is all zero,.
+00018620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018630: 2320 7365 7420 6974 2074 6f20 6265 2069  # set it to be i
+00018640: 6e76 6973 6962 6c65 2e0a 2020 2020 2020  nvisible..      
+00018650: 2020 2020 2020 2020 2020 6966 2067 726f            if gro
+00018660: 7570 2069 6e20 7365 6c66 2e5f 7265 6e64  up in self._rend
+00018670: 6572 6572 733a 0a20 2020 2020 2020 2020  erers:.         
+00018680: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00018690: 7420 6e70 2e63 6f75 6e74 5f6e 6f6e 7a65  t np.count_nonze
+000186a0: 726f 286e 6577 5f64 6174 615b 6772 6f75  ro(new_data[grou
+000186b0: 705d 2920 3e20 303a 0a20 2020 2020 2020  p]) > 0:.       
+000186c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186d0: 2073 656c 662e 5f72 656e 6465 7265 7273   self._renderers
+000186e0: 5b67 726f 7570 5d2e 7669 7369 626c 6520  [group].visible 
+000186f0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+00018700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018710: 7365 6c66 2e5f 6c69 6e65 5f72 656e 6465  self._line_rende
+00018720: 7265 7273 5b67 726f 7570 5d2e 7669 7369  rers[group].visi
+00018730: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+00018740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018750: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00018760: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00018770: 6c66 2e5f 7265 6e64 6572 6572 735b 6772  lf._renderers[gr
+00018780: 6f75 705d 2e76 6973 6962 6c65 203d 2054  oup].visible = T
+00018790: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+000187a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000187b0: 2e5f 6c69 6e65 5f72 656e 6465 7265 7273  ._line_renderers
+000187c0: 5b67 726f 7570 5d2e 7669 7369 626c 6520  [group].visible 
+000187d0: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
+000187e0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+000187f0: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
+00018800: 2020 2020 2020 2320 4472 6177 2074 6865        # Draw the
+00018810: 206e 6577 2061 7265 6120 616e 6420 6c69   new area and li
+00018820: 6e65 2067 6c79 7068 732e 0a20 2020 2020  ne glyphs..     
+00018830: 2020 2020 2020 2020 2020 2072 656e 6465             rende
+00018840: 7265 7220 3d20 7365 6c66 2e72 6f6f 742e  rer = self.root.
+00018850: 7661 7265 6128 0a20 2020 2020 2020 2020  varea(.         
+00018860: 2020 2020 2020 2020 2020 2078 3d22 7469             x="ti
+00018870: 6d65 222c 0a20 2020 2020 2020 2020 2020  me",.           
+00018880: 2020 2020 2020 2020 2079 313d 7374 6163           y1=stac
+00018890: 6b28 2a73 7461 636b 6572 735b 3a69 5d29  k(*stackers[:i])
+000188a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000188b0: 2020 2020 2020 7932 3d73 7461 636b 282a        y2=stack(*
+000188c0: 7374 6163 6b65 7273 5b3a 2069 202b 2031  stackers[: i + 1
+000188d0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+000188e0: 2020 2020 2020 2020 636f 6c6f 723d 636f          color=co
+000188f0: 6c6f 722c 0a20 2020 2020 2020 2020 2020  lor,.           
+00018900: 2020 2020 2020 2020 2061 6c70 6861 3d30           alpha=0
+00018910: 2e35 2c0a 2020 2020 2020 2020 2020 2020  .5,.            
+00018920: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+00018930: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
+00018940: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00018950: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00018960: 6c66 2e5f 7265 6e64 6572 6572 735b 6772  lf._renderers[gr
+00018970: 6f75 705d 203d 2072 656e 6465 7265 720a  oup] = renderer.
+00018980: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018990: 206c 696e 655f 7265 6e64 6572 6572 203d   line_renderer =
+000189a0: 2073 656c 662e 726f 6f74 2e6c 696e 6528   self.root.line(
+000189b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000189c0: 2020 2020 2078 3d22 7469 6d65 222c 0a20       x="time",. 
+000189d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000189e0: 2020 2079 3d73 7461 636b 282a 7374 6163     y=stack(*stac
+000189f0: 6b65 7273 5b3a 2069 202b 2031 5d29 2c0a  kers[: i + 1]),.
+00018a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a10: 2020 2020 636f 6c6f 723d 636f 6c6f 722c      color=color,
+00018a20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018a30: 2020 2020 2061 6c70 6861 3d31 2e30 2c0a       alpha=1.0,.
+00018a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018a50: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+00018a60: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+00018a70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00018a80: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00018a90: 6c69 6e65 5f72 656e 6465 7265 7273 5b67  line_renderers[g
+00018aa0: 726f 7570 5d20 3d20 6c69 6e65 5f72 656e  roup] = line_ren
+00018ab0: 6465 7265 720a 0a20 2020 2020 2020 2020  derer..         
+00018ac0: 2020 2023 2044 6f6e 2774 2061 6464 2068     # Don't add h
+00018ad0: 6f76 6572 2075 6e74 696c 2074 6865 7265  over until there
+00018ae0: 2069 7320 736f 6d65 7468 696e 6720 746f   is something to
+00018af0: 2073 686f 772c 2061 7320 626f 6b65 686a   show, as bokehj
+00018b00: 7320 7365 656d 7320 746f 0a20 2020 2020  s seems to.     
+00018b10: 2020 2020 2020 2023 2068 6176 6520 7472         # have tr
+00018b20: 6f75 626c 6520 7769 7468 2063 7573 746f  ouble with custo
+00018b30: 6d20 686f 7665 7273 2077 6865 6e20 7468  m hovers when th
+00018b40: 6572 6520 6172 6520 6e6f 2072 656e 6465  ere are no rende
+00018b50: 7265 7273 2e0a 2020 2020 2020 2020 2020  rers..          
+00018b60: 2020 6966 2073 656c 662e 706c 7567 696e    if self.plugin
+00018b70: 2e63 6f6d 7075 7465 2061 6e64 2073 656c  .compute and sel
+00018b80: 662e 5f68 6f76 6572 2069 7320 4e6f 6e65  f._hover is None
+00018b90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018ba0: 2020 2320 4164 6420 6120 686f 7665 7220    # Add a hover 
+00018bb0: 7468 6174 2077 696c 6c20 7368 6f77 206f  that will show o
+00018bc0: 6363 7570 616e 6379 2066 6f72 2061 6c6c  ccupancy for all
+00018bd0: 2063 7572 7265 6e74 6c79 2061 6374 6976   currently activ
+00018be0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00018bf0: 2020 2320 7461 736b 2067 726f 7570 732e    # task groups.
+00018c00: 2054 6869 7320 6973 2061 206c 6974 746c   This is a littl
+00018c10: 6520 7472 6963 6b79 2c20 626f 6b65 6820  e tricky, bokeh 
+00018c20: 646f 6573 6e27 7420 2879 6574 2920 7375  doesn't (yet) su
+00018c30: 7070 6f72 740a 2020 2020 2020 2020 2020  pport.          
+00018c40: 2020 2020 2020 2320 6869 7420 7465 7374        # hit test
+00018c50: 7320 666f 7220 7374 6163 6b65 6420 6172  s for stacked ar
+00018c60: 6561 2063 6861 7274 733a 2068 7474 7073  ea charts: https
+00018c70: 3a2f 2f67 6974 6875 622e 636f 6d2f 626f  ://github.com/bo
+00018c80: 6b65 682f 626f 6b65 682f 6973 7375 6573  keh/bokeh/issues
+00018c90: 2f39 3138 320a 2020 2020 2020 2020 2020  /9182.          
+00018ca0: 2020 2020 2020 2320 496e 7374 6561 642c        # Instead,
+00018cb0: 2073 686f 7720 6120 7369 6e67 6c65 2076   show a single v
+00018cc0: 6c69 6e65 2068 6f76 6572 2077 6869 6368  line hover which
+00018cd0: 206c 6973 7473 2074 6865 2063 7572 7265   lists the curre
+00018ce0: 6e74 6c79 2061 6374 6976 6520 7461 736b  ntly active task
+00018cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018d00: 2023 2067 726f 7570 732e 2041 2063 7573   # groups. A cus
+00018d10: 746f 6d20 666f 726d 6174 7465 7220 696e  tom formatter in
+00018d20: 204a 532d 6c61 6e64 2070 756c 6c73 2074   JS-land pulls t
+00018d30: 6865 2072 656c 6576 616e 7420 6461 7461  he relevant data
+00018d40: 2069 6e64 6578 2061 6e64 0a20 2020 2020   index and.     
+00018d50: 2020 2020 2020 2020 2020 2023 2061 7373             # ass
+00018d60: 656d 626c 6573 2074 6865 2074 6f6f 6c74  embles the toolt
+00018d70: 6970 2e0a 2020 2020 2020 2020 2020 2020  ip..            
+00018d80: 2020 2020 666f 726d 6174 7465 7220 3d20      formatter = 
+00018d90: 4375 7374 6f6d 4a53 486f 7665 7228 636f  CustomJSHover(co
+00018da0: 6465 3d22 7265 7475 726e 2027 273b 2229  de="return '';")
+00018db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018dc0: 2073 656c 662e 5f68 6f76 6572 203d 2048   self._hover = H
+00018dd0: 6f76 6572 546f 6f6c 280a 2020 2020 2020  overTool(.      
+00018de0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00018df0: 6f6c 7469 7073 3d22 2222 0a20 2020 2020  oltips=""".     
 00018e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e10: 2020 203c 6469 7620 7374 796c 653d 2266     <div style="f
-00018e20: 6f6e 742d 7369 7a65 3a20 312e 3265 6d3b  ont-size: 1.2em;
-00018e30: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-00018e40: 6c64 223e 0a20 2020 2020 2020 2020 2020  ld">.           
-00018e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e60: 203c 623e 576f 726b 6572 2074 6872 6561   <b>Worker threa
-00018e70: 6420 6f63 6375 7061 6e63 793c 2f62 3e0a  d occupancy</b>.
-00018e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e90: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
-00018ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018eb0: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
+00018e10: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
+00018e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e30: 2020 203c 6469 7620 7374 796c 653d 2266     <div style="f
+00018e40: 6f6e 742d 7369 7a65 3a20 312e 3265 6d3b  ont-size: 1.2em;
+00018e50: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
+00018e60: 6c64 223e 0a20 2020 2020 2020 2020 2020  ld">.           
+00018e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018e80: 203c 623e 576f 726b 6572 2074 6872 6561   <b>Worker threa
+00018e90: 6420 6f63 6375 7061 6e63 793c 2f62 3e0a  d occupancy</b>.
+00018ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018eb0: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
 00018ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018ed0: 2020 2020 2020 2020 2020 2020 2024 696e               $in
-00018ee0: 6465 787b 6375 7374 6f6d 7d0a 2020 2020  dex{custom}.    
-00018ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f00: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
+00018ed0: 2020 2020 2020 2020 2020 203c 6469 763e             <div>
+00018ee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018ef0: 2020 2020 2020 2020 2020 2020 2024 696e               $in
+00018f00: 6465 787b 6375 7374 6f6d 7d0a 2020 2020  dex{custom}.    
 00018f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f20: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00018f20: 2020 2020 2020 3c2f 6469 763e 0a20 2020        </div>.   
 00018f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018f40: 2020 2020 2222 222c 0a20 2020 2020 2020      """,.       
-00018f50: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-00018f60: 653d 2276 6c69 6e65 222c 0a20 2020 2020  e="vline",.     
-00018f70: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00018f80: 696e 655f 706f 6c69 6379 3d22 6e65 6172  ine_policy="near
-00018f90: 6573 7422 2c0a 2020 2020 2020 2020 2020  est",.          
-00018fa0: 2020 2020 2020 2020 2020 6174 7461 6368            attach
-00018fb0: 6d65 6e74 3d22 686f 7269 7a6f 6e74 616c  ment="horizontal
-00018fc0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-00018fd0: 2020 2020 2020 2066 6f72 6d61 7474 6572         formatter
-00018fe0: 733d 7b22 2469 6e64 6578 223a 2066 6f72  s={"$index": for
-00018ff0: 6d61 7474 6572 7d2c 0a20 2020 2020 2020  matter},.       
-00019000: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00019010: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019020: 726f 6f74 2e61 6464 5f74 6f6f 6c73 2873  root.add_tools(s
-00019030: 656c 662e 5f68 6f76 6572 290a 0a20 2020  elf._hover)..   
-00019040: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00019050: 2e5f 686f 7665 723a 0a20 2020 2020 2020  ._hover:.       
-00019060: 2020 2020 2020 2020 2023 2043 7265 6174           # Creat
-00019070: 6520 6120 6375 7374 6f6d 2074 6f6f 6c74  e a custom toolt
-00019080: 6970 2074 6861 743a 0a20 2020 2020 2020  ip that:.       
-00019090: 2020 2020 2020 2020 2023 2020 2031 2e20           #   1. 
-000190a0: 496e 636c 7564 6573 206e 7468 7265 6164  Includes nthread
-000190b0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-000190c0: 2020 2320 2020 322e 2046 696c 7465 7273    #   2. Filters
-000190d0: 206f 7574 2069 6e61 6374 6976 6520 7461   out inactive ta
-000190e0: 736b 2067 726f 7570 730a 2020 2020 2020  sk groups.      
-000190f0: 2020 2020 2020 2020 2020 2320 2020 2020            #     
-00019100: 2028 6f6e 6573 2077 6974 686f 7574 2061   (ones without a
-00019110: 6e79 2063 6f6d 7075 7465 2064 7572 696e  ny compute durin
-00019120: 6720 7468 6520 7265 6c65 7661 6e74 2064  g the relevant d
-00019130: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00019140: 2020 2023 2020 2033 2e20 436f 6c6f 7273     #   3. Colors
-00019150: 2074 6865 206c 6162 656c 7320 6170 7072   the labels appr
-00019160: 6f70 7269 6174 656c 792e 0a20 2020 2020  opriately..     
-00019170: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
-00019180: 7474 6572 203d 2043 7573 746f 6d4a 5348  tter = CustomJSH
-00019190: 6f76 6572 280a 2020 2020 2020 2020 2020  over(.          
-000191a0: 2020 2020 2020 2020 2020 636f 6465 3d22            code="
-000191b0: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
-000191c0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
-000191d0: 2063 6f6c 6f72 6d61 7020 3d20 2573 3b0a   colormap = %s;.
-000191e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000191f0: 2020 2020 2020 2020 636f 6e73 7420 6469          const di
-00019200: 7673 203d 205b 5d3b 0a20 2020 2020 2020  vs = [];.       
-00019210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019220: 2066 6f72 2028 6c65 7420 6b20 6f66 204f   for (let k of O
-00019230: 626a 6563 742e 6b65 7973 2873 6f75 7263  bject.keys(sourc
-00019240: 652e 6461 7461 2929 207b 0a20 2020 2020  e.data)) {.     
-00019250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019260: 2020 2020 2063 6f6e 7374 2076 616c 203d       const val =
-00019270: 2073 6f75 7263 652e 6461 7461 5b6b 5d5b   source.data[k][
-00019280: 7661 6c75 655d 3b0a 2020 2020 2020 2020  value];.        
-00019290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192a0: 2020 636f 6e73 7420 636f 6c6f 7220 3d20    const color = 
-000192b0: 636f 6c6f 726d 6170 5b6b 5d3b 0a20 2020  colormap[k];.   
-000192c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192d0: 2020 2020 2020 2069 6620 286b 203d 3d3d         if (k ===
-000192e0: 2022 7469 6d65 2220 7c7c 206b 203d 3d3d   "time" || k ===
-000192f0: 2022 6e74 6872 6561 6473 2220 7c7c 2076   "nthreads" || v
-00019300: 616c 203c 2031 2e65 2d33 2920 7b0a 2020  al < 1.e-3) {.  
-00019310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019320: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00019330: 7565 3b0a 2020 2020 2020 2020 2020 2020  ue;.            
-00019340: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00019350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019360: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
-00019370: 6c61 6265 6c20 3d20 6b2e 6c65 6e67 7468  label = k.length
-00019380: 203e 3d20 3230 203f 206b 2e73 6c69 6365   >= 20 ? k.slice
-00019390: 2830 2c20 3230 2920 2b20 27e2 80a6 2720  (0, 20) + '...' 
-000193a0: 3a20 6b3b 0a0a 2020 2020 2020 2020 2020  : k;..          
-000193b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000193c0: 2f2f 2055 6e73 6869 6674 2073 6f20 7468  // Unshift so th
-000193d0: 6174 2074 6865 206f 7264 6572 696e 6720  at the ordering 
-000193e0: 6f66 2074 6865 206c 6162 656c 7320 6973  of the labels is
-000193f0: 2074 6865 2073 616d 6520 6173 0a20 2020   the same as.   
-00019400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019410: 2020 2020 2020 202f 2f20 7468 6520 6f72         // the or
-00019420: 6465 7269 6e67 206f 6620 7468 6520 7374  dering of the st
-00019430: 6163 6b65 7273 2e0a 2020 2020 2020 2020  ackers..        
-00019440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019450: 2020 6469 7673 2e75 6e73 6869 6674 280a    divs.unshift(.
+00018f40: 2020 2020 203c 2f64 6976 3e0a 2020 2020       </div>.    
+00018f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f60: 2020 2020 2222 222c 0a20 2020 2020 2020      """,.       
+00018f70: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+00018f80: 653d 2276 6c69 6e65 222c 0a20 2020 2020  e="vline",.     
+00018f90: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00018fa0: 696e 655f 706f 6c69 6379 3d22 6e65 6172  ine_policy="near
+00018fb0: 6573 7422 2c0a 2020 2020 2020 2020 2020  est",.          
+00018fc0: 2020 2020 2020 2020 2020 6174 7461 6368            attach
+00018fd0: 6d65 6e74 3d22 686f 7269 7a6f 6e74 616c  ment="horizontal
+00018fe0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00018ff0: 2020 2020 2020 2066 6f72 6d61 7474 6572         formatter
+00019000: 733d 7b22 2469 6e64 6578 223a 2066 6f72  s={"$index": for
+00019010: 6d61 7474 6572 7d2c 0a20 2020 2020 2020  matter},.       
+00019020: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00019030: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00019040: 726f 6f74 2e61 6464 5f74 6f6f 6c73 2873  root.add_tools(s
+00019050: 656c 662e 5f68 6f76 6572 290a 0a20 2020  elf._hover)..   
+00019060: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00019070: 2e5f 686f 7665 723a 0a20 2020 2020 2020  ._hover:.       
+00019080: 2020 2020 2020 2020 2023 2043 7265 6174           # Creat
+00019090: 6520 6120 6375 7374 6f6d 2074 6f6f 6c74  e a custom toolt
+000190a0: 6970 2074 6861 743a 0a20 2020 2020 2020  ip that:.       
+000190b0: 2020 2020 2020 2020 2023 2020 2031 2e20           #   1. 
+000190c0: 496e 636c 7564 6573 206e 7468 7265 6164  Includes nthread
+000190d0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000190e0: 2020 2320 2020 322e 2046 696c 7465 7273    #   2. Filters
+000190f0: 206f 7574 2069 6e61 6374 6976 6520 7461   out inactive ta
+00019100: 736b 2067 726f 7570 730a 2020 2020 2020  sk groups.      
+00019110: 2020 2020 2020 2020 2020 2320 2020 2020            #     
+00019120: 2028 6f6e 6573 2077 6974 686f 7574 2061   (ones without a
+00019130: 6e79 2063 6f6d 7075 7465 2064 7572 696e  ny compute durin
+00019140: 6720 7468 6520 7265 6c65 7661 6e74 2064  g the relevant d
+00019150: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00019160: 2020 2023 2020 2033 2e20 436f 6c6f 7273     #   3. Colors
+00019170: 2074 6865 206c 6162 656c 7320 6170 7072   the labels appr
+00019180: 6f70 7269 6174 656c 792e 0a20 2020 2020  opriately..     
+00019190: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+000191a0: 7474 6572 203d 2043 7573 746f 6d4a 5348  tter = CustomJSH
+000191b0: 6f76 6572 280a 2020 2020 2020 2020 2020  over(.          
+000191c0: 2020 2020 2020 2020 2020 636f 6465 3d22            code="
+000191d0: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
+000191e0: 2020 2020 2020 2020 2020 2063 6f6e 7374             const
+000191f0: 2063 6f6c 6f72 6d61 7020 3d20 2573 3b0a   colormap = %s;.
+00019200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019210: 2020 2020 2020 2020 636f 6e73 7420 6469          const di
+00019220: 7673 203d 205b 5d3b 0a20 2020 2020 2020  vs = [];.       
+00019230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019240: 2066 6f72 2028 6c65 7420 6b20 6f66 204f   for (let k of O
+00019250: 626a 6563 742e 6b65 7973 2873 6f75 7263  bject.keys(sourc
+00019260: 652e 6461 7461 2929 207b 0a20 2020 2020  e.data)) {.     
+00019270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019280: 2020 2020 2063 6f6e 7374 2076 616c 203d       const val =
+00019290: 2073 6f75 7263 652e 6461 7461 5b6b 5d5b   source.data[k][
+000192a0: 7661 6c75 655d 3b0a 2020 2020 2020 2020  value];.        
+000192b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192c0: 2020 636f 6e73 7420 636f 6c6f 7220 3d20    const color = 
+000192d0: 636f 6c6f 726d 6170 5b6b 5d3b 0a20 2020  colormap[k];.   
+000192e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000192f0: 2020 2020 2020 2069 6620 286b 203d 3d3d         if (k ===
+00019300: 2022 7469 6d65 2220 7c7c 206b 203d 3d3d   "time" || k ===
+00019310: 2022 6e74 6872 6561 6473 2220 7c7c 2076   "nthreads" || v
+00019320: 616c 203c 2031 2e65 2d33 2920 7b0a 2020  al < 1.e-3) {.  
+00019330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019340: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+00019350: 7565 3b0a 2020 2020 2020 2020 2020 2020  ue;.            
+00019360: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
+00019370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019380: 2020 2020 2020 2020 2020 636f 6e73 7420            const 
+00019390: 6c61 6265 6c20 3d20 6b2e 6c65 6e67 7468  label = k.length
+000193a0: 203e 3d20 3230 203f 206b 2e73 6c69 6365   >= 20 ? k.slice
+000193b0: 2830 2c20 3230 2920 2b20 27e2 80a6 2720  (0, 20) + '...' 
+000193c0: 3a20 6b3b 0a0a 2020 2020 2020 2020 2020  : k;..          
+000193d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000193e0: 2f2f 2055 6e73 6869 6674 2073 6f20 7468  // Unshift so th
+000193f0: 6174 2074 6865 206f 7264 6572 696e 6720  at the ordering 
+00019400: 6f66 2074 6865 206c 6162 656c 7320 6973  of the labels is
+00019410: 2074 6865 2073 616d 6520 6173 0a20 2020   the same as.   
+00019420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019430: 2020 2020 2020 202f 2f20 7468 6520 6f72         // the or
+00019440: 6465 7269 6e67 206f 6620 7468 6520 7374  dering of the st
+00019450: 6163 6b65 7273 2e0a 2020 2020 2020 2020  ackers..        
 00019460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019470: 2020 2020 2020 2020 2020 2020 273c 6469              '<di
-00019480: 763e 270a 2020 2020 2020 2020 2020 2020  v>'.            
-00019490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194a0: 2020 2b20 273c 7370 616e 2073 7479 6c65    + '<span style
-000194b0: 3d22 666f 6e74 2d77 6569 6768 743a 2062  ="font-weight: b
-000194c0: 6f6c 643b 2063 6f6c 6f72 3a27 202b 2063  old; color:' + c
-000194d0: 6f6c 6f72 202b 2027 3b22 3e27 0a20 2020  olor + ';">'.   
-000194e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000194f0: 2020 2020 2020 2020 2020 2020 202b 206c               + l
-00019500: 6162 656c 0a20 2020 2020 2020 2020 2020  abel.           
-00019510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019520: 2020 202b 2027 3c2f 7370 616e 3e27 0a20     + '</span>'. 
+00019470: 2020 6469 7673 2e75 6e73 6869 6674 280a    divs.unshift(.
+00019480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019490: 2020 2020 2020 2020 2020 2020 273c 6469              '<di
+000194a0: 763e 270a 2020 2020 2020 2020 2020 2020  v>'.            
+000194b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194c0: 2020 2b20 273c 7370 616e 2073 7479 6c65    + '<span style
+000194d0: 3d22 666f 6e74 2d77 6569 6768 743a 2062  ="font-weight: b
+000194e0: 6f6c 643b 2063 6f6c 6f72 3a27 202b 2063  old; color:' + c
+000194f0: 6f6c 6f72 202b 2027 3b22 3e27 0a20 2020  olor + ';">'.   
+00019500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019510: 2020 2020 2020 2020 2020 2020 202b 206c               + l
+00019520: 6162 656c 0a20 2020 2020 2020 2020 2020  abel.           
 00019530: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019540: 2020 2020 2020 2020 2020 2020 202b 2027               + '
-00019550: 3a20 270a 2020 2020 2020 2020 2020 2020  : '.            
-00019560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019570: 2020 2b20 2076 616c 2e74 6f46 6978 6564    +  val.toFixed
-00019580: 2831 290a 2020 2020 2020 2020 2020 2020  (1).            
-00019590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195a0: 2020 2b20 273c 2f64 6976 3e27 0a20 2020    + '</div>'.   
+00019540: 2020 202b 2027 3c2f 7370 616e 3e27 0a20     + '</span>'. 
+00019550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019560: 2020 2020 2020 2020 2020 2020 202b 2027               + '
+00019570: 3a20 270a 2020 2020 2020 2020 2020 2020  : '.            
+00019580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019590: 2020 2b20 2076 616c 2e74 6f46 6978 6564    +  val.toFixed
+000195a0: 2831 290a 2020 2020 2020 2020 2020 2020  (1).            
 000195b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000195c0: 2020 2b20 273c 2f64 6976 3e27 0a20 2020    + '</div>'.   
 000195d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000195e0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-000195f0: 2020 2020 2020 2020 2020 2020 6469 7673              divs
-00019600: 2e75 6e73 6869 6674 280a 2020 2020 2020  .unshift(.      
-00019610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019620: 2020 2020 273c 6469 763e 270a 2020 2020      '<div>'.    
+000195e0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+000195f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019600: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+00019610: 2020 2020 2020 2020 2020 2020 6469 7673              divs
+00019620: 2e75 6e73 6869 6674 280a 2020 2020 2020  .unshift(.      
 00019630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019640: 2020 2020 2020 2020 2b20 273c 7370 616e          + '<span
-00019650: 2073 7479 6c65 3d22 666f 6e74 2d77 6569   style="font-wei
-00019660: 6768 743a 2062 6f6c 643b 2063 6f6c 6f72  ght: bold; color
-00019670: 3a20 6461 726b 6772 6579 3b22 3e6e 7468  : darkgrey;">nth
-00019680: 7265 6164 733a 203c 2f73 7061 6e3e 270a  reads: </span>'.
-00019690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196a0: 2020 2020 2020 2020 2020 2020 2b20 736f              + so
-000196b0: 7572 6365 2e64 6174 612e 6e74 6872 6561  urce.data.nthrea
-000196c0: 6473 5b76 616c 7565 5d0a 2020 2020 2020  ds[value].      
-000196d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000196e0: 2020 2020 2020 2b20 273c 2f64 6976 3e27        + '</div>'
-000196f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019700: 2020 2020 2020 2020 2029 3b0a 2020 2020           );.    
-00019710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019720: 2020 2020 7265 7475 726e 2064 6976 732e      return divs.
-00019730: 6a6f 696e 2827 5c5c 6e27 290a 2020 2020  join('\\n').    
-00019740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019750: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00019760: 2020 2020 2020 2020 2020 2020 2520 6469              % di
-00019770: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-00019780: 2020 2020 2020 2020 2020 2020 7a69 7028              zip(
-00019790: 7374 6163 6b65 7273 2c20 636f 6c6f 7273  stackers, colors
-000197a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000197b0: 2020 2020 2020 292c 2020 2320 736e 6561        ),  # snea
-000197c0: 6b20 7468 6520 636f 6c6f 7220 6d61 7070  k the color mapp
-000197d0: 696e 6720 696e 746f 2074 6865 2063 616c  ing into the cal
-000197e0: 6c62 6163 6b0a 2020 2020 2020 2020 2020  lback.          
-000197f0: 2020 2020 2020 2020 2020 6172 6773 3d7b            args={
-00019800: 2273 6f75 7263 6522 3a20 7365 6c66 2e73  "source": self.s
-00019810: 6f75 7263 657d 2c0a 2020 2020 2020 2020  ource},.        
-00019820: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00019830: 2020 2020 2020 2020 2020 2320 4164 6420            # Add 
-00019840: 7468 6520 486f 7665 7254 6f6f 6c20 746f  the HoverTool to
-00019850: 2074 6865 2074 6f70 206c 696e 6520 7265   the top line re
-00019860: 6e64 6572 6572 2e0a 2020 2020 2020 2020  nderer..        
-00019870: 2020 2020 2020 2020 746f 705f 6c69 6e65          top_line
-00019880: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00019890: 2020 2020 2020 2020 666f 7220 6c69 6e65          for line
-000198a0: 2069 6e20 7265 7665 7273 6564 2873 656c   in reversed(sel
-000198b0: 662e 5f6c 696e 655f 7265 6e64 6572 6572  f._line_renderer
-000198c0: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
-000198d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000198e0: 2069 6620 6c69 6e65 2e76 6973 6962 6c65   if line.visible
-000198f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00019900: 2020 2020 2020 2020 2020 746f 705f 6c69            top_li
-00019910: 6e65 203d 206c 696e 650a 2020 2020 2020  ne = line.      
-00019920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019930: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
-00019940: 2020 2020 2020 2020 7365 6c66 2e5f 686f          self._ho
-00019950: 7665 722e 7265 6e64 6572 6572 7320 3d20  ver.renderers = 
-00019960: 5b74 6f70 5f6c 696e 655d 0a20 2020 2020  [top_line].     
-00019970: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019980: 5f68 6f76 6572 2e66 6f72 6d61 7474 6572  _hover.formatter
-00019990: 7320 3d20 7b22 2469 6e64 6578 223a 2066  s = {"$index": f
-000199a0: 6f72 6d61 7474 6572 7d0a 0a20 2020 2020  ormatter}..     
-000199b0: 2020 2020 2020 2073 656c 662e 5f6c 6173         self._las
-000199c0: 745f 6472 6177 6e20 3d20 7469 6d65 2829  t_drawn = time()
-000199d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000199e0: 662e 5f6c 6173 745f 7472 616e 7369 7469  f._last_transiti
-000199f0: 6f6e 5f63 6f75 6e74 203d 2073 656c 662e  on_count = self.
-00019a00: 7363 6865 6475 6c65 722e 7472 616e 7369  scheduler.transi
-00019a10: 7469 6f6e 5f63 6f75 6e74 6572 0a20 2020  tion_counter.   
-00019a20: 2020 2020 2065 6c69 6620 7365 6c66 2e5f       elif self._
-00019a30: 7368 6f75 6c64 5f75 7064 6174 6528 293a  should_update():
-00019a40: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
-00019a50: 6f73 7369 626c 7920 7570 6461 7465 2074  ossibly update t
-00019a60: 6865 2079 2072 616e 6765 2069 6620 6e65  he y range if ne
-00019a70: 7720 7468 7265 6164 7320 6861 7665 2062  w threads have b
-00019a80: 6565 6e20 6164 6465 640a 2020 2020 2020  een added.      
-00019a90: 2020 2020 2020 6d61 785f 6e74 6872 6561        max_nthrea
-00019aa0: 6473 203d 206d 6178 2873 656c 662e 706c  ds = max(self.pl
-00019ab0: 7567 696e 2e6e 7468 7265 6164 7329 0a20  ugin.nthreads). 
-00019ac0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00019ad0: 6c66 2e72 6f6f 742e 795f 7261 6e67 652e  lf.root.y_range.
-00019ae0: 656e 6420 213d 206d 6178 5f6e 7468 7265  end != max_nthre
-00019af0: 6164 733a 0a20 2020 2020 2020 2020 2020  ads:.           
-00019b00: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-00019b10: 5f72 616e 6765 2e65 6e64 203d 206d 6178  _range.end = max
-00019b20: 5f6e 7468 7265 6164 730a 2020 2020 2020  _nthreads.      
-00019b30: 2020 2020 2020 2320 5570 6461 7465 2074        # Update t
-00019b40: 6865 2064 6174 612c 206f 6e6c 7920 696e  he data, only in
-00019b50: 636c 7564 696e 6720 6578 6973 7469 6e67  cluding existing
-00019b60: 2063 6f6c 756d 6e73 2c20 7261 7468 6572   columns, rather
-00019b70: 2074 6861 6e20 7265 6472 6177 696e 670a   than redrawing.
-00019b80: 2020 2020 2020 2020 2020 2020 2320 7468              # th
-00019b90: 6520 7768 6f6c 6520 6368 6172 742e 0a20  e whole chart.. 
-00019ba0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019bb0: 736f 7572 6365 2e64 6174 6120 3d20 7365  source.data = se
-00019bc0: 6c66 2e5f 6765 745f 7469 6d65 7365 7269  lf._get_timeseri
-00019bd0: 6573 2872 6573 7472 6963 745f 746f 5f65  es(restrict_to_e
-00019be0: 7869 7374 696e 673d 5472 7565 290a 2020  xisting=True).  
-00019bf0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00019c00: 6c61 7374 5f74 7261 6e73 6974 696f 6e5f  last_transition_
-00019c10: 636f 756e 7420 3d20 7365 6c66 2e73 6368  count = self.sch
-00019c20: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
-00019c30: 6e5f 636f 756e 7465 720a 0a0a 636c 6173  n_counter...clas
-00019c40: 7320 5461 736b 5072 6f67 7265 7373 2844  s TaskProgress(D
-00019c50: 6173 6862 6f61 7264 436f 6d70 6f6e 656e  ashboardComponen
-00019c60: 7429 3a0a 2020 2020 2222 2250 726f 6772  t):.    """Progr
-00019c70: 6573 7320 6261 7273 2070 6572 2074 6173  ess bars per tas
-00019c80: 6b20 7479 7065 2222 220a 0a20 2020 2064  k type"""..    d
-00019c90: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00019ca0: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
-00019cb0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
-00019cc0: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
-00019cd0: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
-00019ce0: 2020 2020 6461 7461 203d 2070 726f 6772      data = progr
-00019cf0: 6573 735f 7175 6164 7328 0a20 2020 2020  ess_quads(.     
-00019d00: 2020 2020 2020 2064 6963 7428 616c 6c3d         dict(all=
-00019d10: 7b7d 2c20 6d65 6d6f 7279 3d7b 7d2c 2065  {}, memory={}, e
-00019d20: 7272 6564 3d7b 7d2c 2072 656c 6561 7365  rred={}, release
-00019d30: 643d 7b7d 2c20 7072 6f63 6573 7369 6e67  d={}, processing
-00019d40: 3d7b 7d2c 2071 7565 7565 643d 7b7d 290a  ={}, queued={}).
-00019d50: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00019d60: 2020 7365 6c66 2e73 6f75 7263 6520 3d20    self.source = 
-00019d70: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
-00019d80: 2864 6174 613d 6461 7461 290a 0a20 2020  (data=data)..   
-00019d90: 2020 2020 2078 5f72 616e 6765 203d 2044       x_range = D
-00019da0: 6174 6152 616e 6765 3164 2872 616e 6765  ataRange1d(range
-00019db0: 5f70 6164 6469 6e67 3d30 290a 2020 2020  _padding=0).    
-00019dc0: 2020 2020 795f 7261 6e67 6520 3d20 5261      y_range = Ra
-00019dd0: 6e67 6531 6428 2d38 2c20 3029 0a0a 2020  nge1d(-8, 0)..  
-00019de0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
-00019df0: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
-00019e00: 2020 2020 2020 7469 746c 653d 2250 726f        title="Pro
-00019e10: 6772 6573 7322 2c0a 2020 2020 2020 2020  gress",.        
-00019e20: 2020 2020 6e61 6d65 3d22 7461 736b 5f70      name="task_p
-00019e30: 726f 6772 6573 7322 2c0a 2020 2020 2020  rogress",.      
-00019e40: 2020 2020 2020 785f 7261 6e67 653d 785f        x_range=x_
-00019e50: 7261 6e67 652c 0a20 2020 2020 2020 2020  range,.         
-00019e60: 2020 2079 5f72 616e 6765 3d79 5f72 616e     y_range=y_ran
-00019e70: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
-00019e80: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
-00019e90: 3d22 6162 6f76 6522 2c0a 2020 2020 2020  ="above",.      
-00019ea0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
-00019eb0: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
-00019ec0: 626f 7264 6572 5f62 6f74 746f 6d3d 3530  border_bottom=50
-00019ed0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-00019ee0: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
-00019ef0: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-00019f00: 6f6f 742e 6c69 6e65 2820 2023 206a 7573  oot.line(  # jus
-00019f10: 7420 746f 2064 6566 696e 6520 6561 726c  t to define earl
-00019f20: 7920 7261 6e67 6573 0a20 2020 2020 2020  y ranges.       
-00019f30: 2020 2020 2078 3d5b 302c 2030 2e39 5d2c       x=[0, 0.9],
-00019f40: 2079 3d5b 2d31 2c20 305d 2c20 6c69 6e65   y=[-1, 0], line
-00019f50: 5f63 6f6c 6f72 3d22 2346 4646 4646 4622  _color="#FFFFFF"
-00019f60: 2c20 616c 7068 613d 302e 300a 2020 2020  , alpha=0.0.    
-00019f70: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-00019f80: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
-00019f90: 2020 2020 2020 2020 2020 736f 7572 6365            source
-00019fa0: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-00019fb0: 2020 2020 2020 2020 2020 746f 703d 2274            top="t
-00019fc0: 6f70 222c 0a20 2020 2020 2020 2020 2020  op",.           
-00019fd0: 2062 6f74 746f 6d3d 2262 6f74 746f 6d22   bottom="bottom"
-00019fe0: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
-00019ff0: 6674 3d22 6c65 6674 222c 0a20 2020 2020  ft="left",.     
-0001a000: 2020 2020 2020 2072 6967 6874 3d22 7269         right="ri
-0001a010: 6768 7422 2c0a 2020 2020 2020 2020 2020  ght",.          
-0001a020: 2020 6669 6c6c 5f63 6f6c 6f72 3d22 2361    fill_color="#a
-0001a030: 6161 6161 6122 2c0a 2020 2020 2020 2020  aaaaa",.        
-0001a040: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
-0001a050: 2361 6161 6161 6122 2c0a 2020 2020 2020  #aaaaaa",.      
-0001a060: 2020 2020 2020 6669 6c6c 5f61 6c70 6861        fill_alpha
-0001a070: 3d30 2e31 2c0a 2020 2020 2020 2020 2020  =0.1,.          
-0001a080: 2020 6c69 6e65 5f61 6c70 6861 3d30 2e33    line_alpha=0.3
-0001a090: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0001a0a0: 2020 2020 7365 6c66 2e72 6f6f 742e 7175      self.root.qu
-0001a0b0: 6164 280a 2020 2020 2020 2020 2020 2020  ad(.            
-0001a0c0: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
-0001a0d0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-0001a0e0: 746f 703d 2274 6f70 222c 0a20 2020 2020  top="top",.     
-0001a0f0: 2020 2020 2020 2062 6f74 746f 6d3d 2262         bottom="b
-0001a100: 6f74 746f 6d22 2c0a 2020 2020 2020 2020  ottom",.        
-0001a110: 2020 2020 6c65 6674 3d22 6c65 6674 222c      left="left",
-0001a120: 0a20 2020 2020 2020 2020 2020 2072 6967  .            rig
-0001a130: 6874 3d22 7265 6c65 6173 6564 2d6c 6f63  ht="released-loc
-0001a140: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
-0001a150: 696c 6c5f 636f 6c6f 723d 2263 6f6c 6f72  ill_color="color
-0001a160: 222c 0a20 2020 2020 2020 2020 2020 206c  ",.            l
-0001a170: 696e 655f 636f 6c6f 723d 2263 6f6c 6f72  ine_color="color
-0001a180: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
-0001a190: 696c 6c5f 616c 7068 613d 302e 362c 0a20  ill_alpha=0.6,. 
-0001a1a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001a1b0: 2073 656c 662e 726f 6f74 2e71 7561 6428   self.root.quad(
-0001a1c0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-0001a1d0: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-0001a1e0: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
-0001a1f0: 3d22 746f 7022 2c0a 2020 2020 2020 2020  ="top",.        
-0001a200: 2020 2020 626f 7474 6f6d 3d22 626f 7474      bottom="bott
-0001a210: 6f6d 222c 0a20 2020 2020 2020 2020 2020  om",.           
-0001a220: 206c 6566 743d 2272 656c 6561 7365 642d   left="released-
-0001a230: 6c6f 6322 2c0a 2020 2020 2020 2020 2020  loc",.          
-0001a240: 2020 7269 6768 743d 226d 656d 6f72 792d    right="memory-
+00019640: 2020 2020 273c 6469 763e 270a 2020 2020      '<div>'.    
+00019650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019660: 2020 2020 2020 2020 2b20 273c 7370 616e          + '<span
+00019670: 2073 7479 6c65 3d22 666f 6e74 2d77 6569   style="font-wei
+00019680: 6768 743a 2062 6f6c 643b 2063 6f6c 6f72  ght: bold; color
+00019690: 3a20 6461 726b 6772 6579 3b22 3e6e 7468  : darkgrey;">nth
+000196a0: 7265 6164 733a 203c 2f73 7061 6e3e 270a  reads: </span>'.
+000196b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000196c0: 2020 2020 2020 2020 2020 2020 2b20 736f              + so
+000196d0: 7572 6365 2e64 6174 612e 6e74 6872 6561  urce.data.nthrea
+000196e0: 6473 5b76 616c 7565 5d0a 2020 2020 2020  ds[value].      
+000196f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019700: 2020 2020 2020 2b20 273c 2f64 6976 3e27        + '</div>'
+00019710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019720: 2020 2020 2020 2020 2029 3b0a 2020 2020           );.    
+00019730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019740: 2020 2020 7265 7475 726e 2064 6976 732e      return divs.
+00019750: 6a6f 696e 2827 5c5c 6e27 290a 2020 2020  join('\\n').    
+00019760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019770: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00019780: 2020 2020 2020 2020 2020 2020 2520 6469              % di
+00019790: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
+000197a0: 2020 2020 2020 2020 2020 2020 7a69 7028              zip(
+000197b0: 7374 6163 6b65 7273 2c20 636f 6c6f 7273  stackers, colors
+000197c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000197d0: 2020 2020 2020 292c 2020 2320 736e 6561        ),  # snea
+000197e0: 6b20 7468 6520 636f 6c6f 7220 6d61 7070  k the color mapp
+000197f0: 696e 6720 696e 746f 2074 6865 2063 616c  ing into the cal
+00019800: 6c62 6163 6b0a 2020 2020 2020 2020 2020  lback.          
+00019810: 2020 2020 2020 2020 2020 6172 6773 3d7b            args={
+00019820: 2273 6f75 7263 6522 3a20 7365 6c66 2e73  "source": self.s
+00019830: 6f75 7263 657d 2c0a 2020 2020 2020 2020  ource},.        
+00019840: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00019850: 2020 2020 2020 2020 2020 2320 4164 6420            # Add 
+00019860: 7468 6520 486f 7665 7254 6f6f 6c20 746f  the HoverTool to
+00019870: 2074 6865 2074 6f70 206c 696e 6520 7265   the top line re
+00019880: 6e64 6572 6572 2e0a 2020 2020 2020 2020  nderer..        
+00019890: 2020 2020 2020 2020 746f 705f 6c69 6e65          top_line
+000198a0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000198b0: 2020 2020 2020 2020 666f 7220 6c69 6e65          for line
+000198c0: 2069 6e20 7265 7665 7273 6564 2873 656c   in reversed(sel
+000198d0: 662e 5f6c 696e 655f 7265 6e64 6572 6572  f._line_renderer
+000198e0: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
+000198f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019900: 2069 6620 6c69 6e65 2e76 6973 6962 6c65   if line.visible
+00019910: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019920: 2020 2020 2020 2020 2020 746f 705f 6c69            top_li
+00019930: 6e65 203d 206c 696e 650a 2020 2020 2020  ne = line.      
+00019940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019950: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+00019960: 2020 2020 2020 2020 7365 6c66 2e5f 686f          self._ho
+00019970: 7665 722e 7265 6e64 6572 6572 7320 3d20  ver.renderers = 
+00019980: 5b74 6f70 5f6c 696e 655d 0a20 2020 2020  [top_line].     
+00019990: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000199a0: 5f68 6f76 6572 2e66 6f72 6d61 7474 6572  _hover.formatter
+000199b0: 7320 3d20 7b22 2469 6e64 6578 223a 2066  s = {"$index": f
+000199c0: 6f72 6d61 7474 6572 7d0a 0a20 2020 2020  ormatter}..     
+000199d0: 2020 2020 2020 2073 656c 662e 5f6c 6173         self._las
+000199e0: 745f 6472 6177 6e20 3d20 7469 6d65 2829  t_drawn = time()
+000199f0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00019a00: 662e 5f6c 6173 745f 7472 616e 7369 7469  f._last_transiti
+00019a10: 6f6e 5f63 6f75 6e74 203d 2073 656c 662e  on_count = self.
+00019a20: 7363 6865 6475 6c65 722e 7472 616e 7369  scheduler.transi
+00019a30: 7469 6f6e 5f63 6f75 6e74 6572 0a20 2020  tion_counter.   
+00019a40: 2020 2020 2065 6c69 6620 7365 6c66 2e5f       elif self._
+00019a50: 7368 6f75 6c64 5f75 7064 6174 6528 293a  should_update():
+00019a60: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
+00019a70: 6f73 7369 626c 7920 7570 6461 7465 2074  ossibly update t
+00019a80: 6865 2079 2072 616e 6765 2069 6620 6e65  he y range if ne
+00019a90: 7720 7468 7265 6164 7320 6861 7665 2062  w threads have b
+00019aa0: 6565 6e20 6164 6465 640a 2020 2020 2020  een added.      
+00019ab0: 2020 2020 2020 6d61 785f 6e74 6872 6561        max_nthrea
+00019ac0: 6473 203d 206d 6178 2873 656c 662e 706c  ds = max(self.pl
+00019ad0: 7567 696e 2e6e 7468 7265 6164 7329 0a20  ugin.nthreads). 
+00019ae0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00019af0: 6c66 2e72 6f6f 742e 795f 7261 6e67 652e  lf.root.y_range.
+00019b00: 656e 6420 213d 206d 6178 5f6e 7468 7265  end != max_nthre
+00019b10: 6164 733a 0a20 2020 2020 2020 2020 2020  ads:.           
+00019b20: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+00019b30: 5f72 616e 6765 2e65 6e64 203d 206d 6178  _range.end = max
+00019b40: 5f6e 7468 7265 6164 730a 2020 2020 2020  _nthreads.      
+00019b50: 2020 2020 2020 2320 5570 6461 7465 2074        # Update t
+00019b60: 6865 2064 6174 612c 206f 6e6c 7920 696e  he data, only in
+00019b70: 636c 7564 696e 6720 6578 6973 7469 6e67  cluding existing
+00019b80: 2063 6f6c 756d 6e73 2c20 7261 7468 6572   columns, rather
+00019b90: 2074 6861 6e20 7265 6472 6177 696e 670a   than redrawing.
+00019ba0: 2020 2020 2020 2020 2020 2020 2320 7468              # th
+00019bb0: 6520 7768 6f6c 6520 6368 6172 742e 0a20  e whole chart.. 
+00019bc0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00019bd0: 736f 7572 6365 2e64 6174 6120 3d20 7365  source.data = se
+00019be0: 6c66 2e5f 6765 745f 7469 6d65 7365 7269  lf._get_timeseri
+00019bf0: 6573 2872 6573 7472 6963 745f 746f 5f65  es(restrict_to_e
+00019c00: 7869 7374 696e 673d 5472 7565 290a 2020  xisting=True).  
+00019c10: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00019c20: 6c61 7374 5f74 7261 6e73 6974 696f 6e5f  last_transition_
+00019c30: 636f 756e 7420 3d20 7365 6c66 2e73 6368  count = self.sch
+00019c40: 6564 756c 6572 2e74 7261 6e73 6974 696f  eduler.transitio
+00019c50: 6e5f 636f 756e 7465 720a 0a0a 636c 6173  n_counter...clas
+00019c60: 7320 5461 736b 5072 6f67 7265 7373 2844  s TaskProgress(D
+00019c70: 6173 6862 6f61 7264 436f 6d70 6f6e 656e  ashboardComponen
+00019c80: 7429 3a0a 2020 2020 2222 2250 726f 6772  t):.    """Progr
+00019c90: 6573 7320 6261 7273 2070 6572 2074 6173  ess bars per tas
+00019ca0: 6b20 7479 7065 2222 220a 0a20 2020 2064  k type"""..    d
+00019cb0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00019cc0: 2c20 7363 6865 6475 6c65 722c 202a 2a6b  , scheduler, **k
+00019cd0: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00019ce0: 7365 6c66 2e73 6368 6564 756c 6572 203d  self.scheduler =
+00019cf0: 2073 6368 6564 756c 6572 0a0a 2020 2020   scheduler..    
+00019d00: 2020 2020 6461 7461 203d 2070 726f 6772      data = progr
+00019d10: 6573 735f 7175 6164 7328 0a20 2020 2020  ess_quads(.     
+00019d20: 2020 2020 2020 2064 6963 7428 616c 6c3d         dict(all=
+00019d30: 7b7d 2c20 6d65 6d6f 7279 3d7b 7d2c 2065  {}, memory={}, e
+00019d40: 7272 6564 3d7b 7d2c 2072 656c 6561 7365  rred={}, release
+00019d50: 643d 7b7d 2c20 7072 6f63 6573 7369 6e67  d={}, processing
+00019d60: 3d7b 7d2c 2071 7565 7565 643d 7b7d 290a  ={}, queued={}).
+00019d70: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00019d80: 2020 7365 6c66 2e73 6f75 7263 6520 3d20    self.source = 
+00019d90: 436f 6c75 6d6e 4461 7461 536f 7572 6365  ColumnDataSource
+00019da0: 2864 6174 613d 6461 7461 290a 0a20 2020  (data=data)..   
+00019db0: 2020 2020 2078 5f72 616e 6765 203d 2044       x_range = D
+00019dc0: 6174 6152 616e 6765 3164 2872 616e 6765  ataRange1d(range
+00019dd0: 5f70 6164 6469 6e67 3d30 290a 2020 2020  _padding=0).    
+00019de0: 2020 2020 795f 7261 6e67 6520 3d20 5261      y_range = Ra
+00019df0: 6e67 6531 6428 2d38 2c20 3029 0a0a 2020  nge1d(-8, 0)..  
+00019e00: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
+00019e10: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
+00019e20: 2020 2020 2020 7469 746c 653d 2250 726f        title="Pro
+00019e30: 6772 6573 7322 2c0a 2020 2020 2020 2020  gress",.        
+00019e40: 2020 2020 6e61 6d65 3d22 7461 736b 5f70      name="task_p
+00019e50: 726f 6772 6573 7322 2c0a 2020 2020 2020  rogress",.      
+00019e60: 2020 2020 2020 785f 7261 6e67 653d 785f        x_range=x_
+00019e70: 7261 6e67 652c 0a20 2020 2020 2020 2020  range,.         
+00019e80: 2020 2079 5f72 616e 6765 3d79 5f72 616e     y_range=y_ran
+00019e90: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
+00019ea0: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
+00019eb0: 3d22 6162 6f76 6522 2c0a 2020 2020 2020  ="above",.      
+00019ec0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
+00019ed0: 2020 2020 2020 2020 2020 2020 6d69 6e5f              min_
+00019ee0: 626f 7264 6572 5f62 6f74 746f 6d3d 3530  border_bottom=50
+00019ef0: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+00019f00: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
+00019f10: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+00019f20: 6f6f 742e 6c69 6e65 2820 2023 206a 7573  oot.line(  # jus
+00019f30: 7420 746f 2064 6566 696e 6520 6561 726c  t to define earl
+00019f40: 7920 7261 6e67 6573 0a20 2020 2020 2020  y ranges.       
+00019f50: 2020 2020 2078 3d5b 302c 2030 2e39 5d2c       x=[0, 0.9],
+00019f60: 2079 3d5b 2d31 2c20 305d 2c20 6c69 6e65   y=[-1, 0], line
+00019f70: 5f63 6f6c 6f72 3d22 2346 4646 4646 4622  _color="#FFFFFF"
+00019f80: 2c20 616c 7068 613d 302e 300a 2020 2020  , alpha=0.0.    
+00019f90: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00019fa0: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
+00019fb0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+00019fc0: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+00019fd0: 2020 2020 2020 2020 2020 746f 703d 2274            top="t
+00019fe0: 6f70 222c 0a20 2020 2020 2020 2020 2020  op",.           
+00019ff0: 2062 6f74 746f 6d3d 2262 6f74 746f 6d22   bottom="bottom"
+0001a000: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
+0001a010: 6674 3d22 6c65 6674 222c 0a20 2020 2020  ft="left",.     
+0001a020: 2020 2020 2020 2072 6967 6874 3d22 7269         right="ri
+0001a030: 6768 7422 2c0a 2020 2020 2020 2020 2020  ght",.          
+0001a040: 2020 6669 6c6c 5f63 6f6c 6f72 3d22 2361    fill_color="#a
+0001a050: 6161 6161 6122 2c0a 2020 2020 2020 2020  aaaaa",.        
+0001a060: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
+0001a070: 2361 6161 6161 6122 2c0a 2020 2020 2020  #aaaaaa",.      
+0001a080: 2020 2020 2020 6669 6c6c 5f61 6c70 6861        fill_alpha
+0001a090: 3d30 2e31 2c0a 2020 2020 2020 2020 2020  =0.1,.          
+0001a0a0: 2020 6c69 6e65 5f61 6c70 6861 3d30 2e33    line_alpha=0.3
+0001a0b0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0001a0c0: 2020 2020 7365 6c66 2e72 6f6f 742e 7175      self.root.qu
+0001a0d0: 6164 280a 2020 2020 2020 2020 2020 2020  ad(.            
+0001a0e0: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+0001a0f0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0001a100: 746f 703d 2274 6f70 222c 0a20 2020 2020  top="top",.     
+0001a110: 2020 2020 2020 2062 6f74 746f 6d3d 2262         bottom="b
+0001a120: 6f74 746f 6d22 2c0a 2020 2020 2020 2020  ottom",.        
+0001a130: 2020 2020 6c65 6674 3d22 6c65 6674 222c      left="left",
+0001a140: 0a20 2020 2020 2020 2020 2020 2072 6967  .            rig
+0001a150: 6874 3d22 7265 6c65 6173 6564 2d6c 6f63  ht="released-loc
+0001a160: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+0001a170: 696c 6c5f 636f 6c6f 723d 2263 6f6c 6f72  ill_color="color
+0001a180: 222c 0a20 2020 2020 2020 2020 2020 206c  ",.            l
+0001a190: 696e 655f 636f 6c6f 723d 2263 6f6c 6f72  ine_color="color
+0001a1a0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+0001a1b0: 696c 6c5f 616c 7068 613d 302e 362c 0a20  ill_alpha=0.6,. 
+0001a1c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001a1d0: 2073 656c 662e 726f 6f74 2e71 7561 6428   self.root.quad(
+0001a1e0: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+0001a1f0: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+0001a200: 0a20 2020 2020 2020 2020 2020 2074 6f70  .            top
+0001a210: 3d22 746f 7022 2c0a 2020 2020 2020 2020  ="top",.        
+0001a220: 2020 2020 626f 7474 6f6d 3d22 626f 7474      bottom="bott
+0001a230: 6f6d 222c 0a20 2020 2020 2020 2020 2020  om",.           
+0001a240: 206c 6566 743d 2272 656c 6561 7365 642d   left="released-
 0001a250: 6c6f 6322 2c0a 2020 2020 2020 2020 2020  loc",.          
-0001a260: 2020 6669 6c6c 5f63 6f6c 6f72 3d22 636f    fill_color="co
-0001a270: 6c6f 7222 2c0a 2020 2020 2020 2020 2020  lor",.          
-0001a280: 2020 6c69 6e65 5f63 6f6c 6f72 3d22 636f    line_color="co
+0001a260: 2020 7269 6768 743d 226d 656d 6f72 792d    right="memory-
+0001a270: 6c6f 6322 2c0a 2020 2020 2020 2020 2020  loc",.          
+0001a280: 2020 6669 6c6c 5f63 6f6c 6f72 3d22 636f    fill_color="co
 0001a290: 6c6f 7222 2c0a 2020 2020 2020 2020 2020  lor",.          
-0001a2a0: 2020 6669 6c6c 5f61 6c70 6861 3d31 2e30    fill_alpha=1.0
-0001a2b0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-0001a2c0: 2020 2020 7365 6c66 2e72 6f6f 742e 7175      self.root.qu
-0001a2d0: 6164 280a 2020 2020 2020 2020 2020 2020  ad(.            
-0001a2e0: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
-0001a2f0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-0001a300: 746f 703d 2274 6f70 222c 0a20 2020 2020  top="top",.     
-0001a310: 2020 2020 2020 2062 6f74 746f 6d3d 2262         bottom="b
-0001a320: 6f74 746f 6d22 2c0a 2020 2020 2020 2020  ottom",.        
-0001a330: 2020 2020 6c65 6674 3d22 6d65 6d6f 7279      left="memory
-0001a340: 2d6c 6f63 222c 0a20 2020 2020 2020 2020  -loc",.         
-0001a350: 2020 2072 6967 6874 3d22 6572 7265 642d     right="erred-
-0001a360: 6c6f 6322 2c0a 2020 2020 2020 2020 2020  loc",.          
-0001a370: 2020 6669 6c6c 5f63 6f6c 6f72 3d22 626c    fill_color="bl
-0001a380: 6163 6b22 2c0a 2020 2020 2020 2020 2020  ack",.          
-0001a390: 2020 6669 6c6c 5f61 6c70 6861 3d30 2e35    fill_alpha=0.5
-0001a3a0: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
-0001a3b0: 6e65 5f61 6c70 6861 3d30 2c0a 2020 2020  ne_alpha=0,.    
-0001a3c0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
-0001a3d0: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
-0001a3e0: 2020 2020 2020 2020 2020 736f 7572 6365            source
-0001a3f0: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
-0001a400: 2020 2020 2020 2020 2020 746f 703d 2274            top="t
-0001a410: 6f70 222c 0a20 2020 2020 2020 2020 2020  op",.           
-0001a420: 2062 6f74 746f 6d3d 2262 6f74 746f 6d22   bottom="bottom"
-0001a430: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
-0001a440: 6674 3d22 6572 7265 642d 6c6f 6322 2c0a  ft="erred-loc",.
-0001a450: 2020 2020 2020 2020 2020 2020 7269 6768              righ
-0001a460: 743d 2270 726f 6365 7373 696e 672d 6c6f  t="processing-lo
-0001a470: 6322 2c0a 2020 2020 2020 2020 2020 2020  c",.            
-0001a480: 6669 6c6c 5f63 6f6c 6f72 3d22 6772 6179  fill_color="gray
-0001a490: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
-0001a4a0: 696c 6c5f 616c 7068 613d 302e 3335 2c0a  ill_alpha=0.35,.
-0001a4b0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
-0001a4c0: 5f61 6c70 6861 3d30 2c0a 2020 2020 2020  _alpha=0,.      
-0001a4d0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-0001a4e0: 2e72 6f6f 742e 7175 6164 280a 2020 2020  .root.quad(.    
-0001a4f0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-0001a500: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
-0001a510: 2020 2020 2020 2020 746f 703d 2274 6f70          top="top
-0001a520: 222c 0a20 2020 2020 2020 2020 2020 2062  ",.            b
-0001a530: 6f74 746f 6d3d 2262 6f74 746f 6d22 2c0a  ottom="bottom",.
-0001a540: 2020 2020 2020 2020 2020 2020 6c65 6674              left
-0001a550: 3d22 7072 6f63 6573 7369 6e67 2d6c 6f63  ="processing-loc
-0001a560: 222c 0a20 2020 2020 2020 2020 2020 2072  ",.            r
-0001a570: 6967 6874 3d22 7175 6575 6564 2d6c 6f63  ight="queued-loc
-0001a580: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
-0001a590: 696c 6c5f 636f 6c6f 723d 2267 7261 7922  ill_color="gray"
-0001a5a0: 2c0a 2020 2020 2020 2020 2020 2020 6861  ,.            ha
-0001a5b0: 7463 685f 7061 7474 6572 6e3d 222f 222c  tch_pattern="/",
-0001a5c0: 0a20 2020 2020 2020 2020 2020 2068 6174  .            hat
-0001a5d0: 6368 5f63 6f6c 6f72 3d22 7768 6974 6522  ch_color="white"
-0001a5e0: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
-0001a5f0: 6c6c 5f61 6c70 6861 3d30 2e33 352c 0a20  ll_alpha=0.35,. 
-0001a600: 2020 2020 2020 2020 2020 206c 696e 655f             line_
-0001a610: 616c 7068 613d 302c 0a20 2020 2020 2020  alpha=0,.       
-0001a620: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-0001a630: 726f 6f74 2e71 7561 6428 0a20 2020 2020  root.quad(.     
-0001a640: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-0001a650: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
-0001a660: 2020 2020 2020 2074 6f70 3d22 746f 7022         top="top"
-0001a670: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
-0001a680: 7474 6f6d 3d22 626f 7474 6f6d 222c 0a20  ttom="bottom",. 
-0001a690: 2020 2020 2020 2020 2020 206c 6566 743d             left=
-0001a6a0: 2271 7565 7565 642d 6c6f 6322 2c0a 2020  "queued-loc",.  
-0001a6b0: 2020 2020 2020 2020 2020 7269 6768 743d            right=
-0001a6c0: 226e 6f2d 776f 726b 6572 2d6c 6f63 222c  "no-worker-loc",
-0001a6d0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-0001a6e0: 6c5f 636f 6c6f 723d 2272 6564 222c 0a20  l_color="red",. 
-0001a6f0: 2020 2020 2020 2020 2020 2068 6174 6368             hatch
-0001a700: 5f70 6174 7465 726e 3d22 2f22 2c0a 2020  _pattern="/",.  
-0001a710: 2020 2020 2020 2020 2020 6861 7463 685f            hatch_
-0001a720: 636f 6c6f 723d 2262 6c61 636b 222c 0a20  color="black",. 
-0001a730: 2020 2020 2020 2020 2020 2066 696c 6c5f             fill_
-0001a740: 616c 7068 613d 302e 3335 2c0a 2020 2020  alpha=0.35,.    
-0001a750: 2020 2020 2020 2020 6c69 6e65 5f61 6c70          line_alp
-0001a760: 6861 3d30 2c0a 2020 2020 2020 2020 290a  ha=0,.        ).
-0001a770: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0001a780: 742e 7465 7874 280a 2020 2020 2020 2020  t.text(.        
-0001a790: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-0001a7a0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0001a7b0: 2020 2020 7465 7874 3d22 7368 6f77 2d6e      text="show-n
-0001a7c0: 616d 6522 2c0a 2020 2020 2020 2020 2020  ame",.          
-0001a7d0: 2020 793d 2262 6f74 746f 6d22 2c0a 2020    y="bottom",.  
-0001a7e0: 2020 2020 2020 2020 2020 783d 226c 6566            x="lef
-0001a7f0: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
-0001a800: 785f 6f66 6673 6574 3d35 2c0a 2020 2020  x_offset=5,.    
-0001a810: 2020 2020 2020 2020 7465 7874 5f66 6f6e          text_fon
-0001a820: 745f 7369 7a65 3d76 616c 7565 2822 3130  t_size=value("10
-0001a830: 7074 2229 2c0a 2020 2020 2020 2020 290a  pt"),.        ).
-0001a840: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
-0001a850: 742e 7465 7874 280a 2020 2020 2020 2020  t.text(.        
-0001a860: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-0001a870: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0001a880: 2020 2020 7465 7874 3d22 646f 6e65 222c      text="done",
-0001a890: 0a20 2020 2020 2020 2020 2020 2079 3d22  .            y="
-0001a8a0: 626f 7474 6f6d 222c 0a20 2020 2020 2020  bottom",.       
-0001a8b0: 2020 2020 2078 3d22 7269 6768 7422 2c0a       x="right",.
-0001a8c0: 2020 2020 2020 2020 2020 2020 785f 6f66              x_of
-0001a8d0: 6673 6574 3d2d 352c 0a20 2020 2020 2020  fset=-5,.       
-0001a8e0: 2020 2020 2074 6578 745f 616c 6967 6e3d       text_align=
-0001a8f0: 2272 6967 6874 222c 0a20 2020 2020 2020  "right",.       
-0001a900: 2020 2020 2074 6578 745f 666f 6e74 5f73       text_font_s
-0001a910: 697a 653d 7661 6c75 6528 2231 3070 7422  ize=value("10pt"
-0001a920: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
-0001a930: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
-0001a940: 6772 6964 2e76 6973 6962 6c65 203d 2046  grid.visible = F
-0001a950: 616c 7365 0a20 2020 2020 2020 2073 656c  alse.        sel
-0001a960: 662e 726f 6f74 2e79 6178 6973 2e6d 696e  f.root.yaxis.min
-0001a970: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
-0001a980: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
-0001a990: 656c 662e 726f 6f74 2e79 6178 6973 2e76  elf.root.yaxis.v
-0001a9a0: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
-0001a9b0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
-0001a9c0: 2e78 6772 6964 2e76 6973 6962 6c65 203d  .xgrid.visible =
-0001a9d0: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
-0001a9e0: 656c 662e 726f 6f74 2e78 6178 6973 2e6d  elf.root.xaxis.m
-0001a9f0: 696e 6f72 5f74 6963 6b5f 6c69 6e65 5f61  inor_tick_line_a
-0001aa00: 6c70 6861 203d 2030 0a20 2020 2020 2020  lpha = 0.       
-0001aa10: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
-0001aa20: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
-0001aa30: 0a0a 2020 2020 2020 2020 686f 7665 7220  ..        hover 
-0001aa40: 3d20 486f 7665 7254 6f6f 6c28 0a20 2020  = HoverTool(.   
-0001aa50: 2020 2020 2020 2020 2070 6f69 6e74 5f70           point_p
-0001aa60: 6f6c 6963 793d 2266 6f6c 6c6f 775f 6d6f  olicy="follow_mo
-0001aa70: 7573 6522 2c0a 2020 2020 2020 2020 2020  use",.          
-0001aa80: 2020 746f 6f6c 7469 7073 3d22 2222 0a20    tooltips=""". 
-0001aa90: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0001aaa0: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-0001aab0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-0001aac0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-0001aad0: 2031 3470 783b 2066 6f6e 742d 7765 6967   14px; font-weig
-0001aae0: 6874 3a20 626f 6c64 3b22 3e4e 616d 653a  ht: bold;">Name:
-0001aaf0: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
-0001ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ab10: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
-0001ab20: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
-0001ab30: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
-0001ab40: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
-0001ab50: 3e40 6e61 6d65 3c2f 7370 616e 3e0a 2020  >@name</span>.  
-0001ab60: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
-0001ab70: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-0001ab80: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
-0001ab90: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0001aba0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-0001abb0: 2d73 697a 653a 2031 3470 783b 2066 6f6e  -size: 14px; fon
-0001abc0: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
-0001abd0: 3e41 6c6c 3a3c 2f73 7061 6e3e 266e 6273  >All:</span>&nbs
-0001abe0: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
-0001abf0: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-0001ac00: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-0001ac10: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
-0001ac20: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
-0001ac30: 6163 653b 223e 4061 6c6c 3c2f 7370 616e  ace;">@all</span
-0001ac40: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
-0001ac50: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
-0001ac60: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
-0001ac70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac80: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-0001ac90: 666f 6e74 2d73 697a 653a 2031 3470 783b  font-size: 14px;
-0001aca0: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
-0001acb0: 6c64 3b22 3e51 7565 7565 643a 3c2f 7370  ld;">Queued:</sp
-0001acc0: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
-0001acd0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
-0001ace0: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
-0001acf0: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
-0001ad00: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
-0001ad10: 206d 6f6e 6f73 7061 6365 3b22 3e40 7175   monospace;">@qu
-0001ad20: 6575 6564 3c2f 7370 616e 3e0a 2020 2020  eued</span>.    
-0001ad30: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
-0001ad40: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-0001ad50: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
-0001ad60: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-0001ad70: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-0001ad80: 697a 653a 2031 3470 783b 2066 6f6e 742d  ize: 14px; font-
-0001ad90: 7765 6967 6874 3a20 626f 6c64 3b22 3e4e  weight: bold;">N
-0001ada0: 6f2d 776f 726b 6572 3a3c 2f73 7061 6e3e  o-worker:</span>
-0001adb0: 266e 6273 703b 0a20 2020 2020 2020 2020  &nbsp;.         
-0001adc0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-0001add0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-0001ade0: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
-0001adf0: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
-0001ae00: 6e6f 7370 6163 653b 223e 406e 6f5f 776f  nospace;">@no_wo
-0001ae10: 726b 6572 3c2f 7370 616e 3e0a 2020 2020  rker</span>.    
-0001ae20: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
-0001ae30: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
-0001ae40: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
-0001ae50: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
-0001ae60: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
-0001ae70: 697a 653a 2031 3470 783b 2066 6f6e 742d  ize: 14px; font-
-0001ae80: 7765 6967 6874 3a20 626f 6c64 3b22 3e50  weight: bold;">P
-0001ae90: 726f 6365 7373 696e 673a 3c2f 7370 616e  rocessing:</span
-0001aea0: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
-0001aeb0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
-0001aec0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
-0001aed0: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
-0001aee0: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
-0001aef0: 6f6e 6f73 7061 6365 3b22 3e40 7072 6f63  onospace;">@proc
-0001af00: 6573 7369 6e67 3c2f 7370 616e 3e0a 2020  essing</span>.  
-0001af10: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
-0001af20: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-0001af30: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
-0001af40: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0001af50: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
-0001af60: 2d73 697a 653a 2031 3470 783b 2066 6f6e  -size: 14px; fon
-0001af70: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
-0001af80: 3e4d 656d 6f72 793a 3c2f 7370 616e 3e26  >Memory:</span>&
-0001af90: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
-0001afa0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
-0001afb0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
-0001afc0: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
-0001afd0: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
-0001afe0: 6f73 7061 6365 3b22 3e40 6d65 6d6f 7279  ospace;">@memory
-0001aff0: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
-0001b000: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
-0001b010: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-0001b020: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-0001b030: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
-0001b040: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
-0001b050: 2031 3470 783b 2066 6f6e 742d 7765 6967   14px; font-weig
-0001b060: 6874 3a20 626f 6c64 3b22 3e45 7272 6564  ht: bold;">Erred
-0001b070: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
-0001b080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b090: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
-0001b0a0: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
-0001b0b0: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
-0001b0c0: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
-0001b0d0: 223e 4065 7272 6564 3c2f 7370 616e 3e0a  ">@erred</span>.
-0001b0e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b0f0: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
-0001b100: 2020 2020 2020 2022 2222 2c0a 2020 2020         """,.    
-0001b110: 2020 2020 290a 2020 2020 2020 2020 6865      ).        he
-0001b120: 6c70 5f20 3d20 4865 6c70 546f 6f6c 280a  lp_ = HelpTool(.
-0001b130: 2020 2020 2020 2020 2020 2020 7265 6469              redi
-0001b140: 7265 6374 3d22 6874 7470 733a 2f2f 646f  rect="https://do
-0001b150: 6373 2e64 6173 6b2e 6f72 672f 656e 2f73  cs.dask.org/en/s
-0001b160: 7461 626c 652f 6461 7368 626f 6172 642e  table/dashboard.
-0001b170: 6874 6d6c 2370 726f 6772 6573 7322 2c0a  html#progress",.
-0001b180: 2020 2020 2020 2020 2020 2020 6465 7363              desc
-0001b190: 7269 7074 696f 6e3d 2241 2064 6573 6372  ription="A descr
-0001b1a0: 6970 7469 6f6e 206f 6620 7468 6520 7072  iption of the pr
-0001b1b0: 6f67 7265 7373 2062 6172 7320 706c 6f74  ogress bars plot
-0001b1c0: 2e22 2c0a 2020 2020 2020 2020 290a 2020  .",.        ).  
-0001b1d0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
-0001b1e0: 6164 645f 746f 6f6c 7328 686f 7665 722c  add_tools(hover,
-0001b1f0: 2068 656c 705f 290a 0a20 2020 2040 7769   help_)..    @wi
-0001b200: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
-0001b210: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
-0001b220: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
-0001b230: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
-0001b240: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
-0001b250: 7b0a 2020 2020 2020 2020 2020 2020 226d  {.            "m
-0001b260: 656d 6f72 7922 3a20 7b7d 2c0a 2020 2020  emory": {},.    
-0001b270: 2020 2020 2020 2020 2265 7272 6564 223a          "erred":
-0001b280: 207b 7d2c 0a20 2020 2020 2020 2020 2020   {},.           
-0001b290: 2022 7265 6c65 6173 6564 223a 207b 7d2c   "released": {},
-0001b2a0: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
-0001b2b0: 6f63 6573 7369 6e67 223a 207b 7d2c 0a20  ocessing": {},. 
-0001b2c0: 2020 2020 2020 2020 2020 2022 7761 6974             "wait
-0001b2d0: 696e 6722 3a20 7b7d 2c0a 2020 2020 2020  ing": {},.      
-0001b2e0: 2020 2020 2020 2271 7565 7565 6422 3a20        "queued": 
-0001b2f0: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
-0001b300: 226e 6f5f 776f 726b 6572 223a 207b 7d2c  "no_worker": {},
-0001b310: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-0001b320: 2020 2020 666f 7220 7470 2069 6e20 7365      for tp in se
-0001b330: 6c66 2e73 6368 6564 756c 6572 2e74 6173  lf.scheduler.tas
-0001b340: 6b5f 7072 6566 6978 6573 2e76 616c 7565  k_prefixes.value
-0001b350: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0001b360: 2061 6374 6976 655f 7374 6174 6573 203d   active_states =
-0001b370: 2074 702e 6163 7469 7665 5f73 7461 7465   tp.active_state
-0001b380: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
-0001b390: 2061 6e79 2861 6374 6976 655f 7374 6174   any(active_stat
-0001b3a0: 6573 2e67 6574 2873 2920 666f 7220 7320  es.get(s) for s 
-0001b3b0: 696e 2073 7461 7465 2e6b 6579 7328 2929  in state.keys())
-0001b3c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001b3d0: 2020 7374 6174 655b 226d 656d 6f72 7922    state["memory"
-0001b3e0: 5d5b 7470 2e6e 616d 655d 203d 2061 6374  ][tp.name] = act
-0001b3f0: 6976 655f 7374 6174 6573 5b22 6d65 6d6f  ive_states["memo
-0001b400: 7279 225d 0a20 2020 2020 2020 2020 2020  ry"].           
-0001b410: 2020 2020 2073 7461 7465 5b22 6572 7265       state["erre
-0001b420: 6422 5d5b 7470 2e6e 616d 655d 203d 2061  d"][tp.name] = a
-0001b430: 6374 6976 655f 7374 6174 6573 5b22 6572  ctive_states["er
-0001b440: 7265 6422 5d0a 2020 2020 2020 2020 2020  red"].          
-0001b450: 2020 2020 2020 7374 6174 655b 2272 656c        state["rel
-0001b460: 6561 7365 6422 5d5b 7470 2e6e 616d 655d  eased"][tp.name]
-0001b470: 203d 2061 6374 6976 655f 7374 6174 6573   = active_states
-0001b480: 5b22 7265 6c65 6173 6564 225d 0a20 2020  ["released"].   
-0001b490: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-0001b4a0: 7465 5b22 7072 6f63 6573 7369 6e67 225d  te["processing"]
-0001b4b0: 5b74 702e 6e61 6d65 5d20 3d20 6163 7469  [tp.name] = acti
-0001b4c0: 7665 5f73 7461 7465 735b 2270 726f 6365  ve_states["proce
-0001b4d0: 7373 696e 6722 5d0a 2020 2020 2020 2020  ssing"].        
-0001b4e0: 2020 2020 2020 2020 7374 6174 655b 2277          state["w
-0001b4f0: 6169 7469 6e67 225d 5b74 702e 6e61 6d65  aiting"][tp.name
-0001b500: 5d20 3d20 6163 7469 7665 5f73 7461 7465  ] = active_state
-0001b510: 735b 2277 6169 7469 6e67 225d 0a20 2020  s["waiting"].   
-0001b520: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-0001b530: 7465 5b22 7175 6575 6564 225d 5b74 702e  te["queued"][tp.
-0001b540: 6e61 6d65 5d20 3d20 6163 7469 7665 5f73  name] = active_s
-0001b550: 7461 7465 735b 2271 7565 7565 6422 5d0a  tates["queued"].
-0001b560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001b570: 7374 6174 655b 226e 6f5f 776f 726b 6572  state["no_worker
-0001b580: 225d 5b74 702e 6e61 6d65 5d20 3d20 6163  "][tp.name] = ac
-0001b590: 7469 7665 5f73 7461 7465 735b 226e 6f2d  tive_states["no-
-0001b5a0: 776f 726b 6572 225d 0a0a 2020 2020 2020  worker"]..      
-0001b5b0: 2020 7374 6174 655b 2261 6c6c 225d 203d    state["all"] =
-0001b5c0: 207b 6b3a 2073 756d 2876 5b6b 5d20 666f   {k: sum(v[k] fo
-0001b5d0: 7220 7620 696e 2073 7461 7465 2e76 616c  r v in state.val
-0001b5e0: 7565 7328 2929 2066 6f72 206b 2069 6e20  ues()) for k in 
-0001b5f0: 7374 6174 655b 226d 656d 6f72 7922 5d7d  state["memory"]}
-0001b600: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-0001b610: 2073 7461 7465 5b22 616c 6c22 5d20 616e   state["all"] an
-0001b620: 6420 6e6f 7420 6c65 6e28 7365 6c66 2e73  d not len(self.s
-0001b630: 6f75 7263 652e 6461 7461 5b22 616c 6c22  ource.data["all"
-0001b640: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
-0001b650: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-0001b660: 6420 3d20 7072 6f67 7265 7373 5f71 7561  d = progress_qua
-0001b670: 6473 2873 7461 7465 290a 0a20 2020 2020  ds(state)..     
-0001b680: 2020 2075 7064 6174 6528 7365 6c66 2e73     update(self.s
-0001b690: 6f75 7263 652c 2064 290a 0a20 2020 2020  ource, d)..     
-0001b6a0: 2020 2074 6f74 616c 7320 3d20 7b0a 2020     totals = {.  
-0001b6b0: 2020 2020 2020 2020 2020 6b3a 2073 756d            k: sum
-0001b6c0: 2873 7461 7465 5b6b 5d2e 7661 6c75 6573  (state[k].values
-0001b6d0: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
-0001b6e0: 666f 7220 6b20 696e 205b 0a20 2020 2020  for k in [.     
-0001b6f0: 2020 2020 2020 2020 2020 2022 616c 6c22             "all"
-0001b700: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001b710: 2020 226d 656d 6f72 7922 2c0a 2020 2020    "memory",.    
-0001b720: 2020 2020 2020 2020 2020 2020 2265 7272              "err
-0001b730: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
-0001b740: 2020 2020 2022 7265 6c65 6173 6564 222c       "released",
-0001b750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b760: 2022 7761 6974 696e 6722 2c0a 2020 2020   "waiting",.    
-0001b770: 2020 2020 2020 2020 2020 2020 2271 7565              "que
-0001b780: 7565 6422 2c0a 2020 2020 2020 2020 2020  ued",.          
-0001b790: 2020 2020 2020 226e 6f5f 776f 726b 6572        "no_worker
-0001b7a0: 222c 0a20 2020 2020 2020 2020 2020 205d  ",.            ]
-0001b7b0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-0001b7c0: 2020 2074 6f74 616c 735b 2270 726f 6365     totals["proce
-0001b7d0: 7373 696e 6722 5d20 3d20 746f 7461 6c73  ssing"] = totals
-0001b7e0: 5b22 616c 6c22 5d20 2d20 7375 6d28 0a20  ["all"] - sum(. 
-0001b7f0: 2020 2020 2020 2020 2020 2076 2066 6f72             v for
-0001b800: 206b 2c20 7620 696e 2074 6f74 616c 732e   k, v in totals.
-0001b810: 6974 656d 7328 2920 6966 206b 2021 3d20  items() if k != 
-0001b820: 2261 6c6c 220a 2020 2020 2020 2020 290a  "all".        ).
-0001b830: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-0001b840: 6f74 2e74 6974 6c65 2e74 6578 7420 3d20  ot.title.text = 
-0001b850: 280a 2020 2020 2020 2020 2020 2020 2250  (.            "P
-0001b860: 726f 6772 6573 7320 2d2d 2074 6f74 616c  rogress -- total
-0001b870: 3a20 2528 616c 6c29 732c 2022 0a20 2020  : %(all)s, ".   
-0001b880: 2020 2020 2020 2020 2022 7761 6974 696e           "waitin
-0001b890: 673a 2025 2877 6169 7469 6e67 2973 2c20  g: %(waiting)s, 
-0001b8a0: 220a 2020 2020 2020 2020 2020 2020 2271  ".            "q
-0001b8b0: 7565 7565 643a 2025 2871 7565 7565 6429  ueued: %(queued)
-0001b8c0: 732c 2022 0a20 2020 2020 2020 2020 2020  s, ".           
-0001b8d0: 2022 7072 6f63 6573 7369 6e67 3a20 2528   "processing: %(
-0001b8e0: 7072 6f63 6573 7369 6e67 2973 2c20 220a  processing)s, ".
-0001b8f0: 2020 2020 2020 2020 2020 2020 2269 6e2d              "in-
-0001b900: 6d65 6d6f 7279 3a20 2528 6d65 6d6f 7279  memory: %(memory
-0001b910: 2973 2c20 220a 2020 2020 2020 2020 2020  )s, ".          
-0001b920: 2020 226e 6f2d 776f 726b 6572 3a20 2528    "no-worker: %(
-0001b930: 6e6f 5f77 6f72 6b65 7229 732c 2022 0a20  no_worker)s, ". 
-0001b940: 2020 2020 2020 2020 2020 2022 6572 7265             "erre
-0001b950: 643a 2025 2865 7272 6564 2973 2220 2520  d: %(erred)s" % 
-0001b960: 746f 7461 6c73 0a20 2020 2020 2020 2029  totals.        )
-0001b970: 0a0a 0a63 6c61 7373 2046 696e 6550 6572  ...class FinePer
-0001b980: 666f 726d 616e 6365 4d65 7472 6963 7328  formanceMetrics(
-0001b990: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
-0001b9a0: 6e74 293a 0a20 2020 2022 2222 0a20 2020  nt):.    """.   
-0001b9b0: 2054 6865 206d 6169 6e20 6f76 6572 7669   The main overvi
-0001b9c0: 6577 206f 6620 7468 6520 4669 6e65 2050  ew of the Fine P
-0001b9d0: 6572 666f 726d 616e 6365 204d 6574 7269  erformance Metri
-0001b9e0: 6373 2070 6167 652e 0a20 2020 2022 2222  cs page..    """
-0001b9f0: 0a0a 2020 2020 4241 5345 5f54 4f4f 4c53  ..    BASE_TOOLS
-0001ba00: 203d 205b 2270 616e 222c 2022 7768 6565   = ["pan", "whee
-0001ba10: 6c5f 7a6f 6f6d 222c 2022 626f 785f 7a6f  l_zoom", "box_zo
-0001ba20: 6f6d 222c 2022 7265 7365 7422 5d0a 2020  om", "reset"].  
-0001ba30: 2020 7363 6865 6475 6c65 723a 2053 6368    scheduler: Sch
-0001ba40: 6564 756c 6572 0a20 2020 2074 6173 6b5f  eduler.    task_
-0001ba50: 6578 6563 5f62 795f 7072 6566 6978 5f73  exec_by_prefix_s
-0001ba60: 7263 3a20 436f 6c75 6d6e 4461 7461 536f  rc: ColumnDataSo
-0001ba70: 7572 6365 0a20 2020 2074 6173 6b5f 6578  urce.    task_ex
-0001ba80: 6563 5f62 795f 7072 6566 6978 5f78 6d61  ec_by_prefix_xma
-0001ba90: 783a 2066 6c6f 6174 0a20 2020 2074 6173  x: float.    tas
-0001baa0: 6b5f 6578 6563 5f62 795f 6163 7469 7669  k_exec_by_activi
-0001bab0: 7479 5f73 7263 3a20 436f 6c75 6d6e 4461  ty_src: ColumnDa
-0001bac0: 7461 536f 7572 6365 0a20 2020 2067 6574  taSource.    get
-0001bad0: 5f64 6174 615f 6279 5f61 6374 6976 6974  _data_by_activit
-0001bae0: 795f 7372 633a 2043 6f6c 756d 6e44 6174  y_src: ColumnDat
-0001baf0: 6153 6f75 7263 650a 2020 2020 7375 6273  aSource.    subs
-0001bb00: 7461 6e74 6961 6c5f 6368 616e 6765 3a20  tantial_change: 
-0001bb10: 626f 6f6c 0a20 2020 2076 6973 6962 6c65  bool.    visible
-0001bb20: 5f66 756e 6374 696f 6e73 3a20 6c69 7374  _functions: list
-0001bb30: 5b73 7472 5d0a 2020 2020 7669 7369 626c  [str].    visibl
-0001bb40: 655f 6163 7469 7669 7469 6573 3a20 6c69  e_activities: li
-0001bb50: 7374 5b73 7472 5d0a 2020 2020 7374 6163  st[str].    stac
-0001bb60: 6b65 645f 6368 6172 745f 7669 7369 626c  ked_chart_visibl
-0001bb70: 655f 6163 7469 7669 7469 6573 3a20 6c69  e_activities: li
-0001bb80: 7374 5b73 7472 5d0a 2020 2020 6675 6e63  st[str].    func
-0001bb90: 7469 6f6e 5f73 656c 6563 746f 723a 204d  tion_selector: M
-0001bba0: 756c 7469 4368 6f69 6365 0a20 2020 2073  ultiChoice.    s
-0001bbb0: 7061 6e5f 7461 675f 7365 6c65 6374 6f72  pan_tag_selector
-0001bbc0: 3a20 4d75 6c74 6943 686f 6963 650a 2020  : MultiChoice.  
-0001bbd0: 2020 756e 6974 5f73 656c 6563 746f 723a    unit_selector:
-0001bbe0: 2053 656c 6563 740a 2020 2020 7461 736b   Select.    task
-0001bbf0: 5f65 7865 635f 6279 5f61 6374 6976 6974  _exec_by_activit
-0001bc00: 795f 6368 6172 743a 2066 6967 7572 6520  y_chart: figure 
-0001bc10: 7c20 4e6f 6e65 0a20 2020 2074 6173 6b5f  | None.    task_
-0001bc20: 6578 6563 5f62 795f 7072 6566 6978 5f63  exec_by_prefix_c
-0001bc30: 6861 7274 3a20 6669 6775 7265 207c 204e  hart: figure | N
-0001bc40: 6f6e 650a 2020 2020 6765 745f 6461 7461  one.    get_data
-0001bc50: 5f62 795f 6163 7469 7669 7479 5f63 6861  _by_activity_cha
-0001bc60: 7274 3a20 6669 6775 7265 207c 204e 6f6e  rt: figure | Non
-0001bc70: 650a 0a20 2020 2040 6c6f 675f 6572 726f  e..    @log_erro
-0001bc80: 7273 0a20 2020 2064 6566 205f 5f69 6e69  rs.    def __ini
-0001bc90: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
-0001bca0: 6c65 723a 2053 6368 6564 756c 6572 2c20  ler: Scheduler, 
-0001bcb0: 2a2a 6b77 6172 6773 3a20 416e 7929 3a0a  **kwargs: Any):.
-0001bcc0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-0001bcd0: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
-0001bce0: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
-0001bcf0: 7461 736b 5f65 7865 635f 6279 5f70 7265  task_exec_by_pre
-0001bd00: 6669 785f 7372 6320 3d20 436f 6c75 6d6e  fix_src = Column
-0001bd10: 4461 7461 536f 7572 6365 2864 6174 613d  DataSource(data=
-0001bd20: 7b7d 290a 2020 2020 2020 2020 7365 6c66  {}).        self
-0001bd30: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
-0001bd40: 6566 6978 5f78 6d61 7820 3d20 302e 300a  efix_xmax = 0.0.
-0001bd50: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0001bd60: 6b5f 6578 6563 5f62 795f 6163 7469 7669  k_exec_by_activi
-0001bd70: 7479 5f73 7263 203d 2043 6f6c 756d 6e44  ty_src = ColumnD
-0001bd80: 6174 6153 6f75 7263 6528 6461 7461 3d7b  ataSource(data={
-0001bd90: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
-0001bda0: 6765 745f 6461 7461 5f62 795f 6163 7469  get_data_by_acti
-0001bdb0: 7669 7479 5f73 7263 203d 2043 6f6c 756d  vity_src = Colum
-0001bdc0: 6e44 6174 6153 6f75 7263 6528 6461 7461  nDataSource(data
-0001bdd0: 3d7b 7d29 0a20 2020 2020 2020 2073 656c  ={}).        sel
-0001bde0: 662e 7375 6273 7461 6e74 6961 6c5f 6368  f.substantial_ch
-0001bdf0: 616e 6765 203d 2046 616c 7365 0a20 2020  ange = False.   
-0001be00: 2020 2020 2073 656c 662e 7669 7369 626c       self.visibl
-0001be10: 655f 6675 6e63 7469 6f6e 7320 3d20 5b5d  e_functions = []
-0001be20: 0a20 2020 2020 2020 2073 656c 662e 7669  .        self.vi
-0001be30: 7369 626c 655f 6163 7469 7669 7469 6573  sible_activities
-0001be40: 203d 205b 5d0a 2020 2020 2020 2020 7365   = [].        se
-0001be50: 6c66 2e73 7461 636b 6564 5f63 6861 7274  lf.stacked_chart
-0001be60: 5f76 6973 6962 6c65 5f61 6374 6976 6974  _visible_activit
-0001be70: 6965 7320 3d20 5b5d 0a20 2020 2020 2020  ies = [].       
-0001be80: 2073 656c 662e 7461 736b 5f65 7865 635f   self.task_exec_
-0001be90: 6279 5f61 6374 6976 6974 795f 6368 6172  by_activity_char
-0001bea0: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
-0001beb0: 2073 656c 662e 7461 736b 5f65 7865 635f   self.task_exec_
-0001bec0: 6279 5f70 7265 6669 785f 6368 6172 7420  by_prefix_chart 
-0001bed0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-0001bee0: 656c 662e 6765 745f 6461 7461 5f62 795f  elf.get_data_by_
-0001bef0: 6163 7469 7669 7479 5f63 6861 7274 203d  activity_chart =
-0001bf00: 204e 6f6e 650a 0a20 2020 2020 2020 2023   None..        #
-0001bf10: 2053 656c 6563 746f 7273 0a20 2020 2020   Selectors.     
-0001bf20: 2020 2073 656c 662e 6675 6e63 7469 6f6e     self.function
-0001bf30: 5f73 656c 6563 746f 7220 3d20 4d75 6c74  _selector = Mult
-0001bf40: 6943 686f 6963 6528 0a20 2020 2020 2020  iChoice(.       
-0001bf50: 2020 2020 2074 6974 6c65 3d22 4669 6c74       title="Filt
-0001bf60: 6572 2062 7920 6675 6e63 7469 6f6e 222c  er by function",
-0001bf70: 0a20 2020 2020 2020 2020 2020 2070 6c61  .            pla
-0001bf80: 6365 686f 6c64 6572 3d22 5365 6c65 6374  ceholder="Select
-0001bf90: 2073 7065 6369 6669 6320 6675 6e63 7469   specific functi
-0001bfa0: 6f6e 7322 2c0a 2020 2020 2020 2020 2020  ons",.          
-0001bfb0: 2020 7661 6c75 653d 5b5d 2c0a 2020 2020    value=[],.    
-0001bfc0: 2020 2020 2020 2020 6f70 7469 6f6e 733d          options=
-0001bfd0: 5b5d 2c0a 2020 2020 2020 2020 290a 2020  [],.        ).  
-0001bfe0: 2020 2020 2020 7365 6c66 2e73 7061 6e5f        self.span_
-0001bff0: 7461 675f 7365 6c65 6374 6f72 203d 204d  tag_selector = M
-0001c000: 756c 7469 4368 6f69 6365 280a 2020 2020  ultiChoice(.    
-0001c010: 2020 2020 2020 2020 7469 746c 653d 2246          title="F
-0001c020: 696c 7465 7220 6279 2073 7061 6e20 7461  ilter by span ta
-0001c030: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
-0001c040: 706c 6163 6568 6f6c 6465 723d 2253 656c  placeholder="Sel
-0001c050: 6563 7420 7370 6563 6966 6963 2073 7061  ect specific spa
-0001c060: 6e20 7461 6773 222c 0a20 2020 2020 2020  n tags",.       
-0001c070: 2020 2020 2076 616c 7565 3d5b 5d2c 0a20       value=[],. 
-0001c080: 2020 2020 2020 2020 2020 206f 7074 696f             optio
-0001c090: 6e73 3d5b 5d2c 0a20 2020 2020 2020 2029  ns=[],.        )
-0001c0a0: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
-0001c0b0: 6974 5f73 656c 6563 746f 7220 3d20 5365  it_selector = Se
-0001c0c0: 6c65 6374 2874 6974 6c65 3d22 556e 6974  lect(title="Unit
-0001c0d0: 2073 656c 6563 7469 6f6e 222c 206f 7074   selection", opt
-0001c0e0: 696f 6e73 3d5b 2273 6563 6f6e 6473 225d  ions=["seconds"]
-0001c0f0: 290a 2020 2020 2020 2020 7365 6c66 2e75  ).        self.u
-0001c100: 6e69 745f 7365 6c65 6374 6f72 2e76 616c  nit_selector.val
-0001c110: 7565 203d 2022 7365 636f 6e64 7322 0a20  ue = "seconds". 
-0001c120: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
-0001c130: 5f73 656c 6563 746f 722e 6f6e 5f63 6861  _selector.on_cha
-0001c140: 6e67 6528 2276 616c 7565 222c 2073 656c  nge("value", sel
-0001c150: 662e 5f68 616e 646c 655f 6368 616e 6765  f._handle_change
-0001c160: 5f75 6e69 7429 0a0a 2020 2020 2020 2020  _unit)..        
-0001c170: 7365 6c65 6374 6f72 735f 726f 7720 3d20  selectors_row = 
-0001c180: 726f 7728 0a20 2020 2020 2020 2020 2020  row(.           
-0001c190: 2063 6869 6c64 7265 6e3d 5b0a 2020 2020   children=[.    
-0001c1a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001c1b0: 2e73 7061 6e5f 7461 675f 7365 6c65 6374  .span_tag_select
-0001c1c0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-0001c1d0: 2020 2020 7365 6c66 2e66 756e 6374 696f      self.functio
-0001c1e0: 6e5f 7365 6c65 6374 6f72 2c0a 2020 2020  n_selector,.    
-0001c1f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001c200: 2e75 6e69 745f 7365 6c65 6374 6f72 2c0a  .unit_selector,.
-0001c210: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
-0001c220: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
-0001c230: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-0001c240: 7769 6474 6822 2c0a 2020 2020 2020 2020  width",.        
-0001c250: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-0001c260: 6f6f 7420 3d20 636f 6c75 6d6e 280a 2020  oot = column(.  
-0001c270: 2020 2020 2020 2020 2020 7365 6c65 6374            select
-0001c280: 6f72 735f 726f 772c 0a20 2020 2020 2020  ors_row,.       
-0001c290: 2020 2020 2073 697a 696e 675f 6d6f 6465       sizing_mode
-0001c2a0: 3d22 7363 616c 655f 7769 6474 6822 2c0a  ="scale_width",.
-0001c2b0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
-0001c2c0: 6566 205f 6861 6e64 6c65 5f63 6861 6e67  ef _handle_chang
-0001c2d0: 655f 756e 6974 2873 656c 662c 2061 7474  e_unit(self, att
-0001c2e0: 723a 2073 7472 2c20 6f6c 643a 2073 7472  r: str, old: str
-0001c2f0: 2c20 6e65 773a 2073 7472 2920 2d3e 204e  , new: str) -> N
-0001c300: 6f6e 653a 0a20 2020 2020 2020 2073 656c  one:.        sel
-0001c310: 662e 7375 6273 7461 6e74 6961 6c5f 6368  f.substantial_ch
-0001c320: 616e 6765 203d 2054 7275 650a 2020 2020  ange = True.    
-0001c330: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-0001c340: 7461 736b 5f65 7865 635f 6279 5f70 7265  task_exec_by_pre
-0001c350: 6669 785f 6368 6172 740a 2020 2020 2020  fix_chart.      
-0001c360: 2020 666d 7420 3d20 7365 6c66 2e5f 626f    fmt = self._bo
-0001c370: 6b65 685f 756e 6974 5f66 6f72 6d61 7428  keh_unit_format(
-0001c380: 290a 2020 2020 2020 2020 7365 6c66 2e74  ).        self.t
-0001c390: 6173 6b5f 6578 6563 5f62 795f 7072 6566  ask_exec_by_pref
-0001c3a0: 6978 5f63 6861 7274 2e78 6178 6973 5b30  ix_chart.xaxis[0
-0001c3b0: 5d2e 666f 726d 6174 7465 722e 666f 726d  ].formatter.form
-0001c3c0: 6174 203d 2066 6d74 0a0a 2020 2020 4077  at = fmt..    @w
-0001c3d0: 6974 686f 7574 5f70 726f 7065 7274 795f  ithout_property_
-0001c3e0: 7661 6c69 6461 7469 6f6e 0a20 2020 2040  validation.    @
-0001c3f0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
-0001c400: 6566 2075 7064 6174 6528 7365 6c66 293a  ef update(self):
-0001c410: 0a20 2020 2020 2020 2073 656c 662e 5f75  .        self._u
-0001c420: 7064 6174 655f 7365 6c65 6374 6f72 7328  pdate_selectors(
-0001c430: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-0001c440: 6275 696c 645f 6461 7461 5f73 6f75 7263  build_data_sourc
-0001c450: 6573 2829 0a0a 2020 2020 2020 2020 6e65  es()..        ne
-0001c460: 6564 735f 6669 6775 7265 735f 726f 7720  eds_figures_row 
-0001c470: 3d20 7365 6c66 2e74 6173 6b5f 6578 6563  = self.task_exec
-0001c480: 5f62 795f 6163 7469 7669 7479 5f63 6861  _by_activity_cha
-0001c490: 7274 2069 7320 4e6f 6e65 0a20 2020 2020  rt is None.     
-0001c4a0: 2020 2069 6620 6e65 6564 735f 6669 6775     if needs_figu
-0001c4b0: 7265 735f 726f 773a 0a20 2020 2020 2020  res_row:.       
-0001c4c0: 2020 2020 2073 656c 662e 7375 6273 7461       self.substa
-0001c4d0: 6e74 6961 6c5f 6368 616e 6765 203d 2054  ntial_change = T
-0001c4e0: 7275 650a 0a20 2020 2020 2020 2069 6620  rue..        if 
-0001c4f0: 6e65 6564 735f 6669 6775 7265 735f 726f  needs_figures_ro
-0001c500: 773a 0a20 2020 2020 2020 2020 2020 2023  w:.            #
-0001c510: 2046 6972 7374 2063 616c 6c20 746f 2075   First call to u
-0001c520: 7064 6174 6528 290a 2020 2020 2020 2020  pdate().        
-0001c530: 2020 2020 7365 6c66 2e74 6173 6b5f 6578      self.task_ex
-0001c540: 6563 5f62 795f 7072 6566 6978 5f63 6861  ec_by_prefix_cha
-0001c550: 7274 203d 2028 0a20 2020 2020 2020 2020  rt = (.         
-0001c560: 2020 2020 2020 2073 656c 662e 5f62 7569         self._bui
-0001c570: 6c64 5f74 6173 6b5f 6578 6563 7574 696f  ld_task_executio
-0001c580: 6e5f 6279 5f70 7265 6669 785f 6368 6172  n_by_prefix_char
-0001c590: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0001c5a0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-0001c5b0: 6c66 2e74 6173 6b5f 6578 6563 5f62 795f  lf.task_exec_by_
-0001c5c0: 6163 7469 7669 7479 5f63 6861 7274 203d  activity_chart =
-0001c5d0: 2073 656c 662e 5f62 7569 6c64 5f70 6965   self._build_pie
-0001c5e0: 5f63 6861 7274 280a 2020 2020 2020 2020  _chart(.        
-0001c5f0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
-0001c600: 656c 662e 7461 736b 5f65 7865 635f 6279  elf.task_exec_by
-0001c610: 5f61 6374 6976 6974 795f 7372 632c 0a20  _activity_src,. 
-0001c620: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0001c630: 6974 6c65 3d22 5461 736b 2065 7865 6375  itle="Task execu
-0001c640: 7469 6f6e 2c20 6279 2061 6374 6976 6974  tion, by activit
-0001c650: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
-0001c660: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-0001c670: 6c66 2e67 6574 5f64 6174 615f 6279 5f61  lf.get_data_by_a
-0001c680: 6374 6976 6974 795f 6368 6172 7420 3d20  ctivity_chart = 
-0001c690: 7365 6c66 2e5f 6275 696c 645f 7069 655f  self._build_pie_
-0001c6a0: 6368 6172 7428 0a20 2020 2020 2020 2020  chart(.         
-0001c6b0: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-0001c6c0: 6c66 2e67 6574 5f64 6174 615f 6279 5f61  lf.get_data_by_a
-0001c6d0: 6374 6976 6974 795f 7372 632c 0a20 2020  ctivity_src,.   
-0001c6e0: 2020 2020 2020 2020 2020 2020 2023 2067               # g
-0001c6f0: 6574 5f64 6174 6120 6973 2063 616c 6c65  et_data is calle
-0001c700: 6420 7669 6120 5250 4320 666f 7220 6461  d via RPC for da
-0001c710: 7461 2070 756c 6c3b 2074 6865 206d 6574  ta pull; the met
-0001c720: 7269 6373 2066 6f72 2069 7420 6172 650a  rics for it are.
-0001c730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c740: 2320 7265 636f 7264 6564 206f 6e20 7468  # recorded on th
-0001c750: 6520 776f 726b 6572 202a 646f 6e61 7469  e worker *donati
-0001c760: 6e67 2a20 7468 6520 6461 7461 0a20 2020  ng* the data.   
-0001c770: 2020 2020 2020 2020 2020 2020 2074 6974               tit
-0001c780: 6c65 3d22 5365 6e64 2064 6174 612c 2062  le="Send data, b
-0001c790: 7920 6163 7469 7669 7479 222c 0a20 2020  y activity",.   
-0001c7a0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0001c7b0: 2020 2020 7365 6c66 2e74 6173 6b5f 6578      self.task_ex
-0001c7c0: 6563 5f62 795f 7072 6566 6978 5f63 6861  ec_by_prefix_cha
-0001c7d0: 7274 2e78 5f72 616e 6765 2e65 6e64 203d  rt.x_range.end =
-0001c7e0: 2073 656c 662e 7461 736b 5f65 7865 635f   self.task_exec_
-0001c7f0: 6279 5f70 7265 6669 785f 786d 6178 202a  by_prefix_xmax *
-0001c800: 2031 2e31 0a0a 2020 2020 2020 2020 6966   1.1..        if
-0001c810: 2073 656c 662e 7375 6273 7461 6e74 6961   self.substantia
-0001c820: 6c5f 6368 616e 6765 3a0a 2020 2020 2020  l_change:.      
-0001c830: 2020 2020 2020 2320 5669 7369 626c 6520        # Visible 
-0001c840: 6163 7469 7669 7469 6573 2061 6e64 2f6f  activities and/o
-0001c850: 7220 6675 6e63 7469 6f6e 7320 6368 616e  r functions chan
-0001c860: 6765 640a 2020 2020 2020 2020 2020 2020  ged.            
-0001c870: 7365 6c66 2e73 7562 7374 616e 7469 616c  self.substantial
-0001c880: 5f63 6861 6e67 6520 3d20 4661 6c73 650a  _change = False.
-0001c890: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001c8a0: 2e5f 7570 6461 7465 5f74 6173 6b5f 6578  ._update_task_ex
-0001c8b0: 6563 7574 696f 6e5f 6279 5f70 7265 6669  ecution_by_prefi
-0001c8c0: 785f 6368 6172 7428 290a 2020 2020 2020  x_chart().      
-0001c8d0: 2020 2020 2020 6669 6775 7265 735f 726f        figures_ro
-0001c8e0: 7720 3d20 726f 7728 0a20 2020 2020 2020  w = row(.       
-0001c8f0: 2020 2020 2020 2020 2063 6869 6c64 7265           childre
-0001c900: 6e3d 5b0a 2020 2020 2020 2020 2020 2020  n=[.            
-0001c910: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
-0001c920: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
-0001c930: 5f63 6861 7274 2c0a 2020 2020 2020 2020  _chart,.        
-0001c940: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001c950: 2e74 6173 6b5f 6578 6563 5f62 795f 6163  .task_exec_by_ac
-0001c960: 7469 7669 7479 5f63 6861 7274 2c0a 2020  tivity_chart,.  
-0001c970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c980: 2020 7365 6c66 2e67 6574 5f64 6174 615f    self.get_data_
-0001c990: 6279 5f61 6374 6976 6974 795f 6368 6172  by_activity_char
-0001c9a0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
-0001c9b0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
-0001c9c0: 2020 2020 2020 7369 7a69 6e67 5f6d 6f64        sizing_mod
-0001c9d0: 653d 2273 7472 6574 6368 5f77 6964 7468  e="stretch_width
-0001c9e0: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
-0001c9f0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0001ca00: 206e 6565 6473 5f66 6967 7572 6573 5f72   needs_figures_r
-0001ca10: 6f77 3a0a 2020 2020 2020 2020 2020 2020  ow:.            
-0001ca20: 2020 2020 2320 4669 7273 7420 6974 6572      # First iter
-0001ca30: 6174 696f 6e2c 2069 6e69 7469 616c 2061  ation, initial a
-0001ca40: 7373 6967 6e6d 656e 7420 6f66 2066 6967  ssignment of fig
-0001ca50: 7572 6573 2072 6f77 0a20 2020 2020 2020  ures row.       
-0001ca60: 2020 2020 2020 2020 2073 656c 662e 726f           self.ro
-0001ca70: 6f74 2e63 6869 6c64 7265 6e2e 6170 7065  ot.children.appe
-0001ca80: 6e64 2866 6967 7572 6573 5f72 6f77 290a  nd(figures_row).
-0001ca90: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001caa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001cab0: 2020 2320 4f74 6865 7277 6973 6520 6e65    # Otherwise ne
-0001cac0: 6564 7320 666f 7263 6564 2072 6566 7265  eds forced refre
-0001cad0: 7368 2062 7920 7265 706c 6163 696e 6720  sh by replacing 
-0001cae0: 7468 6520 6669 6775 7265 7320 726f 770a  the figures row.
-0001caf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cb00: 7365 6c66 2e72 6f6f 742e 6368 696c 6472  self.root.childr
-0001cb10: 656e 5b2d 315d 203d 2066 6967 7572 6573  en[-1] = figures
-0001cb20: 5f72 6f77 0a0a 2020 2020 6465 6620 5f75  _row..    def _u
-0001cb30: 7064 6174 655f 7365 6c65 6374 6f72 7328  pdate_selectors(
-0001cb40: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
-0001cb50: 2020 2020 2020 2022 2222 5570 6461 7465         """Update
-0001cb60: 2063 686f 6963 6573 2061 7661 696c 6162   choices availab
-0001cb70: 6c65 2069 6e0a 0a20 2020 2020 2020 202d  le in..        -
-0001cb80: 2073 656c 662e 756e 6974 5f73 656c 6563   self.unit_selec
-0001cb90: 746f 720a 2020 2020 2020 2020 2d20 7365  tor.        - se
-0001cba0: 6c66 2e66 756e 6374 696f 6e5f 7365 6c65  lf.function_sele
-0001cbb0: 6374 6f72 0a20 2020 2020 2020 202d 2073  ctor.        - s
-0001cbc0: 656c 662e 7370 616e 5f74 6167 5f73 656c  elf.span_tag_sel
-0001cbd0: 6563 746f 720a 2020 2020 2020 2020 2222  ector.        ""
-0001cbe0: 220a 2020 2020 2020 2020 756e 6974 7320  ".        units 
-0001cbf0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-0001cc00: 6675 6e63 7469 6f6e 7320 3d20 7365 7428  functions = set(
-0001cc10: 290a 0a20 2020 2020 2020 2066 6f72 206b  )..        for k
-0001cc20: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
-0001cc30: 6572 2e63 756d 756c 6174 6976 655f 776f  er.cumulative_wo
-0001cc40: 726b 6572 5f6d 6574 7269 6373 3a0a 2020  rker_metrics:.  
-0001cc50: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0001cc60: 2069 7369 6e73 7461 6e63 6528 6b2c 2074   isinstance(k, t
-0001cc70: 7570 6c65 293a 0a20 2020 2020 2020 2020  uple):.         
-0001cc80: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0001cc90: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0001cca0: 6578 742c 202a 6f74 6865 722c 2061 6374  ext, *other, act
-0001ccb0: 6976 6974 792c 2075 6e69 7420 3d20 6b0a  ivity, unit = k.
-0001ccc0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0001ccd0: 6572 7420 6973 696e 7374 616e 6365 2875  ert isinstance(u
-0001cce0: 6e69 742c 2073 7472 290a 2020 2020 2020  nit, str).      
-0001ccf0: 2020 2020 2020 756e 6974 732e 6164 6428        units.add(
-0001cd00: 756e 6974 290a 0a20 2020 2020 2020 2020  unit)..         
-0001cd10: 2020 2069 6620 636f 6e74 6578 7420 3d3d     if context ==
-0001cd20: 2022 6578 6563 7574 6522 3a0a 2020 2020   "execute":.    
-0001cd30: 2020 2020 2020 2020 2020 2020 2866 756e              (fun
-0001cd40: 6374 696f 6e2c 2920 3d20 6f74 6865 720a  ction,) = other.
-0001cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001cd60: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0001cd70: 6528 6675 6e63 7469 6f6e 2c20 7374 7229  e(function, str)
-0001cd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001cd90: 2066 756e 6374 696f 6e73 2e61 6464 2866   functions.add(f
-0001cda0: 756e 6374 696f 6e29 0a0a 2020 2020 2020  unction)..      
-0001cdb0: 2020 756e 6974 732e 6469 6666 6572 656e    units.differen
-0001cdc0: 6365 5f75 7064 6174 6528 7365 6c66 2e75  ce_update(self.u
-0001cdd0: 6e69 745f 7365 6c65 6374 6f72 2e6f 7074  nit_selector.opt
-0001cde0: 696f 6e73 290a 2020 2020 2020 2020 6966  ions).        if
-0001cdf0: 2075 6e69 7473 3a0a 2020 2020 2020 2020   units:.        
-0001ce00: 2020 2020 7365 6c66 2e75 6e69 745f 7365      self.unit_se
-0001ce10: 6c65 6374 6f72 2e6f 7074 696f 6e73 2e65  lector.options.e
-0001ce20: 7874 656e 6428 756e 6974 7329 0a0a 2020  xtend(units)..  
-0001ce30: 2020 2020 2020 6966 2066 756e 6374 696f        if functio
-0001ce40: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
-0001ce50: 2320 4164 6465 6420 6f6e 2074 6865 2066  # Added on the f
-0001ce60: 6c79 2062 7920 5370 616e 2e63 756d 756c  ly by Span.cumul
-0001ce70: 6174 6976 655f 776f 726b 6572 5f6d 6574  ative_worker_met
-0001ce80: 7269 6373 0a20 2020 2020 2020 2020 2020  rics.           
-0001ce90: 2066 756e 6374 696f 6e73 2e61 6464 2822   functions.add("
-0001cea0: 4e2f 4122 290a 2020 2020 2020 2020 6675  N/A").        fu
-0001ceb0: 6e63 7469 6f6e 732e 6469 6666 6572 656e  nctions.differen
-0001cec0: 6365 5f75 7064 6174 6528 7365 6c66 2e66  ce_update(self.f
-0001ced0: 756e 6374 696f 6e5f 7365 6c65 6374 6f72  unction_selector
-0001cee0: 2e6f 7074 696f 6e73 290a 2020 2020 2020  .options).      
-0001cef0: 2020 6966 2066 756e 6374 696f 6e73 3a0a    if functions:.
-0001cf00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001cf10: 2e66 756e 6374 696f 6e5f 7365 6c65 6374  .function_select
-0001cf20: 6f72 2e6f 7074 696f 6e73 2e65 7874 656e  or.options.exten
-0001cf30: 6428 6675 6e63 7469 6f6e 7329 0a20 2020  d(functions).   
-0001cf40: 2020 2020 2020 2020 2073 656c 662e 6675           self.fu
-0001cf50: 6e63 7469 6f6e 5f73 656c 6563 746f 722e  nction_selector.
-0001cf60: 7469 746c 6520 3d20 280a 2020 2020 2020  title = (.      
-0001cf70: 2020 2020 2020 2020 2020 6622 4669 6c74            f"Filt
-0001cf80: 6572 2062 7920 6675 6e63 7469 6f6e 2028  er by function (
-0001cf90: 7b6c 656e 2873 656c 662e 6675 6e63 7469  {len(self.functi
-0001cfa0: 6f6e 5f73 656c 6563 746f 722e 6f70 7469  on_selector.opti
-0001cfb0: 6f6e 7329 7d29 3a22 0a20 2020 2020 2020  ons)}):".       
-0001cfc0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001cfd0: 7370 616e 735f 6578 743a 2053 7061 6e73  spans_ext: Spans
-0001cfe0: 5363 6865 6475 6c65 7245 7874 656e 7369  SchedulerExtensi
-0001cff0: 6f6e 207c 204e 6f6e 6520 3d20 7365 6c66  on | None = self
-0001d000: 2e73 6368 6564 756c 6572 2e65 7874 656e  .scheduler.exten
-0001d010: 7369 6f6e 732e 6765 7428 0a20 2020 2020  sions.get(.     
-0001d020: 2020 2020 2020 2022 7370 616e 7322 0a20         "spans". 
-0001d030: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001d040: 2069 6620 7370 616e 735f 6578 743a 0a20   if spans_ext:. 
-0001d050: 2020 2020 2020 2020 2020 2074 6167 7320             tags 
-0001d060: 3d20 7365 7428 7370 616e 735f 6578 742e  = set(spans_ext.
-0001d070: 7370 616e 735f 7365 6172 6368 5f62 795f  spans_search_by_
-0001d080: 7461 6729 0a20 2020 2020 2020 2020 2020  tag).           
-0001d090: 2074 6167 732e 6469 6666 6572 656e 6365   tags.difference
-0001d0a0: 5f75 7064 6174 6528 7365 6c66 2e73 7061  _update(self.spa
-0001d0b0: 6e5f 7461 675f 7365 6c65 6374 6f72 2e6f  n_tag_selector.o
-0001d0c0: 7074 696f 6e73 290a 2020 2020 2020 2020  ptions).        
-0001d0d0: 2020 2020 6966 2074 6167 733a 0a20 2020      if tags:.   
-0001d0e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001d0f0: 662e 7370 616e 5f74 6167 5f73 656c 6563  f.span_tag_selec
-0001d100: 746f 722e 6f70 7469 6f6e 732e 6578 7465  tor.options.exte
-0001d110: 6e64 2874 6167 7329 0a20 2020 2020 2020  nd(tags).       
-0001d120: 2020 2020 2020 2020 2073 656c 662e 7370           self.sp
-0001d130: 616e 5f74 6167 5f73 656c 6563 746f 722e  an_tag_selector.
-0001d140: 7469 746c 6520 3d20 280a 2020 2020 2020  title = (.      
-0001d150: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-0001d160: 4669 6c74 6572 2062 7920 7370 616e 2074  Filter by span t
-0001d170: 6167 2028 7b6c 656e 2873 656c 662e 7370  ag ({len(self.sp
-0001d180: 616e 5f74 6167 5f73 656c 6563 746f 722e  an_tag_selector.
-0001d190: 6f70 7469 6f6e 7329 7d29 3a22 0a20 2020  options)}):".   
-0001d1a0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-0001d1b0: 2020 2020 6465 6620 5f62 6f6b 6568 5f75      def _bokeh_u
-0001d1c0: 6e69 745f 666f 726d 6174 2873 656c 6629  nit_format(self)
-0001d1d0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-0001d1e0: 2075 6e69 7420 3d20 7365 6c66 2e75 6e69   unit = self.uni
-0001d1f0: 745f 7365 6c65 6374 6f72 2e76 616c 7565  t_selector.value
-0001d200: 0a20 2020 2020 2020 2069 6620 756e 6974  .        if unit
-0001d210: 203d 3d20 2273 6563 6f6e 6473 223a 0a20   == "seconds":. 
-0001d220: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001d230: 6e20 2230 303a 3030 3a30 3022 0a20 2020  n "00:00:00".   
-0001d240: 2020 2020 2065 6c69 6620 756e 6974 203d       elif unit =
-0001d250: 3d20 2262 7974 6573 223a 0a20 2020 2020  = "bytes":.     
-0001d260: 2020 2020 2020 2072 6574 7572 6e20 2230         return "0
-0001d270: 2e30 3062 220a 2020 2020 2020 2020 656c  .00b".        el
-0001d280: 6966 2075 6e69 7420 3d3d 2022 636f 756e  if unit == "coun
-0001d290: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
-0001d2a0: 7265 7475 726e 2022 3022 0a20 2020 2020  return "0".     
-0001d2b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0001d2c0: 2020 2020 2072 6574 7572 6e20 2230 2e30       return "0.0
-0001d2d0: 3030 220a 0a20 2020 2064 6566 205f 666f  00"..    def _fo
-0001d2e0: 726d 6174 2873 656c 662c 2076 616c 3a20  rmat(self, val: 
-0001d2f0: 666c 6f61 7429 202d 3e20 7374 723a 0a20  float) -> str:. 
-0001d300: 2020 2020 2020 2075 6e69 7420 3d20 7365         unit = se
-0001d310: 6c66 2e75 6e69 745f 7365 6c65 6374 6f72  lf.unit_selector
-0001d320: 2e76 616c 7565 0a20 2020 2020 2020 2069  .value.        i
-0001d330: 6620 756e 6974 203d 3d20 2273 6563 6f6e  f unit == "secon
-0001d340: 6473 223a 0a20 2020 2020 2020 2020 2020  ds":.           
-0001d350: 2072 6574 7572 6e20 666f 726d 6174 5f74   return format_t
-0001d360: 696d 6528 7661 6c29 0a20 2020 2020 2020  ime(val).       
-0001d370: 2065 6c69 6620 756e 6974 203d 3d20 2262   elif unit == "b
-0001d380: 7974 6573 223a 0a20 2020 2020 2020 2020  ytes":.         
-0001d390: 2020 2072 6574 7572 6e20 666f 726d 6174     return format
-0001d3a0: 5f62 7974 6573 2869 6e74 2876 616c 2929  _bytes(int(val))
-0001d3b0: 0a20 2020 2020 2020 2023 2063 6f75 6e74  .        # count
-0001d3c0: 206f 7220 6375 7374 6f6d 2075 7365 722d   or custom user-
-0001d3d0: 6465 6669 6e65 6420 6d65 7472 6963 0a20  defined metric. 
-0001d3e0: 2020 2020 2020 2065 6c69 6620 2869 7661         elif (iva
-0001d3f0: 6c20 3a3d 2069 6e74 2876 616c 2929 203d  l := int(val)) =
-0001d400: 3d20 7661 6c3a 0a20 2020 2020 2020 2020  = val:.         
-0001d410: 2020 2072 6574 7572 6e20 7374 7228 6976     return str(iv
-0001d420: 616c 290a 2020 2020 2020 2020 656c 7365  al).        else
-0001d430: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001d440: 7475 726e 2073 7472 2876 616c 290a 0a20  turn str(val).. 
-0001d450: 2020 2064 6566 205f 6765 745f 7061 6c65     def _get_pale
-0001d460: 7474 6528 7365 6c66 2920 2d3e 206c 6973  tte(self) -> lis
-0001d470: 745b 7374 725d 3a0a 2020 2020 2020 2020  t[str]:.        
-0001d480: 6e20 3d20 6c65 6e28 7365 6c66 2e76 6973  n = len(self.vis
-0001d490: 6962 6c65 5f61 6374 6976 6974 6965 7329  ible_activities)
-0001d4a0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-0001d4b0: 2020 2020 2020 2020 2020 6672 6f6d 2062            from b
-0001d4c0: 6f6b 6568 2e70 616c 6574 7465 7320 696d  okeh.palettes im
-0001d4d0: 706f 7274 2069 6e74 6572 705f 7061 6c65  port interp_pale
-0001d4e0: 7474 650a 0a20 2020 2020 2020 2020 2020  tte..           
-0001d4f0: 2072 6574 7572 6e20 6c69 7374 2869 6e74   return list(int
-0001d500: 6572 705f 7061 6c65 7474 6528 5669 7269  erp_palette(Viri
-0001d510: 6469 7331 312c 206e 2929 0a20 2020 2020  dis11, n)).     
-0001d520: 2020 2065 7863 6570 7420 496d 706f 7274     except Import
-0001d530: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0001d540: 2020 2023 2042 6f6b 6568 2032 2e34 0a20     # Bokeh 2.4. 
-0001d550: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001d560: 6e20 5b56 6972 6964 6973 3131 5b69 2025  n [Viridis11[i %
-0001d570: 206c 656e 2856 6972 6964 6973 3131 295d   len(Viridis11)]
-0001d580: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
-0001d590: 6e29 5d0a 0a20 2020 2064 6566 205f 6275  n)]..    def _bu
-0001d5a0: 696c 645f 6461 7461 5f73 6f75 7263 6573  ild_data_sources
-0001d5b0: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
-0001d5c0: 2020 2020 2020 2020 2222 2250 7265 2d70          """Pre-p
-0001d5d0: 726f 6365 7373 2061 6e64 2066 696c 7465  rocess and filte
-0001d5e0: 7220 6669 6e65 2070 6572 666f 726d 616e  r fine performan
-0001d5f0: 6365 206d 6574 7269 6373 3b20 6275 696c  ce metrics; buil
-0001d600: 6420 6461 7461 2074 6162 6c65 7320 696e  d data tables in
-0001d610: 0a20 2020 2020 2020 2042 6f6b 6568 2066  .        Bokeh f
-0001d620: 6f72 6d61 740a 0a20 2020 2020 2020 2055  ormat..        U
-0001d630: 7064 6174 6573 3a0a 0a20 2020 2020 2020  pdates:..       
-0001d640: 202d 2073 656c 662e 7375 6273 7461 6e74   - self.substant
-0001d650: 6961 6c5f 6368 616e 6765 0a20 2020 2020  ial_change.     
-0001d660: 2020 202d 2073 656c 662e 7669 7369 626c     - self.visibl
-0001d670: 655f 6163 7469 7669 7469 6573 0a20 2020  e_activities.   
-0001d680: 2020 2020 202d 2073 656c 662e 7669 7369       - self.visi
-0001d690: 626c 655f 6675 6e63 7469 6f6e 730a 2020  ble_functions.  
-0001d6a0: 2020 2020 2020 2d20 7365 6c66 2e74 6173        - self.tas
-0001d6b0: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
-0001d6c0: 5f73 7263 2e64 6174 610a 2020 2020 2020  _src.data.      
-0001d6d0: 2020 2d20 7365 6c66 2e74 6173 6b5f 6578    - self.task_ex
-0001d6e0: 6563 5f62 795f 6163 7469 7669 7479 5f73  ec_by_activity_s
-0001d6f0: 7263 2e64 6174 610a 2020 2020 2020 2020  rc.data.        
-0001d700: 2d20 7365 6c66 2e67 6574 5f64 6174 615f  - self.get_data_
-0001d710: 6279 5f61 6374 6976 6974 795f 7372 632e  by_activity_src.
-0001d720: 6461 7461 0a20 2020 2020 2020 2022 2222  data.        """
-0001d730: 0a20 2020 2020 2020 2076 6973 6962 6c65  .        visible
-0001d740: 5f66 756e 6374 696f 6e73 203d 2073 6574  _functions = set
-0001d750: 2829 0a20 2020 2020 2020 2076 6973 6962  ().        visib
-0001d760: 6c65 5f61 6374 6976 6974 6965 7320 3d20  le_activities = 
-0001d770: 7365 7428 290a 2020 2020 2020 2020 6578  set().        ex
-0001d780: 6563 7574 655f 6279 5f66 756e 633a 2064  ecute_by_func: d
-0001d790: 6566 6175 6c74 6469 6374 5b74 7570 6c65  efaultdict[tuple
-0001d7a0: 5b73 7472 2c20 7374 725d 2c20 666c 6f61  [str, str], floa
-0001d7b0: 745d 203d 2064 6566 6175 6c74 6469 6374  t] = defaultdict
-0001d7c0: 2866 6c6f 6174 290a 2020 2020 2020 2020  (float).        
-0001d7d0: 6578 6563 7574 653a 2064 6566 6175 6c74  execute: default
-0001d7e0: 6469 6374 5b73 7472 2c20 666c 6f61 745d  dict[str, float]
-0001d7f0: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
-0001d800: 6c6f 6174 290a 2020 2020 2020 2020 6765  loat).        ge
-0001d810: 745f 6461 7461 3a20 6465 6661 756c 7464  t_data: defaultd
-0001d820: 6963 745b 7374 722c 2066 6c6f 6174 5d20  ict[str, float] 
-0001d830: 3d20 6465 6661 756c 7464 6963 7428 666c  = defaultdict(fl
-0001d840: 6f61 7429 0a0a 2020 2020 2020 2020 6675  oat)..        fu
-0001d850: 6e63 7469 6f6e 5f73 656c 203d 2073 6574  nction_sel = set
-0001d860: 2873 656c 662e 6675 6e63 7469 6f6e 5f73  (self.function_s
-0001d870: 656c 6563 746f 722e 7661 6c75 6529 0a0a  elector.value)..
-0001d880: 2020 2020 2020 2020 7370 616e 735f 6578          spans_ex
-0001d890: 743a 2053 7061 6e73 5363 6865 6475 6c65  t: SpansSchedule
-0001d8a0: 7245 7874 656e 7369 6f6e 207c 204e 6f6e  rExtension | Non
-0001d8b0: 6520 3d20 7365 6c66 2e73 6368 6564 756c  e = self.schedul
-0001d8c0: 6572 2e65 7874 656e 7369 6f6e 732e 6765  er.extensions.ge
-0001d8d0: 7428 0a20 2020 2020 2020 2020 2020 2022  t(.            "
-0001d8e0: 7370 616e 7322 0a20 2020 2020 2020 2029  spans".        )
-0001d8f0: 0a20 2020 2020 2020 2069 6620 7370 616e  .        if span
-0001d900: 735f 6578 7420 616e 6420 7365 6c66 2e73  s_ext and self.s
-0001d910: 7061 6e5f 7461 675f 7365 6c65 6374 6f72  pan_tag_selector
-0001d920: 2e76 616c 7565 3a0a 2020 2020 2020 2020  .value:.        
-0001d930: 2020 2020 7370 616e 203d 2073 7061 6e73      span = spans
-0001d940: 5f65 7874 2e6d 6572 6765 5f62 795f 7461  _ext.merge_by_ta
-0001d950: 6773 282a 7365 6c66 2e73 7061 6e5f 7461  gs(*self.span_ta
-0001d960: 675f 7365 6c65 6374 6f72 2e76 616c 7565  g_selector.value
-0001d970: 290a 2020 2020 2020 2020 2020 2020 6d65  ).            me
-0001d980: 7472 6963 7320 3d20 7370 616e 2e63 756d  trics = span.cum
-0001d990: 756c 6174 6976 655f 776f 726b 6572 5f6d  ulative_worker_m
-0001d9a0: 6574 7269 6373 0a20 2020 2020 2020 2065  etrics.        e
-0001d9b0: 6c69 6620 7370 616e 735f 6578 7420 616e  lif spans_ext an
-0001d9c0: 6420 7370 616e 735f 6578 742e 7370 616e  d spans_ext.span
-0001d9d0: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
-0001d9e0: 2043 616c 6375 6c61 7465 2069 646c 6520   Calculate idle 
-0001d9f0: 7469 6d65 0a20 2020 2020 2020 2020 2020  time.           
-0001da00: 2073 7061 6e20 3d20 7370 616e 735f 6578   span = spans_ex
-0001da10: 742e 6d65 7267 655f 616c 6c28 290a 2020  t.merge_all().  
-0001da20: 2020 2020 2020 2020 2020 6d65 7472 6963            metric
-0001da30: 7320 3d20 7370 616e 2e63 756d 756c 6174  s = span.cumulat
-0001da40: 6976 655f 776f 726b 6572 5f6d 6574 7269  ive_worker_metri
-0001da50: 6373 0a20 2020 2020 2020 2065 6c73 653a  cs.        else:
-0001da60: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
-0001da70: 7061 6e73 2065 7874 656e 7369 6f6e 2069  pans extension i
-0001da80: 7320 6e6f 7420 6c6f 6164 6564 0a20 2020  s not loaded.   
-0001da90: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
-0001daa0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0001dab0: 2020 2020 206b 3a20 760a 2020 2020 2020       k: v.      
-0001dac0: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
-0001dad0: 2076 2069 6e20 7365 6c66 2e73 6368 6564   v in self.sched
-0001dae0: 756c 6572 2e63 756d 756c 6174 6976 655f  uler.cumulative_
-0001daf0: 776f 726b 6572 5f6d 6574 7269 6373 2e69  worker_metrics.i
-0001db00: 7465 6d73 2829 0a20 2020 2020 2020 2020  tems().         
-0001db10: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
-0001db20: 616e 6365 286b 2c20 7475 706c 6529 0a20  ance(k, tuple). 
-0001db30: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001db40: 6e64 206c 656e 286b 2920 3d3d 2034 2020  nd len(k) == 4  
-0001db50: 2320 536b 6970 2067 6574 2d64 6174 612c  # Skip get-data,
-0001db60: 2067 6174 6865 722d 6465 7073 2c20 616e   gather-deps, an
-0001db70: 6420 6d65 6d6f 7279 2d6d 6f6e 6974 6f72  d memory-monitor
-0001db80: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
-0001db90: 2020 2020 2020 2020 666f 7220 2863 6f6e          for (con
-0001dba0: 7465 7874 2c20 6675 6e63 7469 6f6e 2c20  text, function, 
-0001dbb0: 6163 7469 7669 7479 2c20 756e 6974 292c  activity, unit),
-0001dbc0: 2076 2069 6e20 6d65 7472 6963 732e 6974   v in metrics.it
-0001dbd0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-0001dbe0: 2020 2069 6620 636f 6e74 6578 7420 213d     if context !=
-0001dbf0: 2022 6578 6563 7574 6522 3a0a 2020 2020   "execute":.    
-0001dc00: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0001dc10: 696e 7565 2020 2320 544f 444f 2076 6973  inue  # TODO vis
-0001dc20: 7561 6c69 7a65 2027 7368 7566 666c 6527  ualize 'shuffle'
-0001dc30: 206d 6574 7269 6373 0a20 2020 2020 2020   metrics.       
-0001dc40: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-0001dc50: 7374 616e 6365 2866 756e 6374 696f 6e2c  stance(function,
-0001dc60: 2073 7472 290a 2020 2020 2020 2020 2020   str).          
-0001dc70: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-0001dc80: 6e63 6528 756e 6974 2c20 7374 7229 0a20  nce(unit, str). 
-0001dc90: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0001dca0: 7420 7365 6c66 2e75 6e69 745f 7365 6c65  t self.unit_sele
-0001dcb0: 6374 6f72 2e76 616c 7565 0a20 2020 2020  ctor.value.     
-0001dcc0: 2020 2020 2020 2069 6620 756e 6974 2021         if unit !
-0001dcd0: 3d20 7365 6c66 2e75 6e69 745f 7365 6c65  = self.unit_sele
-0001dce0: 6374 6f72 2e76 616c 7565 3a0a 2020 2020  ctor.value:.    
-0001dcf0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0001dd00: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-0001dd10: 2069 6620 6675 6e63 7469 6f6e 5f73 656c   if function_sel
-0001dd20: 2061 6e64 2066 756e 6374 696f 6e20 6e6f   and function no
-0001dd30: 7420 696e 2066 756e 6374 696f 6e5f 7365  t in function_se
-0001dd40: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
-0001dd50: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-0001dd60: 2020 2020 2020 2020 2023 2043 7573 746f           # Custo
-0001dd70: 6d20 6d65 7472 6963 7320 776f 6e27 7420  m metrics won't 
-0001dd80: 6e65 6365 7373 6172 696c 7920 636f 6e74  necessarily cont
-0001dd90: 6169 6e20 6120 7374 7269 6e67 2061 7320  ain a string as 
-0001dda0: 7468 6520 6c61 6265 6c0a 2020 2020 2020  the label.      
-0001ddb0: 2020 2020 2020 6163 7469 7669 7479 203d        activity =
-0001ddc0: 2073 7472 2861 6374 6976 6974 7929 0a0a   str(activity)..
-0001ddd0: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
-0001dde0: 444f 2057 6520 636f 756c 6420 696d 706c  DO We could impl
-0001ddf0: 656d 656e 7420 736f 6d65 2066 616e 6379  ement some fancy
-0001de00: 206c 6f67 6963 2069 6e20 7370 616e 732e   logic in spans.
-0001de10: 7079 2074 6f20 6368 616e 6765 2074 6865  py to change the
-0001de20: 206c 6162 656c 0a20 2020 2020 2020 2020   label.         
-0001de30: 2020 2023 2020 2020 2020 6966 206e 6f20     #      if no 
-0001de40: 6f74 6865 7220 7370 616e 7320 6172 6520  other spans are 
-0001de50: 7275 6e6e 696e 6720 6174 2074 6865 2073  running at the s
-0001de60: 616d 6520 7469 6d65 2e0a 2020 2020 2020  ame time..      
-0001de70: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-0001de80: 662e 7370 616e 5f74 6167 5f73 656c 6563  f.span_tag_selec
-0001de90: 746f 722e 7661 6c75 6520 616e 6420 6163  tor.value and ac
-0001dea0: 7469 7669 7479 203d 3d20 2269 646c 6520  tivity == "idle 
-0001deb0: 6f72 206f 7468 6572 2073 7061 6e73 223a  or other spans":
-0001dec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ded0: 2061 6374 6976 6974 7920 3d20 2269 646c   activity = "idl
-0001dee0: 6522 0a0a 2020 2020 2020 2020 2020 2020  e"..            
-0001def0: 6578 6563 7574 655f 6279 5f66 756e 635b  execute_by_func[
-0001df00: 6675 6e63 7469 6f6e 2c20 6163 7469 7669  function, activi
-0001df10: 7479 5d20 2b3d 2076 0a20 2020 2020 2020  ty] += v.       
-0001df20: 2020 2020 2065 7865 6375 7465 5b61 6374       execute[act
-0001df30: 6976 6974 795d 202b 3d20 760a 2020 2020  ivity] += v.    
-0001df40: 2020 2020 2020 2020 7669 7369 626c 655f          visible_
-0001df50: 6675 6e63 7469 6f6e 732e 6164 6428 6675  functions.add(fu
-0001df60: 6e63 7469 6f6e 290a 2020 2020 2020 2020  nction).        
-0001df70: 2020 2020 7669 7369 626c 655f 6163 7469      visible_acti
-0001df80: 7669 7469 6573 2e61 6464 2861 6374 6976  vities.add(activ
-0001df90: 6974 7929 0a0a 2020 2020 2020 2020 6966  ity)..        if
-0001dfa0: 206e 6f74 2073 656c 662e 6675 6e63 7469   not self.functi
-0001dfb0: 6f6e 5f73 656c 6563 746f 722e 7661 6c75  on_selector.valu
-0001dfc0: 6520 616e 6420 6e6f 7420 7365 6c66 2e73  e and not self.s
-0001dfd0: 7061 6e5f 7461 675f 7365 6c65 6374 6f72  pan_tag_selector
-0001dfe0: 2e76 616c 7565 3a0a 2020 2020 2020 2020  .value:.        
-0001dff0: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
-0001e000: 7365 6c66 2e73 6368 6564 756c 6572 2e63  self.scheduler.c
-0001e010: 756d 756c 6174 6976 655f 776f 726b 6572  umulative_worker
-0001e020: 5f6d 6574 7269 6373 2e69 7465 6d73 2829  _metrics.items()
-0001e030: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e040: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
-0001e050: 6b2c 2074 7570 6c65 2920 616e 6420 6b5b  k, tuple) and k[
-0001e060: 305d 203d 3d20 2267 6574 2d64 6174 6122  0] == "get-data"
-0001e070: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e080: 2020 2020 2020 5f2c 2061 6374 6976 6974        _, activit
-0001e090: 792c 2075 6e69 7420 3d20 6b0a 2020 2020  y, unit = k.    
-0001e0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e0b0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0001e0c0: 6528 6163 7469 7669 7479 2c20 7374 7229  e(activity, str)
-0001e0d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e0e0: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
-0001e0f0: 7374 616e 6365 2875 6e69 742c 2073 7472  stance(unit, str
-0001e100: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001e110: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
-0001e120: 662e 756e 6974 5f73 656c 6563 746f 722e  f.unit_selector.
-0001e130: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
-0001e140: 2020 2020 2020 2020 2020 6966 2075 6e69            if uni
-0001e150: 7420 3d3d 2073 656c 662e 756e 6974 5f73  t == self.unit_s
-0001e160: 656c 6563 746f 722e 7661 6c75 653a 0a20  elector.value:. 
-0001e170: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e180: 2020 2020 2020 2076 6973 6962 6c65 5f61         visible_a
-0001e190: 6374 6976 6974 6965 732e 6164 6428 6163  ctivities.add(ac
-0001e1a0: 7469 7669 7479 290a 2020 2020 2020 2020  tivity).        
-0001e1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e1c0: 6765 745f 6461 7461 5b61 6374 6976 6974  get_data[activit
-0001e1d0: 795d 202b 3d20 760a 0a20 2020 2020 2020  y] += v..       
-0001e1e0: 2020 2020 2023 2049 676e 6f72 6520 6d65       # Ignore me
-0001e1f0: 6d6f 7279 2d6d 6f6e 6974 6f72 2061 6e64  mory-monitor and
-0001e200: 2067 6174 6865 722d 6465 7020 6d65 7472   gather-dep metr
-0001e210: 6963 730a 0a20 2020 2020 2020 2069 6620  ics..        if 
-0001e220: 7669 7369 626c 655f 6675 6e63 7469 6f6e  visible_function
-0001e230: 7320 213d 2073 6574 2873 656c 662e 7669  s != set(self.vi
-0001e240: 7369 626c 655f 6675 6e63 7469 6f6e 7329  sible_functions)
-0001e250: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001e260: 6c66 2e73 7562 7374 616e 7469 616c 5f63  lf.substantial_c
-0001e270: 6861 6e67 6520 3d20 5472 7565 0a20 2020  hange = True.   
-0001e280: 2020 2020 2020 2020 2073 656c 662e 7669           self.vi
-0001e290: 7369 626c 655f 6675 6e63 7469 6f6e 7320  sible_functions 
-0001e2a0: 3d20 736f 7274 6564 2876 6973 6962 6c65  = sorted(visible
-0001e2b0: 5f66 756e 6374 696f 6e73 290a 0a20 2020  _functions)..   
-0001e2c0: 2020 2020 2069 6620 7669 7369 626c 655f       if visible_
-0001e2d0: 6163 7469 7669 7469 6573 2021 3d20 7365  activities != se
-0001e2e0: 7428 7365 6c66 2e76 6973 6962 6c65 5f61  t(self.visible_a
-0001e2f0: 6374 6976 6974 6965 7329 3a0a 2020 2020  ctivities):.    
-0001e300: 2020 2020 2020 2020 7365 6c66 2e76 6973          self.vis
-0001e310: 6962 6c65 5f61 6374 6976 6974 6965 7320  ible_activities 
-0001e320: 3d20 736f 7274 6564 2876 6973 6962 6c65  = sorted(visible
-0001e330: 5f61 6374 6976 6974 6965 7329 0a0a 2020  _activities)..  
-0001e340: 2020 2020 2020 280a 2020 2020 2020 2020        (.        
-0001e350: 2020 2020 7365 6c66 2e74 6173 6b5f 6578      self.task_ex
-0001e360: 6563 5f62 795f 7072 6566 6978 5f73 7263  ec_by_prefix_src
-0001e370: 2e64 6174 612c 0a20 2020 2020 2020 2020  .data,.         
-0001e380: 2020 2073 656c 662e 7461 736b 5f65 7865     self.task_exe
-0001e390: 635f 6279 5f70 7265 6669 785f 786d 6178  c_by_prefix_xmax
-0001e3a0: 2c0a 2020 2020 2020 2020 2920 3d20 7365  ,.        ) = se
-0001e3b0: 6c66 2e5f 6275 696c 645f 7461 736b 5f65  lf._build_task_e
-0001e3c0: 7865 6375 7469 6f6e 5f62 795f 7072 6566  xecution_by_pref
-0001e3d0: 6978 5f64 6174 6128 6578 6563 7574 655f  ix_data(execute_
-0001e3e0: 6279 5f66 756e 6329 0a20 2020 2020 2020  by_func).       
-0001e3f0: 2073 656c 662e 7461 736b 5f65 7865 635f   self.task_exec_
-0001e400: 6279 5f61 6374 6976 6974 795f 7372 632e  by_activity_src.
-0001e410: 6461 7461 203d 2073 656c 662e 5f62 7569  data = self._bui
-0001e420: 6c64 5f70 6965 5f64 6174 6128 6578 6563  ld_pie_data(exec
-0001e430: 7574 6529 0a20 2020 2020 2020 2073 656c  ute).        sel
-0001e440: 662e 6765 745f 6461 7461 5f62 795f 6163  f.get_data_by_ac
-0001e450: 7469 7669 7479 5f73 7263 2e64 6174 6120  tivity_src.data 
-0001e460: 3d20 7365 6c66 2e5f 6275 696c 645f 7069  = self._build_pi
-0001e470: 655f 6461 7461 2867 6574 5f64 6174 6129  e_data(get_data)
-0001e480: 0a0a 2020 2020 6465 6620 5f62 7569 6c64  ..    def _build
-0001e490: 5f70 6965 5f64 6174 6128 7365 6c66 2c20  _pie_data(self, 
-0001e4a0: 6461 7461 3a20 6465 6661 756c 7464 6963  data: defaultdic
-0001e4b0: 745b 7374 722c 2066 6c6f 6174 5d29 202d  t[str, float]) -
-0001e4c0: 3e20 6469 6374 5b73 7472 2c20 6c69 7374  > dict[str, list
-0001e4d0: 5d3a 0a20 2020 2020 2020 2022 2222 4275  ]:.        """Bu
-0001e4e0: 696c 6420 7468 6520 6461 7461 2073 6f75  ild the data sou
-0001e4f0: 7263 6520 666f 7220 6120 7069 6520 6368  rce for a pie ch
-0001e500: 6172 7420 6279 2061 6374 6976 6974 790a  art by activity.
-0001e510: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
-0001e520: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
-0001e530: 2d2d 0a20 2020 2020 2020 205f 6275 696c  --.        _buil
-0001e540: 645f 7069 655f 6368 6172 740a 2020 2020  d_pie_chart.    
-0001e550: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001e560: 6163 7469 7669 7469 6573 203d 2073 656c  activities = sel
-0001e570: 662e 7669 7369 626c 655f 6163 7469 7669  f.visible_activi
-0001e580: 7469 6573 0a20 2020 2020 2020 2023 2047  ties.        # G
-0001e590: 656e 6572 6174 6520 7061 6c65 7474 6520  enerate palette 
-0001e5a0: 6261 7365 6420 6f6e 2061 6c6c 2076 6973  based on all vis
-0001e5b0: 6962 6c65 2061 6374 6976 6974 6965 7320  ible activities 
-0001e5c0: 746f 206d 616b 6520 7375 7265 2074 6861  to make sure tha
-0001e5d0: 740a 2020 2020 2020 2020 2320 636f 6c6f  t.        # colo
-0001e5e0: 7273 206d 6174 6368 2062 6574 7765 656e  rs match between
-0001e5f0: 2074 6865 2070 6c6f 7473 0a20 2020 2020   the plots.     
-0001e600: 2020 2070 616c 6574 7465 203d 2073 656c     palette = sel
-0001e610: 662e 5f67 6574 5f70 616c 6574 7465 2829  f._get_palette()
-0001e620: 0a20 2020 2020 2020 2076 616c 7565 7320  .        values 
-0001e630: 3d20 5b64 6174 615b 6163 7469 7669 7479  = [data[activity
-0001e640: 5d20 666f 7220 6163 7469 7669 7479 2069  ] for activity i
-0001e650: 6e20 6163 7469 7669 7469 6573 5d0a 0a20  n activities].. 
-0001e660: 2020 2020 2020 2023 2053 6f72 7420 6279         # Sort by
-0001e670: 2076 616c 7565 7320 6672 6f6d 206c 6172   values from lar
-0001e680: 6765 7374 2074 6f20 736d 616c 6c65 7374  gest to smallest
-0001e690: 0a20 2020 2020 2020 2023 2048 6964 6520  .        # Hide 
-0001e6a0: 6163 7469 7669 7469 6573 2074 6861 7420  activities that 
-0001e6b0: 6172 6520 6d69 7373 696e 6720 696e 2074  are missing in t
-0001e6c0: 6865 2063 7572 7265 6e74 2070 6c6f 7420  he current plot 
-0001e6d0: 6672 6f6d 2074 6865 206c 6567 656e 640a  from the legend.
-0001e6e0: 2020 2020 2020 2020 6964 7820 3d20 5b69          idx = [i
-0001e6f0: 2066 6f72 2069 2c20 7620 696e 2073 6f72   for i, v in sor
-0001e700: 7465 6428 656e 756d 6572 6174 6528 7661  ted(enumerate(va
-0001e710: 6c75 6573 292c 206b 6579 3d6c 616d 6264  lues), key=lambd
-0001e720: 6120 656c 3a20 2d65 6c5b 315d 2920 6966  a el: -el[1]) if
-0001e730: 2076 5d0a 2020 2020 2020 2020 6163 7469   v].        acti
-0001e740: 7669 7469 6573 203d 205b 6163 7469 7669  vities = [activi
-0001e750: 7469 6573 5b69 5d20 666f 7220 6920 696e  ties[i] for i in
-0001e760: 2069 6478 5d0a 2020 2020 2020 2020 7061   idx].        pa
-0001e770: 6c65 7474 6520 3d20 5b70 616c 6574 7465  lette = [palette
-0001e780: 5b69 5d20 666f 7220 6920 696e 2069 6478  [i] for i in idx
-0001e790: 5d0a 2020 2020 2020 2020 7661 6c75 6573  ].        values
-0001e7a0: 203d 205b 7661 6c75 6573 5b69 5d20 666f   = [values[i] fo
-0001e7b0: 7220 6920 696e 2069 6478 5d0a 0a20 2020  r i in idx]..   
-0001e7c0: 2020 2020 2074 6f74 616c 5f76 616c 7565       total_value
-0001e7d0: 203d 2073 756d 2876 616c 7565 7329 0a20   = sum(values). 
-0001e7e0: 2020 2020 2020 2074 6f74 616c 5f74 6578         total_tex
-0001e7f0: 7420 3d20 7365 6c66 2e5f 666f 726d 6174  t = self._format
-0001e800: 2874 6f74 616c 5f76 616c 7565 290a 2020  (total_value).  
-0001e810: 2020 2020 2020 7065 7263 656e 745f 6b20        percent_k 
-0001e820: 3d20 3130 302e 3020 2f20 746f 7461 6c5f  = 100.0 / total_
-0001e830: 7661 6c75 6520 6966 2074 6f74 616c 5f76  value if total_v
-0001e840: 616c 7565 2065 6c73 6520 302e 300a 2020  alue else 0.0.  
-0001e850: 2020 2020 2020 616e 676c 655f 6b20 3d20        angle_k = 
-0001e860: 322e 3020 2a20 6d61 7468 2e70 6920 2f20  2.0 * math.pi / 
-0001e870: 746f 7461 6c5f 7661 6c75 6520 6966 2074  total_value if t
-0001e880: 6f74 616c 5f76 616c 7565 2065 6c73 6520  otal_value else 
-0001e890: 302e 300a 2020 2020 2020 2020 7265 7475  0.0.        retu
-0001e8a0: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
-0001e8b0: 2022 6163 7469 7669 7479 223a 2061 6374   "activity": act
-0001e8c0: 6976 6974 6965 732c 0a20 2020 2020 2020  ivities,.       
-0001e8d0: 2020 2020 2022 7661 6c75 6522 3a20 7661       "value": va
-0001e8e0: 6c75 6573 2c0a 2020 2020 2020 2020 2020  lues,.          
-0001e8f0: 2020 2274 6578 7422 3a20 5b73 656c 662e    "text": [self.
-0001e900: 5f66 6f72 6d61 7428 7629 202b 2066 2220  _format(v) + f" 
-0001e910: 287b 7620 2a20 7065 7263 656e 745f 6b3a  ({v * percent_k:
-0001e920: 2e30 667d 2529 2220 666f 7220 7620 696e  .0f}%)" for v in
-0001e930: 2076 616c 7565 735d 2c0a 2020 2020 2020   values],.      
-0001e940: 2020 2020 2020 2261 6e67 6c65 223a 205b        "angle": [
-0001e950: 7620 2a20 616e 676c 655f 6b20 666f 7220  v * angle_k for 
-0001e960: 7620 696e 2076 616c 7565 735d 2c0a 2020  v in values],.  
-0001e970: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
-0001e980: 223a 2070 616c 6574 7465 2c0a 2020 2020  ": palette,.    
-0001e990: 2020 2020 2020 2020 2274 6f74 616c 5f74          "total_t
-0001e9a0: 6578 7422 3a20 5b74 6f74 616c 5f74 6578  ext": [total_tex
-0001e9b0: 745d 202a 206c 656e 2876 616c 7565 7329  t] * len(values)
-0001e9c0: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
-0001e9d0: 2064 6566 205f 6275 696c 645f 7069 655f   def _build_pie_
-0001e9e0: 6368 6172 7428 7365 6c66 2c20 736f 7572  chart(self, sour
-0001e9f0: 6365 3a20 436f 6c75 6d6e 4461 7461 536f  ce: ColumnDataSo
-0001ea00: 7572 6365 2c20 7469 746c 653a 2073 7472  urce, title: str
-0001ea10: 2920 2d3e 2066 6967 7572 653a 0a20 2020  ) -> figure:.   
-0001ea20: 2020 2020 2022 2222 4372 6561 7465 2070       """Create p
-0001ea30: 6965 2063 6861 7274 2062 7920 6163 7469  ie chart by acti
-0001ea40: 7669 7479 0a0a 2020 2020 2020 2020 5365  vity..        Se
-0001ea50: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
-0001ea60: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0001ea70: 5f62 7569 6c64 5f70 6965 5f64 6174 610a  _build_pie_data.
-0001ea80: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0001ea90: 2020 2020 7069 6563 6861 7274 203d 2066      piechart = f
-0001eaa0: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
-0001eab0: 2020 2068 6569 6768 743d 3530 302c 0a20     height=500,. 
-0001eac0: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
-0001ead0: 675f 6d6f 6465 3d22 7363 616c 655f 626f  g_mode="scale_bo
-0001eae0: 7468 222c 0a20 2020 2020 2020 2020 2020  th",.           
-0001eaf0: 2074 6974 6c65 3d74 6974 6c65 2c0a 2020   title=title,.  
-0001eb00: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
-0001eb10: 2268 6f76 6572 222c 0a20 2020 2020 2020  "hover",.       
-0001eb20: 2020 2020 2074 6f6f 6c74 6970 733d 2240       tooltips="@
-0001eb30: 7b61 6374 6976 6974 797d 3a20 4074 6578  {activity}: @tex
-0001eb40: 743c 6272 3e74 6f74 616c 3a20 407b 746f  t<br>total: @{to
-0001eb50: 7461 6c5f 7465 7874 7d22 2c0a 2020 2020  tal_text}",.    
-0001eb60: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
-0001eb70: 282d 302e 352c 2031 2e30 292c 0a20 2020  (-0.5, 1.0),.   
-0001eb80: 2020 2020 2029 0a20 2020 2020 2020 2070       ).        p
-0001eb90: 6965 6368 6172 742e 6178 6973 2e61 7869  iechart.axis.axi
-0001eba0: 735f 6c61 6265 6c20 3d20 4e6f 6e65 0a20  s_label = None. 
-0001ebb0: 2020 2020 2020 2070 6965 6368 6172 742e         piechart.
-0001ebc0: 6178 6973 2e76 6973 6962 6c65 203d 2046  axis.visible = F
-0001ebd0: 616c 7365 0a20 2020 2020 2020 2070 6965  alse.        pie
-0001ebe0: 6368 6172 742e 6772 6964 2e67 7269 645f  chart.grid.grid_
-0001ebf0: 6c69 6e65 5f63 6f6c 6f72 203d 204e 6f6e  line_color = Non
-0001ec00: 650a 0a20 2020 2020 2020 2070 6965 6368  e..        piech
-0001ec10: 6172 742e 7765 6467 6528 0a20 2020 2020  art.wedge(.     
-0001ec20: 2020 2020 2020 2078 3d30 2c0a 2020 2020         x=0,.    
-0001ec30: 2020 2020 2020 2020 793d 312c 0a20 2020          y=1,.   
-0001ec40: 2020 2020 2020 2020 2072 6164 6975 733d           radius=
-0001ec50: 302e 342c 0a20 2020 2020 2020 2020 2020  0.4,.           
-0001ec60: 2073 7461 7274 5f61 6e67 6c65 3d63 756d   start_angle=cum
-0001ec70: 7375 6d28 2261 6e67 6c65 222c 2069 6e63  sum("angle", inc
-0001ec80: 6c75 6465 5f7a 6572 6f3d 5472 7565 292c  lude_zero=True),
-0001ec90: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
-0001eca0: 5f61 6e67 6c65 3d63 756d 7375 6d28 2261  _angle=cumsum("a
-0001ecb0: 6e67 6c65 2229 2c0a 2020 2020 2020 2020  ngle"),.        
-0001ecc0: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
-0001ecd0: 7768 6974 6522 2c0a 2020 2020 2020 2020  white",.        
-0001ece0: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
-0001ecf0: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
-0001ed00: 2020 2020 6c65 6765 6e64 5f66 6965 6c64      legend_field
-0001ed10: 3d22 6163 7469 7669 7479 222c 0a20 2020  ="activity",.   
-0001ed20: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-0001ed30: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-0001ed40: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0001ed50: 2070 6965 6368 6172 740a 0a20 2020 2064   piechart..    d
-0001ed60: 6566 205f 6275 696c 645f 7461 736b 5f65  ef _build_task_e
-0001ed70: 7865 6375 7469 6f6e 5f62 795f 7072 6566  xecution_by_pref
-0001ed80: 6978 5f64 6174 6128 0a20 2020 2020 2020  ix_data(.       
-0001ed90: 2073 656c 662c 2064 6174 613a 2064 6566   self, data: def
-0001eda0: 6175 6c74 6469 6374 5b74 7570 6c65 5b73  aultdict[tuple[s
-0001edb0: 7472 2c20 7374 725d 2c20 666c 6f61 745d  tr, str], float]
-0001edc0: 0a20 2020 2029 202d 3e20 7475 706c 655b  .    ) -> tuple[
-0001edd0: 6469 6374 5b73 7472 2c20 6c69 7374 5d2c  dict[str, list],
-0001ede0: 2066 6c6f 6174 5d3a 0a20 2020 2020 2020   float]:.       
-0001edf0: 2022 2222 4275 696c 6420 7468 6520 6461   """Build the da
-0001ee00: 7461 2073 6f75 7263 6520 666f 7220 7468  ta source for th
-0001ee10: 6520 6578 6563 7574 6520 6279 2066 756e  e execute by fun
-0001ee20: 6374 696f 6e20 7374 6163 6b65 6420 6368  ction stacked ch
-0001ee30: 6172 740a 0a20 2020 2020 2020 2053 6565  art..        See
-0001ee40: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
-0001ee50: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 205f  ------.        _
-0001ee60: 6275 696c 645f 7461 736b 5f65 7865 6375  build_task_execu
-0001ee70: 7469 6f6e 5f62 795f 7072 6566 6978 5f63  tion_by_prefix_c
-0001ee80: 6861 7274 0a20 2020 2020 2020 205f 7570  hart.        _up
-0001ee90: 6461 7465 5f74 6173 6b5f 6578 6563 7574  date_task_execut
-0001eea0: 696f 6e5f 6279 5f70 7265 6669 785f 6368  ion_by_prefix_ch
-0001eeb0: 6172 740a 2020 2020 2020 2020 2222 220a  art.        """.
-0001eec0: 2020 2020 2020 2020 6675 6e63 5f74 6f74          func_tot
-0001eed0: 616c 7320 3d20 5b0a 2020 2020 2020 2020  als = [.        
-0001eee0: 2020 2020 7375 6d28 6461 7461 5b66 756e      sum(data[fun
-0001eef0: 6374 696f 6e2c 2061 6374 6976 6974 795d  ction, activity]
-0001ef00: 2066 6f72 2061 6374 6976 6974 7920 696e   for activity in
-0001ef10: 2073 656c 662e 7669 7369 626c 655f 6163   self.visible_ac
-0001ef20: 7469 7669 7469 6573 290a 2020 2020 2020  tivities).      
-0001ef30: 2020 2020 2020 666f 7220 6675 6e63 7469        for functi
-0001ef40: 6f6e 2069 6e20 7365 6c66 2e76 6973 6962  on in self.visib
-0001ef50: 6c65 5f66 756e 6374 696f 6e73 0a20 2020  le_functions.   
-0001ef60: 2020 2020 205d 0a20 2020 2020 2020 2070       ].        p
-0001ef70: 6572 635f 6b20 3d20 5b31 3030 2e30 202f  erc_k = [100.0 /
-0001ef80: 2076 2069 6620 7620 656c 7365 2030 2e30   v if v else 0.0
-0001ef90: 2066 6f72 2076 2069 6e20 6675 6e63 5f74   for v in func_t
-0001efa0: 6f74 616c 735d 0a20 2020 2020 2020 206f  otals].        o
-0001efb0: 7574 3a20 6469 6374 5b73 7472 2c20 6c69  ut: dict[str, li
-0001efc0: 7374 5d20 3d20 7b0a 2020 2020 2020 2020  st] = {.        
-0001efd0: 2020 2020 225f 5f66 756e 6374 696f 6e73      "__functions
-0001efe0: 223a 2073 656c 662e 7669 7369 626c 655f  ": self.visible_
-0001eff0: 6675 6e63 7469 6f6e 732c 0a20 2020 2020  functions,.     
-0001f000: 2020 2020 2020 2022 5f5f 5f5f 746f 7461         "____tota
-0001f010: 6c5f 7465 7874 223a 205b 7365 6c66 2e5f  l_text": [self._
-0001f020: 666f 726d 6174 2876 2920 666f 7220 7620  format(v) for v 
-0001f030: 696e 2066 756e 635f 746f 7461 6c73 5d2c  in func_totals],
-0001f040: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-0001f050: 2020 2020 7363 5f76 6973 6962 6c65 5f61      sc_visible_a
-0001f060: 6374 6976 6974 6965 7320 3d20 5b5d 0a20  ctivities = []. 
-0001f070: 2020 2020 2020 2066 6f72 2061 6374 6976         for activ
-0001f080: 6974 7920 696e 2073 656c 662e 7669 7369  ity in self.visi
-0001f090: 626c 655f 6163 7469 7669 7469 6573 3a0a  ble_activities:.
-0001f0a0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
-0001f0b0: 6573 203d 205b 6461 7461 5b66 756e 6374  es = [data[funct
-0001f0c0: 696f 6e2c 2061 6374 6976 6974 795d 2066  ion, activity] f
-0001f0d0: 6f72 2066 756e 6374 696f 6e20 696e 2073  or function in s
-0001f0e0: 656c 662e 7669 7369 626c 655f 6675 6e63  elf.visible_func
-0001f0f0: 7469 6f6e 735d 0a20 2020 2020 2020 2020  tions].         
-0001f100: 2020 2069 6620 6e6f 7420 616e 7928 7661     if not any(va
-0001f110: 6c75 6573 293a 0a20 2020 2020 2020 2020  lues):.         
-0001f120: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0001f130: 2020 2020 2020 2020 2020 2020 7363 5f76              sc_v
-0001f140: 6973 6962 6c65 5f61 6374 6976 6974 6965  isible_activitie
-0001f150: 732e 6170 7065 6e64 2861 6374 6976 6974  s.append(activit
-0001f160: 7929 0a20 2020 2020 2020 2020 2020 206f  y).            o
-0001f170: 7574 5b61 6374 6976 6974 795d 203d 2076  ut[activity] = v
-0001f180: 616c 7565 730a 2020 2020 2020 2020 2020  alues.          
-0001f190: 2020 6f75 745b 6622 5f5f 7b61 6374 6976    out[f"__{activ
-0001f1a0: 6974 797d 5f74 6578 7422 5d20 3d20 5b0a  ity}_text"] = [.
-0001f1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f1c0: 7365 6c66 2e5f 666f 726d 6174 2876 2920  self._format(v) 
-0001f1d0: 2b20 6622 2028 7b76 202a 2070 6572 635f  + f" ({v * perc_
-0001f1e0: 6b69 3a2e 3066 7d25 2922 0a20 2020 2020  ki:.0f}%)".     
-0001f1f0: 2020 2020 2020 2020 2020 2066 6f72 2076             for v
-0001f200: 2c20 7065 7263 5f6b 6920 696e 207a 6970  , perc_ki in zip
-0001f210: 2876 616c 7565 732c 2070 6572 635f 6b29  (values, perc_k)
-0001f220: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
-0001f230: 2020 2020 2020 2069 6620 7363 5f76 6973         if sc_vis
-0001f240: 6962 6c65 5f61 6374 6976 6974 6965 7320  ible_activities 
-0001f250: 213d 2073 656c 662e 7374 6163 6b65 645f  != self.stacked_
-0001f260: 6368 6172 745f 7669 7369 626c 655f 6163  chart_visible_ac
-0001f270: 7469 7669 7469 6573 3a0a 2020 2020 2020  tivities:.      
-0001f280: 2020 2020 2020 7365 6c66 2e73 7562 7374        self.subst
-0001f290: 616e 7469 616c 5f63 6861 6e67 6520 3d20  antial_change = 
-0001f2a0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-0001f2b0: 2073 656c 662e 7374 6163 6b65 645f 6368   self.stacked_ch
-0001f2c0: 6172 745f 7669 7369 626c 655f 6163 7469  art_visible_acti
-0001f2d0: 7669 7469 6573 5b3a 5d20 3d20 7363 5f76  vities[:] = sc_v
-0001f2e0: 6973 6962 6c65 5f61 6374 6976 6974 6965  isible_activitie
-0001f2f0: 730a 0a20 2020 2020 2020 2072 6574 7572  s..        retur
-0001f300: 6e20 6f75 742c 206d 6178 2866 756e 635f  n out, max(func_
-0001f310: 746f 7461 6c73 2c20 6465 6661 756c 743d  totals, default=
-0001f320: 302e 3029 0a0a 2020 2020 6465 6620 5f62  0.0)..    def _b
-0001f330: 7569 6c64 5f74 6173 6b5f 6578 6563 7574  uild_task_execut
-0001f340: 696f 6e5f 6279 5f70 7265 6669 785f 6368  ion_by_prefix_ch
-0001f350: 6172 7428 7365 6c66 2920 2d3e 2066 6967  art(self) -> fig
-0001f360: 7572 653a 0a20 2020 2020 2020 2022 2222  ure:.        """
-0001f370: 4372 6561 7465 2065 6d70 7479 2073 7461  Create empty sta
-0001f380: 636b 6564 2062 6172 2063 6861 7274 2066  cked bar chart f
-0001f390: 6f72 2065 7865 6375 7465 2062 7920 6675  or execute by fu
-0001f3a0: 6e63 7469 6f6e 0a0a 2020 2020 2020 2020  nction..        
-0001f3b0: 5365 6520 616c 736f 0a20 2020 2020 2020  See also.       
-0001f3c0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
-0001f3d0: 2020 5f62 7569 6c64 5f74 6173 6b5f 6578    _build_task_ex
-0001f3e0: 6563 7574 696f 6e5f 6279 5f70 7265 6669  ecution_by_prefi
-0001f3f0: 785f 6461 7461 0a20 2020 2020 2020 205f  x_data.        _
-0001f400: 7570 6461 7465 5f74 6173 6b5f 6578 6563  update_task_exec
-0001f410: 7574 696f 6e5f 6279 5f70 7265 6669 785f  ution_by_prefix_
-0001f420: 6368 6172 740a 2020 2020 2020 2020 2222  chart.        ""
-0001f430: 220a 2020 2020 2020 2020 6261 7263 6861  ".        barcha
-0001f440: 7274 203d 2066 6967 7572 6528 0a20 2020  rt = figure(.   
-0001f450: 2020 2020 2020 2020 2079 5f72 616e 6765           y_range
-0001f460: 3d5b 5d2c 0a20 2020 2020 2020 2020 2020  =[],.           
-0001f470: 2068 6569 6768 743d 3530 302c 0a20 2020   height=500,.   
-0001f480: 2020 2020 2020 2020 2073 697a 696e 675f           sizing_
-0001f490: 6d6f 6465 3d22 7363 616c 655f 626f 7468  mode="scale_both
-0001f4a0: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-0001f4b0: 6974 6c65 3d22 5461 736b 2065 7865 6375  itle="Task execu
-0001f4c0: 7469 6f6e 2c20 6279 2066 756e 6374 696f  tion, by functio
-0001f4d0: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
-0001f4e0: 746f 6f6c 733d 222c 222e 6a6f 696e 2873  tools=",".join(s
-0001f4f0: 656c 662e 4241 5345 5f54 4f4f 4c53 292c  elf.BASE_TOOLS),
-0001f500: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0001f510: 2020 2062 6172 6368 6172 742e 7961 7869     barchart.yaxi
-0001f520: 732e 7669 7369 626c 6520 3d20 5472 7565  s.visible = True
-0001f530: 0a20 2020 2020 2020 2023 2041 7320 6f66  .        # As of
-0001f540: 2042 6f6b 6568 2033 2e31 2c20 4461 7461   Bokeh 3.1, Data
-0001f550: 5261 6e67 6531 4420 2874 6865 2064 6566  Range1D (the def
-0001f560: 6175 6c74 2920 646f 6573 206e 6f74 2077  ault) does not w
-0001f570: 6f72 6b20 7768 656e 2073 7769 7463 6869  ork when switchi
-0001f580: 6e67 2062 6163 6b0a 2020 2020 2020 2020  ng back.        
-0001f590: 2320 6672 6f6d 2062 7974 6573 2028 4769  # from bytes (Gi
-0001f5a0: 4273 2920 746f 2073 6563 6f6e 6473 2028  Bs) to seconds (
-0001f5b0: 6875 6e64 7265 6473 292e 2053 6f20 7765  hundreds). So we
-0001f5c0: 206e 6565 6420 746f 206d 616e 7561 6c6c   need to manuall
-0001f5d0: 7920 7570 6461 7465 2069 742e 0a20 2020  y update it..   
-0001f5e0: 2020 2020 2062 6172 6368 6172 742e 785f       barchart.x_
-0001f5f0: 7261 6e67 6520 3d20 5261 6e67 6531 6428  range = Range1d(
-0001f600: 302c 2031 290a 2020 2020 2020 2020 6261  0, 1).        ba
-0001f610: 7263 6861 7274 2e78 6178 6973 5b30 5d2e  rchart.xaxis[0].
-0001f620: 666f 726d 6174 7465 7220 3d20 4e75 6d65  formatter = Nume
-0001f630: 7261 6c54 6963 6b46 6f72 6d61 7474 6572  ralTickFormatter
-0001f640: 2866 6f72 6d61 743d 2230 303a 3030 3a30  (format="00:00:0
-0001f650: 3022 290a 2020 2020 2020 2020 6261 7263  0").        barc
-0001f660: 6861 7274 2e78 6178 6973 2e6d 616a 6f72  hart.xaxis.major
-0001f670: 5f6c 6162 656c 5f6f 7269 656e 7461 7469  _label_orientati
-0001f680: 6f6e 203d 2030 2e34 0a20 2020 2020 2020  on = 0.4.       
-0001f690: 2062 6172 6368 6172 742e 6772 6964 2e67   barchart.grid.g
-0001f6a0: 7269 645f 6c69 6e65 5f63 6f6c 6f72 203d  rid_line_color =
-0001f6b0: 204e 6f6e 650a 2020 2020 2020 2020 7265   None.        re
-0001f6c0: 7475 726e 2062 6172 6368 6172 740a 0a20  turn barchart.. 
-0001f6d0: 2020 2064 6566 205f 7570 6461 7465 5f74     def _update_t
-0001f6e0: 6173 6b5f 6578 6563 7574 696f 6e5f 6279  ask_execution_by
-0001f6f0: 5f70 7265 6669 785f 6368 6172 7428 7365  _prefix_chart(se
-0001f700: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
-0001f710: 2020 2020 2022 2222 5265 6275 696c 6420       """Rebuild 
-0001f720: 5820 6178 6973 2061 6e64 2074 6f6f 6c74  X axis and toolt
-0001f730: 6970 7320 6f66 2065 7865 6375 7469 6f6e  ips of execution
-0001f740: 2062 7920 7072 6566 6978 2073 7461 636b   by prefix stack
-0001f750: 6564 2063 6861 7274 0a0a 2020 2020 2020  ed chart..      
-0001f760: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
-0001f770: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
-0001f780: 2020 2020 5f62 7569 6c64 5f74 6173 6b5f      _build_task_
-0001f790: 6578 6563 7574 696f 6e5f 6279 5f70 7265  execution_by_pre
-0001f7a0: 6669 785f 6461 7461 0a20 2020 2020 2020  fix_data.       
-0001f7b0: 205f 6275 696c 645f 7461 736b 5f65 7865   _build_task_exe
-0001f7c0: 6375 7469 6f6e 5f62 795f 7072 6566 6978  cution_by_prefix
-0001f7d0: 5f63 6861 7274 0a20 2020 2020 2020 2022  _chart.        "
-0001f7e0: 2222 0a20 2020 2020 2020 2062 6172 6368  "".        barch
-0001f7f0: 6172 7420 3d20 7365 6c66 2e74 6173 6b5f  art = self.task_
-0001f800: 6578 6563 5f62 795f 7072 6566 6978 5f63  exec_by_prefix_c
-0001f810: 6861 7274 0a20 2020 2020 2020 2061 7373  hart.        ass
-0001f820: 6572 7420 6261 7263 6861 7274 2069 7320  ert barchart is 
-0001f830: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
-0001f840: 2062 6172 6368 6172 742e 795f 7261 6e67   barchart.y_rang
-0001f850: 6520 3d20 4661 6374 6f72 5261 6e67 6528  e = FactorRange(
-0001f860: 2a73 656c 662e 7669 7369 626c 655f 6675  *self.visible_fu
-0001f870: 6e63 7469 6f6e 7329 0a0a 2020 2020 2020  nctions)..      
-0001f880: 2020 7061 6c65 7474 6520 3d20 5b0a 2020    palette = [.  
-0001f890: 2020 2020 2020 2020 2020 700a 2020 2020            p.    
-0001f8a0: 2020 2020 2020 2020 666f 7220 702c 2061          for p, a
-0001f8b0: 2069 6e20 7a69 7028 7365 6c66 2e5f 6765   in zip(self._ge
-0001f8c0: 745f 7061 6c65 7474 6528 292c 2073 656c  t_palette(), sel
-0001f8d0: 662e 7669 7369 626c 655f 6163 7469 7669  f.visible_activi
-0001f8e0: 7469 6573 290a 2020 2020 2020 2020 2020  ties).          
-0001f8f0: 2020 6966 2061 2069 6e20 7365 6c66 2e73    if a in self.s
-0001f900: 7461 636b 6564 5f63 6861 7274 5f76 6973  tacked_chart_vis
-0001f910: 6962 6c65 5f61 6374 6976 6974 6965 730a  ible_activities.
-0001f920: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-0001f930: 2020 6173 7365 7274 206c 656e 2870 616c    assert len(pal
-0001f940: 6574 7465 2920 3d3d 206c 656e 2873 656c  ette) == len(sel
-0001f950: 662e 7374 6163 6b65 645f 6368 6172 745f  f.stacked_chart_
-0001f960: 7669 7369 626c 655f 6163 7469 7669 7469  visible_activiti
-0001f970: 6573 290a 2020 2020 2020 2020 7265 6e64  es).        rend
-0001f980: 6572 6572 7320 3d20 6261 7263 6861 7274  erers = barchart
-0001f990: 2e68 6261 725f 7374 6163 6b28 0a20 2020  .hbar_stack(.   
-0001f9a0: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
-0001f9b0: 6163 6b65 645f 6368 6172 745f 7669 7369  acked_chart_visi
-0001f9c0: 626c 655f 6163 7469 7669 7469 6573 2c0a  ble_activities,.
-0001f9d0: 2020 2020 2020 2020 2020 2020 793d 225f              y="_
-0001f9e0: 5f66 756e 6374 696f 6e73 222c 0a20 2020  _functions",.   
-0001f9f0: 2020 2020 2020 2020 2077 6964 7468 3d30           width=0
-0001fa00: 2e39 2c0a 2020 2020 2020 2020 2020 2020  .9,.            
-0001fa10: 736f 7572 6365 3d73 656c 662e 7461 736b  source=self.task
-0001fa20: 5f65 7865 635f 6279 5f70 7265 6669 785f  _exec_by_prefix_
-0001fa30: 7372 632c 0a20 2020 2020 2020 2020 2020  src,.           
-0001fa40: 2063 6f6c 6f72 3d70 616c 6574 7465 2c0a   color=palette,.
-0001fa50: 2020 2020 2020 2020 2020 2020 6c65 6765              lege
-0001fa60: 6e64 5f6c 6162 656c 3d73 656c 662e 7374  nd_label=self.st
-0001fa70: 6163 6b65 645f 6368 6172 745f 7669 7369  acked_chart_visi
-0001fa80: 626c 655f 6163 7469 7669 7469 6573 2c0a  ble_activities,.
-0001fa90: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0001faa0: 2020 2023 2043 7265 6174 6520 6f72 2072     # Create or r
-0001fab0: 6566 7265 7368 2068 6f76 6572 746f 6f6c  efresh hovertool
-0001fac0: 7320 6f6e 2074 6f70 206f 6620 6261 7365  s on top of base
-0001fad0: 2074 6f6f 6c73 0a20 2020 2020 2020 2062   tools.        b
-0001fae0: 6172 6368 6172 742e 746f 6f6c 7320 3d20  archart.tools = 
-0001faf0: 6261 7263 6861 7274 2e74 6f6f 6c73 5b3a  barchart.tools[:
-0001fb00: 206c 656e 2873 656c 662e 4241 5345 5f54   len(self.BASE_T
-0001fb10: 4f4f 4c53 295d 0a0a 2020 2020 2020 2020  OOLS)]..        
-0001fb20: 666f 7220 7662 6172 2069 6e20 7265 6e64  for vbar in rend
-0001fb30: 6572 6572 733a 0a20 2020 2020 2020 2020  erers:.         
-0001fb40: 2020 2074 6f6f 6c74 6970 7320 3d20 5b0a     tooltips = [.
-0001fb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fb60: 2822 6675 6e63 7469 6f6e 222c 2022 405f  ("function", "@_
-0001fb70: 5f66 756e 6374 696f 6e73 2229 2c0a 2020  _functions"),.  
-0001fb80: 2020 2020 2020 2020 2020 2020 2020 2876                (v
-0001fb90: 6261 722e 6e61 6d65 2c20 6622 407b 7b5f  bar.name, f"@{{_
-0001fba0: 5f7b 7662 6172 2e6e 616d 657d 5f74 6578  _{vbar.name}_tex
-0001fbb0: 747d 7d22 292c 0a20 2020 2020 2020 2020  t}}"),.         
-0001fbc0: 2020 2020 2020 2028 2274 6f74 616c 222c         ("total",
-0001fbd0: 2022 405f 5f5f 5f74 6f74 616c 5f74 6578   "@____total_tex
-0001fbe0: 7422 292c 0a20 2020 2020 2020 2020 2020  t"),.           
-0001fbf0: 205d 0a20 2020 2020 2020 2020 2020 2062   ].            b
-0001fc00: 6172 6368 6172 742e 6164 645f 746f 6f6c  archart.add_tool
-0001fc10: 7328 486f 7665 7254 6f6f 6c28 746f 6f6c  s(HoverTool(tool
-0001fc20: 7469 7073 3d74 6f6f 6c74 6970 732c 2072  tips=tooltips, r
-0001fc30: 656e 6465 7265 7273 3d5b 7662 6172 5d29  enderers=[vbar])
-0001fc40: 290a 2020 2020 2020 2020 6261 7263 6861  ).        barcha
-0001fc50: 7274 2e72 656e 6465 7265 7273 203d 2072  rt.renderers = r
-0001fc60: 656e 6465 7265 7273 0a0a 0a63 6c61 7373  enderers...class
-0001fc70: 2043 6f6e 7465 6e74 696f 6e28 4461 7368   Contention(Dash
-0001fc80: 626f 6172 6443 6f6d 706f 6e65 6e74 293a  boardComponent):
-0001fc90: 0a20 2020 2022 2222 0a20 2020 2045 7665  .    """.    Eve
-0001fca0: 6e74 204c 6f6f 7020 4865 616c 7468 2028  nt Loop Health (
-0001fcb0: 616e 6420 4749 4c20 436f 6e74 656e 7469  and GIL Contenti
-0001fcc0: 6f6e 2c20 6966 2063 6f6e 6669 6775 7265  on, if configure
-0001fcd0: 6429 0a20 2020 2022 2222 0a0a 2020 2020  d).    """..    
-0001fce0: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-0001fcf0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-0001fd00: 662c 2073 6368 6564 756c 6572 2c20 2a2a  f, scheduler, **
-0001fd10: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
-0001fd20: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
-0001fd30: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
-0001fd40: 2020 2020 7365 6c66 2e64 6174 6120 3d20      self.data = 
-0001fd50: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
-0001fd60: 2020 6e61 6d65 733d 5b0a 2020 2020 2020    names=[.      
-0001fd70: 2020 2020 2020 2020 2020 2822 5363 6865            ("Sche
-0001fd80: 6475 6c65 7222 2c20 2245 7665 6e74 204c  duler", "Event L
-0001fd90: 6f6f 7022 292c 0a20 2020 2020 2020 2020  oop"),.         
-0001fda0: 2020 2020 2020 2028 2253 6368 6564 756c         ("Schedul
-0001fdb0: 6572 222c 2022 4749 4c22 292c 0a20 2020  er", "GIL"),.   
-0001fdc0: 2020 2020 2020 2020 2020 2020 2028 2257               ("W
-0001fdd0: 6f72 6b65 7273 222c 2022 4576 656e 7420  orkers", "Event 
-0001fde0: 4c6f 6f70 2229 2c0a 2020 2020 2020 2020  Loop"),.        
-0001fdf0: 2020 2020 2020 2020 2822 576f 726b 6572          ("Worker
-0001fe00: 7322 2c20 2247 494c 2229 2c0a 2020 2020  s", "GIL"),.    
-0001fe10: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
-0001fe20: 2020 2020 2020 2076 616c 7565 733d 5b30         values=[0
-0001fe30: 2c20 302c 2030 2c20 305d 2c0a 2020 2020  , 0, 0, 0],.    
-0001fe40: 2020 2020 2020 2020 7465 7874 3d5b 2230          text=["0
-0001fe50: 7322 2c20 2230 2522 2c20 2230 7322 2c20  s", "0%", "0s", 
-0001fe60: 2230 2522 5d2c 0a20 2020 2020 2020 2029  "0%"],.        )
-0001fe70: 0a20 2020 2020 2020 2074 6974 6c65 203d  .        title =
-0001fe80: 2022 4576 656e 7420 4c6f 6f70 2026 2047   "Event Loop & G
-0001fe90: 494c 2043 6f6e 7465 6e74 696f 6e22 0a0a  IL Contention"..
-0001fea0: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
-0001feb0: 2047 494c 2072 656c 6174 6564 206e 616d   GIL related nam
-0001fec0: 6573 2f76 616c 7565 7320 6966 206e 6f74  es/values if not
-0001fed0: 206d 6f6e 6974 6f72 696e 6720 4749 4c0a   monitoring GIL.
-0001fee0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0001fef0: 656c 662e 7363 6865 6475 6c65 722e 6d6f  elf.scheduler.mo
-0001ff00: 6e69 746f 722e 6d6f 6e69 746f 725f 6769  nitor.monitor_gi
-0001ff10: 6c5f 636f 6e74 656e 7469 6f6e 3a0a 2020  l_contention:.  
-0001ff20: 2020 2020 2020 2020 2020 7469 746c 6520            title 
-0001ff30: 3d20 2245 7665 6e74 204c 6f6f 7022 0a20  = "Event Loop". 
-0001ff40: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-0001ff50: 6579 2069 6e20 7365 6c66 2e64 6174 613a  ey in self.data:
-0001ff60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ff70: 2073 656c 662e 6461 7461 5b6b 6579 5d20   self.data[key] 
-0001ff80: 3d20 7365 6c66 2e64 6174 615b 6b65 795d  = self.data[key]
-0001ff90: 5b3a 3a32 5d0a 0a20 2020 2020 2020 2073  [::2]..        s
-0001ffa0: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
-0001ffb0: 756d 6e44 6174 6153 6f75 7263 6528 6461  umnDataSource(da
-0001ffc0: 7461 3d73 656c 662e 6461 7461 290a 2020  ta=self.data).  
-0001ffd0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
-0001ffe0: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
-0001fff0: 2020 2020 2020 7469 746c 653d 7469 746c        title=titl
-00020000: 652c 0a20 2020 2020 2020 2020 2020 2078  e,.            x
-00020010: 5f72 616e 6765 3d46 6163 746f 7252 616e  _range=FactorRan
-00020020: 6765 282a 7365 6c66 2e64 6174 615b 226e  ge(*self.data["n
-00020030: 616d 6573 225d 292c 0a20 2020 2020 2020  ames"]),.       
-00020040: 2020 2020 2079 5f72 616e 6765 3d28 302c       y_range=(0,
-00020050: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
-00020060: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
-00020070: 2020 2020 2020 2074 6f6f 6c62 6172 5f6c         toolbar_l
-00020080: 6f63 6174 696f 6e3d 2261 626f 7665 222c  ocation="above",
-00020090: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
-000200a0: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
-000200b0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-000200c0: 6f74 2e76 6261 7228 0a20 2020 2020 2020  ot.vbar(.       
-000200d0: 2020 2020 2078 3d22 6e61 6d65 7322 2c0a       x="names",.
-000200e0: 2020 2020 2020 2020 2020 2020 746f 703d              top=
-000200f0: 2276 616c 7565 7322 2c0a 2020 2020 2020  "values",.      
-00020100: 2020 2020 2020 7769 6474 683d 302e 392c        width=0.9,
-00020110: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
-00020120: 655f 636f 6c6f 723d 2277 6869 7465 222c  e_color="white",
-00020130: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
-00020140: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
-00020150: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
-00020160: 6c5f 636f 6c6f 723d 6661 6374 6f72 5f63  l_color=factor_c
-00020170: 6d61 7028 0a20 2020 2020 2020 2020 2020  map(.           
-00020180: 2020 2020 2066 6965 6c64 5f6e 616d 653d       field_name=
-00020190: 226e 616d 6573 222c 0a20 2020 2020 2020  "names",.       
-000201a0: 2020 2020 2020 2020 2070 616c 6574 7465           palette
-000201b0: 3d5b 2223 6238 6530 6365 222c 2022 2338  =["#b8e0ce", "#8
-000201c0: 3161 6165 3422 5d2c 0a20 2020 2020 2020  1aae4"],.       
-000201d0: 2020 2020 2020 2020 2066 6163 746f 7273           factors
-000201e0: 3d5b 2245 7665 6e74 204c 6f6f 7022 2c20  =["Event Loop", 
-000201f0: 2247 494c 225d 2c0a 2020 2020 2020 2020  "GIL"],.        
-00020200: 2020 2020 2020 2020 7374 6172 743d 312c          start=1,
-00020210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020220: 2065 6e64 3d32 2c0a 2020 2020 2020 2020   end=2,.        
-00020230: 2020 2020 292c 0a20 2020 2020 2020 2029      ),.        )
-00020240: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-00020250: 6f6f 742e 785f 7261 6e67 652e 6772 6f75  oot.x_range.grou
-00020260: 705f 7061 6464 696e 6720 3d20 302e 3235  p_padding = 0.25
-00020270: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
-00020280: 6f74 2e78 6178 6973 2e6d 696e 6f72 5f74  ot.xaxis.minor_t
-00020290: 6963 6b5f 6c69 6e65 5f61 6c70 6861 203d  ick_line_alpha =
-000202a0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
-000202b0: 726f 6f74 2e79 6772 6964 2e76 6973 6962  root.ygrid.visib
-000202c0: 6c65 203d 2054 7275 650a 2020 2020 2020  le = True.      
-000202d0: 2020 7365 6c66 2e72 6f6f 742e 7867 7269    self.root.xgri
-000202e0: 642e 7669 7369 626c 6520 3d20 4661 6c73  d.visible = Fals
-000202f0: 650a 0a20 2020 2020 2020 2068 6f76 6572  e..        hover
-00020300: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
-00020310: 2020 2020 2020 2020 2020 746f 6f6c 7469            toolti
-00020320: 7073 3d5b 2822 4e61 6d65 222c 2022 406e  ps=[("Name", "@n
-00020330: 616d 6573 2229 2c20 2822 5661 6c75 6522  ames"), ("Value"
-00020340: 2c20 2240 7465 7874 2229 5d2c 206d 6f64  , "@text")], mod
-00020350: 653d 2276 6c69 6e65 220a 2020 2020 2020  e="vline".      
-00020360: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00020370: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
-00020380: 686f 7665 7229 0a0a 2020 2020 4077 6974  hover)..    @wit
-00020390: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
-000203a0: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
-000203b0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-000203c0: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
-000203d0: 2020 2020 2020 2073 203d 2073 656c 662e         s = self.
-000203e0: 7363 6865 6475 6c65 720a 0a20 2020 2020  scheduler..     
-000203f0: 2020 2073 656c 662e 6461 7461 5b22 7661     self.data["va
-00020400: 6c75 6573 225d 203d 205b 0a20 2020 2020  lues"] = [.     
-00020410: 2020 2020 2020 2073 2e5f 7469 636b 5f69         s._tick_i
-00020420: 6e74 6572 7661 6c5f 6f62 7365 7276 6564  nterval_observed
-00020430: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
-00020440: 6c66 2e67 696c 5f63 6f6e 7465 6e74 696f  lf.gil_contentio
-00020450: 6e5f 7363 6865 6475 6c65 722c 0a20 2020  n_scheduler,.   
-00020460: 2020 2020 2020 2020 2073 756d 2877 2e6d           sum(w.m
-00020470: 6574 7269 6373 5b22 6576 656e 745f 6c6f  etrics["event_lo
-00020480: 6f70 5f69 6e74 6572 7661 6c22 5d20 666f  op_interval"] fo
-00020490: 7220 7720 696e 2073 2e77 6f72 6b65 7273  r w in s.workers
-000204a0: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
-000204b0: 2020 2020 2020 202f 2028 6c65 6e28 732e         / (len(s.
-000204c0: 776f 726b 6572 7329 206f 7220 3129 2c0a  workers) or 1),.
-000204d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-000204e0: 2e67 696c 5f63 6f6e 7465 6e74 696f 6e5f  .gil_contention_
-000204f0: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
-00020500: 205d 5b3a 3a20 3120 6966 2073 2e6d 6f6e   ][:: 1 if s.mon
-00020510: 6974 6f72 2e6d 6f6e 6974 6f72 5f67 696c  itor.monitor_gil
-00020520: 5f63 6f6e 7465 6e74 696f 6e20 656c 7365  _contention else
-00020530: 2032 5d0a 0a20 2020 2020 2020 2023 2046   2]..        # F
-00020540: 6f72 6d61 7420 6576 656e 7420 6c6f 6f70  ormat event loop
-00020550: 2061 7320 7469 6d65 2061 6e64 2047 494c   as time and GIL
-00020560: 2028 6966 2063 6f6e 6669 6775 7265 6429   (if configured)
-00020570: 2061 7320 250a 2020 2020 2020 2020 7365   as %.        se
-00020580: 6c66 2e64 6174 615b 2274 6578 7422 5d20  lf.data["text"] 
-00020590: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-000205a0: 6622 7b78 202a 2031 3030 3a2e 3166 7d25  f"{x * 100:.1f}%
-000205b0: 220a 2020 2020 2020 2020 2020 2020 6966  ".            if
-000205c0: 2069 2025 2032 2061 6e64 2073 2e6d 6f6e   i % 2 and s.mon
-000205d0: 6974 6f72 2e6d 6f6e 6974 6f72 5f67 696c  itor.monitor_gil
-000205e0: 5f63 6f6e 7465 6e74 696f 6e0a 2020 2020  _contention.    
-000205f0: 2020 2020 2020 2020 656c 7365 2066 6f72          else for
-00020600: 6d61 745f 7469 6d65 2878 290a 2020 2020  mat_time(x).    
-00020610: 2020 2020 2020 2020 666f 7220 692c 2078          for i, x
-00020620: 2069 6e20 656e 756d 6572 6174 6528 7365   in enumerate(se
-00020630: 6c66 2e64 6174 615b 2276 616c 7565 7322  lf.data["values"
-00020640: 5d29 0a20 2020 2020 2020 205d 0a20 2020  ]).        ].   
-00020650: 2020 2020 2075 7064 6174 6528 7365 6c66       update(self
-00020660: 2e73 6f75 7263 652c 2073 656c 662e 6461  .source, self.da
-00020670: 7461 290a 0a20 2020 2040 7072 6f70 6572  ta)..    @proper
-00020680: 7479 0a20 2020 2064 6566 2067 696c 5f63  ty.    def gil_c
-00020690: 6f6e 7465 6e74 696f 6e5f 776f 726b 6572  ontention_worker
-000206a0: 7328 7365 6c66 2920 2d3e 2066 6c6f 6174  s(self) -> float
-000206b0: 3a0a 2020 2020 2020 2020 776f 726b 6572  :.        worker
-000206c0: 7320 3d20 7365 6c66 2e73 6368 6564 756c  s = self.schedul
-000206d0: 6572 2e77 6f72 6b65 7273 0a20 2020 2020  er.workers.     
-000206e0: 2020 2069 6620 776f 726b 6572 733a 0a20     if workers:. 
-000206f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00020700: 6e20 7375 6d28 0a20 2020 2020 2020 2020  n sum(.         
-00020710: 2020 2020 2020 2077 2e6d 6574 7269 6373         w.metrics
-00020720: 2e67 6574 2822 6769 6c5f 636f 6e74 656e  .get("gil_conten
-00020730: 7469 6f6e 222c 2030 2920 666f 7220 7720  tion", 0) for w 
-00020740: 696e 2077 6f72 6b65 7273 2e76 616c 7565  in workers.value
-00020750: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-00020760: 2920 2f20 6c65 6e28 776f 726b 6572 7329  ) / len(workers)
-00020770: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00020780: 666c 6f61 7428 224e 614e 2229 0a0a 2020  float("NaN")..  
-00020790: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-000207a0: 6465 6620 6769 6c5f 636f 6e74 656e 7469  def gil_contenti
-000207b0: 6f6e 5f73 6368 6564 756c 6572 2873 656c  on_scheduler(sel
-000207c0: 6629 202d 3e20 666c 6f61 743a 0a20 2020  f) -> float:.   
-000207d0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000207e0: 2e73 6368 6564 756c 6572 2e6d 6f6e 6974  .scheduler.monit
-000207f0: 6f72 2e72 6563 656e 7428 292e 6765 7428  or.recent().get(
-00020800: 2267 696c 5f63 6f6e 7465 6e74 696f 6e22  "gil_contention"
-00020810: 2c20 666c 6f61 7428 224e 614e 2229 290a  , float("NaN")).
-00020820: 0a0a 636c 6173 7320 4578 6365 7074 696f  ..class Exceptio
-00020830: 6e73 5461 626c 6528 4461 7368 626f 6172  nsTable(Dashboar
-00020840: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
-00020850: 2022 2222 0a20 2020 2045 7863 6570 7469   """.    Excepti
-00020860: 6f6e 7320 6c6f 6767 6564 2069 6e20 7461  ons logged in ta
-00020870: 736b 732e 0a0a 2020 2020 5369 6e63 6520  sks...    Since 
-00020880: 7468 6572 6520 6d69 6768 7420 6265 206d  there might be m
-00020890: 616e 7920 7265 6c61 7465 6420 6578 6365  any related exce
-000208a0: 7074 696f 6e73 2028 652e 672e 2c20 616c  ptions (e.g., al
-000208b0: 6c20 7461 736b 7320 696e 2061 2067 6976  l tasks in a giv
-000208c0: 656e 0a20 2020 2074 6173 6b20 6772 6f75  en.    task grou
-000208d0: 7020 6661 696c 2066 6f72 2074 6865 2073  p fail for the s
-000208e0: 616d 6520 7265 6173 6f6e 292c 2077 6520  ame reason), we 
-000208f0: 6d61 6b65 2061 2062 6573 742d 6566 666f  make a best-effo
-00020900: 7274 2061 7474 656d 7074 2074 6f0a 2020  rt attempt to.  
-00020910: 2020 2831 2920 6167 6772 6567 6174 6520    (1) aggregate 
-00020920: 746f 2074 6865 2074 6173 6b20 6772 6f75  to the task grou
-00020930: 702c 2061 6e64 2028 3229 2064 6564 7570  p, and (2) dedup
-00020940: 6c69 6361 7465 2073 696d 696c 6172 206c  licate similar l
-00020950: 6f6f 6b69 6e67 2074 6173 6b73 2e0a 2020  ooking tasks..  
-00020960: 2020 2222 220a 0a20 2020 2073 6368 6564    """..    sched
-00020970: 756c 6572 3a20 5363 6865 6475 6c65 720a  uler: Scheduler.
-00020980: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00020990: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
-000209a0: 723a 2053 6368 6564 756c 6572 2c20 7769  r: Scheduler, wi
-000209b0: 6474 683a 2069 6e74 203d 2031 3030 302c  dth: int = 1000,
-000209c0: 202a 2a6b 7761 7267 733a 2041 6e79 293a   **kwargs: Any):
-000209d0: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
-000209e0: 6865 6475 6c65 7220 3d20 7363 6865 6475  heduler = schedu
-000209f0: 6c65 720a 0a20 2020 2020 2020 2073 656c  ler..        sel
-00020a00: 662e 6e61 6d65 7320 3d20 5b0a 2020 2020  f.names = [.    
-00020a10: 2020 2020 2020 2020 2254 6173 6b22 2c0a          "Task",.
-00020a20: 2020 2020 2020 2020 2020 2020 2245 7863              "Exc
-00020a30: 6570 7469 6f6e 222c 0a20 2020 2020 2020  eption",.       
-00020a40: 2020 2020 2022 5472 6163 6562 6163 6b22       "Traceback"
-00020a50: 2c0a 2020 2020 2020 2020 2020 2020 2257  ,.            "W
-00020a60: 6f72 6b65 7228 7329 222c 0a20 2020 2020  orker(s)",.     
-00020a70: 2020 2020 2020 2022 436f 756e 7422 2c0a         "Count",.
-00020a80: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
-00020a90: 2020 2073 656c 662e 736f 7572 6365 203d     self.source =
-00020aa0: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
-00020ab0: 6528 7b6b 3a20 5b5d 2066 6f72 206b 2069  e({k: [] for k i
-00020ac0: 6e20 7365 6c66 2e6e 616d 6573 7d29 0a0a  n self.names})..
-00020ad0: 2020 2020 2020 2020 636f 6465 5f66 6f72          code_for
-00020ae0: 6d61 7474 6572 203d 2048 544d 4c54 656d  matter = HTMLTem
-00020af0: 706c 6174 6546 6f72 6d61 7474 6572 280a  plateFormatter(.
-00020b00: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
-00020b10: 6c61 7465 3d27 3c63 6f64 6520 7469 746c  late='<code titl
-00020b20: 653d 223c 252d 2076 616c 7565 2025 3e22  e="<%- value %>"
-00020b30: 3e3c 253d 2076 616c 7565 2025 3e3c 2f63  ><%= value %></c
-00020b40: 6f64 653e 270a 2020 2020 2020 2020 290a  ode>'.        ).
-00020b50: 2020 2020 2020 2020 636f 6c75 6d6e 7320          columns 
-00020b60: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00020b70: 5461 626c 6543 6f6c 756d 6e28 0a20 2020  TableColumn(.   
-00020b80: 2020 2020 2020 2020 2020 2020 2066 6965               fie
-00020b90: 6c64 3d22 5461 736b 222c 0a20 2020 2020  ld="Task",.     
-00020ba0: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-00020bb0: 3d22 5461 736b 222c 0a20 2020 2020 2020  ="Task",.       
-00020bc0: 2020 2020 2020 2020 2066 6f72 6d61 7474           formatt
-00020bd0: 6572 3d63 6f64 655f 666f 726d 6174 7465  er=code_formatte
-00020be0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
-00020bf0: 2020 2077 6964 7468 3d31 3530 2c0a 2020     width=150,.  
-00020c00: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00020c10: 2020 2020 2020 2020 2054 6162 6c65 436f           TableCo
-00020c20: 6c75 6d6e 280a 2020 2020 2020 2020 2020  lumn(.          
-00020c30: 2020 2020 2020 6669 656c 643d 2245 7863        field="Exc
-00020c40: 6570 7469 6f6e 222c 0a20 2020 2020 2020  eption",.       
-00020c50: 2020 2020 2020 2020 2074 6974 6c65 3d22           title="
-00020c60: 4578 6365 7074 696f 6e22 2c0a 2020 2020  Exception",.    
-00020c70: 2020 2020 2020 2020 2020 2020 666f 726d              form
-00020c80: 6174 7465 723d 636f 6465 5f66 6f72 6d61  atter=code_forma
-00020c90: 7474 6572 2c0a 2020 2020 2020 2020 2020  tter,.          
-00020ca0: 2020 2020 2020 7769 6474 683d 3330 302c        width=300,
-00020cb0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
-00020cc0: 2020 2020 2020 2020 2020 2020 5461 626c              Tabl
-00020cd0: 6543 6f6c 756d 6e28 0a20 2020 2020 2020  eColumn(.       
-00020ce0: 2020 2020 2020 2020 2066 6965 6c64 3d22           field="
-00020cf0: 5472 6163 6562 6163 6b22 2c0a 2020 2020  Traceback",.    
-00020d00: 2020 2020 2020 2020 2020 2020 7469 746c              titl
-00020d10: 653d 2254 7261 6365 6261 636b 222c 0a20  e="Traceback",. 
-00020d20: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00020d30: 6f72 6d61 7474 6572 3d63 6f64 655f 666f  ormatter=code_fo
-00020d40: 726d 6174 7465 722c 0a20 2020 2020 2020  rmatter,.       
-00020d50: 2020 2020 2020 2020 2077 6964 7468 3d33           width=3
-00020d60: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
-00020d70: 292c 0a20 2020 2020 2020 2020 2020 2054  ),.            T
-00020d80: 6162 6c65 436f 6c75 6d6e 280a 2020 2020  ableColumn(.    
-00020d90: 2020 2020 2020 2020 2020 2020 6669 656c              fiel
-00020da0: 643d 2257 6f72 6b65 7228 7329 222c 0a20  d="Worker(s)",. 
-00020db0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00020dc0: 6974 6c65 3d22 576f 726b 6572 2873 2922  itle="Worker(s)"
-00020dd0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00020de0: 2020 666f 726d 6174 7465 723d 636f 6465    formatter=code
-00020df0: 5f66 6f72 6d61 7474 6572 2c0a 2020 2020  _formatter,.    
-00020e00: 2020 2020 2020 2020 2020 2020 7769 6474              widt
-00020e10: 683d 3230 302c 0a20 2020 2020 2020 2020  h=200,.         
-00020e20: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
-00020e30: 2020 5461 626c 6543 6f6c 756d 6e28 0a20    TableColumn(. 
-00020e40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00020e50: 6965 6c64 3d22 436f 756e 7422 2c0a 2020  ield="Count",.  
-00020e60: 2020 2020 2020 2020 2020 2020 2020 7469                ti
-00020e70: 746c 653d 2243 6f75 6e74 222c 0a20 2020  tle="Count",.   
-00020e80: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00020e90: 6d61 7474 6572 3d4e 756d 6265 7246 6f72  matter=NumberFor
-00020ea0: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
-00020eb0: 2c30 2229 2c0a 2020 2020 2020 2020 2020  ,0"),.          
-00020ec0: 2020 2020 2020 7769 6474 683d 3530 2c0a        width=50,.
-00020ed0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-00020ee0: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
-00020ef0: 2020 6966 2022 7369 7a69 6e67 5f6d 6f64    if "sizing_mod
-00020f00: 6522 2069 6e20 6b77 6172 6773 3a0a 2020  e" in kwargs:.  
-00020f10: 2020 2020 2020 2020 2020 7369 7a69 6e67            sizing
-00020f20: 5f6d 6f64 6520 3d20 7b22 7369 7a69 6e67  _mode = {"sizing
-00020f30: 5f6d 6f64 6522 3a20 6b77 6172 6773 5b22  _mode": kwargs["
-00020f40: 7369 7a69 6e67 5f6d 6f64 6522 5d7d 0a20  sizing_mode"]}. 
-00020f50: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00020f60: 2020 2020 2020 2020 2073 697a 696e 675f           sizing_
-00020f70: 6d6f 6465 203d 207b 7d0a 2020 2020 2020  mode = {}.      
-00020f80: 2020 7365 6c66 2e72 6f6f 7420 3d20 4461    self.root = Da
-00020f90: 7461 5461 626c 6528 0a20 2020 2020 2020  taTable(.       
-00020fa0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
-00020fb0: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
-00020fc0: 2020 2020 2063 6f6c 756d 6e73 3d63 6f6c       columns=col
-00020fd0: 756d 6e73 2c0a 2020 2020 2020 2020 2020  umns,.          
-00020fe0: 2020 7265 6f72 6465 7261 626c 653d 5472    reorderable=Tr
-00020ff0: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-00021000: 736f 7274 6162 6c65 3d54 7275 652c 0a20  sortable=True,. 
-00021010: 2020 2020 2020 2020 2020 2077 6964 7468             width
-00021020: 3d77 6964 7468 2c0a 2020 2020 2020 2020  =width,.        
-00021030: 2020 2020 696e 6465 785f 706f 7369 7469      index_positi
-00021040: 6f6e 3d4e 6f6e 652c 0a20 2020 2020 2020  on=None,.       
-00021050: 2020 2020 202a 2a5f 4441 5441 5441 424c       **_DATATABL
-00021060: 455f 5354 594c 4553 4845 4554 535f 4b57  E_STYLESHEETS_KW
-00021070: 4152 4753 2c0a 2020 2020 2020 2020 2020  ARGS,.          
-00021080: 2020 2a2a 7369 7a69 6e67 5f6d 6f64 652c    **sizing_mode,
-00021090: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-000210a0: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
-000210b0: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
-000210c0: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
-000210d0: 293a 0a20 2020 2020 2020 206e 6577 5f64  ):.        new_d
-000210e0: 6174 6120 3d20 7b6e 616d 653a 205b 5d20  ata = {name: [] 
-000210f0: 666f 7220 6e61 6d65 2069 6e20 7365 6c66  for name in self
-00021100: 2e6e 616d 6573 7d0a 2020 2020 2020 2020  .names}.        
-00021110: 6572 7265 645f 7461 736b 7320 3d20 7365  erred_tasks = se
-00021120: 6c66 2e73 6368 6564 756c 6572 2e65 7272  lf.scheduler.err
-00021130: 6564 5f74 6173 6b73 0a0a 2020 2020 2020  ed_tasks..      
-00021140: 2020 666f 7220 7473 2069 6e20 6572 7265    for ts in erre
-00021150: 645f 7461 736b 733a 0a20 2020 2020 2020  d_tasks:.       
-00021160: 2020 2020 206e 6577 5f64 6174 615b 2254       new_data["T
-00021170: 6173 6b22 5d2e 6170 7065 6e64 2874 732e  ask"].append(ts.
-00021180: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
-00021190: 206e 6577 5f64 6174 615b 2245 7863 6570   new_data["Excep
-000211a0: 7469 6f6e 225d 2e61 7070 656e 6428 7473  tion"].append(ts
-000211b0: 2e65 7863 6570 7469 6f6e 5f74 6578 7429  .exception_text)
-000211c0: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
-000211d0: 5f64 6174 615b 2254 7261 6365 6261 636b  _data["Traceback
-000211e0: 225d 2e61 7070 656e 6428 7473 2e74 7261  "].append(ts.tra
-000211f0: 6365 6261 636b 5f74 6578 7429 0a20 2020  ceback_text).   
-00021200: 2020 2020 2020 2020 206e 6577 5f64 6174           new_dat
-00021210: 615b 2257 6f72 6b65 7228 7329 225d 2e61  a["Worker(s)"].a
-00021220: 7070 656e 6428 222c 5c6e 222e 6a6f 696e  ppend(",\n".join
-00021230: 2874 732e 6572 7265 645f 6f6e 2929 0a20  (ts.erred_on)). 
-00021240: 2020 2020 2020 2020 2020 206e 6577 5f64             new_d
-00021250: 6174 615b 2243 6f75 6e74 225d 2e61 7070  ata["Count"].app
-00021260: 656e 6428 6c65 6e28 7473 2e65 7272 6564  end(len(ts.erred
-00021270: 5f6f 6e29 290a 0a20 2020 2020 2020 2075  _on))..        u
-00021280: 7064 6174 6528 7365 6c66 2e73 6f75 7263  pdate(self.sourc
-00021290: 652c 206e 6577 5f64 6174 6129 0a0a 0a63  e, new_data)...c
-000212a0: 6c61 7373 2057 6f72 6b65 7254 6162 6c65  lass WorkerTable
-000212b0: 2844 6173 6862 6f61 7264 436f 6d70 6f6e  (DashboardCompon
-000212c0: 656e 7429 3a0a 2020 2020 2222 2253 7461  ent):.    """Sta
-000212d0: 7475 7320 6f66 2074 6865 2063 7572 7265  tus of the curre
-000212e0: 6e74 2077 6f72 6b65 7273 0a0a 2020 2020  nt workers..    
-000212f0: 5468 6973 2069 7320 7477 6f20 706c 6f74  This is two plot
-00021300: 732c 2061 2074 6578 742d 6261 7365 6420  s, a text-based 
-00021310: 7461 626c 6520 666f 7220 6561 6368 2068  table for each h
-00021320: 6f73 7420 616e 6420 6120 7468 696e 2068  ost and a thin h
-00021330: 6f72 697a 6f6e 7461 6c0a 2020 2020 706c  orizontal.    pl
-00021340: 6f74 206c 6179 696e 6720 6f75 7420 686f  ot laying out ho
-00021350: 7374 7320 6279 2074 6865 6972 2063 7572  sts by their cur
-00021360: 7265 6e74 206d 656d 6f72 7920 7573 652e  rent memory use.
-00021370: 0a20 2020 2022 2222 0a0a 2020 2020 6578  .    """..    ex
-00021380: 636c 7564 6564 5f6e 616d 6573 203d 207b  cluded_names = {
-00021390: 0a20 2020 2020 2020 2022 6578 6563 7574  .        "execut
-000213a0: 696e 6722 2c0a 2020 2020 2020 2020 2269  ing",.        "i
-000213b0: 6e5f 666c 6967 6874 222c 0a20 2020 2020  n_flight",.     
-000213c0: 2020 2022 696e 5f6d 656d 6f72 7922 2c0a     "in_memory",.
-000213d0: 2020 2020 2020 2020 2272 6561 6479 222c          "ready",
-000213e0: 0a20 2020 2020 2020 2022 7469 6d65 222c  .        "time",
-000213f0: 0a20 2020 2020 2020 2023 2055 7365 2073  .        # Use s
-00021400: 6368 6564 756c 6572 2e57 6f72 6b65 7253  cheduler.WorkerS
-00021410: 7461 7465 2e6d 656d 6f72 792e 6d61 6e61  tate.memory.mana
-00021420: 6765 6420 696e 7374 6561 6420 6f66 0a20  ged instead of. 
-00021430: 2020 2020 2020 2023 2073 6368 6564 756c         # schedul
-00021440: 6572 2e57 6f72 6b65 7253 7461 7465 2e6d  er.WorkerState.m
-00021450: 6574 7269 6373 5b22 6d61 6e61 6765 645f  etrics["managed_
-00021460: 6279 7465 7322 5d3b 2074 6865 2074 776f  bytes"]; the two
-00021470: 206d 6561 7375 7265 7320 6172 6520 736c   measures are sl
-00021480: 6967 6874 6c79 0a20 2020 2020 2020 2023  ightly.        #
-00021490: 2064 6966 6665 7265 6e74 2e20 5365 6520   different. See 
-000214a0: 6578 706c 616e 6174 696f 6e20 696e 2073  explanation in s
-000214b0: 6368 6564 756c 6572 2e57 6f72 6b65 7253  cheduler.WorkerS
-000214c0: 7461 7465 2e6d 656d 6f72 7928 292e 0a20  tate.memory().. 
-000214d0: 2020 2020 2020 2022 6d61 6e61 6765 645f         "managed_
-000214e0: 6279 7465 7322 2c0a 2020 2020 2020 2020  bytes",.        
-000214f0: 2273 7069 6c6c 6564 5f62 7974 6573 222c  "spilled_bytes",
-00021500: 0a20 2020 207d 0a0a 2020 2020 6465 6620  .    }..    def 
-00021510: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
-00021520: 6368 6564 756c 6572 2c20 7769 6474 683d  cheduler, width=
-00021530: 3830 302c 202a 2a6b 7761 7267 7329 3a0a  800, **kwargs):.
-00021540: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
-00021550: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
-00021560: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
-00021570: 6e61 6d65 7320 3d20 5b0a 2020 2020 2020  names = [.      
-00021580: 2020 2020 2020 226e 616d 6522 2c0a 2020        "name",.  
-00021590: 2020 2020 2020 2020 2020 2261 6464 7265            "addre
-000215a0: 7373 222c 0a20 2020 2020 2020 2020 2020  ss",.           
-000215b0: 2022 6e74 6872 6561 6473 222c 0a20 2020   "nthreads",.   
-000215c0: 2020 2020 2020 2020 2022 6370 7522 2c0a           "cpu",.
-000215d0: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
-000215e0: 6f72 7922 2c0a 2020 2020 2020 2020 2020  ory",.          
-000215f0: 2020 226d 656d 6f72 795f 6c69 6d69 7422    "memory_limit"
-00021600: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
-00021610: 656d 6f72 795f 7065 7263 656e 7422 2c0a  emory_percent",.
-00021620: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
-00021630: 6f72 795f 6d61 6e61 6765 6422 2c0a 2020  ory_managed",.  
-00021640: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-00021650: 795f 756e 6d61 6e61 6765 645f 6f6c 6422  y_unmanaged_old"
-00021660: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
-00021670: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00021680: 7265 6365 6e74 222c 0a20 2020 2020 2020  recent",.       
-00021690: 2020 2020 2022 6d65 6d6f 7279 5f73 7069       "memory_spi
-000216a0: 6c6c 6564 222c 0a20 2020 2020 2020 2020  lled",.         
-000216b0: 2020 2022 6e75 6d5f 6664 7322 2c0a 2020     "num_fds",.  
-000216c0: 2020 2020 2020 2020 2020 2268 6f73 745f            "host_
-000216d0: 6e65 745f 696f 2e72 6561 645f 6270 7322  net_io.read_bps"
-000216e0: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
-000216f0: 6f73 745f 6e65 745f 696f 2e77 7269 7465  ost_net_io.write
-00021700: 5f62 7073 222c 0a20 2020 2020 2020 2020  _bps",.         
-00021710: 2020 2022 686f 7374 5f64 6973 6b5f 696f     "host_disk_io
-00021720: 2e72 6561 645f 6270 7322 2c0a 2020 2020  .read_bps",.    
-00021730: 2020 2020 2020 2020 2268 6f73 745f 6469          "host_di
-00021740: 736b 5f69 6f2e 7772 6974 655f 6270 7322  sk_io.write_bps"
-00021750: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
-00021760: 7075 5f66 7261 6374 696f 6e22 2c0a 2020  pu_fraction",.  
-00021770: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00021780: 776f 726b 6572 7320 3d20 7365 6c66 2e73  workers = self.s
-00021790: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
-000217a0: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
-000217b0: 2020 7365 6c66 2e65 7874 7261 5f6e 616d    self.extra_nam
-000217c0: 6573 203d 2073 6f72 7465 6428 0a20 2020  es = sorted(.   
-000217d0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-000217e0: 2020 2020 2020 2020 2020 206d 0a20 2020             m.   
-000217f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00021800: 2077 7320 696e 2077 6f72 6b65 7273 0a20   ws in workers. 
-00021810: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00021820: 6f72 206d 2c20 7620 696e 2077 732e 6d65  or m, v in ws.me
-00021830: 7472 6963 732e 6974 656d 7328 290a 2020  trics.items().  
-00021840: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00021850: 206d 206e 6f74 2069 6e20 7365 6c66 2e6e   m not in self.n
-00021860: 616d 6573 2061 6e64 2069 7369 6e73 7461  ames and isinsta
-00021870: 6e63 6528 762c 2028 7374 722c 2069 6e74  nce(v, (str, int
-00021880: 2c20 666c 6f61 7429 290a 2020 2020 2020  , float)).      
-00021890: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-000218a0: 2020 2020 2d20 7365 6c66 2e65 7863 6c75      - self.exclu
-000218b0: 6465 645f 6e61 6d65 730a 2020 2020 2020  ded_names.      
-000218c0: 2020 290a 0a20 2020 2020 2020 2074 6162    )..        tab
-000218d0: 6c65 5f6e 616d 6573 203d 205b 0a20 2020  le_names = [.   
-000218e0: 2020 2020 2020 2020 2022 6e61 6d65 222c           "name",
-000218f0: 0a20 2020 2020 2020 2020 2020 2022 6164  .            "ad
-00021900: 6472 6573 7322 2c0a 2020 2020 2020 2020  dress",.        
-00021910: 2020 2020 226e 7468 7265 6164 7322 2c0a      "nthreads",.
-00021920: 2020 2020 2020 2020 2020 2020 2263 7075              "cpu
-00021930: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00021940: 6d65 6d6f 7279 222c 0a20 2020 2020 2020  memory",.       
-00021950: 2020 2020 2022 6d65 6d6f 7279 5f6c 696d       "memory_lim
-00021960: 6974 222c 0a20 2020 2020 2020 2020 2020  it",.           
-00021970: 2022 6d65 6d6f 7279 5f70 6572 6365 6e74   "memory_percent
-00021980: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00021990: 6d65 6d6f 7279 5f6d 616e 6167 6564 222c  memory_managed",
-000219a0: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-000219b0: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
-000219c0: 6c64 222c 0a20 2020 2020 2020 2020 2020  ld",.           
-000219d0: 2022 6d65 6d6f 7279 5f75 6e6d 616e 6167   "memory_unmanag
-000219e0: 6564 5f72 6563 656e 7422 2c0a 2020 2020  ed_recent",.    
-000219f0: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
-00021a00: 7370 696c 6c65 6422 2c0a 2020 2020 2020  spilled",.      
-00021a10: 2020 2020 2020 226e 756d 5f66 6473 222c        "num_fds",
-00021a20: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
-00021a30: 7374 5f6e 6574 5f69 6f2e 7265 6164 5f62  st_net_io.read_b
-00021a40: 7073 222c 0a20 2020 2020 2020 2020 2020  ps",.           
-00021a50: 2022 686f 7374 5f6e 6574 5f69 6f2e 7772   "host_net_io.wr
-00021a60: 6974 655f 6270 7322 2c0a 2020 2020 2020  ite_bps",.      
-00021a70: 2020 2020 2020 2268 6f73 745f 6469 736b        "host_disk
-00021a80: 5f69 6f2e 7265 6164 5f62 7073 222c 0a20  _io.read_bps",. 
-00021a90: 2020 2020 2020 2020 2020 2022 686f 7374             "host
-00021aa0: 5f64 6973 6b5f 696f 2e77 7269 7465 5f62  _disk_io.write_b
-00021ab0: 7073 222c 0a20 2020 2020 2020 205d 0a20  ps",.        ]. 
-00021ac0: 2020 2020 2020 2063 6f6c 756d 6e5f 7469         column_ti
-00021ad0: 746c 655f 7265 6e61 6d65 7320 3d20 7b0a  tle_renames = {.
-00021ae0: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
-00021af0: 6f72 795f 6c69 6d69 7422 3a20 226c 696d  ory_limit": "lim
-00021b00: 6974 222c 0a20 2020 2020 2020 2020 2020  it",.           
-00021b10: 2022 6d65 6d6f 7279 5f70 6572 6365 6e74   "memory_percent
-00021b20: 223a 2022 6d65 6d6f 7279 2025 222c 0a20  ": "memory %",. 
-00021b30: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
-00021b40: 7279 5f6d 616e 6167 6564 223a 2022 6d61  ry_managed": "ma
-00021b50: 6e61 6765 6422 2c0a 2020 2020 2020 2020  naged",.        
-00021b60: 2020 2020 226d 656d 6f72 795f 756e 6d61      "memory_unma
-00021b70: 6e61 6765 645f 6f6c 6422 3a20 2275 6e6d  naged_old": "unm
-00021b80: 616e 6167 6564 206f 6c64 222c 0a20 2020  anaged old",.   
-00021b90: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
-00021ba0: 5f75 6e6d 616e 6167 6564 5f72 6563 656e  _unmanaged_recen
-00021bb0: 7422 3a20 2275 6e6d 616e 6167 6564 2072  t": "unmanaged r
-00021bc0: 6563 656e 7422 2c0a 2020 2020 2020 2020  ecent",.        
-00021bd0: 2020 2020 226d 656d 6f72 795f 7370 696c      "memory_spil
-00021be0: 6c65 6422 3a20 2273 7069 6c6c 6564 222c  led": "spilled",
-00021bf0: 0a20 2020 2020 2020 2020 2020 2022 6e75  .            "nu
-00021c00: 6d5f 6664 7322 3a20 2223 2066 6473 222c  m_fds": "# fds",
-00021c10: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
-00021c20: 7374 5f6e 6574 5f69 6f2e 7265 6164 5f62  st_net_io.read_b
-00021c30: 7073 223a 2022 6e65 7420 7265 6164 222c  ps": "net read",
-00021c40: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
-00021c50: 7374 5f6e 6574 5f69 6f2e 7772 6974 655f  st_net_io.write_
-00021c60: 6270 7322 3a20 226e 6574 2077 7269 7465  bps": "net write
-00021c70: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
-00021c80: 686f 7374 5f64 6973 6b5f 696f 2e72 6561  host_disk_io.rea
-00021c90: 645f 6270 7322 3a20 2264 6973 6b20 7265  d_bps": "disk re
-00021ca0: 6164 222c 0a20 2020 2020 2020 2020 2020  ad",.           
-00021cb0: 2022 686f 7374 5f64 6973 6b5f 696f 2e77   "host_disk_io.w
-00021cc0: 7269 7465 5f62 7073 223a 2022 6469 736b  rite_bps": "disk
-00021cd0: 2077 7269 7465 222c 0a20 2020 2020 2020   write",.       
-00021ce0: 207d 0a0a 2020 2020 2020 2020 7365 6c66   }..        self
-00021cf0: 2e73 6f75 7263 6520 3d20 436f 6c75 6d6e  .source = Column
-00021d00: 4461 7461 536f 7572 6365 287b 6b3a 205b  DataSource({k: [
-00021d10: 5d20 666f 7220 6b20 696e 2073 656c 662e  ] for k in self.
-00021d20: 6e61 6d65 737d 290a 0a20 2020 2020 2020  names})..       
-00021d30: 2063 6f6c 756d 6e73 203d 207b 0a20 2020   columns = {.   
-00021d40: 2020 2020 2020 2020 206e 616d 653a 2054           name: T
-00021d50: 6162 6c65 436f 6c75 6d6e 2866 6965 6c64  ableColumn(field
-00021d60: 3d6e 616d 652c 2074 6974 6c65 3d63 6f6c  =name, title=col
-00021d70: 756d 6e5f 7469 746c 655f 7265 6e61 6d65  umn_title_rename
-00021d80: 732e 6765 7428 6e61 6d65 2c20 6e61 6d65  s.get(name, name
-00021d90: 2929 0a20 2020 2020 2020 2020 2020 2066  )).            f
-00021da0: 6f72 206e 616d 6520 696e 2074 6162 6c65  or name in table
-00021db0: 5f6e 616d 6573 0a20 2020 2020 2020 207d  _names.        }
-00021dc0: 0a0a 2020 2020 2020 2020 666f 726d 6174  ..        format
-00021dd0: 7465 7273 203d 207b 0a20 2020 2020 2020  ters = {.       
-00021de0: 2020 2020 2022 6370 7522 3a20 4e75 6d62       "cpu": Numb
-00021df0: 6572 466f 726d 6174 7465 7228 666f 726d  erFormatter(form
-00021e00: 6174 3d22 3020 2522 292c 0a20 2020 2020  at="0 %"),.     
-00021e10: 2020 2020 2020 2022 6d65 6d6f 7279 5f70         "memory_p
-00021e20: 6572 6365 6e74 223a 204e 756d 6265 7246  ercent": NumberF
-00021e30: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
-00021e40: 2230 2e30 2025 2229 2c0a 2020 2020 2020  "0.0 %"),.      
-00021e50: 2020 2020 2020 226d 656d 6f72 7922 3a20        "memory": 
-00021e60: 4e75 6d62 6572 466f 726d 6174 7465 7228  NumberFormatter(
-00021e70: 666f 726d 6174 3d22 302e 3020 6222 292c  format="0.0 b"),
-00021e80: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-00021e90: 6d6f 7279 5f6c 696d 6974 223a 204e 756d  mory_limit": Num
-00021ea0: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
-00021eb0: 6d61 743d 2230 2e30 2062 2229 2c0a 2020  mat="0.0 b"),.  
-00021ec0: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
-00021ed0: 795f 6d61 6e61 6765 6422 3a20 4e75 6d62  y_managed": Numb
-00021ee0: 6572 466f 726d 6174 7465 7228 666f 726d  erFormatter(form
-00021ef0: 6174 3d22 302e 3020 6222 292c 0a20 2020  at="0.0 b"),.   
-00021f00: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
-00021f10: 5f75 6e6d 616e 6167 6564 5f6f 6c64 223a  _unmanaged_old":
-00021f20: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
-00021f30: 2866 6f72 6d61 743d 2230 2e30 2062 2229  (format="0.0 b")
-00021f40: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
-00021f50: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00021f60: 7265 6365 6e74 223a 204e 756d 6265 7246  recent": NumberF
-00021f70: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
-00021f80: 2230 2e30 2062 2229 2c0a 2020 2020 2020  "0.0 b"),.      
-00021f90: 2020 2020 2020 226d 656d 6f72 795f 7370        "memory_sp
-00021fa0: 696c 6c65 6422 3a20 4e75 6d62 6572 466f  illed": NumberFo
-00021fb0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
-00021fc0: 302e 3020 6222 292c 0a20 2020 2020 2020  0.0 b"),.       
-00021fd0: 2020 2020 2022 686f 7374 5f6e 6574 5f69       "host_net_i
-00021fe0: 6f2e 7265 6164 5f62 7073 223a 204e 756d  o.read_bps": Num
-00021ff0: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
-00022000: 6d61 743d 2230 2062 2229 2c0a 2020 2020  mat="0 b"),.    
-00022010: 2020 2020 2020 2020 2268 6f73 745f 6e65          "host_ne
-00022020: 745f 696f 2e77 7269 7465 5f62 7073 223a  t_io.write_bps":
-00022030: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
-00022040: 2866 6f72 6d61 743d 2230 2062 2229 2c0a  (format="0 b"),.
-00022050: 2020 2020 2020 2020 2020 2020 226e 756d              "num
-00022060: 5f66 6473 223a 204e 756d 6265 7246 6f72  _fds": NumberFor
-00022070: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
-00022080: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
-00022090: 226e 7468 7265 6164 7322 3a20 4e75 6d62  "nthreads": Numb
-000220a0: 6572 466f 726d 6174 7465 7228 666f 726d  erFormatter(form
-000220b0: 6174 3d22 3022 292c 0a20 2020 2020 2020  at="0"),.       
-000220c0: 2020 2020 2022 686f 7374 5f64 6973 6b5f       "host_disk_
-000220d0: 696f 2e72 6561 645f 6270 7322 3a20 4e75  io.read_bps": Nu
-000220e0: 6d62 6572 466f 726d 6174 7465 7228 666f  mberFormatter(fo
-000220f0: 726d 6174 3d22 3020 6222 292c 0a20 2020  rmat="0 b"),.   
-00022100: 2020 2020 2020 2020 2022 686f 7374 5f64           "host_d
-00022110: 6973 6b5f 696f 2e77 7269 7465 5f62 7073  isk_io.write_bps
-00022120: 223a 204e 756d 6265 7246 6f72 6d61 7474  ": NumberFormatt
-00022130: 6572 2866 6f72 6d61 743d 2230 2062 2229  er(format="0 b")
-00022140: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
-00022150: 2020 2020 2074 6162 6c65 203d 2044 6174       table = Dat
-00022160: 6154 6162 6c65 280a 2020 2020 2020 2020  aTable(.        
-00022170: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
-00022180: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
-00022190: 2020 2020 636f 6c75 6d6e 733d 5b63 6f6c      columns=[col
-000221a0: 756d 6e73 5b6e 5d20 666f 7220 6e20 696e  umns[n] for n in
-000221b0: 2074 6162 6c65 5f6e 616d 6573 5d2c 0a20   table_names],. 
-000221c0: 2020 2020 2020 2020 2020 2072 656f 7264             reord
-000221d0: 6572 6162 6c65 3d54 7275 652c 0a20 2020  erable=True,.   
-000221e0: 2020 2020 2020 2020 2073 6f72 7461 626c           sortabl
-000221f0: 653d 5472 7565 2c0a 2020 2020 2020 2020  e=True,.        
-00022200: 2020 2020 7769 6474 683d 7769 6474 682c      width=width,
-00022210: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
-00022220: 6578 5f70 6f73 6974 696f 6e3d 4e6f 6e65  ex_position=None
-00022230: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-00022240: 5f44 4154 4154 4142 4c45 5f53 5459 4c45  _DATATABLE_STYLE
-00022250: 5348 4545 5453 5f4b 5741 5247 532c 0a20  SHEETS_KWARGS,. 
-00022260: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00022270: 2020 666f 7220 6e61 6d65 2069 6e20 7461    for name in ta
-00022280: 626c 655f 6e61 6d65 733a 0a20 2020 2020  ble_names:.     
-00022290: 2020 2020 2020 2069 6620 6e61 6d65 2069         if name i
-000222a0: 6e20 666f 726d 6174 7465 7273 3a0a 2020  n formatters:.  
-000222b0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
-000222c0: 626c 652e 636f 6c75 6d6e 735b 7461 626c  ble.columns[tabl
-000222d0: 655f 6e61 6d65 732e 696e 6465 7828 6e61  e_names.index(na
-000222e0: 6d65 295d 2e66 6f72 6d61 7474 6572 203d  me)].formatter =
-000222f0: 2066 6f72 6d61 7474 6572 735b 6e61 6d65   formatters[name
-00022300: 5d0a 0a20 2020 2020 2020 2065 7874 7261  ]..        extra
-00022310: 5f6e 616d 6573 203d 205b 226e 616d 6522  _names = ["name"
-00022320: 2c20 2261 6464 7265 7373 225d 202b 2073  , "address"] + s
-00022330: 656c 662e 6578 7472 615f 6e61 6d65 730a  elf.extra_names.
-00022340: 2020 2020 2020 2020 6578 7472 615f 636f          extra_co
-00022350: 6c75 6d6e 7320 3d20 7b0a 2020 2020 2020  lumns = {.      
-00022360: 2020 2020 2020 6e61 6d65 3a20 5461 626c        name: Tabl
-00022370: 6543 6f6c 756d 6e28 6669 656c 643d 6e61  eColumn(field=na
-00022380: 6d65 2c20 7469 746c 653d 636f 6c75 6d6e  me, title=column
-00022390: 5f74 6974 6c65 5f72 656e 616d 6573 2e67  _title_renames.g
-000223a0: 6574 286e 616d 652c 206e 616d 6529 290a  et(name, name)).
-000223b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-000223c0: 6e61 6d65 2069 6e20 6578 7472 615f 6e61  name in extra_na
-000223d0: 6d65 730a 2020 2020 2020 2020 7d0a 0a20  mes.        }.. 
-000223e0: 2020 2020 2020 2065 7874 7261 5f74 6162         extra_tab
-000223f0: 6c65 203d 2044 6174 6154 6162 6c65 280a  le = DataTable(.
-00022400: 2020 2020 2020 2020 2020 2020 736f 7572              sour
-00022410: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
-00022420: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
-00022430: 6d6e 733d 5b65 7874 7261 5f63 6f6c 756d  mns=[extra_colum
-00022440: 6e73 5b6e 5d20 666f 7220 6e20 696e 2065  ns[n] for n in e
-00022450: 7874 7261 5f6e 616d 6573 5d2c 0a20 2020  xtra_names],.   
-00022460: 2020 2020 2020 2020 2072 656f 7264 6572           reorder
-00022470: 6162 6c65 3d54 7275 652c 0a20 2020 2020  able=True,.     
-00022480: 2020 2020 2020 2073 6f72 7461 626c 653d         sortable=
-00022490: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-000224a0: 2020 7769 6474 683d 7769 6474 682c 0a20    width=width,. 
-000224b0: 2020 2020 2020 2020 2020 2069 6e64 6578             index
-000224c0: 5f70 6f73 6974 696f 6e3d 4e6f 6e65 2c0a  _position=None,.
-000224d0: 2020 2020 2020 2020 2020 2020 2a2a 5f44              **_D
-000224e0: 4154 4154 4142 4c45 5f53 5459 4c45 5348  ATATABLE_STYLESH
-000224f0: 4545 5453 5f4b 5741 5247 532c 0a20 2020  EETS_KWARGS,.   
-00022500: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00022510: 666f 7220 6e61 6d65 2069 6e20 6578 7472  for name in extr
-00022520: 615f 6e61 6d65 733a 0a20 2020 2020 2020  a_names:.       
-00022530: 2020 2020 2069 6620 6e61 6d65 2069 6e20       if name in 
-00022540: 666f 726d 6174 7465 7273 3a0a 2020 2020  formatters:.    
-00022550: 2020 2020 2020 2020 2020 2020 6578 7472              extr
-00022560: 615f 7461 626c 652e 636f 6c75 6d6e 735b  a_table.columns[
-00022570: 6578 7472 615f 6e61 6d65 732e 696e 6465  extra_names.inde
-00022580: 7828 6e61 6d65 295d 2e66 6f72 6d61 7474  x(name)].formatt
-00022590: 6572 203d 2066 6f72 6d61 7474 6572 735b  er = formatters[
-000225a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000225b0: 2020 2020 206e 616d 650a 2020 2020 2020       name.      
-000225c0: 2020 2020 2020 2020 2020 5d0a 0a20 2020            ]..   
-000225d0: 2020 2020 2068 6f76 6572 203d 2048 6f76       hover = Hov
-000225e0: 6572 546f 6f6c 280a 2020 2020 2020 2020  erTool(.        
-000225f0: 2020 2020 706f 696e 745f 706f 6c69 6379      point_policy
-00022600: 3d22 666f 6c6c 6f77 5f6d 6f75 7365 222c  ="follow_mouse",
-00022610: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
-00022620: 6c74 6970 733d 2222 220a 2020 2020 2020  ltips=""".      
-00022630: 2020 2020 2020 2020 2020 3c64 6976 3e0a            <div>.
-00022640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022650: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
-00022660: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
-00022670: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
-00022680: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
-00022690: 3e57 6f72 6b65 7220 2840 6e61 6d65 293a  >Worker (@name):
-000226a0: 203c 2f73 7061 6e3e 0a20 2020 2020 2020   </span>.       
-000226b0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
-000226c0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
-000226d0: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
-000226e0: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
-000226f0: 6e6f 7370 6163 653b 223e 406d 656d 6f72  nospace;">@memor
-00022700: 795f 7065 7263 656e 747b 302e 3020 257d  y_percent{0.0 %}
-00022710: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
-00022720: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
-00022730: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00022740: 2222 2c0a 2020 2020 2020 2020 290a 0a20  "",.        ).. 
-00022750: 2020 2020 2020 206d 656d 5f70 6c6f 7420         mem_plot 
-00022760: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
-00022770: 2020 2020 2020 7469 746c 653d 224d 656d        title="Mem
-00022780: 6f72 7920 5573 6520 2825 2922 2c0a 2020  ory Use (%)",.  
-00022790: 2020 2020 2020 2020 2020 746f 6f6c 6261            toolba
-000227a0: 725f 6c6f 6361 7469 6f6e 3d4e 6f6e 652c  r_location=None,
-000227b0: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
-000227c0: 616e 6765 3d28 302c 2031 292c 0a20 2020  ange=(0, 1),.   
-000227d0: 2020 2020 2020 2020 2079 5f72 616e 6765           y_range
-000227e0: 3d28 2d30 2e31 2c20 302e 3129 2c0a 2020  =(-0.1, 0.1),.  
-000227f0: 2020 2020 2020 2020 2020 6865 6967 6874            height
-00022800: 3d36 302c 0a20 2020 2020 2020 2020 2020  =60,.           
-00022810: 2077 6964 7468 3d77 6964 7468 2c0a 2020   width=width,.  
-00022820: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
-00022830: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
-00022840: 6d69 6e5f 626f 7264 6572 5f72 6967 6874  min_border_right
-00022850: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
-00022860: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
-00022870: 2020 290a 2020 2020 2020 2020 6d65 6d5f    ).        mem_
-00022880: 706c 6f74 2e63 6972 636c 6528 0a20 2020  plot.circle(.   
-00022890: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-000228a0: 7365 6c66 2e73 6f75 7263 652c 2078 3d22  self.source, x="
-000228b0: 6d65 6d6f 7279 5f70 6572 6365 6e74 222c  memory_percent",
-000228c0: 2079 3d30 2c20 7369 7a65 3d31 302c 2066   y=0, size=10, f
-000228d0: 696c 6c5f 616c 7068 613d 302e 350a 2020  ill_alpha=0.5.  
-000228e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000228f0: 6d65 6d5f 706c 6f74 2e79 6772 6964 2e76  mem_plot.ygrid.v
-00022900: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
-00022910: 2020 2020 2020 206d 656d 5f70 6c6f 742e         mem_plot.
-00022920: 7961 7869 732e 6d69 6e6f 725f 7469 636b  yaxis.minor_tick
-00022930: 5f6c 696e 655f 616c 7068 6120 3d20 300a  _line_alpha = 0.
-00022940: 2020 2020 2020 2020 6d65 6d5f 706c 6f74          mem_plot
-00022950: 2e78 6178 6973 2e76 6973 6962 6c65 203d  .xaxis.visible =
-00022960: 2046 616c 7365 0a20 2020 2020 2020 206d   False.        m
-00022970: 656d 5f70 6c6f 742e 7961 7869 732e 7669  em_plot.yaxis.vi
-00022980: 7369 626c 6520 3d20 4661 6c73 650a 2020  sible = False.  
-00022990: 2020 2020 2020 6d65 6d5f 706c 6f74 2e61        mem_plot.a
-000229a0: 6464 5f74 6f6f 6c73 2868 6f76 6572 2c20  dd_tools(hover, 
-000229b0: 426f 7853 656c 6563 7454 6f6f 6c28 2929  BoxSelectTool())
-000229c0: 0a0a 2020 2020 2020 2020 686f 7665 7220  ..        hover 
-000229d0: 3d20 486f 7665 7254 6f6f 6c28 0a20 2020  = HoverTool(.   
-000229e0: 2020 2020 2020 2020 2070 6f69 6e74 5f70           point_p
-000229f0: 6f6c 6963 793d 2266 6f6c 6c6f 775f 6d6f  olicy="follow_mo
-00022a00: 7573 6522 2c0a 2020 2020 2020 2020 2020  use",.          
-00022a10: 2020 746f 6f6c 7469 7073 3d22 2222 0a20    tooltips=""". 
-00022a20: 2020 2020 2020 2020 2020 2020 2020 203c                 <
-00022a30: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
-00022a40: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
-00022a50: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
-00022a60: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
-00022a70: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
-00022a80: 6163 653b 223e 576f 726b 6572 2028 406e  ace;">Worker (@n
-00022a90: 616d 6529 3a20 3c2f 7370 616e 3e0a 2020  ame): </span>.  
-00022aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022ab0: 3c73 7061 6e20 7374 796c 653d 2266 6f6e  <span style="fon
-00022ac0: 742d 7369 7a65 3a20 3130 7078 3b20 666f  t-size: 10px; fo
-00022ad0: 6e74 2d66 616d 696c 793a 204d 6f6e 6163  nt-family: Monac
-00022ae0: 6f2c 206d 6f6e 6f73 7061 6365 3b22 3e40  o, monospace;">@
-00022af0: 6370 755f 6672 6163 7469 6f6e 7b30 2025  cpu_fraction{0 %
-00022b00: 7d3c 2f73 7061 6e3e 0a20 2020 2020 2020  }</span>.       
-00022b10: 2020 2020 2020 2020 203c 2f64 6976 3e0a           </div>.
-00022b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022b30: 2222 222c 0a20 2020 2020 2020 2029 0a0a  """,.        )..
-00022b40: 2020 2020 2020 2020 6370 755f 706c 6f74          cpu_plot
-00022b50: 203d 2066 6967 7572 6528 0a20 2020 2020   = figure(.     
-00022b60: 2020 2020 2020 2074 6974 6c65 3d22 4350         title="CP
-00022b70: 5520 5573 6520 2825 2922 2c0a 2020 2020  U Use (%)",.    
-00022b80: 2020 2020 2020 2020 746f 6f6c 6261 725f          toolbar_
-00022b90: 6c6f 6361 7469 6f6e 3d4e 6f6e 652c 0a20  location=None,. 
-00022ba0: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
-00022bb0: 6765 3d28 302c 2031 292c 0a20 2020 2020  ge=(0, 1),.     
-00022bc0: 2020 2020 2020 2079 5f72 616e 6765 3d28         y_range=(
-00022bd0: 2d30 2e31 2c20 302e 3129 2c0a 2020 2020  -0.1, 0.1),.    
-00022be0: 2020 2020 2020 2020 6865 6967 6874 3d36          height=6
-00022bf0: 302c 0a20 2020 2020 2020 2020 2020 2077  0,.            w
-00022c00: 6964 7468 3d77 6964 7468 2c0a 2020 2020  idth=width,.    
-00022c10: 2020 2020 2020 2020 746f 6f6c 733d 2222          tools=""
-00022c20: 2c0a 2020 2020 2020 2020 2020 2020 6d69  ,.            mi
-00022c30: 6e5f 626f 7264 6572 5f72 6967 6874 3d30  n_border_right=0
-00022c40: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
-00022c50: 6b77 6172 6773 2c0a 2020 2020 2020 2020  kwargs,.        
-00022c60: 290a 2020 2020 2020 2020 6370 755f 706c  ).        cpu_pl
-00022c70: 6f74 2e63 6972 636c 6528 0a20 2020 2020  ot.circle(.     
-00022c80: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
-00022c90: 6c66 2e73 6f75 7263 652c 2078 3d22 6370  lf.source, x="cp
-00022ca0: 755f 6672 6163 7469 6f6e 222c 2079 3d30  u_fraction", y=0
-00022cb0: 2c20 7369 7a65 3d31 302c 2066 696c 6c5f  , size=10, fill_
-00022cc0: 616c 7068 613d 302e 350a 2020 2020 2020  alpha=0.5.      
-00022cd0: 2020 290a 2020 2020 2020 2020 6370 755f    ).        cpu_
-00022ce0: 706c 6f74 2e79 6772 6964 2e76 6973 6962  plot.ygrid.visib
-00022cf0: 6c65 203d 2046 616c 7365 0a20 2020 2020  le = False.     
-00022d00: 2020 2063 7075 5f70 6c6f 742e 7961 7869     cpu_plot.yaxi
-00022d10: 732e 6d69 6e6f 725f 7469 636b 5f6c 696e  s.minor_tick_lin
-00022d20: 655f 616c 7068 6120 3d20 300a 2020 2020  e_alpha = 0.    
-00022d30: 2020 2020 6370 755f 706c 6f74 2e78 6178      cpu_plot.xax
-00022d40: 6973 2e76 6973 6962 6c65 203d 2046 616c  is.visible = Fal
-00022d50: 7365 0a20 2020 2020 2020 2063 7075 5f70  se.        cpu_p
-00022d60: 6c6f 742e 7961 7869 732e 7669 7369 626c  lot.yaxis.visibl
-00022d70: 6520 3d20 4661 6c73 650a 2020 2020 2020  e = False.      
-00022d80: 2020 6370 755f 706c 6f74 2e61 6464 5f74    cpu_plot.add_t
-00022d90: 6f6f 6c73 2868 6f76 6572 2c20 426f 7853  ools(hover, BoxS
-00022da0: 656c 6563 7454 6f6f 6c28 2929 0a20 2020  electTool()).   
-00022db0: 2020 2020 2073 656c 662e 6370 755f 706c       self.cpu_pl
-00022dc0: 6f74 203d 2063 7075 5f70 6c6f 740a 0a20  ot = cpu_plot.. 
-00022dd0: 2020 2020 2020 2069 6620 2273 697a 696e         if "sizin
-00022de0: 675f 6d6f 6465 2220 696e 206b 7761 7267  g_mode" in kwarg
-00022df0: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-00022e00: 697a 696e 675f 6d6f 6465 203d 207b 2273  izing_mode = {"s
-00022e10: 697a 696e 675f 6d6f 6465 223a 206b 7761  izing_mode": kwa
-00022e20: 7267 735b 2273 697a 696e 675f 6d6f 6465  rgs["sizing_mode
-00022e30: 225d 7d0a 2020 2020 2020 2020 656c 7365  "]}.        else
-00022e40: 3a0a 2020 2020 2020 2020 2020 2020 7369  :.            si
-00022e50: 7a69 6e67 5f6d 6f64 6520 3d20 7b7d 0a0a  zing_mode = {}..
-00022e60: 2020 2020 2020 2020 636f 6d70 6f6e 656e          componen
-00022e70: 7473 203d 205b 6370 755f 706c 6f74 2c20  ts = [cpu_plot, 
-00022e80: 6d65 6d5f 706c 6f74 2c20 7461 626c 655d  mem_plot, table]
-00022e90: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00022ea0: 2e65 7874 7261 5f6e 616d 6573 3a0a 2020  .extra_names:.  
-00022eb0: 2020 2020 2020 2020 2020 636f 6d70 6f6e            compon
-00022ec0: 656e 7473 2e61 7070 656e 6428 6578 7472  ents.append(extr
-00022ed0: 615f 7461 626c 6529 0a0a 2020 2020 2020  a_table)..      
-00022ee0: 2020 7365 6c66 2e72 6f6f 7420 3d20 636f    self.root = co
-00022ef0: 6c75 6d6e 282a 636f 6d70 6f6e 656e 7473  lumn(*components
-00022f00: 2c20 2a2a 7369 7a69 6e67 5f6d 6f64 6529  , **sizing_mode)
-00022f10: 0a0a 2020 2020 4077 6974 686f 7574 5f70  ..    @without_p
-00022f20: 726f 7065 7274 795f 7661 6c69 6461 7469  roperty_validati
-00022f30: 6f6e 0a20 2020 2064 6566 2075 7064 6174  on.    def updat
-00022f40: 6528 7365 6c66 293a 0a20 2020 2020 2020  e(self):.       
-00022f50: 2064 6174 6120 3d20 7b6e 616d 653a 205b   data = {name: [
-00022f60: 5d20 666f 7220 6e61 6d65 2069 6e20 7365  ] for name in se
-00022f70: 6c66 2e6e 616d 6573 202b 2073 656c 662e  lf.names + self.
-00022f80: 6578 7472 615f 6e61 6d65 737d 0a20 2020  extra_names}.   
-00022f90: 2020 2020 2066 6f72 2069 2c20 7773 2069       for i, ws i
-00022fa0: 6e20 656e 756d 6572 6174 6528 0a20 2020  n enumerate(.   
-00022fb0: 2020 2020 2020 2020 2073 6f72 7465 6428           sorted(
-00022fc0: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
-00022fd0: 6f72 6b65 7273 2e76 616c 7565 7328 292c  orkers.values(),
-00022fe0: 206b 6579 3d6c 616d 6264 6120 7773 3a20   key=lambda ws: 
-00022ff0: 7374 7228 7773 2e6e 616d 6529 290a 2020  str(ws.name)).  
-00023000: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
-00023010: 2020 2020 206d 696e 666f 203d 2077 732e       minfo = ws.
-00023020: 6d65 6d6f 7279 0a0a 2020 2020 2020 2020  memory..        
-00023030: 2020 2020 666f 7220 6e61 6d65 2069 6e20      for name in 
-00023040: 7365 6c66 2e6e 616d 6573 202b 2073 656c  self.names + sel
-00023050: 662e 6578 7472 615f 6e61 6d65 733a 0a20  f.extra_names:. 
-00023060: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00023070: 6620 222e 2220 696e 206e 616d 653a 0a20  f "." in name:. 
-00023080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023090: 2020 206e 302c 205f 2c20 6e31 203d 206e     n0, _, n1 = n
-000230a0: 616d 652e 7061 7274 6974 696f 6e28 222e  ame.partition(".
-000230b0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
-000230c0: 2020 2020 2020 2076 203d 2077 732e 6d65         v = ws.me
-000230d0: 7472 6963 732e 6765 7428 6e30 2c20 7b7d  trics.get(n0, {}
-000230e0: 292e 6765 7428 6e31 2c20 4e6f 6e65 290a  ).get(n1, None).
-000230f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023100: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00023110: 2020 2020 2020 2020 2020 7620 3d20 7773            v = ws
-00023120: 2e6d 6574 7269 6373 2e67 6574 286e 616d  .metrics.get(nam
-00023130: 652c 204e 6f6e 6529 0a20 2020 2020 2020  e, None).       
-00023140: 2020 2020 2020 2020 2064 6174 615b 6e61           data[na
-00023150: 6d65 5d2e 6170 7065 6e64 2876 290a 0a20  me].append(v).. 
+0001a2a0: 2020 6c69 6e65 5f63 6f6c 6f72 3d22 636f    line_color="co
+0001a2b0: 6c6f 7222 2c0a 2020 2020 2020 2020 2020  lor",.          
+0001a2c0: 2020 6669 6c6c 5f61 6c70 6861 3d31 2e30    fill_alpha=1.0
+0001a2d0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+0001a2e0: 2020 2020 7365 6c66 2e72 6f6f 742e 7175      self.root.qu
+0001a2f0: 6164 280a 2020 2020 2020 2020 2020 2020  ad(.            
+0001a300: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
+0001a310: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0001a320: 746f 703d 2274 6f70 222c 0a20 2020 2020  top="top",.     
+0001a330: 2020 2020 2020 2062 6f74 746f 6d3d 2262         bottom="b
+0001a340: 6f74 746f 6d22 2c0a 2020 2020 2020 2020  ottom",.        
+0001a350: 2020 2020 6c65 6674 3d22 6d65 6d6f 7279      left="memory
+0001a360: 2d6c 6f63 222c 0a20 2020 2020 2020 2020  -loc",.         
+0001a370: 2020 2072 6967 6874 3d22 6572 7265 642d     right="erred-
+0001a380: 6c6f 6322 2c0a 2020 2020 2020 2020 2020  loc",.          
+0001a390: 2020 6669 6c6c 5f63 6f6c 6f72 3d22 626c    fill_color="bl
+0001a3a0: 6163 6b22 2c0a 2020 2020 2020 2020 2020  ack",.          
+0001a3b0: 2020 6669 6c6c 5f61 6c70 6861 3d30 2e35    fill_alpha=0.5
+0001a3c0: 2c0a 2020 2020 2020 2020 2020 2020 6c69  ,.            li
+0001a3d0: 6e65 5f61 6c70 6861 3d30 2c0a 2020 2020  ne_alpha=0,.    
+0001a3e0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+0001a3f0: 6c66 2e72 6f6f 742e 7175 6164 280a 2020  lf.root.quad(.  
+0001a400: 2020 2020 2020 2020 2020 736f 7572 6365            source
+0001a410: 3d73 656c 662e 736f 7572 6365 2c0a 2020  =self.source,.  
+0001a420: 2020 2020 2020 2020 2020 746f 703d 2274            top="t
+0001a430: 6f70 222c 0a20 2020 2020 2020 2020 2020  op",.           
+0001a440: 2062 6f74 746f 6d3d 2262 6f74 746f 6d22   bottom="bottom"
+0001a450: 2c0a 2020 2020 2020 2020 2020 2020 6c65  ,.            le
+0001a460: 6674 3d22 6572 7265 642d 6c6f 6322 2c0a  ft="erred-loc",.
+0001a470: 2020 2020 2020 2020 2020 2020 7269 6768              righ
+0001a480: 743d 2270 726f 6365 7373 696e 672d 6c6f  t="processing-lo
+0001a490: 6322 2c0a 2020 2020 2020 2020 2020 2020  c",.            
+0001a4a0: 6669 6c6c 5f63 6f6c 6f72 3d22 6772 6179  fill_color="gray
+0001a4b0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+0001a4c0: 696c 6c5f 616c 7068 613d 302e 3335 2c0a  ill_alpha=0.35,.
+0001a4d0: 2020 2020 2020 2020 2020 2020 6c69 6e65              line
+0001a4e0: 5f61 6c70 6861 3d30 2c0a 2020 2020 2020  _alpha=0,.      
+0001a4f0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+0001a500: 2e72 6f6f 742e 7175 6164 280a 2020 2020  .root.quad(.    
+0001a510: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+0001a520: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
+0001a530: 2020 2020 2020 2020 746f 703d 2274 6f70          top="top
+0001a540: 222c 0a20 2020 2020 2020 2020 2020 2062  ",.            b
+0001a550: 6f74 746f 6d3d 2262 6f74 746f 6d22 2c0a  ottom="bottom",.
+0001a560: 2020 2020 2020 2020 2020 2020 6c65 6674              left
+0001a570: 3d22 7072 6f63 6573 7369 6e67 2d6c 6f63  ="processing-loc
+0001a580: 222c 0a20 2020 2020 2020 2020 2020 2072  ",.            r
+0001a590: 6967 6874 3d22 7175 6575 6564 2d6c 6f63  ight="queued-loc
+0001a5a0: 222c 0a20 2020 2020 2020 2020 2020 2066  ",.            f
+0001a5b0: 696c 6c5f 636f 6c6f 723d 2267 7261 7922  ill_color="gray"
+0001a5c0: 2c0a 2020 2020 2020 2020 2020 2020 6861  ,.            ha
+0001a5d0: 7463 685f 7061 7474 6572 6e3d 222f 222c  tch_pattern="/",
+0001a5e0: 0a20 2020 2020 2020 2020 2020 2068 6174  .            hat
+0001a5f0: 6368 5f63 6f6c 6f72 3d22 7768 6974 6522  ch_color="white"
+0001a600: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
+0001a610: 6c6c 5f61 6c70 6861 3d30 2e33 352c 0a20  ll_alpha=0.35,. 
+0001a620: 2020 2020 2020 2020 2020 206c 696e 655f             line_
+0001a630: 616c 7068 613d 302c 0a20 2020 2020 2020  alpha=0,.       
+0001a640: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
+0001a650: 726f 6f74 2e71 7561 6428 0a20 2020 2020  root.quad(.     
+0001a660: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+0001a670: 6c66 2e73 6f75 7263 652c 0a20 2020 2020  lf.source,.     
+0001a680: 2020 2020 2020 2074 6f70 3d22 746f 7022         top="top"
+0001a690: 2c0a 2020 2020 2020 2020 2020 2020 626f  ,.            bo
+0001a6a0: 7474 6f6d 3d22 626f 7474 6f6d 222c 0a20  ttom="bottom",. 
+0001a6b0: 2020 2020 2020 2020 2020 206c 6566 743d             left=
+0001a6c0: 2271 7565 7565 642d 6c6f 6322 2c0a 2020  "queued-loc",.  
+0001a6d0: 2020 2020 2020 2020 2020 7269 6768 743d            right=
+0001a6e0: 226e 6f2d 776f 726b 6572 2d6c 6f63 222c  "no-worker-loc",
+0001a6f0: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+0001a700: 6c5f 636f 6c6f 723d 2272 6564 222c 0a20  l_color="red",. 
+0001a710: 2020 2020 2020 2020 2020 2068 6174 6368             hatch
+0001a720: 5f70 6174 7465 726e 3d22 2f22 2c0a 2020  _pattern="/",.  
+0001a730: 2020 2020 2020 2020 2020 6861 7463 685f            hatch_
+0001a740: 636f 6c6f 723d 2262 6c61 636b 222c 0a20  color="black",. 
+0001a750: 2020 2020 2020 2020 2020 2066 696c 6c5f             fill_
+0001a760: 616c 7068 613d 302e 3335 2c0a 2020 2020  alpha=0.35,.    
+0001a770: 2020 2020 2020 2020 6c69 6e65 5f61 6c70          line_alp
+0001a780: 6861 3d30 2c0a 2020 2020 2020 2020 290a  ha=0,.        ).
+0001a790: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0001a7a0: 742e 7465 7874 280a 2020 2020 2020 2020  t.text(.        
+0001a7b0: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+0001a7c0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+0001a7d0: 2020 2020 7465 7874 3d22 7368 6f77 2d6e      text="show-n
+0001a7e0: 616d 6522 2c0a 2020 2020 2020 2020 2020  ame",.          
+0001a7f0: 2020 793d 2262 6f74 746f 6d22 2c0a 2020    y="bottom",.  
+0001a800: 2020 2020 2020 2020 2020 783d 226c 6566            x="lef
+0001a810: 7422 2c0a 2020 2020 2020 2020 2020 2020  t",.            
+0001a820: 785f 6f66 6673 6574 3d35 2c0a 2020 2020  x_offset=5,.    
+0001a830: 2020 2020 2020 2020 7465 7874 5f66 6f6e          text_fon
+0001a840: 745f 7369 7a65 3d76 616c 7565 2822 3130  t_size=value("10
+0001a850: 7074 2229 2c0a 2020 2020 2020 2020 290a  pt"),.        ).
+0001a860: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+0001a870: 742e 7465 7874 280a 2020 2020 2020 2020  t.text(.        
+0001a880: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+0001a890: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+0001a8a0: 2020 2020 7465 7874 3d22 646f 6e65 222c      text="done",
+0001a8b0: 0a20 2020 2020 2020 2020 2020 2079 3d22  .            y="
+0001a8c0: 626f 7474 6f6d 222c 0a20 2020 2020 2020  bottom",.       
+0001a8d0: 2020 2020 2078 3d22 7269 6768 7422 2c0a       x="right",.
+0001a8e0: 2020 2020 2020 2020 2020 2020 785f 6f66              x_of
+0001a8f0: 6673 6574 3d2d 352c 0a20 2020 2020 2020  fset=-5,.       
+0001a900: 2020 2020 2074 6578 745f 616c 6967 6e3d       text_align=
+0001a910: 2272 6967 6874 222c 0a20 2020 2020 2020  "right",.       
+0001a920: 2020 2020 2074 6578 745f 666f 6e74 5f73       text_font_s
+0001a930: 697a 653d 7661 6c75 6528 2231 3070 7422  ize=value("10pt"
+0001a940: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
+0001a950: 2020 2020 2073 656c 662e 726f 6f74 2e79       self.root.y
+0001a960: 6772 6964 2e76 6973 6962 6c65 203d 2046  grid.visible = F
+0001a970: 616c 7365 0a20 2020 2020 2020 2073 656c  alse.        sel
+0001a980: 662e 726f 6f74 2e79 6178 6973 2e6d 696e  f.root.yaxis.min
+0001a990: 6f72 5f74 6963 6b5f 6c69 6e65 5f61 6c70  or_tick_line_alp
+0001a9a0: 6861 203d 2030 0a20 2020 2020 2020 2073  ha = 0.        s
+0001a9b0: 656c 662e 726f 6f74 2e79 6178 6973 2e76  elf.root.yaxis.v
+0001a9c0: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
+0001a9d0: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+0001a9e0: 2e78 6772 6964 2e76 6973 6962 6c65 203d  .xgrid.visible =
+0001a9f0: 2046 616c 7365 0a20 2020 2020 2020 2073   False.        s
+0001aa00: 656c 662e 726f 6f74 2e78 6178 6973 2e6d  elf.root.xaxis.m
+0001aa10: 696e 6f72 5f74 6963 6b5f 6c69 6e65 5f61  inor_tick_line_a
+0001aa20: 6c70 6861 203d 2030 0a20 2020 2020 2020  lpha = 0.       
+0001aa30: 2073 656c 662e 726f 6f74 2e78 6178 6973   self.root.xaxis
+0001aa40: 2e76 6973 6962 6c65 203d 2046 616c 7365  .visible = False
+0001aa50: 0a0a 2020 2020 2020 2020 686f 7665 7220  ..        hover 
+0001aa60: 3d20 486f 7665 7254 6f6f 6c28 0a20 2020  = HoverTool(.   
+0001aa70: 2020 2020 2020 2020 2070 6f69 6e74 5f70           point_p
+0001aa80: 6f6c 6963 793d 2266 6f6c 6c6f 775f 6d6f  olicy="follow_mo
+0001aa90: 7573 6522 2c0a 2020 2020 2020 2020 2020  use",.          
+0001aaa0: 2020 746f 6f6c 7469 7073 3d22 2222 0a20    tooltips=""". 
+0001aab0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0001aac0: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
+0001aad0: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+0001aae0: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+0001aaf0: 2031 3470 783b 2066 6f6e 742d 7765 6967   14px; font-weig
+0001ab00: 6874 3a20 626f 6c64 3b22 3e4e 616d 653a  ht: bold;">Name:
+0001ab10: 3c2f 7370 616e 3e26 6e62 7370 3b0a 2020  </span>&nbsp;.  
+0001ab20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab30: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
+0001ab40: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
+0001ab50: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
+0001ab60: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
+0001ab70: 3e40 6e61 6d65 3c2f 7370 616e 3e0a 2020  >@name</span>.  
+0001ab80: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
+0001ab90: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
+0001aba0: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
+0001abb0: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0001abc0: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+0001abd0: 2d73 697a 653a 2031 3470 783b 2066 6f6e  -size: 14px; fon
+0001abe0: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
+0001abf0: 3e41 6c6c 3a3c 2f73 7061 6e3e 266e 6273  >All:</span>&nbs
+0001ac00: 703b 0a20 2020 2020 2020 2020 2020 2020  p;.             
+0001ac10: 2020 2020 2020 203c 7370 616e 2073 7479         <span sty
+0001ac20: 6c65 3d22 666f 6e74 2d73 697a 653a 2031  le="font-size: 1
+0001ac30: 3070 783b 2066 6f6e 742d 6661 6d69 6c79  0px; font-family
+0001ac40: 3a20 4d6f 6e61 636f 2c20 6d6f 6e6f 7370  : Monaco, monosp
+0001ac50: 6163 653b 223e 4061 6c6c 3c2f 7370 616e  ace;">@all</span
+0001ac60: 3e0a 2020 2020 2020 2020 2020 2020 2020  >.              
+0001ac70: 2020 3c2f 6469 763e 0a20 2020 2020 2020    </div>.       
+0001ac80: 2020 2020 2020 2020 203c 6469 763e 0a20           <div>. 
+0001ac90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aca0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
+0001acb0: 666f 6e74 2d73 697a 653a 2031 3470 783b  font-size: 14px;
+0001acc0: 2066 6f6e 742d 7765 6967 6874 3a20 626f   font-weight: bo
+0001acd0: 6c64 3b22 3e51 7565 7565 643a 3c2f 7370  ld;">Queued:</sp
+0001ace0: 616e 3e26 6e62 7370 3b0a 2020 2020 2020  an>&nbsp;.      
+0001acf0: 2020 2020 2020 2020 2020 2020 2020 3c73                <s
+0001ad00: 7061 6e20 7374 796c 653d 2266 6f6e 742d  pan style="font-
+0001ad10: 7369 7a65 3a20 3130 7078 3b20 666f 6e74  size: 10px; font
+0001ad20: 2d66 616d 696c 793a 204d 6f6e 6163 6f2c  -family: Monaco,
+0001ad30: 206d 6f6e 6f73 7061 6365 3b22 3e40 7175   monospace;">@qu
+0001ad40: 6575 6564 3c2f 7370 616e 3e0a 2020 2020  eued</span>.    
+0001ad50: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
+0001ad60: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
+0001ad70: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
+0001ad80: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
+0001ad90: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
+0001ada0: 697a 653a 2031 3470 783b 2066 6f6e 742d  ize: 14px; font-
+0001adb0: 7765 6967 6874 3a20 626f 6c64 3b22 3e4e  weight: bold;">N
+0001adc0: 6f2d 776f 726b 6572 3a3c 2f73 7061 6e3e  o-worker:</span>
+0001add0: 266e 6273 703b 0a20 2020 2020 2020 2020  &nbsp;.         
+0001ade0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+0001adf0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+0001ae00: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
+0001ae10: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
+0001ae20: 6e6f 7370 6163 653b 223e 406e 6f5f 776f  nospace;">@no_wo
+0001ae30: 726b 6572 3c2f 7370 616e 3e0a 2020 2020  rker</span>.    
+0001ae40: 2020 2020 2020 2020 2020 2020 3c2f 6469              </di
+0001ae50: 763e 0a20 2020 2020 2020 2020 2020 2020  v>.             
+0001ae60: 2020 203c 6469 763e 0a20 2020 2020 2020     <div>.       
+0001ae70: 2020 2020 2020 2020 2020 2020 203c 7370               <sp
+0001ae80: 616e 2073 7479 6c65 3d22 666f 6e74 2d73  an style="font-s
+0001ae90: 697a 653a 2031 3470 783b 2066 6f6e 742d  ize: 14px; font-
+0001aea0: 7765 6967 6874 3a20 626f 6c64 3b22 3e50  weight: bold;">P
+0001aeb0: 726f 6365 7373 696e 673a 3c2f 7370 616e  rocessing:</span
+0001aec0: 3e26 6e62 7370 3b0a 2020 2020 2020 2020  >&nbsp;.        
+0001aed0: 2020 2020 2020 2020 2020 2020 3c73 7061              <spa
+0001aee0: 6e20 7374 796c 653d 2266 6f6e 742d 7369  n style="font-si
+0001aef0: 7a65 3a20 3130 7078 3b20 666f 6e74 2d66  ze: 10px; font-f
+0001af00: 616d 696c 793a 204d 6f6e 6163 6f2c 206d  amily: Monaco, m
+0001af10: 6f6e 6f73 7061 6365 3b22 3e40 7072 6f63  onospace;">@proc
+0001af20: 6573 7369 6e67 3c2f 7370 616e 3e0a 2020  essing</span>.  
+0001af30: 2020 2020 2020 2020 2020 2020 2020 3c2f                </
+0001af40: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
+0001af50: 2020 2020 203c 6469 763e 0a20 2020 2020       <div>.     
+0001af60: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0001af70: 7370 616e 2073 7479 6c65 3d22 666f 6e74  span style="font
+0001af80: 2d73 697a 653a 2031 3470 783b 2066 6f6e  -size: 14px; fon
+0001af90: 742d 7765 6967 6874 3a20 626f 6c64 3b22  t-weight: bold;"
+0001afa0: 3e4d 656d 6f72 793a 3c2f 7370 616e 3e26  >Memory:</span>&
+0001afb0: 6e62 7370 3b0a 2020 2020 2020 2020 2020  nbsp;.          
+0001afc0: 2020 2020 2020 2020 2020 3c73 7061 6e20            <span 
+0001afd0: 7374 796c 653d 2266 6f6e 742d 7369 7a65  style="font-size
+0001afe0: 3a20 3130 7078 3b20 666f 6e74 2d66 616d  : 10px; font-fam
+0001aff0: 696c 793a 204d 6f6e 6163 6f2c 206d 6f6e  ily: Monaco, mon
+0001b000: 6f73 7061 6365 3b22 3e40 6d65 6d6f 7279  ospace;">@memory
+0001b010: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
+0001b020: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
+0001b030: 2020 2020 2020 2020 2020 2020 2020 203c                 <
+0001b040: 6469 763e 0a20 2020 2020 2020 2020 2020  div>.           
+0001b050: 2020 2020 2020 2020 203c 7370 616e 2073           <span s
+0001b060: 7479 6c65 3d22 666f 6e74 2d73 697a 653a  tyle="font-size:
+0001b070: 2031 3470 783b 2066 6f6e 742d 7765 6967   14px; font-weig
+0001b080: 6874 3a20 626f 6c64 3b22 3e45 7272 6564  ht: bold;">Erred
+0001b090: 3a3c 2f73 7061 6e3e 266e 6273 703b 0a20  :</span>&nbsp;. 
+0001b0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b0b0: 2020 203c 7370 616e 2073 7479 6c65 3d22     <span style="
+0001b0c0: 666f 6e74 2d73 697a 653a 2031 3070 783b  font-size: 10px;
+0001b0d0: 2066 6f6e 742d 6661 6d69 6c79 3a20 4d6f   font-family: Mo
+0001b0e0: 6e61 636f 2c20 6d6f 6e6f 7370 6163 653b  naco, monospace;
+0001b0f0: 223e 4065 7272 6564 3c2f 7370 616e 3e0a  ">@erred</span>.
+0001b100: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b110: 3c2f 6469 763e 0a20 2020 2020 2020 2020  </div>.         
+0001b120: 2020 2020 2020 2022 2222 2c0a 2020 2020         """,.    
+0001b130: 2020 2020 290a 2020 2020 2020 2020 6865      ).        he
+0001b140: 6c70 5f20 3d20 4865 6c70 546f 6f6c 280a  lp_ = HelpTool(.
+0001b150: 2020 2020 2020 2020 2020 2020 7265 6469              redi
+0001b160: 7265 6374 3d22 6874 7470 733a 2f2f 646f  rect="https://do
+0001b170: 6373 2e64 6173 6b2e 6f72 672f 656e 2f73  cs.dask.org/en/s
+0001b180: 7461 626c 652f 6461 7368 626f 6172 642e  table/dashboard.
+0001b190: 6874 6d6c 2370 726f 6772 6573 7322 2c0a  html#progress",.
+0001b1a0: 2020 2020 2020 2020 2020 2020 6465 7363              desc
+0001b1b0: 7269 7074 696f 6e3d 2241 2064 6573 6372  ription="A descr
+0001b1c0: 6970 7469 6f6e 206f 6620 7468 6520 7072  iption of the pr
+0001b1d0: 6f67 7265 7373 2062 6172 7320 706c 6f74  ogress bars plot
+0001b1e0: 2e22 2c0a 2020 2020 2020 2020 290a 2020  .",.        ).  
+0001b1f0: 2020 2020 2020 7365 6c66 2e72 6f6f 742e        self.root.
+0001b200: 6164 645f 746f 6f6c 7328 686f 7665 722c  add_tools(hover,
+0001b210: 2068 656c 705f 290a 0a20 2020 2040 7769   help_)..    @wi
+0001b220: 7468 6f75 745f 7072 6f70 6572 7479 5f76  thout_property_v
+0001b230: 616c 6964 6174 696f 6e0a 2020 2020 406c  alidation.    @l
+0001b240: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+0001b250: 6620 7570 6461 7465 2873 656c 6629 3a0a  f update(self):.
+0001b260: 2020 2020 2020 2020 7374 6174 6520 3d20          state = 
+0001b270: 7b0a 2020 2020 2020 2020 2020 2020 226d  {.            "m
+0001b280: 656d 6f72 7922 3a20 7b7d 2c0a 2020 2020  emory": {},.    
+0001b290: 2020 2020 2020 2020 2265 7272 6564 223a          "erred":
+0001b2a0: 207b 7d2c 0a20 2020 2020 2020 2020 2020   {},.           
+0001b2b0: 2022 7265 6c65 6173 6564 223a 207b 7d2c   "released": {},
+0001b2c0: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
+0001b2d0: 6f63 6573 7369 6e67 223a 207b 7d2c 0a20  ocessing": {},. 
+0001b2e0: 2020 2020 2020 2020 2020 2022 7761 6974             "wait
+0001b2f0: 696e 6722 3a20 7b7d 2c0a 2020 2020 2020  ing": {},.      
+0001b300: 2020 2020 2020 2271 7565 7565 6422 3a20        "queued": 
+0001b310: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
+0001b320: 226e 6f5f 776f 726b 6572 223a 207b 7d2c  "no_worker": {},
+0001b330: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0001b340: 2020 2020 666f 7220 7470 2069 6e20 7365      for tp in se
+0001b350: 6c66 2e73 6368 6564 756c 6572 2e74 6173  lf.scheduler.tas
+0001b360: 6b5f 7072 6566 6978 6573 2e76 616c 7565  k_prefixes.value
+0001b370: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0001b380: 2061 6374 6976 655f 7374 6174 6573 203d   active_states =
+0001b390: 2074 702e 6163 7469 7665 5f73 7461 7465   tp.active_state
+0001b3a0: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
+0001b3b0: 2061 6e79 2861 6374 6976 655f 7374 6174   any(active_stat
+0001b3c0: 6573 2e67 6574 2873 2920 666f 7220 7320  es.get(s) for s 
+0001b3d0: 696e 2073 7461 7465 2e6b 6579 7328 2929  in state.keys())
+0001b3e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001b3f0: 2020 7374 6174 655b 226d 656d 6f72 7922    state["memory"
+0001b400: 5d5b 7470 2e6e 616d 655d 203d 2061 6374  ][tp.name] = act
+0001b410: 6976 655f 7374 6174 6573 5b22 6d65 6d6f  ive_states["memo
+0001b420: 7279 225d 0a20 2020 2020 2020 2020 2020  ry"].           
+0001b430: 2020 2020 2073 7461 7465 5b22 6572 7265       state["erre
+0001b440: 6422 5d5b 7470 2e6e 616d 655d 203d 2061  d"][tp.name] = a
+0001b450: 6374 6976 655f 7374 6174 6573 5b22 6572  ctive_states["er
+0001b460: 7265 6422 5d0a 2020 2020 2020 2020 2020  red"].          
+0001b470: 2020 2020 2020 7374 6174 655b 2272 656c        state["rel
+0001b480: 6561 7365 6422 5d5b 7470 2e6e 616d 655d  eased"][tp.name]
+0001b490: 203d 2061 6374 6976 655f 7374 6174 6573   = active_states
+0001b4a0: 5b22 7265 6c65 6173 6564 225d 0a20 2020  ["released"].   
+0001b4b0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+0001b4c0: 7465 5b22 7072 6f63 6573 7369 6e67 225d  te["processing"]
+0001b4d0: 5b74 702e 6e61 6d65 5d20 3d20 6163 7469  [tp.name] = acti
+0001b4e0: 7665 5f73 7461 7465 735b 2270 726f 6365  ve_states["proce
+0001b4f0: 7373 696e 6722 5d0a 2020 2020 2020 2020  ssing"].        
+0001b500: 2020 2020 2020 2020 7374 6174 655b 2277          state["w
+0001b510: 6169 7469 6e67 225d 5b74 702e 6e61 6d65  aiting"][tp.name
+0001b520: 5d20 3d20 6163 7469 7665 5f73 7461 7465  ] = active_state
+0001b530: 735b 2277 6169 7469 6e67 225d 0a20 2020  s["waiting"].   
+0001b540: 2020 2020 2020 2020 2020 2020 2073 7461               sta
+0001b550: 7465 5b22 7175 6575 6564 225d 5b74 702e  te["queued"][tp.
+0001b560: 6e61 6d65 5d20 3d20 6163 7469 7665 5f73  name] = active_s
+0001b570: 7461 7465 735b 2271 7565 7565 6422 5d0a  tates["queued"].
+0001b580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b590: 7374 6174 655b 226e 6f5f 776f 726b 6572  state["no_worker
+0001b5a0: 225d 5b74 702e 6e61 6d65 5d20 3d20 6163  "][tp.name] = ac
+0001b5b0: 7469 7665 5f73 7461 7465 735b 226e 6f2d  tive_states["no-
+0001b5c0: 776f 726b 6572 225d 0a0a 2020 2020 2020  worker"]..      
+0001b5d0: 2020 7374 6174 655b 2261 6c6c 225d 203d    state["all"] =
+0001b5e0: 207b 6b3a 2073 756d 2876 5b6b 5d20 666f   {k: sum(v[k] fo
+0001b5f0: 7220 7620 696e 2073 7461 7465 2e76 616c  r v in state.val
+0001b600: 7565 7328 2929 2066 6f72 206b 2069 6e20  ues()) for k in 
+0001b610: 7374 6174 655b 226d 656d 6f72 7922 5d7d  state["memory"]}
+0001b620: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+0001b630: 2073 7461 7465 5b22 616c 6c22 5d20 616e   state["all"] an
+0001b640: 6420 6e6f 7420 6c65 6e28 7365 6c66 2e73  d not len(self.s
+0001b650: 6f75 7263 652e 6461 7461 5b22 616c 6c22  ource.data["all"
+0001b660: 5d29 3a0a 2020 2020 2020 2020 2020 2020  ]):.            
+0001b670: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+0001b680: 6420 3d20 7072 6f67 7265 7373 5f71 7561  d = progress_qua
+0001b690: 6473 2873 7461 7465 290a 0a20 2020 2020  ds(state)..     
+0001b6a0: 2020 2075 7064 6174 6528 7365 6c66 2e73     update(self.s
+0001b6b0: 6f75 7263 652c 2064 290a 0a20 2020 2020  ource, d)..     
+0001b6c0: 2020 2074 6f74 616c 7320 3d20 7b0a 2020     totals = {.  
+0001b6d0: 2020 2020 2020 2020 2020 6b3a 2073 756d            k: sum
+0001b6e0: 2873 7461 7465 5b6b 5d2e 7661 6c75 6573  (state[k].values
+0001b6f0: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+0001b700: 666f 7220 6b20 696e 205b 0a20 2020 2020  for k in [.     
+0001b710: 2020 2020 2020 2020 2020 2022 616c 6c22             "all"
+0001b720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001b730: 2020 226d 656d 6f72 7922 2c0a 2020 2020    "memory",.    
+0001b740: 2020 2020 2020 2020 2020 2020 2265 7272              "err
+0001b750: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
+0001b760: 2020 2020 2022 7265 6c65 6173 6564 222c       "released",
+0001b770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b780: 2022 7761 6974 696e 6722 2c0a 2020 2020   "waiting",.    
+0001b790: 2020 2020 2020 2020 2020 2020 2271 7565              "que
+0001b7a0: 7565 6422 2c0a 2020 2020 2020 2020 2020  ued",.          
+0001b7b0: 2020 2020 2020 226e 6f5f 776f 726b 6572        "no_worker
+0001b7c0: 222c 0a20 2020 2020 2020 2020 2020 205d  ",.            ]
+0001b7d0: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+0001b7e0: 2020 2074 6f74 616c 735b 2270 726f 6365     totals["proce
+0001b7f0: 7373 696e 6722 5d20 3d20 746f 7461 6c73  ssing"] = totals
+0001b800: 5b22 616c 6c22 5d20 2d20 7375 6d28 0a20  ["all"] - sum(. 
+0001b810: 2020 2020 2020 2020 2020 2076 2066 6f72             v for
+0001b820: 206b 2c20 7620 696e 2074 6f74 616c 732e   k, v in totals.
+0001b830: 6974 656d 7328 2920 6966 206b 2021 3d20  items() if k != 
+0001b840: 2261 6c6c 220a 2020 2020 2020 2020 290a  "all".        ).
+0001b850: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+0001b860: 6f74 2e74 6974 6c65 2e74 6578 7420 3d20  ot.title.text = 
+0001b870: 280a 2020 2020 2020 2020 2020 2020 2250  (.            "P
+0001b880: 726f 6772 6573 7320 2d2d 2074 6f74 616c  rogress -- total
+0001b890: 3a20 2528 616c 6c29 732c 2022 0a20 2020  : %(all)s, ".   
+0001b8a0: 2020 2020 2020 2020 2022 7761 6974 696e           "waitin
+0001b8b0: 673a 2025 2877 6169 7469 6e67 2973 2c20  g: %(waiting)s, 
+0001b8c0: 220a 2020 2020 2020 2020 2020 2020 2271  ".            "q
+0001b8d0: 7565 7565 643a 2025 2871 7565 7565 6429  ueued: %(queued)
+0001b8e0: 732c 2022 0a20 2020 2020 2020 2020 2020  s, ".           
+0001b8f0: 2022 7072 6f63 6573 7369 6e67 3a20 2528   "processing: %(
+0001b900: 7072 6f63 6573 7369 6e67 2973 2c20 220a  processing)s, ".
+0001b910: 2020 2020 2020 2020 2020 2020 2269 6e2d              "in-
+0001b920: 6d65 6d6f 7279 3a20 2528 6d65 6d6f 7279  memory: %(memory
+0001b930: 2973 2c20 220a 2020 2020 2020 2020 2020  )s, ".          
+0001b940: 2020 226e 6f2d 776f 726b 6572 3a20 2528    "no-worker: %(
+0001b950: 6e6f 5f77 6f72 6b65 7229 732c 2022 0a20  no_worker)s, ". 
+0001b960: 2020 2020 2020 2020 2020 2022 6572 7265             "erre
+0001b970: 643a 2025 2865 7272 6564 2973 2220 2520  d: %(erred)s" % 
+0001b980: 746f 7461 6c73 0a20 2020 2020 2020 2029  totals.        )
+0001b990: 0a0a 0a63 6c61 7373 2046 696e 6550 6572  ...class FinePer
+0001b9a0: 666f 726d 616e 6365 4d65 7472 6963 7328  formanceMetrics(
+0001b9b0: 4461 7368 626f 6172 6443 6f6d 706f 6e65  DashboardCompone
+0001b9c0: 6e74 293a 0a20 2020 2022 2222 0a20 2020  nt):.    """.   
+0001b9d0: 2054 6865 206d 6169 6e20 6f76 6572 7669   The main overvi
+0001b9e0: 6577 206f 6620 7468 6520 4669 6e65 2050  ew of the Fine P
+0001b9f0: 6572 666f 726d 616e 6365 204d 6574 7269  erformance Metri
+0001ba00: 6373 2070 6167 652e 0a20 2020 2022 2222  cs page..    """
+0001ba10: 0a0a 2020 2020 4241 5345 5f54 4f4f 4c53  ..    BASE_TOOLS
+0001ba20: 203d 205b 2270 616e 222c 2022 7768 6565   = ["pan", "whee
+0001ba30: 6c5f 7a6f 6f6d 222c 2022 626f 785f 7a6f  l_zoom", "box_zo
+0001ba40: 6f6d 222c 2022 7265 7365 7422 5d0a 2020  om", "reset"].  
+0001ba50: 2020 7363 6865 6475 6c65 723a 2053 6368    scheduler: Sch
+0001ba60: 6564 756c 6572 0a20 2020 2074 6173 6b5f  eduler.    task_
+0001ba70: 6578 6563 5f62 795f 7072 6566 6978 5f73  exec_by_prefix_s
+0001ba80: 7263 3a20 436f 6c75 6d6e 4461 7461 536f  rc: ColumnDataSo
+0001ba90: 7572 6365 0a20 2020 2074 6173 6b5f 6578  urce.    task_ex
+0001baa0: 6563 5f62 795f 7072 6566 6978 5f78 6d61  ec_by_prefix_xma
+0001bab0: 783a 2066 6c6f 6174 0a20 2020 2074 6173  x: float.    tas
+0001bac0: 6b5f 6578 6563 5f62 795f 6163 7469 7669  k_exec_by_activi
+0001bad0: 7479 5f73 7263 3a20 436f 6c75 6d6e 4461  ty_src: ColumnDa
+0001bae0: 7461 536f 7572 6365 0a20 2020 2067 6574  taSource.    get
+0001baf0: 5f64 6174 615f 6279 5f61 6374 6976 6974  _data_by_activit
+0001bb00: 795f 7372 633a 2043 6f6c 756d 6e44 6174  y_src: ColumnDat
+0001bb10: 6153 6f75 7263 650a 2020 2020 7375 6273  aSource.    subs
+0001bb20: 7461 6e74 6961 6c5f 6368 616e 6765 3a20  tantial_change: 
+0001bb30: 626f 6f6c 0a20 2020 2076 6973 6962 6c65  bool.    visible
+0001bb40: 5f66 756e 6374 696f 6e73 3a20 6c69 7374  _functions: list
+0001bb50: 5b73 7472 5d0a 2020 2020 7669 7369 626c  [str].    visibl
+0001bb60: 655f 6163 7469 7669 7469 6573 3a20 6c69  e_activities: li
+0001bb70: 7374 5b73 7472 5d0a 2020 2020 7374 6163  st[str].    stac
+0001bb80: 6b65 645f 6368 6172 745f 7669 7369 626c  ked_chart_visibl
+0001bb90: 655f 6163 7469 7669 7469 6573 3a20 6c69  e_activities: li
+0001bba0: 7374 5b73 7472 5d0a 2020 2020 6675 6e63  st[str].    func
+0001bbb0: 7469 6f6e 5f73 656c 6563 746f 723a 204d  tion_selector: M
+0001bbc0: 756c 7469 4368 6f69 6365 0a20 2020 2073  ultiChoice.    s
+0001bbd0: 7061 6e5f 7461 675f 7365 6c65 6374 6f72  pan_tag_selector
+0001bbe0: 3a20 4d75 6c74 6943 686f 6963 650a 2020  : MultiChoice.  
+0001bbf0: 2020 756e 6974 5f73 656c 6563 746f 723a    unit_selector:
+0001bc00: 2053 656c 6563 740a 2020 2020 7461 736b   Select.    task
+0001bc10: 5f65 7865 635f 6279 5f61 6374 6976 6974  _exec_by_activit
+0001bc20: 795f 6368 6172 743a 2066 6967 7572 6520  y_chart: figure 
+0001bc30: 7c20 4e6f 6e65 0a20 2020 2074 6173 6b5f  | None.    task_
+0001bc40: 6578 6563 5f62 795f 7072 6566 6978 5f63  exec_by_prefix_c
+0001bc50: 6861 7274 3a20 6669 6775 7265 207c 204e  hart: figure | N
+0001bc60: 6f6e 650a 2020 2020 6765 745f 6461 7461  one.    get_data
+0001bc70: 5f62 795f 6163 7469 7669 7479 5f63 6861  _by_activity_cha
+0001bc80: 7274 3a20 6669 6775 7265 207c 204e 6f6e  rt: figure | Non
+0001bc90: 650a 0a20 2020 2040 6c6f 675f 6572 726f  e..    @log_erro
+0001bca0: 7273 0a20 2020 2064 6566 205f 5f69 6e69  rs.    def __ini
+0001bcb0: 745f 5f28 7365 6c66 2c20 7363 6865 6475  t__(self, schedu
+0001bcc0: 6c65 723a 2053 6368 6564 756c 6572 2c20  ler: Scheduler, 
+0001bcd0: 2a2a 6b77 6172 6773 3a20 416e 7929 3a0a  **kwargs: Any):.
+0001bce0: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+0001bcf0: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
+0001bd00: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
+0001bd10: 7461 736b 5f65 7865 635f 6279 5f70 7265  task_exec_by_pre
+0001bd20: 6669 785f 7372 6320 3d20 436f 6c75 6d6e  fix_src = Column
+0001bd30: 4461 7461 536f 7572 6365 2864 6174 613d  DataSource(data=
+0001bd40: 7b7d 290a 2020 2020 2020 2020 7365 6c66  {}).        self
+0001bd50: 2e74 6173 6b5f 6578 6563 5f62 795f 7072  .task_exec_by_pr
+0001bd60: 6566 6978 5f78 6d61 7820 3d20 302e 300a  efix_xmax = 0.0.
+0001bd70: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0001bd80: 6b5f 6578 6563 5f62 795f 6163 7469 7669  k_exec_by_activi
+0001bd90: 7479 5f73 7263 203d 2043 6f6c 756d 6e44  ty_src = ColumnD
+0001bda0: 6174 6153 6f75 7263 6528 6461 7461 3d7b  ataSource(data={
+0001bdb0: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+0001bdc0: 6765 745f 6461 7461 5f62 795f 6163 7469  get_data_by_acti
+0001bdd0: 7669 7479 5f73 7263 203d 2043 6f6c 756d  vity_src = Colum
+0001bde0: 6e44 6174 6153 6f75 7263 6528 6461 7461  nDataSource(data
+0001bdf0: 3d7b 7d29 0a20 2020 2020 2020 2073 656c  ={}).        sel
+0001be00: 662e 7375 6273 7461 6e74 6961 6c5f 6368  f.substantial_ch
+0001be10: 616e 6765 203d 2046 616c 7365 0a20 2020  ange = False.   
+0001be20: 2020 2020 2073 656c 662e 7669 7369 626c       self.visibl
+0001be30: 655f 6675 6e63 7469 6f6e 7320 3d20 5b5d  e_functions = []
+0001be40: 0a20 2020 2020 2020 2073 656c 662e 7669  .        self.vi
+0001be50: 7369 626c 655f 6163 7469 7669 7469 6573  sible_activities
+0001be60: 203d 205b 5d0a 2020 2020 2020 2020 7365   = [].        se
+0001be70: 6c66 2e73 7461 636b 6564 5f63 6861 7274  lf.stacked_chart
+0001be80: 5f76 6973 6962 6c65 5f61 6374 6976 6974  _visible_activit
+0001be90: 6965 7320 3d20 5b5d 0a20 2020 2020 2020  ies = [].       
+0001bea0: 2073 656c 662e 7461 736b 5f65 7865 635f   self.task_exec_
+0001beb0: 6279 5f61 6374 6976 6974 795f 6368 6172  by_activity_char
+0001bec0: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
+0001bed0: 2073 656c 662e 7461 736b 5f65 7865 635f   self.task_exec_
+0001bee0: 6279 5f70 7265 6669 785f 6368 6172 7420  by_prefix_chart 
+0001bef0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+0001bf00: 656c 662e 6765 745f 6461 7461 5f62 795f  elf.get_data_by_
+0001bf10: 6163 7469 7669 7479 5f63 6861 7274 203d  activity_chart =
+0001bf20: 204e 6f6e 650a 0a20 2020 2020 2020 2023   None..        #
+0001bf30: 2053 656c 6563 746f 7273 0a20 2020 2020   Selectors.     
+0001bf40: 2020 2073 656c 662e 6675 6e63 7469 6f6e     self.function
+0001bf50: 5f73 656c 6563 746f 7220 3d20 4d75 6c74  _selector = Mult
+0001bf60: 6943 686f 6963 6528 0a20 2020 2020 2020  iChoice(.       
+0001bf70: 2020 2020 2074 6974 6c65 3d22 4669 6c74       title="Filt
+0001bf80: 6572 2062 7920 6675 6e63 7469 6f6e 222c  er by function",
+0001bf90: 0a20 2020 2020 2020 2020 2020 2070 6c61  .            pla
+0001bfa0: 6365 686f 6c64 6572 3d22 5365 6c65 6374  ceholder="Select
+0001bfb0: 2073 7065 6369 6669 6320 6675 6e63 7469   specific functi
+0001bfc0: 6f6e 7322 2c0a 2020 2020 2020 2020 2020  ons",.          
+0001bfd0: 2020 7661 6c75 653d 5b5d 2c0a 2020 2020    value=[],.    
+0001bfe0: 2020 2020 2020 2020 6f70 7469 6f6e 733d          options=
+0001bff0: 5b5d 2c0a 2020 2020 2020 2020 290a 2020  [],.        ).  
+0001c000: 2020 2020 2020 7365 6c66 2e73 7061 6e5f        self.span_
+0001c010: 7461 675f 7365 6c65 6374 6f72 203d 204d  tag_selector = M
+0001c020: 756c 7469 4368 6f69 6365 280a 2020 2020  ultiChoice(.    
+0001c030: 2020 2020 2020 2020 7469 746c 653d 2246          title="F
+0001c040: 696c 7465 7220 6279 2073 7061 6e20 7461  ilter by span ta
+0001c050: 6722 2c0a 2020 2020 2020 2020 2020 2020  g",.            
+0001c060: 706c 6163 6568 6f6c 6465 723d 2253 656c  placeholder="Sel
+0001c070: 6563 7420 7370 6563 6966 6963 2073 7061  ect specific spa
+0001c080: 6e20 7461 6773 222c 0a20 2020 2020 2020  n tags",.       
+0001c090: 2020 2020 2076 616c 7565 3d5b 5d2c 0a20       value=[],. 
+0001c0a0: 2020 2020 2020 2020 2020 206f 7074 696f             optio
+0001c0b0: 6e73 3d5b 5d2c 0a20 2020 2020 2020 2029  ns=[],.        )
+0001c0c0: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
+0001c0d0: 6974 5f73 656c 6563 746f 7220 3d20 5365  it_selector = Se
+0001c0e0: 6c65 6374 2874 6974 6c65 3d22 556e 6974  lect(title="Unit
+0001c0f0: 2073 656c 6563 7469 6f6e 222c 206f 7074   selection", opt
+0001c100: 696f 6e73 3d5b 2273 6563 6f6e 6473 225d  ions=["seconds"]
+0001c110: 290a 2020 2020 2020 2020 7365 6c66 2e75  ).        self.u
+0001c120: 6e69 745f 7365 6c65 6374 6f72 2e76 616c  nit_selector.val
+0001c130: 7565 203d 2022 7365 636f 6e64 7322 0a20  ue = "seconds". 
+0001c140: 2020 2020 2020 2073 656c 662e 756e 6974         self.unit
+0001c150: 5f73 656c 6563 746f 722e 6f6e 5f63 6861  _selector.on_cha
+0001c160: 6e67 6528 2276 616c 7565 222c 2073 656c  nge("value", sel
+0001c170: 662e 5f68 616e 646c 655f 6368 616e 6765  f._handle_change
+0001c180: 5f75 6e69 7429 0a0a 2020 2020 2020 2020  _unit)..        
+0001c190: 7365 6c65 6374 6f72 735f 726f 7720 3d20  selectors_row = 
+0001c1a0: 726f 7728 0a20 2020 2020 2020 2020 2020  row(.           
+0001c1b0: 2063 6869 6c64 7265 6e3d 5b0a 2020 2020   children=[.    
+0001c1c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001c1d0: 2e73 7061 6e5f 7461 675f 7365 6c65 6374  .span_tag_select
+0001c1e0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
+0001c1f0: 2020 2020 7365 6c66 2e66 756e 6374 696f      self.functio
+0001c200: 6e5f 7365 6c65 6374 6f72 2c0a 2020 2020  n_selector,.    
+0001c210: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001c220: 2e75 6e69 745f 7365 6c65 6374 6f72 2c0a  .unit_selector,.
+0001c230: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+0001c240: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
+0001c250: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+0001c260: 7769 6474 6822 2c0a 2020 2020 2020 2020  width",.        
+0001c270: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
+0001c280: 6f6f 7420 3d20 636f 6c75 6d6e 280a 2020  oot = column(.  
+0001c290: 2020 2020 2020 2020 2020 7365 6c65 6374            select
+0001c2a0: 6f72 735f 726f 772c 0a20 2020 2020 2020  ors_row,.       
+0001c2b0: 2020 2020 2073 697a 696e 675f 6d6f 6465       sizing_mode
+0001c2c0: 3d22 7363 616c 655f 7769 6474 6822 2c0a  ="scale_width",.
+0001c2d0: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+0001c2e0: 6566 205f 6861 6e64 6c65 5f63 6861 6e67  ef _handle_chang
+0001c2f0: 655f 756e 6974 2873 656c 662c 2061 7474  e_unit(self, att
+0001c300: 723a 2073 7472 2c20 6f6c 643a 2073 7472  r: str, old: str
+0001c310: 2c20 6e65 773a 2073 7472 2920 2d3e 204e  , new: str) -> N
+0001c320: 6f6e 653a 0a20 2020 2020 2020 2073 656c  one:.        sel
+0001c330: 662e 7375 6273 7461 6e74 6961 6c5f 6368  f.substantial_ch
+0001c340: 616e 6765 203d 2054 7275 650a 2020 2020  ange = True.    
+0001c350: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
+0001c360: 7461 736b 5f65 7865 635f 6279 5f70 7265  task_exec_by_pre
+0001c370: 6669 785f 6368 6172 740a 2020 2020 2020  fix_chart.      
+0001c380: 2020 666d 7420 3d20 7365 6c66 2e5f 626f    fmt = self._bo
+0001c390: 6b65 685f 756e 6974 5f66 6f72 6d61 7428  keh_unit_format(
+0001c3a0: 290a 2020 2020 2020 2020 7365 6c66 2e74  ).        self.t
+0001c3b0: 6173 6b5f 6578 6563 5f62 795f 7072 6566  ask_exec_by_pref
+0001c3c0: 6978 5f63 6861 7274 2e78 6178 6973 5b30  ix_chart.xaxis[0
+0001c3d0: 5d2e 666f 726d 6174 7465 722e 666f 726d  ].formatter.form
+0001c3e0: 6174 203d 2066 6d74 0a0a 2020 2020 4077  at = fmt..    @w
+0001c3f0: 6974 686f 7574 5f70 726f 7065 7274 795f  ithout_property_
+0001c400: 7661 6c69 6461 7469 6f6e 0a20 2020 2040  validation.    @
+0001c410: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+0001c420: 6566 2075 7064 6174 6528 7365 6c66 293a  ef update(self):
+0001c430: 0a20 2020 2020 2020 2073 656c 662e 5f75  .        self._u
+0001c440: 7064 6174 655f 7365 6c65 6374 6f72 7328  pdate_selectors(
+0001c450: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+0001c460: 6275 696c 645f 6461 7461 5f73 6f75 7263  build_data_sourc
+0001c470: 6573 2829 0a0a 2020 2020 2020 2020 6e65  es()..        ne
+0001c480: 6564 735f 6669 6775 7265 735f 726f 7720  eds_figures_row 
+0001c490: 3d20 7365 6c66 2e74 6173 6b5f 6578 6563  = self.task_exec
+0001c4a0: 5f62 795f 6163 7469 7669 7479 5f63 6861  _by_activity_cha
+0001c4b0: 7274 2069 7320 4e6f 6e65 0a20 2020 2020  rt is None.     
+0001c4c0: 2020 2069 6620 6e65 6564 735f 6669 6775     if needs_figu
+0001c4d0: 7265 735f 726f 773a 0a20 2020 2020 2020  res_row:.       
+0001c4e0: 2020 2020 2073 656c 662e 7375 6273 7461       self.substa
+0001c4f0: 6e74 6961 6c5f 6368 616e 6765 203d 2054  ntial_change = T
+0001c500: 7275 650a 0a20 2020 2020 2020 2069 6620  rue..        if 
+0001c510: 6e65 6564 735f 6669 6775 7265 735f 726f  needs_figures_ro
+0001c520: 773a 0a20 2020 2020 2020 2020 2020 2023  w:.            #
+0001c530: 2046 6972 7374 2063 616c 6c20 746f 2075   First call to u
+0001c540: 7064 6174 6528 290a 2020 2020 2020 2020  pdate().        
+0001c550: 2020 2020 7365 6c66 2e74 6173 6b5f 6578      self.task_ex
+0001c560: 6563 5f62 795f 7072 6566 6978 5f63 6861  ec_by_prefix_cha
+0001c570: 7274 203d 2028 0a20 2020 2020 2020 2020  rt = (.         
+0001c580: 2020 2020 2020 2073 656c 662e 5f62 7569         self._bui
+0001c590: 6c64 5f74 6173 6b5f 6578 6563 7574 696f  ld_task_executio
+0001c5a0: 6e5f 6279 5f70 7265 6669 785f 6368 6172  n_by_prefix_char
+0001c5b0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+0001c5c0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0001c5d0: 6c66 2e74 6173 6b5f 6578 6563 5f62 795f  lf.task_exec_by_
+0001c5e0: 6163 7469 7669 7479 5f63 6861 7274 203d  activity_chart =
+0001c5f0: 2073 656c 662e 5f62 7569 6c64 5f70 6965   self._build_pie
+0001c600: 5f63 6861 7274 280a 2020 2020 2020 2020  _chart(.        
+0001c610: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+0001c620: 656c 662e 7461 736b 5f65 7865 635f 6279  elf.task_exec_by
+0001c630: 5f61 6374 6976 6974 795f 7372 632c 0a20  _activity_src,. 
+0001c640: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001c650: 6974 6c65 3d22 5461 736b 2065 7865 6375  itle="Task execu
+0001c660: 7469 6f6e 2c20 6279 2061 6374 6976 6974  tion, by activit
+0001c670: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
+0001c680: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+0001c690: 6c66 2e67 6574 5f64 6174 615f 6279 5f61  lf.get_data_by_a
+0001c6a0: 6374 6976 6974 795f 6368 6172 7420 3d20  ctivity_chart = 
+0001c6b0: 7365 6c66 2e5f 6275 696c 645f 7069 655f  self._build_pie_
+0001c6c0: 6368 6172 7428 0a20 2020 2020 2020 2020  chart(.         
+0001c6d0: 2020 2020 2020 2073 6f75 7263 653d 7365         source=se
+0001c6e0: 6c66 2e67 6574 5f64 6174 615f 6279 5f61  lf.get_data_by_a
+0001c6f0: 6374 6976 6974 795f 7372 632c 0a20 2020  ctivity_src,.   
+0001c700: 2020 2020 2020 2020 2020 2020 2023 2067               # g
+0001c710: 6574 5f64 6174 6120 6973 2063 616c 6c65  et_data is calle
+0001c720: 6420 7669 6120 5250 4320 666f 7220 6461  d via RPC for da
+0001c730: 7461 2070 756c 6c3b 2074 6865 206d 6574  ta pull; the met
+0001c740: 7269 6373 2066 6f72 2069 7420 6172 650a  rics for it are.
+0001c750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c760: 2320 7265 636f 7264 6564 206f 6e20 7468  # recorded on th
+0001c770: 6520 776f 726b 6572 202a 646f 6e61 7469  e worker *donati
+0001c780: 6e67 2a20 7468 6520 6461 7461 0a20 2020  ng* the data.   
+0001c790: 2020 2020 2020 2020 2020 2020 2074 6974               tit
+0001c7a0: 6c65 3d22 5365 6e64 2064 6174 612c 2062  le="Send data, b
+0001c7b0: 7920 6163 7469 7669 7479 222c 0a20 2020  y activity",.   
+0001c7c0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0001c7d0: 2020 2020 7365 6c66 2e74 6173 6b5f 6578      self.task_ex
+0001c7e0: 6563 5f62 795f 7072 6566 6978 5f63 6861  ec_by_prefix_cha
+0001c7f0: 7274 2e78 5f72 616e 6765 2e65 6e64 203d  rt.x_range.end =
+0001c800: 2073 656c 662e 7461 736b 5f65 7865 635f   self.task_exec_
+0001c810: 6279 5f70 7265 6669 785f 786d 6178 202a  by_prefix_xmax *
+0001c820: 2031 2e31 0a0a 2020 2020 2020 2020 6966   1.1..        if
+0001c830: 2073 656c 662e 7375 6273 7461 6e74 6961   self.substantia
+0001c840: 6c5f 6368 616e 6765 3a0a 2020 2020 2020  l_change:.      
+0001c850: 2020 2020 2020 2320 5669 7369 626c 6520        # Visible 
+0001c860: 6163 7469 7669 7469 6573 2061 6e64 2f6f  activities and/o
+0001c870: 7220 6675 6e63 7469 6f6e 7320 6368 616e  r functions chan
+0001c880: 6765 640a 2020 2020 2020 2020 2020 2020  ged.            
+0001c890: 7365 6c66 2e73 7562 7374 616e 7469 616c  self.substantial
+0001c8a0: 5f63 6861 6e67 6520 3d20 4661 6c73 650a  _change = False.
+0001c8b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001c8c0: 2e5f 7570 6461 7465 5f74 6173 6b5f 6578  ._update_task_ex
+0001c8d0: 6563 7574 696f 6e5f 6279 5f70 7265 6669  ecution_by_prefi
+0001c8e0: 785f 6368 6172 7428 290a 2020 2020 2020  x_chart().      
+0001c8f0: 2020 2020 2020 6669 6775 7265 735f 726f        figures_ro
+0001c900: 7720 3d20 726f 7728 0a20 2020 2020 2020  w = row(.       
+0001c910: 2020 2020 2020 2020 2063 6869 6c64 7265           childre
+0001c920: 6e3d 5b0a 2020 2020 2020 2020 2020 2020  n=[.            
+0001c930: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0001c940: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
+0001c950: 5f63 6861 7274 2c0a 2020 2020 2020 2020  _chart,.        
+0001c960: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001c970: 2e74 6173 6b5f 6578 6563 5f62 795f 6163  .task_exec_by_ac
+0001c980: 7469 7669 7479 5f63 6861 7274 2c0a 2020  tivity_chart,.  
+0001c990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c9a0: 2020 7365 6c66 2e67 6574 5f64 6174 615f    self.get_data_
+0001c9b0: 6279 5f61 6374 6976 6974 795f 6368 6172  by_activity_char
+0001c9c0: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+0001c9d0: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+0001c9e0: 2020 2020 2020 7369 7a69 6e67 5f6d 6f64        sizing_mod
+0001c9f0: 653d 2273 7472 6574 6368 5f77 6964 7468  e="stretch_width
+0001ca00: 222c 0a20 2020 2020 2020 2020 2020 2029  ",.            )
+0001ca10: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+0001ca20: 206e 6565 6473 5f66 6967 7572 6573 5f72   needs_figures_r
+0001ca30: 6f77 3a0a 2020 2020 2020 2020 2020 2020  ow:.            
+0001ca40: 2020 2020 2320 4669 7273 7420 6974 6572      # First iter
+0001ca50: 6174 696f 6e2c 2069 6e69 7469 616c 2061  ation, initial a
+0001ca60: 7373 6967 6e6d 656e 7420 6f66 2066 6967  ssignment of fig
+0001ca70: 7572 6573 2072 6f77 0a20 2020 2020 2020  ures row.       
+0001ca80: 2020 2020 2020 2020 2073 656c 662e 726f           self.ro
+0001ca90: 6f74 2e63 6869 6c64 7265 6e2e 6170 7065  ot.children.appe
+0001caa0: 6e64 2866 6967 7572 6573 5f72 6f77 290a  nd(figures_row).
+0001cab0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0001cac0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001cad0: 2020 2320 4f74 6865 7277 6973 6520 6e65    # Otherwise ne
+0001cae0: 6564 7320 666f 7263 6564 2072 6566 7265  eds forced refre
+0001caf0: 7368 2062 7920 7265 706c 6163 696e 6720  sh by replacing 
+0001cb00: 7468 6520 6669 6775 7265 7320 726f 770a  the figures row.
+0001cb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb20: 7365 6c66 2e72 6f6f 742e 6368 696c 6472  self.root.childr
+0001cb30: 656e 5b2d 315d 203d 2066 6967 7572 6573  en[-1] = figures
+0001cb40: 5f72 6f77 0a0a 2020 2020 6465 6620 5f75  _row..    def _u
+0001cb50: 7064 6174 655f 7365 6c65 6374 6f72 7328  pdate_selectors(
+0001cb60: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
+0001cb70: 2020 2020 2020 2022 2222 5570 6461 7465         """Update
+0001cb80: 2063 686f 6963 6573 2061 7661 696c 6162   choices availab
+0001cb90: 6c65 2069 6e0a 0a20 2020 2020 2020 202d  le in..        -
+0001cba0: 2073 656c 662e 756e 6974 5f73 656c 6563   self.unit_selec
+0001cbb0: 746f 720a 2020 2020 2020 2020 2d20 7365  tor.        - se
+0001cbc0: 6c66 2e66 756e 6374 696f 6e5f 7365 6c65  lf.function_sele
+0001cbd0: 6374 6f72 0a20 2020 2020 2020 202d 2073  ctor.        - s
+0001cbe0: 656c 662e 7370 616e 5f74 6167 5f73 656c  elf.span_tag_sel
+0001cbf0: 6563 746f 720a 2020 2020 2020 2020 2222  ector.        ""
+0001cc00: 220a 2020 2020 2020 2020 756e 6974 7320  ".        units 
+0001cc10: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+0001cc20: 6675 6e63 7469 6f6e 7320 3d20 7365 7428  functions = set(
+0001cc30: 290a 0a20 2020 2020 2020 2066 6f72 206b  )..        for k
+0001cc40: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
+0001cc50: 6572 2e63 756d 756c 6174 6976 655f 776f  er.cumulative_wo
+0001cc60: 726b 6572 5f6d 6574 7269 6373 3a0a 2020  rker_metrics:.  
+0001cc70: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0001cc80: 2069 7369 6e73 7461 6e63 6528 6b2c 2074   isinstance(k, t
+0001cc90: 7570 6c65 293a 0a20 2020 2020 2020 2020  uple):.         
+0001cca0: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0001ccb0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0001ccc0: 6578 742c 202a 6f74 6865 722c 2061 6374  ext, *other, act
+0001ccd0: 6976 6974 792c 2075 6e69 7420 3d20 6b0a  ivity, unit = k.
+0001cce0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+0001ccf0: 6572 7420 6973 696e 7374 616e 6365 2875  ert isinstance(u
+0001cd00: 6e69 742c 2073 7472 290a 2020 2020 2020  nit, str).      
+0001cd10: 2020 2020 2020 756e 6974 732e 6164 6428        units.add(
+0001cd20: 756e 6974 290a 0a20 2020 2020 2020 2020  unit)..         
+0001cd30: 2020 2069 6620 636f 6e74 6578 7420 3d3d     if context ==
+0001cd40: 2022 6578 6563 7574 6522 3a0a 2020 2020   "execute":.    
+0001cd50: 2020 2020 2020 2020 2020 2020 2866 756e              (fun
+0001cd60: 6374 696f 6e2c 2920 3d20 6f74 6865 720a  ction,) = other.
+0001cd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cd80: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0001cd90: 6528 6675 6e63 7469 6f6e 2c20 7374 7229  e(function, str)
+0001cda0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cdb0: 2066 756e 6374 696f 6e73 2e61 6464 2866   functions.add(f
+0001cdc0: 756e 6374 696f 6e29 0a0a 2020 2020 2020  unction)..      
+0001cdd0: 2020 756e 6974 732e 6469 6666 6572 656e    units.differen
+0001cde0: 6365 5f75 7064 6174 6528 7365 6c66 2e75  ce_update(self.u
+0001cdf0: 6e69 745f 7365 6c65 6374 6f72 2e6f 7074  nit_selector.opt
+0001ce00: 696f 6e73 290a 2020 2020 2020 2020 6966  ions).        if
+0001ce10: 2075 6e69 7473 3a0a 2020 2020 2020 2020   units:.        
+0001ce20: 2020 2020 7365 6c66 2e75 6e69 745f 7365      self.unit_se
+0001ce30: 6c65 6374 6f72 2e6f 7074 696f 6e73 2e65  lector.options.e
+0001ce40: 7874 656e 6428 756e 6974 7329 0a0a 2020  xtend(units)..  
+0001ce50: 2020 2020 2020 6966 2066 756e 6374 696f        if functio
+0001ce60: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+0001ce70: 2320 4164 6465 6420 6f6e 2074 6865 2066  # Added on the f
+0001ce80: 6c79 2062 7920 5370 616e 2e63 756d 756c  ly by Span.cumul
+0001ce90: 6174 6976 655f 776f 726b 6572 5f6d 6574  ative_worker_met
+0001cea0: 7269 6373 0a20 2020 2020 2020 2020 2020  rics.           
+0001ceb0: 2066 756e 6374 696f 6e73 2e61 6464 2822   functions.add("
+0001cec0: 4e2f 4122 290a 2020 2020 2020 2020 6675  N/A").        fu
+0001ced0: 6e63 7469 6f6e 732e 6469 6666 6572 656e  nctions.differen
+0001cee0: 6365 5f75 7064 6174 6528 7365 6c66 2e66  ce_update(self.f
+0001cef0: 756e 6374 696f 6e5f 7365 6c65 6374 6f72  unction_selector
+0001cf00: 2e6f 7074 696f 6e73 290a 2020 2020 2020  .options).      
+0001cf10: 2020 6966 2066 756e 6374 696f 6e73 3a0a    if functions:.
+0001cf20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001cf30: 2e66 756e 6374 696f 6e5f 7365 6c65 6374  .function_select
+0001cf40: 6f72 2e6f 7074 696f 6e73 2e65 7874 656e  or.options.exten
+0001cf50: 6428 6675 6e63 7469 6f6e 7329 0a20 2020  d(functions).   
+0001cf60: 2020 2020 2020 2020 2073 656c 662e 6675           self.fu
+0001cf70: 6e63 7469 6f6e 5f73 656c 6563 746f 722e  nction_selector.
+0001cf80: 7469 746c 6520 3d20 280a 2020 2020 2020  title = (.      
+0001cf90: 2020 2020 2020 2020 2020 6622 4669 6c74            f"Filt
+0001cfa0: 6572 2062 7920 6675 6e63 7469 6f6e 2028  er by function (
+0001cfb0: 7b6c 656e 2873 656c 662e 6675 6e63 7469  {len(self.functi
+0001cfc0: 6f6e 5f73 656c 6563 746f 722e 6f70 7469  on_selector.opti
+0001cfd0: 6f6e 7329 7d29 3a22 0a20 2020 2020 2020  ons)}):".       
+0001cfe0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0001cff0: 7370 616e 735f 6578 743a 2053 7061 6e73  spans_ext: Spans
+0001d000: 5363 6865 6475 6c65 7245 7874 656e 7369  SchedulerExtensi
+0001d010: 6f6e 207c 204e 6f6e 6520 3d20 7365 6c66  on | None = self
+0001d020: 2e73 6368 6564 756c 6572 2e65 7874 656e  .scheduler.exten
+0001d030: 7369 6f6e 732e 6765 7428 0a20 2020 2020  sions.get(.     
+0001d040: 2020 2020 2020 2022 7370 616e 7322 0a20         "spans". 
+0001d050: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001d060: 2069 6620 7370 616e 735f 6578 743a 0a20   if spans_ext:. 
+0001d070: 2020 2020 2020 2020 2020 2074 6167 7320             tags 
+0001d080: 3d20 7365 7428 7370 616e 735f 6578 742e  = set(spans_ext.
+0001d090: 7370 616e 735f 7365 6172 6368 5f62 795f  spans_search_by_
+0001d0a0: 7461 6729 0a20 2020 2020 2020 2020 2020  tag).           
+0001d0b0: 2074 6167 732e 6469 6666 6572 656e 6365   tags.difference
+0001d0c0: 5f75 7064 6174 6528 7365 6c66 2e73 7061  _update(self.spa
+0001d0d0: 6e5f 7461 675f 7365 6c65 6374 6f72 2e6f  n_tag_selector.o
+0001d0e0: 7074 696f 6e73 290a 2020 2020 2020 2020  ptions).        
+0001d0f0: 2020 2020 6966 2074 6167 733a 0a20 2020      if tags:.   
+0001d100: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001d110: 662e 7370 616e 5f74 6167 5f73 656c 6563  f.span_tag_selec
+0001d120: 746f 722e 6f70 7469 6f6e 732e 6578 7465  tor.options.exte
+0001d130: 6e64 2874 6167 7329 0a20 2020 2020 2020  nd(tags).       
+0001d140: 2020 2020 2020 2020 2073 656c 662e 7370           self.sp
+0001d150: 616e 5f74 6167 5f73 656c 6563 746f 722e  an_tag_selector.
+0001d160: 7469 746c 6520 3d20 280a 2020 2020 2020  title = (.      
+0001d170: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+0001d180: 4669 6c74 6572 2062 7920 7370 616e 2074  Filter by span t
+0001d190: 6167 2028 7b6c 656e 2873 656c 662e 7370  ag ({len(self.sp
+0001d1a0: 616e 5f74 6167 5f73 656c 6563 746f 722e  an_tag_selector.
+0001d1b0: 6f70 7469 6f6e 7329 7d29 3a22 0a20 2020  options)}):".   
+0001d1c0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
+0001d1d0: 2020 2020 6465 6620 5f62 6f6b 6568 5f75      def _bokeh_u
+0001d1e0: 6e69 745f 666f 726d 6174 2873 656c 6629  nit_format(self)
+0001d1f0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+0001d200: 2075 6e69 7420 3d20 7365 6c66 2e75 6e69   unit = self.uni
+0001d210: 745f 7365 6c65 6374 6f72 2e76 616c 7565  t_selector.value
+0001d220: 0a20 2020 2020 2020 2069 6620 756e 6974  .        if unit
+0001d230: 203d 3d20 2273 6563 6f6e 6473 223a 0a20   == "seconds":. 
+0001d240: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001d250: 6e20 2230 303a 3030 3a30 3022 0a20 2020  n "00:00:00".   
+0001d260: 2020 2020 2065 6c69 6620 756e 6974 203d       elif unit =
+0001d270: 3d20 2262 7974 6573 223a 0a20 2020 2020  = "bytes":.     
+0001d280: 2020 2020 2020 2072 6574 7572 6e20 2230         return "0
+0001d290: 2e30 3062 220a 2020 2020 2020 2020 656c  .00b".        el
+0001d2a0: 6966 2075 6e69 7420 3d3d 2022 636f 756e  if unit == "coun
+0001d2b0: 7422 3a0a 2020 2020 2020 2020 2020 2020  t":.            
+0001d2c0: 7265 7475 726e 2022 3022 0a20 2020 2020  return "0".     
+0001d2d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001d2e0: 2020 2020 2072 6574 7572 6e20 2230 2e30       return "0.0
+0001d2f0: 3030 220a 0a20 2020 2064 6566 205f 666f  00"..    def _fo
+0001d300: 726d 6174 2873 656c 662c 2076 616c 3a20  rmat(self, val: 
+0001d310: 666c 6f61 7429 202d 3e20 7374 723a 0a20  float) -> str:. 
+0001d320: 2020 2020 2020 2075 6e69 7420 3d20 7365         unit = se
+0001d330: 6c66 2e75 6e69 745f 7365 6c65 6374 6f72  lf.unit_selector
+0001d340: 2e76 616c 7565 0a20 2020 2020 2020 2069  .value.        i
+0001d350: 6620 756e 6974 203d 3d20 2273 6563 6f6e  f unit == "secon
+0001d360: 6473 223a 0a20 2020 2020 2020 2020 2020  ds":.           
+0001d370: 2072 6574 7572 6e20 666f 726d 6174 5f74   return format_t
+0001d380: 696d 6528 7661 6c29 0a20 2020 2020 2020  ime(val).       
+0001d390: 2065 6c69 6620 756e 6974 203d 3d20 2262   elif unit == "b
+0001d3a0: 7974 6573 223a 0a20 2020 2020 2020 2020  ytes":.         
+0001d3b0: 2020 2072 6574 7572 6e20 666f 726d 6174     return format
+0001d3c0: 5f62 7974 6573 2869 6e74 2876 616c 2929  _bytes(int(val))
+0001d3d0: 0a20 2020 2020 2020 2023 2063 6f75 6e74  .        # count
+0001d3e0: 206f 7220 6375 7374 6f6d 2075 7365 722d   or custom user-
+0001d3f0: 6465 6669 6e65 6420 6d65 7472 6963 0a20  defined metric. 
+0001d400: 2020 2020 2020 2065 6c69 6620 2869 7661         elif (iva
+0001d410: 6c20 3a3d 2069 6e74 2876 616c 2929 203d  l := int(val)) =
+0001d420: 3d20 7661 6c3a 0a20 2020 2020 2020 2020  = val:.         
+0001d430: 2020 2072 6574 7572 6e20 7374 7228 6976     return str(iv
+0001d440: 616c 290a 2020 2020 2020 2020 656c 7365  al).        else
+0001d450: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0001d460: 7475 726e 2073 7472 2876 616c 290a 0a20  turn str(val).. 
+0001d470: 2020 2064 6566 205f 6765 745f 7061 6c65     def _get_pale
+0001d480: 7474 6528 7365 6c66 2920 2d3e 206c 6973  tte(self) -> lis
+0001d490: 745b 7374 725d 3a0a 2020 2020 2020 2020  t[str]:.        
+0001d4a0: 6e20 3d20 6c65 6e28 7365 6c66 2e76 6973  n = len(self.vis
+0001d4b0: 6962 6c65 5f61 6374 6976 6974 6965 7329  ible_activities)
+0001d4c0: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+0001d4d0: 2020 2020 2020 2020 2020 6672 6f6d 2062            from b
+0001d4e0: 6f6b 6568 2e70 616c 6574 7465 7320 696d  okeh.palettes im
+0001d4f0: 706f 7274 2069 6e74 6572 705f 7061 6c65  port interp_pale
+0001d500: 7474 650a 0a20 2020 2020 2020 2020 2020  tte..           
+0001d510: 2072 6574 7572 6e20 6c69 7374 2869 6e74   return list(int
+0001d520: 6572 705f 7061 6c65 7474 6528 5669 7269  erp_palette(Viri
+0001d530: 6469 7331 312c 206e 2929 0a20 2020 2020  dis11, n)).     
+0001d540: 2020 2065 7863 6570 7420 496d 706f 7274     except Import
+0001d550: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0001d560: 2020 2023 2042 6f6b 6568 2032 2e34 0a20     # Bokeh 2.4. 
+0001d570: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001d580: 6e20 5b56 6972 6964 6973 3131 5b69 2025  n [Viridis11[i %
+0001d590: 206c 656e 2856 6972 6964 6973 3131 295d   len(Viridis11)]
+0001d5a0: 2066 6f72 2069 2069 6e20 7261 6e67 6528   for i in range(
+0001d5b0: 6e29 5d0a 0a20 2020 2064 6566 205f 6275  n)]..    def _bu
+0001d5c0: 696c 645f 6461 7461 5f73 6f75 7263 6573  ild_data_sources
+0001d5d0: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
+0001d5e0: 2020 2020 2020 2020 2222 2250 7265 2d70          """Pre-p
+0001d5f0: 726f 6365 7373 2061 6e64 2066 696c 7465  rocess and filte
+0001d600: 7220 6669 6e65 2070 6572 666f 726d 616e  r fine performan
+0001d610: 6365 206d 6574 7269 6373 3b20 6275 696c  ce metrics; buil
+0001d620: 6420 6461 7461 2074 6162 6c65 7320 696e  d data tables in
+0001d630: 0a20 2020 2020 2020 2042 6f6b 6568 2066  .        Bokeh f
+0001d640: 6f72 6d61 740a 0a20 2020 2020 2020 2055  ormat..        U
+0001d650: 7064 6174 6573 3a0a 0a20 2020 2020 2020  pdates:..       
+0001d660: 202d 2073 656c 662e 7375 6273 7461 6e74   - self.substant
+0001d670: 6961 6c5f 6368 616e 6765 0a20 2020 2020  ial_change.     
+0001d680: 2020 202d 2073 656c 662e 7669 7369 626c     - self.visibl
+0001d690: 655f 6163 7469 7669 7469 6573 0a20 2020  e_activities.   
+0001d6a0: 2020 2020 202d 2073 656c 662e 7669 7369       - self.visi
+0001d6b0: 626c 655f 6675 6e63 7469 6f6e 730a 2020  ble_functions.  
+0001d6c0: 2020 2020 2020 2d20 7365 6c66 2e74 6173        - self.tas
+0001d6d0: 6b5f 6578 6563 5f62 795f 7072 6566 6978  k_exec_by_prefix
+0001d6e0: 5f73 7263 2e64 6174 610a 2020 2020 2020  _src.data.      
+0001d6f0: 2020 2d20 7365 6c66 2e74 6173 6b5f 6578    - self.task_ex
+0001d700: 6563 5f62 795f 6163 7469 7669 7479 5f73  ec_by_activity_s
+0001d710: 7263 2e64 6174 610a 2020 2020 2020 2020  rc.data.        
+0001d720: 2d20 7365 6c66 2e67 6574 5f64 6174 615f  - self.get_data_
+0001d730: 6279 5f61 6374 6976 6974 795f 7372 632e  by_activity_src.
+0001d740: 6461 7461 0a20 2020 2020 2020 2022 2222  data.        """
+0001d750: 0a20 2020 2020 2020 2076 6973 6962 6c65  .        visible
+0001d760: 5f66 756e 6374 696f 6e73 203d 2073 6574  _functions = set
+0001d770: 2829 0a20 2020 2020 2020 2076 6973 6962  ().        visib
+0001d780: 6c65 5f61 6374 6976 6974 6965 7320 3d20  le_activities = 
+0001d790: 7365 7428 290a 2020 2020 2020 2020 6578  set().        ex
+0001d7a0: 6563 7574 655f 6279 5f66 756e 633a 2064  ecute_by_func: d
+0001d7b0: 6566 6175 6c74 6469 6374 5b74 7570 6c65  efaultdict[tuple
+0001d7c0: 5b73 7472 2c20 7374 725d 2c20 666c 6f61  [str, str], floa
+0001d7d0: 745d 203d 2064 6566 6175 6c74 6469 6374  t] = defaultdict
+0001d7e0: 2866 6c6f 6174 290a 2020 2020 2020 2020  (float).        
+0001d7f0: 6578 6563 7574 653a 2064 6566 6175 6c74  execute: default
+0001d800: 6469 6374 5b73 7472 2c20 666c 6f61 745d  dict[str, float]
+0001d810: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
+0001d820: 6c6f 6174 290a 2020 2020 2020 2020 6765  loat).        ge
+0001d830: 745f 6461 7461 3a20 6465 6661 756c 7464  t_data: defaultd
+0001d840: 6963 745b 7374 722c 2066 6c6f 6174 5d20  ict[str, float] 
+0001d850: 3d20 6465 6661 756c 7464 6963 7428 666c  = defaultdict(fl
+0001d860: 6f61 7429 0a0a 2020 2020 2020 2020 6675  oat)..        fu
+0001d870: 6e63 7469 6f6e 5f73 656c 203d 2073 6574  nction_sel = set
+0001d880: 2873 656c 662e 6675 6e63 7469 6f6e 5f73  (self.function_s
+0001d890: 656c 6563 746f 722e 7661 6c75 6529 0a0a  elector.value)..
+0001d8a0: 2020 2020 2020 2020 7370 616e 735f 6578          spans_ex
+0001d8b0: 743a 2053 7061 6e73 5363 6865 6475 6c65  t: SpansSchedule
+0001d8c0: 7245 7874 656e 7369 6f6e 207c 204e 6f6e  rExtension | Non
+0001d8d0: 6520 3d20 7365 6c66 2e73 6368 6564 756c  e = self.schedul
+0001d8e0: 6572 2e65 7874 656e 7369 6f6e 732e 6765  er.extensions.ge
+0001d8f0: 7428 0a20 2020 2020 2020 2020 2020 2022  t(.            "
+0001d900: 7370 616e 7322 0a20 2020 2020 2020 2029  spans".        )
+0001d910: 0a20 2020 2020 2020 2069 6620 7370 616e  .        if span
+0001d920: 735f 6578 7420 616e 6420 7365 6c66 2e73  s_ext and self.s
+0001d930: 7061 6e5f 7461 675f 7365 6c65 6374 6f72  pan_tag_selector
+0001d940: 2e76 616c 7565 3a0a 2020 2020 2020 2020  .value:.        
+0001d950: 2020 2020 7370 616e 203d 2073 7061 6e73      span = spans
+0001d960: 5f65 7874 2e6d 6572 6765 5f62 795f 7461  _ext.merge_by_ta
+0001d970: 6773 282a 7365 6c66 2e73 7061 6e5f 7461  gs(*self.span_ta
+0001d980: 675f 7365 6c65 6374 6f72 2e76 616c 7565  g_selector.value
+0001d990: 290a 2020 2020 2020 2020 2020 2020 6d65  ).            me
+0001d9a0: 7472 6963 7320 3d20 7370 616e 2e63 756d  trics = span.cum
+0001d9b0: 756c 6174 6976 655f 776f 726b 6572 5f6d  ulative_worker_m
+0001d9c0: 6574 7269 6373 0a20 2020 2020 2020 2065  etrics.        e
+0001d9d0: 6c69 6620 7370 616e 735f 6578 7420 616e  lif spans_ext an
+0001d9e0: 6420 7370 616e 735f 6578 742e 7370 616e  d spans_ext.span
+0001d9f0: 733a 0a20 2020 2020 2020 2020 2020 2023  s:.            #
+0001da00: 2043 616c 6375 6c61 7465 2069 646c 6520   Calculate idle 
+0001da10: 7469 6d65 0a20 2020 2020 2020 2020 2020  time.           
+0001da20: 2073 7061 6e20 3d20 7370 616e 735f 6578   span = spans_ex
+0001da30: 742e 6d65 7267 655f 616c 6c28 290a 2020  t.merge_all().  
+0001da40: 2020 2020 2020 2020 2020 6d65 7472 6963            metric
+0001da50: 7320 3d20 7370 616e 2e63 756d 756c 6174  s = span.cumulat
+0001da60: 6976 655f 776f 726b 6572 5f6d 6574 7269  ive_worker_metri
+0001da70: 6373 0a20 2020 2020 2020 2065 6c73 653a  cs.        else:
+0001da80: 0a20 2020 2020 2020 2020 2020 2023 2053  .            # S
+0001da90: 7061 6e73 2065 7874 656e 7369 6f6e 2069  pans extension i
+0001daa0: 7320 6e6f 7420 6c6f 6164 6564 0a20 2020  s not loaded.   
+0001dab0: 2020 2020 2020 2020 206d 6574 7269 6373           metrics
+0001dac0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+0001dad0: 2020 2020 206b 3a20 760a 2020 2020 2020       k: v.      
+0001dae0: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
+0001daf0: 2076 2069 6e20 7365 6c66 2e73 6368 6564   v in self.sched
+0001db00: 756c 6572 2e63 756d 756c 6174 6976 655f  uler.cumulative_
+0001db10: 776f 726b 6572 5f6d 6574 7269 6373 2e69  worker_metrics.i
+0001db20: 7465 6d73 2829 0a20 2020 2020 2020 2020  tems().         
+0001db30: 2020 2020 2020 2069 6620 6973 696e 7374         if isinst
+0001db40: 616e 6365 286b 2c20 7475 706c 6529 0a20  ance(k, tuple). 
+0001db50: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0001db60: 6e64 206c 656e 286b 2920 3d3d 2034 2020  nd len(k) == 4  
+0001db70: 2320 536b 6970 2067 6574 2d64 6174 612c  # Skip get-data,
+0001db80: 2067 6174 6865 722d 6465 7073 2c20 616e   gather-deps, an
+0001db90: 6420 6d65 6d6f 7279 2d6d 6f6e 6974 6f72  d memory-monitor
+0001dba0: 0a20 2020 2020 2020 2020 2020 207d 0a0a  .            }..
+0001dbb0: 2020 2020 2020 2020 666f 7220 2863 6f6e          for (con
+0001dbc0: 7465 7874 2c20 6675 6e63 7469 6f6e 2c20  text, function, 
+0001dbd0: 6163 7469 7669 7479 2c20 756e 6974 292c  activity, unit),
+0001dbe0: 2076 2069 6e20 6d65 7472 6963 732e 6974   v in metrics.it
+0001dbf0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+0001dc00: 2020 2069 6620 636f 6e74 6578 7420 213d     if context !=
+0001dc10: 2022 6578 6563 7574 6522 3a0a 2020 2020   "execute":.    
+0001dc20: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0001dc30: 696e 7565 2020 2320 544f 444f 2076 6973  inue  # TODO vis
+0001dc40: 7561 6c69 7a65 2027 7368 7566 666c 6527  ualize 'shuffle'
+0001dc50: 206d 6574 7269 6373 0a20 2020 2020 2020   metrics.       
+0001dc60: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+0001dc70: 7374 616e 6365 2866 756e 6374 696f 6e2c  stance(function,
+0001dc80: 2073 7472 290a 2020 2020 2020 2020 2020   str).          
+0001dc90: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+0001dca0: 6e63 6528 756e 6974 2c20 7374 7229 0a20  nce(unit, str). 
+0001dcb0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0001dcc0: 7420 7365 6c66 2e75 6e69 745f 7365 6c65  t self.unit_sele
+0001dcd0: 6374 6f72 2e76 616c 7565 0a20 2020 2020  ctor.value.     
+0001dce0: 2020 2020 2020 2069 6620 756e 6974 2021         if unit !
+0001dcf0: 3d20 7365 6c66 2e75 6e69 745f 7365 6c65  = self.unit_sele
+0001dd00: 6374 6f72 2e76 616c 7565 3a0a 2020 2020  ctor.value:.    
+0001dd10: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+0001dd20: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+0001dd30: 2069 6620 6675 6e63 7469 6f6e 5f73 656c   if function_sel
+0001dd40: 2061 6e64 2066 756e 6374 696f 6e20 6e6f   and function no
+0001dd50: 7420 696e 2066 756e 6374 696f 6e5f 7365  t in function_se
+0001dd60: 6c3a 0a20 2020 2020 2020 2020 2020 2020  l:.             
+0001dd70: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+0001dd80: 2020 2020 2020 2020 2023 2043 7573 746f           # Custo
+0001dd90: 6d20 6d65 7472 6963 7320 776f 6e27 7420  m metrics won't 
+0001dda0: 6e65 6365 7373 6172 696c 7920 636f 6e74  necessarily cont
+0001ddb0: 6169 6e20 6120 7374 7269 6e67 2061 7320  ain a string as 
+0001ddc0: 7468 6520 6c61 6265 6c0a 2020 2020 2020  the label.      
+0001ddd0: 2020 2020 2020 6163 7469 7669 7479 203d        activity =
+0001dde0: 2073 7472 2861 6374 6976 6974 7929 0a0a   str(activity)..
+0001ddf0: 2020 2020 2020 2020 2020 2020 2320 544f              # TO
+0001de00: 444f 2057 6520 636f 756c 6420 696d 706c  DO We could impl
+0001de10: 656d 656e 7420 736f 6d65 2066 616e 6379  ement some fancy
+0001de20: 206c 6f67 6963 2069 6e20 7370 616e 732e   logic in spans.
+0001de30: 7079 2074 6f20 6368 616e 6765 2074 6865  py to change the
+0001de40: 206c 6162 656c 0a20 2020 2020 2020 2020   label.         
+0001de50: 2020 2023 2020 2020 2020 6966 206e 6f20     #      if no 
+0001de60: 6f74 6865 7220 7370 616e 7320 6172 6520  other spans are 
+0001de70: 7275 6e6e 696e 6720 6174 2074 6865 2073  running at the s
+0001de80: 616d 6520 7469 6d65 2e0a 2020 2020 2020  ame time..      
+0001de90: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+0001dea0: 662e 7370 616e 5f74 6167 5f73 656c 6563  f.span_tag_selec
+0001deb0: 746f 722e 7661 6c75 6520 616e 6420 6163  tor.value and ac
+0001dec0: 7469 7669 7479 203d 3d20 2269 646c 6520  tivity == "idle 
+0001ded0: 6f72 206f 7468 6572 2073 7061 6e73 223a  or other spans":
+0001dee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001def0: 2061 6374 6976 6974 7920 3d20 2269 646c   activity = "idl
+0001df00: 6522 0a0a 2020 2020 2020 2020 2020 2020  e"..            
+0001df10: 6578 6563 7574 655f 6279 5f66 756e 635b  execute_by_func[
+0001df20: 6675 6e63 7469 6f6e 2c20 6163 7469 7669  function, activi
+0001df30: 7479 5d20 2b3d 2076 0a20 2020 2020 2020  ty] += v.       
+0001df40: 2020 2020 2065 7865 6375 7465 5b61 6374       execute[act
+0001df50: 6976 6974 795d 202b 3d20 760a 2020 2020  ivity] += v.    
+0001df60: 2020 2020 2020 2020 7669 7369 626c 655f          visible_
+0001df70: 6675 6e63 7469 6f6e 732e 6164 6428 6675  functions.add(fu
+0001df80: 6e63 7469 6f6e 290a 2020 2020 2020 2020  nction).        
+0001df90: 2020 2020 7669 7369 626c 655f 6163 7469      visible_acti
+0001dfa0: 7669 7469 6573 2e61 6464 2861 6374 6976  vities.add(activ
+0001dfb0: 6974 7929 0a0a 2020 2020 2020 2020 6966  ity)..        if
+0001dfc0: 206e 6f74 2073 656c 662e 6675 6e63 7469   not self.functi
+0001dfd0: 6f6e 5f73 656c 6563 746f 722e 7661 6c75  on_selector.valu
+0001dfe0: 6520 616e 6420 6e6f 7420 7365 6c66 2e73  e and not self.s
+0001dff0: 7061 6e5f 7461 675f 7365 6c65 6374 6f72  pan_tag_selector
+0001e000: 2e76 616c 7565 3a0a 2020 2020 2020 2020  .value:.        
+0001e010: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
+0001e020: 7365 6c66 2e73 6368 6564 756c 6572 2e63  self.scheduler.c
+0001e030: 756d 756c 6174 6976 655f 776f 726b 6572  umulative_worker
+0001e040: 5f6d 6574 7269 6373 2e69 7465 6d73 2829  _metrics.items()
+0001e050: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e060: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+0001e070: 6b2c 2074 7570 6c65 2920 616e 6420 6b5b  k, tuple) and k[
+0001e080: 305d 203d 3d20 2267 6574 2d64 6174 6122  0] == "get-data"
+0001e090: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001e0a0: 2020 2020 2020 5f2c 2061 6374 6976 6974        _, activit
+0001e0b0: 792c 2075 6e69 7420 3d20 6b0a 2020 2020  y, unit = k.    
+0001e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e0d0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+0001e0e0: 6528 6163 7469 7669 7479 2c20 7374 7229  e(activity, str)
+0001e0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001e100: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+0001e110: 7374 616e 6365 2875 6e69 742c 2073 7472  stance(unit, str
+0001e120: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001e130: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+0001e140: 662e 756e 6974 5f73 656c 6563 746f 722e  f.unit_selector.
+0001e150: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+0001e160: 2020 2020 2020 2020 2020 6966 2075 6e69            if uni
+0001e170: 7420 3d3d 2073 656c 662e 756e 6974 5f73  t == self.unit_s
+0001e180: 656c 6563 746f 722e 7661 6c75 653a 0a20  elector.value:. 
+0001e190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e1a0: 2020 2020 2020 2076 6973 6962 6c65 5f61         visible_a
+0001e1b0: 6374 6976 6974 6965 732e 6164 6428 6163  ctivities.add(ac
+0001e1c0: 7469 7669 7479 290a 2020 2020 2020 2020  tivity).        
+0001e1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e1e0: 6765 745f 6461 7461 5b61 6374 6976 6974  get_data[activit
+0001e1f0: 795d 202b 3d20 760a 0a20 2020 2020 2020  y] += v..       
+0001e200: 2020 2020 2023 2049 676e 6f72 6520 6d65       # Ignore me
+0001e210: 6d6f 7279 2d6d 6f6e 6974 6f72 2061 6e64  mory-monitor and
+0001e220: 2067 6174 6865 722d 6465 7020 6d65 7472   gather-dep metr
+0001e230: 6963 730a 0a20 2020 2020 2020 2069 6620  ics..        if 
+0001e240: 7669 7369 626c 655f 6675 6e63 7469 6f6e  visible_function
+0001e250: 7320 213d 2073 6574 2873 656c 662e 7669  s != set(self.vi
+0001e260: 7369 626c 655f 6675 6e63 7469 6f6e 7329  sible_functions)
+0001e270: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001e280: 6c66 2e73 7562 7374 616e 7469 616c 5f63  lf.substantial_c
+0001e290: 6861 6e67 6520 3d20 5472 7565 0a20 2020  hange = True.   
+0001e2a0: 2020 2020 2020 2020 2073 656c 662e 7669           self.vi
+0001e2b0: 7369 626c 655f 6675 6e63 7469 6f6e 7320  sible_functions 
+0001e2c0: 3d20 736f 7274 6564 2876 6973 6962 6c65  = sorted(visible
+0001e2d0: 5f66 756e 6374 696f 6e73 290a 0a20 2020  _functions)..   
+0001e2e0: 2020 2020 2069 6620 7669 7369 626c 655f       if visible_
+0001e2f0: 6163 7469 7669 7469 6573 2021 3d20 7365  activities != se
+0001e300: 7428 7365 6c66 2e76 6973 6962 6c65 5f61  t(self.visible_a
+0001e310: 6374 6976 6974 6965 7329 3a0a 2020 2020  ctivities):.    
+0001e320: 2020 2020 2020 2020 7365 6c66 2e76 6973          self.vis
+0001e330: 6962 6c65 5f61 6374 6976 6974 6965 7320  ible_activities 
+0001e340: 3d20 736f 7274 6564 2876 6973 6962 6c65  = sorted(visible
+0001e350: 5f61 6374 6976 6974 6965 7329 0a0a 2020  _activities)..  
+0001e360: 2020 2020 2020 280a 2020 2020 2020 2020        (.        
+0001e370: 2020 2020 7365 6c66 2e74 6173 6b5f 6578      self.task_ex
+0001e380: 6563 5f62 795f 7072 6566 6978 5f73 7263  ec_by_prefix_src
+0001e390: 2e64 6174 612c 0a20 2020 2020 2020 2020  .data,.         
+0001e3a0: 2020 2073 656c 662e 7461 736b 5f65 7865     self.task_exe
+0001e3b0: 635f 6279 5f70 7265 6669 785f 786d 6178  c_by_prefix_xmax
+0001e3c0: 2c0a 2020 2020 2020 2020 2920 3d20 7365  ,.        ) = se
+0001e3d0: 6c66 2e5f 6275 696c 645f 7461 736b 5f65  lf._build_task_e
+0001e3e0: 7865 6375 7469 6f6e 5f62 795f 7072 6566  xecution_by_pref
+0001e3f0: 6978 5f64 6174 6128 6578 6563 7574 655f  ix_data(execute_
+0001e400: 6279 5f66 756e 6329 0a20 2020 2020 2020  by_func).       
+0001e410: 2073 656c 662e 7461 736b 5f65 7865 635f   self.task_exec_
+0001e420: 6279 5f61 6374 6976 6974 795f 7372 632e  by_activity_src.
+0001e430: 6461 7461 203d 2073 656c 662e 5f62 7569  data = self._bui
+0001e440: 6c64 5f70 6965 5f64 6174 6128 6578 6563  ld_pie_data(exec
+0001e450: 7574 6529 0a20 2020 2020 2020 2073 656c  ute).        sel
+0001e460: 662e 6765 745f 6461 7461 5f62 795f 6163  f.get_data_by_ac
+0001e470: 7469 7669 7479 5f73 7263 2e64 6174 6120  tivity_src.data 
+0001e480: 3d20 7365 6c66 2e5f 6275 696c 645f 7069  = self._build_pi
+0001e490: 655f 6461 7461 2867 6574 5f64 6174 6129  e_data(get_data)
+0001e4a0: 0a0a 2020 2020 6465 6620 5f62 7569 6c64  ..    def _build
+0001e4b0: 5f70 6965 5f64 6174 6128 7365 6c66 2c20  _pie_data(self, 
+0001e4c0: 6461 7461 3a20 6465 6661 756c 7464 6963  data: defaultdic
+0001e4d0: 745b 7374 722c 2066 6c6f 6174 5d29 202d  t[str, float]) -
+0001e4e0: 3e20 6469 6374 5b73 7472 2c20 6c69 7374  > dict[str, list
+0001e4f0: 5d3a 0a20 2020 2020 2020 2022 2222 4275  ]:.        """Bu
+0001e500: 696c 6420 7468 6520 6461 7461 2073 6f75  ild the data sou
+0001e510: 7263 6520 666f 7220 6120 7069 6520 6368  rce for a pie ch
+0001e520: 6172 7420 6279 2061 6374 6976 6974 790a  art by activity.
+0001e530: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
+0001e540: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+0001e550: 2d2d 0a20 2020 2020 2020 205f 6275 696c  --.        _buil
+0001e560: 645f 7069 655f 6368 6172 740a 2020 2020  d_pie_chart.    
+0001e570: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001e580: 6163 7469 7669 7469 6573 203d 2073 656c  activities = sel
+0001e590: 662e 7669 7369 626c 655f 6163 7469 7669  f.visible_activi
+0001e5a0: 7469 6573 0a20 2020 2020 2020 2023 2047  ties.        # G
+0001e5b0: 656e 6572 6174 6520 7061 6c65 7474 6520  enerate palette 
+0001e5c0: 6261 7365 6420 6f6e 2061 6c6c 2076 6973  based on all vis
+0001e5d0: 6962 6c65 2061 6374 6976 6974 6965 7320  ible activities 
+0001e5e0: 746f 206d 616b 6520 7375 7265 2074 6861  to make sure tha
+0001e5f0: 740a 2020 2020 2020 2020 2320 636f 6c6f  t.        # colo
+0001e600: 7273 206d 6174 6368 2062 6574 7765 656e  rs match between
+0001e610: 2074 6865 2070 6c6f 7473 0a20 2020 2020   the plots.     
+0001e620: 2020 2070 616c 6574 7465 203d 2073 656c     palette = sel
+0001e630: 662e 5f67 6574 5f70 616c 6574 7465 2829  f._get_palette()
+0001e640: 0a20 2020 2020 2020 2076 616c 7565 7320  .        values 
+0001e650: 3d20 5b64 6174 615b 6163 7469 7669 7479  = [data[activity
+0001e660: 5d20 666f 7220 6163 7469 7669 7479 2069  ] for activity i
+0001e670: 6e20 6163 7469 7669 7469 6573 5d0a 0a20  n activities].. 
+0001e680: 2020 2020 2020 2023 2053 6f72 7420 6279         # Sort by
+0001e690: 2076 616c 7565 7320 6672 6f6d 206c 6172   values from lar
+0001e6a0: 6765 7374 2074 6f20 736d 616c 6c65 7374  gest to smallest
+0001e6b0: 0a20 2020 2020 2020 2023 2048 6964 6520  .        # Hide 
+0001e6c0: 6163 7469 7669 7469 6573 2074 6861 7420  activities that 
+0001e6d0: 6172 6520 6d69 7373 696e 6720 696e 2074  are missing in t
+0001e6e0: 6865 2063 7572 7265 6e74 2070 6c6f 7420  he current plot 
+0001e6f0: 6672 6f6d 2074 6865 206c 6567 656e 640a  from the legend.
+0001e700: 2020 2020 2020 2020 6964 7820 3d20 5b69          idx = [i
+0001e710: 2066 6f72 2069 2c20 7620 696e 2073 6f72   for i, v in sor
+0001e720: 7465 6428 656e 756d 6572 6174 6528 7661  ted(enumerate(va
+0001e730: 6c75 6573 292c 206b 6579 3d6c 616d 6264  lues), key=lambd
+0001e740: 6120 656c 3a20 2d65 6c5b 315d 2920 6966  a el: -el[1]) if
+0001e750: 2076 5d0a 2020 2020 2020 2020 6163 7469   v].        acti
+0001e760: 7669 7469 6573 203d 205b 6163 7469 7669  vities = [activi
+0001e770: 7469 6573 5b69 5d20 666f 7220 6920 696e  ties[i] for i in
+0001e780: 2069 6478 5d0a 2020 2020 2020 2020 7061   idx].        pa
+0001e790: 6c65 7474 6520 3d20 5b70 616c 6574 7465  lette = [palette
+0001e7a0: 5b69 5d20 666f 7220 6920 696e 2069 6478  [i] for i in idx
+0001e7b0: 5d0a 2020 2020 2020 2020 7661 6c75 6573  ].        values
+0001e7c0: 203d 205b 7661 6c75 6573 5b69 5d20 666f   = [values[i] fo
+0001e7d0: 7220 6920 696e 2069 6478 5d0a 0a20 2020  r i in idx]..   
+0001e7e0: 2020 2020 2074 6f74 616c 5f76 616c 7565       total_value
+0001e7f0: 203d 2073 756d 2876 616c 7565 7329 0a20   = sum(values). 
+0001e800: 2020 2020 2020 2074 6f74 616c 5f74 6578         total_tex
+0001e810: 7420 3d20 7365 6c66 2e5f 666f 726d 6174  t = self._format
+0001e820: 2874 6f74 616c 5f76 616c 7565 290a 2020  (total_value).  
+0001e830: 2020 2020 2020 7065 7263 656e 745f 6b20        percent_k 
+0001e840: 3d20 3130 302e 3020 2f20 746f 7461 6c5f  = 100.0 / total_
+0001e850: 7661 6c75 6520 6966 2074 6f74 616c 5f76  value if total_v
+0001e860: 616c 7565 2065 6c73 6520 302e 300a 2020  alue else 0.0.  
+0001e870: 2020 2020 2020 616e 676c 655f 6b20 3d20        angle_k = 
+0001e880: 322e 3020 2a20 6d61 7468 2e70 6920 2f20  2.0 * math.pi / 
+0001e890: 746f 7461 6c5f 7661 6c75 6520 6966 2074  total_value if t
+0001e8a0: 6f74 616c 5f76 616c 7565 2065 6c73 6520  otal_value else 
+0001e8b0: 302e 300a 2020 2020 2020 2020 7265 7475  0.0.        retu
+0001e8c0: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
+0001e8d0: 2022 6163 7469 7669 7479 223a 2061 6374   "activity": act
+0001e8e0: 6976 6974 6965 732c 0a20 2020 2020 2020  ivities,.       
+0001e8f0: 2020 2020 2022 7661 6c75 6522 3a20 7661       "value": va
+0001e900: 6c75 6573 2c0a 2020 2020 2020 2020 2020  lues,.          
+0001e910: 2020 2274 6578 7422 3a20 5b73 656c 662e    "text": [self.
+0001e920: 5f66 6f72 6d61 7428 7629 202b 2066 2220  _format(v) + f" 
+0001e930: 287b 7620 2a20 7065 7263 656e 745f 6b3a  ({v * percent_k:
+0001e940: 2e30 667d 2529 2220 666f 7220 7620 696e  .0f}%)" for v in
+0001e950: 2076 616c 7565 735d 2c0a 2020 2020 2020   values],.      
+0001e960: 2020 2020 2020 2261 6e67 6c65 223a 205b        "angle": [
+0001e970: 7620 2a20 616e 676c 655f 6b20 666f 7220  v * angle_k for 
+0001e980: 7620 696e 2076 616c 7565 735d 2c0a 2020  v in values],.  
+0001e990: 2020 2020 2020 2020 2020 2263 6f6c 6f72            "color
+0001e9a0: 223a 2070 616c 6574 7465 2c0a 2020 2020  ": palette,.    
+0001e9b0: 2020 2020 2020 2020 2274 6f74 616c 5f74          "total_t
+0001e9c0: 6578 7422 3a20 5b74 6f74 616c 5f74 6578  ext": [total_tex
+0001e9d0: 745d 202a 206c 656e 2876 616c 7565 7329  t] * len(values)
+0001e9e0: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
+0001e9f0: 2064 6566 205f 6275 696c 645f 7069 655f   def _build_pie_
+0001ea00: 6368 6172 7428 7365 6c66 2c20 736f 7572  chart(self, sour
+0001ea10: 6365 3a20 436f 6c75 6d6e 4461 7461 536f  ce: ColumnDataSo
+0001ea20: 7572 6365 2c20 7469 746c 653a 2073 7472  urce, title: str
+0001ea30: 2920 2d3e 2066 6967 7572 653a 0a20 2020  ) -> figure:.   
+0001ea40: 2020 2020 2022 2222 4372 6561 7465 2070       """Create p
+0001ea50: 6965 2063 6861 7274 2062 7920 6163 7469  ie chart by acti
+0001ea60: 7669 7479 0a0a 2020 2020 2020 2020 5365  vity..        Se
+0001ea70: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
+0001ea80: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+0001ea90: 5f62 7569 6c64 5f70 6965 5f64 6174 610a  _build_pie_data.
+0001eaa0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001eab0: 2020 2020 7069 6563 6861 7274 203d 2066      piechart = f
+0001eac0: 6967 7572 6528 0a20 2020 2020 2020 2020  igure(.         
+0001ead0: 2020 2068 6569 6768 743d 3530 302c 0a20     height=500,. 
+0001eae0: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
+0001eaf0: 675f 6d6f 6465 3d22 7363 616c 655f 626f  g_mode="scale_bo
+0001eb00: 7468 222c 0a20 2020 2020 2020 2020 2020  th",.           
+0001eb10: 2074 6974 6c65 3d74 6974 6c65 2c0a 2020   title=title,.  
+0001eb20: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+0001eb30: 2268 6f76 6572 222c 0a20 2020 2020 2020  "hover",.       
+0001eb40: 2020 2020 2074 6f6f 6c74 6970 733d 2240       tooltips="@
+0001eb50: 7b61 6374 6976 6974 797d 3a20 4074 6578  {activity}: @tex
+0001eb60: 743c 6272 3e74 6f74 616c 3a20 407b 746f  t<br>total: @{to
+0001eb70: 7461 6c5f 7465 7874 7d22 2c0a 2020 2020  tal_text}",.    
+0001eb80: 2020 2020 2020 2020 785f 7261 6e67 653d          x_range=
+0001eb90: 282d 302e 352c 2031 2e30 292c 0a20 2020  (-0.5, 1.0),.   
+0001eba0: 2020 2020 2029 0a20 2020 2020 2020 2070       ).        p
+0001ebb0: 6965 6368 6172 742e 6178 6973 2e61 7869  iechart.axis.axi
+0001ebc0: 735f 6c61 6265 6c20 3d20 4e6f 6e65 0a20  s_label = None. 
+0001ebd0: 2020 2020 2020 2070 6965 6368 6172 742e         piechart.
+0001ebe0: 6178 6973 2e76 6973 6962 6c65 203d 2046  axis.visible = F
+0001ebf0: 616c 7365 0a20 2020 2020 2020 2070 6965  alse.        pie
+0001ec00: 6368 6172 742e 6772 6964 2e67 7269 645f  chart.grid.grid_
+0001ec10: 6c69 6e65 5f63 6f6c 6f72 203d 204e 6f6e  line_color = Non
+0001ec20: 650a 0a20 2020 2020 2020 2070 6965 6368  e..        piech
+0001ec30: 6172 742e 7765 6467 6528 0a20 2020 2020  art.wedge(.     
+0001ec40: 2020 2020 2020 2078 3d30 2c0a 2020 2020         x=0,.    
+0001ec50: 2020 2020 2020 2020 793d 312c 0a20 2020          y=1,.   
+0001ec60: 2020 2020 2020 2020 2072 6164 6975 733d           radius=
+0001ec70: 302e 342c 0a20 2020 2020 2020 2020 2020  0.4,.           
+0001ec80: 2073 7461 7274 5f61 6e67 6c65 3d63 756d   start_angle=cum
+0001ec90: 7375 6d28 2261 6e67 6c65 222c 2069 6e63  sum("angle", inc
+0001eca0: 6c75 6465 5f7a 6572 6f3d 5472 7565 292c  lude_zero=True),
+0001ecb0: 0a20 2020 2020 2020 2020 2020 2065 6e64  .            end
+0001ecc0: 5f61 6e67 6c65 3d63 756d 7375 6d28 2261  _angle=cumsum("a
+0001ecd0: 6e67 6c65 2229 2c0a 2020 2020 2020 2020  ngle"),.        
+0001ece0: 2020 2020 6c69 6e65 5f63 6f6c 6f72 3d22      line_color="
+0001ecf0: 7768 6974 6522 2c0a 2020 2020 2020 2020  white",.        
+0001ed00: 2020 2020 6669 6c6c 5f63 6f6c 6f72 3d22      fill_color="
+0001ed10: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
+0001ed20: 2020 2020 6c65 6765 6e64 5f66 6965 6c64      legend_field
+0001ed30: 3d22 6163 7469 7669 7479 222c 0a20 2020  ="activity",.   
+0001ed40: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+0001ed50: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+0001ed60: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+0001ed70: 2070 6965 6368 6172 740a 0a20 2020 2064   piechart..    d
+0001ed80: 6566 205f 6275 696c 645f 7461 736b 5f65  ef _build_task_e
+0001ed90: 7865 6375 7469 6f6e 5f62 795f 7072 6566  xecution_by_pref
+0001eda0: 6978 5f64 6174 6128 0a20 2020 2020 2020  ix_data(.       
+0001edb0: 2073 656c 662c 2064 6174 613a 2064 6566   self, data: def
+0001edc0: 6175 6c74 6469 6374 5b74 7570 6c65 5b73  aultdict[tuple[s
+0001edd0: 7472 2c20 7374 725d 2c20 666c 6f61 745d  tr, str], float]
+0001ede0: 0a20 2020 2029 202d 3e20 7475 706c 655b  .    ) -> tuple[
+0001edf0: 6469 6374 5b73 7472 2c20 6c69 7374 5d2c  dict[str, list],
+0001ee00: 2066 6c6f 6174 5d3a 0a20 2020 2020 2020   float]:.       
+0001ee10: 2022 2222 4275 696c 6420 7468 6520 6461   """Build the da
+0001ee20: 7461 2073 6f75 7263 6520 666f 7220 7468  ta source for th
+0001ee30: 6520 6578 6563 7574 6520 6279 2066 756e  e execute by fun
+0001ee40: 6374 696f 6e20 7374 6163 6b65 6420 6368  ction stacked ch
+0001ee50: 6172 740a 0a20 2020 2020 2020 2053 6565  art..        See
+0001ee60: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
+0001ee70: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 205f  ------.        _
+0001ee80: 6275 696c 645f 7461 736b 5f65 7865 6375  build_task_execu
+0001ee90: 7469 6f6e 5f62 795f 7072 6566 6978 5f63  tion_by_prefix_c
+0001eea0: 6861 7274 0a20 2020 2020 2020 205f 7570  hart.        _up
+0001eeb0: 6461 7465 5f74 6173 6b5f 6578 6563 7574  date_task_execut
+0001eec0: 696f 6e5f 6279 5f70 7265 6669 785f 6368  ion_by_prefix_ch
+0001eed0: 6172 740a 2020 2020 2020 2020 2222 220a  art.        """.
+0001eee0: 2020 2020 2020 2020 6675 6e63 5f74 6f74          func_tot
+0001eef0: 616c 7320 3d20 5b0a 2020 2020 2020 2020  als = [.        
+0001ef00: 2020 2020 7375 6d28 6461 7461 5b66 756e      sum(data[fun
+0001ef10: 6374 696f 6e2c 2061 6374 6976 6974 795d  ction, activity]
+0001ef20: 2066 6f72 2061 6374 6976 6974 7920 696e   for activity in
+0001ef30: 2073 656c 662e 7669 7369 626c 655f 6163   self.visible_ac
+0001ef40: 7469 7669 7469 6573 290a 2020 2020 2020  tivities).      
+0001ef50: 2020 2020 2020 666f 7220 6675 6e63 7469        for functi
+0001ef60: 6f6e 2069 6e20 7365 6c66 2e76 6973 6962  on in self.visib
+0001ef70: 6c65 5f66 756e 6374 696f 6e73 0a20 2020  le_functions.   
+0001ef80: 2020 2020 205d 0a20 2020 2020 2020 2070       ].        p
+0001ef90: 6572 635f 6b20 3d20 5b31 3030 2e30 202f  erc_k = [100.0 /
+0001efa0: 2076 2069 6620 7620 656c 7365 2030 2e30   v if v else 0.0
+0001efb0: 2066 6f72 2076 2069 6e20 6675 6e63 5f74   for v in func_t
+0001efc0: 6f74 616c 735d 0a20 2020 2020 2020 206f  otals].        o
+0001efd0: 7574 3a20 6469 6374 5b73 7472 2c20 6c69  ut: dict[str, li
+0001efe0: 7374 5d20 3d20 7b0a 2020 2020 2020 2020  st] = {.        
+0001eff0: 2020 2020 225f 5f66 756e 6374 696f 6e73      "__functions
+0001f000: 223a 2073 656c 662e 7669 7369 626c 655f  ": self.visible_
+0001f010: 6675 6e63 7469 6f6e 732c 0a20 2020 2020  functions,.     
+0001f020: 2020 2020 2020 2022 5f5f 5f5f 746f 7461         "____tota
+0001f030: 6c5f 7465 7874 223a 205b 7365 6c66 2e5f  l_text": [self._
+0001f040: 666f 726d 6174 2876 2920 666f 7220 7620  format(v) for v 
+0001f050: 696e 2066 756e 635f 746f 7461 6c73 5d2c  in func_totals],
+0001f060: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+0001f070: 2020 2020 7363 5f76 6973 6962 6c65 5f61      sc_visible_a
+0001f080: 6374 6976 6974 6965 7320 3d20 5b5d 0a20  ctivities = []. 
+0001f090: 2020 2020 2020 2066 6f72 2061 6374 6976         for activ
+0001f0a0: 6974 7920 696e 2073 656c 662e 7669 7369  ity in self.visi
+0001f0b0: 626c 655f 6163 7469 7669 7469 6573 3a0a  ble_activities:.
+0001f0c0: 2020 2020 2020 2020 2020 2020 7661 6c75              valu
+0001f0d0: 6573 203d 205b 6461 7461 5b66 756e 6374  es = [data[funct
+0001f0e0: 696f 6e2c 2061 6374 6976 6974 795d 2066  ion, activity] f
+0001f0f0: 6f72 2066 756e 6374 696f 6e20 696e 2073  or function in s
+0001f100: 656c 662e 7669 7369 626c 655f 6675 6e63  elf.visible_func
+0001f110: 7469 6f6e 735d 0a20 2020 2020 2020 2020  tions].         
+0001f120: 2020 2069 6620 6e6f 7420 616e 7928 7661     if not any(va
+0001f130: 6c75 6573 293a 0a20 2020 2020 2020 2020  lues):.         
+0001f140: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0001f150: 2020 2020 2020 2020 2020 2020 7363 5f76              sc_v
+0001f160: 6973 6962 6c65 5f61 6374 6976 6974 6965  isible_activitie
+0001f170: 732e 6170 7065 6e64 2861 6374 6976 6974  s.append(activit
+0001f180: 7929 0a20 2020 2020 2020 2020 2020 206f  y).            o
+0001f190: 7574 5b61 6374 6976 6974 795d 203d 2076  ut[activity] = v
+0001f1a0: 616c 7565 730a 2020 2020 2020 2020 2020  alues.          
+0001f1b0: 2020 6f75 745b 6622 5f5f 7b61 6374 6976    out[f"__{activ
+0001f1c0: 6974 797d 5f74 6578 7422 5d20 3d20 5b0a  ity}_text"] = [.
+0001f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f1e0: 7365 6c66 2e5f 666f 726d 6174 2876 2920  self._format(v) 
+0001f1f0: 2b20 6622 2028 7b76 202a 2070 6572 635f  + f" ({v * perc_
+0001f200: 6b69 3a2e 3066 7d25 2922 0a20 2020 2020  ki:.0f}%)".     
+0001f210: 2020 2020 2020 2020 2020 2066 6f72 2076             for v
+0001f220: 2c20 7065 7263 5f6b 6920 696e 207a 6970  , perc_ki in zip
+0001f230: 2876 616c 7565 732c 2070 6572 635f 6b29  (values, perc_k)
+0001f240: 0a20 2020 2020 2020 2020 2020 205d 0a20  .            ]. 
+0001f250: 2020 2020 2020 2069 6620 7363 5f76 6973         if sc_vis
+0001f260: 6962 6c65 5f61 6374 6976 6974 6965 7320  ible_activities 
+0001f270: 213d 2073 656c 662e 7374 6163 6b65 645f  != self.stacked_
+0001f280: 6368 6172 745f 7669 7369 626c 655f 6163  chart_visible_ac
+0001f290: 7469 7669 7469 6573 3a0a 2020 2020 2020  tivities:.      
+0001f2a0: 2020 2020 2020 7365 6c66 2e73 7562 7374        self.subst
+0001f2b0: 616e 7469 616c 5f63 6861 6e67 6520 3d20  antial_change = 
+0001f2c0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
+0001f2d0: 2073 656c 662e 7374 6163 6b65 645f 6368   self.stacked_ch
+0001f2e0: 6172 745f 7669 7369 626c 655f 6163 7469  art_visible_acti
+0001f2f0: 7669 7469 6573 5b3a 5d20 3d20 7363 5f76  vities[:] = sc_v
+0001f300: 6973 6962 6c65 5f61 6374 6976 6974 6965  isible_activitie
+0001f310: 730a 0a20 2020 2020 2020 2072 6574 7572  s..        retur
+0001f320: 6e20 6f75 742c 206d 6178 2866 756e 635f  n out, max(func_
+0001f330: 746f 7461 6c73 2c20 6465 6661 756c 743d  totals, default=
+0001f340: 302e 3029 0a0a 2020 2020 6465 6620 5f62  0.0)..    def _b
+0001f350: 7569 6c64 5f74 6173 6b5f 6578 6563 7574  uild_task_execut
+0001f360: 696f 6e5f 6279 5f70 7265 6669 785f 6368  ion_by_prefix_ch
+0001f370: 6172 7428 7365 6c66 2920 2d3e 2066 6967  art(self) -> fig
+0001f380: 7572 653a 0a20 2020 2020 2020 2022 2222  ure:.        """
+0001f390: 4372 6561 7465 2065 6d70 7479 2073 7461  Create empty sta
+0001f3a0: 636b 6564 2062 6172 2063 6861 7274 2066  cked bar chart f
+0001f3b0: 6f72 2065 7865 6375 7465 2062 7920 6675  or execute by fu
+0001f3c0: 6e63 7469 6f6e 0a0a 2020 2020 2020 2020  nction..        
+0001f3d0: 5365 6520 616c 736f 0a20 2020 2020 2020  See also.       
+0001f3e0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+0001f3f0: 2020 5f62 7569 6c64 5f74 6173 6b5f 6578    _build_task_ex
+0001f400: 6563 7574 696f 6e5f 6279 5f70 7265 6669  ecution_by_prefi
+0001f410: 785f 6461 7461 0a20 2020 2020 2020 205f  x_data.        _
+0001f420: 7570 6461 7465 5f74 6173 6b5f 6578 6563  update_task_exec
+0001f430: 7574 696f 6e5f 6279 5f70 7265 6669 785f  ution_by_prefix_
+0001f440: 6368 6172 740a 2020 2020 2020 2020 2222  chart.        ""
+0001f450: 220a 2020 2020 2020 2020 6261 7263 6861  ".        barcha
+0001f460: 7274 203d 2066 6967 7572 6528 0a20 2020  rt = figure(.   
+0001f470: 2020 2020 2020 2020 2079 5f72 616e 6765           y_range
+0001f480: 3d5b 5d2c 0a20 2020 2020 2020 2020 2020  =[],.           
+0001f490: 2068 6569 6768 743d 3530 302c 0a20 2020   height=500,.   
+0001f4a0: 2020 2020 2020 2020 2073 697a 696e 675f           sizing_
+0001f4b0: 6d6f 6465 3d22 7363 616c 655f 626f 7468  mode="scale_both
+0001f4c0: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
+0001f4d0: 6974 6c65 3d22 5461 736b 2065 7865 6375  itle="Task execu
+0001f4e0: 7469 6f6e 2c20 6279 2066 756e 6374 696f  tion, by functio
+0001f4f0: 6e22 2c0a 2020 2020 2020 2020 2020 2020  n",.            
+0001f500: 746f 6f6c 733d 222c 222e 6a6f 696e 2873  tools=",".join(s
+0001f510: 656c 662e 4241 5345 5f54 4f4f 4c53 292c  elf.BASE_TOOLS),
+0001f520: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001f530: 2020 2062 6172 6368 6172 742e 7961 7869     barchart.yaxi
+0001f540: 732e 7669 7369 626c 6520 3d20 5472 7565  s.visible = True
+0001f550: 0a20 2020 2020 2020 2023 2041 7320 6f66  .        # As of
+0001f560: 2042 6f6b 6568 2033 2e31 2c20 4461 7461   Bokeh 3.1, Data
+0001f570: 5261 6e67 6531 4420 2874 6865 2064 6566  Range1D (the def
+0001f580: 6175 6c74 2920 646f 6573 206e 6f74 2077  ault) does not w
+0001f590: 6f72 6b20 7768 656e 2073 7769 7463 6869  ork when switchi
+0001f5a0: 6e67 2062 6163 6b0a 2020 2020 2020 2020  ng back.        
+0001f5b0: 2320 6672 6f6d 2062 7974 6573 2028 4769  # from bytes (Gi
+0001f5c0: 4273 2920 746f 2073 6563 6f6e 6473 2028  Bs) to seconds (
+0001f5d0: 6875 6e64 7265 6473 292e 2053 6f20 7765  hundreds). So we
+0001f5e0: 206e 6565 6420 746f 206d 616e 7561 6c6c   need to manuall
+0001f5f0: 7920 7570 6461 7465 2069 742e 0a20 2020  y update it..   
+0001f600: 2020 2020 2062 6172 6368 6172 742e 785f       barchart.x_
+0001f610: 7261 6e67 6520 3d20 5261 6e67 6531 6428  range = Range1d(
+0001f620: 302c 2031 290a 2020 2020 2020 2020 6261  0, 1).        ba
+0001f630: 7263 6861 7274 2e78 6178 6973 5b30 5d2e  rchart.xaxis[0].
+0001f640: 666f 726d 6174 7465 7220 3d20 4e75 6d65  formatter = Nume
+0001f650: 7261 6c54 6963 6b46 6f72 6d61 7474 6572  ralTickFormatter
+0001f660: 2866 6f72 6d61 743d 2230 303a 3030 3a30  (format="00:00:0
+0001f670: 3022 290a 2020 2020 2020 2020 6261 7263  0").        barc
+0001f680: 6861 7274 2e78 6178 6973 2e6d 616a 6f72  hart.xaxis.major
+0001f690: 5f6c 6162 656c 5f6f 7269 656e 7461 7469  _label_orientati
+0001f6a0: 6f6e 203d 2030 2e34 0a20 2020 2020 2020  on = 0.4.       
+0001f6b0: 2062 6172 6368 6172 742e 6772 6964 2e67   barchart.grid.g
+0001f6c0: 7269 645f 6c69 6e65 5f63 6f6c 6f72 203d  rid_line_color =
+0001f6d0: 204e 6f6e 650a 2020 2020 2020 2020 7265   None.        re
+0001f6e0: 7475 726e 2062 6172 6368 6172 740a 0a20  turn barchart.. 
+0001f6f0: 2020 2064 6566 205f 7570 6461 7465 5f74     def _update_t
+0001f700: 6173 6b5f 6578 6563 7574 696f 6e5f 6279  ask_execution_by
+0001f710: 5f70 7265 6669 785f 6368 6172 7428 7365  _prefix_chart(se
+0001f720: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
+0001f730: 2020 2020 2022 2222 5265 6275 696c 6420       """Rebuild 
+0001f740: 5820 6178 6973 2061 6e64 2074 6f6f 6c74  X axis and toolt
+0001f750: 6970 7320 6f66 2065 7865 6375 7469 6f6e  ips of execution
+0001f760: 2062 7920 7072 6566 6978 2073 7461 636b   by prefix stack
+0001f770: 6564 2063 6861 7274 0a0a 2020 2020 2020  ed chart..      
+0001f780: 2020 5365 6520 616c 736f 0a20 2020 2020    See also.     
+0001f790: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+0001f7a0: 2020 2020 5f62 7569 6c64 5f74 6173 6b5f      _build_task_
+0001f7b0: 6578 6563 7574 696f 6e5f 6279 5f70 7265  execution_by_pre
+0001f7c0: 6669 785f 6461 7461 0a20 2020 2020 2020  fix_data.       
+0001f7d0: 205f 6275 696c 645f 7461 736b 5f65 7865   _build_task_exe
+0001f7e0: 6375 7469 6f6e 5f62 795f 7072 6566 6978  cution_by_prefix
+0001f7f0: 5f63 6861 7274 0a20 2020 2020 2020 2022  _chart.        "
+0001f800: 2222 0a20 2020 2020 2020 2062 6172 6368  "".        barch
+0001f810: 6172 7420 3d20 7365 6c66 2e74 6173 6b5f  art = self.task_
+0001f820: 6578 6563 5f62 795f 7072 6566 6978 5f63  exec_by_prefix_c
+0001f830: 6861 7274 0a20 2020 2020 2020 2061 7373  hart.        ass
+0001f840: 6572 7420 6261 7263 6861 7274 2069 7320  ert barchart is 
+0001f850: 6e6f 7420 4e6f 6e65 0a20 2020 2020 2020  not None.       
+0001f860: 2062 6172 6368 6172 742e 795f 7261 6e67   barchart.y_rang
+0001f870: 6520 3d20 4661 6374 6f72 5261 6e67 6528  e = FactorRange(
+0001f880: 2a73 656c 662e 7669 7369 626c 655f 6675  *self.visible_fu
+0001f890: 6e63 7469 6f6e 7329 0a0a 2020 2020 2020  nctions)..      
+0001f8a0: 2020 7061 6c65 7474 6520 3d20 5b0a 2020    palette = [.  
+0001f8b0: 2020 2020 2020 2020 2020 700a 2020 2020            p.    
+0001f8c0: 2020 2020 2020 2020 666f 7220 702c 2061          for p, a
+0001f8d0: 2069 6e20 7a69 7028 7365 6c66 2e5f 6765   in zip(self._ge
+0001f8e0: 745f 7061 6c65 7474 6528 292c 2073 656c  t_palette(), sel
+0001f8f0: 662e 7669 7369 626c 655f 6163 7469 7669  f.visible_activi
+0001f900: 7469 6573 290a 2020 2020 2020 2020 2020  ties).          
+0001f910: 2020 6966 2061 2069 6e20 7365 6c66 2e73    if a in self.s
+0001f920: 7461 636b 6564 5f63 6861 7274 5f76 6973  tacked_chart_vis
+0001f930: 6962 6c65 5f61 6374 6976 6974 6965 730a  ible_activities.
+0001f940: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0001f950: 2020 6173 7365 7274 206c 656e 2870 616c    assert len(pal
+0001f960: 6574 7465 2920 3d3d 206c 656e 2873 656c  ette) == len(sel
+0001f970: 662e 7374 6163 6b65 645f 6368 6172 745f  f.stacked_chart_
+0001f980: 7669 7369 626c 655f 6163 7469 7669 7469  visible_activiti
+0001f990: 6573 290a 2020 2020 2020 2020 7265 6e64  es).        rend
+0001f9a0: 6572 6572 7320 3d20 6261 7263 6861 7274  erers = barchart
+0001f9b0: 2e68 6261 725f 7374 6163 6b28 0a20 2020  .hbar_stack(.   
+0001f9c0: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
+0001f9d0: 6163 6b65 645f 6368 6172 745f 7669 7369  acked_chart_visi
+0001f9e0: 626c 655f 6163 7469 7669 7469 6573 2c0a  ble_activities,.
+0001f9f0: 2020 2020 2020 2020 2020 2020 793d 225f              y="_
+0001fa00: 5f66 756e 6374 696f 6e73 222c 0a20 2020  _functions",.   
+0001fa10: 2020 2020 2020 2020 2077 6964 7468 3d30           width=0
+0001fa20: 2e39 2c0a 2020 2020 2020 2020 2020 2020  .9,.            
+0001fa30: 736f 7572 6365 3d73 656c 662e 7461 736b  source=self.task
+0001fa40: 5f65 7865 635f 6279 5f70 7265 6669 785f  _exec_by_prefix_
+0001fa50: 7372 632c 0a20 2020 2020 2020 2020 2020  src,.           
+0001fa60: 2063 6f6c 6f72 3d70 616c 6574 7465 2c0a   color=palette,.
+0001fa70: 2020 2020 2020 2020 2020 2020 6c65 6765              lege
+0001fa80: 6e64 5f6c 6162 656c 3d73 656c 662e 7374  nd_label=self.st
+0001fa90: 6163 6b65 645f 6368 6172 745f 7669 7369  acked_chart_visi
+0001faa0: 626c 655f 6163 7469 7669 7469 6573 2c0a  ble_activities,.
+0001fab0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0001fac0: 2020 2023 2043 7265 6174 6520 6f72 2072     # Create or r
+0001fad0: 6566 7265 7368 2068 6f76 6572 746f 6f6c  efresh hovertool
+0001fae0: 7320 6f6e 2074 6f70 206f 6620 6261 7365  s on top of base
+0001faf0: 2074 6f6f 6c73 0a20 2020 2020 2020 2062   tools.        b
+0001fb00: 6172 6368 6172 742e 746f 6f6c 7320 3d20  archart.tools = 
+0001fb10: 6261 7263 6861 7274 2e74 6f6f 6c73 5b3a  barchart.tools[:
+0001fb20: 206c 656e 2873 656c 662e 4241 5345 5f54   len(self.BASE_T
+0001fb30: 4f4f 4c53 295d 0a0a 2020 2020 2020 2020  OOLS)]..        
+0001fb40: 666f 7220 7662 6172 2069 6e20 7265 6e64  for vbar in rend
+0001fb50: 6572 6572 733a 0a20 2020 2020 2020 2020  erers:.         
+0001fb60: 2020 2074 6f6f 6c74 6970 7320 3d20 5b0a     tooltips = [.
+0001fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001fb80: 2822 6675 6e63 7469 6f6e 222c 2022 405f  ("function", "@_
+0001fb90: 5f66 756e 6374 696f 6e73 2229 2c0a 2020  _functions"),.  
+0001fba0: 2020 2020 2020 2020 2020 2020 2020 2876                (v
+0001fbb0: 6261 722e 6e61 6d65 2c20 6622 407b 7b5f  bar.name, f"@{{_
+0001fbc0: 5f7b 7662 6172 2e6e 616d 657d 5f74 6578  _{vbar.name}_tex
+0001fbd0: 747d 7d22 292c 0a20 2020 2020 2020 2020  t}}"),.         
+0001fbe0: 2020 2020 2020 2028 2274 6f74 616c 222c         ("total",
+0001fbf0: 2022 405f 5f5f 5f74 6f74 616c 5f74 6578   "@____total_tex
+0001fc00: 7422 292c 0a20 2020 2020 2020 2020 2020  t"),.           
+0001fc10: 205d 0a20 2020 2020 2020 2020 2020 2062   ].            b
+0001fc20: 6172 6368 6172 742e 6164 645f 746f 6f6c  archart.add_tool
+0001fc30: 7328 486f 7665 7254 6f6f 6c28 746f 6f6c  s(HoverTool(tool
+0001fc40: 7469 7073 3d74 6f6f 6c74 6970 732c 2072  tips=tooltips, r
+0001fc50: 656e 6465 7265 7273 3d5b 7662 6172 5d29  enderers=[vbar])
+0001fc60: 290a 2020 2020 2020 2020 6261 7263 6861  ).        barcha
+0001fc70: 7274 2e72 656e 6465 7265 7273 203d 2072  rt.renderers = r
+0001fc80: 656e 6465 7265 7273 0a0a 0a63 6c61 7373  enderers...class
+0001fc90: 2043 6f6e 7465 6e74 696f 6e28 4461 7368   Contention(Dash
+0001fca0: 626f 6172 6443 6f6d 706f 6e65 6e74 293a  boardComponent):
+0001fcb0: 0a20 2020 2022 2222 0a20 2020 2045 7665  .    """.    Eve
+0001fcc0: 6e74 204c 6f6f 7020 4865 616c 7468 2028  nt Loop Health (
+0001fcd0: 616e 6420 4749 4c20 436f 6e74 656e 7469  and GIL Contenti
+0001fce0: 6f6e 2c20 6966 2063 6f6e 6669 6775 7265  on, if configure
+0001fcf0: 6429 0a20 2020 2022 2222 0a0a 2020 2020  d).    """..    
+0001fd00: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+0001fd10: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+0001fd20: 662c 2073 6368 6564 756c 6572 2c20 2a2a  f, scheduler, **
+0001fd30: 6b77 6172 6773 293a 0a20 2020 2020 2020  kwargs):.       
+0001fd40: 2073 656c 662e 7363 6865 6475 6c65 7220   self.scheduler 
+0001fd50: 3d20 7363 6865 6475 6c65 720a 2020 2020  = scheduler.    
+0001fd60: 2020 2020 7365 6c66 2e64 6174 6120 3d20      self.data = 
+0001fd70: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
+0001fd80: 2020 6e61 6d65 733d 5b0a 2020 2020 2020    names=[.      
+0001fd90: 2020 2020 2020 2020 2020 2822 5363 6865            ("Sche
+0001fda0: 6475 6c65 7222 2c20 2245 7665 6e74 204c  duler", "Event L
+0001fdb0: 6f6f 7022 292c 0a20 2020 2020 2020 2020  oop"),.         
+0001fdc0: 2020 2020 2020 2028 2253 6368 6564 756c         ("Schedul
+0001fdd0: 6572 222c 2022 4749 4c22 292c 0a20 2020  er", "GIL"),.   
+0001fde0: 2020 2020 2020 2020 2020 2020 2028 2257               ("W
+0001fdf0: 6f72 6b65 7273 222c 2022 4576 656e 7420  orkers", "Event 
+0001fe00: 4c6f 6f70 2229 2c0a 2020 2020 2020 2020  Loop"),.        
+0001fe10: 2020 2020 2020 2020 2822 576f 726b 6572          ("Worker
+0001fe20: 7322 2c20 2247 494c 2229 2c0a 2020 2020  s", "GIL"),.    
+0001fe30: 2020 2020 2020 2020 5d2c 0a20 2020 2020          ],.     
+0001fe40: 2020 2020 2020 2076 616c 7565 733d 5b30         values=[0
+0001fe50: 2c20 302c 2030 2c20 305d 2c0a 2020 2020  , 0, 0, 0],.    
+0001fe60: 2020 2020 2020 2020 7465 7874 3d5b 2230          text=["0
+0001fe70: 7322 2c20 2230 2522 2c20 2230 7322 2c20  s", "0%", "0s", 
+0001fe80: 2230 2522 5d2c 0a20 2020 2020 2020 2029  "0%"],.        )
+0001fe90: 0a20 2020 2020 2020 2074 6974 6c65 203d  .        title =
+0001fea0: 2022 4576 656e 7420 4c6f 6f70 2026 2047   "Event Loop & G
+0001feb0: 494c 2043 6f6e 7465 6e74 696f 6e22 0a0a  IL Contention"..
+0001fec0: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
+0001fed0: 2047 494c 2072 656c 6174 6564 206e 616d   GIL related nam
+0001fee0: 6573 2f76 616c 7565 7320 6966 206e 6f74  es/values if not
+0001fef0: 206d 6f6e 6974 6f72 696e 6720 4749 4c0a   monitoring GIL.
+0001ff00: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0001ff10: 656c 662e 7363 6865 6475 6c65 722e 6d6f  elf.scheduler.mo
+0001ff20: 6e69 746f 722e 6d6f 6e69 746f 725f 6769  nitor.monitor_gi
+0001ff30: 6c5f 636f 6e74 656e 7469 6f6e 3a0a 2020  l_contention:.  
+0001ff40: 2020 2020 2020 2020 2020 7469 746c 6520            title 
+0001ff50: 3d20 2245 7665 6e74 204c 6f6f 7022 0a20  = "Event Loop". 
+0001ff60: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
+0001ff70: 6579 2069 6e20 7365 6c66 2e64 6174 613a  ey in self.data:
+0001ff80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ff90: 2073 656c 662e 6461 7461 5b6b 6579 5d20   self.data[key] 
+0001ffa0: 3d20 7365 6c66 2e64 6174 615b 6b65 795d  = self.data[key]
+0001ffb0: 5b3a 3a32 5d0a 0a20 2020 2020 2020 2073  [::2]..        s
+0001ffc0: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
+0001ffd0: 756d 6e44 6174 6153 6f75 7263 6528 6461  umnDataSource(da
+0001ffe0: 7461 3d73 656c 662e 6461 7461 290a 2020  ta=self.data).  
+0001fff0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
+00020000: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
+00020010: 2020 2020 2020 7469 746c 653d 7469 746c        title=titl
+00020020: 652c 0a20 2020 2020 2020 2020 2020 2078  e,.            x
+00020030: 5f72 616e 6765 3d46 6163 746f 7252 616e  _range=FactorRan
+00020040: 6765 282a 7365 6c66 2e64 6174 615b 226e  ge(*self.data["n
+00020050: 616d 6573 225d 292c 0a20 2020 2020 2020  ames"]),.       
+00020060: 2020 2020 2079 5f72 616e 6765 3d28 302c       y_range=(0,
+00020070: 2031 292c 0a20 2020 2020 2020 2020 2020   1),.           
+00020080: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
+00020090: 2020 2020 2020 2074 6f6f 6c62 6172 5f6c         toolbar_l
+000200a0: 6f63 6174 696f 6e3d 2261 626f 7665 222c  ocation="above",
+000200b0: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+000200c0: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
+000200d0: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+000200e0: 6f74 2e76 6261 7228 0a20 2020 2020 2020  ot.vbar(.       
+000200f0: 2020 2020 2078 3d22 6e61 6d65 7322 2c0a       x="names",.
+00020100: 2020 2020 2020 2020 2020 2020 746f 703d              top=
+00020110: 2276 616c 7565 7322 2c0a 2020 2020 2020  "values",.      
+00020120: 2020 2020 2020 7769 6474 683d 302e 392c        width=0.9,
+00020130: 0a20 2020 2020 2020 2020 2020 206c 696e  .            lin
+00020140: 655f 636f 6c6f 723d 2277 6869 7465 222c  e_color="white",
+00020150: 0a20 2020 2020 2020 2020 2020 2073 6f75  .            sou
+00020160: 7263 653d 7365 6c66 2e73 6f75 7263 652c  rce=self.source,
+00020170: 0a20 2020 2020 2020 2020 2020 2066 696c  .            fil
+00020180: 6c5f 636f 6c6f 723d 6661 6374 6f72 5f63  l_color=factor_c
+00020190: 6d61 7028 0a20 2020 2020 2020 2020 2020  map(.           
+000201a0: 2020 2020 2066 6965 6c64 5f6e 616d 653d       field_name=
+000201b0: 226e 616d 6573 222c 0a20 2020 2020 2020  "names",.       
+000201c0: 2020 2020 2020 2020 2070 616c 6574 7465           palette
+000201d0: 3d5b 2223 6238 6530 6365 222c 2022 2338  =["#b8e0ce", "#8
+000201e0: 3161 6165 3422 5d2c 0a20 2020 2020 2020  1aae4"],.       
+000201f0: 2020 2020 2020 2020 2066 6163 746f 7273           factors
+00020200: 3d5b 2245 7665 6e74 204c 6f6f 7022 2c20  =["Event Loop", 
+00020210: 2247 494c 225d 2c0a 2020 2020 2020 2020  "GIL"],.        
+00020220: 2020 2020 2020 2020 7374 6172 743d 312c          start=1,
+00020230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020240: 2065 6e64 3d32 2c0a 2020 2020 2020 2020   end=2,.        
+00020250: 2020 2020 292c 0a20 2020 2020 2020 2029      ),.        )
+00020260: 0a0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
+00020270: 6f6f 742e 785f 7261 6e67 652e 6772 6f75  oot.x_range.grou
+00020280: 705f 7061 6464 696e 6720 3d20 302e 3235  p_padding = 0.25
+00020290: 0a20 2020 2020 2020 2073 656c 662e 726f  .        self.ro
+000202a0: 6f74 2e78 6178 6973 2e6d 696e 6f72 5f74  ot.xaxis.minor_t
+000202b0: 6963 6b5f 6c69 6e65 5f61 6c70 6861 203d  ick_line_alpha =
+000202c0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+000202d0: 726f 6f74 2e79 6772 6964 2e76 6973 6962  root.ygrid.visib
+000202e0: 6c65 203d 2054 7275 650a 2020 2020 2020  le = True.      
+000202f0: 2020 7365 6c66 2e72 6f6f 742e 7867 7269    self.root.xgri
+00020300: 642e 7669 7369 626c 6520 3d20 4661 6c73  d.visible = Fals
+00020310: 650a 0a20 2020 2020 2020 2068 6f76 6572  e..        hover
+00020320: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
+00020330: 2020 2020 2020 2020 2020 746f 6f6c 7469            toolti
+00020340: 7073 3d5b 2822 4e61 6d65 222c 2022 406e  ps=[("Name", "@n
+00020350: 616d 6573 2229 2c20 2822 5661 6c75 6522  ames"), ("Value"
+00020360: 2c20 2240 7465 7874 2229 5d2c 206d 6f64  , "@text")], mod
+00020370: 653d 2276 6c69 6e65 220a 2020 2020 2020  e="vline".      
+00020380: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
+00020390: 2e72 6f6f 742e 6164 645f 746f 6f6c 7328  .root.add_tools(
+000203a0: 686f 7665 7229 0a0a 2020 2020 4077 6974  hover)..    @wit
+000203b0: 686f 7574 5f70 726f 7065 7274 795f 7661  hout_property_va
+000203c0: 6c69 6461 7469 6f6e 0a20 2020 2040 6c6f  lidation.    @lo
+000203d0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
+000203e0: 2075 7064 6174 6528 7365 6c66 293a 0a20   update(self):. 
+000203f0: 2020 2020 2020 2073 203d 2073 656c 662e         s = self.
+00020400: 7363 6865 6475 6c65 720a 0a20 2020 2020  scheduler..     
+00020410: 2020 2073 656c 662e 6461 7461 5b22 7661     self.data["va
+00020420: 6c75 6573 225d 203d 205b 0a20 2020 2020  lues"] = [.     
+00020430: 2020 2020 2020 2073 2e5f 7469 636b 5f69         s._tick_i
+00020440: 6e74 6572 7661 6c5f 6f62 7365 7276 6564  nterval_observed
+00020450: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+00020460: 6c66 2e67 696c 5f63 6f6e 7465 6e74 696f  lf.gil_contentio
+00020470: 6e5f 7363 6865 6475 6c65 722c 0a20 2020  n_scheduler,.   
+00020480: 2020 2020 2020 2020 2073 756d 2877 2e6d           sum(w.m
+00020490: 6574 7269 6373 5b22 6576 656e 745f 6c6f  etrics["event_lo
+000204a0: 6f70 5f69 6e74 6572 7661 6c22 5d20 666f  op_interval"] fo
+000204b0: 7220 7720 696e 2073 2e77 6f72 6b65 7273  r w in s.workers
+000204c0: 2e76 616c 7565 7328 2929 0a20 2020 2020  .values()).     
+000204d0: 2020 2020 2020 202f 2028 6c65 6e28 732e         / (len(s.
+000204e0: 776f 726b 6572 7329 206f 7220 3129 2c0a  workers) or 1),.
+000204f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00020500: 2e67 696c 5f63 6f6e 7465 6e74 696f 6e5f  .gil_contention_
+00020510: 776f 726b 6572 732c 0a20 2020 2020 2020  workers,.       
+00020520: 205d 5b3a 3a20 3120 6966 2073 2e6d 6f6e   ][:: 1 if s.mon
+00020530: 6974 6f72 2e6d 6f6e 6974 6f72 5f67 696c  itor.monitor_gil
+00020540: 5f63 6f6e 7465 6e74 696f 6e20 656c 7365  _contention else
+00020550: 2032 5d0a 0a20 2020 2020 2020 2023 2046   2]..        # F
+00020560: 6f72 6d61 7420 6576 656e 7420 6c6f 6f70  ormat event loop
+00020570: 2061 7320 7469 6d65 2061 6e64 2047 494c   as time and GIL
+00020580: 2028 6966 2063 6f6e 6669 6775 7265 6429   (if configured)
+00020590: 2061 7320 250a 2020 2020 2020 2020 7365   as %.        se
+000205a0: 6c66 2e64 6174 615b 2274 6578 7422 5d20  lf.data["text"] 
+000205b0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+000205c0: 6622 7b78 202a 2031 3030 3a2e 3166 7d25  f"{x * 100:.1f}%
+000205d0: 220a 2020 2020 2020 2020 2020 2020 6966  ".            if
+000205e0: 2069 2025 2032 2061 6e64 2073 2e6d 6f6e   i % 2 and s.mon
+000205f0: 6974 6f72 2e6d 6f6e 6974 6f72 5f67 696c  itor.monitor_gil
+00020600: 5f63 6f6e 7465 6e74 696f 6e0a 2020 2020  _contention.    
+00020610: 2020 2020 2020 2020 656c 7365 2066 6f72          else for
+00020620: 6d61 745f 7469 6d65 2878 290a 2020 2020  mat_time(x).    
+00020630: 2020 2020 2020 2020 666f 7220 692c 2078          for i, x
+00020640: 2069 6e20 656e 756d 6572 6174 6528 7365   in enumerate(se
+00020650: 6c66 2e64 6174 615b 2276 616c 7565 7322  lf.data["values"
+00020660: 5d29 0a20 2020 2020 2020 205d 0a20 2020  ]).        ].   
+00020670: 2020 2020 2075 7064 6174 6528 7365 6c66       update(self
+00020680: 2e73 6f75 7263 652c 2073 656c 662e 6461  .source, self.da
+00020690: 7461 290a 0a20 2020 2040 7072 6f70 6572  ta)..    @proper
+000206a0: 7479 0a20 2020 2064 6566 2067 696c 5f63  ty.    def gil_c
+000206b0: 6f6e 7465 6e74 696f 6e5f 776f 726b 6572  ontention_worker
+000206c0: 7328 7365 6c66 2920 2d3e 2066 6c6f 6174  s(self) -> float
+000206d0: 3a0a 2020 2020 2020 2020 776f 726b 6572  :.        worker
+000206e0: 7320 3d20 7365 6c66 2e73 6368 6564 756c  s = self.schedul
+000206f0: 6572 2e77 6f72 6b65 7273 0a20 2020 2020  er.workers.     
+00020700: 2020 2069 6620 776f 726b 6572 733a 0a20     if workers:. 
+00020710: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00020720: 6e20 7375 6d28 0a20 2020 2020 2020 2020  n sum(.         
+00020730: 2020 2020 2020 2077 2e6d 6574 7269 6373         w.metrics
+00020740: 2e67 6574 2822 6769 6c5f 636f 6e74 656e  .get("gil_conten
+00020750: 7469 6f6e 222c 2030 2920 666f 7220 7720  tion", 0) for w 
+00020760: 696e 2077 6f72 6b65 7273 2e76 616c 7565  in workers.value
+00020770: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
+00020780: 2920 2f20 6c65 6e28 776f 726b 6572 7329  ) / len(workers)
+00020790: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000207a0: 666c 6f61 7428 224e 614e 2229 0a0a 2020  float("NaN")..  
+000207b0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+000207c0: 6465 6620 6769 6c5f 636f 6e74 656e 7469  def gil_contenti
+000207d0: 6f6e 5f73 6368 6564 756c 6572 2873 656c  on_scheduler(sel
+000207e0: 6629 202d 3e20 666c 6f61 743a 0a20 2020  f) -> float:.   
+000207f0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00020800: 2e73 6368 6564 756c 6572 2e6d 6f6e 6974  .scheduler.monit
+00020810: 6f72 2e72 6563 656e 7428 292e 6765 7428  or.recent().get(
+00020820: 2267 696c 5f63 6f6e 7465 6e74 696f 6e22  "gil_contention"
+00020830: 2c20 666c 6f61 7428 224e 614e 2229 290a  , float("NaN")).
+00020840: 0a0a 636c 6173 7320 4578 6365 7074 696f  ..class Exceptio
+00020850: 6e73 5461 626c 6528 4461 7368 626f 6172  nsTable(Dashboar
+00020860: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
+00020870: 2022 2222 0a20 2020 2045 7863 6570 7469   """.    Excepti
+00020880: 6f6e 7320 6c6f 6767 6564 2069 6e20 7461  ons logged in ta
+00020890: 736b 732e 0a0a 2020 2020 5369 6e63 6520  sks...    Since 
+000208a0: 7468 6572 6520 6d69 6768 7420 6265 206d  there might be m
+000208b0: 616e 7920 7265 6c61 7465 6420 6578 6365  any related exce
+000208c0: 7074 696f 6e73 2028 652e 672e 2c20 616c  ptions (e.g., al
+000208d0: 6c20 7461 736b 7320 696e 2061 2067 6976  l tasks in a giv
+000208e0: 656e 0a20 2020 2074 6173 6b20 6772 6f75  en.    task grou
+000208f0: 7020 6661 696c 2066 6f72 2074 6865 2073  p fail for the s
+00020900: 616d 6520 7265 6173 6f6e 292c 2077 6520  ame reason), we 
+00020910: 6d61 6b65 2061 2062 6573 742d 6566 666f  make a best-effo
+00020920: 7274 2061 7474 656d 7074 2074 6f0a 2020  rt attempt to.  
+00020930: 2020 2831 2920 6167 6772 6567 6174 6520    (1) aggregate 
+00020940: 746f 2074 6865 2074 6173 6b20 6772 6f75  to the task grou
+00020950: 702c 2061 6e64 2028 3229 2064 6564 7570  p, and (2) dedup
+00020960: 6c69 6361 7465 2073 696d 696c 6172 206c  licate similar l
+00020970: 6f6f 6b69 6e67 2074 6173 6b73 2e0a 2020  ooking tasks..  
+00020980: 2020 2222 220a 0a20 2020 2073 6368 6564    """..    sched
+00020990: 756c 6572 3a20 5363 6865 6475 6c65 720a  uler: Scheduler.
+000209a0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+000209b0: 5f28 7365 6c66 2c20 7363 6865 6475 6c65  _(self, schedule
+000209c0: 723a 2053 6368 6564 756c 6572 2c20 7769  r: Scheduler, wi
+000209d0: 6474 683a 2069 6e74 203d 2031 3030 302c  dth: int = 1000,
+000209e0: 202a 2a6b 7761 7267 733a 2041 6e79 293a   **kwargs: Any):
+000209f0: 0a20 2020 2020 2020 2073 656c 662e 7363  .        self.sc
+00020a00: 6865 6475 6c65 7220 3d20 7363 6865 6475  heduler = schedu
+00020a10: 6c65 720a 0a20 2020 2020 2020 2073 656c  ler..        sel
+00020a20: 662e 6e61 6d65 7320 3d20 5b0a 2020 2020  f.names = [.    
+00020a30: 2020 2020 2020 2020 2254 6173 6b22 2c0a          "Task",.
+00020a40: 2020 2020 2020 2020 2020 2020 2245 7863              "Exc
+00020a50: 6570 7469 6f6e 222c 0a20 2020 2020 2020  eption",.       
+00020a60: 2020 2020 2022 5472 6163 6562 6163 6b22       "Traceback"
+00020a70: 2c0a 2020 2020 2020 2020 2020 2020 2257  ,.            "W
+00020a80: 6f72 6b65 7228 7329 222c 0a20 2020 2020  orker(s)",.     
+00020a90: 2020 2020 2020 2022 436f 756e 7422 2c0a         "Count",.
+00020aa0: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
+00020ab0: 2020 2073 656c 662e 736f 7572 6365 203d     self.source =
+00020ac0: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
+00020ad0: 6528 7b6b 3a20 5b5d 2066 6f72 206b 2069  e({k: [] for k i
+00020ae0: 6e20 7365 6c66 2e6e 616d 6573 7d29 0a0a  n self.names})..
+00020af0: 2020 2020 2020 2020 636f 6465 5f66 6f72          code_for
+00020b00: 6d61 7474 6572 203d 2048 544d 4c54 656d  matter = HTMLTem
+00020b10: 706c 6174 6546 6f72 6d61 7474 6572 280a  plateFormatter(.
+00020b20: 2020 2020 2020 2020 2020 2020 7465 6d70              temp
+00020b30: 6c61 7465 3d27 3c63 6f64 6520 7469 746c  late='<code titl
+00020b40: 653d 223c 252d 2076 616c 7565 2025 3e22  e="<%- value %>"
+00020b50: 3e3c 253d 2076 616c 7565 2025 3e3c 2f63  ><%= value %></c
+00020b60: 6f64 653e 270a 2020 2020 2020 2020 290a  ode>'.        ).
+00020b70: 2020 2020 2020 2020 636f 6c75 6d6e 7320          columns 
+00020b80: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00020b90: 5461 626c 6543 6f6c 756d 6e28 0a20 2020  TableColumn(.   
+00020ba0: 2020 2020 2020 2020 2020 2020 2066 6965               fie
+00020bb0: 6c64 3d22 5461 736b 222c 0a20 2020 2020  ld="Task",.     
+00020bc0: 2020 2020 2020 2020 2020 2074 6974 6c65             title
+00020bd0: 3d22 5461 736b 222c 0a20 2020 2020 2020  ="Task",.       
+00020be0: 2020 2020 2020 2020 2066 6f72 6d61 7474           formatt
+00020bf0: 6572 3d63 6f64 655f 666f 726d 6174 7465  er=code_formatte
+00020c00: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+00020c10: 2020 2077 6964 7468 3d31 3530 2c0a 2020     width=150,.  
+00020c20: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00020c30: 2020 2020 2020 2020 2054 6162 6c65 436f           TableCo
+00020c40: 6c75 6d6e 280a 2020 2020 2020 2020 2020  lumn(.          
+00020c50: 2020 2020 2020 6669 656c 643d 2245 7863        field="Exc
+00020c60: 6570 7469 6f6e 222c 0a20 2020 2020 2020  eption",.       
+00020c70: 2020 2020 2020 2020 2074 6974 6c65 3d22           title="
+00020c80: 4578 6365 7074 696f 6e22 2c0a 2020 2020  Exception",.    
+00020c90: 2020 2020 2020 2020 2020 2020 666f 726d              form
+00020ca0: 6174 7465 723d 636f 6465 5f66 6f72 6d61  atter=code_forma
+00020cb0: 7474 6572 2c0a 2020 2020 2020 2020 2020  tter,.          
+00020cc0: 2020 2020 2020 7769 6474 683d 3330 302c        width=300,
+00020cd0: 0a20 2020 2020 2020 2020 2020 2029 2c0a  .            ),.
+00020ce0: 2020 2020 2020 2020 2020 2020 5461 626c              Tabl
+00020cf0: 6543 6f6c 756d 6e28 0a20 2020 2020 2020  eColumn(.       
+00020d00: 2020 2020 2020 2020 2066 6965 6c64 3d22           field="
+00020d10: 5472 6163 6562 6163 6b22 2c0a 2020 2020  Traceback",.    
+00020d20: 2020 2020 2020 2020 2020 2020 7469 746c              titl
+00020d30: 653d 2254 7261 6365 6261 636b 222c 0a20  e="Traceback",. 
+00020d40: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020d50: 6f72 6d61 7474 6572 3d63 6f64 655f 666f  ormatter=code_fo
+00020d60: 726d 6174 7465 722c 0a20 2020 2020 2020  rmatter,.       
+00020d70: 2020 2020 2020 2020 2077 6964 7468 3d33           width=3
+00020d80: 3030 2c0a 2020 2020 2020 2020 2020 2020  00,.            
+00020d90: 292c 0a20 2020 2020 2020 2020 2020 2054  ),.            T
+00020da0: 6162 6c65 436f 6c75 6d6e 280a 2020 2020  ableColumn(.    
+00020db0: 2020 2020 2020 2020 2020 2020 6669 656c              fiel
+00020dc0: 643d 2257 6f72 6b65 7228 7329 222c 0a20  d="Worker(s)",. 
+00020dd0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00020de0: 6974 6c65 3d22 576f 726b 6572 2873 2922  itle="Worker(s)"
+00020df0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020e00: 2020 666f 726d 6174 7465 723d 636f 6465    formatter=code
+00020e10: 5f66 6f72 6d61 7474 6572 2c0a 2020 2020  _formatter,.    
+00020e20: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+00020e30: 683d 3230 302c 0a20 2020 2020 2020 2020  h=200,.         
+00020e40: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00020e50: 2020 5461 626c 6543 6f6c 756d 6e28 0a20    TableColumn(. 
+00020e60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00020e70: 6965 6c64 3d22 436f 756e 7422 2c0a 2020  ield="Count",.  
+00020e80: 2020 2020 2020 2020 2020 2020 2020 7469                ti
+00020e90: 746c 653d 2243 6f75 6e74 222c 0a20 2020  tle="Count",.   
+00020ea0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00020eb0: 6d61 7474 6572 3d4e 756d 6265 7246 6f72  matter=NumberFor
+00020ec0: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
+00020ed0: 2c30 2229 2c0a 2020 2020 2020 2020 2020  ,0"),.          
+00020ee0: 2020 2020 2020 7769 6474 683d 3530 2c0a        width=50,.
+00020ef0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00020f00: 2020 2020 2020 205d 0a0a 2020 2020 2020         ]..      
+00020f10: 2020 6966 2022 7369 7a69 6e67 5f6d 6f64    if "sizing_mod
+00020f20: 6522 2069 6e20 6b77 6172 6773 3a0a 2020  e" in kwargs:.  
+00020f30: 2020 2020 2020 2020 2020 7369 7a69 6e67            sizing
+00020f40: 5f6d 6f64 6520 3d20 7b22 7369 7a69 6e67  _mode = {"sizing
+00020f50: 5f6d 6f64 6522 3a20 6b77 6172 6773 5b22  _mode": kwargs["
+00020f60: 7369 7a69 6e67 5f6d 6f64 6522 5d7d 0a20  sizing_mode"]}. 
+00020f70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00020f80: 2020 2020 2020 2020 2073 697a 696e 675f           sizing_
+00020f90: 6d6f 6465 203d 207b 7d0a 2020 2020 2020  mode = {}.      
+00020fa0: 2020 7365 6c66 2e72 6f6f 7420 3d20 4461    self.root = Da
+00020fb0: 7461 5461 626c 6528 0a20 2020 2020 2020  taTable(.       
+00020fc0: 2020 2020 2073 6f75 7263 653d 7365 6c66       source=self
+00020fd0: 2e73 6f75 7263 652c 0a20 2020 2020 2020  .source,.       
+00020fe0: 2020 2020 2063 6f6c 756d 6e73 3d63 6f6c       columns=col
+00020ff0: 756d 6e73 2c0a 2020 2020 2020 2020 2020  umns,.          
+00021000: 2020 7265 6f72 6465 7261 626c 653d 5472    reorderable=Tr
+00021010: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
+00021020: 736f 7274 6162 6c65 3d54 7275 652c 0a20  sortable=True,. 
+00021030: 2020 2020 2020 2020 2020 2077 6964 7468             width
+00021040: 3d77 6964 7468 2c0a 2020 2020 2020 2020  =width,.        
+00021050: 2020 2020 696e 6465 785f 706f 7369 7469      index_positi
+00021060: 6f6e 3d4e 6f6e 652c 0a20 2020 2020 2020  on=None,.       
+00021070: 2020 2020 202a 2a5f 4441 5441 5441 424c       **_DATATABL
+00021080: 455f 5354 594c 4553 4845 4554 535f 4b57  E_STYLESHEETS_KW
+00021090: 4152 4753 2c0a 2020 2020 2020 2020 2020  ARGS,.          
+000210a0: 2020 2a2a 7369 7a69 6e67 5f6d 6f64 652c    **sizing_mode,
+000210b0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+000210c0: 4077 6974 686f 7574 5f70 726f 7065 7274  @without_propert
+000210d0: 795f 7661 6c69 6461 7469 6f6e 0a20 2020  y_validation.   
+000210e0: 2064 6566 2075 7064 6174 6528 7365 6c66   def update(self
+000210f0: 293a 0a20 2020 2020 2020 206e 6577 5f64  ):.        new_d
+00021100: 6174 6120 3d20 7b6e 616d 653a 205b 5d20  ata = {name: [] 
+00021110: 666f 7220 6e61 6d65 2069 6e20 7365 6c66  for name in self
+00021120: 2e6e 616d 6573 7d0a 2020 2020 2020 2020  .names}.        
+00021130: 6572 7265 645f 7461 736b 7320 3d20 7365  erred_tasks = se
+00021140: 6c66 2e73 6368 6564 756c 6572 2e65 7272  lf.scheduler.err
+00021150: 6564 5f74 6173 6b73 0a0a 2020 2020 2020  ed_tasks..      
+00021160: 2020 666f 7220 7473 2069 6e20 6572 7265    for ts in erre
+00021170: 645f 7461 736b 733a 0a20 2020 2020 2020  d_tasks:.       
+00021180: 2020 2020 206e 6577 5f64 6174 615b 2254       new_data["T
+00021190: 6173 6b22 5d2e 6170 7065 6e64 2874 732e  ask"].append(ts.
+000211a0: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+000211b0: 206e 6577 5f64 6174 615b 2245 7863 6570   new_data["Excep
+000211c0: 7469 6f6e 225d 2e61 7070 656e 6428 7473  tion"].append(ts
+000211d0: 2e65 7863 6570 7469 6f6e 5f74 6578 7429  .exception_text)
+000211e0: 0a20 2020 2020 2020 2020 2020 206e 6577  .            new
+000211f0: 5f64 6174 615b 2254 7261 6365 6261 636b  _data["Traceback
+00021200: 225d 2e61 7070 656e 6428 7473 2e74 7261  "].append(ts.tra
+00021210: 6365 6261 636b 5f74 6578 7429 0a20 2020  ceback_text).   
+00021220: 2020 2020 2020 2020 206e 6577 5f64 6174           new_dat
+00021230: 615b 2257 6f72 6b65 7228 7329 225d 2e61  a["Worker(s)"].a
+00021240: 7070 656e 6428 222c 5c6e 222e 6a6f 696e  ppend(",\n".join
+00021250: 2874 732e 6572 7265 645f 6f6e 2929 0a20  (ts.erred_on)). 
+00021260: 2020 2020 2020 2020 2020 206e 6577 5f64             new_d
+00021270: 6174 615b 2243 6f75 6e74 225d 2e61 7070  ata["Count"].app
+00021280: 656e 6428 6c65 6e28 7473 2e65 7272 6564  end(len(ts.erred
+00021290: 5f6f 6e29 290a 0a20 2020 2020 2020 2075  _on))..        u
+000212a0: 7064 6174 6528 7365 6c66 2e73 6f75 7263  pdate(self.sourc
+000212b0: 652c 206e 6577 5f64 6174 6129 0a0a 0a63  e, new_data)...c
+000212c0: 6c61 7373 2057 6f72 6b65 7254 6162 6c65  lass WorkerTable
+000212d0: 2844 6173 6862 6f61 7264 436f 6d70 6f6e  (DashboardCompon
+000212e0: 656e 7429 3a0a 2020 2020 2222 2253 7461  ent):.    """Sta
+000212f0: 7475 7320 6f66 2074 6865 2063 7572 7265  tus of the curre
+00021300: 6e74 2077 6f72 6b65 7273 0a0a 2020 2020  nt workers..    
+00021310: 5468 6973 2069 7320 7477 6f20 706c 6f74  This is two plot
+00021320: 732c 2061 2074 6578 742d 6261 7365 6420  s, a text-based 
+00021330: 7461 626c 6520 666f 7220 6561 6368 2068  table for each h
+00021340: 6f73 7420 616e 6420 6120 7468 696e 2068  ost and a thin h
+00021350: 6f72 697a 6f6e 7461 6c0a 2020 2020 706c  orizontal.    pl
+00021360: 6f74 206c 6179 696e 6720 6f75 7420 686f  ot laying out ho
+00021370: 7374 7320 6279 2074 6865 6972 2063 7572  sts by their cur
+00021380: 7265 6e74 206d 656d 6f72 7920 7573 652e  rent memory use.
+00021390: 0a20 2020 2022 2222 0a0a 2020 2020 6578  .    """..    ex
+000213a0: 636c 7564 6564 5f6e 616d 6573 203d 207b  cluded_names = {
+000213b0: 0a20 2020 2020 2020 2022 6578 6563 7574  .        "execut
+000213c0: 696e 6722 2c0a 2020 2020 2020 2020 2269  ing",.        "i
+000213d0: 6e5f 666c 6967 6874 222c 0a20 2020 2020  n_flight",.     
+000213e0: 2020 2022 696e 5f6d 656d 6f72 7922 2c0a     "in_memory",.
+000213f0: 2020 2020 2020 2020 2272 6561 6479 222c          "ready",
+00021400: 0a20 2020 2020 2020 2022 7469 6d65 222c  .        "time",
+00021410: 0a20 2020 2020 2020 2023 2055 7365 2073  .        # Use s
+00021420: 6368 6564 756c 6572 2e57 6f72 6b65 7253  cheduler.WorkerS
+00021430: 7461 7465 2e6d 656d 6f72 792e 6d61 6e61  tate.memory.mana
+00021440: 6765 6420 696e 7374 6561 6420 6f66 0a20  ged instead of. 
+00021450: 2020 2020 2020 2023 2073 6368 6564 756c         # schedul
+00021460: 6572 2e57 6f72 6b65 7253 7461 7465 2e6d  er.WorkerState.m
+00021470: 6574 7269 6373 5b22 6d61 6e61 6765 645f  etrics["managed_
+00021480: 6279 7465 7322 5d3b 2074 6865 2074 776f  bytes"]; the two
+00021490: 206d 6561 7375 7265 7320 6172 6520 736c   measures are sl
+000214a0: 6967 6874 6c79 0a20 2020 2020 2020 2023  ightly.        #
+000214b0: 2064 6966 6665 7265 6e74 2e20 5365 6520   different. See 
+000214c0: 6578 706c 616e 6174 696f 6e20 696e 2073  explanation in s
+000214d0: 6368 6564 756c 6572 2e57 6f72 6b65 7253  cheduler.WorkerS
+000214e0: 7461 7465 2e6d 656d 6f72 7928 292e 0a20  tate.memory().. 
+000214f0: 2020 2020 2020 2022 6d61 6e61 6765 645f         "managed_
+00021500: 6279 7465 7322 2c0a 2020 2020 2020 2020  bytes",.        
+00021510: 2273 7069 6c6c 6564 5f62 7974 6573 222c  "spilled_bytes",
+00021520: 0a20 2020 207d 0a0a 2020 2020 6465 6620  .    }..    def 
+00021530: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
+00021540: 6368 6564 756c 6572 2c20 7769 6474 683d  cheduler, width=
+00021550: 3830 302c 202a 2a6b 7761 7267 7329 3a0a  800, **kwargs):.
+00021560: 2020 2020 2020 2020 7365 6c66 2e73 6368          self.sch
+00021570: 6564 756c 6572 203d 2073 6368 6564 756c  eduler = schedul
+00021580: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
+00021590: 6e61 6d65 7320 3d20 5b0a 2020 2020 2020  names = [.      
+000215a0: 2020 2020 2020 226e 616d 6522 2c0a 2020        "name",.  
+000215b0: 2020 2020 2020 2020 2020 2261 6464 7265            "addre
+000215c0: 7373 222c 0a20 2020 2020 2020 2020 2020  ss",.           
+000215d0: 2022 6e74 6872 6561 6473 222c 0a20 2020   "nthreads",.   
+000215e0: 2020 2020 2020 2020 2022 6370 7522 2c0a           "cpu",.
+000215f0: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
+00021600: 6f72 7922 2c0a 2020 2020 2020 2020 2020  ory",.          
+00021610: 2020 226d 656d 6f72 795f 6c69 6d69 7422    "memory_limit"
+00021620: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+00021630: 656d 6f72 795f 7065 7263 656e 7422 2c0a  emory_percent",.
+00021640: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
+00021650: 6f72 795f 6d61 6e61 6765 6422 2c0a 2020  ory_managed",.  
+00021660: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+00021670: 795f 756e 6d61 6e61 6765 645f 6f6c 6422  y_unmanaged_old"
+00021680: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+00021690: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+000216a0: 7265 6365 6e74 222c 0a20 2020 2020 2020  recent",.       
+000216b0: 2020 2020 2022 6d65 6d6f 7279 5f73 7069       "memory_spi
+000216c0: 6c6c 6564 222c 0a20 2020 2020 2020 2020  lled",.         
+000216d0: 2020 2022 6e75 6d5f 6664 7322 2c0a 2020     "num_fds",.  
+000216e0: 2020 2020 2020 2020 2020 2268 6f73 745f            "host_
+000216f0: 6e65 745f 696f 2e72 6561 645f 6270 7322  net_io.read_bps"
+00021700: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
+00021710: 6f73 745f 6e65 745f 696f 2e77 7269 7465  ost_net_io.write
+00021720: 5f62 7073 222c 0a20 2020 2020 2020 2020  _bps",.         
+00021730: 2020 2022 686f 7374 5f64 6973 6b5f 696f     "host_disk_io
+00021740: 2e72 6561 645f 6270 7322 2c0a 2020 2020  .read_bps",.    
+00021750: 2020 2020 2020 2020 2268 6f73 745f 6469          "host_di
+00021760: 736b 5f69 6f2e 7772 6974 655f 6270 7322  sk_io.write_bps"
+00021770: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
+00021780: 7075 5f66 7261 6374 696f 6e22 2c0a 2020  pu_fraction",.  
+00021790: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+000217a0: 776f 726b 6572 7320 3d20 7365 6c66 2e73  workers = self.s
+000217b0: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+000217c0: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
+000217d0: 2020 7365 6c66 2e65 7874 7261 5f6e 616d    self.extra_nam
+000217e0: 6573 203d 2073 6f72 7465 6428 0a20 2020  es = sorted(.   
+000217f0: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00021800: 2020 2020 2020 2020 2020 206d 0a20 2020             m.   
+00021810: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00021820: 2077 7320 696e 2077 6f72 6b65 7273 0a20   ws in workers. 
+00021830: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00021840: 6f72 206d 2c20 7620 696e 2077 732e 6d65  or m, v in ws.me
+00021850: 7472 6963 732e 6974 656d 7328 290a 2020  trics.items().  
+00021860: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00021870: 206d 206e 6f74 2069 6e20 7365 6c66 2e6e   m not in self.n
+00021880: 616d 6573 2061 6e64 2069 7369 6e73 7461  ames and isinsta
+00021890: 6e63 6528 762c 2028 7374 722c 2069 6e74  nce(v, (str, int
+000218a0: 2c20 666c 6f61 7429 290a 2020 2020 2020  , float)).      
+000218b0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000218c0: 2020 2020 2d20 7365 6c66 2e65 7863 6c75      - self.exclu
+000218d0: 6465 645f 6e61 6d65 730a 2020 2020 2020  ded_names.      
+000218e0: 2020 290a 0a20 2020 2020 2020 2074 6162    )..        tab
+000218f0: 6c65 5f6e 616d 6573 203d 205b 0a20 2020  le_names = [.   
+00021900: 2020 2020 2020 2020 2022 6e61 6d65 222c           "name",
+00021910: 0a20 2020 2020 2020 2020 2020 2022 6164  .            "ad
+00021920: 6472 6573 7322 2c0a 2020 2020 2020 2020  dress",.        
+00021930: 2020 2020 226e 7468 7265 6164 7322 2c0a      "nthreads",.
+00021940: 2020 2020 2020 2020 2020 2020 2263 7075              "cpu
+00021950: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00021960: 6d65 6d6f 7279 222c 0a20 2020 2020 2020  memory",.       
+00021970: 2020 2020 2022 6d65 6d6f 7279 5f6c 696d       "memory_lim
+00021980: 6974 222c 0a20 2020 2020 2020 2020 2020  it",.           
+00021990: 2022 6d65 6d6f 7279 5f70 6572 6365 6e74   "memory_percent
+000219a0: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+000219b0: 6d65 6d6f 7279 5f6d 616e 6167 6564 222c  memory_managed",
+000219c0: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+000219d0: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f6f  mory_unmanaged_o
+000219e0: 6c64 222c 0a20 2020 2020 2020 2020 2020  ld",.           
+000219f0: 2022 6d65 6d6f 7279 5f75 6e6d 616e 6167   "memory_unmanag
+00021a00: 6564 5f72 6563 656e 7422 2c0a 2020 2020  ed_recent",.    
+00021a10: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
+00021a20: 7370 696c 6c65 6422 2c0a 2020 2020 2020  spilled",.      
+00021a30: 2020 2020 2020 226e 756d 5f66 6473 222c        "num_fds",
+00021a40: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
+00021a50: 7374 5f6e 6574 5f69 6f2e 7265 6164 5f62  st_net_io.read_b
+00021a60: 7073 222c 0a20 2020 2020 2020 2020 2020  ps",.           
+00021a70: 2022 686f 7374 5f6e 6574 5f69 6f2e 7772   "host_net_io.wr
+00021a80: 6974 655f 6270 7322 2c0a 2020 2020 2020  ite_bps",.      
+00021a90: 2020 2020 2020 2268 6f73 745f 6469 736b        "host_disk
+00021aa0: 5f69 6f2e 7265 6164 5f62 7073 222c 0a20  _io.read_bps",. 
+00021ab0: 2020 2020 2020 2020 2020 2022 686f 7374             "host
+00021ac0: 5f64 6973 6b5f 696f 2e77 7269 7465 5f62  _disk_io.write_b
+00021ad0: 7073 222c 0a20 2020 2020 2020 205d 0a20  ps",.        ]. 
+00021ae0: 2020 2020 2020 2063 6f6c 756d 6e5f 7469         column_ti
+00021af0: 746c 655f 7265 6e61 6d65 7320 3d20 7b0a  tle_renames = {.
+00021b00: 2020 2020 2020 2020 2020 2020 226d 656d              "mem
+00021b10: 6f72 795f 6c69 6d69 7422 3a20 226c 696d  ory_limit": "lim
+00021b20: 6974 222c 0a20 2020 2020 2020 2020 2020  it",.           
+00021b30: 2022 6d65 6d6f 7279 5f70 6572 6365 6e74   "memory_percent
+00021b40: 223a 2022 6d65 6d6f 7279 2025 222c 0a20  ": "memory %",. 
+00021b50: 2020 2020 2020 2020 2020 2022 6d65 6d6f             "memo
+00021b60: 7279 5f6d 616e 6167 6564 223a 2022 6d61  ry_managed": "ma
+00021b70: 6e61 6765 6422 2c0a 2020 2020 2020 2020  naged",.        
+00021b80: 2020 2020 226d 656d 6f72 795f 756e 6d61      "memory_unma
+00021b90: 6e61 6765 645f 6f6c 6422 3a20 2275 6e6d  naged_old": "unm
+00021ba0: 616e 6167 6564 206f 6c64 222c 0a20 2020  anaged old",.   
+00021bb0: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
+00021bc0: 5f75 6e6d 616e 6167 6564 5f72 6563 656e  _unmanaged_recen
+00021bd0: 7422 3a20 2275 6e6d 616e 6167 6564 2072  t": "unmanaged r
+00021be0: 6563 656e 7422 2c0a 2020 2020 2020 2020  ecent",.        
+00021bf0: 2020 2020 226d 656d 6f72 795f 7370 696c      "memory_spil
+00021c00: 6c65 6422 3a20 2273 7069 6c6c 6564 222c  led": "spilled",
+00021c10: 0a20 2020 2020 2020 2020 2020 2022 6e75  .            "nu
+00021c20: 6d5f 6664 7322 3a20 2223 2066 6473 222c  m_fds": "# fds",
+00021c30: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
+00021c40: 7374 5f6e 6574 5f69 6f2e 7265 6164 5f62  st_net_io.read_b
+00021c50: 7073 223a 2022 6e65 7420 7265 6164 222c  ps": "net read",
+00021c60: 0a20 2020 2020 2020 2020 2020 2022 686f  .            "ho
+00021c70: 7374 5f6e 6574 5f69 6f2e 7772 6974 655f  st_net_io.write_
+00021c80: 6270 7322 3a20 226e 6574 2077 7269 7465  bps": "net write
+00021c90: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00021ca0: 686f 7374 5f64 6973 6b5f 696f 2e72 6561  host_disk_io.rea
+00021cb0: 645f 6270 7322 3a20 2264 6973 6b20 7265  d_bps": "disk re
+00021cc0: 6164 222c 0a20 2020 2020 2020 2020 2020  ad",.           
+00021cd0: 2022 686f 7374 5f64 6973 6b5f 696f 2e77   "host_disk_io.w
+00021ce0: 7269 7465 5f62 7073 223a 2022 6469 736b  rite_bps": "disk
+00021cf0: 2077 7269 7465 222c 0a20 2020 2020 2020   write",.       
+00021d00: 207d 0a0a 2020 2020 2020 2020 7365 6c66   }..        self
+00021d10: 2e73 6f75 7263 6520 3d20 436f 6c75 6d6e  .source = Column
+00021d20: 4461 7461 536f 7572 6365 287b 6b3a 205b  DataSource({k: [
+00021d30: 5d20 666f 7220 6b20 696e 2073 656c 662e  ] for k in self.
+00021d40: 6e61 6d65 737d 290a 0a20 2020 2020 2020  names})..       
+00021d50: 2063 6f6c 756d 6e73 203d 207b 0a20 2020   columns = {.   
+00021d60: 2020 2020 2020 2020 206e 616d 653a 2054           name: T
+00021d70: 6162 6c65 436f 6c75 6d6e 2866 6965 6c64  ableColumn(field
+00021d80: 3d6e 616d 652c 2074 6974 6c65 3d63 6f6c  =name, title=col
+00021d90: 756d 6e5f 7469 746c 655f 7265 6e61 6d65  umn_title_rename
+00021da0: 732e 6765 7428 6e61 6d65 2c20 6e61 6d65  s.get(name, name
+00021db0: 2929 0a20 2020 2020 2020 2020 2020 2066  )).            f
+00021dc0: 6f72 206e 616d 6520 696e 2074 6162 6c65  or name in table
+00021dd0: 5f6e 616d 6573 0a20 2020 2020 2020 207d  _names.        }
+00021de0: 0a0a 2020 2020 2020 2020 666f 726d 6174  ..        format
+00021df0: 7465 7273 203d 207b 0a20 2020 2020 2020  ters = {.       
+00021e00: 2020 2020 2022 6370 7522 3a20 4e75 6d62       "cpu": Numb
+00021e10: 6572 466f 726d 6174 7465 7228 666f 726d  erFormatter(form
+00021e20: 6174 3d22 3020 2522 292c 0a20 2020 2020  at="0 %"),.     
+00021e30: 2020 2020 2020 2022 6d65 6d6f 7279 5f70         "memory_p
+00021e40: 6572 6365 6e74 223a 204e 756d 6265 7246  ercent": NumberF
+00021e50: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
+00021e60: 2230 2e30 2025 2229 2c0a 2020 2020 2020  "0.0 %"),.      
+00021e70: 2020 2020 2020 226d 656d 6f72 7922 3a20        "memory": 
+00021e80: 4e75 6d62 6572 466f 726d 6174 7465 7228  NumberFormatter(
+00021e90: 666f 726d 6174 3d22 302e 3020 6222 292c  format="0.0 b"),
+00021ea0: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
+00021eb0: 6d6f 7279 5f6c 696d 6974 223a 204e 756d  mory_limit": Num
+00021ec0: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
+00021ed0: 6d61 743d 2230 2e30 2062 2229 2c0a 2020  mat="0.0 b"),.  
+00021ee0: 2020 2020 2020 2020 2020 226d 656d 6f72            "memor
+00021ef0: 795f 6d61 6e61 6765 6422 3a20 4e75 6d62  y_managed": Numb
+00021f00: 6572 466f 726d 6174 7465 7228 666f 726d  erFormatter(form
+00021f10: 6174 3d22 302e 3020 6222 292c 0a20 2020  at="0.0 b"),.   
+00021f20: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
+00021f30: 5f75 6e6d 616e 6167 6564 5f6f 6c64 223a  _unmanaged_old":
+00021f40: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
+00021f50: 2866 6f72 6d61 743d 2230 2e30 2062 2229  (format="0.0 b")
+00021f60: 2c0a 2020 2020 2020 2020 2020 2020 226d  ,.            "m
+00021f70: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00021f80: 7265 6365 6e74 223a 204e 756d 6265 7246  recent": NumberF
+00021f90: 6f72 6d61 7474 6572 2866 6f72 6d61 743d  ormatter(format=
+00021fa0: 2230 2e30 2062 2229 2c0a 2020 2020 2020  "0.0 b"),.      
+00021fb0: 2020 2020 2020 226d 656d 6f72 795f 7370        "memory_sp
+00021fc0: 696c 6c65 6422 3a20 4e75 6d62 6572 466f  illed": NumberFo
+00021fd0: 726d 6174 7465 7228 666f 726d 6174 3d22  rmatter(format="
+00021fe0: 302e 3020 6222 292c 0a20 2020 2020 2020  0.0 b"),.       
+00021ff0: 2020 2020 2022 686f 7374 5f6e 6574 5f69       "host_net_i
+00022000: 6f2e 7265 6164 5f62 7073 223a 204e 756d  o.read_bps": Num
+00022010: 6265 7246 6f72 6d61 7474 6572 2866 6f72  berFormatter(for
+00022020: 6d61 743d 2230 2062 2229 2c0a 2020 2020  mat="0 b"),.    
+00022030: 2020 2020 2020 2020 2268 6f73 745f 6e65          "host_ne
+00022040: 745f 696f 2e77 7269 7465 5f62 7073 223a  t_io.write_bps":
+00022050: 204e 756d 6265 7246 6f72 6d61 7474 6572   NumberFormatter
+00022060: 2866 6f72 6d61 743d 2230 2062 2229 2c0a  (format="0 b"),.
+00022070: 2020 2020 2020 2020 2020 2020 226e 756d              "num
+00022080: 5f66 6473 223a 204e 756d 6265 7246 6f72  _fds": NumberFor
+00022090: 6d61 7474 6572 2866 6f72 6d61 743d 2230  matter(format="0
+000220a0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+000220b0: 226e 7468 7265 6164 7322 3a20 4e75 6d62  "nthreads": Numb
+000220c0: 6572 466f 726d 6174 7465 7228 666f 726d  erFormatter(form
+000220d0: 6174 3d22 3022 292c 0a20 2020 2020 2020  at="0"),.       
+000220e0: 2020 2020 2022 686f 7374 5f64 6973 6b5f       "host_disk_
+000220f0: 696f 2e72 6561 645f 6270 7322 3a20 4e75  io.read_bps": Nu
+00022100: 6d62 6572 466f 726d 6174 7465 7228 666f  mberFormatter(fo
+00022110: 726d 6174 3d22 3020 6222 292c 0a20 2020  rmat="0 b"),.   
+00022120: 2020 2020 2020 2020 2022 686f 7374 5f64           "host_d
+00022130: 6973 6b5f 696f 2e77 7269 7465 5f62 7073  isk_io.write_bps
+00022140: 223a 204e 756d 6265 7246 6f72 6d61 7474  ": NumberFormatt
+00022150: 6572 2866 6f72 6d61 743d 2230 2062 2229  er(format="0 b")
+00022160: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
+00022170: 2020 2020 2074 6162 6c65 203d 2044 6174       table = Dat
+00022180: 6154 6162 6c65 280a 2020 2020 2020 2020  aTable(.        
+00022190: 2020 2020 736f 7572 6365 3d73 656c 662e      source=self.
+000221a0: 736f 7572 6365 2c0a 2020 2020 2020 2020  source,.        
+000221b0: 2020 2020 636f 6c75 6d6e 733d 5b63 6f6c      columns=[col
+000221c0: 756d 6e73 5b6e 5d20 666f 7220 6e20 696e  umns[n] for n in
+000221d0: 2074 6162 6c65 5f6e 616d 6573 5d2c 0a20   table_names],. 
+000221e0: 2020 2020 2020 2020 2020 2072 656f 7264             reord
+000221f0: 6572 6162 6c65 3d54 7275 652c 0a20 2020  erable=True,.   
+00022200: 2020 2020 2020 2020 2073 6f72 7461 626c           sortabl
+00022210: 653d 5472 7565 2c0a 2020 2020 2020 2020  e=True,.        
+00022220: 2020 2020 7769 6474 683d 7769 6474 682c      width=width,
+00022230: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+00022240: 6578 5f70 6f73 6974 696f 6e3d 4e6f 6e65  ex_position=None
+00022250: 2c0a 2020 2020 2020 2020 2020 2020 2a2a  ,.            **
+00022260: 5f44 4154 4154 4142 4c45 5f53 5459 4c45  _DATATABLE_STYLE
+00022270: 5348 4545 5453 5f4b 5741 5247 532c 0a20  SHEETS_KWARGS,. 
+00022280: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00022290: 2020 666f 7220 6e61 6d65 2069 6e20 7461    for name in ta
+000222a0: 626c 655f 6e61 6d65 733a 0a20 2020 2020  ble_names:.     
+000222b0: 2020 2020 2020 2069 6620 6e61 6d65 2069         if name i
+000222c0: 6e20 666f 726d 6174 7465 7273 3a0a 2020  n formatters:.  
+000222d0: 2020 2020 2020 2020 2020 2020 2020 7461                ta
+000222e0: 626c 652e 636f 6c75 6d6e 735b 7461 626c  ble.columns[tabl
+000222f0: 655f 6e61 6d65 732e 696e 6465 7828 6e61  e_names.index(na
+00022300: 6d65 295d 2e66 6f72 6d61 7474 6572 203d  me)].formatter =
+00022310: 2066 6f72 6d61 7474 6572 735b 6e61 6d65   formatters[name
+00022320: 5d0a 0a20 2020 2020 2020 2065 7874 7261  ]..        extra
+00022330: 5f6e 616d 6573 203d 205b 226e 616d 6522  _names = ["name"
+00022340: 2c20 2261 6464 7265 7373 225d 202b 2073  , "address"] + s
+00022350: 656c 662e 6578 7472 615f 6e61 6d65 730a  elf.extra_names.
+00022360: 2020 2020 2020 2020 6578 7472 615f 636f          extra_co
+00022370: 6c75 6d6e 7320 3d20 7b0a 2020 2020 2020  lumns = {.      
+00022380: 2020 2020 2020 6e61 6d65 3a20 5461 626c        name: Tabl
+00022390: 6543 6f6c 756d 6e28 6669 656c 643d 6e61  eColumn(field=na
+000223a0: 6d65 2c20 7469 746c 653d 636f 6c75 6d6e  me, title=column
+000223b0: 5f74 6974 6c65 5f72 656e 616d 6573 2e67  _title_renames.g
+000223c0: 6574 286e 616d 652c 206e 616d 6529 290a  et(name, name)).
+000223d0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000223e0: 6e61 6d65 2069 6e20 6578 7472 615f 6e61  name in extra_na
+000223f0: 6d65 730a 2020 2020 2020 2020 7d0a 0a20  mes.        }.. 
+00022400: 2020 2020 2020 2065 7874 7261 5f74 6162         extra_tab
+00022410: 6c65 203d 2044 6174 6154 6162 6c65 280a  le = DataTable(.
+00022420: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00022430: 6365 3d73 656c 662e 736f 7572 6365 2c0a  ce=self.source,.
+00022440: 2020 2020 2020 2020 2020 2020 636f 6c75              colu
+00022450: 6d6e 733d 5b65 7874 7261 5f63 6f6c 756d  mns=[extra_colum
+00022460: 6e73 5b6e 5d20 666f 7220 6e20 696e 2065  ns[n] for n in e
+00022470: 7874 7261 5f6e 616d 6573 5d2c 0a20 2020  xtra_names],.   
+00022480: 2020 2020 2020 2020 2072 656f 7264 6572           reorder
+00022490: 6162 6c65 3d54 7275 652c 0a20 2020 2020  able=True,.     
+000224a0: 2020 2020 2020 2073 6f72 7461 626c 653d         sortable=
+000224b0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
+000224c0: 2020 7769 6474 683d 7769 6474 682c 0a20    width=width,. 
+000224d0: 2020 2020 2020 2020 2020 2069 6e64 6578             index
+000224e0: 5f70 6f73 6974 696f 6e3d 4e6f 6e65 2c0a  _position=None,.
+000224f0: 2020 2020 2020 2020 2020 2020 2a2a 5f44              **_D
+00022500: 4154 4154 4142 4c45 5f53 5459 4c45 5348  ATATABLE_STYLESH
+00022510: 4545 5453 5f4b 5741 5247 532c 0a20 2020  EETS_KWARGS,.   
+00022520: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00022530: 666f 7220 6e61 6d65 2069 6e20 6578 7472  for name in extr
+00022540: 615f 6e61 6d65 733a 0a20 2020 2020 2020  a_names:.       
+00022550: 2020 2020 2069 6620 6e61 6d65 2069 6e20       if name in 
+00022560: 666f 726d 6174 7465 7273 3a0a 2020 2020  formatters:.    
+00022570: 2020 2020 2020 2020 2020 2020 6578 7472              extr
+00022580: 615f 7461 626c 652e 636f 6c75 6d6e 735b  a_table.columns[
+00022590: 6578 7472 615f 6e61 6d65 732e 696e 6465  extra_names.inde
+000225a0: 7828 6e61 6d65 295d 2e66 6f72 6d61 7474  x(name)].formatt
+000225b0: 6572 203d 2066 6f72 6d61 7474 6572 735b  er = formatters[
+000225c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000225d0: 2020 2020 206e 616d 650a 2020 2020 2020       name.      
+000225e0: 2020 2020 2020 2020 2020 5d0a 0a20 2020            ]..   
+000225f0: 2020 2020 2068 6f76 6572 203d 2048 6f76       hover = Hov
+00022600: 6572 546f 6f6c 280a 2020 2020 2020 2020  erTool(.        
+00022610: 2020 2020 706f 696e 745f 706f 6c69 6379      point_policy
+00022620: 3d22 666f 6c6c 6f77 5f6d 6f75 7365 222c  ="follow_mouse",
+00022630: 0a20 2020 2020 2020 2020 2020 2074 6f6f  .            too
+00022640: 6c74 6970 733d 2222 220a 2020 2020 2020  ltips=""".      
+00022650: 2020 2020 2020 2020 2020 3c64 6976 3e0a            <div>.
+00022660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022670: 2020 3c73 7061 6e20 7374 796c 653d 2266    <span style="f
+00022680: 6f6e 742d 7369 7a65 3a20 3130 7078 3b20  ont-size: 10px; 
+00022690: 666f 6e74 2d66 616d 696c 793a 204d 6f6e  font-family: Mon
+000226a0: 6163 6f2c 206d 6f6e 6f73 7061 6365 3b22  aco, monospace;"
+000226b0: 3e57 6f72 6b65 7220 2840 6e61 6d65 293a  >Worker (@name):
+000226c0: 203c 2f73 7061 6e3e 0a20 2020 2020 2020   </span>.       
+000226d0: 2020 2020 2020 2020 2020 203c 7370 616e             <span
+000226e0: 2073 7479 6c65 3d22 666f 6e74 2d73 697a   style="font-siz
+000226f0: 653a 2031 3070 783b 2066 6f6e 742d 6661  e: 10px; font-fa
+00022700: 6d69 6c79 3a20 4d6f 6e61 636f 2c20 6d6f  mily: Monaco, mo
+00022710: 6e6f 7370 6163 653b 223e 406d 656d 6f72  nospace;">@memor
+00022720: 795f 7065 7263 656e 747b 302e 3020 257d  y_percent{0.0 %}
+00022730: 3c2f 7370 616e 3e0a 2020 2020 2020 2020  </span>.        
+00022740: 2020 2020 2020 2020 3c2f 6469 763e 0a20          </div>. 
+00022750: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00022760: 2222 2c0a 2020 2020 2020 2020 290a 0a20  "",.        ).. 
+00022770: 2020 2020 2020 206d 656d 5f70 6c6f 7420         mem_plot 
+00022780: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
+00022790: 2020 2020 2020 7469 746c 653d 224d 656d        title="Mem
+000227a0: 6f72 7920 5573 6520 2825 2922 2c0a 2020  ory Use (%)",.  
+000227b0: 2020 2020 2020 2020 2020 746f 6f6c 6261            toolba
+000227c0: 725f 6c6f 6361 7469 6f6e 3d4e 6f6e 652c  r_location=None,
+000227d0: 0a20 2020 2020 2020 2020 2020 2078 5f72  .            x_r
+000227e0: 616e 6765 3d28 302c 2031 292c 0a20 2020  ange=(0, 1),.   
+000227f0: 2020 2020 2020 2020 2079 5f72 616e 6765           y_range
+00022800: 3d28 2d30 2e31 2c20 302e 3129 2c0a 2020  =(-0.1, 0.1),.  
+00022810: 2020 2020 2020 2020 2020 6865 6967 6874            height
+00022820: 3d36 302c 0a20 2020 2020 2020 2020 2020  =60,.           
+00022830: 2077 6964 7468 3d77 6964 7468 2c0a 2020   width=width,.  
+00022840: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+00022850: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+00022860: 6d69 6e5f 626f 7264 6572 5f72 6967 6874  min_border_right
+00022870: 3d30 2c0a 2020 2020 2020 2020 2020 2020  =0,.            
+00022880: 2a2a 6b77 6172 6773 2c0a 2020 2020 2020  **kwargs,.      
+00022890: 2020 290a 2020 2020 2020 2020 6d65 6d5f    ).        mem_
+000228a0: 706c 6f74 2e73 6361 7474 6572 280a 2020  plot.scatter(.  
+000228b0: 2020 2020 2020 2020 2020 736f 7572 6365            source
+000228c0: 3d73 656c 662e 736f 7572 6365 2c20 783d  =self.source, x=
+000228d0: 226d 656d 6f72 795f 7065 7263 656e 7422  "memory_percent"
+000228e0: 2c20 793d 302c 2073 697a 653d 3130 2c20  , y=0, size=10, 
+000228f0: 6669 6c6c 5f61 6c70 6861 3d30 2e35 0a20  fill_alpha=0.5. 
+00022900: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00022910: 206d 656d 5f70 6c6f 742e 7967 7269 642e   mem_plot.ygrid.
+00022920: 7669 7369 626c 6520 3d20 4661 6c73 650a  visible = False.
+00022930: 2020 2020 2020 2020 6d65 6d5f 706c 6f74          mem_plot
+00022940: 2e79 6178 6973 2e6d 696e 6f72 5f74 6963  .yaxis.minor_tic
+00022950: 6b5f 6c69 6e65 5f61 6c70 6861 203d 2030  k_line_alpha = 0
+00022960: 0a20 2020 2020 2020 206d 656d 5f70 6c6f  .        mem_plo
+00022970: 742e 7861 7869 732e 7669 7369 626c 6520  t.xaxis.visible 
+00022980: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+00022990: 6d65 6d5f 706c 6f74 2e79 6178 6973 2e76  mem_plot.yaxis.v
+000229a0: 6973 6962 6c65 203d 2046 616c 7365 0a20  isible = False. 
+000229b0: 2020 2020 2020 206d 656d 5f70 6c6f 742e         mem_plot.
+000229c0: 6164 645f 746f 6f6c 7328 686f 7665 722c  add_tools(hover,
+000229d0: 2042 6f78 5365 6c65 6374 546f 6f6c 2829   BoxSelectTool()
+000229e0: 290a 0a20 2020 2020 2020 2068 6f76 6572  )..        hover
+000229f0: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
+00022a00: 2020 2020 2020 2020 2020 706f 696e 745f            point_
+00022a10: 706f 6c69 6379 3d22 666f 6c6c 6f77 5f6d  policy="follow_m
+00022a20: 6f75 7365 222c 0a20 2020 2020 2020 2020  ouse",.         
+00022a30: 2020 2074 6f6f 6c74 6970 733d 2222 220a     tooltips=""".
+00022a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022a50: 3c64 6976 3e0a 2020 2020 2020 2020 2020  <div>.          
+00022a60: 2020 2020 2020 2020 3c73 7061 6e20 7374          <span st
+00022a70: 796c 653d 2266 6f6e 742d 7369 7a65 3a20  yle="font-size: 
+00022a80: 3130 7078 3b20 666f 6e74 2d66 616d 696c  10px; font-famil
+00022a90: 793a 204d 6f6e 6163 6f2c 206d 6f6e 6f73  y: Monaco, monos
+00022aa0: 7061 6365 3b22 3e57 6f72 6b65 7220 2840  pace;">Worker (@
+00022ab0: 6e61 6d65 293a 203c 2f73 7061 6e3e 0a20  name): </span>. 
+00022ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022ad0: 203c 7370 616e 2073 7479 6c65 3d22 666f   <span style="fo
+00022ae0: 6e74 2d73 697a 653a 2031 3070 783b 2066  nt-size: 10px; f
+00022af0: 6f6e 742d 6661 6d69 6c79 3a20 4d6f 6e61  ont-family: Mona
+00022b00: 636f 2c20 6d6f 6e6f 7370 6163 653b 223e  co, monospace;">
+00022b10: 4063 7075 5f66 7261 6374 696f 6e7b 3020  @cpu_fraction{0 
+00022b20: 257d 3c2f 7370 616e 3e0a 2020 2020 2020  %}</span>.      
+00022b30: 2020 2020 2020 2020 2020 3c2f 6469 763e            </div>
+00022b40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022b50: 2022 2222 2c0a 2020 2020 2020 2020 290a   """,.        ).
+00022b60: 0a20 2020 2020 2020 2063 7075 5f70 6c6f  .        cpu_plo
+00022b70: 7420 3d20 6669 6775 7265 280a 2020 2020  t = figure(.    
+00022b80: 2020 2020 2020 2020 7469 746c 653d 2243          title="C
+00022b90: 5055 2055 7365 2028 2529 222c 0a20 2020  PU Use (%)",.   
+00022ba0: 2020 2020 2020 2020 2074 6f6f 6c62 6172           toolbar
+00022bb0: 5f6c 6f63 6174 696f 6e3d 4e6f 6e65 2c0a  _location=None,.
+00022bc0: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
+00022bd0: 6e67 653d 2830 2c20 3129 2c0a 2020 2020  nge=(0, 1),.    
+00022be0: 2020 2020 2020 2020 795f 7261 6e67 653d          y_range=
+00022bf0: 282d 302e 312c 2030 2e31 292c 0a20 2020  (-0.1, 0.1),.   
+00022c00: 2020 2020 2020 2020 2068 6569 6768 743d           height=
+00022c10: 3630 2c0a 2020 2020 2020 2020 2020 2020  60,.            
+00022c20: 7769 6474 683d 7769 6474 682c 0a20 2020  width=width,.   
+00022c30: 2020 2020 2020 2020 2074 6f6f 6c73 3d22           tools="
+00022c40: 222c 0a20 2020 2020 2020 2020 2020 206d  ",.            m
+00022c50: 696e 5f62 6f72 6465 725f 7269 6768 743d  in_border_right=
+00022c60: 302c 0a20 2020 2020 2020 2020 2020 202a  0,.            *
+00022c70: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
+00022c80: 2029 0a20 2020 2020 2020 2063 7075 5f70   ).        cpu_p
+00022c90: 6c6f 742e 7363 6174 7465 7228 0a20 2020  lot.scatter(.   
+00022ca0: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
+00022cb0: 7365 6c66 2e73 6f75 7263 652c 2078 3d22  self.source, x="
+00022cc0: 6370 755f 6672 6163 7469 6f6e 222c 2079  cpu_fraction", y
+00022cd0: 3d30 2c20 7369 7a65 3d31 302c 2066 696c  =0, size=10, fil
+00022ce0: 6c5f 616c 7068 613d 302e 350a 2020 2020  l_alpha=0.5.    
+00022cf0: 2020 2020 290a 2020 2020 2020 2020 6370      ).        cp
+00022d00: 755f 706c 6f74 2e79 6772 6964 2e76 6973  u_plot.ygrid.vis
+00022d10: 6962 6c65 203d 2046 616c 7365 0a20 2020  ible = False.   
+00022d20: 2020 2020 2063 7075 5f70 6c6f 742e 7961       cpu_plot.ya
+00022d30: 7869 732e 6d69 6e6f 725f 7469 636b 5f6c  xis.minor_tick_l
+00022d40: 696e 655f 616c 7068 6120 3d20 300a 2020  ine_alpha = 0.  
+00022d50: 2020 2020 2020 6370 755f 706c 6f74 2e78        cpu_plot.x
+00022d60: 6178 6973 2e76 6973 6962 6c65 203d 2046  axis.visible = F
+00022d70: 616c 7365 0a20 2020 2020 2020 2063 7075  alse.        cpu
+00022d80: 5f70 6c6f 742e 7961 7869 732e 7669 7369  _plot.yaxis.visi
+00022d90: 626c 6520 3d20 4661 6c73 650a 2020 2020  ble = False.    
+00022da0: 2020 2020 6370 755f 706c 6f74 2e61 6464      cpu_plot.add
+00022db0: 5f74 6f6f 6c73 2868 6f76 6572 2c20 426f  _tools(hover, Bo
+00022dc0: 7853 656c 6563 7454 6f6f 6c28 2929 0a20  xSelectTool()). 
+00022dd0: 2020 2020 2020 2073 656c 662e 6370 755f         self.cpu_
+00022de0: 706c 6f74 203d 2063 7075 5f70 6c6f 740a  plot = cpu_plot.
+00022df0: 0a20 2020 2020 2020 2069 6620 2273 697a  .        if "siz
+00022e00: 696e 675f 6d6f 6465 2220 696e 206b 7761  ing_mode" in kwa
+00022e10: 7267 733a 0a20 2020 2020 2020 2020 2020  rgs:.           
+00022e20: 2073 697a 696e 675f 6d6f 6465 203d 207b   sizing_mode = {
+00022e30: 2273 697a 696e 675f 6d6f 6465 223a 206b  "sizing_mode": k
+00022e40: 7761 7267 735b 2273 697a 696e 675f 6d6f  wargs["sizing_mo
+00022e50: 6465 225d 7d0a 2020 2020 2020 2020 656c  de"]}.        el
+00022e60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00022e70: 7369 7a69 6e67 5f6d 6f64 6520 3d20 7b7d  sizing_mode = {}
+00022e80: 0a0a 2020 2020 2020 2020 636f 6d70 6f6e  ..        compon
+00022e90: 656e 7473 203d 205b 6370 755f 706c 6f74  ents = [cpu_plot
+00022ea0: 2c20 6d65 6d5f 706c 6f74 2c20 7461 626c  , mem_plot, tabl
+00022eb0: 655d 0a20 2020 2020 2020 2069 6620 7365  e].        if se
+00022ec0: 6c66 2e65 7874 7261 5f6e 616d 6573 3a0a  lf.extra_names:.
+00022ed0: 2020 2020 2020 2020 2020 2020 636f 6d70              comp
+00022ee0: 6f6e 656e 7473 2e61 7070 656e 6428 6578  onents.append(ex
+00022ef0: 7472 615f 7461 626c 6529 0a0a 2020 2020  tra_table)..    
+00022f00: 2020 2020 7365 6c66 2e72 6f6f 7420 3d20      self.root = 
+00022f10: 636f 6c75 6d6e 282a 636f 6d70 6f6e 656e  column(*componen
+00022f20: 7473 2c20 2a2a 7369 7a69 6e67 5f6d 6f64  ts, **sizing_mod
+00022f30: 6529 0a0a 2020 2020 4077 6974 686f 7574  e)..    @without
+00022f40: 5f70 726f 7065 7274 795f 7661 6c69 6461  _property_valida
+00022f50: 7469 6f6e 0a20 2020 2064 6566 2075 7064  tion.    def upd
+00022f60: 6174 6528 7365 6c66 293a 0a20 2020 2020  ate(self):.     
+00022f70: 2020 2064 6174 6120 3d20 7b6e 616d 653a     data = {name:
+00022f80: 205b 5d20 666f 7220 6e61 6d65 2069 6e20   [] for name in 
+00022f90: 7365 6c66 2e6e 616d 6573 202b 2073 656c  self.names + sel
+00022fa0: 662e 6578 7472 615f 6e61 6d65 737d 0a20  f.extra_names}. 
+00022fb0: 2020 2020 2020 2066 6f72 2069 2c20 7773         for i, ws
+00022fc0: 2069 6e20 656e 756d 6572 6174 6528 0a20   in enumerate(. 
+00022fd0: 2020 2020 2020 2020 2020 2073 6f72 7465             sorte
+00022fe0: 6428 7365 6c66 2e73 6368 6564 756c 6572  d(self.scheduler
+00022ff0: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+00023000: 292c 206b 6579 3d6c 616d 6264 6120 7773  ), key=lambda ws
+00023010: 3a20 7374 7228 7773 2e6e 616d 6529 290a  : str(ws.name)).
+00023020: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+00023030: 2020 2020 2020 206d 696e 666f 203d 2077         minfo = w
+00023040: 732e 6d65 6d6f 7279 0a0a 2020 2020 2020  s.memory..      
+00023050: 2020 2020 2020 666f 7220 6e61 6d65 2069        for name i
+00023060: 6e20 7365 6c66 2e6e 616d 6573 202b 2073  n self.names + s
+00023070: 656c 662e 6578 7472 615f 6e61 6d65 733a  elf.extra_names:
+00023080: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023090: 2069 6620 222e 2220 696e 206e 616d 653a   if "." in name:
+000230a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000230b0: 2020 2020 206e 302c 205f 2c20 6e31 203d       n0, _, n1 =
+000230c0: 206e 616d 652e 7061 7274 6974 696f 6e28   name.partition(
+000230d0: 222e 2229 0a20 2020 2020 2020 2020 2020  ".").           
+000230e0: 2020 2020 2020 2020 2076 203d 2077 732e           v = ws.
+000230f0: 6d65 7472 6963 732e 6765 7428 6e30 2c20  metrics.get(n0, 
+00023100: 7b7d 292e 6765 7428 6e31 2c20 4e6f 6e65  {}).get(n1, None
+00023110: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00023120: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00023130: 2020 2020 2020 2020 2020 2020 7620 3d20              v = 
+00023140: 7773 2e6d 6574 7269 6373 2e67 6574 286e  ws.metrics.get(n
+00023150: 616d 652c 204e 6f6e 6529 0a20 2020 2020  ame, None).     
 00023160: 2020 2020 2020 2020 2020 2064 6174 615b             data[
-00023170: 226e 616d 6522 5d5b 2d31 5d20 3d20 7773  "name"][-1] = ws
-00023180: 2e6e 616d 6520 6966 2077 732e 6e61 6d65  .name if ws.name
-00023190: 2069 7320 6e6f 7420 4e6f 6e65 2065 6c73   is not None els
-000231a0: 6520 690a 2020 2020 2020 2020 2020 2020  e i.            
-000231b0: 6461 7461 5b22 6164 6472 6573 7322 5d5b  data["address"][
-000231c0: 2d31 5d20 3d20 7773 2e61 6464 7265 7373  -1] = ws.address
-000231d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000231e0: 7773 2e6d 656d 6f72 795f 6c69 6d69 743a  ws.memory_limit:
-000231f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023200: 2064 6174 615b 226d 656d 6f72 795f 7065   data["memory_pe
-00023210: 7263 656e 7422 5d5b 2d31 5d20 3d20 7773  rcent"][-1] = ws
-00023220: 2e6d 6574 7269 6373 5b22 6d65 6d6f 7279  .metrics["memory
-00023230: 225d 202f 2077 732e 6d65 6d6f 7279 5f6c  "] / ws.memory_l
-00023240: 696d 6974 0a20 2020 2020 2020 2020 2020  imit.           
-00023250: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00023260: 2020 2020 2020 2064 6174 615b 226d 656d         data["mem
-00023270: 6f72 795f 7065 7263 656e 7422 5d5b 2d31  ory_percent"][-1
-00023280: 5d20 3d20 2222 0a20 2020 2020 2020 2020  ] = "".         
-00023290: 2020 2064 6174 615b 226d 656d 6f72 795f     data["memory_
-000232a0: 6c69 6d69 7422 5d5b 2d31 5d20 3d20 7773  limit"][-1] = ws
-000232b0: 2e6d 656d 6f72 795f 6c69 6d69 740a 2020  .memory_limit.  
-000232c0: 2020 2020 2020 2020 2020 6461 7461 5b22            data["
-000232d0: 6d65 6d6f 7279 5f6d 616e 6167 6564 225d  memory_managed"]
-000232e0: 5b2d 315d 203d 206d 696e 666f 2e6d 616e  [-1] = minfo.man
-000232f0: 6167 6564 0a20 2020 2020 2020 2020 2020  aged.           
-00023300: 2064 6174 615b 226d 656d 6f72 795f 756e   data["memory_un
-00023310: 6d61 6e61 6765 645f 6f6c 6422 5d5b 2d31  managed_old"][-1
-00023320: 5d20 3d20 6d69 6e66 6f2e 756e 6d61 6e61  ] = minfo.unmana
-00023330: 6765 645f 6f6c 640a 2020 2020 2020 2020  ged_old.        
-00023340: 2020 2020 6461 7461 5b22 6d65 6d6f 7279      data["memory
-00023350: 5f75 6e6d 616e 6167 6564 5f72 6563 656e  _unmanaged_recen
-00023360: 7422 5d5b 2d31 5d20 3d20 6d69 6e66 6f2e  t"][-1] = minfo.
-00023370: 756e 6d61 6e61 6765 645f 7265 6365 6e74  unmanaged_recent
-00023380: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-00023390: 615b 226d 656d 6f72 795f 756e 6d61 6e61  a["memory_unmana
-000233a0: 6765 645f 7265 6365 6e74 225d 5b2d 315d  ged_recent"][-1]
-000233b0: 203d 206d 696e 666f 2e75 6e6d 616e 6167   = minfo.unmanag
-000233c0: 6564 5f72 6563 656e 740a 2020 2020 2020  ed_recent.      
-000233d0: 2020 2020 2020 6461 7461 5b22 6d65 6d6f        data["memo
-000233e0: 7279 5f73 7069 6c6c 6564 225d 5b2d 315d  ry_spilled"][-1]
-000233f0: 203d 206d 696e 666f 2e73 7069 6c6c 6564   = minfo.spilled
-00023400: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-00023410: 615b 2263 7075 225d 5b2d 315d 203d 2077  a["cpu"][-1] = w
-00023420: 732e 6d65 7472 6963 735b 2263 7075 225d  s.metrics["cpu"]
-00023430: 202f 2031 3030 2e30 0a20 2020 2020 2020   / 100.0.       
-00023440: 2020 2020 2064 6174 615b 2263 7075 5f66       data["cpu_f
-00023450: 7261 6374 696f 6e22 5d5b 2d31 5d20 3d20  raction"][-1] = 
-00023460: 7773 2e6d 6574 7269 6373 5b22 6370 7522  ws.metrics["cpu"
-00023470: 5d20 2f20 3130 302e 3020 2f20 7773 2e6e  ] / 100.0 / ws.n
-00023480: 7468 7265 6164 730a 2020 2020 2020 2020  threads.        
-00023490: 2020 2020 6461 7461 5b22 6e74 6872 6561      data["nthrea
-000234a0: 6473 225d 5b2d 315d 203d 2077 732e 6e74  ds"][-1] = ws.nt
-000234b0: 6872 6561 6473 0a0a 2020 2020 2020 2020  hreads..        
-000234c0: 666f 7220 6e61 6d65 2069 6e20 7365 6c66  for name in self
-000234d0: 2e6e 616d 6573 202b 2073 656c 662e 6578  .names + self.ex
-000234e0: 7472 615f 6e61 6d65 733a 0a20 2020 2020  tra_names:.     
-000234f0: 2020 2020 2020 2069 6620 6e61 6d65 203d         if name =
-00023500: 3d20 226e 616d 6522 3a0a 2020 2020 2020  = "name":.      
-00023510: 2020 2020 2020 2020 2020 6461 7461 5b6e            data[n
-00023520: 616d 655d 2e69 6e73 6572 7428 302c 2066  ame].insert(0, f
-00023530: 2254 6f74 616c 2028 7b6c 656e 2864 6174  "Total ({len(dat
-00023540: 615b 6e61 6d65 5d29 7d29 2229 0a20 2020  a[name])})").   
-00023550: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00023560: 7469 6e75 650a 2020 2020 2020 2020 2020  tinue.          
-00023570: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00023580: 2020 2020 2020 2069 6620 6c65 6e28 7365         if len(se
-00023590: 6c66 2e73 6368 6564 756c 6572 2e77 6f72  lf.scheduler.wor
-000235a0: 6b65 7273 2920 3d3d 2030 3a0a 2020 2020  kers) == 0:.    
-000235b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000235c0: 746f 7461 6c5f 6461 7461 203d 204e 6f6e  total_data = Non
-000235d0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-000235e0: 2020 656c 6966 206e 616d 6520 3d3d 2022    elif name == "
-000235f0: 6d65 6d6f 7279 5f70 6572 6365 6e74 223a  memory_percent":
-00023600: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023610: 2020 2020 2074 6f74 616c 5f6d 656d 203d       total_mem =
-00023620: 2073 756d 280a 2020 2020 2020 2020 2020   sum(.          
-00023630: 2020 2020 2020 2020 2020 2020 2020 7773                ws
-00023640: 2e6d 656d 6f72 795f 6c69 6d69 7420 666f  .memory_limit fo
-00023650: 7220 7773 2069 6e20 7365 6c66 2e73 6368  r ws in self.sch
-00023660: 6564 756c 6572 2e77 6f72 6b65 7273 2e76  eduler.workers.v
-00023670: 616c 7565 7328 290a 2020 2020 2020 2020  alues().        
-00023680: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00023690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000236a0: 2020 746f 7461 6c5f 6461 7461 203d 2028    total_data = (
-000236b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000236c0: 2020 2020 2020 2020 2028 0a20 2020 2020           (.     
-000236d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000236e0: 2020 2020 2020 2073 756d 280a 2020 2020         sum(.    
+00023170: 6e61 6d65 5d2e 6170 7065 6e64 2876 290a  name].append(v).
+00023180: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
+00023190: 615b 226e 616d 6522 5d5b 2d31 5d20 3d20  a["name"][-1] = 
+000231a0: 7773 2e6e 616d 6520 6966 2077 732e 6e61  ws.name if ws.na
+000231b0: 6d65 2069 7320 6e6f 7420 4e6f 6e65 2065  me is not None e
+000231c0: 6c73 6520 690a 2020 2020 2020 2020 2020  lse i.          
+000231d0: 2020 6461 7461 5b22 6164 6472 6573 7322    data["address"
+000231e0: 5d5b 2d31 5d20 3d20 7773 2e61 6464 7265  ][-1] = ws.addre
+000231f0: 7373 0a20 2020 2020 2020 2020 2020 2069  ss.            i
+00023200: 6620 7773 2e6d 656d 6f72 795f 6c69 6d69  f ws.memory_limi
+00023210: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+00023220: 2020 2064 6174 615b 226d 656d 6f72 795f     data["memory_
+00023230: 7065 7263 656e 7422 5d5b 2d31 5d20 3d20  percent"][-1] = 
+00023240: 7773 2e6d 6574 7269 6373 5b22 6d65 6d6f  ws.metrics["memo
+00023250: 7279 225d 202f 2077 732e 6d65 6d6f 7279  ry"] / ws.memory
+00023260: 5f6c 696d 6974 0a20 2020 2020 2020 2020  _limit.         
+00023270: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00023280: 2020 2020 2020 2020 2064 6174 615b 226d           data["m
+00023290: 656d 6f72 795f 7065 7263 656e 7422 5d5b  emory_percent"][
+000232a0: 2d31 5d20 3d20 2222 0a20 2020 2020 2020  -1] = "".       
+000232b0: 2020 2020 2064 6174 615b 226d 656d 6f72       data["memor
+000232c0: 795f 6c69 6d69 7422 5d5b 2d31 5d20 3d20  y_limit"][-1] = 
+000232d0: 7773 2e6d 656d 6f72 795f 6c69 6d69 740a  ws.memory_limit.
+000232e0: 2020 2020 2020 2020 2020 2020 6461 7461              data
+000232f0: 5b22 6d65 6d6f 7279 5f6d 616e 6167 6564  ["memory_managed
+00023300: 225d 5b2d 315d 203d 206d 696e 666f 2e6d  "][-1] = minfo.m
+00023310: 616e 6167 6564 0a20 2020 2020 2020 2020  anaged.         
+00023320: 2020 2064 6174 615b 226d 656d 6f72 795f     data["memory_
+00023330: 756e 6d61 6e61 6765 645f 6f6c 6422 5d5b  unmanaged_old"][
+00023340: 2d31 5d20 3d20 6d69 6e66 6f2e 756e 6d61  -1] = minfo.unma
+00023350: 6e61 6765 645f 6f6c 640a 2020 2020 2020  naged_old.      
+00023360: 2020 2020 2020 6461 7461 5b22 6d65 6d6f        data["memo
+00023370: 7279 5f75 6e6d 616e 6167 6564 5f72 6563  ry_unmanaged_rec
+00023380: 656e 7422 5d5b 2d31 5d20 3d20 6d69 6e66  ent"][-1] = minf
+00023390: 6f2e 756e 6d61 6e61 6765 645f 7265 6365  o.unmanaged_rece
+000233a0: 6e74 0a20 2020 2020 2020 2020 2020 2064  nt.            d
+000233b0: 6174 615b 226d 656d 6f72 795f 756e 6d61  ata["memory_unma
+000233c0: 6e61 6765 645f 7265 6365 6e74 225d 5b2d  naged_recent"][-
+000233d0: 315d 203d 206d 696e 666f 2e75 6e6d 616e  1] = minfo.unman
+000233e0: 6167 6564 5f72 6563 656e 740a 2020 2020  aged_recent.    
+000233f0: 2020 2020 2020 2020 6461 7461 5b22 6d65          data["me
+00023400: 6d6f 7279 5f73 7069 6c6c 6564 225d 5b2d  mory_spilled"][-
+00023410: 315d 203d 206d 696e 666f 2e73 7069 6c6c  1] = minfo.spill
+00023420: 6564 0a20 2020 2020 2020 2020 2020 2064  ed.            d
+00023430: 6174 615b 2263 7075 225d 5b2d 315d 203d  ata["cpu"][-1] =
+00023440: 2077 732e 6d65 7472 6963 735b 2263 7075   ws.metrics["cpu
+00023450: 225d 202f 2031 3030 2e30 0a20 2020 2020  "] / 100.0.     
+00023460: 2020 2020 2020 2064 6174 615b 2263 7075         data["cpu
+00023470: 5f66 7261 6374 696f 6e22 5d5b 2d31 5d20  _fraction"][-1] 
+00023480: 3d20 7773 2e6d 6574 7269 6373 5b22 6370  = ws.metrics["cp
+00023490: 7522 5d20 2f20 3130 302e 3020 2f20 7773  u"] / 100.0 / ws
+000234a0: 2e6e 7468 7265 6164 730a 2020 2020 2020  .nthreads.      
+000234b0: 2020 2020 2020 6461 7461 5b22 6e74 6872        data["nthr
+000234c0: 6561 6473 225d 5b2d 315d 203d 2077 732e  eads"][-1] = ws.
+000234d0: 6e74 6872 6561 6473 0a0a 2020 2020 2020  nthreads..      
+000234e0: 2020 666f 7220 6e61 6d65 2069 6e20 7365    for name in se
+000234f0: 6c66 2e6e 616d 6573 202b 2073 656c 662e  lf.names + self.
+00023500: 6578 7472 615f 6e61 6d65 733a 0a20 2020  extra_names:.   
+00023510: 2020 2020 2020 2020 2069 6620 6e61 6d65           if name
+00023520: 203d 3d20 226e 616d 6522 3a0a 2020 2020   == "name":.    
+00023530: 2020 2020 2020 2020 2020 2020 6461 7461              data
+00023540: 5b6e 616d 655d 2e69 6e73 6572 7428 302c  [name].insert(0,
+00023550: 2066 2254 6f74 616c 2028 7b6c 656e 2864   f"Total ({len(d
+00023560: 6174 615b 6e61 6d65 5d29 7d29 2229 0a20  ata[name])})"). 
+00023570: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00023580: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+00023590: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+000235a0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+000235b0: 7365 6c66 2e73 6368 6564 756c 6572 2e77  self.scheduler.w
+000235c0: 6f72 6b65 7273 2920 3d3d 2030 3a0a 2020  orkers) == 0:.  
+000235d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000235e0: 2020 746f 7461 6c5f 6461 7461 203d 204e    total_data = N
+000235f0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00023600: 2020 2020 656c 6966 206e 616d 6520 3d3d      elif name ==
+00023610: 2022 6d65 6d6f 7279 5f70 6572 6365 6e74   "memory_percent
+00023620: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
+00023630: 2020 2020 2020 2074 6f74 616c 5f6d 656d         total_mem
+00023640: 203d 2073 756d 280a 2020 2020 2020 2020   = sum(.        
+00023650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023660: 7773 2e6d 656d 6f72 795f 6c69 6d69 7420  ws.memory_limit 
+00023670: 666f 7220 7773 2069 6e20 7365 6c66 2e73  for ws in self.s
+00023680: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+00023690: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
+000236a0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000236b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000236c0: 2020 2020 746f 7461 6c5f 6461 7461 203d      total_data =
+000236d0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+000236e0: 2020 2020 2020 2020 2020 2028 0a20 2020             (.   
 000236f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023700: 2020 2020 2020 2020 2020 2020 7773 2e6d              ws.m
-00023710: 6574 7269 6373 5b22 6d65 6d6f 7279 225d  etrics["memory"]
-00023720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023740: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-00023750: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
-00023760: 732e 7661 6c75 6573 2829 0a20 2020 2020  s.values().     
-00023770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023780: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00023700: 2020 2020 2020 2020 2073 756d 280a 2020           sum(.  
+00023710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023720: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+00023730: 2e6d 6574 7269 6373 5b22 6d65 6d6f 7279  .metrics["memory
+00023740: 225d 0a20 2020 2020 2020 2020 2020 2020  "].             
+00023750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023760: 2020 2066 6f72 2077 7320 696e 2073 656c     for ws in sel
+00023770: 662e 7363 6865 6475 6c65 722e 776f 726b  f.scheduler.work
+00023780: 6572 732e 7661 6c75 6573 2829 0a20 2020  ers.values().   
 00023790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000237a0: 2020 2020 202f 2074 6f74 616c 5f6d 656d       / total_mem
-000237b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000237c0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-000237d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000237e0: 2020 2069 6620 746f 7461 6c5f 6d65 6d0a     if total_mem.
+000237a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000237b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000237c0: 2020 2020 2020 202f 2074 6f74 616c 5f6d         / total_m
+000237d0: 656d 0a20 2020 2020 2020 2020 2020 2020  em.             
+000237e0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
 000237f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023800: 2020 2020 2020 2020 656c 7365 2022 220a          else "".
-00023810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023820: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00023830: 2020 2020 2020 656c 6966 206e 616d 6520        elif name 
-00023840: 3d3d 2022 6370 7522 3a0a 2020 2020 2020  == "cpu":.      
-00023850: 2020 2020 2020 2020 2020 2020 2020 746f                to
-00023860: 7461 6c5f 6461 7461 203d 2028 0a20 2020  tal_data = (.   
+00023800: 2020 2020 2069 6620 746f 7461 6c5f 6d65       if total_me
+00023810: 6d0a 2020 2020 2020 2020 2020 2020 2020  m.              
+00023820: 2020 2020 2020 2020 2020 656c 7365 2022            else "
+00023830: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+00023840: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00023850: 2020 2020 2020 2020 656c 6966 206e 616d          elif nam
+00023860: 6520 3d3d 2022 6370 7522 3a0a 2020 2020  e == "cpu":.    
 00023870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023880: 2020 2020 2073 756d 2877 732e 6d65 7472       sum(ws.metr
-00023890: 6963 735b 2263 7075 225d 2066 6f72 2077  ics["cpu"] for w
-000238a0: 7320 696e 2073 656c 662e 7363 6865 6475  s in self.schedu
-000238b0: 6c65 722e 776f 726b 6572 732e 7661 6c75  ler.workers.valu
-000238c0: 6573 2829 290a 2020 2020 2020 2020 2020  es()).          
-000238d0: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
-000238e0: 3130 300a 2020 2020 2020 2020 2020 2020  100.            
-000238f0: 2020 2020 2020 2020 2020 2020 2f20 6c65              / le
-00023900: 6e28 7365 6c66 2e73 6368 6564 756c 6572  n(self.scheduler
-00023910: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-00023920: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00023930: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00023940: 2020 2020 2020 2020 2065 6c69 6620 6e61           elif na
-00023950: 6d65 203d 3d20 2263 7075 5f66 7261 6374  me == "cpu_fract
-00023960: 696f 6e22 3a0a 2020 2020 2020 2020 2020  ion":.          
-00023970: 2020 2020 2020 2020 2020 746f 7461 6c5f            total_
-00023980: 6461 7461 203d 2028 0a20 2020 2020 2020  data = (.       
-00023990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000239a0: 2073 756d 2877 732e 6d65 7472 6963 735b   sum(ws.metrics[
-000239b0: 2263 7075 225d 2066 6f72 2077 7320 696e  "cpu"] for ws in
-000239c0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
-000239d0: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
-000239e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000239f0: 2020 2020 2020 2020 2020 2f20 3130 300a            / 100.
-00023a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a10: 2020 2020 2020 2020 2f20 7375 6d28 7773          / sum(ws
-00023a20: 2e6e 7468 7265 6164 7320 666f 7220 7773  .nthreads for ws
-00023a30: 2069 6e20 7365 6c66 2e73 6368 6564 756c   in self.schedul
-00023a40: 6572 2e77 6f72 6b65 7273 2e76 616c 7565  er.workers.value
-00023a50: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
-00023a60: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00023a70: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00023a80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023a90: 2020 2020 2074 6f74 616c 5f64 6174 6120       total_data 
-00023aa0: 3d20 7375 6d28 6461 7461 5b6e 616d 655d  = sum(data[name]
-00023ab0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00023ac0: 2020 2064 6174 615b 6e61 6d65 5d2e 696e     data[name].in
-00023ad0: 7365 7274 2830 2c20 746f 7461 6c5f 6461  sert(0, total_da
-00023ae0: 7461 290a 2020 2020 2020 2020 2020 2020  ta).            
-00023af0: 6578 6365 7074 2054 7970 6545 7272 6f72  except TypeError
-00023b00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00023b10: 2020 6461 7461 5b6e 616d 655d 2e69 6e73    data[name].ins
-00023b20: 6572 7428 302c 204e 6f6e 6529 0a0a 2020  ert(0, None)..  
-00023b30: 2020 2020 2020 7365 6c66 2e73 6f75 7263        self.sourc
-00023b40: 652e 6461 7461 2e75 7064 6174 6528 6461  e.data.update(da
-00023b50: 7461 290a 0a0a 636c 6173 7320 5368 7566  ta)...class Shuf
-00023b60: 666c 696e 6728 4461 7368 626f 6172 6443  fling(DashboardC
-00023b70: 6f6d 706f 6e65 6e74 293a 0a20 2020 2022  omponent):.    "
-00023b80: 2222 4f63 6375 7061 6e63 7920 2869 6e20  ""Occupancy (in 
-00023b90: 7469 6d65 2920 7065 7220 776f 726b 6572  time) per worker
-00023ba0: 2222 220a 0a20 2020 2040 6c6f 675f 6572  """..    @log_er
-00023bb0: 726f 7273 0a20 2020 2064 6566 205f 5f69  rors.    def __i
-00023bc0: 6e69 745f 5f28 7365 6c66 2c20 7363 6865  nit__(self, sche
-00023bd0: 6475 6c65 722c 202a 2a6b 7761 7267 7329  duler, **kwargs)
-00023be0: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
-00023bf0: 6368 6564 756c 6572 203d 2073 6368 6564  cheduler = sched
-00023c00: 756c 6572 0a20 2020 2020 2020 2073 656c  uler.        sel
-00023c10: 662e 736f 7572 6365 203d 2043 6f6c 756d  f.source = Colum
-00023c20: 6e44 6174 6153 6f75 7263 6528 0a20 2020  nDataSource(.   
-00023c30: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00023c40: 2020 2020 2020 2020 2020 2022 776f 726b             "work
-00023c50: 6572 223a 205b 5d2c 0a20 2020 2020 2020  er": [],.       
-00023c60: 2020 2020 2020 2020 2022 7922 3a20 5b5d           "y": []
-00023c70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00023c80: 2020 2263 6f6d 6d5f 6d65 6d6f 7279 223a    "comm_memory":
-00023c90: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00023ca0: 2020 2020 2022 636f 6d6d 5f6d 656d 6f72       "comm_memor
-00023cb0: 795f 6c69 6d69 7422 3a20 5b5d 2c0a 2020  y_limit": [],.  
-00023cc0: 2020 2020 2020 2020 2020 2020 2020 2263                "c
-00023cd0: 6f6d 6d5f 6275 636b 6574 7322 3a20 5b5d  omm_buckets": []
-00023ce0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00023cf0: 2020 2263 6f6d 6d5f 6176 675f 6475 7261    "comm_avg_dura
-00023d00: 7469 6f6e 223a 205b 5d2c 0a20 2020 2020  tion": [],.     
-00023d10: 2020 2020 2020 2020 2020 2022 636f 6d6d             "comm
-00023d20: 5f61 7667 5f73 697a 6522 3a20 5b5d 2c0a  _avg_size": [],.
-00023d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023d40: 2263 6f6d 6d5f 7265 6164 223a 205b 5d2c  "comm_read": [],
-00023d50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023d60: 2022 636f 6d6d 5f77 7269 7474 656e 223a   "comm_written":
-00023d70: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00023d80: 2020 2020 2022 636f 6d6d 5f63 6f6c 6f72       "comm_color
+00023880: 746f 7461 6c5f 6461 7461 203d 2028 0a20  total_data = (. 
+00023890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000238a0: 2020 2020 2020 2073 756d 2877 732e 6d65         sum(ws.me
+000238b0: 7472 6963 735b 2263 7075 225d 2066 6f72  trics["cpu"] for
+000238c0: 2077 7320 696e 2073 656c 662e 7363 6865   ws in self.sche
+000238d0: 6475 6c65 722e 776f 726b 6572 732e 7661  duler.workers.va
+000238e0: 6c75 6573 2829 290a 2020 2020 2020 2020  lues()).        
+000238f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023900: 2f20 3130 300a 2020 2020 2020 2020 2020  / 100.          
+00023910: 2020 2020 2020 2020 2020 2020 2020 2f20                / 
+00023920: 6c65 6e28 7365 6c66 2e73 6368 6564 756c  len(self.schedul
+00023930: 6572 2e77 6f72 6b65 7273 2e76 616c 7565  er.workers.value
+00023940: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
+00023950: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00023960: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00023970: 6e61 6d65 203d 3d20 2263 7075 5f66 7261  name == "cpu_fra
+00023980: 6374 696f 6e22 3a0a 2020 2020 2020 2020  ction":.        
+00023990: 2020 2020 2020 2020 2020 2020 746f 7461              tota
+000239a0: 6c5f 6461 7461 203d 2028 0a20 2020 2020  l_data = (.     
+000239b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000239c0: 2020 2073 756d 2877 732e 6d65 7472 6963     sum(ws.metric
+000239d0: 735b 2263 7075 225d 2066 6f72 2077 7320  s["cpu"] for ws 
+000239e0: 696e 2073 656c 662e 7363 6865 6475 6c65  in self.schedule
+000239f0: 722e 776f 726b 6572 732e 7661 6c75 6573  r.workers.values
+00023a00: 2829 290a 2020 2020 2020 2020 2020 2020  ()).            
+00023a10: 2020 2020 2020 2020 2020 2020 2f20 3130              / 10
+00023a20: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+00023a30: 2020 2020 2020 2020 2020 2f20 7375 6d28            / sum(
+00023a40: 7773 2e6e 7468 7265 6164 7320 666f 7220  ws.nthreads for 
+00023a50: 7773 2069 6e20 7365 6c66 2e73 6368 6564  ws in self.sched
+00023a60: 756c 6572 2e77 6f72 6b65 7273 2e76 616c  uler.workers.val
+00023a70: 7565 7328 2929 0a20 2020 2020 2020 2020  ues()).         
+00023a80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00023a90: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00023aa0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00023ab0: 2020 2020 2020 2074 6f74 616c 5f64 6174         total_dat
+00023ac0: 6120 3d20 7375 6d28 6461 7461 5b6e 616d  a = sum(data[nam
+00023ad0: 655d 290a 0a20 2020 2020 2020 2020 2020  e])..           
+00023ae0: 2020 2020 2064 6174 615b 6e61 6d65 5d2e       data[name].
+00023af0: 696e 7365 7274 2830 2c20 746f 7461 6c5f  insert(0, total_
+00023b00: 6461 7461 290a 2020 2020 2020 2020 2020  data).          
+00023b10: 2020 6578 6365 7074 2054 7970 6545 7272    except TypeErr
+00023b20: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00023b30: 2020 2020 6461 7461 5b6e 616d 655d 2e69      data[name].i
+00023b40: 6e73 6572 7428 302c 204e 6f6e 6529 0a0a  nsert(0, None)..
+00023b50: 2020 2020 2020 2020 7365 6c66 2e73 6f75          self.sou
+00023b60: 7263 652e 6461 7461 2e75 7064 6174 6528  rce.data.update(
+00023b70: 6461 7461 290a 0a0a 636c 6173 7320 5368  data)...class Sh
+00023b80: 7566 666c 696e 6728 4461 7368 626f 6172  uffling(Dashboar
+00023b90: 6443 6f6d 706f 6e65 6e74 293a 0a20 2020  dComponent):.   
+00023ba0: 2022 2222 4f63 6375 7061 6e63 7920 2869   """Occupancy (i
+00023bb0: 6e20 7469 6d65 2920 7065 7220 776f 726b  n time) per work
+00023bc0: 6572 2222 220a 0a20 2020 2040 6c6f 675f  er"""..    @log_
+00023bd0: 6572 726f 7273 0a20 2020 2064 6566 205f  errors.    def _
+00023be0: 5f69 6e69 745f 5f28 7365 6c66 2c20 7363  _init__(self, sc
+00023bf0: 6865 6475 6c65 722c 202a 2a6b 7761 7267  heduler, **kwarg
+00023c00: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
+00023c10: 2e73 6368 6564 756c 6572 203d 2073 6368  .scheduler = sch
+00023c20: 6564 756c 6572 0a20 2020 2020 2020 2073  eduler.        s
+00023c30: 656c 662e 736f 7572 6365 203d 2043 6f6c  elf.source = Col
+00023c40: 756d 6e44 6174 6153 6f75 7263 6528 0a20  umnDataSource(. 
+00023c50: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00023c60: 2020 2020 2020 2020 2020 2020 2022 776f               "wo
+00023c70: 726b 6572 223a 205b 5d2c 0a20 2020 2020  rker": [],.     
+00023c80: 2020 2020 2020 2020 2020 2022 7922 3a20             "y": 
+00023c90: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00023ca0: 2020 2020 2263 6f6d 6d5f 6d65 6d6f 7279      "comm_memory
+00023cb0: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00023cc0: 2020 2020 2020 2022 636f 6d6d 5f6d 656d         "comm_mem
+00023cd0: 6f72 795f 6c69 6d69 7422 3a20 5b5d 2c0a  ory_limit": [],.
+00023ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023cf0: 2263 6f6d 6d5f 6275 636b 6574 7322 3a20  "comm_buckets": 
+00023d00: 5b5d 2c0a 2020 2020 2020 2020 2020 2020  [],.            
+00023d10: 2020 2020 2263 6f6d 6d5f 6176 675f 6475      "comm_avg_du
+00023d20: 7261 7469 6f6e 223a 205b 5d2c 0a20 2020  ration": [],.   
+00023d30: 2020 2020 2020 2020 2020 2020 2022 636f               "co
+00023d40: 6d6d 5f61 7667 5f73 697a 6522 3a20 5b5d  mm_avg_size": []
+00023d50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023d60: 2020 2263 6f6d 6d5f 7265 6164 223a 205b    "comm_read": [
+00023d70: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
+00023d80: 2020 2022 636f 6d6d 5f77 7269 7474 656e     "comm_written
 00023d90: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00023da0: 2020 2020 2020 2022 6469 736b 5f6d 656d         "disk_mem
-00023db0: 6f72 7922 3a20 5b5d 2c0a 2020 2020 2020  ory": [],.      
-00023dc0: 2020 2020 2020 2020 2020 2264 6973 6b5f            "disk_
-00023dd0: 6d65 6d6f 7279 5f6c 696d 6974 223a 205b  memory_limit": [
-00023de0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00023df0: 2020 2022 6469 736b 5f62 7563 6b65 7473     "disk_buckets
-00023e00: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
-00023e10: 2020 2020 2020 2022 6469 736b 5f61 7667         "disk_avg
-00023e20: 5f64 7572 6174 696f 6e22 3a20 5b5d 2c0a  _duration": [],.
-00023e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023e40: 2264 6973 6b5f 6176 675f 7369 7a65 223a  "disk_avg_size":
-00023e50: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
-00023e60: 2020 2020 2022 6469 736b 5f72 6561 6422       "disk_read"
-00023e70: 3a20 5b5d 2c0a 2020 2020 2020 2020 2020  : [],.          
-00023e80: 2020 2020 2020 2264 6973 6b5f 7772 6974        "disk_writ
-00023e90: 7465 6e22 3a20 5b5d 2c0a 2020 2020 2020  ten": [],.      
-00023ea0: 2020 2020 2020 2020 2020 2264 6973 6b5f            "disk_
-00023eb0: 636f 6c6f 7222 3a20 5b5d 2c0a 2020 2020  color": [],.    
-00023ec0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00023ed0: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00023ee0: 2e74 6f74 616c 735f 736f 7572 6365 203d  .totals_source =
-00023ef0: 2043 6f6c 756d 6e44 6174 6153 6f75 7263   ColumnDataSourc
-00023f00: 6528 0a20 2020 2020 2020 2020 2020 207b  e(.            {
-00023f10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00023f20: 2022 7822 3a20 5b22 4e65 7477 6f72 6b20   "x": ["Network 
-00023f30: 5365 6e64 222c 2022 4e65 7477 6f72 6b20  Send", "Network 
-00023f40: 5265 6365 6976 6522 2c20 2244 6973 6b20  Receive", "Disk 
-00023f50: 5772 6974 6522 2c20 2244 6973 6b20 5265  Write", "Disk Re
-00023f60: 6164 225d 2c0a 2020 2020 2020 2020 2020  ad"],.          
-00023f70: 2020 2020 2020 2276 616c 7565 7322 3a20        "values": 
-00023f80: 5b30 2c20 302c 2030 2c20 305d 2c0a 2020  [0, 0, 0, 0],.  
-00023f90: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-00023fa0: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-00023fb0: 656c 662e 636f 6d6d 5f6d 656d 6f72 7920  elf.comm_memory 
-00023fc0: 3d20 6669 6775 7265 280a 2020 2020 2020  = figure(.      
-00023fd0: 2020 2020 2020 7469 746c 653d 2243 6f6d        title="Com
-00023fe0: 6d73 2042 7566 6665 7222 2c0a 2020 2020  ms Buffer",.    
-00023ff0: 2020 2020 2020 2020 746f 6f6c 733d 2222          tools=""
-00024000: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-00024010: 6f6c 6261 725f 6c6f 6361 7469 6f6e 3d22  olbar_location="
-00024020: 6162 6f76 6522 2c0a 2020 2020 2020 2020  above",.        
-00024030: 2020 2020 785f 7261 6e67 653d 5261 6e67      x_range=Rang
-00024040: 6531 6428 302c 2031 3030 5f30 3030 5f30  e1d(0, 100_000_0
-00024050: 3030 292c 0a20 2020 2020 2020 2020 2020  00),.           
-00024060: 202a 2a6b 7761 7267 732c 0a20 2020 2020   **kwargs,.     
-00024070: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-00024080: 662e 636f 6d6d 5f6d 656d 6f72 792e 6862  f.comm_memory.hb
-00024090: 6172 280a 2020 2020 2020 2020 2020 2020  ar(.            
-000240a0: 736f 7572 6365 3d73 656c 662e 736f 7572  source=self.sour
-000240b0: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
-000240c0: 7269 6768 743d 2263 6f6d 6d5f 6d65 6d6f  right="comm_memo
-000240d0: 7279 222c 0a20 2020 2020 2020 2020 2020  ry",.           
-000240e0: 2079 3d22 7922 2c0a 2020 2020 2020 2020   y="y",.        
-000240f0: 2020 2020 6865 6967 6874 3d30 2e39 2c0a      height=0.9,.
-00024100: 2020 2020 2020 2020 2020 2020 636f 6c6f              colo
-00024110: 723d 2263 6f6d 6d5f 636f 6c6f 7222 2c0a  r="comm_color",.
-00024120: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00024130: 2020 686f 7665 7220 3d20 486f 7665 7254    hover = HoverT
-00024140: 6f6f 6c28 0a20 2020 2020 2020 2020 2020  ool(.           
-00024150: 2074 6f6f 6c74 6970 733d 5b0a 2020 2020   tooltips=[.    
-00024160: 2020 2020 2020 2020 2020 2020 2822 4d65              ("Me
-00024170: 6d6f 7279 2055 7365 6422 2c20 2240 636f  mory Used", "@co
-00024180: 6d6d 5f6d 656d 6f72 797b 302e 3030 2062  mm_memory{0.00 b
-00024190: 7d22 292c 0a20 2020 2020 2020 2020 2020  }"),.           
-000241a0: 2020 2020 2028 2241 7665 7261 6765 2057       ("Average W
-000241b0: 7269 7465 222c 2022 4063 6f6d 6d5f 6176  rite", "@comm_av
-000241c0: 675f 7369 7a65 7b30 2e30 3020 627d 2229  g_size{0.00 b}")
-000241d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000241e0: 2020 2822 2320 4275 636b 6574 7322 2c20    ("# Buckets", 
-000241f0: 2240 636f 6d6d 5f62 7563 6b65 7473 2229  "@comm_buckets")
-00024200: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00024210: 2020 2822 4176 6572 6167 6520 4475 7261    ("Average Dura
-00024220: 7469 6f6e 222c 2022 4063 6f6d 6d5f 6176  tion", "@comm_av
-00024230: 675f 6475 7261 7469 6f6e 2229 2c0a 2020  g_duration"),.  
-00024240: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-00024250: 2020 2020 2020 2020 2066 6f72 6d61 7474           formatt
-00024260: 6572 733d 7b22 4063 6f6d 6d5f 6176 675f  ers={"@comm_avg_
-00024270: 6475 7261 7469 6f6e 223a 2022 6461 7465  duration": "date
-00024280: 7469 6d65 227d 2c0a 2020 2020 2020 2020  time"},.        
-00024290: 2020 2020 6d6f 6465 3d22 686c 696e 6522      mode="hline"
-000242a0: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
-000242b0: 2020 2020 7365 6c66 2e63 6f6d 6d5f 6d65      self.comm_me
-000242c0: 6d6f 7279 2e61 6464 5f74 6f6f 6c73 2868  mory.add_tools(h
-000242d0: 6f76 6572 290a 2020 2020 2020 2020 7365  over).        se
-000242e0: 6c66 2e63 6f6d 6d5f 6d65 6d6f 7279 2e78  lf.comm_memory.x
-000242f0: 5f72 616e 6765 2e73 7461 7274 203d 2030  _range.start = 0
-00024300: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-00024310: 6d6d 5f6d 656d 6f72 792e 785f 7261 6e67  mm_memory.x_rang
-00024320: 652e 656e 6420 3d20 310a 2020 2020 2020  e.end = 1.      
-00024330: 2020 7365 6c66 2e63 6f6d 6d5f 6d65 6d6f    self.comm_memo
-00024340: 7279 2e78 6178 6973 5b30 5d2e 666f 726d  ry.xaxis[0].form
-00024350: 6174 7465 7220 3d20 4e75 6d65 7261 6c54  atter = NumeralT
-00024360: 6963 6b46 6f72 6d61 7474 6572 2866 6f72  ickFormatter(for
-00024370: 6d61 743d 2230 2e30 2062 2229 0a0a 2020  mat="0.0 b")..  
-00024380: 2020 2020 2020 7365 6c66 2e64 6973 6b5f        self.disk_
-00024390: 6d65 6d6f 7279 203d 2066 6967 7572 6528  memory = figure(
-000243a0: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
-000243b0: 6c65 3d22 4469 736b 2042 7566 6665 7222  le="Disk Buffer"
-000243c0: 2c0a 2020 2020 2020 2020 2020 2020 746f  ,.            to
-000243d0: 6f6c 733d 2222 2c0a 2020 2020 2020 2020  ols="",.        
-000243e0: 2020 2020 746f 6f6c 6261 725f 6c6f 6361      toolbar_loca
-000243f0: 7469 6f6e 3d22 6162 6f76 6522 2c0a 2020  tion="above",.  
-00024400: 2020 2020 2020 2020 2020 785f 7261 6e67            x_rang
-00024410: 653d 5261 6e67 6531 6428 302c 2031 3030  e=Range1d(0, 100
-00024420: 5f30 3030 5f30 3030 292c 0a20 2020 2020  _000_000),.     
-00024430: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
-00024440: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00024450: 2020 2073 656c 662e 6469 736b 5f6d 656d     self.disk_mem
-00024460: 6f72 792e 7961 7869 732e 7669 7369 626c  ory.yaxis.visibl
-00024470: 6520 3d20 4661 6c73 650a 0a20 2020 2020  e = False..     
-00024480: 2020 2073 656c 662e 6469 736b 5f6d 656d     self.disk_mem
-00024490: 6f72 792e 6862 6172 280a 2020 2020 2020  ory.hbar(.      
-000244a0: 2020 2020 2020 736f 7572 6365 3d73 656c        source=sel
-000244b0: 662e 736f 7572 6365 2c0a 2020 2020 2020  f.source,.      
-000244c0: 2020 2020 2020 7269 6768 743d 2264 6973        right="dis
-000244d0: 6b5f 6d65 6d6f 7279 222c 0a20 2020 2020  k_memory",.     
-000244e0: 2020 2020 2020 2079 3d22 7922 2c0a 2020         y="y",.  
-000244f0: 2020 2020 2020 2020 2020 6865 6967 6874            height
-00024500: 3d30 2e39 2c0a 2020 2020 2020 2020 2020  =0.9,.          
-00024510: 2020 636f 6c6f 723d 2264 6973 6b5f 636f    color="disk_co
-00024520: 6c6f 7222 2c0a 2020 2020 2020 2020 290a  lor",.        ).
-00024530: 0a20 2020 2020 2020 2068 6f76 6572 203d  .        hover =
-00024540: 2048 6f76 6572 546f 6f6c 280a 2020 2020   HoverTool(.    
-00024550: 2020 2020 2020 2020 746f 6f6c 7469 7073          tooltips
-00024560: 3d5b 0a20 2020 2020 2020 2020 2020 2020  =[.             
-00024570: 2020 2028 224d 656d 6f72 7920 5573 6564     ("Memory Used
-00024580: 222c 2022 4064 6973 6b5f 6d65 6d6f 7279  ", "@disk_memory
-00024590: 7b30 2e30 3020 627d 2229 2c0a 2020 2020  {0.00 b}"),.    
-000245a0: 2020 2020 2020 2020 2020 2020 2822 4176              ("Av
-000245b0: 6572 6167 6520 5772 6974 6522 2c20 2240  erage Write", "@
-000245c0: 6469 736b 5f61 7667 5f73 697a 657b 302e  disk_avg_size{0.
-000245d0: 3030 2062 7d22 292c 0a20 2020 2020 2020  00 b}"),.       
-000245e0: 2020 2020 2020 2020 2028 2223 2042 7563           ("# Buc
-000245f0: 6b65 7473 222c 2022 4064 6973 6b5f 6275  kets", "@disk_bu
-00024600: 636b 6574 7322 292c 0a20 2020 2020 2020  ckets"),.       
-00024610: 2020 2020 2020 2020 2028 2241 7665 7261           ("Avera
-00024620: 6765 2044 7572 6174 696f 6e22 2c20 2240  ge Duration", "@
-00024630: 6469 736b 5f61 7667 5f64 7572 6174 696f  disk_avg_duratio
-00024640: 6e22 292c 0a20 2020 2020 2020 2020 2020  n"),.           
-00024650: 205d 2c0a 2020 2020 2020 2020 2020 2020   ],.            
-00024660: 666f 726d 6174 7465 7273 3d7b 2240 6469  formatters={"@di
-00024670: 736b 5f61 7667 5f64 7572 6174 696f 6e22  sk_avg_duration"
-00024680: 3a20 2264 6174 6574 696d 6522 7d2c 0a20  : "datetime"},. 
-00024690: 2020 2020 2020 2020 2020 206d 6f64 653d             mode=
-000246a0: 2268 6c69 6e65 222c 0a20 2020 2020 2020  "hline",.       
-000246b0: 2029 0a20 2020 2020 2020 2073 656c 662e   ).        self.
-000246c0: 6469 736b 5f6d 656d 6f72 792e 6164 645f  disk_memory.add_
-000246d0: 746f 6f6c 7328 686f 7665 7229 0a20 2020  tools(hover).   
-000246e0: 2020 2020 2073 656c 662e 6469 736b 5f6d       self.disk_m
-000246f0: 656d 6f72 792e 7861 7869 735b 305d 2e66  emory.xaxis[0].f
-00024700: 6f72 6d61 7474 6572 203d 204e 756d 6572  ormatter = Numer
-00024710: 616c 5469 636b 466f 726d 6174 7465 7228  alTickFormatter(
-00024720: 666f 726d 6174 3d22 302e 3020 6222 290a  format="0.0 b").
-00024730: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
-00024740: 7461 6c73 203d 2066 6967 7572 6528 0a20  tals = figure(. 
-00024750: 2020 2020 2020 2020 2020 2074 6974 6c65             title
-00024760: 3d22 546f 7461 6c20 6d6f 7665 6d65 6e74  ="Total movement
-00024770: 222c 0a20 2020 2020 2020 2020 2020 2074  ",.            t
-00024780: 6f6f 6c73 3d22 222c 0a20 2020 2020 2020  ools="",.       
-00024790: 2020 2020 2074 6f6f 6c62 6172 5f6c 6f63       toolbar_loc
-000247a0: 6174 696f 6e3d 2261 626f 7665 222c 0a20  ation="above",. 
-000247b0: 2020 2020 2020 2020 2020 202a 2a6b 7761             **kwa
-000247c0: 7267 732c 0a20 2020 2020 2020 2029 0a20  rgs,.        ). 
-000247d0: 2020 2020 2020 2074 6974 6c65 7320 3d20         titles = 
-000247e0: 5b22 4e65 7477 6f72 6b20 5365 6e64 222c  ["Network Send",
-000247f0: 2022 4e65 7477 6f72 6b20 5265 6365 6976   "Network Receiv
-00024800: 6522 2c20 2244 6973 6b20 5772 6974 6522  e", "Disk Write"
-00024810: 2c20 2244 6973 6b20 5265 6164 225d 0a20  , "Disk Read"]. 
-00024820: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
-00024830: 6c73 203d 2066 6967 7572 6528 0a20 2020  ls = figure(.   
-00024840: 2020 2020 2020 2020 2078 5f72 616e 6765           x_range
-00024850: 3d74 6974 6c65 732c 0a20 2020 2020 2020  =titles,.       
-00024860: 2020 2020 2074 6974 6c65 3d22 546f 7461       title="Tota
-00024870: 6c73 222c 0a20 2020 2020 2020 2020 2020  ls",.           
-00024880: 2074 6f6f 6c62 6172 5f6c 6f63 6174 696f   toolbar_locatio
-00024890: 6e3d 4e6f 6e65 2c0a 2020 2020 2020 2020  n=None,.        
-000248a0: 2020 2020 746f 6f6c 733d 2222 2c0a 2020      tools="",.  
-000248b0: 2020 2020 2020 2020 2020 2a2a 6b77 6172            **kwar
-000248c0: 6773 2c0a 2020 2020 2020 2020 290a 0a20  gs,.        ).. 
-000248d0: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
-000248e0: 6c73 2e76 6261 7228 0a20 2020 2020 2020  ls.vbar(.       
-000248f0: 2020 2020 2078 3d22 7822 2c0a 2020 2020       x="x",.    
-00024900: 2020 2020 2020 2020 746f 703d 2276 616c          top="val
-00024910: 7565 7322 2c0a 2020 2020 2020 2020 2020  ues",.          
-00024920: 2020 7769 6474 683d 302e 392c 0a20 2020    width=0.9,.   
-00024930: 2020 2020 2020 2020 2073 6f75 7263 653d           source=
-00024940: 7365 6c66 2e74 6f74 616c 735f 736f 7572  self.totals_sour
-00024950: 6365 2c0a 2020 2020 2020 2020 290a 0a20  ce,.        ).. 
-00024960: 2020 2020 2020 2073 656c 662e 746f 7461         self.tota
-00024970: 6c73 2e78 6772 6964 2e67 7269 645f 6c69  ls.xgrid.grid_li
-00024980: 6e65 5f63 6f6c 6f72 203d 204e 6f6e 650a  ne_color = None.
-00024990: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
-000249a0: 616c 732e 795f 7261 6e67 652e 7374 6172  als.y_range.star
-000249b0: 7420 3d20 300a 2020 2020 2020 2020 7365  t = 0.        se
-000249c0: 6c66 2e74 6f74 616c 732e 7961 7869 735b  lf.totals.yaxis[
-000249d0: 305d 2e66 6f72 6d61 7474 6572 203d 204e  0].formatter = N
-000249e0: 756d 6572 616c 5469 636b 466f 726d 6174  umeralTickFormat
-000249f0: 7465 7228 666f 726d 6174 3d22 302e 3020  ter(format="0.0 
-00024a00: 6222 290a 0a20 2020 2020 2020 2068 6f76  b")..        hov
-00024a10: 6572 203d 2048 6f76 6572 546f 6f6c 280a  er = HoverTool(.
-00024a20: 2020 2020 2020 2020 2020 2020 746f 6f6c              tool
-00024a30: 7469 7073 3d5b 2822 546f 7461 6c22 2c20  tips=[("Total", 
-00024a40: 2240 7661 6c75 6573 7b30 2e30 3062 7d22  "@values{0.00b}"
-00024a50: 295d 2c0a 2020 2020 2020 2020 2020 2020  )],.            
-00024a60: 6d6f 6465 3d22 766c 696e 6522 2c0a 2020  mode="vline",.  
-00024a70: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00024a80: 7365 6c66 2e74 6f74 616c 732e 6164 645f  self.totals.add_
-00024a90: 746f 6f6c 7328 686f 7665 7229 0a0a 2020  tools(hover)..  
-00024aa0: 2020 2020 2020 7365 6c66 2e72 6f6f 7420        self.root 
-00024ab0: 3d20 726f 7728 7365 6c66 2e63 6f6d 6d5f  = row(self.comm_
-00024ac0: 6d65 6d6f 7279 2c20 7365 6c66 2e64 6973  memory, self.dis
-00024ad0: 6b5f 6d65 6d6f 7279 290a 0a20 2020 2040  k_memory)..    @
-00024ae0: 7769 7468 6f75 745f 7072 6f70 6572 7479  without_property
-00024af0: 5f76 616c 6964 6174 696f 6e0a 2020 2020  _validation.    
-00024b00: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
-00024b10: 6465 6620 7570 6461 7465 2873 656c 6629  def update(self)
-00024b20: 3a0a 2020 2020 2020 2020 696e 7075 7420  :.        input 
-00024b30: 3d20 7365 6c66 2e73 6368 6564 756c 6572  = self.scheduler
-00024b40: 2e65 7874 656e 7369 6f6e 735b 2273 6875  .extensions["shu
-00024b50: 6666 6c65 225d 2e68 6561 7274 6265 6174  ffle"].heartbeat
-00024b60: 730a 2020 2020 2020 2020 6966 206e 6f74  s.        if not
-00024b70: 2069 6e70 7574 3a0a 2020 2020 2020 2020   input:.        
-00024b80: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-00024b90: 2020 2020 696e 7075 7420 3d20 6c69 7374      input = list
-00024ba0: 2869 6e70 7574 2e76 616c 7565 7328 2929  (input.values())
-00024bb0: 5b2d 315d 2020 2320 544f 444f 3a20 6d75  [-1]  # TODO: mu
-00024bc0: 6c74 6970 6c65 2063 6f6e 6375 7272 656e  ltiple concurren
-00024bd0: 7420 7368 7566 666c 6573 0a0a 2020 2020  t shuffles..    
-00024be0: 2020 2020 6461 7461 203d 2064 6566 6175      data = defau
-00024bf0: 6c74 6469 6374 286c 6973 7429 0a20 2020  ltdict(list).   
-00024c00: 2020 2020 206e 6f77 203d 2074 696d 6528       now = time(
-00024c10: 290a 0a20 2020 2020 2020 2066 6f72 2069  )..        for i
-00024c20: 2c20 2877 6f72 6b65 722c 2064 2920 696e  , (worker, d) in
-00024c30: 2065 6e75 6d65 7261 7465 2869 6e70 7574   enumerate(input
-00024c40: 2e69 7465 6d73 2829 293a 0a20 2020 2020  .items()):.     
-00024c50: 2020 2020 2020 2064 6174 615b 2279 225d         data["y"]
-00024c60: 2e61 7070 656e 6428 6929 0a20 2020 2020  .append(i).     
-00024c70: 2020 2020 2020 2064 6174 615b 2277 6f72         data["wor
-00024c80: 6b65 7222 5d2e 6170 7065 6e64 2877 6f72  ker"].append(wor
-00024c90: 6b65 7229 0a20 2020 2020 2020 2020 2020  ker).           
-00024ca0: 2066 6f72 2070 7265 6669 7820 696e 205b   for prefix in [
-00024cb0: 2263 6f6d 6d22 2c20 2264 6973 6b22 5d3a  "comm", "disk"]:
-00024cc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024cd0: 206d 656d 6f72 795f 6c69 6d69 7420 3d20   memory_limit = 
-00024ce0: 645b 7072 6566 6978 5d5b 226d 656d 6f72  d[prefix]["memor
-00024cf0: 795f 6c69 6d69 7422 5d20 6f72 2030 0a20  y_limit"] or 0. 
-00024d00: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00024d10: 6174 615b 6622 7b70 7265 6669 787d 5f74  ata[f"{prefix}_t
-00024d20: 6f74 616c 225d 2e61 7070 656e 6428 645b  otal"].append(d[
-00024d30: 7072 6566 6978 5d5b 2274 6f74 616c 225d  prefix]["total"]
-00024d40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00024d50: 2020 6461 7461 5b66 227b 7072 6566 6978    data[f"{prefix
-00024d60: 7d5f 6d65 6d6f 7279 225d 2e61 7070 656e  }_memory"].appen
-00024d70: 6428 645b 7072 6566 6978 5d5b 226d 656d  d(d[prefix]["mem
-00024d80: 6f72 7922 5d29 0a20 2020 2020 2020 2020  ory"]).         
-00024d90: 2020 2020 2020 2064 6174 615b 6622 7b70         data[f"{p
-00024da0: 7265 6669 787d 5f6d 656d 6f72 795f 6c69  refix}_memory_li
-00024db0: 6d69 7422 5d2e 6170 7065 6e64 286d 656d  mit"].append(mem
-00024dc0: 6f72 795f 6c69 6d69 7429 0a20 2020 2020  ory_limit).     
-00024dd0: 2020 2020 2020 2020 2020 2064 6174 615b             data[
-00024de0: 6622 7b70 7265 6669 787d 5f62 7563 6b65  f"{prefix}_bucke
-00024df0: 7473 225d 2e61 7070 656e 6428 645b 7072  ts"].append(d[pr
-00024e00: 6566 6978 5d5b 2262 7563 6b65 7473 225d  efix]["buckets"]
-00024e10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00024e20: 2020 6461 7461 5b66 227b 7072 6566 6978    data[f"{prefix
-00024e30: 7d5f 6176 675f 6475 7261 7469 6f6e 225d  }_avg_duration"]
-00024e40: 2e61 7070 656e 6428 645b 7072 6566 6978  .append(d[prefix
-00024e50: 5d5b 2261 7667 5f64 7572 6174 696f 6e22  ]["avg_duration"
-00024e60: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-00024e70: 2020 2064 6174 615b 6622 7b70 7265 6669     data[f"{prefi
-00024e80: 787d 5f61 7667 5f73 697a 6522 5d2e 6170  x}_avg_size"].ap
-00024e90: 7065 6e64 2864 5b70 7265 6669 785d 5b22  pend(d[prefix]["
-00024ea0: 6176 675f 7369 7a65 225d 290a 2020 2020  avg_size"]).    
-00024eb0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-00024ec0: 5b66 227b 7072 6566 6978 7d5f 7265 6164  [f"{prefix}_read
-00024ed0: 225d 2e61 7070 656e 6428 645b 7072 6566  "].append(d[pref
-00024ee0: 6978 5d5b 2272 6561 6422 5d29 0a20 2020  ix]["read"]).   
-00024ef0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
-00024f00: 615b 6622 7b70 7265 6669 787d 5f77 7269  a[f"{prefix}_wri
-00024f10: 7474 656e 225d 2e61 7070 656e 6428 645b  tten"].append(d[
-00024f20: 7072 6566 6978 5d5b 2277 7269 7474 656e  prefix]["written
-00024f30: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
-00024f40: 2020 2020 6966 2073 656c 662e 7363 6865      if self.sche
-00024f50: 6475 6c65 722e 776f 726b 6572 735b 776f  duler.workers[wo
-00024f60: 726b 6572 5d2e 6c61 7374 5f73 6565 6e20  rker].last_seen 
-00024f70: 3c20 6e6f 7720 2d20 353a 0a20 2020 2020  < now - 5:.     
-00024f80: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00024f90: 6174 615b 6622 7b70 7265 6669 787d 5f63  ata[f"{prefix}_c
-00024fa0: 6f6c 6f72 225d 2e61 7070 656e 6428 2267  olor"].append("g
-00024fb0: 7261 7922 290a 2020 2020 2020 2020 2020  ray").          
-00024fc0: 2020 2020 2020 656c 6966 2064 5b70 7265        elif d[pre
-00024fd0: 6669 785d 5b22 6d65 6d6f 7279 225d 203e  fix]["memory"] >
-00024fe0: 206d 656d 6f72 795f 6c69 6d69 743a 0a20   memory_limit:. 
-00024ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025000: 2020 2064 6174 615b 6622 7b70 7265 6669     data[f"{prefi
-00025010: 787d 5f63 6f6c 6f72 225d 2e61 7070 656e  x}_color"].appen
-00025020: 6428 2272 6564 2229 0a20 2020 2020 2020  d("red").       
-00025030: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00025040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025050: 2020 2064 6174 615b 6622 7b70 7265 6669     data[f"{prefi
-00025060: 787d 5f63 6f6c 6f72 225d 2e61 7070 656e  x}_color"].appen
-00025070: 6428 2262 6c75 6522 290a 0a20 2020 2020  d("blue")..     
-00025080: 2020 2074 6f74 616c 7320 3d20 7b0a 2020     totals = {.  
-00025090: 2020 2020 2020 2020 2020 2278 223a 205b            "x": [
-000250a0: 224e 6574 776f 726b 2053 656e 6422 2c20  "Network Send", 
-000250b0: 224e 6574 776f 726b 2052 6563 6569 7665  "Network Receive
-000250c0: 222c 2022 4469 736b 2057 7269 7465 222c  ", "Disk Write",
-000250d0: 2022 4469 736b 2052 6561 6422 5d2c 0a20   "Disk Read"],. 
-000250e0: 2020 2020 2020 2020 2020 2022 7661 6c75             "valu
-000250f0: 6573 223a 205b 0a20 2020 2020 2020 2020  es": [.         
-00025100: 2020 2020 2020 2073 756d 2864 6174 615b         sum(data[
-00025110: 2263 6f6d 6d5f 7772 6974 7465 6e22 5d29  "comm_written"])
-00025120: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00025130: 2020 7375 6d28 6461 7461 5b22 636f 6d6d    sum(data["comm
-00025140: 5f72 6561 6422 5d29 2c0a 2020 2020 2020  _read"]),.      
-00025150: 2020 2020 2020 2020 2020 7375 6d28 6461            sum(da
-00025160: 7461 5b22 6469 736b 5f77 7269 7474 656e  ta["disk_written
-00025170: 225d 292c 0a20 2020 2020 2020 2020 2020  "]),.           
-00025180: 2020 2020 2073 756d 2864 6174 615b 2264       sum(data["d
-00025190: 6973 6b5f 7265 6164 225d 292c 0a20 2020  isk_read"]),.   
-000251a0: 2020 2020 2020 2020 205d 2c0a 2020 2020           ],.    
-000251b0: 2020 2020 7d0a 2020 2020 2020 2020 7570      }.        up
-000251c0: 6461 7465 2873 656c 662e 746f 7461 6c73  date(self.totals
-000251d0: 5f73 6f75 7263 652c 2074 6f74 616c 7329  _source, totals)
-000251e0: 0a0a 2020 2020 2020 2020 7570 6461 7465  ..        update
-000251f0: 2873 656c 662e 736f 7572 6365 2c20 6469  (self.source, di
-00025200: 6374 2864 6174 6129 290a 2020 2020 2020  ct(data)).      
-00025210: 2020 6c69 6d69 7420 3d20 6d61 7828 6461    limit = max(da
-00025220: 7461 5b22 636f 6d6d 5f6d 656d 6f72 795f  ta["comm_memory_
-00025230: 6c69 6d69 7422 5d20 2b20 6461 7461 5b22  limit"] + data["
-00025240: 6469 736b 5f6d 656d 6f72 795f 6c69 6d69  disk_memory_limi
-00025250: 7422 5d29 202a 2031 2e32 0a20 2020 2020  t"]) * 1.2.     
-00025260: 2020 2073 656c 662e 636f 6d6d 5f6d 656d     self.comm_mem
-00025270: 6f72 792e 785f 7261 6e67 652e 656e 6420  ory.x_range.end 
-00025280: 3d20 6c69 6d69 740a 2020 2020 2020 2020  = limit.        
-00025290: 7365 6c66 2e64 6973 6b5f 6d65 6d6f 7279  self.disk_memory
-000252a0: 2e78 5f72 616e 6765 2e65 6e64 203d 206c  .x_range.end = l
-000252b0: 696d 6974 0a0a 0a5f 5354 594c 4553 203d  imit..._STYLES =
-000252c0: 207b 0a20 2020 2022 7769 6474 6822 3a20   {.    "width": 
-000252d0: 2231 3030 2522 2c0a 2020 2020 2268 6569  "100%",.    "hei
-000252e0: 6768 7422 3a20 2231 3030 2522 2c0a 2020  ght": "100%",.  
-000252f0: 2020 226d 6178 2d77 6964 7468 223a 2022    "max-width": "
-00025300: 3139 3230 7078 222c 0a20 2020 2022 6d61  1920px",.    "ma
-00025310: 782d 6865 6967 6874 223a 2022 3130 3830  x-height": "1080
-00025320: 7078 222c 0a20 2020 2022 7061 6464 696e  px",.    "paddin
-00025330: 6722 3a20 2231 3270 7822 2c0a 2020 2020  g": "12px",.    
-00025340: 2262 6f72 6465 7222 3a20 2231 7078 2073  "border": "1px s
-00025350: 6f6c 6964 206c 6967 6874 6772 6179 222c  olid lightgray",
-00025360: 0a20 2020 2022 626f 782d 7368 6164 6f77  .    "box-shadow
-00025370: 223a 2022 696e 7365 7420 3170 7820 3020  ": "inset 1px 0 
-00025380: 3870 7820 3020 6c69 6768 7467 7261 7922  8px 0 lightgray"
-00025390: 2c0a 2020 2020 226f 7665 7266 6c6f 7722  ,.    "overflow"
-000253a0: 3a20 2261 7574 6f22 2c0a 7d0a 6966 2042  : "auto",.}.if B
-000253b0: 4f4b 4548 5f56 4552 5349 4f4e 2e6d 616a  OKEH_VERSION.maj
-000253c0: 6f72 203c 2033 3a0a 2020 2020 5f42 4f4b  or < 3:.    _BOK
-000253d0: 4548 5f53 5459 4c45 535f 4b57 4152 4753  EH_STYLES_KWARGS
-000253e0: 203d 207b 2273 7479 6c65 223a 205f 5354   = {"style": _ST
-000253f0: 594c 4553 7d0a 656c 7365 3a0a 2020 2020  YLES}.else:.    
-00025400: 5f42 4f4b 4548 5f53 5459 4c45 535f 4b57  _BOKEH_STYLES_KW
-00025410: 4152 4753 203d 207b 2273 7479 6c65 7322  ARGS = {"styles"
-00025420: 3a20 5f53 5459 4c45 537d 0a0a 0a63 6c61  : _STYLES}...cla
-00025430: 7373 2053 6368 6564 756c 6572 4c6f 6773  ss SchedulerLogs
-00025440: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
-00025450: 5f5f 2873 656c 662c 2073 6368 6564 756c  __(self, schedul
-00025460: 6572 2c20 7374 6172 743d 4e6f 6e65 293a  er, start=None):
-00025470: 0a20 2020 2020 2020 206c 6f67 7320 3d20  .        logs = 
-00025480: 7363 6865 6475 6c65 722e 6765 745f 6c6f  scheduler.get_lo
-00025490: 6773 2873 7461 7274 3d73 7461 7274 2c20  gs(start=start, 
-000254a0: 7469 6d65 7374 616d 7073 3d54 7275 6529  timestamps=True)
-000254b0: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-000254c0: 206c 6f67 733a 0a20 2020 2020 2020 2020   logs:.         
-000254d0: 2020 206c 6f67 735f 6874 6d6c 203d 2028     logs_html = (
-000254e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000254f0: 2027 3c70 2073 7479 6c65 3d22 666f 6e74   '<p style="font
-00025500: 2d66 616d 696c 793a 206d 6f6e 6f73 7061  -family: monospa
-00025510: 6365 3b20 6d61 7267 696e 3a20 303b 223e  ce; margin: 0;">
-00025520: 4e6f 206c 6f67 7320 746f 2072 6570 6f72  No logs to repor
-00025530: 743c 2f70 3e27 0a20 2020 2020 2020 2020  t</p>'.         
-00025540: 2020 2029 0a20 2020 2020 2020 2065 6c73     ).        els
-00025550: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
-00025560: 6f67 735f 6874 6d6c 203d 204c 6f67 280a  ogs_html = Log(.
-00025570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025580: 225c 6e22 2e6a 6f69 6e28 0a20 2020 2020  "\n".join(.     
-00025590: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000255a0: 2573 202d 2025 7322 0a20 2020 2020 2020  %s - %s".       
-000255b0: 2020 2020 2020 2020 2020 2020 2025 2028               % (
-000255c0: 6461 7465 7469 6d65 2e66 726f 6d74 696d  datetime.fromtim
-000255d0: 6573 7461 6d70 2874 696d 6529 2e73 7472  estamp(time).str
-000255e0: 6674 696d 6528 2225 483a 254d 3a25 532e  ftime("%H:%M:%S.
-000255f0: 2566 2229 2c20 6c69 6e65 290a 2020 2020  %f"), line).    
-00025600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025610: 666f 7220 7469 6d65 2c20 6c65 7665 6c2c  for time, level,
-00025620: 206c 696e 6520 696e 206c 6f67 730a 2020   line in logs.  
-00025630: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00025640: 2020 2020 2020 2020 2020 2020 292e 5f72              )._r
-00025650: 6570 725f 6874 6d6c 5f28 290a 0a20 2020  epr_html_()..   
-00025660: 2020 2020 2073 656c 662e 726f 6f74 203d       self.root =
-00025670: 2044 6976 2874 6578 743d 6c6f 6773 5f68   Div(text=logs_h
-00025680: 746d 6c2c 202a 2a5f 424f 4b45 485f 5354  tml, **_BOKEH_ST
-00025690: 594c 4553 5f4b 5741 5247 5329 0a0a 0a40  YLES_KWARGS)...@
-000256a0: 6c6f 675f 6572 726f 7273 0a64 6566 2073  log_errors.def s
-000256b0: 7973 7465 6d6d 6f6e 6974 6f72 5f64 6f63  ystemmonitor_doc
-000256c0: 2873 6368 6564 756c 6572 2c20 6578 7472  (scheduler, extr
-000256d0: 612c 2064 6f63 293a 0a20 2020 2073 7973  a, doc):.    sys
-000256e0: 6d6f 6e20 3d20 5379 7374 656d 4d6f 6e69  mon = SystemMoni
-000256f0: 746f 7228 7363 6865 6475 6c65 722c 2073  tor(scheduler, s
-00025700: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
-00025710: 7463 685f 626f 7468 2229 0a20 2020 2064  tch_both").    d
-00025720: 6f63 2e74 6974 6c65 203d 2022 4461 736b  oc.title = "Dask
-00025730: 3a20 5363 6865 6475 6c65 7220 5379 7374  : Scheduler Syst
-00025740: 656d 204d 6f6e 6974 6f72 220a 2020 2020  em Monitor".    
-00025750: 6164 645f 7065 7269 6f64 6963 5f63 616c  add_periodic_cal
-00025760: 6c62 6163 6b28 646f 632c 2073 7973 6d6f  lback(doc, sysmo
-00025770: 6e2c 2035 3030 290a 0a20 2020 2064 6f63  n, 500)..    doc
-00025780: 2e61 6464 5f72 6f6f 7428 7379 736d 6f6e  .add_root(sysmon
-00025790: 2e72 6f6f 7429 0a20 2020 2064 6f63 2e74  .root).    doc.t
-000257a0: 656d 706c 6174 6520 3d20 656e 762e 6765  emplate = env.ge
-000257b0: 745f 7465 6d70 6c61 7465 2822 7369 6d70  t_template("simp
-000257c0: 6c65 2e68 746d 6c22 290a 2020 2020 646f  le.html").    do
-000257d0: 632e 7465 6d70 6c61 7465 5f76 6172 6961  c.template_varia
-000257e0: 626c 6573 2e75 7064 6174 6528 6578 7472  bles.update(extr
-000257f0: 6129 0a20 2020 2064 6f63 2e74 6865 6d65  a).    doc.theme
-00025800: 203d 2042 4f4b 4548 5f54 4845 4d45 0a0a   = BOKEH_THEME..
-00025810: 0a40 6c6f 675f 6572 726f 7273 0a64 6566  .@log_errors.def
-00025820: 2073 6875 6666 6c69 6e67 5f64 6f63 2873   shuffling_doc(s
-00025830: 6368 6564 756c 6572 2c20 6578 7472 612c  cheduler, extra,
-00025840: 2064 6f63 293a 0a20 2020 2064 6f63 2e74   doc):.    doc.t
-00025850: 6974 6c65 203d 2022 4461 736b 3a20 5368  itle = "Dask: Sh
-00025860: 7566 666c 696e 6722 0a0a 2020 2020 7368  uffling"..    sh
-00025870: 7566 666c 696e 6720 3d20 5368 7566 666c  uffling = Shuffl
-00025880: 696e 6728 7363 6865 6475 6c65 722c 2077  ing(scheduler, w
-00025890: 6964 7468 3d34 3030 2c20 6865 6967 6874  idth=400, height
-000258a0: 3d34 3030 290a 2020 2020 776f 726b 6572  =400).    worker
-000258b0: 735f 6d65 6d6f 7279 203d 2057 6f72 6b65  s_memory = Worke
-000258c0: 7273 4d65 6d6f 7279 2873 6368 6564 756c  rsMemory(schedul
-000258d0: 6572 2c20 7769 6474 683d 3430 302c 2068  er, width=400, h
-000258e0: 6569 6768 743d 3430 3029 0a20 2020 2074  eight=400).    t
-000258f0: 696d 6573 6572 6965 7320 3d20 5379 7374  imeseries = Syst
-00025900: 656d 5469 6d65 7365 7269 6573 280a 2020  emTimeseries(.  
-00025910: 2020 2020 2020 7363 6865 6475 6c65 722c        scheduler,
-00025920: 2077 6964 7468 3d31 3630 302c 2068 6569   width=1600, hei
-00025930: 6768 743d 3230 302c 2066 6f6c 6c6f 775f  ght=200, follow_
-00025940: 696e 7465 7276 616c 3d31 3030 3030 0a20  interval=10000. 
-00025950: 2020 2029 0a20 2020 2065 7665 6e74 5f6c     ).    event_l
-00025960: 6f6f 7020 3d20 436f 6e74 656e 7469 6f6e  oop = Contention
-00025970: 2873 6368 6564 756c 6572 2c20 7769 6474  (scheduler, widt
-00025980: 683d 3230 302c 2068 6569 6768 743d 3430  h=200, height=40
-00025990: 3029 0a0a 2020 2020 6164 645f 7065 7269  0)..    add_peri
-000259a0: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
-000259b0: 632c 2073 6875 6666 6c69 6e67 2c20 3230  c, shuffling, 20
-000259c0: 3029 0a20 2020 2061 6464 5f70 6572 696f  0).    add_perio
-000259d0: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
-000259e0: 2c20 776f 726b 6572 735f 6d65 6d6f 7279  , workers_memory
-000259f0: 2c20 3230 3029 0a20 2020 2061 6464 5f70  , 200).    add_p
-00025a00: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00025a10: 2864 6f63 2c20 7469 6d65 7365 7269 6573  (doc, timeseries
-00025a20: 2c20 3530 3029 0a20 2020 2061 6464 5f70  , 500).    add_p
-00025a30: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00025a40: 2864 6f63 2c20 6576 656e 745f 6c6f 6f70  (doc, event_loop
-00025a50: 2c20 3530 3029 0a0a 2020 2020 7469 6d65  , 500)..    time
-00025a60: 7365 7269 6573 2e62 616e 6477 6964 7468  series.bandwidth
-00025a70: 2e79 5f72 616e 6765 203d 2074 696d 6573  .y_range = times
-00025a80: 6572 6965 732e 6469 736b 2e79 5f72 616e  eries.disk.y_ran
-00025a90: 6765 0a0a 2020 2020 646f 632e 6164 645f  ge..    doc.add_
-00025aa0: 726f 6f74 280a 2020 2020 2020 2020 636f  root(.        co
-00025ab0: 6c75 6d6e 280a 2020 2020 2020 2020 2020  lumn(.          
-00025ac0: 2020 726f 7728 0a20 2020 2020 2020 2020    row(.         
-00025ad0: 2020 2020 2020 2077 6f72 6b65 7273 5f6d         workers_m
-00025ae0: 656d 6f72 792e 726f 6f74 2c0a 2020 2020  emory.root,.    
-00025af0: 2020 2020 2020 2020 2020 2020 7368 7566              shuf
-00025b00: 666c 696e 672e 636f 6d6d 5f6d 656d 6f72  fling.comm_memor
-00025b10: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-00025b20: 2020 2073 6875 6666 6c69 6e67 2e64 6973     shuffling.dis
-00025b30: 6b5f 6d65 6d6f 7279 2c0a 2020 2020 2020  k_memory,.      
-00025b40: 2020 2020 2020 2020 2020 7368 7566 666c            shuffl
-00025b50: 696e 672e 746f 7461 6c73 2c0a 2020 2020  ing.totals,.    
-00025b60: 2020 2020 2020 2020 2020 2020 6576 656e              even
-00025b70: 745f 6c6f 6f70 2e72 6f6f 742c 0a20 2020  t_loop.root,.   
-00025b80: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
-00025b90: 2020 2020 2020 2020 726f 7728 636f 6c75          row(colu
-00025ba0: 6d6e 2874 696d 6573 6572 6965 732e 6261  mn(timeseries.ba
-00025bb0: 6e64 7769 6474 682c 2074 696d 6573 6572  ndwidth, timeser
-00025bc0: 6965 732e 6469 736b 2929 2c0a 2020 2020  ies.disk)),.    
-00025bd0: 2020 2020 290a 2020 2020 290a 2020 2020      ).    ).    
-00025be0: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
-00025bf0: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
-00025c00: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
-00025c10: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
-00025c20: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
-00025c30: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
-00025c40: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
-00025c50: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
-00025c60: 730a 6465 6620 7374 6561 6c69 6e67 5f64  s.def stealing_d
-00025c70: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
-00025c80: 7472 612c 2064 6f63 293a 0a20 2020 206f  tra, doc):.    o
-00025c90: 6363 7570 616e 6379 203d 204f 6363 7570  ccupancy = Occup
-00025ca0: 616e 6379 2873 6368 6564 756c 6572 290a  ancy(scheduler).
-00025cb0: 2020 2020 7374 6561 6c69 6e67 5f74 7320      stealing_ts 
-00025cc0: 3d20 5374 6561 6c69 6e67 5469 6d65 5365  = StealingTimeSe
-00025cd0: 7269 6573 2873 6368 6564 756c 6572 290a  ries(scheduler).
-00025ce0: 2020 2020 7374 6561 6c69 6e67 5f65 7665      stealing_eve
-00025cf0: 6e74 7320 3d20 5374 6561 6c69 6e67 4576  nts = StealingEv
-00025d00: 656e 7473 2873 6368 6564 756c 6572 290a  ents(scheduler).
-00025d10: 2020 2020 7374 6561 6c69 6e67 5f65 7665      stealing_eve
-00025d20: 6e74 732e 726f 6f74 2e78 5f72 616e 6765  nts.root.x_range
-00025d30: 203d 2073 7465 616c 696e 675f 7473 2e72   = stealing_ts.r
-00025d40: 6f6f 742e 785f 7261 6e67 650a 2020 2020  oot.x_range.    
-00025d50: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
-00025d60: 6b3a 2057 6f72 6b20 5374 6561 6c69 6e67  k: Work Stealing
-00025d70: 220a 2020 2020 6164 645f 7065 7269 6f64  ".    add_period
-00025d80: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
-00025d90: 206f 6363 7570 616e 6379 2c20 3530 3029   occupancy, 500)
-00025da0: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
-00025db0: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
-00025dc0: 7374 6561 6c69 6e67 5f74 732c 2035 3030  stealing_ts, 500
-00025dd0: 290a 2020 2020 6164 645f 7065 7269 6f64  ).    add_period
-00025de0: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
-00025df0: 2073 7465 616c 696e 675f 6576 656e 7473   stealing_events
-00025e00: 2c20 3530 3029 0a0a 2020 2020 646f 632e  , 500)..    doc.
-00025e10: 6164 645f 726f 6f74 280a 2020 2020 2020  add_root(.      
-00025e20: 2020 726f 7728 0a20 2020 2020 2020 2020    row(.         
-00025e30: 2020 206f 6363 7570 616e 6379 2e72 6f6f     occupancy.roo
-00025e40: 742c 0a20 2020 2020 2020 2020 2020 2063  t,.            c
-00025e50: 6f6c 756d 6e28 0a20 2020 2020 2020 2020  olumn(.         
-00025e60: 2020 2020 2020 2073 7465 616c 696e 675f         stealing_
-00025e70: 7473 2e72 6f6f 742c 0a20 2020 2020 2020  ts.root,.       
+00023da0: 2020 2020 2020 2022 636f 6d6d 5f63 6f6c         "comm_col
+00023db0: 6f72 223a 205b 5d2c 0a20 2020 2020 2020  or": [],.       
+00023dc0: 2020 2020 2020 2020 2022 6469 736b 5f6d           "disk_m
+00023dd0: 656d 6f72 7922 3a20 5b5d 2c0a 2020 2020  emory": [],.    
+00023de0: 2020 2020 2020 2020 2020 2020 2264 6973              "dis
+00023df0: 6b5f 6d65 6d6f 7279 5f6c 696d 6974 223a  k_memory_limit":
+00023e00: 205b 5d2c 0a20 2020 2020 2020 2020 2020   [],.           
+00023e10: 2020 2020 2022 6469 736b 5f62 7563 6b65       "disk_bucke
+00023e20: 7473 223a 205b 5d2c 0a20 2020 2020 2020  ts": [],.       
+00023e30: 2020 2020 2020 2020 2022 6469 736b 5f61           "disk_a
+00023e40: 7667 5f64 7572 6174 696f 6e22 3a20 5b5d  vg_duration": []
+00023e50: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00023e60: 2020 2264 6973 6b5f 6176 675f 7369 7a65    "disk_avg_size
+00023e70: 223a 205b 5d2c 0a20 2020 2020 2020 2020  ": [],.         
+00023e80: 2020 2020 2020 2022 6469 736b 5f72 6561         "disk_rea
+00023e90: 6422 3a20 5b5d 2c0a 2020 2020 2020 2020  d": [],.        
+00023ea0: 2020 2020 2020 2020 2264 6973 6b5f 7772          "disk_wr
+00023eb0: 6974 7465 6e22 3a20 5b5d 2c0a 2020 2020  itten": [],.    
+00023ec0: 2020 2020 2020 2020 2020 2020 2264 6973              "dis
+00023ed0: 6b5f 636f 6c6f 7222 3a20 5b5d 2c0a 2020  k_color": [],.  
+00023ee0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00023ef0: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00023f00: 6c66 2e74 6f74 616c 735f 736f 7572 6365  lf.totals_source
+00023f10: 203d 2043 6f6c 756d 6e44 6174 6153 6f75   = ColumnDataSou
+00023f20: 7263 6528 0a20 2020 2020 2020 2020 2020  rce(.           
+00023f30: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
+00023f40: 2020 2022 7822 3a20 5b22 4e65 7477 6f72     "x": ["Networ
+00023f50: 6b20 5365 6e64 222c 2022 4e65 7477 6f72  k Send", "Networ
+00023f60: 6b20 5265 6365 6976 6522 2c20 2244 6973  k Receive", "Dis
+00023f70: 6b20 5772 6974 6522 2c20 2244 6973 6b20  k Write", "Disk 
+00023f80: 5265 6164 225d 2c0a 2020 2020 2020 2020  Read"],.        
+00023f90: 2020 2020 2020 2020 2276 616c 7565 7322          "values"
+00023fa0: 3a20 5b30 2c20 302c 2030 2c20 305d 2c0a  : [0, 0, 0, 0],.
+00023fb0: 2020 2020 2020 2020 2020 2020 7d0a 2020              }.  
+00023fc0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00023fd0: 2073 656c 662e 636f 6d6d 5f6d 656d 6f72   self.comm_memor
+00023fe0: 7920 3d20 6669 6775 7265 280a 2020 2020  y = figure(.    
+00023ff0: 2020 2020 2020 2020 7469 746c 653d 2243          title="C
+00024000: 6f6d 6d73 2042 7566 6665 7222 2c0a 2020  omms Buffer",.  
+00024010: 2020 2020 2020 2020 2020 746f 6f6c 733d            tools=
+00024020: 2222 2c0a 2020 2020 2020 2020 2020 2020  "",.            
+00024030: 746f 6f6c 6261 725f 6c6f 6361 7469 6f6e  toolbar_location
+00024040: 3d22 6162 6f76 6522 2c0a 2020 2020 2020  ="above",.      
+00024050: 2020 2020 2020 785f 7261 6e67 653d 5261        x_range=Ra
+00024060: 6e67 6531 6428 302c 2031 3030 5f30 3030  nge1d(0, 100_000
+00024070: 5f30 3030 292c 0a20 2020 2020 2020 2020  _000),.         
+00024080: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
+00024090: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+000240a0: 656c 662e 636f 6d6d 5f6d 656d 6f72 792e  elf.comm_memory.
+000240b0: 6862 6172 280a 2020 2020 2020 2020 2020  hbar(.          
+000240c0: 2020 736f 7572 6365 3d73 656c 662e 736f    source=self.so
+000240d0: 7572 6365 2c0a 2020 2020 2020 2020 2020  urce,.          
+000240e0: 2020 7269 6768 743d 2263 6f6d 6d5f 6d65    right="comm_me
+000240f0: 6d6f 7279 222c 0a20 2020 2020 2020 2020  mory",.         
+00024100: 2020 2079 3d22 7922 2c0a 2020 2020 2020     y="y",.      
+00024110: 2020 2020 2020 6865 6967 6874 3d30 2e39        height=0.9
+00024120: 2c0a 2020 2020 2020 2020 2020 2020 636f  ,.            co
+00024130: 6c6f 723d 2263 6f6d 6d5f 636f 6c6f 7222  lor="comm_color"
+00024140: 2c0a 2020 2020 2020 2020 290a 2020 2020  ,.        ).    
+00024150: 2020 2020 686f 7665 7220 3d20 486f 7665      hover = Hove
+00024160: 7254 6f6f 6c28 0a20 2020 2020 2020 2020  rTool(.         
+00024170: 2020 2074 6f6f 6c74 6970 733d 5b0a 2020     tooltips=[.  
+00024180: 2020 2020 2020 2020 2020 2020 2020 2822                ("
+00024190: 4d65 6d6f 7279 2055 7365 6422 2c20 2240  Memory Used", "@
+000241a0: 636f 6d6d 5f6d 656d 6f72 797b 302e 3030  comm_memory{0.00
+000241b0: 2062 7d22 292c 0a20 2020 2020 2020 2020   b}"),.         
+000241c0: 2020 2020 2020 2028 2241 7665 7261 6765         ("Average
+000241d0: 2057 7269 7465 222c 2022 4063 6f6d 6d5f   Write", "@comm_
+000241e0: 6176 675f 7369 7a65 7b30 2e30 3020 627d  avg_size{0.00 b}
+000241f0: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00024200: 2020 2020 2822 2320 4275 636b 6574 7322      ("# Buckets"
+00024210: 2c20 2240 636f 6d6d 5f62 7563 6b65 7473  , "@comm_buckets
+00024220: 2229 2c0a 2020 2020 2020 2020 2020 2020  "),.            
+00024230: 2020 2020 2822 4176 6572 6167 6520 4475      ("Average Du
+00024240: 7261 7469 6f6e 222c 2022 4063 6f6d 6d5f  ration", "@comm_
+00024250: 6176 675f 6475 7261 7469 6f6e 2229 2c0a  avg_duration"),.
+00024260: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+00024270: 2020 2020 2020 2020 2020 2066 6f72 6d61             forma
+00024280: 7474 6572 733d 7b22 4063 6f6d 6d5f 6176  tters={"@comm_av
+00024290: 675f 6475 7261 7469 6f6e 223a 2022 6461  g_duration": "da
+000242a0: 7465 7469 6d65 227d 2c0a 2020 2020 2020  tetime"},.      
+000242b0: 2020 2020 2020 6d6f 6465 3d22 686c 696e        mode="hlin
+000242c0: 6522 2c0a 2020 2020 2020 2020 290a 2020  e",.        ).  
+000242d0: 2020 2020 2020 7365 6c66 2e63 6f6d 6d5f        self.comm_
+000242e0: 6d65 6d6f 7279 2e61 6464 5f74 6f6f 6c73  memory.add_tools
+000242f0: 2868 6f76 6572 290a 2020 2020 2020 2020  (hover).        
+00024300: 7365 6c66 2e63 6f6d 6d5f 6d65 6d6f 7279  self.comm_memory
+00024310: 2e78 5f72 616e 6765 2e73 7461 7274 203d  .x_range.start =
+00024320: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+00024330: 636f 6d6d 5f6d 656d 6f72 792e 785f 7261  comm_memory.x_ra
+00024340: 6e67 652e 656e 6420 3d20 310a 2020 2020  nge.end = 1.    
+00024350: 2020 2020 7365 6c66 2e63 6f6d 6d5f 6d65      self.comm_me
+00024360: 6d6f 7279 2e78 6178 6973 5b30 5d2e 666f  mory.xaxis[0].fo
+00024370: 726d 6174 7465 7220 3d20 4e75 6d65 7261  rmatter = Numera
+00024380: 6c54 6963 6b46 6f72 6d61 7474 6572 2866  lTickFormatter(f
+00024390: 6f72 6d61 743d 2230 2e30 2062 2229 0a0a  ormat="0.0 b")..
+000243a0: 2020 2020 2020 2020 7365 6c66 2e64 6973          self.dis
+000243b0: 6b5f 6d65 6d6f 7279 203d 2066 6967 7572  k_memory = figur
+000243c0: 6528 0a20 2020 2020 2020 2020 2020 2074  e(.            t
+000243d0: 6974 6c65 3d22 4469 736b 2042 7566 6665  itle="Disk Buffe
+000243e0: 7222 2c0a 2020 2020 2020 2020 2020 2020  r",.            
+000243f0: 746f 6f6c 733d 2222 2c0a 2020 2020 2020  tools="",.      
+00024400: 2020 2020 2020 746f 6f6c 6261 725f 6c6f        toolbar_lo
+00024410: 6361 7469 6f6e 3d22 6162 6f76 6522 2c0a  cation="above",.
+00024420: 2020 2020 2020 2020 2020 2020 785f 7261              x_ra
+00024430: 6e67 653d 5261 6e67 6531 6428 302c 2031  nge=Range1d(0, 1
+00024440: 3030 5f30 3030 5f30 3030 292c 0a20 2020  00_000_000),.   
+00024450: 2020 2020 2020 2020 202a 2a6b 7761 7267           **kwarg
+00024460: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
+00024470: 2020 2020 2073 656c 662e 6469 736b 5f6d       self.disk_m
+00024480: 656d 6f72 792e 7961 7869 732e 7669 7369  emory.yaxis.visi
+00024490: 626c 6520 3d20 4661 6c73 650a 0a20 2020  ble = False..   
+000244a0: 2020 2020 2073 656c 662e 6469 736b 5f6d       self.disk_m
+000244b0: 656d 6f72 792e 6862 6172 280a 2020 2020  emory.hbar(.    
+000244c0: 2020 2020 2020 2020 736f 7572 6365 3d73          source=s
+000244d0: 656c 662e 736f 7572 6365 2c0a 2020 2020  elf.source,.    
+000244e0: 2020 2020 2020 2020 7269 6768 743d 2264          right="d
+000244f0: 6973 6b5f 6d65 6d6f 7279 222c 0a20 2020  isk_memory",.   
+00024500: 2020 2020 2020 2020 2079 3d22 7922 2c0a           y="y",.
+00024510: 2020 2020 2020 2020 2020 2020 6865 6967              heig
+00024520: 6874 3d30 2e39 2c0a 2020 2020 2020 2020  ht=0.9,.        
+00024530: 2020 2020 636f 6c6f 723d 2264 6973 6b5f      color="disk_
+00024540: 636f 6c6f 7222 2c0a 2020 2020 2020 2020  color",.        
+00024550: 290a 0a20 2020 2020 2020 2068 6f76 6572  )..        hover
+00024560: 203d 2048 6f76 6572 546f 6f6c 280a 2020   = HoverTool(.  
+00024570: 2020 2020 2020 2020 2020 746f 6f6c 7469            toolti
+00024580: 7073 3d5b 0a20 2020 2020 2020 2020 2020  ps=[.           
+00024590: 2020 2020 2028 224d 656d 6f72 7920 5573       ("Memory Us
+000245a0: 6564 222c 2022 4064 6973 6b5f 6d65 6d6f  ed", "@disk_memo
+000245b0: 7279 7b30 2e30 3020 627d 2229 2c0a 2020  ry{0.00 b}"),.  
+000245c0: 2020 2020 2020 2020 2020 2020 2020 2822                ("
+000245d0: 4176 6572 6167 6520 5772 6974 6522 2c20  Average Write", 
+000245e0: 2240 6469 736b 5f61 7667 5f73 697a 657b  "@disk_avg_size{
+000245f0: 302e 3030 2062 7d22 292c 0a20 2020 2020  0.00 b}"),.     
+00024600: 2020 2020 2020 2020 2020 2028 2223 2042             ("# B
+00024610: 7563 6b65 7473 222c 2022 4064 6973 6b5f  uckets", "@disk_
+00024620: 6275 636b 6574 7322 292c 0a20 2020 2020  buckets"),.     
+00024630: 2020 2020 2020 2020 2020 2028 2241 7665             ("Ave
+00024640: 7261 6765 2044 7572 6174 696f 6e22 2c20  rage Duration", 
+00024650: 2240 6469 736b 5f61 7667 5f64 7572 6174  "@disk_avg_durat
+00024660: 696f 6e22 292c 0a20 2020 2020 2020 2020  ion"),.         
+00024670: 2020 205d 2c0a 2020 2020 2020 2020 2020     ],.          
+00024680: 2020 666f 726d 6174 7465 7273 3d7b 2240    formatters={"@
+00024690: 6469 736b 5f61 7667 5f64 7572 6174 696f  disk_avg_duratio
+000246a0: 6e22 3a20 2264 6174 6574 696d 6522 7d2c  n": "datetime"},
+000246b0: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
+000246c0: 653d 2268 6c69 6e65 222c 0a20 2020 2020  e="hline",.     
+000246d0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+000246e0: 662e 6469 736b 5f6d 656d 6f72 792e 6164  f.disk_memory.ad
+000246f0: 645f 746f 6f6c 7328 686f 7665 7229 0a20  d_tools(hover). 
+00024700: 2020 2020 2020 2073 656c 662e 6469 736b         self.disk
+00024710: 5f6d 656d 6f72 792e 7861 7869 735b 305d  _memory.xaxis[0]
+00024720: 2e66 6f72 6d61 7474 6572 203d 204e 756d  .formatter = Num
+00024730: 6572 616c 5469 636b 466f 726d 6174 7465  eralTickFormatte
+00024740: 7228 666f 726d 6174 3d22 302e 3020 6222  r(format="0.0 b"
+00024750: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00024760: 746f 7461 6c73 203d 2066 6967 7572 6528  totals = figure(
+00024770: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
+00024780: 6c65 3d22 546f 7461 6c20 6d6f 7665 6d65  le="Total moveme
+00024790: 6e74 222c 0a20 2020 2020 2020 2020 2020  nt",.           
+000247a0: 2074 6f6f 6c73 3d22 222c 0a20 2020 2020   tools="",.     
+000247b0: 2020 2020 2020 2074 6f6f 6c62 6172 5f6c         toolbar_l
+000247c0: 6f63 6174 696f 6e3d 2261 626f 7665 222c  ocation="above",
+000247d0: 0a20 2020 2020 2020 2020 2020 202a 2a6b  .            **k
+000247e0: 7761 7267 732c 0a20 2020 2020 2020 2029  wargs,.        )
+000247f0: 0a20 2020 2020 2020 2074 6974 6c65 7320  .        titles 
+00024800: 3d20 5b22 4e65 7477 6f72 6b20 5365 6e64  = ["Network Send
+00024810: 222c 2022 4e65 7477 6f72 6b20 5265 6365  ", "Network Rece
+00024820: 6976 6522 2c20 2244 6973 6b20 5772 6974  ive", "Disk Writ
+00024830: 6522 2c20 2244 6973 6b20 5265 6164 225d  e", "Disk Read"]
+00024840: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
+00024850: 7461 6c73 203d 2066 6967 7572 6528 0a20  tals = figure(. 
+00024860: 2020 2020 2020 2020 2020 2078 5f72 616e             x_ran
+00024870: 6765 3d74 6974 6c65 732c 0a20 2020 2020  ge=titles,.     
+00024880: 2020 2020 2020 2074 6974 6c65 3d22 546f         title="To
+00024890: 7461 6c73 222c 0a20 2020 2020 2020 2020  tals",.         
+000248a0: 2020 2074 6f6f 6c62 6172 5f6c 6f63 6174     toolbar_locat
+000248b0: 696f 6e3d 4e6f 6e65 2c0a 2020 2020 2020  ion=None,.      
+000248c0: 2020 2020 2020 746f 6f6c 733d 2222 2c0a        tools="",.
+000248d0: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
+000248e0: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
+000248f0: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
+00024900: 7461 6c73 2e76 6261 7228 0a20 2020 2020  tals.vbar(.     
+00024910: 2020 2020 2020 2078 3d22 7822 2c0a 2020         x="x",.  
+00024920: 2020 2020 2020 2020 2020 746f 703d 2276            top="v
+00024930: 616c 7565 7322 2c0a 2020 2020 2020 2020  alues",.        
+00024940: 2020 2020 7769 6474 683d 302e 392c 0a20      width=0.9,. 
+00024950: 2020 2020 2020 2020 2020 2073 6f75 7263             sourc
+00024960: 653d 7365 6c66 2e74 6f74 616c 735f 736f  e=self.totals_so
+00024970: 7572 6365 2c0a 2020 2020 2020 2020 290a  urce,.        ).
+00024980: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
+00024990: 7461 6c73 2e78 6772 6964 2e67 7269 645f  tals.xgrid.grid_
+000249a0: 6c69 6e65 5f63 6f6c 6f72 203d 204e 6f6e  line_color = Non
+000249b0: 650a 2020 2020 2020 2020 7365 6c66 2e74  e.        self.t
+000249c0: 6f74 616c 732e 795f 7261 6e67 652e 7374  otals.y_range.st
+000249d0: 6172 7420 3d20 300a 2020 2020 2020 2020  art = 0.        
+000249e0: 7365 6c66 2e74 6f74 616c 732e 7961 7869  self.totals.yaxi
+000249f0: 735b 305d 2e66 6f72 6d61 7474 6572 203d  s[0].formatter =
+00024a00: 204e 756d 6572 616c 5469 636b 466f 726d   NumeralTickForm
+00024a10: 6174 7465 7228 666f 726d 6174 3d22 302e  atter(format="0.
+00024a20: 3020 6222 290a 0a20 2020 2020 2020 2068  0 b")..        h
+00024a30: 6f76 6572 203d 2048 6f76 6572 546f 6f6c  over = HoverTool
+00024a40: 280a 2020 2020 2020 2020 2020 2020 746f  (.            to
+00024a50: 6f6c 7469 7073 3d5b 2822 546f 7461 6c22  oltips=[("Total"
+00024a60: 2c20 2240 7661 6c75 6573 7b30 2e30 3062  , "@values{0.00b
+00024a70: 7d22 295d 2c0a 2020 2020 2020 2020 2020  }")],.          
+00024a80: 2020 6d6f 6465 3d22 766c 696e 6522 2c0a    mode="vline",.
+00024a90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00024aa0: 2020 7365 6c66 2e74 6f74 616c 732e 6164    self.totals.ad
+00024ab0: 645f 746f 6f6c 7328 686f 7665 7229 0a0a  d_tools(hover)..
+00024ac0: 2020 2020 2020 2020 7365 6c66 2e72 6f6f          self.roo
+00024ad0: 7420 3d20 726f 7728 7365 6c66 2e63 6f6d  t = row(self.com
+00024ae0: 6d5f 6d65 6d6f 7279 2c20 7365 6c66 2e64  m_memory, self.d
+00024af0: 6973 6b5f 6d65 6d6f 7279 290a 0a20 2020  isk_memory)..   
+00024b00: 2040 7769 7468 6f75 745f 7072 6f70 6572   @without_proper
+00024b10: 7479 5f76 616c 6964 6174 696f 6e0a 2020  ty_validation.  
+00024b20: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+00024b30: 2020 6465 6620 7570 6461 7465 2873 656c    def update(sel
+00024b40: 6629 3a0a 2020 2020 2020 2020 696e 7075  f):.        inpu
+00024b50: 7420 3d20 7365 6c66 2e73 6368 6564 756c  t = self.schedul
+00024b60: 6572 2e65 7874 656e 7369 6f6e 735b 2273  er.extensions["s
+00024b70: 6875 6666 6c65 225d 2e68 6561 7274 6265  huffle"].heartbe
+00024b80: 6174 730a 2020 2020 2020 2020 6966 206e  ats.        if n
+00024b90: 6f74 2069 6e70 7574 3a0a 2020 2020 2020  ot input:.      
+00024ba0: 2020 2020 2020 7265 7475 726e 0a0a 2020        return..  
+00024bb0: 2020 2020 2020 696e 7075 7420 3d20 6c69        input = li
+00024bc0: 7374 2869 6e70 7574 2e76 616c 7565 7328  st(input.values(
+00024bd0: 2929 5b2d 315d 2020 2320 544f 444f 3a20  ))[-1]  # TODO: 
+00024be0: 6d75 6c74 6970 6c65 2063 6f6e 6375 7272  multiple concurr
+00024bf0: 656e 7420 7368 7566 666c 6573 0a0a 2020  ent shuffles..  
+00024c00: 2020 2020 2020 6461 7461 203d 2064 6566        data = def
+00024c10: 6175 6c74 6469 6374 286c 6973 7429 0a20  aultdict(list). 
+00024c20: 2020 2020 2020 206e 6f77 203d 2074 696d         now = tim
+00024c30: 6528 290a 0a20 2020 2020 2020 2066 6f72  e()..        for
+00024c40: 2069 2c20 2877 6f72 6b65 722c 2064 2920   i, (worker, d) 
+00024c50: 696e 2065 6e75 6d65 7261 7465 2869 6e70  in enumerate(inp
+00024c60: 7574 2e69 7465 6d73 2829 293a 0a20 2020  ut.items()):.   
+00024c70: 2020 2020 2020 2020 2064 6174 615b 2279           data["y
+00024c80: 225d 2e61 7070 656e 6428 6929 0a20 2020  "].append(i).   
+00024c90: 2020 2020 2020 2020 2064 6174 615b 2277           data["w
+00024ca0: 6f72 6b65 7222 5d2e 6170 7065 6e64 2877  orker"].append(w
+00024cb0: 6f72 6b65 7229 0a20 2020 2020 2020 2020  orker).         
+00024cc0: 2020 2066 6f72 2070 7265 6669 7820 696e     for prefix in
+00024cd0: 205b 2263 6f6d 6d22 2c20 2264 6973 6b22   ["comm", "disk"
+00024ce0: 5d3a 0a20 2020 2020 2020 2020 2020 2020  ]:.             
+00024cf0: 2020 206d 656d 6f72 795f 6c69 6d69 7420     memory_limit 
+00024d00: 3d20 645b 7072 6566 6978 5d5b 226d 656d  = d[prefix]["mem
+00024d10: 6f72 795f 6c69 6d69 7422 5d20 6f72 2030  ory_limit"] or 0
+00024d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024d30: 2064 6174 615b 6622 7b70 7265 6669 787d   data[f"{prefix}
+00024d40: 5f74 6f74 616c 225d 2e61 7070 656e 6428  _total"].append(
+00024d50: 645b 7072 6566 6978 5d5b 2274 6f74 616c  d[prefix]["total
+00024d60: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+00024d70: 2020 2020 6461 7461 5b66 227b 7072 6566      data[f"{pref
+00024d80: 6978 7d5f 6d65 6d6f 7279 225d 2e61 7070  ix}_memory"].app
+00024d90: 656e 6428 645b 7072 6566 6978 5d5b 226d  end(d[prefix]["m
+00024da0: 656d 6f72 7922 5d29 0a20 2020 2020 2020  emory"]).       
+00024db0: 2020 2020 2020 2020 2064 6174 615b 6622           data[f"
+00024dc0: 7b70 7265 6669 787d 5f6d 656d 6f72 795f  {prefix}_memory_
+00024dd0: 6c69 6d69 7422 5d2e 6170 7065 6e64 286d  limit"].append(m
+00024de0: 656d 6f72 795f 6c69 6d69 7429 0a20 2020  emory_limit).   
+00024df0: 2020 2020 2020 2020 2020 2020 2064 6174               dat
+00024e00: 615b 6622 7b70 7265 6669 787d 5f62 7563  a[f"{prefix}_buc
+00024e10: 6b65 7473 225d 2e61 7070 656e 6428 645b  kets"].append(d[
+00024e20: 7072 6566 6978 5d5b 2262 7563 6b65 7473  prefix]["buckets
+00024e30: 225d 290a 2020 2020 2020 2020 2020 2020  "]).            
+00024e40: 2020 2020 6461 7461 5b66 227b 7072 6566      data[f"{pref
+00024e50: 6978 7d5f 6176 675f 6475 7261 7469 6f6e  ix}_avg_duration
+00024e60: 225d 2e61 7070 656e 6428 645b 7072 6566  "].append(d[pref
+00024e70: 6978 5d5b 2261 7667 5f64 7572 6174 696f  ix]["avg_duratio
+00024e80: 6e22 5d29 0a20 2020 2020 2020 2020 2020  n"]).           
+00024e90: 2020 2020 2064 6174 615b 6622 7b70 7265       data[f"{pre
+00024ea0: 6669 787d 5f61 7667 5f73 697a 6522 5d2e  fix}_avg_size"].
+00024eb0: 6170 7065 6e64 2864 5b70 7265 6669 785d  append(d[prefix]
+00024ec0: 5b22 6176 675f 7369 7a65 225d 290a 2020  ["avg_size"]).  
+00024ed0: 2020 2020 2020 2020 2020 2020 2020 6461                da
+00024ee0: 7461 5b66 227b 7072 6566 6978 7d5f 7265  ta[f"{prefix}_re
+00024ef0: 6164 225d 2e61 7070 656e 6428 645b 7072  ad"].append(d[pr
+00024f00: 6566 6978 5d5b 2272 6561 6422 5d29 0a20  efix]["read"]). 
+00024f10: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00024f20: 6174 615b 6622 7b70 7265 6669 787d 5f77  ata[f"{prefix}_w
+00024f30: 7269 7474 656e 225d 2e61 7070 656e 6428  ritten"].append(
+00024f40: 645b 7072 6566 6978 5d5b 2277 7269 7474  d[prefix]["writt
+00024f50: 656e 225d 290a 2020 2020 2020 2020 2020  en"]).          
+00024f60: 2020 2020 2020 6966 2073 656c 662e 7363        if self.sc
+00024f70: 6865 6475 6c65 722e 776f 726b 6572 735b  heduler.workers[
+00024f80: 776f 726b 6572 5d2e 6c61 7374 5f73 6565  worker].last_see
+00024f90: 6e20 3c20 6e6f 7720 2d20 353a 0a20 2020  n < now - 5:.   
+00024fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024fb0: 2064 6174 615b 6622 7b70 7265 6669 787d   data[f"{prefix}
+00024fc0: 5f63 6f6c 6f72 225d 2e61 7070 656e 6428  _color"].append(
+00024fd0: 2267 7261 7922 290a 2020 2020 2020 2020  "gray").        
+00024fe0: 2020 2020 2020 2020 656c 6966 2064 5b70          elif d[p
+00024ff0: 7265 6669 785d 5b22 6d65 6d6f 7279 225d  refix]["memory"]
+00025000: 203e 206d 656d 6f72 795f 6c69 6d69 743a   > memory_limit:
+00025010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025020: 2020 2020 2064 6174 615b 6622 7b70 7265       data[f"{pre
+00025030: 6669 787d 5f63 6f6c 6f72 225d 2e61 7070  fix}_color"].app
+00025040: 656e 6428 2272 6564 2229 0a20 2020 2020  end("red").     
+00025050: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00025060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025070: 2020 2020 2064 6174 615b 6622 7b70 7265       data[f"{pre
+00025080: 6669 787d 5f63 6f6c 6f72 225d 2e61 7070  fix}_color"].app
+00025090: 656e 6428 2262 6c75 6522 290a 0a20 2020  end("blue")..   
+000250a0: 2020 2020 2074 6f74 616c 7320 3d20 7b0a       totals = {.
+000250b0: 2020 2020 2020 2020 2020 2020 2278 223a              "x":
+000250c0: 205b 224e 6574 776f 726b 2053 656e 6422   ["Network Send"
+000250d0: 2c20 224e 6574 776f 726b 2052 6563 6569  , "Network Recei
+000250e0: 7665 222c 2022 4469 736b 2057 7269 7465  ve", "Disk Write
+000250f0: 222c 2022 4469 736b 2052 6561 6422 5d2c  ", "Disk Read"],
+00025100: 0a20 2020 2020 2020 2020 2020 2022 7661  .            "va
+00025110: 6c75 6573 223a 205b 0a20 2020 2020 2020  lues": [.       
+00025120: 2020 2020 2020 2020 2073 756d 2864 6174           sum(dat
+00025130: 615b 2263 6f6d 6d5f 7772 6974 7465 6e22  a["comm_written"
+00025140: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
+00025150: 2020 2020 7375 6d28 6461 7461 5b22 636f      sum(data["co
+00025160: 6d6d 5f72 6561 6422 5d29 2c0a 2020 2020  mm_read"]),.    
+00025170: 2020 2020 2020 2020 2020 2020 7375 6d28              sum(
+00025180: 6461 7461 5b22 6469 736b 5f77 7269 7474  data["disk_writt
+00025190: 656e 225d 292c 0a20 2020 2020 2020 2020  en"]),.         
+000251a0: 2020 2020 2020 2073 756d 2864 6174 615b         sum(data[
+000251b0: 2264 6973 6b5f 7265 6164 225d 292c 0a20  "disk_read"]),. 
+000251c0: 2020 2020 2020 2020 2020 205d 2c0a 2020             ],.  
+000251d0: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+000251e0: 7570 6461 7465 2873 656c 662e 746f 7461  update(self.tota
+000251f0: 6c73 5f73 6f75 7263 652c 2074 6f74 616c  ls_source, total
+00025200: 7329 0a0a 2020 2020 2020 2020 7570 6461  s)..        upda
+00025210: 7465 2873 656c 662e 736f 7572 6365 2c20  te(self.source, 
+00025220: 6469 6374 2864 6174 6129 290a 2020 2020  dict(data)).    
+00025230: 2020 2020 6c69 6d69 7420 3d20 6d61 7828      limit = max(
+00025240: 6461 7461 5b22 636f 6d6d 5f6d 656d 6f72  data["comm_memor
+00025250: 795f 6c69 6d69 7422 5d20 2b20 6461 7461  y_limit"] + data
+00025260: 5b22 6469 736b 5f6d 656d 6f72 795f 6c69  ["disk_memory_li
+00025270: 6d69 7422 5d29 202a 2031 2e32 0a20 2020  mit"]) * 1.2.   
+00025280: 2020 2020 2073 656c 662e 636f 6d6d 5f6d       self.comm_m
+00025290: 656d 6f72 792e 785f 7261 6e67 652e 656e  emory.x_range.en
+000252a0: 6420 3d20 6c69 6d69 740a 2020 2020 2020  d = limit.      
+000252b0: 2020 7365 6c66 2e64 6973 6b5f 6d65 6d6f    self.disk_memo
+000252c0: 7279 2e78 5f72 616e 6765 2e65 6e64 203d  ry.x_range.end =
+000252d0: 206c 696d 6974 0a0a 0a5f 5354 594c 4553   limit..._STYLES
+000252e0: 203d 207b 0a20 2020 2022 7769 6474 6822   = {.    "width"
+000252f0: 3a20 2231 3030 2522 2c0a 2020 2020 2268  : "100%",.    "h
+00025300: 6569 6768 7422 3a20 2231 3030 2522 2c0a  eight": "100%",.
+00025310: 2020 2020 226d 6178 2d77 6964 7468 223a      "max-width":
+00025320: 2022 3139 3230 7078 222c 0a20 2020 2022   "1920px",.    "
+00025330: 6d61 782d 6865 6967 6874 223a 2022 3130  max-height": "10
+00025340: 3830 7078 222c 0a20 2020 2022 7061 6464  80px",.    "padd
+00025350: 696e 6722 3a20 2231 3270 7822 2c0a 2020  ing": "12px",.  
+00025360: 2020 2262 6f72 6465 7222 3a20 2231 7078    "border": "1px
+00025370: 2073 6f6c 6964 206c 6967 6874 6772 6179   solid lightgray
+00025380: 222c 0a20 2020 2022 626f 782d 7368 6164  ",.    "box-shad
+00025390: 6f77 223a 2022 696e 7365 7420 3170 7820  ow": "inset 1px 
+000253a0: 3020 3870 7820 3020 6c69 6768 7467 7261  0 8px 0 lightgra
+000253b0: 7922 2c0a 2020 2020 226f 7665 7266 6c6f  y",.    "overflo
+000253c0: 7722 3a20 2261 7574 6f22 2c0a 7d0a 6966  w": "auto",.}.if
+000253d0: 2042 4f4b 4548 5f56 4552 5349 4f4e 2e6d   BOKEH_VERSION.m
+000253e0: 616a 6f72 203c 2033 3a0a 2020 2020 5f42  ajor < 3:.    _B
+000253f0: 4f4b 4548 5f53 5459 4c45 535f 4b57 4152  OKEH_STYLES_KWAR
+00025400: 4753 203d 207b 2273 7479 6c65 223a 205f  GS = {"style": _
+00025410: 5354 594c 4553 7d0a 656c 7365 3a0a 2020  STYLES}.else:.  
+00025420: 2020 5f42 4f4b 4548 5f53 5459 4c45 535f    _BOKEH_STYLES_
+00025430: 4b57 4152 4753 203d 207b 2273 7479 6c65  KWARGS = {"style
+00025440: 7322 3a20 5f53 5459 4c45 537d 0a0a 0a63  s": _STYLES}...c
+00025450: 6c61 7373 2053 6368 6564 756c 6572 4c6f  lass SchedulerLo
+00025460: 6773 3a0a 2020 2020 6465 6620 5f5f 696e  gs:.    def __in
+00025470: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
+00025480: 756c 6572 2c20 7374 6172 743d 4e6f 6e65  uler, start=None
+00025490: 293a 0a20 2020 2020 2020 206c 6f67 7320  ):.        logs 
+000254a0: 3d20 7363 6865 6475 6c65 722e 6765 745f  = scheduler.get_
+000254b0: 6c6f 6773 2873 7461 7274 3d73 7461 7274  logs(start=start
+000254c0: 2c20 7469 6d65 7374 616d 7073 3d54 7275  , timestamps=Tru
+000254d0: 6529 0a0a 2020 2020 2020 2020 6966 206e  e)..        if n
+000254e0: 6f74 206c 6f67 733a 0a20 2020 2020 2020  ot logs:.       
+000254f0: 2020 2020 206c 6f67 735f 6874 6d6c 203d       logs_html =
+00025500: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00025510: 2020 2027 3c70 2073 7479 6c65 3d22 666f     '<p style="fo
+00025520: 6e74 2d66 616d 696c 793a 206d 6f6e 6f73  nt-family: monos
+00025530: 7061 6365 3b20 6d61 7267 696e 3a20 303b  pace; margin: 0;
+00025540: 223e 4e6f 206c 6f67 7320 746f 2072 6570  ">No logs to rep
+00025550: 6f72 743c 2f70 3e27 0a20 2020 2020 2020  ort</p>'.       
+00025560: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+00025570: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00025580: 206c 6f67 735f 6874 6d6c 203d 204c 6f67   logs_html = Log
+00025590: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000255a0: 2020 225c 6e22 2e6a 6f69 6e28 0a20 2020    "\n".join(.   
+000255b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000255c0: 2022 2573 202d 2025 7322 0a20 2020 2020   "%s - %s".     
+000255d0: 2020 2020 2020 2020 2020 2020 2020 2025                 %
+000255e0: 2028 6461 7465 7469 6d65 2e66 726f 6d74   (datetime.fromt
+000255f0: 696d 6573 7461 6d70 2874 696d 6529 2e73  imestamp(time).s
+00025600: 7472 6674 696d 6528 2225 483a 254d 3a25  trftime("%H:%M:%
+00025610: 532e 2566 2229 2c20 6c69 6e65 290a 2020  S.%f"), line).  
+00025620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025630: 2020 666f 7220 7469 6d65 2c20 6c65 7665    for time, leve
+00025640: 6c2c 206c 696e 6520 696e 206c 6f67 730a  l, line in logs.
+00025650: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025660: 290a 2020 2020 2020 2020 2020 2020 292e  ).            ).
+00025670: 5f72 6570 725f 6874 6d6c 5f28 290a 0a20  _repr_html_().. 
+00025680: 2020 2020 2020 2073 656c 662e 726f 6f74         self.root
+00025690: 203d 2044 6976 2874 6578 743d 6c6f 6773   = Div(text=logs
+000256a0: 5f68 746d 6c2c 202a 2a5f 424f 4b45 485f  _html, **_BOKEH_
+000256b0: 5354 594c 4553 5f4b 5741 5247 5329 0a0a  STYLES_KWARGS)..
+000256c0: 0a40 6c6f 675f 6572 726f 7273 0a64 6566  .@log_errors.def
+000256d0: 2073 7973 7465 6d6d 6f6e 6974 6f72 5f64   systemmonitor_d
+000256e0: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
+000256f0: 7472 612c 2064 6f63 293a 0a20 2020 2073  tra, doc):.    s
+00025700: 7973 6d6f 6e20 3d20 5379 7374 656d 4d6f  ysmon = SystemMo
+00025710: 6e69 746f 7228 7363 6865 6475 6c65 722c  nitor(scheduler,
+00025720: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
+00025730: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
+00025740: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
+00025750: 736b 3a20 5363 6865 6475 6c65 7220 5379  sk: Scheduler Sy
+00025760: 7374 656d 204d 6f6e 6974 6f72 220a 2020  stem Monitor".  
+00025770: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
+00025780: 616c 6c62 6163 6b28 646f 632c 2073 7973  allback(doc, sys
+00025790: 6d6f 6e2c 2035 3030 290a 0a20 2020 2064  mon, 500)..    d
+000257a0: 6f63 2e61 6464 5f72 6f6f 7428 7379 736d  oc.add_root(sysm
+000257b0: 6f6e 2e72 6f6f 7429 0a20 2020 2064 6f63  on.root).    doc
+000257c0: 2e74 656d 706c 6174 6520 3d20 656e 762e  .template = env.
+000257d0: 6765 745f 7465 6d70 6c61 7465 2822 7369  get_template("si
+000257e0: 6d70 6c65 2e68 746d 6c22 290a 2020 2020  mple.html").    
+000257f0: 646f 632e 7465 6d70 6c61 7465 5f76 6172  doc.template_var
+00025800: 6961 626c 6573 2e75 7064 6174 6528 6578  iables.update(ex
+00025810: 7472 6129 0a20 2020 2064 6f63 2e74 6865  tra).    doc.the
+00025820: 6d65 203d 2042 4f4b 4548 5f54 4845 4d45  me = BOKEH_THEME
+00025830: 0a0a 0a40 6c6f 675f 6572 726f 7273 0a64  ...@log_errors.d
+00025840: 6566 2073 6875 6666 6c69 6e67 5f64 6f63  ef shuffling_doc
+00025850: 2873 6368 6564 756c 6572 2c20 6578 7472  (scheduler, extr
+00025860: 612c 2064 6f63 293a 0a20 2020 2064 6f63  a, doc):.    doc
+00025870: 2e74 6974 6c65 203d 2022 4461 736b 3a20  .title = "Dask: 
+00025880: 5368 7566 666c 696e 6722 0a0a 2020 2020  Shuffling"..    
+00025890: 7368 7566 666c 696e 6720 3d20 5368 7566  shuffling = Shuf
+000258a0: 666c 696e 6728 7363 6865 6475 6c65 722c  fling(scheduler,
+000258b0: 2077 6964 7468 3d34 3030 2c20 6865 6967   width=400, heig
+000258c0: 6874 3d34 3030 290a 2020 2020 776f 726b  ht=400).    work
+000258d0: 6572 735f 6d65 6d6f 7279 203d 2057 6f72  ers_memory = Wor
+000258e0: 6b65 7273 4d65 6d6f 7279 2873 6368 6564  kersMemory(sched
+000258f0: 756c 6572 2c20 7769 6474 683d 3430 302c  uler, width=400,
+00025900: 2068 6569 6768 743d 3430 3029 0a20 2020   height=400).   
+00025910: 2074 696d 6573 6572 6965 7320 3d20 5379   timeseries = Sy
+00025920: 7374 656d 5469 6d65 7365 7269 6573 280a  stemTimeseries(.
+00025930: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+00025940: 722c 2077 6964 7468 3d31 3630 302c 2068  r, width=1600, h
+00025950: 6569 6768 743d 3230 302c 2066 6f6c 6c6f  eight=200, follo
+00025960: 775f 696e 7465 7276 616c 3d31 3030 3030  w_interval=10000
+00025970: 0a20 2020 2029 0a20 2020 2065 7665 6e74  .    ).    event
+00025980: 5f6c 6f6f 7020 3d20 436f 6e74 656e 7469  _loop = Contenti
+00025990: 6f6e 2873 6368 6564 756c 6572 2c20 7769  on(scheduler, wi
+000259a0: 6474 683d 3230 302c 2068 6569 6768 743d  dth=200, height=
+000259b0: 3430 3029 0a0a 2020 2020 6164 645f 7065  400)..    add_pe
+000259c0: 7269 6f64 6963 5f63 616c 6c62 6163 6b28  riodic_callback(
+000259d0: 646f 632c 2073 6875 6666 6c69 6e67 2c20  doc, shuffling, 
+000259e0: 3230 3029 0a20 2020 2061 6464 5f70 6572  200).    add_per
+000259f0: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
+00025a00: 6f63 2c20 776f 726b 6572 735f 6d65 6d6f  oc, workers_memo
+00025a10: 7279 2c20 3230 3029 0a20 2020 2061 6464  ry, 200).    add
+00025a20: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+00025a30: 636b 2864 6f63 2c20 7469 6d65 7365 7269  ck(doc, timeseri
+00025a40: 6573 2c20 3530 3029 0a20 2020 2061 6464  es, 500).    add
+00025a50: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+00025a60: 636b 2864 6f63 2c20 6576 656e 745f 6c6f  ck(doc, event_lo
+00025a70: 6f70 2c20 3530 3029 0a0a 2020 2020 7469  op, 500)..    ti
+00025a80: 6d65 7365 7269 6573 2e62 616e 6477 6964  meseries.bandwid
+00025a90: 7468 2e79 5f72 616e 6765 203d 2074 696d  th.y_range = tim
+00025aa0: 6573 6572 6965 732e 6469 736b 2e79 5f72  eseries.disk.y_r
+00025ab0: 616e 6765 0a0a 2020 2020 646f 632e 6164  ange..    doc.ad
+00025ac0: 645f 726f 6f74 280a 2020 2020 2020 2020  d_root(.        
+00025ad0: 636f 6c75 6d6e 280a 2020 2020 2020 2020  column(.        
+00025ae0: 2020 2020 726f 7728 0a20 2020 2020 2020      row(.       
+00025af0: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+00025b00: 5f6d 656d 6f72 792e 726f 6f74 2c0a 2020  _memory.root,.  
+00025b10: 2020 2020 2020 2020 2020 2020 2020 7368                sh
+00025b20: 7566 666c 696e 672e 636f 6d6d 5f6d 656d  uffling.comm_mem
+00025b30: 6f72 792c 0a20 2020 2020 2020 2020 2020  ory,.           
+00025b40: 2020 2020 2073 6875 6666 6c69 6e67 2e64       shuffling.d
+00025b50: 6973 6b5f 6d65 6d6f 7279 2c0a 2020 2020  isk_memory,.    
+00025b60: 2020 2020 2020 2020 2020 2020 7368 7566              shuf
+00025b70: 666c 696e 672e 746f 7461 6c73 2c0a 2020  fling.totals,.  
+00025b80: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+00025b90: 656e 745f 6c6f 6f70 2e72 6f6f 742c 0a20  ent_loop.root,. 
+00025ba0: 2020 2020 2020 2020 2020 2029 2c0a 2020             ),.  
+00025bb0: 2020 2020 2020 2020 2020 726f 7728 636f            row(co
+00025bc0: 6c75 6d6e 2874 696d 6573 6572 6965 732e  lumn(timeseries.
+00025bd0: 6261 6e64 7769 6474 682c 2074 696d 6573  bandwidth, times
+00025be0: 6572 6965 732e 6469 736b 2929 2c0a 2020  eries.disk)),.  
+00025bf0: 2020 2020 2020 290a 2020 2020 290a 2020        ).    ).  
+00025c00: 2020 646f 632e 7465 6d70 6c61 7465 203d    doc.template =
+00025c10: 2065 6e76 2e67 6574 5f74 656d 706c 6174   env.get_templat
+00025c20: 6528 2273 696d 706c 652e 6874 6d6c 2229  e("simple.html")
+00025c30: 0a20 2020 2064 6f63 2e74 656d 706c 6174  .    doc.templat
+00025c40: 655f 7661 7269 6162 6c65 732e 7570 6461  e_variables.upda
+00025c50: 7465 2865 7874 7261 290a 2020 2020 646f  te(extra).    do
+00025c60: 632e 7468 656d 6520 3d20 424f 4b45 485f  c.theme = BOKEH_
+00025c70: 5448 454d 450a 0a0a 406c 6f67 5f65 7272  THEME...@log_err
+00025c80: 6f72 730a 6465 6620 7374 6561 6c69 6e67  ors.def stealing
+00025c90: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
+00025ca0: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
+00025cb0: 206f 6363 7570 616e 6379 203d 204f 6363   occupancy = Occ
+00025cc0: 7570 616e 6379 2873 6368 6564 756c 6572  upancy(scheduler
+00025cd0: 290a 2020 2020 7374 6561 6c69 6e67 5f74  ).    stealing_t
+00025ce0: 7320 3d20 5374 6561 6c69 6e67 5469 6d65  s = StealingTime
+00025cf0: 5365 7269 6573 2873 6368 6564 756c 6572  Series(scheduler
+00025d00: 290a 2020 2020 7374 6561 6c69 6e67 5f65  ).    stealing_e
+00025d10: 7665 6e74 7320 3d20 5374 6561 6c69 6e67  vents = Stealing
+00025d20: 4576 656e 7473 2873 6368 6564 756c 6572  Events(scheduler
+00025d30: 290a 2020 2020 7374 6561 6c69 6e67 5f65  ).    stealing_e
+00025d40: 7665 6e74 732e 726f 6f74 2e78 5f72 616e  vents.root.x_ran
+00025d50: 6765 203d 2073 7465 616c 696e 675f 7473  ge = stealing_ts
+00025d60: 2e72 6f6f 742e 785f 7261 6e67 650a 2020  .root.x_range.  
+00025d70: 2020 646f 632e 7469 746c 6520 3d20 2244    doc.title = "D
+00025d80: 6173 6b3a 2057 6f72 6b20 5374 6561 6c69  ask: Work Steali
+00025d90: 6e67 220a 2020 2020 6164 645f 7065 7269  ng".    add_peri
+00025da0: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
+00025db0: 632c 206f 6363 7570 616e 6379 2c20 3530  c, occupancy, 50
+00025dc0: 3029 0a20 2020 2061 6464 5f70 6572 696f  0).    add_perio
+00025dd0: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
+00025de0: 2c20 7374 6561 6c69 6e67 5f74 732c 2035  , stealing_ts, 5
+00025df0: 3030 290a 2020 2020 6164 645f 7065 7269  00).    add_peri
+00025e00: 6f64 6963 5f63 616c 6c62 6163 6b28 646f  odic_callback(do
+00025e10: 632c 2073 7465 616c 696e 675f 6576 656e  c, stealing_even
+00025e20: 7473 2c20 3530 3029 0a0a 2020 2020 646f  ts, 500)..    do
+00025e30: 632e 6164 645f 726f 6f74 280a 2020 2020  c.add_root(.    
+00025e40: 2020 2020 726f 7728 0a20 2020 2020 2020      row(.       
+00025e50: 2020 2020 206f 6363 7570 616e 6379 2e72       occupancy.r
+00025e60: 6f6f 742c 0a20 2020 2020 2020 2020 2020  oot,.           
+00025e70: 2063 6f6c 756d 6e28 0a20 2020 2020 2020   column(.       
 00025e80: 2020 2020 2020 2020 2073 7465 616c 696e           stealin
-00025e90: 675f 6576 656e 7473 2e72 6f6f 742c 0a20  g_events.root,. 
-00025ea0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00025eb0: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
-00025ec0: 7463 685f 626f 7468 222c 0a20 2020 2020  tch_both",.     
-00025ed0: 2020 2020 2020 2029 2c0a 2020 2020 2020         ),.      
-00025ee0: 2020 290a 2020 2020 290a 0a20 2020 2064    ).    )..    d
-00025ef0: 6f63 2e74 656d 706c 6174 6520 3d20 656e  oc.template = en
-00025f00: 762e 6765 745f 7465 6d70 6c61 7465 2822  v.get_template("
-00025f10: 7369 6d70 6c65 2e68 746d 6c22 290a 2020  simple.html").  
-00025f20: 2020 646f 632e 7465 6d70 6c61 7465 5f76    doc.template_v
-00025f30: 6172 6961 626c 6573 2e75 7064 6174 6528  ariables.update(
-00025f40: 6578 7472 6129 0a20 2020 2064 6f63 2e74  extra).    doc.t
-00025f50: 6865 6d65 203d 2042 4f4b 4548 5f54 4845  heme = BOKEH_THE
-00025f60: 4d45 0a0a 0a40 6c6f 675f 6572 726f 7273  ME...@log_errors
-00025f70: 0a64 6566 2065 7665 6e74 735f 646f 6328  .def events_doc(
-00025f80: 7363 6865 6475 6c65 722c 2065 7874 7261  scheduler, extra
-00025f90: 2c20 646f 6329 3a0a 2020 2020 6576 656e  , doc):.    even
-00025fa0: 7473 203d 2045 7665 6e74 7328 7363 6865  ts = Events(sche
-00025fb0: 6475 6c65 722c 2022 616c 6c22 2c20 6865  duler, "all", he
-00025fc0: 6967 6874 3d32 3530 290a 2020 2020 6576  ight=250).    ev
-00025fd0: 656e 7473 2e75 7064 6174 6528 290a 2020  ents.update().  
-00025fe0: 2020 6164 645f 7065 7269 6f64 6963 5f63    add_periodic_c
-00025ff0: 616c 6c62 6163 6b28 646f 632c 2065 7665  allback(doc, eve
-00026000: 6e74 732c 2035 3030 290a 2020 2020 646f  nts, 500).    do
-00026010: 632e 7469 746c 6520 3d20 2244 6173 6b3a  c.title = "Dask:
-00026020: 2053 6368 6564 756c 6572 2045 7665 6e74   Scheduler Event
-00026030: 7322 0a20 2020 2064 6f63 2e61 6464 5f72  s".    doc.add_r
-00026040: 6f6f 7428 636f 6c75 6d6e 2865 7665 6e74  oot(column(event
-00026050: 732e 726f 6f74 2c20 7369 7a69 6e67 5f6d  s.root, sizing_m
-00026060: 6f64 653d 2273 6361 6c65 5f77 6964 7468  ode="scale_width
-00026070: 2229 290a 2020 2020 646f 632e 7465 6d70  ")).    doc.temp
-00026080: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
-00026090: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
-000260a0: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
-000260b0: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
-000260c0: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
-000260d0: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
-000260e0: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
-000260f0: 6f67 5f65 7272 6f72 730a 6465 6620 6578  og_errors.def ex
-00026100: 6365 7074 696f 6e73 5f64 6f63 2873 6368  ceptions_doc(sch
-00026110: 6564 756c 6572 2c20 6578 7472 612c 2064  eduler, extra, d
-00026120: 6f63 293a 0a20 2020 2074 6162 6c65 203d  oc):.    table =
-00026130: 2045 7863 6570 7469 6f6e 7354 6162 6c65   ExceptionsTable
-00026140: 2873 6368 6564 756c 6572 290a 2020 2020  (scheduler).    
-00026150: 7461 626c 652e 7570 6461 7465 2829 0a20  table.update(). 
-00026160: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
-00026170: 6361 6c6c 6261 636b 2864 6f63 2c20 7461  callback(doc, ta
-00026180: 626c 652c 2031 3030 3029 0a20 2020 2064  ble, 1000).    d
-00026190: 6f63 2e74 6974 6c65 203d 2022 4461 736b  oc.title = "Dask
-000261a0: 3a20 4578 6365 7074 696f 6e73 220a 2020  : Exceptions".  
-000261b0: 2020 646f 632e 6164 645f 726f 6f74 2874    doc.add_root(t
-000261c0: 6162 6c65 2e72 6f6f 7429 0a20 2020 2064  able.root).    d
-000261d0: 6f63 2e74 656d 706c 6174 6520 3d20 656e  oc.template = en
-000261e0: 762e 6765 745f 7465 6d70 6c61 7465 2822  v.get_template("
-000261f0: 7369 6d70 6c65 2e68 746d 6c22 290a 2020  simple.html").  
-00026200: 2020 646f 632e 7465 6d70 6c61 7465 5f76    doc.template_v
-00026210: 6172 6961 626c 6573 2e75 7064 6174 6528  ariables.update(
-00026220: 6578 7472 6129 0a20 2020 2064 6f63 2e74  extra).    doc.t
-00026230: 6865 6d65 203d 2042 4f4b 4548 5f54 4845  heme = BOKEH_THE
-00026240: 4d45 0a0a 0a40 6c6f 675f 6572 726f 7273  ME...@log_errors
-00026250: 0a64 6566 2077 6f72 6b65 7273 5f64 6f63  .def workers_doc
-00026260: 2873 6368 6564 756c 6572 2c20 6578 7472  (scheduler, extr
-00026270: 612c 2064 6f63 293a 0a20 2020 2074 6162  a, doc):.    tab
-00026280: 6c65 203d 2057 6f72 6b65 7254 6162 6c65  le = WorkerTable
-00026290: 2873 6368 6564 756c 6572 290a 2020 2020  (scheduler).    
-000262a0: 7461 626c 652e 7570 6461 7465 2829 0a20  table.update(). 
-000262b0: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
-000262c0: 6361 6c6c 6261 636b 2864 6f63 2c20 7461  callback(doc, ta
-000262d0: 626c 652c 2035 3030 290a 2020 2020 646f  ble, 500).    do
-000262e0: 632e 7469 746c 6520 3d20 2244 6173 6b3a  c.title = "Dask:
-000262f0: 2057 6f72 6b65 7273 220a 2020 2020 646f   Workers".    do
-00026300: 632e 6164 645f 726f 6f74 2874 6162 6c65  c.add_root(table
-00026310: 2e72 6f6f 7429 0a20 2020 2064 6f63 2e74  .root).    doc.t
-00026320: 656d 706c 6174 6520 3d20 656e 762e 6765  emplate = env.ge
-00026330: 745f 7465 6d70 6c61 7465 2822 7369 6d70  t_template("simp
-00026340: 6c65 2e68 746d 6c22 290a 2020 2020 646f  le.html").    do
-00026350: 632e 7465 6d70 6c61 7465 5f76 6172 6961  c.template_varia
-00026360: 626c 6573 2e75 7064 6174 6528 6578 7472  bles.update(extr
-00026370: 6129 0a20 2020 2064 6f63 2e74 6865 6d65  a).    doc.theme
-00026380: 203d 2042 4f4b 4548 5f54 4845 4d45 0a0a   = BOKEH_THEME..
-00026390: 0a40 6c6f 675f 6572 726f 7273 0a64 6566  .@log_errors.def
-000263a0: 2068 6172 6477 6172 655f 646f 6328 7363   hardware_doc(sc
-000263b0: 6865 6475 6c65 722c 2065 7874 7261 2c20  heduler, extra, 
-000263c0: 646f 6329 3a0a 2020 2020 6877 203d 2048  doc):.    hw = H
-000263d0: 6172 6477 6172 6528 7363 6865 6475 6c65  ardware(schedule
-000263e0: 7229 0a20 2020 2068 772e 7570 6461 7465  r).    hw.update
-000263f0: 2829 0a20 2020 2064 6f63 2e74 6974 6c65  ().    doc.title
-00026400: 203d 2022 4461 736b 3a20 436c 7573 7465   = "Dask: Cluste
-00026410: 7220 4861 7264 7761 7265 2042 616e 6477  r Hardware Bandw
-00026420: 6964 7468 220a 2020 2020 646f 632e 6164  idth".    doc.ad
-00026430: 645f 726f 6f74 2868 772e 726f 6f74 290a  d_root(hw.root).
-00026440: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
-00026450: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
-00026460: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
-00026470: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
-00026480: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
-00026490: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
-000264a0: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
-000264b0: 485f 5448 454d 450a 0a20 2020 2061 6464  H_THEME..    add
-000264c0: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
-000264d0: 636b 2864 6f63 2c20 6877 2c20 3530 3029  ck(doc, hw, 500)
-000264e0: 0a0a 0a40 6c6f 675f 6572 726f 7273 0a64  ...@log_errors.d
-000264f0: 6566 2074 6173 6b73 5f64 6f63 2873 6368  ef tasks_doc(sch
-00026500: 6564 756c 6572 2c20 6578 7472 612c 2064  eduler, extra, d
-00026510: 6f63 293a 0a20 2020 2074 7320 3d20 5461  oc):.    ts = Ta
-00026520: 736b 5374 7265 616d 280a 2020 2020 2020  skStream(.      
-00026530: 2020 7363 6865 6475 6c65 722c 0a20 2020    scheduler,.   
-00026540: 2020 2020 206e 5f72 6563 7461 6e67 6c65       n_rectangle
-00026550: 733d 6461 736b 2e63 6f6e 6669 672e 6765  s=dask.config.ge
-00026560: 7428 0a20 2020 2020 2020 2020 2020 2022  t(.            "
-00026570: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-00026580: 6475 6c65 722e 6461 7368 626f 6172 642e  duler.dashboard.
-00026590: 7461 736b 732e 7461 736b 2d73 7472 6561  tasks.task-strea
-000265a0: 6d2d 6c65 6e67 7468 220a 2020 2020 2020  m-length".      
-000265b0: 2020 292c 0a20 2020 2020 2020 2063 6c65    ),.        cle
-000265c0: 6172 5f69 6e74 6572 7661 6c3d 2236 3073  ar_interval="60s
-000265d0: 222c 0a20 2020 2020 2020 2073 697a 696e  ",.        sizin
-000265e0: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-000265f0: 626f 7468 222c 0a20 2020 2029 0a20 2020  both",.    ).   
-00026600: 2074 732e 7570 6461 7465 2829 0a20 2020   ts.update().   
-00026610: 2061 6464 5f70 6572 696f 6469 635f 6361   add_periodic_ca
-00026620: 6c6c 6261 636b 2864 6f63 2c20 7473 2c20  llback(doc, ts, 
-00026630: 3530 3030 290a 2020 2020 646f 632e 7469  5000).    doc.ti
-00026640: 746c 6520 3d20 2244 6173 6b3a 2054 6173  tle = "Dask: Tas
-00026650: 6b20 5374 7265 616d 220a 2020 2020 646f  k Stream".    do
-00026660: 632e 6164 645f 726f 6f74 2874 732e 726f  c.add_root(ts.ro
-00026670: 6f74 290a 2020 2020 646f 632e 7465 6d70  ot).    doc.temp
-00026680: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
-00026690: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
-000266a0: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
-000266b0: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
-000266c0: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
-000266d0: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
-000266e0: 424f 4b45 485f 5448 454d 450a 0a0a 406c  BOKEH_THEME...@l
-000266f0: 6f67 5f65 7272 6f72 730a 6465 6620 6772  og_errors.def gr
-00026700: 6170 685f 646f 6328 7363 6865 6475 6c65  aph_doc(schedule
-00026710: 722c 2065 7874 7261 2c20 646f 6329 3a0a  r, extra, doc):.
-00026720: 2020 2020 6772 6170 6820 3d20 5461 736b      graph = Task
-00026730: 4772 6170 6828 7363 6865 6475 6c65 722c  Graph(scheduler,
-00026740: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
-00026750: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
-00026760: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
-00026770: 736b 3a20 5461 736b 2047 7261 7068 220a  sk: Task Graph".
-00026780: 2020 2020 6772 6170 682e 7570 6461 7465      graph.update
-00026790: 2829 0a20 2020 2061 6464 5f70 6572 696f  ().    add_perio
-000267a0: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
-000267b0: 2c20 6772 6170 682c 2032 3030 290a 2020  , graph, 200).  
-000267c0: 2020 646f 632e 6164 645f 726f 6f74 2867    doc.add_root(g
-000267d0: 7261 7068 2e72 6f6f 7429 0a0a 2020 2020  raph.root)..    
-000267e0: 646f 632e 7465 6d70 6c61 7465 203d 2065  doc.template = e
-000267f0: 6e76 2e67 6574 5f74 656d 706c 6174 6528  nv.get_template(
-00026800: 2273 696d 706c 652e 6874 6d6c 2229 0a20  "simple.html"). 
-00026810: 2020 2064 6f63 2e74 656d 706c 6174 655f     doc.template_
-00026820: 7661 7269 6162 6c65 732e 7570 6461 7465  variables.update
-00026830: 2865 7874 7261 290a 2020 2020 646f 632e  (extra).    doc.
-00026840: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
-00026850: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
-00026860: 730a 6465 6620 7467 5f67 7261 7068 5f64  s.def tg_graph_d
-00026870: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
-00026880: 7472 612c 2064 6f63 293a 0a20 2020 2074  tra, doc):.    t
-00026890: 675f 6772 6170 6820 3d20 5461 736b 4772  g_graph = TaskGr
-000268a0: 6f75 7047 7261 7068 2873 6368 6564 756c  oupGraph(schedul
-000268b0: 6572 2c20 7369 7a69 6e67 5f6d 6f64 653d  er, sizing_mode=
-000268c0: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
-000268d0: 2020 2020 646f 632e 7469 746c 6520 3d20      doc.title = 
-000268e0: 2244 6173 6b3a 2054 6173 6b20 4772 6f75  "Dask: Task Grou
-000268f0: 7073 2047 7261 7068 220a 2020 2020 7467  ps Graph".    tg
-00026900: 5f67 7261 7068 2e75 7064 6174 6528 290a  _graph.update().
-00026910: 2020 2020 6164 645f 7065 7269 6f64 6963      add_periodic
-00026920: 5f63 616c 6c62 6163 6b28 646f 632c 2074  _callback(doc, t
-00026930: 675f 6772 6170 682c 2032 3030 290a 2020  g_graph, 200).  
-00026940: 2020 646f 632e 6164 645f 726f 6f74 2874    doc.add_root(t
-00026950: 675f 6772 6170 682e 726f 6f74 290a 2020  g_graph.root).  
-00026960: 2020 646f 632e 7465 6d70 6c61 7465 203d    doc.template =
-00026970: 2065 6e76 2e67 6574 5f74 656d 706c 6174   env.get_templat
-00026980: 6528 2273 696d 706c 652e 6874 6d6c 2229  e("simple.html")
-00026990: 0a20 2020 2064 6f63 2e74 656d 706c 6174  .    doc.templat
-000269a0: 655f 7661 7269 6162 6c65 732e 7570 6461  e_variables.upda
-000269b0: 7465 2865 7874 7261 290a 2020 2020 646f  te(extra).    do
-000269c0: 632e 7468 656d 6520 3d20 424f 4b45 485f  c.theme = BOKEH_
-000269d0: 5448 454d 450a 0a0a 406c 6f67 5f65 7272  THEME...@log_err
-000269e0: 6f72 730a 6465 6620 7374 6174 7573 5f64  ors.def status_d
-000269f0: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
-00026a00: 7472 612c 2064 6f63 293a 0a20 2020 2063  tra, doc):.    c
-00026a10: 6c75 7374 6572 5f6d 656d 6f72 7920 3d20  luster_memory = 
-00026a20: 436c 7573 7465 724d 656d 6f72 7928 7363  ClusterMemory(sc
-00026a30: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
-00026a40: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-00026a50: 7468 2229 0a20 2020 2063 6c75 7374 6572  th").    cluster
-00026a60: 5f6d 656d 6f72 792e 7570 6461 7465 2829  _memory.update()
-00026a70: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
-00026a80: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
-00026a90: 636c 7573 7465 725f 6d65 6d6f 7279 2c20  cluster_memory, 
-00026aa0: 3130 3029 0a20 2020 2064 6f63 2e61 6464  100).    doc.add
-00026ab0: 5f72 6f6f 7428 636c 7573 7465 725f 6d65  _root(cluster_me
-00026ac0: 6d6f 7279 2e72 6f6f 7429 0a0a 2020 2020  mory.root)..    
-00026ad0: 6966 206c 656e 2873 6368 6564 756c 6572  if len(scheduler
-00026ae0: 2e77 6f72 6b65 7273 2920 3c3d 2031 3030  .workers) <= 100
-00026af0: 3a0a 2020 2020 2020 2020 776f 726b 6572  :.        worker
-00026b00: 735f 6d65 6d6f 7279 203d 2057 6f72 6b65  s_memory = Worke
-00026b10: 7273 4d65 6d6f 7279 2873 6368 6564 756c  rsMemory(schedul
-00026b20: 6572 2c20 7369 7a69 6e67 5f6d 6f64 653d  er, sizing_mode=
-00026b30: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
-00026b40: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
-00026b50: 696e 6720 3d20 4375 7272 656e 744c 6f61  ing = CurrentLoa
-00026b60: 6428 7363 6865 6475 6c65 722c 2073 697a  d(scheduler, siz
-00026b70: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
-00026b80: 685f 626f 7468 2229 0a0a 2020 2020 2020  h_both")..      
-00026b90: 2020 7072 6f63 6573 7369 6e67 5f72 6f6f    processing_roo
-00026ba0: 7420 3d20 7072 6f63 6573 7369 6e67 2e70  t = processing.p
-00026bb0: 726f 6365 7373 696e 675f 6669 6775 7265  rocessing_figure
-00026bc0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
-00026bd0: 2020 2077 6f72 6b65 7273 5f6d 656d 6f72     workers_memor
-00026be0: 7920 3d20 576f 726b 6572 734d 656d 6f72  y = WorkersMemor
-00026bf0: 7948 6973 746f 6772 616d 2873 6368 6564  yHistogram(sched
-00026c00: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
-00026c10: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
-00026c20: 290a 2020 2020 2020 2020 7072 6f63 6573  ).        proces
-00026c30: 7369 6e67 203d 2050 726f 6365 7373 696e  sing = Processin
-00026c40: 6748 6973 746f 6772 616d 2873 6368 6564  gHistogram(sched
-00026c50: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
-00026c60: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
-00026c70: 290a 0a20 2020 2020 2020 2070 726f 6365  )..        proce
-00026c80: 7373 696e 675f 726f 6f74 203d 2070 726f  ssing_root = pro
-00026c90: 6365 7373 696e 672e 726f 6f74 0a0a 2020  cessing.root..  
-00026ca0: 2020 6375 7272 656e 745f 6c6f 6164 203d    current_load =
-00026cb0: 2043 7572 7265 6e74 4c6f 6164 2873 6368   CurrentLoad(sch
-00026cc0: 6564 756c 6572 2c20 7369 7a69 6e67 5f6d  eduler, sizing_m
-00026cd0: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
-00026ce0: 6822 290a 2020 2020 6f63 6375 7061 6e63  h").    occupanc
-00026cf0: 7920 3d20 4f63 6375 7061 6e63 7928 7363  y = Occupancy(sc
-00026d00: 6865 6475 6c65 722c 2073 697a 696e 675f  heduler, sizing_
-00026d10: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-00026d20: 7468 2229 0a20 2020 2077 6f72 6b65 7273  th").    workers
-00026d30: 5f74 7261 6e73 6665 725f 6279 7465 7320  _transfer_bytes 
-00026d40: 3d20 576f 726b 6572 7354 7261 6e73 6665  = WorkersTransfe
-00026d50: 7242 7974 6573 2873 6368 6564 756c 6572  rBytes(scheduler
-00026d60: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
-00026d70: 7472 6574 6368 5f62 6f74 6822 290a 0a20  tretch_both").. 
-00026d80: 2020 2063 7075 5f72 6f6f 7420 3d20 6375     cpu_root = cu
-00026d90: 7272 656e 745f 6c6f 6164 2e63 7075 5f66  rrent_load.cpu_f
-00026da0: 6967 7572 650a 2020 2020 6f63 6375 7061  igure.    occupa
-00026db0: 6e63 795f 726f 6f74 203d 206f 6363 7570  ncy_root = occup
-00026dc0: 616e 6379 2e72 6f6f 740a 0a20 2020 2077  ancy.root..    w
-00026dd0: 6f72 6b65 7273 5f6d 656d 6f72 792e 7570  orkers_memory.up
-00026de0: 6461 7465 2829 0a20 2020 2077 6f72 6b65  date().    worke
-00026df0: 7273 5f74 7261 6e73 6665 725f 6279 7465  rs_transfer_byte
-00026e00: 732e 7570 6461 7465 2829 0a20 2020 2070  s.update().    p
-00026e10: 726f 6365 7373 696e 672e 7570 6461 7465  rocessing.update
-00026e20: 2829 0a20 2020 2063 7572 7265 6e74 5f6c  ().    current_l
-00026e30: 6f61 642e 7570 6461 7465 2829 0a20 2020  oad.update().   
-00026e40: 206f 6363 7570 616e 6379 2e75 7064 6174   occupancy.updat
-00026e50: 6528 290a 0a20 2020 2061 6464 5f70 6572  e()..    add_per
-00026e60: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
-00026e70: 6f63 2c20 776f 726b 6572 735f 6d65 6d6f  oc, workers_memo
-00026e80: 7279 2c20 3130 3029 0a20 2020 2061 6464  ry, 100).    add
-00026e90: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
-00026ea0: 636b 2864 6f63 2c20 776f 726b 6572 735f  ck(doc, workers_
-00026eb0: 7472 616e 7366 6572 5f62 7974 6573 2c20  transfer_bytes, 
-00026ec0: 3130 3029 0a20 2020 2061 6464 5f70 6572  100).    add_per
-00026ed0: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
-00026ee0: 6f63 2c20 7072 6f63 6573 7369 6e67 2c20  oc, processing, 
-00026ef0: 3130 3029 0a20 2020 2061 6464 5f70 6572  100).    add_per
-00026f00: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
-00026f10: 6f63 2c20 6375 7272 656e 745f 6c6f 6164  oc, current_load
-00026f20: 2c20 3130 3029 0a20 2020 2061 6464 5f70  , 100).    add_p
-00026f30: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00026f40: 2864 6f63 2c20 6f63 6375 7061 6e63 792c  (doc, occupancy,
-00026f50: 2031 3030 290a 0a20 2020 2064 6f63 2e61   100)..    doc.a
-00026f60: 6464 5f72 6f6f 7428 776f 726b 6572 735f  dd_root(workers_
-00026f70: 6d65 6d6f 7279 2e72 6f6f 7429 0a0a 2020  memory.root)..  
-00026f80: 2020 7461 6273 203d 205b 0a20 2020 2020    tabs = [.     
-00026f90: 2020 2054 6162 5061 6e65 6c28 6368 696c     TabPanel(chil
-00026fa0: 643d 7072 6f63 6573 7369 6e67 5f72 6f6f  d=processing_roo
-00026fb0: 742c 2074 6974 6c65 3d22 5072 6f63 6573  t, title="Proces
-00026fc0: 7369 6e67 2229 2c0a 2020 2020 2020 2020  sing"),.        
-00026fd0: 5461 6250 616e 656c 2863 6869 6c64 3d63  TabPanel(child=c
-00026fe0: 7075 5f72 6f6f 742c 2074 6974 6c65 3d22  pu_root, title="
-00026ff0: 4350 5522 292c 0a20 2020 2020 2020 2054  CPU"),.        T
-00027000: 6162 5061 6e65 6c28 6368 696c 643d 6f63  abPanel(child=oc
-00027010: 6375 7061 6e63 795f 726f 6f74 2c20 7469  cupancy_root, ti
-00027020: 746c 653d 224f 6363 7570 616e 6379 2229  tle="Occupancy")
-00027030: 2c0a 2020 2020 2020 2020 5461 6250 616e  ,.        TabPan
-00027040: 656c 2863 6869 6c64 3d77 6f72 6b65 7273  el(child=workers
-00027050: 5f74 7261 6e73 6665 725f 6279 7465 732e  _transfer_bytes.
-00027060: 726f 6f74 2c20 7469 746c 653d 2244 6174  root, title="Dat
-00027070: 6120 5472 616e 7366 6572 2229 2c0a 2020  a Transfer"),.  
-00027080: 2020 5d0a 0a20 2020 2068 656c 705f 203d    ]..    help_ =
-00027090: 2048 656c 7054 6f6f 6c28 0a20 2020 2020   HelpTool(.     
-000270a0: 2020 2072 6564 6972 6563 743d 2268 7474     redirect="htt
-000270b0: 7073 3a2f 2f64 6f63 732e 6461 736b 2e6f  ps://docs.dask.o
-000270c0: 7267 2f65 6e2f 7374 6162 6c65 2f64 6173  rg/en/stable/das
-000270d0: 6862 6f61 7264 2e68 746d 6c23 7461 736b  hboard.html#task
-000270e0: 2d70 726f 6365 7373 696e 672d 6370 752d  -processing-cpu-
-000270f0: 7574 696c 697a 6174 696f 6e2d 6f63 6375  utilization-occu
-00027100: 7061 6e63 792d 6461 7461 2d74 7261 6e73  pancy-data-trans
-00027110: 6665 7222 2c0a 2020 2020 2020 2020 6465  fer",.        de
-00027120: 7363 7269 7074 696f 6e3d 2241 2064 6573  scription="A des
-00027130: 6372 6970 7469 6f6e 206f 6620 5461 736b  cription of Task
-00027140: 2050 726f 6365 7373 696e 672f 4350 5520   Processing/CPU 
-00027150: 5574 696c 697a 6174 696f 6e2f 4f63 6375  Utilization/Occu
-00027160: 7061 6e63 7922 2c0a 2020 2020 290a 2020  pancy",.    ).  
-00027170: 2020 666f 7220 7461 6220 696e 2074 6162    for tab in tab
-00027180: 733a 0a20 2020 2020 2020 2074 6162 2e63  s:.        tab.c
-00027190: 6869 6c64 2e74 6f6f 6c62 6172 5f6c 6f63  hild.toolbar_loc
-000271a0: 6174 696f 6e20 3d20 2261 626f 7665 220a  ation = "above".
-000271b0: 2020 2020 2020 2020 7461 622e 6368 696c          tab.chil
-000271c0: 642e 6164 645f 746f 6f6c 7328 6865 6c70  d.add_tools(help
-000271d0: 5f29 0a0a 2020 2020 7072 6f63 5f74 6162  _)..    proc_tab
-000271e0: 7320 3d20 5461 6273 2874 6162 733d 7461  s = Tabs(tabs=ta
-000271f0: 6273 2c20 6e61 6d65 3d22 7072 6f63 6573  bs, name="proces
-00027200: 7369 6e67 5f74 6162 7322 2c20 7369 7a69  sing_tabs", sizi
-00027210: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
-00027220: 5f62 6f74 6822 290a 2020 2020 646f 632e  _both").    doc.
-00027230: 6164 645f 726f 6f74 2870 726f 635f 7461  add_root(proc_ta
-00027240: 6273 290a 0a20 2020 2074 6173 6b5f 7374  bs)..    task_st
-00027250: 7265 616d 203d 2054 6173 6b53 7472 6561  ream = TaskStrea
-00027260: 6d28 0a20 2020 2020 2020 2073 6368 6564  m(.        sched
-00027270: 756c 6572 2c0a 2020 2020 2020 2020 6e5f  uler,.        n_
-00027280: 7265 6374 616e 676c 6573 3d64 6173 6b2e  rectangles=dask.
-00027290: 636f 6e66 6967 2e67 6574 280a 2020 2020  config.get(.    
-000272a0: 2020 2020 2020 2020 2264 6973 7472 6962          "distrib
-000272b0: 7574 6564 2e73 6368 6564 756c 6572 2e64  uted.scheduler.d
-000272c0: 6173 6862 6f61 7264 2e73 7461 7475 732e  ashboard.status.
-000272d0: 7461 736b 2d73 7472 6561 6d2d 6c65 6e67  task-stream-leng
-000272e0: 7468 220a 2020 2020 2020 2020 292c 0a20  th".        ),. 
-000272f0: 2020 2020 2020 2063 6c65 6172 5f69 6e74         clear_int
-00027300: 6572 7661 6c3d 2235 7322 2c0a 2020 2020  erval="5s",.    
-00027310: 2020 2020 7369 7a69 6e67 5f6d 6f64 653d      sizing_mode=
-00027320: 2273 7472 6574 6368 5f62 6f74 6822 2c0a  "stretch_both",.
-00027330: 2020 2020 290a 2020 2020 7461 736b 5f73      ).    task_s
-00027340: 7472 6561 6d2e 7570 6461 7465 2829 0a20  tream.update(). 
-00027350: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
-00027360: 6361 6c6c 6261 636b 2864 6f63 2c20 7461  callback(doc, ta
-00027370: 736b 5f73 7472 6561 6d2c 2031 3030 290a  sk_stream, 100).
-00027380: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
-00027390: 2874 6173 6b5f 7374 7265 616d 2e72 6f6f  (task_stream.roo
-000273a0: 7429 0a0a 2020 2020 7461 736b 5f70 726f  t)..    task_pro
-000273b0: 6772 6573 7320 3d20 5461 736b 5072 6f67  gress = TaskProg
-000273c0: 7265 7373 2873 6368 6564 756c 6572 2c20  ress(scheduler, 
-000273d0: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-000273e0: 6574 6368 5f62 6f74 6822 290a 2020 2020  etch_both").    
-000273f0: 7461 736b 5f70 726f 6772 6573 732e 7570  task_progress.up
-00027400: 6461 7465 2829 0a20 2020 2061 6464 5f70  date().    add_p
-00027410: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00027420: 2864 6f63 2c20 7461 736b 5f70 726f 6772  (doc, task_progr
-00027430: 6573 732c 2031 3030 290a 2020 2020 646f  ess, 100).    do
-00027440: 632e 6164 645f 726f 6f74 2874 6173 6b5f  c.add_root(task_
-00027450: 7072 6f67 7265 7373 2e72 6f6f 7429 0a0a  progress.root)..
-00027460: 2020 2020 646f 632e 7469 746c 6520 3d20      doc.title = 
-00027470: 2244 6173 6b3a 2053 7461 7475 7322 0a20  "Dask: Status". 
-00027480: 2020 2064 6f63 2e74 6865 6d65 203d 2042     doc.theme = B
-00027490: 4f4b 4548 5f54 4845 4d45 0a20 2020 2064  OKEH_THEME.    d
-000274a0: 6f63 2e74 656d 706c 6174 6520 3d20 656e  oc.template = en
-000274b0: 762e 6765 745f 7465 6d70 6c61 7465 2822  v.get_template("
-000274c0: 7374 6174 7573 2e68 746d 6c22 290a 2020  status.html").  
-000274d0: 2020 646f 632e 7465 6d70 6c61 7465 5f76    doc.template_v
-000274e0: 6172 6961 626c 6573 2e75 7064 6174 6528  ariables.update(
-000274f0: 6578 7472 6129 0a0a 0a40 6c6f 675f 6572  extra)...@log_er
-00027500: 726f 7273 0a40 6375 7272 790a 6465 6620  rors.@curry.def 
-00027510: 696e 6469 7669 6475 616c 5f64 6f63 2863  individual_doc(c
-00027520: 6c73 2c20 696e 7465 7276 616c 2c20 7363  ls, interval, sc
-00027530: 6865 6475 6c65 722c 2065 7874 7261 2c20  heduler, extra, 
-00027540: 646f 632c 2066 6967 5f61 7474 723d 2272  doc, fig_attr="r
-00027550: 6f6f 7422 2c20 2a2a 6b77 6172 6773 293a  oot", **kwargs):
-00027560: 0a20 2020 2023 204e 6f74 653a 2040 6c6f  .    # Note: @lo
-00027570: 675f 6572 726f 7273 2061 6e64 2040 6375  g_errors and @cu
-00027580: 7272 7920 6172 6520 6e6f 7420 636f 6d70  rry are not comp
-00027590: 6174 6962 6c65 0a20 2020 2066 6967 203d  atible.    fig =
-000275a0: 2063 6c73 2873 6368 6564 756c 6572 2c20   cls(scheduler, 
-000275b0: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-000275c0: 6574 6368 5f62 6f74 6822 2c20 2a2a 6b77  etch_both", **kw
-000275d0: 6172 6773 290a 2020 2020 6669 672e 7570  args).    fig.up
-000275e0: 6461 7465 2829 0a20 2020 2061 6464 5f70  date().    add_p
-000275f0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00027600: 2864 6f63 2c20 6669 672c 2069 6e74 6572  (doc, fig, inter
-00027610: 7661 6c29 0a20 2020 2064 6f63 2e61 6464  val).    doc.add
-00027620: 5f72 6f6f 7428 6765 7461 7474 7228 6669  _root(getattr(fi
-00027630: 672c 2066 6967 5f61 7474 7229 290a 2020  g, fig_attr)).  
-00027640: 2020 646f 632e 7468 656d 6520 3d20 424f    doc.theme = BO
-00027650: 4b45 485f 5448 454d 450a 2020 2020 646f  KEH_THEME.    do
-00027660: 632e 7469 746c 6520 3d20 2244 6173 6b3a  c.title = "Dask:
-00027670: 2022 202b 2066 756e 636e 616d 6528 636c   " + funcname(cl
-00027680: 7329 0a0a 0a40 6c6f 675f 6572 726f 7273  s)...@log_errors
-00027690: 0a64 6566 2069 6e64 6976 6964 7561 6c5f  .def individual_
-000276a0: 7072 6f66 696c 655f 646f 6328 7363 6865  profile_doc(sche
-000276b0: 6475 6c65 722c 2065 7874 7261 2c20 646f  duler, extra, do
-000276c0: 6329 3a0a 2020 2020 7072 6f66 203d 2050  c):.    prof = P
-000276d0: 726f 6669 6c65 5469 6d65 506c 6f74 2873  rofileTimePlot(s
-000276e0: 6368 6564 756c 6572 2c20 7369 7a69 6e67  cheduler, sizing
-000276f0: 5f6d 6f64 653d 2273 7472 6574 6368 5f62  _mode="stretch_b
-00027700: 6f74 6822 2c20 646f 633d 646f 6329 0a20  oth", doc=doc). 
-00027710: 2020 2064 6f63 2e61 6464 5f72 6f6f 7428     doc.add_root(
-00027720: 7072 6f66 2e72 6f6f 7429 0a20 2020 2070  prof.root).    p
-00027730: 726f 662e 7472 6967 6765 725f 7570 6461  rof.trigger_upda
-00027740: 7465 2829 0a20 2020 2064 6f63 2e74 6865  te().    doc.the
-00027750: 6d65 203d 2042 4f4b 4548 5f54 4845 4d45  me = BOKEH_THEME
-00027760: 0a0a 0a40 6c6f 675f 6572 726f 7273 0a64  ...@log_errors.d
-00027770: 6566 2069 6e64 6976 6964 7561 6c5f 7072  ef individual_pr
-00027780: 6f66 696c 655f 7365 7276 6572 5f64 6f63  ofile_server_doc
-00027790: 2873 6368 6564 756c 6572 2c20 6578 7472  (scheduler, extr
-000277a0: 612c 2064 6f63 293a 0a20 2020 2070 726f  a, doc):.    pro
-000277b0: 6620 3d20 5072 6f66 696c 6553 6572 7665  f = ProfileServe
-000277c0: 7228 7363 6865 6475 6c65 722c 2073 697a  r(scheduler, siz
-000277d0: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
-000277e0: 685f 626f 7468 222c 2064 6f63 3d64 6f63  h_both", doc=doc
-000277f0: 290a 2020 2020 646f 632e 6164 645f 726f  ).    doc.add_ro
-00027800: 6f74 2870 726f 662e 726f 6f74 290a 2020  ot(prof.root).  
-00027810: 2020 7072 6f66 2e74 7269 6767 6572 5f75    prof.trigger_u
-00027820: 7064 6174 6528 290a 2020 2020 646f 632e  pdate().    doc.
-00027830: 7468 656d 6520 3d20 424f 4b45 485f 5448  theme = BOKEH_TH
-00027840: 454d 450a 0a0a 406c 6f67 5f65 7272 6f72  EME...@log_error
-00027850: 730a 6465 6620 7072 6f66 696c 655f 646f  s.def profile_do
-00027860: 6328 7363 6865 6475 6c65 722c 2065 7874  c(scheduler, ext
-00027870: 7261 2c20 646f 6329 3a0a 2020 2020 646f  ra, doc):.    do
-00027880: 632e 7469 746c 6520 3d20 2244 6173 6b3a  c.title = "Dask:
-00027890: 2050 726f 6669 6c65 220a 2020 2020 7072   Profile".    pr
-000278a0: 6f66 203d 2050 726f 6669 6c65 5469 6d65  of = ProfileTime
-000278b0: 506c 6f74 2873 6368 6564 756c 6572 2c20  Plot(scheduler, 
-000278c0: 7369 7a69 6e67 5f6d 6f64 653d 2273 7472  sizing_mode="str
-000278d0: 6574 6368 5f62 6f74 6822 2c20 646f 633d  etch_both", doc=
-000278e0: 646f 6329 0a20 2020 2064 6f63 2e61 6464  doc).    doc.add
-000278f0: 5f72 6f6f 7428 7072 6f66 2e72 6f6f 7429  _root(prof.root)
-00027900: 0a20 2020 2064 6f63 2e74 656d 706c 6174  .    doc.templat
-00027910: 6520 3d20 656e 762e 6765 745f 7465 6d70  e = env.get_temp
-00027920: 6c61 7465 2822 7369 6d70 6c65 2e68 746d  late("simple.htm
-00027930: 6c22 290a 2020 2020 646f 632e 7465 6d70  l").    doc.temp
-00027940: 6c61 7465 5f76 6172 6961 626c 6573 2e75  late_variables.u
-00027950: 7064 6174 6528 6578 7472 6129 0a20 2020  pdate(extra).   
-00027960: 2064 6f63 2e74 6865 6d65 203d 2042 4f4b   doc.theme = BOK
-00027970: 4548 5f54 4845 4d45 0a0a 2020 2020 7072  EH_THEME..    pr
-00027980: 6f66 2e74 7269 6767 6572 5f75 7064 6174  of.trigger_updat
-00027990: 6528 290a 0a0a 406c 6f67 5f65 7272 6f72  e()...@log_error
-000279a0: 730a 6465 6620 7072 6f66 696c 655f 7365  s.def profile_se
-000279b0: 7276 6572 5f64 6f63 2873 6368 6564 756c  rver_doc(schedul
-000279c0: 6572 2c20 6578 7472 612c 2064 6f63 293a  er, extra, doc):
-000279d0: 0a20 2020 2064 6f63 2e74 6974 6c65 203d  .    doc.title =
-000279e0: 2022 4461 736b 3a20 5072 6f66 696c 6520   "Dask: Profile 
-000279f0: 6f66 2045 7665 6e74 204c 6f6f 7022 0a20  of Event Loop". 
-00027a00: 2020 2070 726f 6620 3d20 5072 6f66 696c     prof = Profil
-00027a10: 6553 6572 7665 7228 7363 6865 6475 6c65  eServer(schedule
-00027a20: 722c 2073 697a 696e 675f 6d6f 6465 3d22  r, sizing_mode="
-00027a30: 7374 7265 7463 685f 626f 7468 222c 2064  stretch_both", d
-00027a40: 6f63 3d64 6f63 290a 2020 2020 646f 632e  oc=doc).    doc.
-00027a50: 6164 645f 726f 6f74 2870 726f 662e 726f  add_root(prof.ro
-00027a60: 6f74 290a 2020 2020 646f 632e 7465 6d70  ot).    doc.temp
-00027a70: 6c61 7465 203d 2065 6e76 2e67 6574 5f74  late = env.get_t
-00027a80: 656d 706c 6174 6528 2273 696d 706c 652e  emplate("simple.
-00027a90: 6874 6d6c 2229 0a20 2020 2064 6f63 2e74  html").    doc.t
-00027aa0: 656d 706c 6174 655f 7661 7269 6162 6c65  emplate_variable
-00027ab0: 732e 7570 6461 7465 2865 7874 7261 290a  s.update(extra).
-00027ac0: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
-00027ad0: 424f 4b45 485f 5448 454d 450a 0a20 2020  BOKEH_THEME..   
-00027ae0: 2070 726f 662e 7472 6967 6765 725f 7570   prof.trigger_up
-00027af0: 6461 7465 2829 0a                        date().
+00025e90: 675f 7473 2e72 6f6f 742c 0a20 2020 2020  g_ts.root,.     
+00025ea0: 2020 2020 2020 2020 2020 2073 7465 616c             steal
+00025eb0: 696e 675f 6576 656e 7473 2e72 6f6f 742c  ing_events.root,
+00025ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025ed0: 2073 697a 696e 675f 6d6f 6465 3d22 7374   sizing_mode="st
+00025ee0: 7265 7463 685f 626f 7468 222c 0a20 2020  retch_both",.   
+00025ef0: 2020 2020 2020 2020 2029 2c0a 2020 2020           ),.    
+00025f00: 2020 2020 290a 2020 2020 290a 0a20 2020      ).    )..   
+00025f10: 2064 6f63 2e74 656d 706c 6174 6520 3d20   doc.template = 
+00025f20: 656e 762e 6765 745f 7465 6d70 6c61 7465  env.get_template
+00025f30: 2822 7369 6d70 6c65 2e68 746d 6c22 290a  ("simple.html").
+00025f40: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
+00025f50: 5f76 6172 6961 626c 6573 2e75 7064 6174  _variables.updat
+00025f60: 6528 6578 7472 6129 0a20 2020 2064 6f63  e(extra).    doc
+00025f70: 2e74 6865 6d65 203d 2042 4f4b 4548 5f54  .theme = BOKEH_T
+00025f80: 4845 4d45 0a0a 0a40 6c6f 675f 6572 726f  HEME...@log_erro
+00025f90: 7273 0a64 6566 2065 7665 6e74 735f 646f  rs.def events_do
+00025fa0: 6328 7363 6865 6475 6c65 722c 2065 7874  c(scheduler, ext
+00025fb0: 7261 2c20 646f 6329 3a0a 2020 2020 6576  ra, doc):.    ev
+00025fc0: 656e 7473 203d 2045 7665 6e74 7328 7363  ents = Events(sc
+00025fd0: 6865 6475 6c65 722c 2022 616c 6c22 2c20  heduler, "all", 
+00025fe0: 6865 6967 6874 3d32 3530 290a 2020 2020  height=250).    
+00025ff0: 6576 656e 7473 2e75 7064 6174 6528 290a  events.update().
+00026000: 2020 2020 6164 645f 7065 7269 6f64 6963      add_periodic
+00026010: 5f63 616c 6c62 6163 6b28 646f 632c 2065  _callback(doc, e
+00026020: 7665 6e74 732c 2035 3030 290a 2020 2020  vents, 500).    
+00026030: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
+00026040: 6b3a 2053 6368 6564 756c 6572 2045 7665  k: Scheduler Eve
+00026050: 6e74 7322 0a20 2020 2064 6f63 2e61 6464  nts".    doc.add
+00026060: 5f72 6f6f 7428 636f 6c75 6d6e 2865 7665  _root(column(eve
+00026070: 6e74 732e 726f 6f74 2c20 7369 7a69 6e67  nts.root, sizing
+00026080: 5f6d 6f64 653d 2273 6361 6c65 5f77 6964  _mode="scale_wid
+00026090: 7468 2229 290a 2020 2020 646f 632e 7465  th")).    doc.te
+000260a0: 6d70 6c61 7465 203d 2065 6e76 2e67 6574  mplate = env.get
+000260b0: 5f74 656d 706c 6174 6528 2273 696d 706c  _template("simpl
+000260c0: 652e 6874 6d6c 2229 0a20 2020 2064 6f63  e.html").    doc
+000260d0: 2e74 656d 706c 6174 655f 7661 7269 6162  .template_variab
+000260e0: 6c65 732e 7570 6461 7465 2865 7874 7261  les.update(extra
+000260f0: 290a 2020 2020 646f 632e 7468 656d 6520  ).    doc.theme 
+00026100: 3d20 424f 4b45 485f 5448 454d 450a 0a0a  = BOKEH_THEME...
+00026110: 406c 6f67 5f65 7272 6f72 730a 6465 6620  @log_errors.def 
+00026120: 6578 6365 7074 696f 6e73 5f64 6f63 2873  exceptions_doc(s
+00026130: 6368 6564 756c 6572 2c20 6578 7472 612c  cheduler, extra,
+00026140: 2064 6f63 293a 0a20 2020 2074 6162 6c65   doc):.    table
+00026150: 203d 2045 7863 6570 7469 6f6e 7354 6162   = ExceptionsTab
+00026160: 6c65 2873 6368 6564 756c 6572 290a 2020  le(scheduler).  
+00026170: 2020 7461 626c 652e 7570 6461 7465 2829    table.update()
+00026180: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
+00026190: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
+000261a0: 7461 626c 652c 2031 3030 3029 0a20 2020  table, 1000).   
+000261b0: 2064 6f63 2e74 6974 6c65 203d 2022 4461   doc.title = "Da
+000261c0: 736b 3a20 4578 6365 7074 696f 6e73 220a  sk: Exceptions".
+000261d0: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
+000261e0: 2874 6162 6c65 2e72 6f6f 7429 0a20 2020  (table.root).   
+000261f0: 2064 6f63 2e74 656d 706c 6174 6520 3d20   doc.template = 
+00026200: 656e 762e 6765 745f 7465 6d70 6c61 7465  env.get_template
+00026210: 2822 7369 6d70 6c65 2e68 746d 6c22 290a  ("simple.html").
+00026220: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
+00026230: 5f76 6172 6961 626c 6573 2e75 7064 6174  _variables.updat
+00026240: 6528 6578 7472 6129 0a20 2020 2064 6f63  e(extra).    doc
+00026250: 2e74 6865 6d65 203d 2042 4f4b 4548 5f54  .theme = BOKEH_T
+00026260: 4845 4d45 0a0a 0a40 6c6f 675f 6572 726f  HEME...@log_erro
+00026270: 7273 0a64 6566 2077 6f72 6b65 7273 5f64  rs.def workers_d
+00026280: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
+00026290: 7472 612c 2064 6f63 293a 0a20 2020 2074  tra, doc):.    t
+000262a0: 6162 6c65 203d 2057 6f72 6b65 7254 6162  able = WorkerTab
+000262b0: 6c65 2873 6368 6564 756c 6572 290a 2020  le(scheduler).  
+000262c0: 2020 7461 626c 652e 7570 6461 7465 2829    table.update()
+000262d0: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
+000262e0: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
+000262f0: 7461 626c 652c 2035 3030 290a 2020 2020  table, 500).    
+00026300: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
+00026310: 6b3a 2057 6f72 6b65 7273 220a 2020 2020  k: Workers".    
+00026320: 646f 632e 6164 645f 726f 6f74 2874 6162  doc.add_root(tab
+00026330: 6c65 2e72 6f6f 7429 0a20 2020 2064 6f63  le.root).    doc
+00026340: 2e74 656d 706c 6174 6520 3d20 656e 762e  .template = env.
+00026350: 6765 745f 7465 6d70 6c61 7465 2822 7369  get_template("si
+00026360: 6d70 6c65 2e68 746d 6c22 290a 2020 2020  mple.html").    
+00026370: 646f 632e 7465 6d70 6c61 7465 5f76 6172  doc.template_var
+00026380: 6961 626c 6573 2e75 7064 6174 6528 6578  iables.update(ex
+00026390: 7472 6129 0a20 2020 2064 6f63 2e74 6865  tra).    doc.the
+000263a0: 6d65 203d 2042 4f4b 4548 5f54 4845 4d45  me = BOKEH_THEME
+000263b0: 0a0a 0a40 6c6f 675f 6572 726f 7273 0a64  ...@log_errors.d
+000263c0: 6566 2068 6172 6477 6172 655f 646f 6328  ef hardware_doc(
+000263d0: 7363 6865 6475 6c65 722c 2065 7874 7261  scheduler, extra
+000263e0: 2c20 646f 6329 3a0a 2020 2020 6877 203d  , doc):.    hw =
+000263f0: 2048 6172 6477 6172 6528 7363 6865 6475   Hardware(schedu
+00026400: 6c65 7229 0a20 2020 2068 772e 7570 6461  ler).    hw.upda
+00026410: 7465 2829 0a20 2020 2064 6f63 2e74 6974  te().    doc.tit
+00026420: 6c65 203d 2022 4461 736b 3a20 436c 7573  le = "Dask: Clus
+00026430: 7465 7220 4861 7264 7761 7265 2042 616e  ter Hardware Ban
+00026440: 6477 6964 7468 220a 2020 2020 646f 632e  dwidth".    doc.
+00026450: 6164 645f 726f 6f74 2868 772e 726f 6f74  add_root(hw.root
+00026460: 290a 2020 2020 646f 632e 7465 6d70 6c61  ).    doc.templa
+00026470: 7465 203d 2065 6e76 2e67 6574 5f74 656d  te = env.get_tem
+00026480: 706c 6174 6528 2273 696d 706c 652e 6874  plate("simple.ht
+00026490: 6d6c 2229 0a20 2020 2064 6f63 2e74 656d  ml").    doc.tem
+000264a0: 706c 6174 655f 7661 7269 6162 6c65 732e  plate_variables.
+000264b0: 7570 6461 7465 2865 7874 7261 290a 2020  update(extra).  
+000264c0: 2020 646f 632e 7468 656d 6520 3d20 424f    doc.theme = BO
+000264d0: 4b45 485f 5448 454d 450a 0a20 2020 2061  KEH_THEME..    a
+000264e0: 6464 5f70 6572 696f 6469 635f 6361 6c6c  dd_periodic_call
+000264f0: 6261 636b 2864 6f63 2c20 6877 2c20 3530  back(doc, hw, 50
+00026500: 3029 0a0a 0a40 6c6f 675f 6572 726f 7273  0)...@log_errors
+00026510: 0a64 6566 2074 6173 6b73 5f64 6f63 2873  .def tasks_doc(s
+00026520: 6368 6564 756c 6572 2c20 6578 7472 612c  cheduler, extra,
+00026530: 2064 6f63 293a 0a20 2020 2074 7320 3d20   doc):.    ts = 
+00026540: 5461 736b 5374 7265 616d 280a 2020 2020  TaskStream(.    
+00026550: 2020 2020 7363 6865 6475 6c65 722c 0a20      scheduler,. 
+00026560: 2020 2020 2020 206e 5f72 6563 7461 6e67         n_rectang
+00026570: 6c65 733d 6461 736b 2e63 6f6e 6669 672e  les=dask.config.
+00026580: 6765 7428 0a20 2020 2020 2020 2020 2020  get(.           
+00026590: 2022 6469 7374 7269 6275 7465 642e 7363   "distributed.sc
+000265a0: 6865 6475 6c65 722e 6461 7368 626f 6172  heduler.dashboar
+000265b0: 642e 7461 736b 732e 7461 736b 2d73 7472  d.tasks.task-str
+000265c0: 6561 6d2d 6c65 6e67 7468 220a 2020 2020  eam-length".    
+000265d0: 2020 2020 292c 0a20 2020 2020 2020 2063      ),.        c
+000265e0: 6c65 6172 5f69 6e74 6572 7661 6c3d 2236  lear_interval="6
+000265f0: 3073 222c 0a20 2020 2020 2020 2073 697a  0s",.        siz
+00026600: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
+00026610: 685f 626f 7468 222c 0a20 2020 2029 0a20  h_both",.    ). 
+00026620: 2020 2074 732e 7570 6461 7465 2829 0a20     ts.update(). 
+00026630: 2020 2061 6464 5f70 6572 696f 6469 635f     add_periodic_
+00026640: 6361 6c6c 6261 636b 2864 6f63 2c20 7473  callback(doc, ts
+00026650: 2c20 3530 3030 290a 2020 2020 646f 632e  , 5000).    doc.
+00026660: 7469 746c 6520 3d20 2244 6173 6b3a 2054  title = "Dask: T
+00026670: 6173 6b20 5374 7265 616d 220a 2020 2020  ask Stream".    
+00026680: 646f 632e 6164 645f 726f 6f74 2874 732e  doc.add_root(ts.
+00026690: 726f 6f74 290a 2020 2020 646f 632e 7465  root).    doc.te
+000266a0: 6d70 6c61 7465 203d 2065 6e76 2e67 6574  mplate = env.get
+000266b0: 5f74 656d 706c 6174 6528 2273 696d 706c  _template("simpl
+000266c0: 652e 6874 6d6c 2229 0a20 2020 2064 6f63  e.html").    doc
+000266d0: 2e74 656d 706c 6174 655f 7661 7269 6162  .template_variab
+000266e0: 6c65 732e 7570 6461 7465 2865 7874 7261  les.update(extra
+000266f0: 290a 2020 2020 646f 632e 7468 656d 6520  ).    doc.theme 
+00026700: 3d20 424f 4b45 485f 5448 454d 450a 0a0a  = BOKEH_THEME...
+00026710: 406c 6f67 5f65 7272 6f72 730a 6465 6620  @log_errors.def 
+00026720: 6772 6170 685f 646f 6328 7363 6865 6475  graph_doc(schedu
+00026730: 6c65 722c 2065 7874 7261 2c20 646f 6329  ler, extra, doc)
+00026740: 3a0a 2020 2020 6772 6170 6820 3d20 5461  :.    graph = Ta
+00026750: 736b 4772 6170 6828 7363 6865 6475 6c65  skGraph(schedule
+00026760: 722c 2073 697a 696e 675f 6d6f 6465 3d22  r, sizing_mode="
+00026770: 7374 7265 7463 685f 626f 7468 2229 0a20  stretch_both"). 
+00026780: 2020 2064 6f63 2e74 6974 6c65 203d 2022     doc.title = "
+00026790: 4461 736b 3a20 5461 736b 2047 7261 7068  Dask: Task Graph
+000267a0: 220a 2020 2020 6772 6170 682e 7570 6461  ".    graph.upda
+000267b0: 7465 2829 0a20 2020 2061 6464 5f70 6572  te().    add_per
+000267c0: 696f 6469 635f 6361 6c6c 6261 636b 2864  iodic_callback(d
+000267d0: 6f63 2c20 6772 6170 682c 2032 3030 290a  oc, graph, 200).
+000267e0: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
+000267f0: 2867 7261 7068 2e72 6f6f 7429 0a0a 2020  (graph.root)..  
+00026800: 2020 646f 632e 7465 6d70 6c61 7465 203d    doc.template =
+00026810: 2065 6e76 2e67 6574 5f74 656d 706c 6174   env.get_templat
+00026820: 6528 2273 696d 706c 652e 6874 6d6c 2229  e("simple.html")
+00026830: 0a20 2020 2064 6f63 2e74 656d 706c 6174  .    doc.templat
+00026840: 655f 7661 7269 6162 6c65 732e 7570 6461  e_variables.upda
+00026850: 7465 2865 7874 7261 290a 2020 2020 646f  te(extra).    do
+00026860: 632e 7468 656d 6520 3d20 424f 4b45 485f  c.theme = BOKEH_
+00026870: 5448 454d 450a 0a0a 406c 6f67 5f65 7272  THEME...@log_err
+00026880: 6f72 730a 6465 6620 7467 5f67 7261 7068  ors.def tg_graph
+00026890: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
+000268a0: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
+000268b0: 2074 675f 6772 6170 6820 3d20 5461 736b   tg_graph = Task
+000268c0: 4772 6f75 7047 7261 7068 2873 6368 6564  GroupGraph(sched
+000268d0: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
+000268e0: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+000268f0: 290a 2020 2020 646f 632e 7469 746c 6520  ).    doc.title 
+00026900: 3d20 2244 6173 6b3a 2054 6173 6b20 4772  = "Dask: Task Gr
+00026910: 6f75 7073 2047 7261 7068 220a 2020 2020  oups Graph".    
+00026920: 7467 5f67 7261 7068 2e75 7064 6174 6528  tg_graph.update(
+00026930: 290a 2020 2020 6164 645f 7065 7269 6f64  ).    add_period
+00026940: 6963 5f63 616c 6c62 6163 6b28 646f 632c  ic_callback(doc,
+00026950: 2074 675f 6772 6170 682c 2032 3030 290a   tg_graph, 200).
+00026960: 2020 2020 646f 632e 6164 645f 726f 6f74      doc.add_root
+00026970: 2874 675f 6772 6170 682e 726f 6f74 290a  (tg_graph.root).
+00026980: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
+00026990: 203d 2065 6e76 2e67 6574 5f74 656d 706c   = env.get_templ
+000269a0: 6174 6528 2273 696d 706c 652e 6874 6d6c  ate("simple.html
+000269b0: 2229 0a20 2020 2064 6f63 2e74 656d 706c  ").    doc.templ
+000269c0: 6174 655f 7661 7269 6162 6c65 732e 7570  ate_variables.up
+000269d0: 6461 7465 2865 7874 7261 290a 2020 2020  date(extra).    
+000269e0: 646f 632e 7468 656d 6520 3d20 424f 4b45  doc.theme = BOKE
+000269f0: 485f 5448 454d 450a 0a0a 406c 6f67 5f65  H_THEME...@log_e
+00026a00: 7272 6f72 730a 6465 6620 7374 6174 7573  rrors.def status
+00026a10: 5f64 6f63 2873 6368 6564 756c 6572 2c20  _doc(scheduler, 
+00026a20: 6578 7472 612c 2064 6f63 293a 0a20 2020  extra, doc):.   
+00026a30: 2063 6c75 7374 6572 5f6d 656d 6f72 7920   cluster_memory 
+00026a40: 3d20 436c 7573 7465 724d 656d 6f72 7928  = ClusterMemory(
+00026a50: 7363 6865 6475 6c65 722c 2073 697a 696e  scheduler, sizin
+00026a60: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+00026a70: 626f 7468 2229 0a20 2020 2063 6c75 7374  both").    clust
+00026a80: 6572 5f6d 656d 6f72 792e 7570 6461 7465  er_memory.update
+00026a90: 2829 0a20 2020 2061 6464 5f70 6572 696f  ().    add_perio
+00026aa0: 6469 635f 6361 6c6c 6261 636b 2864 6f63  dic_callback(doc
+00026ab0: 2c20 636c 7573 7465 725f 6d65 6d6f 7279  , cluster_memory
+00026ac0: 2c20 3130 3029 0a20 2020 2064 6f63 2e61  , 100).    doc.a
+00026ad0: 6464 5f72 6f6f 7428 636c 7573 7465 725f  dd_root(cluster_
+00026ae0: 6d65 6d6f 7279 2e72 6f6f 7429 0a0a 2020  memory.root)..  
+00026af0: 2020 6966 206c 656e 2873 6368 6564 756c    if len(schedul
+00026b00: 6572 2e77 6f72 6b65 7273 2920 3c3d 2031  er.workers) <= 1
+00026b10: 3030 3a0a 2020 2020 2020 2020 776f 726b  00:.        work
+00026b20: 6572 735f 6d65 6d6f 7279 203d 2057 6f72  ers_memory = Wor
+00026b30: 6b65 7273 4d65 6d6f 7279 2873 6368 6564  kersMemory(sched
+00026b40: 756c 6572 2c20 7369 7a69 6e67 5f6d 6f64  uler, sizing_mod
+00026b50: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+00026b60: 290a 0a20 2020 2020 2020 2070 726f 6365  )..        proce
+00026b70: 7373 696e 6720 3d20 4375 7272 656e 744c  ssing = CurrentL
+00026b80: 6f61 6428 7363 6865 6475 6c65 722c 2073  oad(scheduler, s
+00026b90: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
+00026ba0: 7463 685f 626f 7468 2229 0a0a 2020 2020  tch_both")..    
+00026bb0: 2020 2020 7072 6f63 6573 7369 6e67 5f72      processing_r
+00026bc0: 6f6f 7420 3d20 7072 6f63 6573 7369 6e67  oot = processing
+00026bd0: 2e70 726f 6365 7373 696e 675f 6669 6775  .processing_figu
+00026be0: 7265 0a20 2020 2065 6c73 653a 0a20 2020  re.    else:.   
+00026bf0: 2020 2020 2077 6f72 6b65 7273 5f6d 656d       workers_mem
+00026c00: 6f72 7920 3d20 576f 726b 6572 734d 656d  ory = WorkersMem
+00026c10: 6f72 7948 6973 746f 6772 616d 2873 6368  oryHistogram(sch
+00026c20: 6564 756c 6572 2c20 7369 7a69 6e67 5f6d  eduler, sizing_m
+00026c30: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+00026c40: 6822 290a 2020 2020 2020 2020 7072 6f63  h").        proc
+00026c50: 6573 7369 6e67 203d 2050 726f 6365 7373  essing = Process
+00026c60: 696e 6748 6973 746f 6772 616d 2873 6368  ingHistogram(sch
+00026c70: 6564 756c 6572 2c20 7369 7a69 6e67 5f6d  eduler, sizing_m
+00026c80: 6f64 653d 2273 7472 6574 6368 5f62 6f74  ode="stretch_bot
+00026c90: 6822 290a 0a20 2020 2020 2020 2070 726f  h")..        pro
+00026ca0: 6365 7373 696e 675f 726f 6f74 203d 2070  cessing_root = p
+00026cb0: 726f 6365 7373 696e 672e 726f 6f74 0a0a  rocessing.root..
+00026cc0: 2020 2020 6375 7272 656e 745f 6c6f 6164      current_load
+00026cd0: 203d 2043 7572 7265 6e74 4c6f 6164 2873   = CurrentLoad(s
+00026ce0: 6368 6564 756c 6572 2c20 7369 7a69 6e67  cheduler, sizing
+00026cf0: 5f6d 6f64 653d 2273 7472 6574 6368 5f62  _mode="stretch_b
+00026d00: 6f74 6822 290a 2020 2020 6f63 6375 7061  oth").    occupa
+00026d10: 6e63 7920 3d20 4f63 6375 7061 6e63 7928  ncy = Occupancy(
+00026d20: 7363 6865 6475 6c65 722c 2073 697a 696e  scheduler, sizin
+00026d30: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+00026d40: 626f 7468 2229 0a20 2020 2077 6f72 6b65  both").    worke
+00026d50: 7273 5f74 7261 6e73 6665 725f 6279 7465  rs_transfer_byte
+00026d60: 7320 3d20 576f 726b 6572 7354 7261 6e73  s = WorkersTrans
+00026d70: 6665 7242 7974 6573 2873 6368 6564 756c  ferBytes(schedul
+00026d80: 6572 2c20 7369 7a69 6e67 5f6d 6f64 653d  er, sizing_mode=
+00026d90: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
+00026da0: 0a20 2020 2063 7075 5f72 6f6f 7420 3d20  .    cpu_root = 
+00026db0: 6375 7272 656e 745f 6c6f 6164 2e63 7075  current_load.cpu
+00026dc0: 5f66 6967 7572 650a 2020 2020 6f63 6375  _figure.    occu
+00026dd0: 7061 6e63 795f 726f 6f74 203d 206f 6363  pancy_root = occ
+00026de0: 7570 616e 6379 2e72 6f6f 740a 0a20 2020  upancy.root..   
+00026df0: 2077 6f72 6b65 7273 5f6d 656d 6f72 792e   workers_memory.
+00026e00: 7570 6461 7465 2829 0a20 2020 2077 6f72  update().    wor
+00026e10: 6b65 7273 5f74 7261 6e73 6665 725f 6279  kers_transfer_by
+00026e20: 7465 732e 7570 6461 7465 2829 0a20 2020  tes.update().   
+00026e30: 2070 726f 6365 7373 696e 672e 7570 6461   processing.upda
+00026e40: 7465 2829 0a20 2020 2063 7572 7265 6e74  te().    current
+00026e50: 5f6c 6f61 642e 7570 6461 7465 2829 0a20  _load.update(). 
+00026e60: 2020 206f 6363 7570 616e 6379 2e75 7064     occupancy.upd
+00026e70: 6174 6528 290a 0a20 2020 2061 6464 5f70  ate()..    add_p
+00026e80: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00026e90: 2864 6f63 2c20 776f 726b 6572 735f 6d65  (doc, workers_me
+00026ea0: 6d6f 7279 2c20 3130 3029 0a20 2020 2061  mory, 100).    a
+00026eb0: 6464 5f70 6572 696f 6469 635f 6361 6c6c  dd_periodic_call
+00026ec0: 6261 636b 2864 6f63 2c20 776f 726b 6572  back(doc, worker
+00026ed0: 735f 7472 616e 7366 6572 5f62 7974 6573  s_transfer_bytes
+00026ee0: 2c20 3130 3029 0a20 2020 2061 6464 5f70  , 100).    add_p
+00026ef0: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00026f00: 2864 6f63 2c20 7072 6f63 6573 7369 6e67  (doc, processing
+00026f10: 2c20 3130 3029 0a20 2020 2061 6464 5f70  , 100).    add_p
+00026f20: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00026f30: 2864 6f63 2c20 6375 7272 656e 745f 6c6f  (doc, current_lo
+00026f40: 6164 2c20 3130 3029 0a20 2020 2061 6464  ad, 100).    add
+00026f50: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+00026f60: 636b 2864 6f63 2c20 6f63 6375 7061 6e63  ck(doc, occupanc
+00026f70: 792c 2031 3030 290a 0a20 2020 2064 6f63  y, 100)..    doc
+00026f80: 2e61 6464 5f72 6f6f 7428 776f 726b 6572  .add_root(worker
+00026f90: 735f 6d65 6d6f 7279 2e72 6f6f 7429 0a0a  s_memory.root)..
+00026fa0: 2020 2020 7461 6273 203d 205b 0a20 2020      tabs = [.   
+00026fb0: 2020 2020 2054 6162 5061 6e65 6c28 6368       TabPanel(ch
+00026fc0: 696c 643d 7072 6f63 6573 7369 6e67 5f72  ild=processing_r
+00026fd0: 6f6f 742c 2074 6974 6c65 3d22 5072 6f63  oot, title="Proc
+00026fe0: 6573 7369 6e67 2229 2c0a 2020 2020 2020  essing"),.      
+00026ff0: 2020 5461 6250 616e 656c 2863 6869 6c64    TabPanel(child
+00027000: 3d63 7075 5f72 6f6f 742c 2074 6974 6c65  =cpu_root, title
+00027010: 3d22 4350 5522 292c 0a20 2020 2020 2020  ="CPU"),.       
+00027020: 2054 6162 5061 6e65 6c28 6368 696c 643d   TabPanel(child=
+00027030: 6f63 6375 7061 6e63 795f 726f 6f74 2c20  occupancy_root, 
+00027040: 7469 746c 653d 224f 6363 7570 616e 6379  title="Occupancy
+00027050: 2229 2c0a 2020 2020 2020 2020 5461 6250  "),.        TabP
+00027060: 616e 656c 2863 6869 6c64 3d77 6f72 6b65  anel(child=worke
+00027070: 7273 5f74 7261 6e73 6665 725f 6279 7465  rs_transfer_byte
+00027080: 732e 726f 6f74 2c20 7469 746c 653d 2244  s.root, title="D
+00027090: 6174 6120 5472 616e 7366 6572 2229 2c0a  ata Transfer"),.
+000270a0: 2020 2020 5d0a 0a20 2020 2068 656c 705f      ]..    help_
+000270b0: 203d 2048 656c 7054 6f6f 6c28 0a20 2020   = HelpTool(.   
+000270c0: 2020 2020 2072 6564 6972 6563 743d 2268       redirect="h
+000270d0: 7474 7073 3a2f 2f64 6f63 732e 6461 736b  ttps://docs.dask
+000270e0: 2e6f 7267 2f65 6e2f 7374 6162 6c65 2f64  .org/en/stable/d
+000270f0: 6173 6862 6f61 7264 2e68 746d 6c23 7461  ashboard.html#ta
+00027100: 736b 2d70 726f 6365 7373 696e 672d 6370  sk-processing-cp
+00027110: 752d 7574 696c 697a 6174 696f 6e2d 6f63  u-utilization-oc
+00027120: 6375 7061 6e63 792d 6461 7461 2d74 7261  cupancy-data-tra
+00027130: 6e73 6665 7222 2c0a 2020 2020 2020 2020  nsfer",.        
+00027140: 6465 7363 7269 7074 696f 6e3d 2241 2064  description="A d
+00027150: 6573 6372 6970 7469 6f6e 206f 6620 5461  escription of Ta
+00027160: 736b 2050 726f 6365 7373 696e 672f 4350  sk Processing/CP
+00027170: 5520 5574 696c 697a 6174 696f 6e2f 4f63  U Utilization/Oc
+00027180: 6375 7061 6e63 7922 2c0a 2020 2020 290a  cupancy",.    ).
+00027190: 2020 2020 666f 7220 7461 6220 696e 2074      for tab in t
+000271a0: 6162 733a 0a20 2020 2020 2020 2074 6162  abs:.        tab
+000271b0: 2e63 6869 6c64 2e74 6f6f 6c62 6172 5f6c  .child.toolbar_l
+000271c0: 6f63 6174 696f 6e20 3d20 2261 626f 7665  ocation = "above
+000271d0: 220a 2020 2020 2020 2020 7461 622e 6368  ".        tab.ch
+000271e0: 696c 642e 6164 645f 746f 6f6c 7328 6865  ild.add_tools(he
+000271f0: 6c70 5f29 0a0a 2020 2020 7072 6f63 5f74  lp_)..    proc_t
+00027200: 6162 7320 3d20 5461 6273 2874 6162 733d  abs = Tabs(tabs=
+00027210: 7461 6273 2c20 6e61 6d65 3d22 7072 6f63  tabs, name="proc
+00027220: 6573 7369 6e67 5f74 6162 7322 2c20 7369  essing_tabs", si
+00027230: 7a69 6e67 5f6d 6f64 653d 2273 7472 6574  zing_mode="stret
+00027240: 6368 5f62 6f74 6822 290a 2020 2020 646f  ch_both").    do
+00027250: 632e 6164 645f 726f 6f74 2870 726f 635f  c.add_root(proc_
+00027260: 7461 6273 290a 0a20 2020 2074 6173 6b5f  tabs)..    task_
+00027270: 7374 7265 616d 203d 2054 6173 6b53 7472  stream = TaskStr
+00027280: 6561 6d28 0a20 2020 2020 2020 2073 6368  eam(.        sch
+00027290: 6564 756c 6572 2c0a 2020 2020 2020 2020  eduler,.        
+000272a0: 6e5f 7265 6374 616e 676c 6573 3d64 6173  n_rectangles=das
+000272b0: 6b2e 636f 6e66 6967 2e67 6574 280a 2020  k.config.get(.  
+000272c0: 2020 2020 2020 2020 2020 2264 6973 7472            "distr
+000272d0: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+000272e0: 2e64 6173 6862 6f61 7264 2e73 7461 7475  .dashboard.statu
+000272f0: 732e 7461 736b 2d73 7472 6561 6d2d 6c65  s.task-stream-le
+00027300: 6e67 7468 220a 2020 2020 2020 2020 292c  ngth".        ),
+00027310: 0a20 2020 2020 2020 2063 6c65 6172 5f69  .        clear_i
+00027320: 6e74 6572 7661 6c3d 2235 7322 2c0a 2020  nterval="5s",.  
+00027330: 2020 2020 2020 7369 7a69 6e67 5f6d 6f64        sizing_mod
+00027340: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+00027350: 2c0a 2020 2020 290a 2020 2020 7461 736b  ,.    ).    task
+00027360: 5f73 7472 6561 6d2e 7570 6461 7465 2829  _stream.update()
+00027370: 0a20 2020 2061 6464 5f70 6572 696f 6469  .    add_periodi
+00027380: 635f 6361 6c6c 6261 636b 2864 6f63 2c20  c_callback(doc, 
+00027390: 7461 736b 5f73 7472 6561 6d2c 2031 3030  task_stream, 100
+000273a0: 290a 2020 2020 646f 632e 6164 645f 726f  ).    doc.add_ro
+000273b0: 6f74 2874 6173 6b5f 7374 7265 616d 2e72  ot(task_stream.r
+000273c0: 6f6f 7429 0a0a 2020 2020 7461 736b 5f70  oot)..    task_p
+000273d0: 726f 6772 6573 7320 3d20 5461 736b 5072  rogress = TaskPr
+000273e0: 6f67 7265 7373 2873 6368 6564 756c 6572  ogress(scheduler
+000273f0: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
+00027400: 7472 6574 6368 5f62 6f74 6822 290a 2020  tretch_both").  
+00027410: 2020 7461 736b 5f70 726f 6772 6573 732e    task_progress.
+00027420: 7570 6461 7465 2829 0a20 2020 2061 6464  update().    add
+00027430: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+00027440: 636b 2864 6f63 2c20 7461 736b 5f70 726f  ck(doc, task_pro
+00027450: 6772 6573 732c 2031 3030 290a 2020 2020  gress, 100).    
+00027460: 646f 632e 6164 645f 726f 6f74 2874 6173  doc.add_root(tas
+00027470: 6b5f 7072 6f67 7265 7373 2e72 6f6f 7429  k_progress.root)
+00027480: 0a0a 2020 2020 646f 632e 7469 746c 6520  ..    doc.title 
+00027490: 3d20 2244 6173 6b3a 2053 7461 7475 7322  = "Dask: Status"
+000274a0: 0a20 2020 2064 6f63 2e74 6865 6d65 203d  .    doc.theme =
+000274b0: 2042 4f4b 4548 5f54 4845 4d45 0a20 2020   BOKEH_THEME.   
+000274c0: 2064 6f63 2e74 656d 706c 6174 6520 3d20   doc.template = 
+000274d0: 656e 762e 6765 745f 7465 6d70 6c61 7465  env.get_template
+000274e0: 2822 7374 6174 7573 2e68 746d 6c22 290a  ("status.html").
+000274f0: 2020 2020 646f 632e 7465 6d70 6c61 7465      doc.template
+00027500: 5f76 6172 6961 626c 6573 2e75 7064 6174  _variables.updat
+00027510: 6528 6578 7472 6129 0a0a 0a40 6c6f 675f  e(extra)...@log_
+00027520: 6572 726f 7273 0a40 6375 7272 790a 6465  errors.@curry.de
+00027530: 6620 696e 6469 7669 6475 616c 5f64 6f63  f individual_doc
+00027540: 2863 6c73 2c20 696e 7465 7276 616c 2c20  (cls, interval, 
+00027550: 7363 6865 6475 6c65 722c 2065 7874 7261  scheduler, extra
+00027560: 2c20 646f 632c 2066 6967 5f61 7474 723d  , doc, fig_attr=
+00027570: 2272 6f6f 7422 2c20 2a2a 6b77 6172 6773  "root", **kwargs
+00027580: 293a 0a20 2020 2023 204e 6f74 653a 2040  ):.    # Note: @
+00027590: 6c6f 675f 6572 726f 7273 2061 6e64 2040  log_errors and @
+000275a0: 6375 7272 7920 6172 6520 6e6f 7420 636f  curry are not co
+000275b0: 6d70 6174 6962 6c65 0a20 2020 2066 6967  mpatible.    fig
+000275c0: 203d 2063 6c73 2873 6368 6564 756c 6572   = cls(scheduler
+000275d0: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
+000275e0: 7472 6574 6368 5f62 6f74 6822 2c20 2a2a  tretch_both", **
+000275f0: 6b77 6172 6773 290a 2020 2020 6669 672e  kwargs).    fig.
+00027600: 7570 6461 7465 2829 0a20 2020 2061 6464  update().    add
+00027610: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+00027620: 636b 2864 6f63 2c20 6669 672c 2069 6e74  ck(doc, fig, int
+00027630: 6572 7661 6c29 0a20 2020 2064 6f63 2e61  erval).    doc.a
+00027640: 6464 5f72 6f6f 7428 6765 7461 7474 7228  dd_root(getattr(
+00027650: 6669 672c 2066 6967 5f61 7474 7229 290a  fig, fig_attr)).
+00027660: 2020 2020 646f 632e 7468 656d 6520 3d20      doc.theme = 
+00027670: 424f 4b45 485f 5448 454d 450a 2020 2020  BOKEH_THEME.    
+00027680: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
+00027690: 6b3a 2022 202b 2066 756e 636e 616d 6528  k: " + funcname(
+000276a0: 636c 7329 0a0a 0a40 6c6f 675f 6572 726f  cls)...@log_erro
+000276b0: 7273 0a64 6566 2069 6e64 6976 6964 7561  rs.def individua
+000276c0: 6c5f 7072 6f66 696c 655f 646f 6328 7363  l_profile_doc(sc
+000276d0: 6865 6475 6c65 722c 2065 7874 7261 2c20  heduler, extra, 
+000276e0: 646f 6329 3a0a 2020 2020 7072 6f66 203d  doc):.    prof =
+000276f0: 2050 726f 6669 6c65 5469 6d65 506c 6f74   ProfileTimePlot
+00027700: 2873 6368 6564 756c 6572 2c20 7369 7a69  (scheduler, sizi
+00027710: 6e67 5f6d 6f64 653d 2273 7472 6574 6368  ng_mode="stretch
+00027720: 5f62 6f74 6822 2c20 646f 633d 646f 6329  _both", doc=doc)
+00027730: 0a20 2020 2064 6f63 2e61 6464 5f72 6f6f  .    doc.add_roo
+00027740: 7428 7072 6f66 2e72 6f6f 7429 0a20 2020  t(prof.root).   
+00027750: 2070 726f 662e 7472 6967 6765 725f 7570   prof.trigger_up
+00027760: 6461 7465 2829 0a20 2020 2064 6f63 2e74  date().    doc.t
+00027770: 6865 6d65 203d 2042 4f4b 4548 5f54 4845  heme = BOKEH_THE
+00027780: 4d45 0a0a 0a40 6c6f 675f 6572 726f 7273  ME...@log_errors
+00027790: 0a64 6566 2069 6e64 6976 6964 7561 6c5f  .def individual_
+000277a0: 7072 6f66 696c 655f 7365 7276 6572 5f64  profile_server_d
+000277b0: 6f63 2873 6368 6564 756c 6572 2c20 6578  oc(scheduler, ex
+000277c0: 7472 612c 2064 6f63 293a 0a20 2020 2070  tra, doc):.    p
+000277d0: 726f 6620 3d20 5072 6f66 696c 6553 6572  rof = ProfileSer
+000277e0: 7665 7228 7363 6865 6475 6c65 722c 2073  ver(scheduler, s
+000277f0: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
+00027800: 7463 685f 626f 7468 222c 2064 6f63 3d64  tch_both", doc=d
+00027810: 6f63 290a 2020 2020 646f 632e 6164 645f  oc).    doc.add_
+00027820: 726f 6f74 2870 726f 662e 726f 6f74 290a  root(prof.root).
+00027830: 2020 2020 7072 6f66 2e74 7269 6767 6572      prof.trigger
+00027840: 5f75 7064 6174 6528 290a 2020 2020 646f  _update().    do
+00027850: 632e 7468 656d 6520 3d20 424f 4b45 485f  c.theme = BOKEH_
+00027860: 5448 454d 450a 0a0a 406c 6f67 5f65 7272  THEME...@log_err
+00027870: 6f72 730a 6465 6620 7072 6f66 696c 655f  ors.def profile_
+00027880: 646f 6328 7363 6865 6475 6c65 722c 2065  doc(scheduler, e
+00027890: 7874 7261 2c20 646f 6329 3a0a 2020 2020  xtra, doc):.    
+000278a0: 646f 632e 7469 746c 6520 3d20 2244 6173  doc.title = "Das
+000278b0: 6b3a 2050 726f 6669 6c65 220a 2020 2020  k: Profile".    
+000278c0: 7072 6f66 203d 2050 726f 6669 6c65 5469  prof = ProfileTi
+000278d0: 6d65 506c 6f74 2873 6368 6564 756c 6572  mePlot(scheduler
+000278e0: 2c20 7369 7a69 6e67 5f6d 6f64 653d 2273  , sizing_mode="s
+000278f0: 7472 6574 6368 5f62 6f74 6822 2c20 646f  tretch_both", do
+00027900: 633d 646f 6329 0a20 2020 2064 6f63 2e61  c=doc).    doc.a
+00027910: 6464 5f72 6f6f 7428 7072 6f66 2e72 6f6f  dd_root(prof.roo
+00027920: 7429 0a20 2020 2064 6f63 2e74 656d 706c  t).    doc.templ
+00027930: 6174 6520 3d20 656e 762e 6765 745f 7465  ate = env.get_te
+00027940: 6d70 6c61 7465 2822 7369 6d70 6c65 2e68  mplate("simple.h
+00027950: 746d 6c22 290a 2020 2020 646f 632e 7465  tml").    doc.te
+00027960: 6d70 6c61 7465 5f76 6172 6961 626c 6573  mplate_variables
+00027970: 2e75 7064 6174 6528 6578 7472 6129 0a20  .update(extra). 
+00027980: 2020 2064 6f63 2e74 6865 6d65 203d 2042     doc.theme = B
+00027990: 4f4b 4548 5f54 4845 4d45 0a0a 2020 2020  OKEH_THEME..    
+000279a0: 7072 6f66 2e74 7269 6767 6572 5f75 7064  prof.trigger_upd
+000279b0: 6174 6528 290a 0a0a 406c 6f67 5f65 7272  ate()...@log_err
+000279c0: 6f72 730a 6465 6620 7072 6f66 696c 655f  ors.def profile_
+000279d0: 7365 7276 6572 5f64 6f63 2873 6368 6564  server_doc(sched
+000279e0: 756c 6572 2c20 6578 7472 612c 2064 6f63  uler, extra, doc
+000279f0: 293a 0a20 2020 2064 6f63 2e74 6974 6c65  ):.    doc.title
+00027a00: 203d 2022 4461 736b 3a20 5072 6f66 696c   = "Dask: Profil
+00027a10: 6520 6f66 2045 7665 6e74 204c 6f6f 7022  e of Event Loop"
+00027a20: 0a20 2020 2070 726f 6620 3d20 5072 6f66  .    prof = Prof
+00027a30: 696c 6553 6572 7665 7228 7363 6865 6475  ileServer(schedu
+00027a40: 6c65 722c 2073 697a 696e 675f 6d6f 6465  ler, sizing_mode
+00027a50: 3d22 7374 7265 7463 685f 626f 7468 222c  ="stretch_both",
+00027a60: 2064 6f63 3d64 6f63 290a 2020 2020 646f   doc=doc).    do
+00027a70: 632e 6164 645f 726f 6f74 2870 726f 662e  c.add_root(prof.
+00027a80: 726f 6f74 290a 2020 2020 646f 632e 7465  root).    doc.te
+00027a90: 6d70 6c61 7465 203d 2065 6e76 2e67 6574  mplate = env.get
+00027aa0: 5f74 656d 706c 6174 6528 2273 696d 706c  _template("simpl
+00027ab0: 652e 6874 6d6c 2229 0a20 2020 2064 6f63  e.html").    doc
+00027ac0: 2e74 656d 706c 6174 655f 7661 7269 6162  .template_variab
+00027ad0: 6c65 732e 7570 6461 7465 2865 7874 7261  les.update(extra
+00027ae0: 290a 2020 2020 646f 632e 7468 656d 6520  ).    doc.theme 
+00027af0: 3d20 424f 4b45 485f 5448 454d 450a 0a20  = BOKEH_THEME.. 
+00027b00: 2020 2070 726f 662e 7472 6967 6765 725f     prof.trigger_
+00027b10: 7570 6461 7465 2829 0a                   update().
```

### Comparing `distributed-2024.3.1/distributed/dashboard/components/shared.py` & `distributed-2024.4.0/distributed/dashboard/components/shared.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/dashboard/components/worker.py` & `distributed-2024.4.0/distributed/dashboard/components/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/dashboard/core.py` & `distributed-2024.4.0/distributed/dashboard/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/dashboard/export_tool.js` & `distributed-2024.4.0/distributed/dashboard/export_tool.js`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/dashboard/export_tool.py` & `distributed-2024.4.0/distributed/dashboard/export_tool.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/dashboard/scheduler.py` & `distributed-2024.4.0/distributed/dashboard/scheduler.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/dashboard/utils.py` & `distributed-2024.4.0/distributed/dashboard/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/dashboard/worker.py` & `distributed-2024.4.0/distributed/dashboard/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/deploy/adaptive.py` & `distributed-2024.4.0/distributed/deploy/adaptive.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/deploy/adaptive_core.py` & `distributed-2024.4.0/distributed/deploy/adaptive_core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/deploy/cluster.py` & `distributed-2024.4.0/distributed/deploy/cluster.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/deploy/local.py` & `distributed-2024.4.0/distributed/deploy/local.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/deploy/old_ssh.py` & `distributed-2024.4.0/distributed/deploy/old_ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/deploy/spec.py` & `distributed-2024.4.0/distributed/deploy/spec.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/deploy/ssh.py` & `distributed-2024.4.0/distributed/deploy/ssh.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/deploy/subprocess.py` & `distributed-2024.4.0/distributed/deploy/subprocess.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/deploy/utils.py` & `distributed-2024.4.0/distributed/deploy/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/cluster_dump.py` & `distributed-2024.4.0/distributed/diagnostics/cluster_dump.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/cudf.py` & `distributed-2024.4.0/distributed/diagnostics/cudf.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/eventstream.py` & `distributed-2024.4.0/distributed/diagnostics/eventstream.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/graph_layout.py` & `distributed-2024.4.0/distributed/diagnostics/graph_layout.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/memory_sampler.py` & `distributed-2024.4.0/distributed/diagnostics/memory_sampler.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/memray.py` & `distributed-2024.4.0/distributed/diagnostics/memray.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/nvml.py` & `distributed-2024.4.0/distributed/diagnostics/nvml.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/plugin.py` & `distributed-2024.4.0/distributed/diagnostics/plugin.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/progress.py` & `distributed-2024.4.0/distributed/diagnostics/progress.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/progress_stream.py` & `distributed-2024.4.0/distributed/diagnostics/progress_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/progressbar.py` & `distributed-2024.4.0/distributed/diagnostics/progressbar.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/rmm.py` & `distributed-2024.4.0/distributed/diagnostics/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/task_stream.py` & `distributed-2024.4.0/distributed/diagnostics/task_stream.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diagnostics/websocket.py` & `distributed-2024.4.0/distributed/diagnostics/websocket.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/diskutils.py` & `distributed-2024.4.0/distributed/diskutils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/distributed-schema.yaml` & `distributed-2024.4.0/distributed/distributed-schema.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/distributed.yaml` & `distributed-2024.4.0/distributed/distributed.yaml`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/event.py` & `distributed-2024.4.0/distributed/event.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/exceptions.py` & `distributed-2024.4.0/distributed/exceptions.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/prometheus.py` & `distributed-2024.4.0/distributed/http/prometheus.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/proxy.py` & `distributed-2024.4.0/distributed/http/proxy.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/routing.py` & `distributed-2024.4.0/distributed/http/routing.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/scheduler/api.py` & `distributed-2024.4.0/distributed/http/scheduler/api.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/scheduler/info.py` & `distributed-2024.4.0/distributed/http/scheduler/info.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/scheduler/json.py` & `distributed-2024.4.0/distributed/http/scheduler/json.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/scheduler/missing_bokeh.py` & `distributed-2024.4.0/distributed/http/scheduler/missing_bokeh.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/scheduler/prometheus/core.py` & `distributed-2024.4.0/distributed/http/scheduler/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/scheduler/prometheus/semaphore.py` & `distributed-2024.4.0/distributed/http/scheduler/prometheus/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/scheduler/prometheus/stealing.py` & `distributed-2024.4.0/distributed/http/scheduler/prometheus/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/css/base.css` & `distributed-2024.4.0/distributed/http/static/css/base.css`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/css/individual-cluster-map.css` & `distributed-2024.4.0/distributed/http/static/css/individual-cluster-map.css`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/css/sortable.min.css` & `distributed-2024.4.0/distributed/http/static/css/sortable.min.css`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/css/status.css` & `distributed-2024.4.0/distributed/http/static/css/status.css`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/images/dask-logo.svg` & `distributed-2024.4.0/distributed/http/static/images/dask-logo.svg`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/images/fa-bars.svg` & `distributed-2024.4.0/distributed/http/static/images/fa-bars.svg`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/images/favicon.ico` & `distributed-2024.4.0/distributed/http/static/images/favicon.ico`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/images/jupyter.svg` & `distributed-2024.4.0/distributed/http/static/images/jupyter.svg`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/images/numpy.png` & `distributed-2024.4.0/distributed/http/static/images/numpy.png`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/images/pandas.png` & `distributed-2024.4.0/distributed/http/static/images/pandas.png`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/images/python.png` & `distributed-2024.4.0/distributed/http/static/images/python.png`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/individual-cluster-map.html` & `distributed-2024.4.0/distributed/http/static/individual-cluster-map.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/js/anime.min.js` & `distributed-2024.4.0/distributed/http/static/js/anime.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/js/individual-cluster-map.js` & `distributed-2024.4.0/distributed/http/static/js/individual-cluster-map.js`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/js/reconnecting-websocket.min.js` & `distributed-2024.4.0/distributed/http/static/js/reconnecting-websocket.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/static/js/sortable.min.js` & `distributed-2024.4.0/distributed/http/static/js/sortable.min.js`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/templates/base.html` & `distributed-2024.4.0/distributed/http/templates/base.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/templates/exceptions.html` & `distributed-2024.4.0/distributed/http/templates/exceptions.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/templates/main.html` & `distributed-2024.4.0/distributed/http/templates/main.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/templates/status.html` & `distributed-2024.4.0/distributed/http/templates/status.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/templates/task.html` & `distributed-2024.4.0/distributed/http/templates/task.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/templates/worker-table.html` & `distributed-2024.4.0/distributed/http/templates/worker-table.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/templates/worker.html` & `distributed-2024.4.0/distributed/http/templates/worker.html`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/utils.py` & `distributed-2024.4.0/distributed/http/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/http/worker/prometheus/core.py` & `distributed-2024.4.0/distributed/http/worker/prometheus/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/itertools.py` & `distributed-2024.4.0/distributed/itertools.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/lock.py` & `distributed-2024.4.0/distributed/lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/metrics.py` & `distributed-2024.4.0/distributed/metrics.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/multi_lock.py` & `distributed-2024.4.0/distributed/multi_lock.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/nanny.py` & `distributed-2024.4.0/distributed/nanny.py`

 * *Files 0% similar despite different names*

```diff
@@ -847,14 +847,15 @@
         # Therefore wait for it to be properly started before killing it
         if self.status == Status.starting:
             await self.running.wait()
 
         assert self.status in (
             Status.running,
             Status.failed,  # process failed to start, but hasn't been joined yet
+            Status.closing_gracefully,
         ), self.status
         self.status = Status.stopping
         logger.info("Nanny asking worker to close. Reason: %s", reason)
 
         process = self.process
         wait_timeout = timeout * 0.8
         self.child_stop_q.put(
```

### Comparing `distributed-2024.3.1/distributed/node.py` & `distributed-2024.4.0/distributed/node.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/objects.py` & `distributed-2024.4.0/distributed/objects.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/preloading.py` & `distributed-2024.4.0/distributed/preloading.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/process.py` & `distributed-2024.4.0/distributed/process.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/proctitle.py` & `distributed-2024.4.0/distributed/proctitle.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/profile.py` & `distributed-2024.4.0/distributed/profile.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/__init__.py` & `distributed-2024.4.0/distributed/protocol/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/arrow.py` & `distributed-2024.4.0/distributed/protocol/arrow.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/compression.py` & `distributed-2024.4.0/distributed/protocol/compression.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/core.py` & `distributed-2024.4.0/distributed/protocol/core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/cuda.py` & `distributed-2024.4.0/distributed/protocol/cuda.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/cupy.py` & `distributed-2024.4.0/distributed/protocol/cupy.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/h5py.py` & `distributed-2024.4.0/distributed/protocol/h5py.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/keras.py` & `distributed-2024.4.0/distributed/protocol/keras.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/netcdf4.py` & `distributed-2024.4.0/distributed/protocol/netcdf4.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/numba.py` & `distributed-2024.4.0/distributed/protocol/numba.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/numpy.py` & `distributed-2024.4.0/distributed/protocol/numpy.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/pickle.py` & `distributed-2024.4.0/distributed/protocol/pickle.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/rmm.py` & `distributed-2024.4.0/distributed/protocol/rmm.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/scipy.py` & `distributed-2024.4.0/distributed/protocol/scipy.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/serialize.py` & `distributed-2024.4.0/distributed/protocol/serialize.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/sparse.py` & `distributed-2024.4.0/distributed/protocol/sparse.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/torch.py` & `distributed-2024.4.0/distributed/protocol/torch.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/utils.py` & `distributed-2024.4.0/distributed/protocol/utils.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/protocol/utils_test.py` & `distributed-2024.4.0/distributed/protocol/utils_test.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/publish.py` & `distributed-2024.4.0/distributed/publish.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/pubsub.py` & `distributed-2024.4.0/distributed/pubsub.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/queues.py` & `distributed-2024.4.0/distributed/queues.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/recreate_tasks.py` & `distributed-2024.4.0/distributed/recreate_tasks.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/scheduler.py` & `distributed-2024.4.0/distributed/scheduler.py`

 * *Files 2% similar despite different names*

```diff
@@ -145,20120 +145,20313 @@
 00000900: 656e 7369 6f6e 0a66 726f 6d20 6469 7374  ension.from dist
 00000910: 7269 6275 7465 642e 6874 7470 2069 6d70  ributed.http imp
 00000920: 6f72 7420 6765 745f 6861 6e64 6c65 7273  ort get_handlers
 00000930: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
 00000940: 642e 6c6f 636b 2069 6d70 6f72 7420 4c6f  d.lock import Lo
 00000950: 636b 4578 7465 6e73 696f 6e0a 6672 6f6d  ckExtension.from
 00000960: 2064 6973 7472 6962 7574 6564 2e6d 6574   distributed.met
-00000970: 7269 6373 2069 6d70 6f72 7420 6d6f 6e6f  rics import mono
-00000980: 746f 6e69 632c 2074 696d 650a 6672 6f6d  tonic, time.from
-00000990: 2064 6973 7472 6962 7574 6564 2e6d 756c   distributed.mul
-000009a0: 7469 5f6c 6f63 6b20 696d 706f 7274 204d  ti_lock import M
-000009b0: 756c 7469 4c6f 636b 4578 7465 6e73 696f  ultiLockExtensio
-000009c0: 6e0a 6672 6f6d 2064 6973 7472 6962 7574  n.from distribut
-000009d0: 6564 2e6e 6f64 6520 696d 706f 7274 2053  ed.node import S
-000009e0: 6572 7665 724e 6f64 650a 6672 6f6d 2064  erverNode.from d
-000009f0: 6973 7472 6962 7574 6564 2e70 726f 6374  istributed.proct
-00000a00: 6974 6c65 2069 6d70 6f72 7420 7365 7470  itle import setp
-00000a10: 726f 6374 6974 6c65 0a66 726f 6d20 6469  roctitle.from di
-00000a20: 7374 7269 6275 7465 642e 7072 6f74 6f63  stributed.protoc
-00000a30: 6f6c 2069 6d70 6f72 7420 6465 7365 7269  ol import deseri
-00000a40: 616c 697a 650a 6672 6f6d 2064 6973 7472  alize.from distr
-00000a50: 6962 7574 6564 2e70 726f 746f 636f 6c2e  ibuted.protocol.
-00000a60: 7069 636b 6c65 2069 6d70 6f72 7420 6475  pickle import du
-00000a70: 6d70 732c 206c 6f61 6473 0a66 726f 6d20  mps, loads.from 
-00000a80: 6469 7374 7269 6275 7465 642e 7072 6f74  distributed.prot
-00000a90: 6f63 6f6c 2e73 6572 6961 6c69 7a65 2069  ocol.serialize i
-00000aa0: 6d70 6f72 7420 5365 7269 616c 697a 6564  mport Serialized
-00000ab0: 2c20 546f 5069 636b 6c65 2c20 7365 7269  , ToPickle, seri
-00000ac0: 616c 697a 650a 6672 6f6d 2064 6973 7472  alize.from distr
-00000ad0: 6962 7574 6564 2e70 7562 6c69 7368 2069  ibuted.publish i
-00000ae0: 6d70 6f72 7420 5075 626c 6973 6845 7874  mport PublishExt
-00000af0: 656e 7369 6f6e 0a66 726f 6d20 6469 7374  ension.from dist
-00000b00: 7269 6275 7465 642e 7075 6273 7562 2069  ributed.pubsub i
-00000b10: 6d70 6f72 7420 5075 6253 7562 5363 6865  mport PubSubSche
-00000b20: 6475 6c65 7245 7874 656e 7369 6f6e 0a66  dulerExtension.f
-00000b30: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-00000b40: 7175 6575 6573 2069 6d70 6f72 7420 5175  queues import Qu
-00000b50: 6575 6545 7874 656e 7369 6f6e 0a66 726f  eueExtension.fro
-00000b60: 6d20 6469 7374 7269 6275 7465 642e 7265  m distributed.re
-00000b70: 6372 6561 7465 5f74 6173 6b73 2069 6d70  create_tasks imp
-00000b80: 6f72 7420 5265 706c 6179 5461 736b 5363  ort ReplayTaskSc
-00000b90: 6865 6475 6c65 720a 6672 6f6d 2064 6973  heduler.from dis
-00000ba0: 7472 6962 7574 6564 2e73 6563 7572 6974  tributed.securit
-00000bb0: 7920 696d 706f 7274 2053 6563 7572 6974  y import Securit
-00000bc0: 790a 6672 6f6d 2064 6973 7472 6962 7574  y.from distribut
-00000bd0: 6564 2e73 656d 6170 686f 7265 2069 6d70  ed.semaphore imp
-00000be0: 6f72 7420 5365 6d61 7068 6f72 6545 7874  ort SemaphoreExt
-00000bf0: 656e 7369 6f6e 0a66 726f 6d20 6469 7374  ension.from dist
-00000c00: 7269 6275 7465 642e 7368 7566 666c 6520  ributed.shuffle 
-00000c10: 696d 706f 7274 2053 6875 6666 6c65 5363  import ShuffleSc
-00000c20: 6865 6475 6c65 7250 6c75 6769 6e0a 6672  hedulerPlugin.fr
-00000c30: 6f6d 2064 6973 7472 6962 7574 6564 2e73  om distributed.s
-00000c40: 7061 6e73 2069 6d70 6f72 7420 5370 616e  pans import Span
-00000c50: 7353 6368 6564 756c 6572 4578 7465 6e73  sSchedulerExtens
-00000c60: 696f 6e0a 6672 6f6d 2064 6973 7472 6962  ion.from distrib
-00000c70: 7574 6564 2e73 7465 616c 696e 6720 696d  uted.stealing im
-00000c80: 706f 7274 2057 6f72 6b53 7465 616c 696e  port WorkStealin
-00000c90: 670a 6672 6f6d 2064 6973 7472 6962 7574  g.from distribut
-00000ca0: 6564 2e75 7469 6c73 2069 6d70 6f72 7420  ed.utils import 
-00000cb0: 280a 2020 2020 416c 6c2c 0a20 2020 2054  (.    All,.    T
-00000cc0: 696d 656f 7574 4572 726f 722c 0a20 2020  imeoutError,.   
-00000cd0: 2066 6f72 6d61 745f 6461 7368 626f 6172   format_dashboar
-00000ce0: 645f 6c69 6e6b 2c0a 2020 2020 6765 745f  d_link,.    get_
-00000cf0: 6669 6c65 6e6f 5f6c 696d 6974 2c0a 2020  fileno_limit,.  
-00000d00: 2020 6973 5f70 7974 686f 6e5f 7368 7574    is_python_shut
-00000d10: 7469 6e67 5f64 6f77 6e2c 0a20 2020 206b  ting_down,.    k
-00000d20: 6579 5f73 706c 6974 5f67 726f 7570 2c0a  ey_split_group,.
-00000d30: 2020 2020 6c6f 675f 6572 726f 7273 2c0a      log_errors,.
-00000d40: 2020 2020 6f66 666c 6f61 642c 0a20 2020      offload,.   
-00000d50: 2072 6563 7572 7369 7665 5f74 6f5f 6469   recursive_to_di
-00000d60: 6374 2c0a 2020 2020 7761 6974 5f66 6f72  ct,.    wait_for
-00000d70: 2c0a 290a 6672 6f6d 2064 6973 7472 6962  ,.).from distrib
-00000d80: 7574 6564 2e75 7469 6c73 5f63 6f6d 6d20  uted.utils_comm 
-00000d90: 696d 706f 7274 2028 0a20 2020 2067 6174  import (.    gat
-00000da0: 6865 725f 6672 6f6d 5f77 6f72 6b65 7273  her_from_workers
-00000db0: 2c0a 2020 2020 7265 7472 795f 6f70 6572  ,.    retry_oper
-00000dc0: 6174 696f 6e2c 0a20 2020 2073 6361 7474  ation,.    scatt
-00000dd0: 6572 5f74 6f5f 776f 726b 6572 732c 0a20  er_to_workers,. 
-00000de0: 2020 2075 6e70 6163 6b5f 7265 6d6f 7465     unpack_remote
-00000df0: 6461 7461 2c0a 290a 6672 6f6d 2064 6973  data,.).from dis
-00000e00: 7472 6962 7574 6564 2e75 7469 6c73 5f70  tributed.utils_p
-00000e10: 6572 6620 696d 706f 7274 2064 6973 6162  erf import disab
-00000e20: 6c65 5f67 635f 6469 6167 6e6f 7369 732c  le_gc_diagnosis,
-00000e30: 2065 6e61 626c 655f 6763 5f64 6961 676e   enable_gc_diagn
-00000e40: 6f73 6973 0a66 726f 6d20 6469 7374 7269  osis.from distri
-00000e50: 6275 7465 642e 7661 7269 6162 6c65 2069  buted.variable i
-00000e60: 6d70 6f72 7420 5661 7269 6162 6c65 4578  mport VariableEx
-00000e70: 7465 6e73 696f 6e0a 6672 6f6d 2064 6973  tension.from dis
-00000e80: 7472 6962 7574 6564 2e77 6f72 6b65 7220  tributed.worker 
-00000e90: 696d 706f 7274 205f 6e6f 726d 616c 697a  import _normaliz
-00000ea0: 655f 7461 736b 0a0a 6966 2054 5950 455f  e_task..if TYPE_
-00000eb0: 4348 4543 4b49 4e47 3a0a 2020 2020 2320  CHECKING:.    # 
-00000ec0: 544f 444f 2069 6d70 6f72 7420 6672 6f6d  TODO import from
-00000ed0: 2074 7970 696e 6720 2872 6571 7569 7265   typing (require
-00000ee0: 7320 5079 7468 6f6e 203e 3d33 2e31 3029  s Python >=3.10)
-00000ef0: 0a20 2020 2023 2054 4f44 4f20 696d 706f  .    # TODO impo
-00000f00: 7274 2066 726f 6d20 7479 7069 6e67 2028  rt from typing (
-00000f10: 7265 7175 6972 6573 2050 7974 686f 6e20  requires Python 
-00000f20: 3e3d 332e 3131 290a 2020 2020 6672 6f6d  >=3.11).    from
-00000f30: 2074 7970 696e 675f 6578 7465 6e73 696f   typing_extensio
-00000f40: 6e73 2069 6d70 6f72 7420 5365 6c66 2c20  ns import Self, 
-00000f50: 5479 7065 416c 6961 730a 0a20 2020 2066  TypeAlias..    f
-00000f60: 726f 6d20 6461 736b 2e68 6967 686c 6576  rom dask.highlev
-00000f70: 656c 6772 6170 6820 696d 706f 7274 2048  elgraph import H
-00000f80: 6967 684c 6576 656c 4772 6170 680a 0a23  ighLevelGraph..#
-00000f90: 204e 6f74 2074 6f20 6265 2063 6f6e 6675   Not to be confu
-00000fa0: 7365 6420 7769 7468 2064 6973 7472 6962  sed with distrib
-00000fb0: 7574 6564 2e77 6f72 6b65 725f 7374 6174  uted.worker_stat
-00000fc0: 655f 6d61 6368 696e 652e 5461 736b 5374  e_machine.TaskSt
-00000fd0: 6174 6553 7461 7465 0a54 6173 6b53 7461  ateState.TaskSta
-00000fe0: 7465 5374 6174 653a 2054 7970 6541 6c69  teState: TypeAli
-00000ff0: 6173 203d 204c 6974 6572 616c 5b0a 2020  as = Literal[.  
-00001000: 2020 2272 656c 6561 7365 6422 2c0a 2020    "released",.  
-00001010: 2020 2277 6169 7469 6e67 222c 0a20 2020    "waiting",.   
-00001020: 2022 6e6f 2d77 6f72 6b65 7222 2c0a 2020   "no-worker",.  
-00001030: 2020 2271 7565 7565 6422 2c0a 2020 2020    "queued",.    
-00001040: 2270 726f 6365 7373 696e 6722 2c0a 2020  "processing",.  
-00001050: 2020 226d 656d 6f72 7922 2c0a 2020 2020    "memory",.    
-00001060: 2265 7272 6564 222c 0a20 2020 2022 666f  "erred",.    "fo
-00001070: 7267 6f74 7465 6e22 2c0a 5d0a 0a41 4c4c  rgotten",.]..ALL
-00001080: 5f54 4153 4b5f 5354 4154 4553 3a20 5365  _TASK_STATES: Se
-00001090: 745b 5461 736b 5374 6174 6553 7461 7465  t[TaskStateState
-000010a0: 5d20 3d20 7365 7428 5461 736b 5374 6174  ] = set(TaskStat
-000010b0: 6553 7461 7465 2e5f 5f61 7267 735f 5f29  eState.__args__)
-000010c0: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-000010d0: 0a0a 2320 7b74 6173 6b20 6b65 7920 2d3e  ..# {task key ->
-000010e0: 2066 696e 6973 6820 7374 6174 657d 0a23   finish state}.#
-000010f0: 204e 6f74 2074 6f20 6265 2063 6f6e 6675   Not to be confu
-00001100: 7365 6420 7769 7468 2064 6973 7472 6962  sed with distrib
-00001110: 7574 6564 2e77 6f72 6b65 725f 7374 6174  uted.worker_stat
-00001120: 655f 6d61 6368 696e 652e 5265 6373 0a52  e_machine.Recs.R
-00001130: 6563 733a 2054 7970 6541 6c69 6173 203d  ecs: TypeAlias =
-00001140: 2064 6963 745b 4b65 792c 2054 6173 6b53   dict[Key, TaskS
-00001150: 7461 7465 5374 6174 655d 0a23 207b 636c  tateState].# {cl
-00001160: 6965 6e74 206f 7220 776f 726b 6572 2061  ient or worker a
-00001170: 6464 7265 7373 3a20 5b7b 6f70 3a20 3c6b  ddress: [{op: <k
-00001180: 6579 3e2c 202e 2e2e 7d2c 202e 2e2e 5d7d  ey>, ...}, ...]}
-00001190: 0a4d 7367 733a 2054 7970 6541 6c69 6173  .Msgs: TypeAlias
-000011a0: 203d 2064 6963 745b 7374 722c 206c 6973   = dict[str, lis
-000011b0: 745b 6469 6374 5b73 7472 2c20 416e 795d  t[dict[str, Any]
-000011c0: 5d5d 0a23 2028 7265 636f 6d6d 656e 6461  ]].# (recommenda
-000011d0: 7469 6f6e 732c 2063 6c69 656e 7420 6d65  tions, client me
-000011e0: 7373 6167 6573 2c20 776f 726b 6572 206d  ssages, worker m
-000011f0: 6573 7361 6765 7329 0a52 6563 734d 7367  essages).RecsMsg
-00001200: 733a 2054 7970 6541 6c69 6173 203d 2074  s: TypeAlias = t
-00001210: 7570 6c65 5b52 6563 732c 204d 7367 732c  uple[Recs, Msgs,
-00001220: 204d 7367 735d 0a0a 545f 7275 6e73 7065   Msgs]..T_runspe
-00001230: 633a 2054 7970 6541 6c69 6173 203d 2074  c: TypeAlias = t
-00001240: 7570 6c65 5b43 616c 6c61 626c 652c 2074  uple[Callable, t
-00001250: 7570 6c65 2c20 6469 6374 5b73 7472 2c20  uple, dict[str, 
-00001260: 416e 795d 5d0a 0a6c 6f67 6765 7220 3d20  Any]]..logger = 
-00001270: 6c6f 6767 696e 672e 6765 744c 6f67 6765  logging.getLogge
-00001280: 7228 5f5f 6e61 6d65 5f5f 290a 4c4f 475f  r(__name__).LOG_
-00001290: 5044 4220 3d20 6461 736b 2e63 6f6e 6669  PDB = dask.confi
-000012a0: 672e 6765 7428 2264 6973 7472 6962 7574  g.get("distribut
-000012b0: 6564 2e61 646d 696e 2e70 6462 2d6f 6e2d  ed.admin.pdb-on-
-000012c0: 6572 7222 290a 4445 4641 554c 545f 4441  err").DEFAULT_DA
-000012d0: 5441 5f53 495a 4520 3d20 7061 7273 655f  TA_SIZE = parse_
-000012e0: 6279 7465 7328 0a20 2020 2064 6173 6b2e  bytes(.    dask.
-000012f0: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-00001300: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-00001310: 722e 6465 6661 756c 742d 6461 7461 2d73  r.default-data-s
-00001320: 697a 6522 290a 290a 5354 494d 554c 5553  ize").).STIMULUS
-00001330: 5f49 445f 554e 5345 5420 3d20 223c 7374  _ID_UNSET = "<st
-00001340: 696d 756c 7573 5f69 6420 756e 7365 743e  imulus_id unset>
-00001350: 220a 0a44 4546 4155 4c54 5f45 5854 454e  "..DEFAULT_EXTEN
-00001360: 5349 4f4e 5320 3d20 7b0a 2020 2020 226c  SIONS = {.    "l
-00001370: 6f63 6b73 223a 204c 6f63 6b45 7874 656e  ocks": LockExten
-00001380: 7369 6f6e 2c0a 2020 2020 226d 756c 7469  sion,.    "multi
-00001390: 5f6c 6f63 6b73 223a 204d 756c 7469 4c6f  _locks": MultiLo
-000013a0: 636b 4578 7465 6e73 696f 6e2c 0a20 2020  ckExtension,.   
-000013b0: 2022 7075 626c 6973 6822 3a20 5075 626c   "publish": Publ
-000013c0: 6973 6845 7874 656e 7369 6f6e 2c0a 2020  ishExtension,.  
-000013d0: 2020 2272 6570 6c61 792d 7461 736b 7322    "replay-tasks"
-000013e0: 3a20 5265 706c 6179 5461 736b 5363 6865  : ReplayTaskSche
-000013f0: 6475 6c65 722c 0a20 2020 2022 7175 6575  duler,.    "queu
-00001400: 6573 223a 2051 7565 7565 4578 7465 6e73  es": QueueExtens
-00001410: 696f 6e2c 0a20 2020 2022 7661 7269 6162  ion,.    "variab
-00001420: 6c65 7322 3a20 5661 7269 6162 6c65 4578  les": VariableEx
-00001430: 7465 6e73 696f 6e2c 0a20 2020 2022 7075  tension,.    "pu
-00001440: 6273 7562 223a 2050 7562 5375 6253 6368  bsub": PubSubSch
-00001450: 6564 756c 6572 4578 7465 6e73 696f 6e2c  edulerExtension,
-00001460: 0a20 2020 2022 7365 6d61 7068 6f72 6573  .    "semaphores
-00001470: 223a 2053 656d 6170 686f 7265 4578 7465  ": SemaphoreExte
-00001480: 6e73 696f 6e2c 0a20 2020 2022 6576 656e  nsion,.    "even
-00001490: 7473 223a 2045 7665 6e74 4578 7465 6e73  ts": EventExtens
-000014a0: 696f 6e2c 0a20 2020 2022 616d 6d22 3a20  ion,.    "amm": 
-000014b0: 4163 7469 7665 4d65 6d6f 7279 4d61 6e61  ActiveMemoryMana
-000014c0: 6765 7245 7874 656e 7369 6f6e 2c0a 2020  gerExtension,.  
-000014d0: 2020 226d 656d 6f72 795f 7361 6d70 6c65    "memory_sample
-000014e0: 7222 3a20 4d65 6d6f 7279 5361 6d70 6c65  r": MemorySample
-000014f0: 7245 7874 656e 7369 6f6e 2c0a 2020 2020  rExtension,.    
-00001500: 2273 6875 6666 6c65 223a 2053 6875 6666  "shuffle": Shuff
-00001510: 6c65 5363 6865 6475 6c65 7250 6c75 6769  leSchedulerPlugi
-00001520: 6e2c 0a20 2020 2022 7370 616e 7322 3a20  n,.    "spans": 
-00001530: 5370 616e 7353 6368 6564 756c 6572 4578  SpansSchedulerEx
-00001540: 7465 6e73 696f 6e2c 0a20 2020 2022 7374  tension,.    "st
-00001550: 6561 6c69 6e67 223a 2057 6f72 6b53 7465  ealing": WorkSte
-00001560: 616c 696e 672c 0a7d 0a0a 0a63 6c61 7373  aling,.}...class
-00001570: 2043 6c69 656e 7453 7461 7465 3a0a 2020   ClientState:.  
-00001580: 2020 2222 2241 2073 696d 706c 6520 6f62    """A simple ob
-00001590: 6a65 6374 2068 6f6c 6469 6e67 2069 6e66  ject holding inf
-000015a0: 6f72 6d61 7469 6f6e 2061 626f 7574 2061  ormation about a
-000015b0: 2063 6c69 656e 742e 2222 220a 0a20 2020   client."""..   
-000015c0: 2023 3a20 4120 756e 6971 7565 2069 6465   #: A unique ide
-000015d0: 6e74 6966 6965 7220 666f 7220 7468 6973  ntifier for this
-000015e0: 2063 6c69 656e 742e 2054 6869 7320 6973   client. This is
-000015f0: 2067 656e 6572 616c 6c79 2061 6e20 6f70   generally an op
-00001600: 6171 7565 0a20 2020 2023 3a20 7374 7269  aque.    #: stri
-00001610: 6e67 2067 656e 6572 6174 6564 2062 7920  ng generated by 
-00001620: 7468 6520 636c 6965 6e74 2069 7473 656c  the client itsel
-00001630: 662e 0a20 2020 2063 6c69 656e 745f 6b65  f..    client_ke
-00001640: 793a 2073 7472 0a0a 2020 2020 233a 2043  y: str..    #: C
-00001650: 6163 6865 6420 6861 7368 206f 6620 3a61  ached hash of :a
-00001660: 7474 723a 607e 436c 6965 6e74 5374 6174  ttr:`~ClientStat
-00001670: 652e 636c 6965 6e74 5f6b 6579 600a 2020  e.client_key`.  
-00001680: 2020 5f68 6173 683a 2069 6e74 0a0a 2020    _hash: int..  
-00001690: 2020 233a 2041 2073 6574 206f 6620 7461    #: A set of ta
-000016a0: 736b 7320 7468 6973 2063 6c69 656e 7420  sks this client 
-000016b0: 7761 6e74 7320 746f 2062 6520 6b65 7074  wants to be kept
-000016c0: 2069 6e20 6d65 6d6f 7279 2c20 736f 2074   in memory, so t
-000016d0: 6861 7420 6974 2063 616e 2064 6f77 6e6c  hat it can downl
-000016e0: 6f61 640a 2020 2020 233a 2069 7473 2072  oad.    #: its r
-000016f0: 6573 756c 7420 7768 656e 2064 6573 6972  esult when desir
-00001700: 6564 2e20 5468 6973 2069 7320 7468 6520  ed. This is the 
-00001710: 7265 7665 7273 6520 6d61 7070 696e 6720  reverse mapping 
-00001720: 6f66 0a20 2020 2023 3a20 3a63 6c61 7373  of.    #: :class
-00001730: 3a60 5461 736b 5374 6174 652e 7768 6f5f  :`TaskState.who_
-00001740: 7761 6e74 7360 2e20 5461 736b 7320 6172  wants`. Tasks ar
-00001750: 6520 7479 7069 6361 6c6c 7920 7265 6d6f  e typically remo
-00001760: 7665 6420 6672 6f6d 2074 6869 7320 7365  ved from this se
-00001770: 7420 7768 656e 2074 6865 0a20 2020 2023  t when the.    #
-00001780: 3a20 636f 7272 6573 706f 6e64 696e 6720  : corresponding 
-00001790: 6f62 6a65 6374 2069 6e20 7468 6520 636c  object in the cl
-000017a0: 6965 6e74 2773 2073 7061 6365 2028 666f  ient's space (fo
-000017b0: 7220 6578 616d 706c 6520 6120 6060 4675  r example a ``Fu
-000017c0: 7475 7265 6060 206f 7220 6120 4461 736b  ture`` or a Dask
-000017d0: 0a20 2020 2023 3a20 636f 6c6c 6563 7469  .    #: collecti
-000017e0: 6f6e 2920 6765 7473 2067 6172 6261 6765  on) gets garbage
-000017f0: 2d63 6f6c 6c65 6374 6564 2e0a 2020 2020  -collected..    
-00001800: 7761 6e74 735f 7768 6174 3a20 7365 745b  wants_what: set[
-00001810: 5461 736b 5374 6174 655d 0a0a 2020 2020  TaskState]..    
-00001820: 233a 2054 6865 206c 6173 7420 7469 6d65  #: The last time
-00001830: 2077 6520 7265 6365 6976 6564 2061 2068   we received a h
-00001840: 6561 7274 6265 6174 2066 726f 6d20 7468  eartbeat from th
-00001850: 6973 2063 6c69 656e 742c 2069 6e20 6c6f  is client, in lo
-00001860: 6361 6c20 7363 6865 6475 6c65 7220 7469  cal scheduler ti
-00001870: 6d65 2e0a 2020 2020 6c61 7374 5f73 6565  me..    last_see
-00001880: 6e3a 2066 6c6f 6174 0a0a 2020 2020 233a  n: float..    #:
-00001890: 204f 7574 7075 7420 6f66 203a 6675 6e63   Output of :func
-000018a0: 3a60 6469 7374 7269 6275 7465 642e 7665  :`distributed.ve
-000018b0: 7273 696f 6e73 2e67 6574 5f76 6572 7369  rsions.get_versi
-000018c0: 6f6e 7360 206f 6e20 7468 6520 636c 6965  ons` on the clie
-000018d0: 6e74 0a20 2020 2076 6572 7369 6f6e 733a  nt.    versions:
-000018e0: 2064 6963 745b 7374 722c 2041 6e79 5d0a   dict[str, Any].
-000018f0: 0a20 2020 205f 5f73 6c6f 7473 5f5f 203d  .    __slots__ =
-00001900: 2074 7570 6c65 285f 5f61 6e6e 6f74 6174   tuple(__annotat
-00001910: 696f 6e73 5f5f 290a 0a20 2020 2064 6566  ions__)..    def
-00001920: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
-00001930: 636c 6965 6e74 3a20 7374 722c 202a 2c20  client: str, *, 
-00001940: 7665 7273 696f 6e73 3a20 6469 6374 5b73  versions: dict[s
-00001950: 7472 2c20 416e 795d 207c 204e 6f6e 6520  tr, Any] | None 
-00001960: 3d20 4e6f 6e65 293a 0a20 2020 2020 2020  = None):.       
-00001970: 2073 656c 662e 636c 6965 6e74 5f6b 6579   self.client_key
-00001980: 203d 2063 6c69 656e 740a 2020 2020 2020   = client.      
-00001990: 2020 7365 6c66 2e5f 6861 7368 203d 2068    self._hash = h
-000019a0: 6173 6828 636c 6965 6e74 290a 2020 2020  ash(client).    
-000019b0: 2020 2020 7365 6c66 2e77 616e 7473 5f77      self.wants_w
-000019c0: 6861 7420 3d20 7365 7428 290a 2020 2020  hat = set().    
-000019d0: 2020 2020 7365 6c66 2e6c 6173 745f 7365      self.last_se
-000019e0: 656e 203d 2074 696d 6528 290a 2020 2020  en = time().    
-000019f0: 2020 2020 7365 6c66 2e76 6572 7369 6f6e      self.version
-00001a00: 7320 3d20 7665 7273 696f 6e73 206f 7220  s = versions or 
-00001a10: 7b7d 0a0a 2020 2020 6465 6620 5f5f 6861  {}..    def __ha
-00001a20: 7368 5f5f 2873 656c 6629 202d 3e20 696e  sh__(self) -> in
-00001a30: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
-00001a40: 6e20 7365 6c66 2e5f 6861 7368 0a0a 2020  n self._hash..  
-00001a50: 2020 6465 6620 5f5f 6571 5f5f 2873 656c    def __eq__(sel
-00001a60: 662c 206f 7468 6572 3a20 6f62 6a65 6374  f, other: object
-00001a70: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-00001a80: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-00001a90: 616e 6365 286f 7468 6572 2c20 436c 6965  ance(other, Clie
-00001aa0: 6e74 5374 6174 6529 3a0a 2020 2020 2020  ntState):.      
-00001ab0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-00001ac0: 7365 0a20 2020 2020 2020 2072 6574 7572  se.        retur
-00001ad0: 6e20 7365 6c66 2e63 6c69 656e 745f 6b65  n self.client_ke
-00001ae0: 7920 3d3d 206f 7468 6572 2e63 6c69 656e  y == other.clien
-00001af0: 745f 6b65 790a 0a20 2020 2064 6566 205f  t_key..    def _
-00001b00: 5f72 6570 725f 5f28 7365 6c66 2920 2d3e  _repr__(self) ->
-00001b10: 2073 7472 3a0a 2020 2020 2020 2020 7265   str:.        re
-00001b20: 7475 726e 2066 223c 436c 6965 6e74 207b  turn f"<Client {
-00001b30: 7365 6c66 2e63 6c69 656e 745f 6b65 7921  self.client_key!
-00001b40: 727d 3e22 0a0a 2020 2020 6465 6620 5f5f  r}>"..    def __
-00001b50: 7374 725f 5f28 7365 6c66 2920 2d3e 2073  str__(self) -> s
-00001b60: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
-00001b70: 726e 2073 656c 662e 636c 6965 6e74 5f6b  rn self.client_k
-00001b80: 6579 0a0a 2020 2020 6465 6620 5f74 6f5f  ey..    def _to_
-00001b90: 6469 6374 5f6e 6f5f 6e65 7374 2873 656c  dict_no_nest(sel
-00001ba0: 662c 202a 2c20 6578 636c 7564 653a 2043  f, *, exclude: C
-00001bb0: 6f6e 7461 696e 6572 5b73 7472 5d20 3d20  ontainer[str] = 
-00001bc0: 2829 2920 2d3e 2064 6963 743a 0a20 2020  ()) -> dict:.   
-00001bd0: 2020 2020 2022 2222 4469 6374 696f 6e61       """Dictiona
-00001be0: 7279 2072 6570 7265 7365 6e74 6174 696f  ry representatio
-00001bf0: 6e20 666f 7220 6465 6275 6767 696e 6720  n for debugging 
-00001c00: 7075 7270 6f73 6573 2e0a 2020 2020 2020  purposes..      
-00001c10: 2020 4e6f 7420 7479 7065 2073 7461 626c    Not type stabl
-00001c20: 6520 616e 6420 6e6f 7420 696e 7465 6e64  e and not intend
-00001c30: 6564 2066 6f72 2072 6f75 6e64 7472 6970  ed for roundtrip
-00001c40: 732e 0a0a 2020 2020 2020 2020 5365 6520  s...        See 
-00001c50: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
-00001c60: 2d2d 2d2d 2d0a 2020 2020 2020 2020 436c  -----.        Cl
-00001c70: 6965 6e74 2e64 756d 705f 636c 7573 7465  ient.dump_cluste
-00001c80: 725f 7374 6174 650a 2020 2020 2020 2020  r_state.        
-00001c90: 6469 7374 7269 6275 7465 642e 7574 696c  distributed.util
-00001ca0: 732e 7265 6375 7273 6976 655f 746f 5f64  s.recursive_to_d
-00001cb0: 6963 740a 2020 2020 2020 2020 5461 736b  ict.        Task
-00001cc0: 5374 6174 652e 5f74 6f5f 6469 6374 0a20  State._to_dict. 
-00001cd0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00001ce0: 2020 2072 6574 7572 6e20 7265 6375 7273     return recurs
-00001cf0: 6976 655f 746f 5f64 6963 7428 0a20 2020  ive_to_dict(.   
-00001d00: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
-00001d10: 2020 2020 2020 2020 2020 2065 7863 6c75             exclu
-00001d20: 6465 3d73 6574 2865 7863 6c75 6465 2920  de=set(exclude) 
-00001d30: 7c20 7b22 7665 7273 696f 6e73 227d 2c20  | {"versions"}, 
-00001d40: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-00001d50: 2020 2020 2020 2020 2020 2020 6d65 6d62              memb
-00001d60: 6572 733d 5472 7565 2c0a 2020 2020 2020  ers=True,.      
-00001d70: 2020 290a 0a0a 636c 6173 7320 4d65 6d6f    )...class Memo
-00001d80: 7279 5374 6174 653a 0a20 2020 2022 2222  ryState:.    """
-00001d90: 4d65 6d6f 7279 2072 6561 6469 6e67 7320  Memory readings 
-00001da0: 6f6e 2061 2077 6f72 6b65 7220 6f72 206f  on a worker or o
-00001db0: 6e20 7468 6520 7768 6f6c 6520 636c 7573  n the whole clus
-00001dc0: 7465 722e 0a0a 2020 2020 5365 6520 3a64  ter...    See :d
-00001dd0: 6f63 3a60 776f 726b 6572 2d6d 656d 6f72  oc:`worker-memor
-00001de0: 7960 2e0a 0a20 2020 2041 7474 7269 6275  y`...    Attribu
-00001df0: 7465 7320 2f20 7072 6f70 6572 7469 6573  tes / properties
-00001e00: 3a0a 0a20 2020 206d 616e 6167 6564 5f74  :..    managed_t
-00001e10: 6f74 616c 0a20 2020 2020 2020 2053 756d  otal.        Sum
-00001e20: 206f 6620 7468 6520 6f75 7470 7574 206f   of the output o
-00001e30: 6620 7369 7a65 6f66 2829 2066 6f72 2061  f sizeof() for a
-00001e40: 6c6c 2064 6173 6b20 6b65 7973 2068 656c  ll dask keys hel
-00001e50: 6420 6279 2074 6865 2077 6f72 6b65 7220  d by the worker 
-00001e60: 696e 206d 656d 6f72 792c 0a20 2020 2020  in memory,.     
-00001e70: 2020 2070 6c75 7320 6e75 6d62 6572 206f     plus number o
-00001e80: 6620 6279 7465 7320 7370 696c 6c65 6420  f bytes spilled 
-00001e90: 746f 2064 6973 6b0a 0a20 2020 206d 616e  to disk..    man
-00001ea0: 6167 6564 0a20 2020 2020 2020 2053 756d  aged.        Sum
-00001eb0: 206f 6620 7468 6520 6f75 7470 7574 206f   of the output o
-00001ec0: 6620 7369 7a65 6f66 2829 2066 6f72 2074  f sizeof() for t
-00001ed0: 6865 2064 6173 6b20 6b65 7973 2068 656c  he dask keys hel
-00001ee0: 6420 696e 2052 414d 2e20 4e6f 7465 2074  d in RAM. Note t
-00001ef0: 6861 7420 7468 6973 206d 6179 0a20 2020  hat this may.   
-00001f00: 2020 2020 2062 6520 696e 6163 6375 7261       be inaccura
-00001f10: 7465 2c20 7768 6963 6820 6d61 7920 6361  te, which may ca
-00001f20: 7573 6520 696e 6163 6375 7261 7465 2075  use inaccurate u
-00001f30: 6e6d 616e 6167 6564 206d 656d 6f72 7920  nmanaged memory 
-00001f40: 2873 6565 2062 656c 6f77 292e 0a0a 2020  (see below)...  
-00001f50: 2020 7370 696c 6c65 640a 2020 2020 2020    spilled.      
-00001f60: 2020 4e75 6d62 6572 206f 6620 6279 7465    Number of byte
-00001f70: 7320 2066 6f72 2074 6865 2064 6173 6b20  s  for the dask 
-00001f80: 6b65 7973 2073 7069 6c6c 6564 2074 6f20  keys spilled to 
-00001f90: 7468 6520 6861 7264 2064 7269 7665 2e0a  the hard drive..
-00001fa0: 2020 2020 2020 2020 4e6f 7465 2074 6861          Note tha
-00001fb0: 7420 7468 6973 2069 7320 7468 6520 7369  t this is the si
-00001fc0: 7a65 206f 6e20 6469 736b 3b20 7369 7a65  ze on disk; size
-00001fd0: 2069 6e20 6d65 6d6f 7279 206d 6179 2062   in memory may b
-00001fe0: 6520 6469 6666 6572 656e 7420 6475 6520  e different due 
-00001ff0: 746f 0a20 2020 2020 2020 2063 6f6d 7072  to.        compr
-00002000: 6573 7369 6f6e 2061 6e64 2069 6e61 6363  ession and inacc
-00002010: 7572 6163 6965 7320 696e 2073 697a 656f  uracies in sizeo
-00002020: 6628 292e 2049 6e20 6f74 6865 7220 776f  f(). In other wo
-00002030: 7264 732c 2067 6976 656e 2074 6865 2073  rds, given the s
-00002040: 616d 6520 6b65 7973 2c0a 2020 2020 2020  ame keys,.      
-00002050: 2020 276d 616e 6167 6564 2720 7769 6c6c    'managed' will
-00002060: 2063 6861 6e67 6520 6465 7065 6e64 696e   change dependin
-00002070: 6720 6f6e 2074 6865 206b 6579 7320 6265  g on the keys be
-00002080: 696e 6720 696e 206d 656d 6f72 7920 6f72  ing in memory or
-00002090: 2073 7069 6c6c 6564 2e0a 0a20 2020 2070   spilled...    p
-000020a0: 726f 6365 7373 0a20 2020 2020 2020 2054  rocess.        T
-000020b0: 6f74 616c 2052 5353 206d 656d 6f72 7920  otal RSS memory 
-000020c0: 6d65 6173 7572 6564 2062 7920 7468 6520  measured by the 
-000020d0: 4f53 206f 6e20 7468 6520 776f 726b 6572  OS on the worker
-000020e0: 2070 726f 6365 7373 2e0a 2020 2020 2020   process..      
-000020f0: 2020 5468 6973 2069 7320 616c 7761 7973    This is always
-00002100: 2065 7861 6374 6c79 2065 7175 616c 2074   exactly equal t
-00002110: 6f20 6d61 6e61 6765 6420 2b20 756e 6d61  o managed + unma
-00002120: 6e61 6765 642e 0a0a 2020 2020 756e 6d61  naged...    unma
-00002130: 6e61 6765 640a 2020 2020 2020 2020 7072  naged.        pr
-00002140: 6f63 6573 7320 2d20 6d61 6e61 6765 642e  ocess - managed.
-00002150: 2054 6869 7320 6973 2074 6865 2073 756d   This is the sum
-00002160: 206f 660a 0a20 2020 2020 2020 202d 2050   of..        - P
-00002170: 7974 686f 6e20 696e 7465 7270 7265 7465  ython interprete
-00002180: 7220 616e 6420 6d6f 6475 6c65 730a 2020  r and modules.  
-00002190: 2020 2020 2020 2d20 676c 6f62 616c 2076        - global v
-000021a0: 6172 6961 626c 6573 0a20 2020 2020 2020  ariables.       
-000021b0: 202d 206d 656d 6f72 7920 7465 6d70 6f72   - memory tempor
-000021c0: 6172 696c 7920 616c 6c6f 6361 7465 6420  arily allocated 
-000021d0: 6279 2074 6865 2064 6173 6b20 7461 736b  by the dask task
-000021e0: 7320 7468 6174 2061 7265 2063 7572 7265  s that are curre
-000021f0: 6e74 6c79 2072 756e 6e69 6e67 0a20 2020  ntly running.   
-00002200: 2020 2020 202d 206d 656d 6f72 7920 6672       - memory fr
-00002210: 6167 6d65 6e74 6174 696f 6e0a 2020 2020  agmentation.    
-00002220: 2020 2020 2d20 6d65 6d6f 7279 206c 6561      - memory lea
-00002230: 6b73 0a20 2020 2020 2020 202d 206d 656d  ks.        - mem
-00002240: 6f72 7920 6e6f 7420 7965 7420 6761 7262  ory not yet garb
-00002250: 6167 6520 636f 6c6c 6563 7465 640a 2020  age collected.  
-00002260: 2020 2020 2020 2d20 6d65 6d6f 7279 206e        - memory n
-00002270: 6f74 2079 6574 2066 7265 6528 2927 6420  ot yet free()'d 
-00002280: 6279 2074 6865 2050 7974 686f 6e20 6d65  by the Python me
-00002290: 6d6f 7279 206d 616e 6167 6572 2074 6f20  mory manager to 
-000022a0: 7468 6520 4f53 0a0a 2020 2020 756e 6d61  the OS..    unma
-000022b0: 6e61 6765 645f 6f6c 640a 2020 2020 2020  naged_old.      
-000022c0: 2020 4d69 6e69 6d75 6d20 6f66 2074 6865    Minimum of the
-000022d0: 2027 756e 6d61 6e61 6765 6427 206d 6561   'unmanaged' mea
-000022e0: 7375 7265 7320 6f76 6572 2074 6865 206c  sures over the l
-000022f0: 6173 740a 2020 2020 2020 2020 6060 6469  ast.        ``di
-00002300: 7374 7269 6275 7465 642e 6d65 6d6f 7279  stributed.memory
-00002310: 2e72 6563 656e 742d 746f 2d6f 6c64 2d74  .recent-to-old-t
-00002320: 696d 6560 6020 7365 636f 6e64 730a 0a20  ime`` seconds.. 
-00002330: 2020 2075 6e6d 616e 6167 6564 5f72 6563     unmanaged_rec
-00002340: 656e 740a 2020 2020 2020 2020 756e 6d61  ent.        unma
-00002350: 6e61 6765 6420 2d20 756e 6d61 6e61 6765  naged - unmanage
-00002360: 645f 6f6c 643b 2069 6e20 6f74 6865 7220  d_old; in other 
-00002370: 776f 7264 7320 7072 6f63 6573 7320 6d65  words process me
-00002380: 6d6f 7279 2074 6861 7420 6861 7320 6265  mory that has be
-00002390: 656e 2072 6563 656e 746c 790a 2020 2020  en recently.    
-000023a0: 2020 2020 616c 6c6f 6361 7465 6420 6275      allocated bu
-000023b0: 7420 6973 206e 6f74 2061 6363 6f75 6e74  t is not account
-000023c0: 6564 2066 6f72 2062 7920 6461 736b 3b20  ed for by dask; 
-000023d0: 686f 7065 6675 6c6c 7920 6974 2773 206d  hopefully it's m
-000023e0: 6f73 746c 7920 6120 7465 6d70 6f72 6172  ostly a temporar
-000023f0: 790a 2020 2020 2020 2020 7370 696b 652e  y.        spike.
-00002400: 0a0a 2020 2020 6f70 7469 6d69 7374 6963  ..    optimistic
-00002410: 0a20 2020 2020 2020 206d 616e 6167 6564  .        managed
-00002420: 202b 2075 6e6d 616e 6167 6564 5f6f 6c64   + unmanaged_old
-00002430: 3b20 696e 206f 7468 6572 2077 6f72 6473  ; in other words
-00002440: 2074 6865 206d 656d 6f72 7920 6865 6c64   the memory held
-00002450: 206c 6f6e 672d 7465 726d 2062 790a 2020   long-term by.  
-00002460: 2020 2020 2020 7468 6520 7072 6f63 6573        the proces
-00002470: 7320 756e 6465 7220 7468 6520 686f 7065  s under the hope
-00002480: 6675 6c20 6173 7375 6d70 7469 6f6e 2074  ful assumption t
-00002490: 6861 7420 616c 6c20 756e 6d61 6e61 6765  hat all unmanage
-000024a0: 645f 7265 6365 6e74 206d 656d 6f72 7920  d_recent memory 
-000024b0: 6973 2061 0a20 2020 2020 2020 2074 656d  is a.        tem
-000024c0: 706f 7261 7279 2073 7069 6b65 0a20 2020  porary spike.   
-000024d0: 2022 2222 0a0a 2020 2020 7072 6f63 6573   """..    proces
-000024e0: 733a 2069 6e74 0a20 2020 2075 6e6d 616e  s: int.    unman
-000024f0: 6167 6564 5f6f 6c64 3a20 696e 740a 2020  aged_old: int.  
-00002500: 2020 6d61 6e61 6765 643a 2069 6e74 0a20    managed: int. 
-00002510: 2020 2073 7069 6c6c 6564 3a20 696e 740a     spilled: int.
-00002520: 0a20 2020 205f 5f73 6c6f 7473 5f5f 203d  .    __slots__ =
-00002530: 2074 7570 6c65 285f 5f61 6e6e 6f74 6174   tuple(__annotat
-00002540: 696f 6e73 5f5f 290a 0a20 2020 2064 6566  ions__)..    def
-00002550: 205f 5f69 6e69 745f 5f28 0a20 2020 2020   __init__(.     
-00002560: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00002570: 202a 2c0a 2020 2020 2020 2020 7072 6f63   *,.        proc
-00002580: 6573 733a 2069 6e74 2c0a 2020 2020 2020  ess: int,.      
-00002590: 2020 756e 6d61 6e61 6765 645f 6f6c 643a    unmanaged_old:
-000025a0: 2069 6e74 2c0a 2020 2020 2020 2020 6d61   int,.        ma
-000025b0: 6e61 6765 643a 2069 6e74 2c0a 2020 2020  naged: int,.    
-000025c0: 2020 2020 7370 696c 6c65 643a 2069 6e74      spilled: int
-000025d0: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
-000025e0: 2023 2053 6f6d 6520 6461 7461 2061 7272   # Some data arr
-000025f0: 6976 6573 2077 6974 6820 7468 6520 6865  ives with the he
-00002600: 6172 7462 6561 742c 2073 6f6d 6520 6f74  artbeat, some ot
-00002610: 6865 7220 6172 7269 7665 7320 696e 2072  her arrives in r
-00002620: 6561 6c74 696d 6520 6173 2074 6865 0a20  ealtime as the. 
-00002630: 2020 2020 2020 2023 2074 6173 6b73 2070         # tasks p
-00002640: 726f 6772 6573 732e 2041 6c73 6f2c 2073  rogress. Also, s
-00002650: 697a 656f 6628 2920 6973 206e 6f74 2067  izeof() is not g
-00002660: 7561 7261 6e74 6565 6420 746f 2072 6574  uaranteed to ret
-00002670: 7572 6e20 636f 7272 6563 7420 7265 7375  urn correct resu
-00002680: 6c74 732e 0a20 2020 2020 2020 2023 2054  lts..        # T
-00002690: 6869 7320 6361 6e20 6361 7573 6520 676c  his can cause gl
-000026a0: 6974 6368 6573 2077 6865 7265 2061 2070  itches where a p
-000026b0: 6172 7469 616c 206d 6561 7375 7265 2069  artial measure i
-000026c0: 7320 6c61 7267 6572 2074 6861 6e20 7468  s larger than th
-000026d0: 6520 7768 6f6c 652c 2073 6f0a 2020 2020  e whole, so.    
-000026e0: 2020 2020 2320 7765 206e 6565 6420 746f      # we need to
-000026f0: 2066 6f72 6365 2061 6c6c 206e 756d 6265   force all numbe
-00002700: 7273 2074 6f20 6164 6420 7570 2065 7861  rs to add up exa
-00002710: 6374 6c79 2062 7920 6465 6669 6e69 7469  ctly by definiti
-00002720: 6f6e 2e0a 2020 2020 2020 2020 7365 6c66  on..        self
-00002730: 2e70 726f 6365 7373 203d 2070 726f 6365  .process = proce
-00002740: 7373 0a20 2020 2020 2020 2073 656c 662e  ss.        self.
-00002750: 6d61 6e61 6765 6420 3d20 6d69 6e28 7365  managed = min(se
-00002760: 6c66 2e70 726f 6365 7373 2c20 6d61 6e61  lf.process, mana
-00002770: 6765 6429 0a20 2020 2020 2020 2073 656c  ged).        sel
-00002780: 662e 7370 696c 6c65 6420 3d20 7370 696c  f.spilled = spil
-00002790: 6c65 640a 2020 2020 2020 2020 2320 5375  led.        # Su
-000027a0: 6274 7261 6374 696f 6e73 2062 6574 7765  btractions betwe
-000027b0: 656e 2075 6e73 6967 6e65 6420 696e 7473  en unsigned ints
-000027c0: 2067 7561 7261 6e74 6565 6420 6279 2063   guaranteed by c
-000027d0: 6f6e 7374 7275 6374 696f 6e20 746f 2062  onstruction to b
-000027e0: 6520 3e3d 2030 0a20 2020 2020 2020 2073  e >= 0.        s
-000027f0: 656c 662e 756e 6d61 6e61 6765 645f 6f6c  elf.unmanaged_ol
-00002800: 6420 3d20 6d69 6e28 756e 6d61 6e61 6765  d = min(unmanage
-00002810: 645f 6f6c 642c 2070 726f 6365 7373 202d  d_old, process -
-00002820: 2073 656c 662e 6d61 6e61 6765 6429 0a0a   self.managed)..
-00002830: 2020 2020 4073 7461 7469 636d 6574 686f      @staticmetho
-00002840: 640a 2020 2020 6465 6620 7375 6d28 2a69  d.    def sum(*i
-00002850: 6e66 6f73 3a20 4d65 6d6f 7279 5374 6174  nfos: MemoryStat
-00002860: 6529 202d 3e20 4d65 6d6f 7279 5374 6174  e) -> MemoryStat
-00002870: 653a 0a20 2020 2020 2020 2070 726f 6365  e:.        proce
-00002880: 7373 203d 2030 0a20 2020 2020 2020 2075  ss = 0.        u
-00002890: 6e6d 616e 6167 6564 5f6f 6c64 203d 2030  nmanaged_old = 0
-000028a0: 0a20 2020 2020 2020 206d 616e 6167 6564  .        managed
-000028b0: 203d 2030 0a20 2020 2020 2020 2073 7069   = 0.        spi
-000028c0: 6c6c 6564 203d 2030 0a20 2020 2020 2020  lled = 0.       
-000028d0: 2066 6f72 206d 7320 696e 2069 6e66 6f73   for ms in infos
-000028e0: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
-000028f0: 6f63 6573 7320 2b3d 206d 732e 7072 6f63  ocess += ms.proc
-00002900: 6573 730a 2020 2020 2020 2020 2020 2020  ess.            
-00002910: 756e 6d61 6e61 6765 645f 6f6c 6420 2b3d  unmanaged_old +=
-00002920: 206d 732e 756e 6d61 6e61 6765 645f 6f6c   ms.unmanaged_ol
-00002930: 640a 2020 2020 2020 2020 2020 2020 7370  d.            sp
-00002940: 696c 6c65 6420 2b3d 206d 732e 7370 696c  illed += ms.spil
-00002950: 6c65 640a 2020 2020 2020 2020 2020 2020  led.            
-00002960: 6d61 6e61 6765 6420 2b3d 206d 732e 6d61  managed += ms.ma
-00002970: 6e61 6765 640a 2020 2020 2020 2020 7265  naged.        re
-00002980: 7475 726e 204d 656d 6f72 7953 7461 7465  turn MemoryState
-00002990: 280a 2020 2020 2020 2020 2020 2020 7072  (.            pr
-000029a0: 6f63 6573 733d 7072 6f63 6573 732c 0a20  ocess=process,. 
-000029b0: 2020 2020 2020 2020 2020 2075 6e6d 616e             unman
-000029c0: 6167 6564 5f6f 6c64 3d75 6e6d 616e 6167  aged_old=unmanag
-000029d0: 6564 5f6f 6c64 2c0a 2020 2020 2020 2020  ed_old,.        
-000029e0: 2020 2020 6d61 6e61 6765 643d 6d61 6e61      managed=mana
-000029f0: 6765 642c 0a20 2020 2020 2020 2020 2020  ged,.           
-00002a00: 2073 7069 6c6c 6564 3d73 7069 6c6c 6564   spilled=spilled
-00002a10: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
-00002a20: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00002a30: 6566 206d 616e 6167 6564 5f74 6f74 616c  ef managed_total
-00002a40: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
-00002a50: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-00002a60: 6c66 2e6d 616e 6167 6564 202b 2073 656c  lf.managed + sel
-00002a70: 662e 7370 696c 6c65 640a 0a20 2020 2040  f.spilled..    @
-00002a80: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
-00002a90: 2075 6e6d 616e 6167 6564 2873 656c 6629   unmanaged(self)
-00002aa0: 202d 3e20 696e 743a 0a20 2020 2020 2020   -> int:.       
-00002ab0: 2023 2054 6869 7320 6973 206e 6576 6572   # This is never
-00002ac0: 206e 6567 6174 6976 6520 7468 616e 6b73   negative thanks
-00002ad0: 2074 6f20 5f5f 696e 6974 5f5f 0a20 2020   to __init__.   
-00002ae0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00002af0: 2e70 726f 6365 7373 202d 2073 656c 662e  .process - self.
-00002b00: 6d61 6e61 6765 640a 0a20 2020 2040 7072  managed..    @pr
-00002b10: 6f70 6572 7479 0a20 2020 2064 6566 2075  operty.    def u
-00002b20: 6e6d 616e 6167 6564 5f72 6563 656e 7428  nmanaged_recent(
-00002b30: 7365 6c66 2920 2d3e 2069 6e74 3a0a 2020  self) -> int:.  
-00002b40: 2020 2020 2020 2320 5468 6973 2069 7320        # This is 
-00002b50: 6e65 7665 7220 6e65 6761 7469 7665 2074  never negative t
-00002b60: 6861 6e6b 7320 746f 205f 5f69 6e69 745f  hanks to __init_
-00002b70: 5f0a 2020 2020 2020 2020 7265 7475 726e  _.        return
-00002b80: 2073 656c 662e 7072 6f63 6573 7320 2d20   self.process - 
-00002b90: 7365 6c66 2e6d 616e 6167 6564 202d 2073  self.managed - s
-00002ba0: 656c 662e 756e 6d61 6e61 6765 645f 6f6c  elf.unmanaged_ol
-00002bb0: 640a 0a20 2020 2040 7072 6f70 6572 7479  d..    @property
-00002bc0: 0a20 2020 2064 6566 206f 7074 696d 6973  .    def optimis
-00002bd0: 7469 6328 7365 6c66 2920 2d3e 2069 6e74  tic(self) -> int
-00002be0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-00002bf0: 2073 656c 662e 6d61 6e61 6765 6420 2b20   self.managed + 
-00002c00: 7365 6c66 2e75 6e6d 616e 6167 6564 5f6f  self.unmanaged_o
-00002c10: 6c64 0a0a 2020 2020 4070 726f 7065 7274  ld..    @propert
-00002c20: 790a 2020 2020 6465 6620 6d61 6e61 6765  y.    def manage
-00002c30: 645f 696e 5f6d 656d 6f72 7928 7365 6c66  d_in_memory(self
-00002c40: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
-00002c50: 2020 7761 726e 696e 6773 2e77 6172 6e28    warnings.warn(
-00002c60: 226d 616e 6167 6564 5f69 6e5f 6d65 6d6f  "managed_in_memo
-00002c70: 7279 2068 6173 2062 6565 6e20 7265 6e61  ry has been rena
-00002c80: 6d65 6420 746f 206d 616e 6167 6564 222c  med to managed",
-00002c90: 2046 7574 7572 6557 6172 6e69 6e67 290a   FutureWarning).
-00002ca0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00002cb0: 656c 662e 6d61 6e61 6765 640a 0a20 2020  elf.managed..   
-00002cc0: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00002cd0: 6566 206d 616e 6167 6564 5f73 7069 6c6c  ef managed_spill
-00002ce0: 6564 2873 656c 6629 202d 3e20 696e 743a  ed(self) -> int:
-00002cf0: 0a20 2020 2020 2020 2077 6172 6e69 6e67  .        warning
-00002d00: 732e 7761 726e 2822 6d61 6e61 6765 645f  s.warn("managed_
-00002d10: 7370 696c 6c65 6420 6861 7320 6265 656e  spilled has been
-00002d20: 2072 656e 616d 6564 2074 6f20 7370 696c   renamed to spil
-00002d30: 6c65 6422 2c20 4675 7475 7265 5761 726e  led", FutureWarn
-00002d40: 696e 6729 0a20 2020 2020 2020 2072 6574  ing).        ret
-00002d50: 7572 6e20 7365 6c66 2e73 7069 6c6c 6564  urn self.spilled
-00002d60: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
-00002d70: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
-00002d80: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00002d90: 280a 2020 2020 2020 2020 2020 2020 6622  (.            f"
-00002da0: 5072 6f63 6573 7320 6d65 6d6f 7279 2028  Process memory (
-00002db0: 5253 5329 2020 3a20 7b66 6f72 6d61 745f  RSS)  : {format_
-00002dc0: 6279 7465 7328 7365 6c66 2e70 726f 6365  bytes(self.proce
-00002dd0: 7373 297d 5c6e 220a 2020 2020 2020 2020  ss)}\n".        
-00002de0: 2020 2020 6622 2020 2d20 6d61 6e61 6765      f"  - manage
-00002df0: 6420 6279 2044 6173 6b20 2020 3a20 7b66  d by Dask   : {f
-00002e00: 6f72 6d61 745f 6279 7465 7328 7365 6c66  ormat_bytes(self
-00002e10: 2e6d 616e 6167 6564 297d 5c6e 220a 2020  .managed)}\n".  
-00002e20: 2020 2020 2020 2020 2020 6622 2020 2d20            f"  - 
-00002e30: 756e 6d61 6e61 6765 6420 286f 6c64 2920  unmanaged (old) 
-00002e40: 2020 3a20 7b66 6f72 6d61 745f 6279 7465    : {format_byte
-00002e50: 7328 7365 6c66 2e75 6e6d 616e 6167 6564  s(self.unmanaged
-00002e60: 5f6f 6c64 297d 5c6e 220a 2020 2020 2020  _old)}\n".      
-00002e70: 2020 2020 2020 6622 2020 2d20 756e 6d61        f"  - unma
-00002e80: 6e61 6765 6420 2872 6563 656e 7429 3a20  naged (recent): 
-00002e90: 7b66 6f72 6d61 745f 6279 7465 7328 7365  {format_bytes(se
-00002ea0: 6c66 2e75 6e6d 616e 6167 6564 5f72 6563  lf.unmanaged_rec
-00002eb0: 656e 7429 7d5c 6e22 0a20 2020 2020 2020  ent)}\n".       
-00002ec0: 2020 2020 2066 2253 7069 6c6c 6564 2074       f"Spilled t
-00002ed0: 6f20 6469 736b 2020 2020 2020 203a 207b  o disk       : {
-00002ee0: 666f 726d 6174 5f62 7974 6573 2873 656c  format_bytes(sel
-00002ef0: 662e 7370 696c 6c65 6429 7d5c 6e22 0a20  f.spilled)}\n". 
-00002f00: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-00002f10: 6620 5f74 6f5f 6469 6374 2873 656c 662c  f _to_dict(self,
-00002f20: 202a 2c20 6578 636c 7564 653a 2043 6f6e   *, exclude: Con
-00002f30: 7461 696e 6572 5b73 7472 5d20 3d20 2829  tainer[str] = ()
-00002f40: 2920 2d3e 2064 6963 743a 0a20 2020 2020  ) -> dict:.     
-00002f50: 2020 2022 2222 4469 6374 696f 6e61 7279     """Dictionary
-00002f60: 2072 6570 7265 7365 6e74 6174 696f 6e20   representation 
-00002f70: 666f 7220 6465 6275 6767 696e 6720 7075  for debugging pu
-00002f80: 7270 6f73 6573 2e0a 0a20 2020 2020 2020  rposes...       
-00002f90: 2053 6565 2061 6c73 6f0a 2020 2020 2020   See also.      
-00002fa0: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
-00002fb0: 2020 2043 6c69 656e 742e 6475 6d70 5f63     Client.dump_c
-00002fc0: 6c75 7374 6572 5f73 7461 7465 0a20 2020  luster_state.   
-00002fd0: 2020 2020 2064 6973 7472 6962 7574 6564       distributed
-00002fe0: 2e75 7469 6c73 2e72 6563 7572 7369 7665  .utils.recursive
-00002ff0: 5f74 6f5f 6469 6374 0a20 2020 2020 2020  _to_dict.       
-00003000: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-00003010: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
-00003020: 2020 6b3a 2067 6574 6174 7472 2873 656c    k: getattr(sel
-00003030: 662c 206b 290a 2020 2020 2020 2020 2020  f, k).          
-00003040: 2020 666f 7220 6b20 696e 2064 6972 2873    for k in dir(s
-00003050: 656c 6629 0a20 2020 2020 2020 2020 2020  elf).           
-00003060: 2069 6620 6e6f 7420 6b2e 7374 6172 7473   if not k.starts
-00003070: 7769 7468 2822 5f22 290a 2020 2020 2020  with("_").      
-00003080: 2020 2020 2020 616e 6420 6b20 6e6f 7420        and k not 
-00003090: 696e 207b 2273 756d 222c 2022 6d61 6e61  in {"sum", "mana
-000030a0: 6765 645f 696e 5f6d 656d 6f72 7922 2c20  ged_in_memory", 
-000030b0: 226d 616e 6167 6564 5f73 7069 6c6c 6564  "managed_spilled
-000030c0: 227d 0a20 2020 2020 2020 207d 0a0a 0a63  "}.        }...c
-000030d0: 6c61 7373 2057 6f72 6b65 7253 7461 7465  lass WorkerState
-000030e0: 3a0a 2020 2020 2222 2241 2073 696d 706c  :.    """A simpl
-000030f0: 6520 6f62 6a65 6374 2068 6f6c 6469 6e67  e object holding
-00003100: 2069 6e66 6f72 6d61 7469 6f6e 2061 626f   information abo
-00003110: 7574 2061 2077 6f72 6b65 722e 0a0a 2020  ut a worker...  
-00003120: 2020 4e6f 7420 746f 2062 6520 636f 6e66    Not to be conf
-00003130: 7573 6564 2077 6974 6820 3a63 6c61 7373  used with :class
-00003140: 3a60 6469 7374 7269 6275 7465 642e 776f  :`distributed.wo
-00003150: 726b 6572 5f73 7461 7465 5f6d 6163 6869  rker_state_machi
-00003160: 6e65 2e57 6f72 6b65 7253 7461 7465 602e  ne.WorkerState`.
-00003170: 0a20 2020 2022 2222 0a0a 2020 2020 233a  .    """..    #:
-00003180: 2054 6869 7320 776f 726b 6572 2773 2075   This worker's u
-00003190: 6e69 7175 6520 6b65 792e 2054 6869 7320  nique key. This 
-000031a0: 6361 6e20 6265 2069 7473 2063 6f6e 6e65  can be its conne
-000031b0: 6374 6564 2061 6464 7265 7373 0a20 2020  cted address.   
-000031c0: 2023 3a20 2873 7563 6820 6173 2060 6022   #: (such as ``"
-000031d0: 7463 703a 2f2f 3132 372e 302e 302e 313a  tcp://127.0.0.1:
-000031e0: 3838 3931 2260 6029 206f 7220 616e 2061  8891"``) or an a
-000031f0: 6c69 6173 2028 7375 6368 2061 7320 6060  lias (such as ``
-00003200: 2261 6c69 6365 2260 6029 2e0a 2020 2020  "alice"``)..    
-00003210: 6164 6472 6573 733a 2073 7472 0a0a 2020  address: str..  
-00003220: 2020 7069 643a 2069 6e74 0a20 2020 206e    pid: int.    n
-00003230: 616d 653a 2048 6173 6861 626c 650a 0a20  ame: Hashable.. 
-00003240: 2020 2023 3a20 5468 6520 6e75 6d62 6572     #: The number
-00003250: 206f 6620 4350 5520 7468 7265 6164 7320   of CPU threads 
-00003260: 6d61 6465 2061 7661 696c 6162 6c65 206f  made available o
-00003270: 6e20 7468 6973 2077 6f72 6b65 720a 2020  n this worker.  
-00003280: 2020 6e74 6872 6561 6473 3a20 696e 740a    nthreads: int.
-00003290: 0a20 2020 2023 3a20 4d65 6d6f 7279 2061  .    #: Memory a
-000032a0: 7661 696c 6162 6c65 2074 6f20 7468 6520  vailable to the 
-000032b0: 776f 726b 6572 2c20 696e 2062 7974 6573  worker, in bytes
-000032c0: 0a20 2020 206d 656d 6f72 795f 6c69 6d69  .    memory_limi
-000032d0: 743a 2069 6e74 0a0a 2020 2020 6c6f 6361  t: int..    loca
-000032e0: 6c5f 6469 7265 6374 6f72 793a 2073 7472  l_directory: str
-000032f0: 0a20 2020 2073 6572 7669 6365 733a 2064  .    services: d
-00003300: 6963 745b 7374 722c 2069 6e74 5d0a 0a20  ict[str, int].. 
-00003310: 2020 2023 3a20 4f75 7470 7574 206f 6620     #: Output of 
-00003320: 3a6d 6574 683a 6064 6973 7472 6962 7574  :meth:`distribut
-00003330: 6564 2e76 6572 7369 6f6e 732e 6765 745f  ed.versions.get_
-00003340: 7665 7273 696f 6e73 6020 6f6e 2074 6865  versions` on the
-00003350: 2077 6f72 6b65 720a 2020 2020 7665 7273   worker.    vers
-00003360: 696f 6e73 3a20 6469 6374 5b73 7472 2c20  ions: dict[str, 
-00003370: 416e 795d 0a0a 2020 2020 233a 2041 6464  Any]..    #: Add
-00003380: 7265 7373 206f 6620 7468 6520 6173 736f  ress of the asso
-00003390: 6369 6174 6564 203a 636c 6173 733a 607e  ciated :class:`~
-000033a0: 6469 7374 7269 6275 7465 642e 6e61 6e6e  distributed.nann
-000033b0: 792e 4e61 6e6e 7960 2c20 6966 2070 7265  y.Nanny`, if pre
-000033c0: 7365 6e74 0a20 2020 206e 616e 6e79 3a20  sent.    nanny: 
-000033d0: 7374 7220 7c20 4e6f 6e65 0a0a 2020 2020  str | None..    
-000033e0: 233a 2052 6561 642d 6f6e 6c79 2077 6f72  #: Read-only wor
-000033f0: 6b65 7220 7374 6174 7573 2c20 7379 6e63  ker status, sync
-00003400: 6564 206f 6e65 2077 6179 2066 726f 6d20  ed one way from 
-00003410: 7468 6520 7265 6d6f 7465 2057 6f72 6b65  the remote Worke
-00003420: 7220 6f62 6a65 6374 0a20 2020 2073 7461  r object.    sta
-00003430: 7475 733a 2053 7461 7475 730a 0a20 2020  tus: Status..   
-00003440: 2023 3a20 4361 6368 6564 2068 6173 6820   #: Cached hash 
-00003450: 6f66 203a 6174 7472 3a60 7e57 6f72 6b65  of :attr:`~Worke
-00003460: 7253 7461 7465 2e73 6572 7665 725f 6964  rState.server_id
-00003470: 600a 2020 2020 5f68 6173 683a 2069 6e74  `.    _hash: int
-00003480: 0a0a 2020 2020 233a 2054 6865 2074 6f74  ..    #: The tot
-00003490: 616c 206d 656d 6f72 7920 7369 7a65 2c20  al memory size, 
-000034a0: 696e 2062 7974 6573 2c20 7573 6564 2062  in bytes, used b
-000034b0: 7920 7468 6520 7461 736b 7320 7468 6973  y the tasks this
-000034c0: 2077 6f72 6b65 7220 686f 6c64 7320 696e   worker holds in
-000034d0: 206d 656d 6f72 790a 2020 2020 233a 2028   memory.    #: (
-000034e0: 692e 652e 2074 6865 2074 6173 6b73 2069  i.e. the tasks i
-000034f0: 6e20 7468 6973 2077 6f72 6b65 7227 7320  n this worker's 
-00003500: 3a61 7474 723a 607e 576f 726b 6572 5374  :attr:`~WorkerSt
-00003510: 6174 652e 6861 735f 7768 6174 6029 2e0a  ate.has_what`)..
-00003520: 2020 2020 6e62 7974 6573 3a20 696e 740a      nbytes: int.
-00003530: 0a20 2020 2023 3a20 576f 726b 6572 206d  .    #: Worker m
-00003540: 656d 6f72 7920 756e 6b6e 6f77 6e20 746f  emory unknown to
-00003550: 2074 6865 2077 6f72 6b65 722c 2069 6e20   the worker, in 
-00003560: 6279 7465 732c 2077 6869 6368 2068 6173  bytes, which has
-00003570: 2062 6565 6e20 7468 6572 6520 666f 7220   been there for 
-00003580: 6d6f 7265 2074 6861 6e0a 2020 2020 233a  more than.    #:
-00003590: 2033 3020 7365 636f 6e64 732e 2053 6565   30 seconds. See
-000035a0: 203a 636c 6173 733a 604d 656d 6f72 7953   :class:`MemoryS
-000035b0: 7461 7465 602e 0a20 2020 205f 6d65 6d6f  tate`..    _memo
-000035c0: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
-000035d0: 3a20 696e 740a 0a20 2020 2023 3a20 4869  : int..    #: Hi
-000035e0: 7374 6f72 7920 6f66 2074 6865 206c 6173  story of the las
-000035f0: 7420 3330 2073 6563 6f6e 6473 2720 776f  t 30 seconds' wo
-00003600: 7274 6820 6f66 2075 6e6d 616e 6167 6564  rth of unmanaged
-00003610: 206d 656d 6f72 792e 2055 7365 6420 746f   memory. Used to
-00003620: 2064 6966 6665 7265 6e74 6961 7465 0a20   differentiate. 
-00003630: 2020 2023 3a20 6265 7477 6565 6e20 226f     #: between "o
-00003640: 6c64 2220 616e 6420 226e 6577 2220 756e  ld" and "new" un
-00003650: 6d61 6e61 6765 6420 6d65 6d6f 7279 2e0a  managed memory..
-00003660: 2020 2020 233a 2046 6f72 6d61 743a 2060      #: Format: `
-00003670: 605b 2874 696d 6573 7461 6d70 2c20 6279  `[(timestamp, by
-00003680: 7465 7329 2c20 2874 696d 6573 7461 6d70  tes), (timestamp
-00003690: 2c20 6279 7465 7329 2c20 2e2e 2e5d 6060  , bytes), ...]``
-000036a0: 0a20 2020 205f 6d65 6d6f 7279 5f75 6e6d  .    _memory_unm
-000036b0: 616e 6167 6564 5f68 6973 746f 7279 3a20  anaged_history: 
-000036c0: 6465 7175 655b 7475 706c 655b 666c 6f61  deque[tuple[floa
-000036d0: 742c 2069 6e74 5d5d 0a0a 2020 2020 6d65  t, int]]..    me
-000036e0: 7472 6963 733a 2064 6963 745b 7374 722c  trics: dict[str,
-000036f0: 2041 6e79 5d0a 0a20 2020 2023 3a20 5468   Any]..    #: Th
-00003700: 6520 6c61 7374 2074 696d 6520 7765 2072  e last time we r
-00003710: 6563 6569 7665 6420 6120 6865 6172 7462  eceived a heartb
-00003720: 6561 7420 6672 6f6d 2074 6869 7320 776f  eat from this wo
-00003730: 726b 6572 2c20 696e 206c 6f63 616c 2073  rker, in local s
-00003740: 6368 6564 756c 6572 2074 696d 652e 0a20  cheduler time.. 
-00003750: 2020 206c 6173 745f 7365 656e 3a20 666c     last_seen: fl
-00003760: 6f61 740a 0a20 2020 2074 696d 655f 6465  oat..    time_de
-00003770: 6c61 793a 2066 6c6f 6174 0a20 2020 2062  lay: float.    b
-00003780: 616e 6477 6964 7468 3a20 666c 6f61 740a  andwidth: float.
-00003790: 0a20 2020 2023 3a20 4120 7365 7420 6f66  .    #: A set of
-000037a0: 2061 6c6c 2054 6173 6b53 7461 7465 7320   all TaskStates 
-000037b0: 6f6e 2074 6869 7320 776f 726b 6572 2074  on this worker t
-000037c0: 6861 7420 6172 6520 6163 746f 7273 2e20  hat are actors. 
-000037d0: 5468 6973 206f 6e6c 7920 696e 636c 7564  This only includ
-000037e0: 6573 2074 686f 7365 0a20 2020 2023 3a20  es those.    #: 
-000037f0: 6163 746f 7273 2077 686f 7365 2073 7461  actors whose sta
-00003800: 7465 2061 6374 7561 6c6c 7920 6c69 7665  te actually live
-00003810: 7320 6f6e 2074 6869 7320 776f 726b 6572  s on this worker
-00003820: 2c20 6e6f 7420 6163 746f 7273 2074 6f20  , not actors to 
-00003830: 7768 6963 6820 7468 6973 2077 6f72 6b65  which this worke
-00003840: 720a 2020 2020 233a 2068 6173 2061 2072  r.    #: has a r
-00003850: 6566 6572 656e 6365 2e0a 2020 2020 6163  eference..    ac
-00003860: 746f 7273 3a20 7365 745b 5461 736b 5374  tors: set[TaskSt
-00003870: 6174 655d 0a0a 2020 2020 233a 2055 6e64  ate]..    #: Und
-00003880: 6572 6c79 696e 6720 6461 7461 206f 6620  erlying data of 
-00003890: 3a6d 6574 683a 6057 6f72 6b65 7253 7461  :meth:`WorkerSta
-000038a0: 7465 2e68 6173 5f77 6861 7460 0a20 2020  te.has_what`.   
-000038b0: 205f 6861 735f 7768 6174 3a20 6469 6374   _has_what: dict
-000038c0: 5b54 6173 6b53 7461 7465 2c20 4e6f 6e65  [TaskState, None
-000038d0: 5d0a 0a20 2020 2023 3a20 4120 7365 7420  ]..    #: A set 
-000038e0: 6f66 2074 6173 6b73 2074 6861 7420 6861  of tasks that ha
-000038f0: 7665 2062 6565 6e20 7375 626d 6974 7465  ve been submitte
-00003900: 6420 746f 2074 6869 7320 776f 726b 6572  d to this worker
-00003910: 2e20 4d75 6c74 6970 6c65 2074 6173 6b73  . Multiple tasks
-00003920: 206d 6179 2062 650a 2020 2020 2320 7375   may be.    # su
-00003930: 626d 6974 7465 6420 746f 2061 2077 6f72  bmitted to a wor
-00003940: 6b65 7220 696e 2061 6476 616e 6365 2061  ker in advance a
-00003950: 6e64 2074 6865 2077 6f72 6b65 7220 7769  nd the worker wi
-00003960: 6c6c 2072 756e 2074 6865 6d20 6576 656e  ll run them even
-00003970: 7475 616c 6c79 2c0a 2020 2020 2320 6465  tually,.    # de
-00003980: 7065 6e64 696e 6720 6f6e 2069 7473 2065  pending on its e
-00003990: 7865 6375 7469 6f6e 2072 6573 6f75 7263  xecution resourc
-000039a0: 6573 2028 6275 7420 7365 6520 3a64 6f63  es (but see :doc
-000039b0: 3a60 776f 726b 2d73 7465 616c 696e 6760  :`work-stealing`
-000039c0: 292e 0a20 2020 2023 3a0a 2020 2020 233a  )..    #:.    #:
-000039d0: 2041 6c6c 2074 6865 2074 6173 6b73 2068   All the tasks h
-000039e0: 6572 6520 6172 6520 696e 2074 6865 2022  ere are in the "
-000039f0: 7072 6f63 6573 7369 6e67 2220 7374 6174  processing" stat
-00003a00: 652e 0a20 2020 2023 3a20 5468 6973 2061  e..    #: This a
-00003a10: 7474 7269 6275 7465 2069 7320 6b65 7074  ttribute is kept
-00003a20: 2069 6e20 7379 6e63 2077 6974 6820 3a61   in sync with :a
-00003a30: 7474 723a 6054 6173 6b53 7461 7465 2e70  ttr:`TaskState.p
-00003a40: 726f 6365 7373 696e 675f 6f6e 602e 0a20  rocessing_on`.. 
-00003a50: 2020 2070 726f 6365 7373 696e 673a 2073     processing: s
-00003a60: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
-00003a70: 2020 2023 3a20 5275 6e6e 696e 6720 7461     #: Running ta
-00003a80: 736b 7320 7468 6174 2069 6e76 6f6b 6564  sks that invoked
-00003a90: 203a 6675 6e63 3a60 6469 7374 7269 6275   :func:`distribu
-00003aa0: 7465 642e 7365 6365 6465 600a 2020 2020  ted.secede`.    
-00003ab0: 6c6f 6e67 5f72 756e 6e69 6e67 3a20 7365  long_running: se
-00003ac0: 745b 5461 736b 5374 6174 655d 0a0a 2020  t[TaskState]..  
-00003ad0: 2020 233a 2041 2064 6963 7469 6f6e 6172    #: A dictionar
-00003ae0: 7920 6f66 2074 6173 6b73 2074 6861 7420  y of tasks that 
-00003af0: 6172 6520 6375 7272 656e 746c 7920 6265  are currently be
-00003b00: 696e 6720 7275 6e20 6f6e 2074 6869 7320  ing run on this 
-00003b10: 776f 726b 6572 2e0a 2020 2020 233a 2045  worker..    #: E
-00003b20: 6163 6820 7461 736b 2073 7461 7465 2069  ach task state i
-00003b30: 7320 6173 736f 6369 6174 6564 2077 6974  s associated wit
-00003b40: 6820 7468 6520 6475 7261 7469 6f6e 2069  h the duration i
-00003b50: 6e20 7365 636f 6e64 7320 7768 6963 6820  n seconds which 
-00003b60: 7468 6520 7461 736b 2068 6173 0a20 2020  the task has.   
-00003b70: 2023 3a20 6265 656e 2072 756e 6e69 6e67   #: been running
-00003b80: 2e0a 2020 2020 6578 6563 7574 696e 673a  ..    executing:
-00003b90: 2064 6963 745b 5461 736b 5374 6174 652c   dict[TaskState,
-00003ba0: 2066 6c6f 6174 5d0a 0a20 2020 2023 3a20   float]..    #: 
-00003bb0: 5468 6520 6176 6169 6c61 626c 6520 7265  The available re
-00003bc0: 736f 7572 6365 7320 6f6e 2074 6869 7320  sources on this 
-00003bd0: 776f 726b 6572 2c20 652e 672e 2060 607b  worker, e.g. ``{
-00003be0: 2247 5055 223a 2032 7d60 602e 0a20 2020  "GPU": 2}``..   
-00003bf0: 2023 3a20 5468 6573 6520 6172 6520 6162   #: These are ab
-00003c00: 7374 7261 6374 2071 7561 6e74 6974 6965  stract quantitie
-00003c10: 7320 7468 6174 2063 6f6e 7374 7261 696e  s that constrain
-00003c20: 2063 6572 7461 696e 2074 6173 6b73 2066   certain tasks f
-00003c30: 726f 6d20 7275 6e6e 696e 6720 6174 2074  rom running at t
-00003c40: 6865 0a20 2020 2023 3a20 7361 6d65 2074  he.    #: same t
-00003c50: 696d 6520 6f6e 2074 6869 7320 776f 726b  ime on this work
-00003c60: 6572 2e0a 2020 2020 7265 736f 7572 6365  er..    resource
-00003c70: 733a 2064 6963 745b 7374 722c 2066 6c6f  s: dict[str, flo
-00003c80: 6174 5d0a 0a20 2020 2023 3a20 5468 6520  at]..    #: The 
-00003c90: 7375 6d20 6f66 2065 6163 6820 7265 736f  sum of each reso
-00003ca0: 7572 6365 2075 7365 6420 6279 2061 6c6c  urce used by all
-00003cb0: 2074 6173 6b73 2061 6c6c 6f63 6174 6564   tasks allocated
-00003cc0: 2074 6f20 7468 6973 2077 6f72 6b65 722e   to this worker.
-00003cd0: 0a20 2020 2023 3a20 5468 6520 6e75 6d62  .    #: The numb
-00003ce0: 6572 7320 696e 2074 6869 7320 6469 6374  ers in this dict
-00003cf0: 696f 6e61 7279 2063 616e 206f 6e6c 7920  ionary can only 
-00003d00: 6265 206c 6573 7320 6f72 2065 7175 616c  be less or equal
-00003d10: 2074 6861 6e20 7468 6f73 6520 696e 2074   than those in t
-00003d20: 6869 730a 2020 2020 233a 2077 6f72 6b65  his.    #: worke
-00003d30: 7227 7320 3a61 7474 723a 607e 576f 726b  r's :attr:`~Work
-00003d40: 6572 5374 6174 652e 7265 736f 7572 6365  erState.resource
-00003d50: 7360 2e0a 2020 2020 7573 6564 5f72 6573  s`..    used_res
-00003d60: 6f75 7263 6573 3a20 6469 6374 5b73 7472  ources: dict[str
-00003d70: 2c20 666c 6f61 745d 0a0a 2020 2020 233a  , float]..    #:
-00003d80: 2041 7262 6974 7261 7279 2061 6464 6974   Arbitrary addit
-00003d90: 696f 6e61 6c20 6d65 7461 6461 7461 2074  ional metadata t
-00003da0: 6f20 6265 2061 6464 6564 2074 6f20 3a6d  o be added to :m
-00003db0: 6574 683a 607e 576f 726b 6572 5374 6174  eth:`~WorkerStat
-00003dc0: 652e 6964 656e 7469 7479 600a 2020 2020  e.identity`.    
-00003dd0: 6578 7472 613a 2064 6963 745b 7374 722c  extra: dict[str,
-00003de0: 2041 6e79 5d0a 0a20 2020 2023 2054 6865   Any]..    # The
-00003df0: 2075 6e69 7175 6520 7365 7276 6572 2049   unique server I
-00003e00: 4420 7468 6973 2057 6f72 6b65 7253 7461  D this WorkerSta
-00003e10: 7465 2069 7320 7265 6665 7265 6e63 696e  te is referencin
-00003e20: 670a 2020 2020 7365 7276 6572 5f69 643a  g.    server_id:
-00003e30: 2073 7472 0a0a 2020 2020 2320 5265 6665   str..    # Refe
-00003e40: 7265 6e63 6520 746f 2073 6368 6564 756c  rence to schedul
-00003e50: 6572 2074 6173 6b5f 6772 6f75 7073 0a20  er task_groups. 
-00003e60: 2020 2073 6368 6564 756c 6572 5f72 6566     scheduler_ref
-00003e70: 3a20 7765 616b 7265 662e 7265 665b 5363  : weakref.ref[Sc
-00003e80: 6865 6475 6c65 7253 7461 7465 5d20 7c20  hedulerState] | 
-00003e90: 4e6f 6e65 0a20 2020 2074 6173 6b5f 7072  None.    task_pr
-00003ea0: 6566 6978 5f63 6f75 6e74 3a20 6465 6661  efix_count: defa
-00003eb0: 756c 7464 6963 745b 7374 722c 2069 6e74  ultdict[str, int
-00003ec0: 5d0a 2020 2020 5f6e 6574 776f 726b 5f6f  ].    _network_o
-00003ed0: 6363 3a20 666c 6f61 740a 2020 2020 5f6f  cc: float.    _o
-00003ee0: 6363 7570 616e 6379 5f63 6163 6865 3a20  ccupancy_cache: 
-00003ef0: 666c 6f61 7420 7c20 4e6f 6e65 0a0a 2020  float | None..  
-00003f00: 2020 233a 204b 6579 7320 7468 6174 206d    #: Keys that m
-00003f10: 6179 206e 6565 6420 746f 2062 6520 6665  ay need to be fe
-00003f20: 7463 6865 6420 746f 2074 6869 7320 776f  tched to this wo
-00003f30: 726b 6572 2c20 616e 6420 7468 6520 6e75  rker, and the nu
-00003f40: 6d62 6572 206f 6620 7461 736b 7320 7468  mber of tasks th
-00003f50: 6174 206e 6565 6420 7468 656d 2e0a 2020  at need them..  
-00003f60: 2020 233a 2041 6c6c 2074 6173 6b73 2061    #: All tasks a
-00003f70: 7265 2063 7572 7265 6e74 6c79 2069 6e20  re currently in 
-00003f80: 606d 656d 6f72 7960 206f 6e20 6120 776f  `memory` on a wo
-00003f90: 726b 6572 206f 7468 6572 2074 6861 6e20  rker other than 
-00003fa0: 7468 6973 206f 6e65 2e0a 2020 2020 233a  this one..    #:
-00003fb0: 204d 7563 6820 6c69 6b65 2060 7072 6f63   Much like `proc
-00003fc0: 6573 7369 6e67 602c 2074 6869 7320 646f  essing`, this do
-00003fd0: 6573 206e 6f74 2065 7861 6374 6c79 2072  es not exactly r
-00003fe0: 6566 6c65 6374 2077 6f72 6b65 7220 7374  eflect worker st
-00003ff0: 6174 653a 0a20 2020 2023 3a20 6b65 7973  ate:.    #: keys
-00004000: 2068 6572 6520 6d61 7920 6265 2071 7565   here may be que
-00004010: 7565 6420 746f 2066 6574 6368 2c20 696e  ued to fetch, in
-00004020: 2066 6c69 6768 742c 206f 7220 616c 7265   flight, or alre
-00004030: 6164 7920 696e 206d 656d 6f72 790a 2020  ady in memory.  
-00004040: 2020 233a 206f 6e20 7468 6520 776f 726b    #: on the work
-00004050: 6572 2e0a 2020 2020 6e65 6564 735f 7768  er..    needs_wh
-00004060: 6174 3a20 6469 6374 5b54 6173 6b53 7461  at: dict[TaskSta
-00004070: 7465 2c20 696e 745d 0a0a 2020 2020 5f5f  te, int]..    __
-00004080: 736c 6f74 735f 5f20 3d20 7475 706c 6528  slots__ = tuple(
-00004090: 5f5f 616e 6e6f 7461 7469 6f6e 735f 5f29  __annotations__)
-000040a0: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-000040b0: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
-000040c0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
-000040d0: 2020 2020 2061 6464 7265 7373 3a20 7374       address: st
-000040e0: 722c 0a20 2020 2020 2020 2073 7461 7475  r,.        statu
-000040f0: 733a 2053 7461 7475 732c 0a20 2020 2020  s: Status,.     
-00004100: 2020 2070 6964 3a20 696e 742c 0a20 2020     pid: int,.   
-00004110: 2020 2020 206e 616d 653a 206f 626a 6563       name: objec
-00004120: 742c 0a20 2020 2020 2020 206e 7468 7265  t,.        nthre
-00004130: 6164 733a 2069 6e74 203d 2030 2c0a 2020  ads: int = 0,.  
-00004140: 2020 2020 2020 6d65 6d6f 7279 5f6c 696d        memory_lim
-00004150: 6974 3a20 696e 742c 0a20 2020 2020 2020  it: int,.       
-00004160: 206c 6f63 616c 5f64 6972 6563 746f 7279   local_directory
-00004170: 3a20 7374 722c 0a20 2020 2020 2020 206e  : str,.        n
-00004180: 616e 6e79 3a20 7374 7220 7c20 4e6f 6e65  anny: str | None
-00004190: 2c0a 2020 2020 2020 2020 7365 7276 6572  ,.        server
-000041a0: 5f69 643a 2073 7472 2c0a 2020 2020 2020  _id: str,.      
-000041b0: 2020 7365 7276 6963 6573 3a20 6469 6374    services: dict
-000041c0: 5b73 7472 2c20 696e 745d 207c 204e 6f6e  [str, int] | Non
-000041d0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-000041e0: 2020 7665 7273 696f 6e73 3a20 6469 6374    versions: dict
-000041f0: 5b73 7472 2c20 416e 795d 207c 204e 6f6e  [str, Any] | Non
-00004200: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00004210: 2020 6578 7472 613a 2064 6963 745b 7374    extra: dict[st
-00004220: 722c 2041 6e79 5d20 7c20 4e6f 6e65 203d  r, Any] | None =
-00004230: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
-00004240: 6368 6564 756c 6572 3a20 5363 6865 6475  cheduler: Schedu
-00004250: 6c65 7253 7461 7465 207c 204e 6f6e 6520  lerState | None 
-00004260: 3d20 4e6f 6e65 2c0a 2020 2020 293a 0a20  = None,.    ):. 
-00004270: 2020 2020 2020 2073 656c 662e 7365 7276         self.serv
-00004280: 6572 5f69 6420 3d20 7365 7276 6572 5f69  er_id = server_i
-00004290: 640a 2020 2020 2020 2020 7365 6c66 2e61  d.        self.a
-000042a0: 6464 7265 7373 203d 2061 6464 7265 7373  ddress = address
-000042b0: 0a20 2020 2020 2020 2073 656c 662e 7069  .        self.pi
-000042c0: 6420 3d20 7069 640a 2020 2020 2020 2020  d = pid.        
-000042d0: 7365 6c66 2e6e 616d 6520 3d20 6e61 6d65  self.name = name
-000042e0: 0a20 2020 2020 2020 2073 656c 662e 6e74  .        self.nt
-000042f0: 6872 6561 6473 203d 206e 7468 7265 6164  hreads = nthread
-00004300: 730a 2020 2020 2020 2020 7365 6c66 2e6d  s.        self.m
-00004310: 656d 6f72 795f 6c69 6d69 7420 3d20 6d65  emory_limit = me
-00004320: 6d6f 7279 5f6c 696d 6974 0a20 2020 2020  mory_limit.     
-00004330: 2020 2073 656c 662e 6c6f 6361 6c5f 6469     self.local_di
-00004340: 7265 6374 6f72 7920 3d20 6c6f 6361 6c5f  rectory = local_
-00004350: 6469 7265 6374 6f72 790a 2020 2020 2020  directory.      
-00004360: 2020 7365 6c66 2e73 6572 7669 6365 7320    self.services 
-00004370: 3d20 7365 7276 6963 6573 206f 7220 7b7d  = services or {}
-00004380: 0a20 2020 2020 2020 2073 656c 662e 7665  .        self.ve
-00004390: 7273 696f 6e73 203d 2076 6572 7369 6f6e  rsions = version
-000043a0: 7320 6f72 207b 7d0a 2020 2020 2020 2020  s or {}.        
-000043b0: 7365 6c66 2e6e 616e 6e79 203d 206e 616e  self.nanny = nan
-000043c0: 6e79 0a20 2020 2020 2020 2073 656c 662e  ny.        self.
-000043d0: 7374 6174 7573 203d 2073 7461 7475 730a  status = status.
-000043e0: 2020 2020 2020 2020 7365 6c66 2e5f 6861          self._ha
-000043f0: 7368 203d 2068 6173 6828 7365 6c66 2e73  sh = hash(self.s
-00004400: 6572 7665 725f 6964 290a 2020 2020 2020  erver_id).      
-00004410: 2020 7365 6c66 2e6e 6279 7465 7320 3d20    self.nbytes = 
-00004420: 300a 2020 2020 2020 2020 7365 6c66 2e5f  0.        self._
-00004430: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
-00004440: 5f6f 6c64 203d 2030 0a20 2020 2020 2020  _old = 0.       
-00004450: 2073 656c 662e 5f6d 656d 6f72 795f 756e   self._memory_un
-00004460: 6d61 6e61 6765 645f 6869 7374 6f72 7920  managed_history 
-00004470: 3d20 6465 7175 6528 290a 2020 2020 2020  = deque().      
-00004480: 2020 7365 6c66 2e6d 6574 7269 6373 203d    self.metrics =
-00004490: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-000044a0: 2e6c 6173 745f 7365 656e 203d 2030 0a20  .last_seen = 0. 
-000044b0: 2020 2020 2020 2073 656c 662e 7469 6d65         self.time
-000044c0: 5f64 656c 6179 203d 2030 0a20 2020 2020  _delay = 0.     
-000044d0: 2020 2073 656c 662e 6261 6e64 7769 6474     self.bandwidt
-000044e0: 6820 3d20 7061 7273 655f 6279 7465 7328  h = parse_bytes(
-000044f0: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
-00004500: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
-00004510: 6564 756c 6572 2e62 616e 6477 6964 7468  eduler.bandwidth
-00004520: 2229 290a 2020 2020 2020 2020 7365 6c66  ")).        self
-00004530: 2e61 6374 6f72 7320 3d20 7365 7428 290a  .actors = set().
-00004540: 2020 2020 2020 2020 7365 6c66 2e5f 6861          self._ha
-00004550: 735f 7768 6174 203d 207b 7d0a 2020 2020  s_what = {}.    
-00004560: 2020 2020 7365 6c66 2e70 726f 6365 7373      self.process
-00004570: 696e 6720 3d20 7365 7428 290a 2020 2020  ing = set().    
-00004580: 2020 2020 7365 6c66 2e6c 6f6e 675f 7275      self.long_ru
-00004590: 6e6e 696e 6720 3d20 7365 7428 290a 2020  nning = set().  
-000045a0: 2020 2020 2020 7365 6c66 2e65 7865 6375        self.execu
-000045b0: 7469 6e67 203d 207b 7d0a 2020 2020 2020  ting = {}.      
-000045c0: 2020 7365 6c66 2e72 6573 6f75 7263 6573    self.resources
-000045d0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-000045e0: 6c66 2e75 7365 645f 7265 736f 7572 6365  lf.used_resource
-000045f0: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
-00004600: 656c 662e 6578 7472 6120 3d20 6578 7472  elf.extra = extr
-00004610: 6120 6f72 207b 7d0a 2020 2020 2020 2020  a or {}.        
-00004620: 7365 6c66 2e73 6368 6564 756c 6572 5f72  self.scheduler_r
-00004630: 6566 203d 2077 6561 6b72 6566 2e72 6566  ef = weakref.ref
-00004640: 2873 6368 6564 756c 6572 2920 6966 2073  (scheduler) if s
-00004650: 6368 6564 756c 6572 2065 6c73 6520 4e6f  cheduler else No
-00004660: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-00004670: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
-00004680: 7420 3d20 6465 6661 756c 7464 6963 7428  t = defaultdict(
-00004690: 696e 7429 0a20 2020 2020 2020 2073 656c  int).        sel
-000046a0: 662e 6e65 6564 735f 7768 6174 203d 207b  f.needs_what = {
-000046b0: 7d0a 2020 2020 2020 2020 7365 6c66 2e5f  }.        self._
-000046c0: 6e65 7477 6f72 6b5f 6f63 6320 3d20 300a  network_occ = 0.
-000046d0: 2020 2020 2020 2020 7365 6c66 2e5f 6f63          self._oc
-000046e0: 6375 7061 6e63 795f 6361 6368 6520 3d20  cupancy_cache = 
-000046f0: 4e6f 6e65 0a0a 2020 2020 6465 6620 5f5f  None..    def __
-00004700: 6861 7368 5f5f 2873 656c 6629 202d 3e20  hash__(self) -> 
-00004710: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
-00004720: 7572 6e20 7365 6c66 2e5f 6861 7368 0a0a  urn self._hash..
-00004730: 2020 2020 6465 6620 5f5f 6571 5f5f 2873      def __eq__(s
-00004740: 656c 662c 206f 7468 6572 3a20 6f62 6a65  elf, other: obje
-00004750: 6374 2920 2d3e 2062 6f6f 6c3a 0a20 2020  ct) -> bool:.   
-00004760: 2020 2020 2072 6574 7572 6e20 6973 696e       return isin
-00004770: 7374 616e 6365 286f 7468 6572 2c20 576f  stance(other, Wo
-00004780: 726b 6572 5374 6174 6529 2061 6e64 206f  rkerState) and o
-00004790: 7468 6572 2e73 6572 7665 725f 6964 203d  ther.server_id =
-000047a0: 3d20 7365 6c66 2e73 6572 7665 725f 6964  = self.server_id
-000047b0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-000047c0: 2020 2020 6465 6620 6861 735f 7768 6174      def has_what
-000047d0: 2873 656c 6629 202d 3e20 5365 745b 5461  (self) -> Set[Ta
-000047e0: 736b 5374 6174 655d 3a0a 2020 2020 2020  skState]:.      
-000047f0: 2020 2222 2241 6e20 696e 7365 7274 696f    """An insertio
-00004800: 6e2d 736f 7274 6564 2073 6574 2d6c 696b  n-sorted set-lik
-00004810: 6520 6f66 2074 6173 6b73 2077 6869 6368  e of tasks which
-00004820: 2063 7572 7265 6e74 6c79 2072 6573 6964   currently resid
-00004830: 6520 6f6e 2074 6869 7320 776f 726b 6572  e on this worker
-00004840: 2e0a 2020 2020 2020 2020 416c 6c20 7468  ..        All th
-00004850: 6520 7461 736b 7320 6865 7265 2061 7265  e tasks here are
-00004860: 2069 6e20 7468 6520 226d 656d 6f72 7922   in the "memory"
-00004870: 2073 7461 7465 2e0a 2020 2020 2020 2020   state..        
-00004880: 5468 6973 2069 7320 7468 6520 7265 7665  This is the reve
-00004890: 7273 6520 6d61 7070 696e 6720 6f66 203a  rse mapping of :
-000048a0: 6174 7472 3a60 5461 736b 5374 6174 652e  attr:`TaskState.
-000048b0: 7768 6f5f 6861 7360 2e0a 0a20 2020 2020  who_has`...     
-000048c0: 2020 2054 6869 7320 6973 2061 2072 6561     This is a rea
-000048d0: 642d 6f6e 6c79 2070 7562 6c69 6320 6163  d-only public ac
-000048e0: 6365 7373 6f72 2e20 5468 6520 6461 7461  cessor. The data
-000048f0: 2069 7320 696d 706c 656d 656e 7465 6420   is implemented 
-00004900: 6173 2061 2064 6963 7420 7769 7468 6f75  as a dict withou
-00004910: 740a 2020 2020 2020 2020 7661 6c75 6573  t.        values
-00004920: 2c20 6265 6361 7573 6520 7265 6261 6c61  , because rebala
-00004930: 6e63 6528 2920 7265 6c69 6573 206f 6e20  nce() relies on 
-00004940: 6469 6374 7320 6265 696e 6720 696e 7365  dicts being inse
-00004950: 7274 696f 6e2d 736f 7274 6564 2e0a 2020  rtion-sorted..  
-00004960: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00004970: 2020 7265 7475 726e 2073 656c 662e 5f68    return self._h
-00004980: 6173 5f77 6861 742e 6b65 7973 2829 0a0a  as_what.keys()..
-00004990: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-000049a0: 2020 6465 6620 686f 7374 2873 656c 6629    def host(self)
-000049b0: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
-000049c0: 2072 6574 7572 6e20 6765 745f 6164 6472   return get_addr
-000049d0: 6573 735f 686f 7374 2873 656c 662e 6164  ess_host(self.ad
-000049e0: 6472 6573 7329 0a0a 2020 2020 4070 726f  dress)..    @pro
-000049f0: 7065 7274 790a 2020 2020 6465 6620 6d65  perty.    def me
-00004a00: 6d6f 7279 2873 656c 6629 202d 3e20 4d65  mory(self) -> Me
-00004a10: 6d6f 7279 5374 6174 653a 0a20 2020 2020  moryState:.     
-00004a20: 2020 2022 2222 506f 6c69 7368 6564 206d     """Polished m
-00004a30: 656d 6f72 7920 6d65 7472 6963 7320 666f  emory metrics fo
-00004a40: 7220 7468 6520 776f 726b 6572 2e0a 0a20  r the worker... 
-00004a50: 2020 2020 2020 202a 2a44 6573 6967 6e20         **Design 
-00004a60: 6e6f 7465 206f 6e20 6d61 6e61 6765 6420  note on managed 
-00004a70: 6d65 6d6f 7279 2a2a 0a0a 2020 2020 2020  memory**..      
-00004a80: 2020 5468 6572 6520 6172 6520 7477 6f20    There are two 
-00004a90: 6d65 6173 7572 6573 2061 7661 696c 6162  measures availab
-00004aa0: 6c65 2066 6f72 206d 616e 6167 6564 206d  le for managed m
-00004ab0: 656d 6f72 793a 0a0a 2020 2020 2020 2020  emory:..        
-00004ac0: 2d20 6060 7365 6c66 2e6e 6279 7465 7360  - ``self.nbytes`
-00004ad0: 600a 2020 2020 2020 2020 2d20 6060 7365  `.        - ``se
-00004ae0: 6c66 2e6d 6574 7269 6373 5b22 6d61 6e61  lf.metrics["mana
-00004af0: 6765 645f 6279 7465 7322 5d60 600a 0a20  ged_bytes"]``.. 
-00004b00: 2020 2020 2020 2041 7420 7265 7374 2c20         At rest, 
-00004b10: 7468 6520 7477 6f20 6e75 6d62 6572 7320  the two numbers 
-00004b20: 6d75 7374 2062 6520 6964 656e 7469 6361  must be identica
-00004b30: 6c2e 2048 6f77 6576 6572 2c20 6060 7365  l. However, ``se
-00004b40: 6c66 2e6e 6279 7465 7360 6020 6973 0a20  lf.nbytes`` is. 
-00004b50: 2020 2020 2020 2069 6d6d 6564 6961 7465         immediate
-00004b60: 6c79 2075 7064 6174 6564 2074 6872 6f75  ly updated throu
-00004b70: 6768 2074 6865 2062 6174 6368 6564 2063  gh the batched c
-00004b80: 6f6d 6d73 2061 7320 736f 6f6e 2061 7320  omms as soon as 
-00004b90: 6561 6368 2074 6173 6b20 6c61 6e64 7320  each task lands 
-00004ba0: 696e 0a20 2020 2020 2020 206d 656d 6f72  in.        memor
-00004bb0: 7920 6f6e 2074 6865 2077 6f72 6b65 723b  y on the worker;
-00004bc0: 2060 6073 656c 662e 6d65 7472 6963 735b   ``self.metrics[
-00004bd0: 226d 616e 6167 6564 5f62 7974 6573 225d  "managed_bytes"]
-00004be0: 6060 2069 6e73 7465 6164 2069 7320 7570  `` instead is up
-00004bf0: 6461 7465 6420 6279 0a20 2020 2020 2020  dated by.       
-00004c00: 2074 6865 2068 6561 7274 6265 6174 2c20   the heartbeat, 
-00004c10: 7768 6963 6820 6361 6e20 6c61 6720 7365  which can lag se
-00004c20: 7665 7261 6c20 7365 636f 6e64 7320 6265  veral seconds be
-00004c30: 6869 6e64 2e0a 0a20 2020 2020 2020 2042  hind...        B
-00004c40: 656c 6f77 2077 6520 6172 6520 6d69 7869  elow we are mixi
-00004c50: 6e67 206c 696b 656c 7920 6e65 7765 7220  ng likely newer 
-00004c60: 6d61 6e61 6765 6420 6d65 6d6f 7279 2069  managed memory i
-00004c70: 6e66 6f20 6672 6f6d 2060 6073 656c 662e  nfo from ``self.
-00004c80: 6e62 7974 6573 6060 2077 6974 680a 2020  nbytes`` with.  
-00004c90: 2020 2020 2020 7072 6f63 6573 7320 616e        process an
-00004ca0: 6420 7370 696c 6c65 6420 6d65 6d6f 7279  d spilled memory
-00004cb0: 2066 726f 6d20 7468 6520 6865 6172 7462   from the heartb
-00004cc0: 6561 742e 2054 6869 7320 6973 2064 656c  eat. This is del
-00004cd0: 6962 6572 6174 652c 2073 6f20 7468 6174  iberate, so that
-00004ce0: 0a20 2020 2020 2020 206d 616e 6167 6564  .        managed
-00004cf0: 206d 656d 6f72 7920 746f 7461 6c20 6973   memory total is
-00004d00: 2075 7064 6174 6564 206d 6f72 6520 6672   updated more fr
-00004d10: 6571 7565 6e74 6c79 2e0a 0a20 2020 2020  equently...     
-00004d20: 2020 204d 616e 6167 6564 206d 656d 6f72     Managed memor
-00004d30: 7920 6469 7265 6374 6c79 2061 6e64 2069  y directly and i
-00004d40: 6d6d 6564 6961 7465 6c79 2063 6f6e 7472  mmediately contr
-00004d50: 6962 7574 6573 2074 6f20 6f70 7469 6d69  ibutes to optimi
-00004d60: 7374 6963 206d 656d 6f72 792c 2077 6869  stic memory, whi
-00004d70: 6368 0a20 2020 2020 2020 2069 7320 696e  ch.        is in
-00004d80: 2074 7572 6e20 7573 6564 2069 6e20 4163   turn used in Ac
-00004d90: 7469 7665 204d 656d 6f72 7920 4d61 6e61  tive Memory Mana
-00004da0: 6765 7220 6865 7572 6973 7469 6373 2028  ger heuristics (
-00004db0: 6174 2074 6865 206d 6f6d 656e 7420 6f66  at the moment of
-00004dc0: 2077 7269 7469 6e67 3b0a 2020 2020 2020   writing;.      
-00004dd0: 2020 6d6f 7265 2075 7365 7320 7769 6c6c    more uses will
-00004de0: 206c 696b 656c 7920 6265 2061 6464 6564   likely be added
-00004df0: 2069 6e20 7468 6520 6675 7475 7265 292e   in the future).
-00004e00: 2053 6f20 6974 2773 2069 6d70 6f72 7461   So it's importa
-00004e10: 6e74 2074 6f20 6861 7665 2069 740a 2020  nt to have it.  
-00004e20: 2020 2020 2020 7570 2074 6f20 6461 7465        up to date
-00004e30: 3b20 6d75 6368 206d 6f72 6520 7468 616e  ; much more than
-00004e40: 2069 7420 6973 2066 6f72 2070 726f 6365   it is for proce
-00004e50: 7373 206d 656d 6f72 792e 0a0a 2020 2020  ss memory...    
-00004e60: 2020 2020 4861 7669 6e67 2075 702d 746f      Having up-to
-00004e70: 2d64 6174 6520 6d61 6e61 6765 6420 6d65  -date managed me
-00004e80: 6d6f 7279 2069 6e66 6f20 6173 2073 6f6f  mory info as soo
-00004e90: 6e20 6173 2074 6865 2073 6368 6564 756c  n as the schedul
-00004ea0: 6572 206c 6561 726e 7320 6162 6f75 740a  er learns about.
-00004eb0: 2020 2020 2020 2020 7461 736b 2063 6f6d          task com
-00004ec0: 706c 6574 696f 6e20 616c 736f 2073 7562  pletion also sub
-00004ed0: 7374 616e 7469 616c 6c79 2073 696d 706c  stantially simpl
-00004ee0: 6966 6965 7320 756e 6974 2074 6573 7473  ifies unit tests
-00004ef0: 2e0a 0a20 2020 2020 2020 2054 6865 2066  ...        The f
-00004f00: 6c69 7020 7369 6465 206f 6620 7468 6973  lip side of this
-00004f10: 2064 6573 6967 6e20 6973 2074 6861 7420   design is that 
-00004f20: 6974 206d 6179 2063 6175 7365 2073 6f6d  it may cause som
-00004f30: 6520 6e6f 6973 6520 696e 2074 6865 0a20  e noise in the. 
-00004f40: 2020 2020 2020 2075 6e6d 616e 6167 6564         unmanaged
-00004f50: 5f72 6563 656e 7420 6d65 6173 7572 652e  _recent measure.
-00004f60: 2065 2e67 2e3a 0a0a 2020 2020 2020 2020   e.g.:..        
-00004f70: 312e 2044 656c 6574 6520 3130 304d 4220  1. Delete 100MB 
-00004f80: 6f66 206d 616e 6167 6564 2064 6174 610a  of managed data.
-00004f90: 2020 2020 2020 2020 322e 2054 6865 2075          2. The u
-00004fa0: 7064 6174 6564 206d 616e 6167 6564 206d  pdated managed m
-00004fb0: 656d 6f72 7920 7265 6163 6865 7320 7468  emory reaches th
-00004fc0: 6520 7363 6865 6475 6c65 7220 6661 7374  e scheduler fast
-00004fd0: 6572 2074 6861 6e20 7468 650a 2020 2020  er than the.    
-00004fe0: 2020 2020 2020 2075 7064 6174 6564 2070         updated p
-00004ff0: 726f 6365 7373 206d 656d 6f72 790a 2020  rocess memory.  
-00005000: 2020 2020 2020 332e 2054 6865 7265 2773        3. There's
-00005010: 2061 2062 6c69 7020 7768 6572 6520 7468   a blip where th
-00005020: 6520 7363 6865 6475 6c65 7220 7468 696e  e scheduler thin
-00005030: 6b73 2074 6861 7420 7468 6572 6527 7320  ks that there's 
-00005040: 6120 7375 6464 656e 2031 3030 4d42 0a20  a sudden 100MB. 
-00005050: 2020 2020 2020 2020 2020 696e 6372 6561            increa
-00005060: 7365 2069 6e20 756e 6d61 6e61 6765 645f  se in unmanaged_
-00005070: 7265 6365 6e74 2c20 7369 6e63 6520 7072  recent, since pr
-00005080: 6f63 6573 7320 6d65 6d6f 7279 2068 6173  ocess memory has
-00005090: 6e27 7420 6368 616e 6765 6420 6275 7420  n't changed but 
-000050a0: 6d61 6e61 6765 640a 2020 2020 2020 2020  managed.        
-000050b0: 2020 206d 656d 6f72 7920 6861 7320 6465     memory has de
-000050c0: 6372 6561 7365 6420 6279 2031 3030 4d42  creased by 100MB
-000050d0: 0a20 2020 2020 2020 2034 2e20 5768 656e  .        4. When
-000050e0: 2074 6865 2068 6561 7274 6265 6174 2061   the heartbeat a
-000050f0: 7272 6976 6573 2c20 7072 6f63 6573 7320  rrives, process 
-00005100: 6d65 6d6f 7279 2067 6f65 7320 646f 776e  memory goes down
-00005110: 2061 6e64 2073 6f20 646f 6573 2074 6865   and so does the
-00005120: 0a20 2020 2020 2020 2020 2020 756e 6d61  .           unma
-00005130: 6e61 6765 645f 7265 6365 6e74 2e0a 0a20  naged_recent... 
-00005140: 2020 2020 2020 2054 6869 7320 6973 204f         This is O
-00005150: 4b20 2d20 6f6e 6520 6f66 2074 6865 206d  K - one of the m
-00005160: 6169 6e20 7265 6173 6f6e 7320 666f 7220  ain reasons for 
-00005170: 7468 6520 756e 6d61 6e61 6765 645f 7265  the unmanaged_re
-00005180: 6365 6e74 202f 2075 6e6d 616e 6167 6564  cent / unmanaged
-00005190: 5f6f 6c64 0a20 2020 2020 2020 2073 706c  _old.        spl
-000051a0: 6974 2069 7320 6578 6163 746c 7920 746f  it is exactly to
-000051b0: 2063 6f6e 6365 6e74 7261 7465 2061 6c6c   concentrate all
-000051c0: 2074 6865 206e 6f69 7365 2069 6e20 756e   the noise in un
-000051d0: 6d61 6e61 6765 645f 7265 6365 6e74 2061  managed_recent a
-000051e0: 6e64 2065 7863 6c75 6465 2069 740a 2020  nd exclude it.  
-000051f0: 2020 2020 2020 6672 6f6d 206f 7074 696d        from optim
-00005200: 6973 7469 6320 6d65 6d6f 7279 2c20 7768  istic memory, wh
-00005210: 6963 6820 6973 2075 7365 6420 666f 7220  ich is used for 
-00005220: 6865 7572 6973 7469 6373 2e0a 0a20 2020  heuristics...   
-00005230: 2020 2020 2053 6f6d 6574 6869 6e67 2074       Something t
-00005240: 6861 7420 6973 206c 6573 7320 4f4b 2c20  hat is less OK, 
-00005250: 6275 7420 616c 736f 206c 6573 7320 6672  but also less fr
-00005260: 6571 7565 6e74 2c20 6973 2074 6861 7420  equent, is that 
-00005270: 7468 6520 7375 6464 656e 2064 656c 6574  the sudden delet
-00005280: 696f 6e0a 2020 2020 2020 2020 6f66 2073  ion.        of s
-00005290: 7069 6c6c 6564 206b 6579 7320 7769 6c6c  pilled keys will
-000052a0: 2063 6175 7365 2061 206e 6567 6174 6976   cause a negativ
-000052b0: 6520 626c 6970 2069 6e20 6d61 6e61 6765  e blip in manage
-000052c0: 6420 6d65 6d6f 7279 3a0a 0a20 2020 2020  d memory:..     
-000052d0: 2020 2031 2e20 4465 6c65 7465 2031 3030     1. Delete 100
-000052e0: 4d42 206f 6620 7370 696c 6c65 6420 6461  MB of spilled da
-000052f0: 7461 0a20 2020 2020 2020 2032 2e20 5468  ta.        2. Th
-00005300: 6520 7570 6461 7465 6420 6d61 6e61 6765  e updated manage
-00005310: 6420 6d65 6d6f 7279 202a 746f 7461 6c2a  d memory *total*
-00005320: 2072 6561 6368 6573 2074 6865 2073 6368   reaches the sch
-00005330: 6564 756c 6572 2066 6173 7465 7220 7468  eduler faster th
-00005340: 616e 2074 6865 0a20 2020 2020 2020 2020  an the.         
-00005350: 2020 7570 6461 7465 6420 7370 696c 6c65    updated spille
-00005360: 6420 706f 7274 696f 6e0a 2020 2020 2020  d portion.      
-00005370: 2020 332e 2054 6869 7320 6361 7573 6573    3. This causes
-00005380: 2074 6865 206d 616e 6167 6564 206d 656d   the managed mem
-00005390: 6f72 7920 746f 2074 656d 706f 7261 7269  ory to temporari
-000053a0: 6c79 2070 6c75 6d6d 6574 2061 6e64 2062  ly plummet and b
-000053b0: 6520 7265 706c 6163 6564 2062 790a 2020  e replaced by.  
-000053c0: 2020 2020 2020 2020 2075 6e6d 616e 6167           unmanag
-000053d0: 6564 5f72 6563 656e 742c 2077 6869 6c65  ed_recent, while
-000053e0: 2073 7069 6c6c 6564 206d 656d 6f72 7920   spilled memory 
-000053f0: 7265 6d61 696e 7320 756e 616c 7465 7265  remains unaltere
-00005400: 640a 2020 2020 2020 2020 342e 2057 6865  d.        4. Whe
-00005410: 6e20 7468 6520 6865 6172 7462 6561 7420  n the heartbeat 
-00005420: 6172 7269 7665 732c 206d 616e 6167 6564  arrives, managed
-00005430: 2067 6f65 7320 6261 636b 2075 702c 2075   goes back up, u
-00005440: 6e6d 616e 6167 6564 5f72 6563 656e 740a  nmanaged_recent.
-00005450: 2020 2020 2020 2020 2020 2067 6f65 7320             goes 
-00005460: 6261 636b 2064 6f77 6e2c 2061 6e64 2073  back down, and s
-00005470: 7069 6c6c 6564 2067 6f65 7320 646f 776e  pilled goes down
-00005480: 2062 7920 3130 304d 4220 6173 2069 7420   by 100MB as it 
-00005490: 7368 6f75 6c64 2068 6176 6520 746f 0a20  should have to. 
-000054a0: 2020 2020 2020 2020 2020 6265 6769 6e20            begin 
-000054b0: 7769 7468 2e0a 0a20 2020 2020 2020 203a  with...        :
-000054c0: 6973 7375 653a 6036 3030 3260 2077 696c  issue:`6002` wil
-000054d0: 6c20 6c65 7420 7573 2073 6f6c 7665 2074  l let us solve t
-000054e0: 6869 732e 0a20 2020 2020 2020 2022 2222  his..        """
-000054f0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00005500: 4d65 6d6f 7279 5374 6174 6528 0a20 2020  MemoryState(.   
-00005510: 2020 2020 2020 2020 2070 726f 6365 7373           process
-00005520: 3d73 656c 662e 6d65 7472 6963 735b 226d  =self.metrics["m
-00005530: 656d 6f72 7922 5d2c 0a20 2020 2020 2020  emory"],.       
-00005540: 2020 2020 206d 616e 6167 6564 3d6d 6178       managed=max
-00005550: 2830 2c20 7365 6c66 2e6e 6279 7465 7320  (0, self.nbytes 
-00005560: 2d20 7365 6c66 2e6d 6574 7269 6373 5b22  - self.metrics["
-00005570: 7370 696c 6c65 645f 6279 7465 7322 5d5b  spilled_bytes"][
-00005580: 226d 656d 6f72 7922 5d29 2c0a 2020 2020  "memory"]),.    
-00005590: 2020 2020 2020 2020 7370 696c 6c65 643d          spilled=
-000055a0: 7365 6c66 2e6d 6574 7269 6373 5b22 7370  self.metrics["sp
-000055b0: 696c 6c65 645f 6279 7465 7322 5d5b 2264  illed_bytes"]["d
-000055c0: 6973 6b22 5d2c 0a20 2020 2020 2020 2020  isk"],.         
-000055d0: 2020 2075 6e6d 616e 6167 6564 5f6f 6c64     unmanaged_old
-000055e0: 3d73 656c 662e 5f6d 656d 6f72 795f 756e  =self._memory_un
-000055f0: 6d61 6e61 6765 645f 6f6c 642c 0a20 2020  managed_old,.   
-00005600: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00005610: 636c 6561 6e28 7365 6c66 2920 2d3e 2057  clean(self) -> W
-00005620: 6f72 6b65 7253 7461 7465 3a0a 2020 2020  orkerState:.    
-00005630: 2020 2020 2222 2252 6574 7572 6e20 6120      """Return a 
-00005640: 7665 7273 696f 6e20 6f66 2074 6869 7320  version of this 
-00005650: 6f62 6a65 6374 2074 6861 7420 6973 2061  object that is a
-00005660: 7070 726f 7072 6961 7465 2066 6f72 2073  ppropriate for s
-00005670: 6572 6961 6c69 7a61 7469 6f6e 2222 220a  erialization""".
-00005680: 2020 2020 2020 2020 7773 203d 2057 6f72          ws = Wor
-00005690: 6b65 7253 7461 7465 280a 2020 2020 2020  kerState(.      
-000056a0: 2020 2020 2020 6164 6472 6573 733d 7365        address=se
-000056b0: 6c66 2e61 6464 7265 7373 2c0a 2020 2020  lf.address,.    
-000056c0: 2020 2020 2020 2020 7374 6174 7573 3d73          status=s
-000056d0: 656c 662e 7374 6174 7573 2c0a 2020 2020  elf.status,.    
-000056e0: 2020 2020 2020 2020 7069 643d 7365 6c66          pid=self
-000056f0: 2e70 6964 2c0a 2020 2020 2020 2020 2020  .pid,.          
-00005700: 2020 6e61 6d65 3d73 656c 662e 6e61 6d65    name=self.name
-00005710: 2c0a 2020 2020 2020 2020 2020 2020 6e74  ,.            nt
-00005720: 6872 6561 6473 3d73 656c 662e 6e74 6872  hreads=self.nthr
-00005730: 6561 6473 2c0a 2020 2020 2020 2020 2020  eads,.          
-00005740: 2020 6d65 6d6f 7279 5f6c 696d 6974 3d73    memory_limit=s
-00005750: 656c 662e 6d65 6d6f 7279 5f6c 696d 6974  elf.memory_limit
-00005760: 2c0a 2020 2020 2020 2020 2020 2020 6c6f  ,.            lo
-00005770: 6361 6c5f 6469 7265 6374 6f72 793d 7365  cal_directory=se
-00005780: 6c66 2e6c 6f63 616c 5f64 6972 6563 746f  lf.local_directo
-00005790: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
-000057a0: 7365 7276 6963 6573 3d73 656c 662e 7365  services=self.se
-000057b0: 7276 6963 6573 2c0a 2020 2020 2020 2020  rvices,.        
-000057c0: 2020 2020 6e61 6e6e 793d 7365 6c66 2e6e      nanny=self.n
-000057d0: 616e 6e79 2c0a 2020 2020 2020 2020 2020  anny,.          
-000057e0: 2020 6578 7472 613d 7365 6c66 2e65 7874    extra=self.ext
-000057f0: 7261 2c0a 2020 2020 2020 2020 2020 2020  ra,.            
-00005800: 7365 7276 6572 5f69 643d 7365 6c66 2e73  server_id=self.s
-00005810: 6572 7665 725f 6964 2c0a 2020 2020 2020  erver_id,.      
-00005820: 2020 290a 2020 2020 2020 2020 7773 2e5f    ).        ws._
-00005830: 6f63 6375 7061 6e63 795f 6361 6368 6520  occupancy_cache 
-00005840: 3d20 7365 6c66 2e6f 6363 7570 616e 6379  = self.occupancy
-00005850: 0a0a 2020 2020 2020 2020 7773 2e65 7865  ..        ws.exe
-00005860: 6375 7469 6e67 203d 207b 0a20 2020 2020  cuting = {.     
-00005870: 2020 2020 2020 2074 732e 6b65 793a 2064         ts.key: d
-00005880: 7572 6174 696f 6e20 666f 7220 7473 2c20  uration for ts, 
-00005890: 6475 7261 7469 6f6e 2069 6e20 7365 6c66  duration in self
-000058a0: 2e65 7865 6375 7469 6e67 2e69 7465 6d73  .executing.items
-000058b0: 2829 2020 2320 7479 7065 3a20 6967 6e6f  ()  # type: igno
-000058c0: 7265 0a20 2020 2020 2020 207d 0a20 2020  re.        }.   
-000058d0: 2020 2020 2072 6574 7572 6e20 7773 0a0a       return ws..
-000058e0: 2020 2020 6465 6620 5f5f 7265 7072 5f5f      def __repr__
-000058f0: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
-00005900: 2020 2020 2020 206e 616d 6520 3d20 6622         name = f"
-00005910: 2c20 6e61 6d65 3a20 7b73 656c 662e 6e61  , name: {self.na
-00005920: 6d65 7d22 2069 6620 7365 6c66 2e6e 616d  me}" if self.nam
-00005930: 6520 213d 2073 656c 662e 6164 6472 6573  e != self.addres
-00005940: 7320 656c 7365 2022 220a 2020 2020 2020  s else "".      
-00005950: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
-00005960: 2020 2020 2020 2066 223c 576f 726b 6572         f"<Worker
-00005970: 5374 6174 6520 7b73 656c 662e 6164 6472  State {self.addr
-00005980: 6573 7321 727d 7b6e 616d 657d 2c20 220a  ess!r}{name}, ".
-00005990: 2020 2020 2020 2020 2020 2020 6622 7374              f"st
-000059a0: 6174 7573 3a20 7b73 656c 662e 7374 6174  atus: {self.stat
-000059b0: 7573 2e6e 616d 657d 2c20 220a 2020 2020  us.name}, ".    
-000059c0: 2020 2020 2020 2020 6622 6d65 6d6f 7279          f"memory
-000059d0: 3a20 7b6c 656e 2873 656c 662e 6861 735f  : {len(self.has_
-000059e0: 7768 6174 297d 2c20 220a 2020 2020 2020  what)}, ".      
-000059f0: 2020 2020 2020 6622 7072 6f63 6573 7369        f"processi
-00005a00: 6e67 3a20 7b6c 656e 2873 656c 662e 7072  ng: {len(self.pr
-00005a10: 6f63 6573 7369 6e67 297d 3e22 0a20 2020  ocessing)}>".   
-00005a20: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00005a30: 5f72 6570 725f 6874 6d6c 5f28 7365 6c66  _repr_html_(self
-00005a40: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-00005a50: 2020 7265 7475 726e 2067 6574 5f74 656d    return get_tem
-00005a60: 706c 6174 6528 2277 6f72 6b65 725f 7374  plate("worker_st
-00005a70: 6174 652e 6874 6d6c 2e6a 3222 292e 7265  ate.html.j2").re
-00005a80: 6e64 6572 280a 2020 2020 2020 2020 2020  nder(.          
-00005a90: 2020 6164 6472 6573 733d 7365 6c66 2e61    address=self.a
-00005aa0: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
-00005ab0: 2020 2020 6e61 6d65 3d73 656c 662e 6e61      name=self.na
-00005ac0: 6d65 2c0a 2020 2020 2020 2020 2020 2020  me,.            
-00005ad0: 7374 6174 7573 3d73 656c 662e 7374 6174  status=self.stat
-00005ae0: 7573 2e6e 616d 652c 0a20 2020 2020 2020  us.name,.       
-00005af0: 2020 2020 2068 6173 5f77 6861 743d 7365       has_what=se
-00005b00: 6c66 2e68 6173 5f77 6861 742c 0a20 2020  lf.has_what,.   
-00005b10: 2020 2020 2020 2020 2070 726f 6365 7373           process
-00005b20: 696e 673d 7365 6c66 2e70 726f 6365 7373  ing=self.process
-00005b30: 696e 672c 0a20 2020 2020 2020 2029 0a0a  ing,.        )..
-00005b40: 2020 2020 6465 6620 6964 656e 7469 7479      def identity
-00005b50: 2873 656c 6629 202d 3e20 6469 6374 5b73  (self) -> dict[s
-00005b60: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
-00005b70: 2020 7265 7475 726e 207b 0a20 2020 2020    return {.     
-00005b80: 2020 2020 2020 2022 7479 7065 223a 2022         "type": "
-00005b90: 576f 726b 6572 222c 0a20 2020 2020 2020  Worker",.       
-00005ba0: 2020 2020 2022 6964 223a 2073 656c 662e       "id": self.
-00005bb0: 6e61 6d65 2c0a 2020 2020 2020 2020 2020  name,.          
-00005bc0: 2020 2268 6f73 7422 3a20 7365 6c66 2e68    "host": self.h
-00005bd0: 6f73 742c 0a20 2020 2020 2020 2020 2020  ost,.           
-00005be0: 2022 7265 736f 7572 6365 7322 3a20 7365   "resources": se
-00005bf0: 6c66 2e72 6573 6f75 7263 6573 2c0a 2020  lf.resources,.  
-00005c00: 2020 2020 2020 2020 2020 226c 6f63 616c            "local
-00005c10: 5f64 6972 6563 746f 7279 223a 2073 656c  _directory": sel
-00005c20: 662e 6c6f 6361 6c5f 6469 7265 6374 6f72  f.local_director
-00005c30: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
-00005c40: 6e61 6d65 223a 2073 656c 662e 6e61 6d65  name": self.name
-00005c50: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
-00005c60: 7468 7265 6164 7322 3a20 7365 6c66 2e6e  threads": self.n
-00005c70: 7468 7265 6164 732c 0a20 2020 2020 2020  threads,.       
-00005c80: 2020 2020 2022 6d65 6d6f 7279 5f6c 696d       "memory_lim
-00005c90: 6974 223a 2073 656c 662e 6d65 6d6f 7279  it": self.memory
-00005ca0: 5f6c 696d 6974 2c0a 2020 2020 2020 2020  _limit,.        
-00005cb0: 2020 2020 226c 6173 745f 7365 656e 223a      "last_seen":
-00005cc0: 2073 656c 662e 6c61 7374 5f73 6565 6e2c   self.last_seen,
-00005cd0: 0a20 2020 2020 2020 2020 2020 2022 7365  .            "se
-00005ce0: 7276 6963 6573 223a 2073 656c 662e 7365  rvices": self.se
-00005cf0: 7276 6963 6573 2c0a 2020 2020 2020 2020  rvices,.        
-00005d00: 2020 2020 226d 6574 7269 6373 223a 2073      "metrics": s
-00005d10: 656c 662e 6d65 7472 6963 732c 0a20 2020  elf.metrics,.   
-00005d20: 2020 2020 2020 2020 2022 7374 6174 7573           "status
-00005d30: 223a 2073 656c 662e 7374 6174 7573 2e6e  ": self.status.n
-00005d40: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-00005d50: 2022 6e61 6e6e 7922 3a20 7365 6c66 2e6e   "nanny": self.n
-00005d60: 616e 6e79 2c0a 2020 2020 2020 2020 2020  anny,.          
-00005d70: 2020 2a2a 7365 6c66 2e65 7874 7261 2c0a    **self.extra,.
-00005d80: 2020 2020 2020 2020 7d0a 0a20 2020 2064          }..    d
-00005d90: 6566 205f 746f 5f64 6963 745f 6e6f 5f6e  ef _to_dict_no_n
-00005da0: 6573 7428 7365 6c66 2c20 2a2c 2065 7863  est(self, *, exc
-00005db0: 6c75 6465 3a20 436f 6e74 6169 6e65 725b  lude: Container[
-00005dc0: 7374 725d 203d 2028 2929 202d 3e20 6469  str] = ()) -> di
-00005dd0: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
-00005de0: 2020 2020 2020 2222 2244 6963 7469 6f6e        """Diction
-00005df0: 6172 7920 7265 7072 6573 656e 7461 7469  ary representati
-00005e00: 6f6e 2066 6f72 2064 6562 7567 6769 6e67  on for debugging
-00005e10: 2070 7572 706f 7365 732e 0a20 2020 2020   purposes..     
-00005e20: 2020 204e 6f74 2074 7970 6520 7374 6162     Not type stab
-00005e30: 6c65 2061 6e64 206e 6f74 2069 6e74 656e  le and not inten
-00005e40: 6465 6420 666f 7220 726f 756e 6474 7269  ded for roundtri
-00005e50: 7073 2e0a 0a20 2020 2020 2020 2053 6565  ps...        See
-00005e60: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
-00005e70: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2043  ------.        C
-00005e80: 6c69 656e 742e 6475 6d70 5f63 6c75 7374  lient.dump_clust
-00005e90: 6572 5f73 7461 7465 0a20 2020 2020 2020  er_state.       
-00005ea0: 2064 6973 7472 6962 7574 6564 2e75 7469   distributed.uti
-00005eb0: 6c73 2e72 6563 7572 7369 7665 5f74 6f5f  ls.recursive_to_
-00005ec0: 6469 6374 0a20 2020 2020 2020 2054 6173  dict.        Tas
-00005ed0: 6b53 7461 7465 2e5f 746f 5f64 6963 740a  kState._to_dict.
-00005ee0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00005ef0: 2020 2020 7265 7475 726e 2072 6563 7572      return recur
-00005f00: 7369 7665 5f74 6f5f 6469 6374 280a 2020  sive_to_dict(.  
-00005f10: 2020 2020 2020 2020 2020 7365 6c66 2c0a            self,.
-00005f20: 2020 2020 2020 2020 2020 2020 6578 636c              excl
-00005f30: 7564 653d 7365 7428 6578 636c 7564 6529  ude=set(exclude)
-00005f40: 207c 207b 2276 6572 7369 6f6e 7322 7d2c   | {"versions"},
-00005f50: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-00005f60: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
-00005f70: 6265 7273 3d54 7275 652c 0a20 2020 2020  bers=True,.     
-00005f80: 2020 2029 0a0a 2020 2020 4070 726f 7065     )..    @prope
-00005f90: 7274 790a 2020 2020 6465 6620 7363 6865  rty.    def sche
-00005fa0: 6475 6c65 7228 7365 6c66 2920 2d3e 2053  duler(self) -> S
-00005fb0: 6368 6564 756c 6572 5374 6174 653a 0a20  chedulerState:. 
-00005fc0: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
-00005fd0: 6c66 2e73 6368 6564 756c 6572 5f72 6566  lf.scheduler_ref
-00005fe0: 0a20 2020 2020 2020 2073 203d 2073 656c  .        s = sel
-00005ff0: 662e 7363 6865 6475 6c65 725f 7265 6628  f.scheduler_ref(
-00006000: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00006010: 2073 0a20 2020 2020 2020 2072 6574 7572   s.        retur
-00006020: 6e20 730a 0a20 2020 2064 6566 2061 6464  n s..    def add
-00006030: 5f74 6f5f 7072 6f63 6573 7369 6e67 2873  _to_processing(s
-00006040: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
-00006050: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
-00006060: 2020 2020 2022 2222 4173 7369 676e 2061       """Assign a
-00006070: 2074 6173 6b20 746f 2074 6869 7320 776f   task to this wo
-00006080: 726b 6572 2066 6f72 2063 6f6d 7075 7465  rker for compute
-00006090: 2e22 2222 0a20 2020 2020 2020 2069 6620  .""".        if 
-000060a0: 7365 6c66 2e73 6368 6564 756c 6572 2e76  self.scheduler.v
-000060b0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-000060c0: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-000060d0: 6f74 2069 6e20 7365 6c66 2e70 726f 6365  ot in self.proce
-000060e0: 7373 696e 670a 0a20 2020 2020 2020 2074  ssing..        t
-000060f0: 7020 3d20 7473 2e70 7265 6669 780a 2020  p = ts.prefix.  
-00006100: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
-00006110: 7072 6566 6978 5f63 6f75 6e74 5b74 702e  prefix_count[tp.
-00006120: 6e61 6d65 5d20 2b3d 2031 0a20 2020 2020  name] += 1.     
-00006130: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
-00006140: 722e 5f74 6173 6b5f 7072 6566 6978 5f63  r._task_prefix_c
-00006150: 6f75 6e74 5f67 6c6f 6261 6c5b 7470 2e6e  ount_global[tp.n
-00006160: 616d 655d 202b 3d20 310a 2020 2020 2020  ame] += 1.      
-00006170: 2020 7365 6c66 2e70 726f 6365 7373 696e    self.processin
-00006180: 672e 6164 6428 7473 290a 2020 2020 2020  g.add(ts).      
-00006190: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-000061a0: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-000061b0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-000061c0: 2064 7473 2e77 686f 5f68 6173 0a20 2020   dts.who_has.   
-000061d0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-000061e0: 206e 6f74 2069 6e20 6474 732e 7768 6f5f   not in dts.who_
-000061f0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-00006200: 2020 2020 2073 656c 662e 5f69 6e63 5f6e       self._inc_n
-00006210: 6565 6473 5f72 6570 6c69 6361 2864 7473  eeds_replica(dts
-00006220: 290a 0a20 2020 2064 6566 2061 6464 5f74  )..    def add_t
-00006230: 6f5f 6c6f 6e67 5f72 756e 6e69 6e67 2873  o_long_running(s
-00006240: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
-00006250: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
-00006260: 2020 2020 2069 6620 7365 6c66 2e73 6368       if self.sch
-00006270: 6564 756c 6572 2e76 616c 6964 6174 653a  eduler.validate:
-00006280: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00006290: 6572 7420 7473 2069 6e20 7365 6c66 2e70  ert ts in self.p
-000062a0: 726f 6365 7373 696e 670a 2020 2020 2020  rocessing.      
-000062b0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-000062c0: 6e6f 7420 696e 2073 656c 662e 6c6f 6e67  not in self.long
-000062d0: 5f72 756e 6e69 6e67 0a0a 2020 2020 2020  _running..      
-000062e0: 2020 7365 6c66 2e5f 7265 6d6f 7665 5f66    self._remove_f
-000062f0: 726f 6d5f 7461 736b 5f70 7265 6669 785f  rom_task_prefix_
-00006300: 636f 756e 7428 7473 290a 2020 2020 2020  count(ts).      
-00006310: 2020 2320 4361 6e6e 6f74 2072 656d 6f76    # Cannot remov
-00006320: 6520 6672 6f6d 2070 726f 6365 7373 696e  e from processin
-00006330: 6720 7369 6e63 6520 7765 2772 6520 7573  g since we're us
-00006340: 696e 6720 7468 6973 2066 6f72 2074 6869  ing this for thi
-00006350: 6e67 7320 6c69 6b65 0a20 2020 2020 2020  ngs like.       
-00006360: 2023 2069 646c 656e 6573 7320 6465 7465   # idleness dete
-00006370: 6374 696f 6e2e 2049 646c 6520 776f 726b  ction. Idle work
-00006380: 6572 7320 6172 6520 7479 7069 6361 6c6c  ers are typicall
-00006390: 7920 7461 7267 6574 6564 2066 6f72 0a20  y targeted for. 
-000063a0: 2020 2020 2020 2023 2064 6f77 6e73 6361         # downsca
-000063b0: 6c69 6e67 2062 7574 2077 6520 7368 6f75  ling but we shou
-000063c0: 6c64 206e 6f74 2064 6f77 6e73 6361 6c65  ld not downscale
-000063d0: 2077 6f72 6b65 7273 2077 6974 6820 6c6f   workers with lo
-000063e0: 6e67 2072 756e 6e69 6e67 0a20 2020 2020  ng running.     
-000063f0: 2020 2023 2074 6173 6b73 0a20 2020 2020     # tasks.     
-00006400: 2020 2073 656c 662e 6c6f 6e67 5f72 756e     self.long_run
-00006410: 6e69 6e67 2e61 6464 2874 7329 0a0a 2020  ning.add(ts)..  
-00006420: 2020 6465 6620 7265 6d6f 7665 5f66 726f    def remove_fro
-00006430: 6d5f 7072 6f63 6573 7369 6e67 2873 656c  m_processing(sel
-00006440: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-00006450: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00006460: 2020 2022 2222 5265 6d6f 7665 2061 2074     """Remove a t
-00006470: 6173 6b20 6672 6f6d 2061 2077 6f72 6b65  ask from a worke
-00006480: 7273 2070 726f 6365 7373 696e 6722 2222  rs processing"""
-00006490: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000064a0: 2e73 6368 6564 756c 6572 2e76 616c 6964  .scheduler.valid
-000064b0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-000064c0: 2061 7373 6572 7420 7473 2069 6e20 7365   assert ts in se
-000064d0: 6c66 2e70 726f 6365 7373 696e 670a 0a20  lf.processing.. 
-000064e0: 2020 2020 2020 2069 6620 7473 2069 6e20         if ts in 
-000064f0: 7365 6c66 2e6c 6f6e 675f 7275 6e6e 696e  self.long_runnin
-00006500: 673a 0a20 2020 2020 2020 2020 2020 2073  g:.            s
-00006510: 656c 662e 6c6f 6e67 5f72 756e 6e69 6e67  elf.long_running
-00006520: 2e64 6973 6361 7264 2874 7329 0a20 2020  .discard(ts).   
-00006530: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00006540: 2020 2020 2020 2073 656c 662e 5f72 656d         self._rem
-00006550: 6f76 655f 6672 6f6d 5f74 6173 6b5f 7072  ove_from_task_pr
-00006560: 6566 6978 5f63 6f75 6e74 2874 7329 0a20  efix_count(ts). 
-00006570: 2020 2020 2020 2073 656c 662e 7072 6f63         self.proc
-00006580: 6573 7369 6e67 2e72 656d 6f76 6528 7473  essing.remove(ts
-00006590: 290a 2020 2020 2020 2020 666f 7220 6474  ).        for dt
-000065a0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-000065b0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-000065c0: 2020 6966 2064 7473 2069 6e20 7365 6c66    if dts in self
-000065d0: 2e6e 6565 6473 5f77 6861 743a 0a20 2020  .needs_what:.   
-000065e0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-000065f0: 662e 5f64 6563 5f6e 6565 6473 5f72 6570  f._dec_needs_rep
-00006600: 6c69 6361 2864 7473 290a 0a20 2020 2064  lica(dts)..    d
-00006610: 6566 205f 7265 6d6f 7665 5f66 726f 6d5f  ef _remove_from_
-00006620: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
-00006630: 7428 7365 6c66 2c20 7473 3a20 5461 736b  t(self, ts: Task
-00006640: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-00006650: 2020 2020 2020 2020 636f 756e 7420 3d20          count = 
-00006660: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
-00006670: 5f63 6f75 6e74 5b74 732e 7072 6566 6978  _count[ts.prefix
-00006680: 2e6e 616d 655d 202d 2031 0a20 2020 2020  .name] - 1.     
-00006690: 2020 2069 6620 636f 756e 743a 0a20 2020     if count:.   
-000066a0: 2020 2020 2020 2020 2073 656c 662e 7461           self.ta
-000066b0: 736b 5f70 7265 6669 785f 636f 756e 745b  sk_prefix_count[
-000066c0: 7473 2e70 7265 6669 782e 6e61 6d65 5d20  ts.prefix.name] 
-000066d0: 3d20 636f 756e 740a 2020 2020 2020 2020  = count.        
-000066e0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000066f0: 2020 6465 6c20 7365 6c66 2e74 6173 6b5f    del self.task_
-00006700: 7072 6566 6978 5f63 6f75 6e74 5b74 732e  prefix_count[ts.
-00006710: 7072 6566 6978 2e6e 616d 655d 0a0a 2020  prefix.name]..  
-00006720: 2020 2020 2020 636f 756e 7420 3d20 7365        count = se
-00006730: 6c66 2e73 6368 6564 756c 6572 2e5f 7461  lf.scheduler._ta
-00006740: 736b 5f70 7265 6669 785f 636f 756e 745f  sk_prefix_count_
-00006750: 676c 6f62 616c 5b74 732e 7072 6566 6978  global[ts.prefix
-00006760: 2e6e 616d 655d 202d 2031 0a20 2020 2020  .name] - 1.     
-00006770: 2020 2069 6620 636f 756e 743a 0a20 2020     if count:.   
-00006780: 2020 2020 2020 2020 2073 656c 662e 7363           self.sc
-00006790: 6865 6475 6c65 722e 5f74 6173 6b5f 7072  heduler._task_pr
-000067a0: 6566 6978 5f63 6f75 6e74 5f67 6c6f 6261  efix_count_globa
-000067b0: 6c5b 7473 2e70 7265 6669 782e 6e61 6d65  l[ts.prefix.name
-000067c0: 5d20 3d20 636f 756e 740a 2020 2020 2020  ] = count.      
-000067d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000067e0: 2020 2020 6465 6c20 7365 6c66 2e73 6368      del self.sch
-000067f0: 6564 756c 6572 2e5f 7461 736b 5f70 7265  eduler._task_pre
-00006800: 6669 785f 636f 756e 745f 676c 6f62 616c  fix_count_global
-00006810: 5b74 732e 7072 6566 6978 2e6e 616d 655d  [ts.prefix.name]
-00006820: 0a0a 2020 2020 6465 6620 7265 6d6f 7665  ..    def remove
-00006830: 5f72 6570 6c69 6361 2873 656c 662c 2074  _replica(self, t
-00006840: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
-00006850: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00006860: 2222 5468 6520 776f 726b 6572 206e 6f20  ""The worker no 
-00006870: 6c6f 6e67 6572 2068 6173 2061 2074 6173  longer has a tas
-00006880: 6b20 696e 206d 656d 6f72 7922 2222 0a20  k in memory""". 
-00006890: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
-000068a0: 6368 6564 756c 6572 2e76 616c 6964 6174  cheduler.validat
-000068b0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-000068c0: 7373 6572 7420 7473 2e77 686f 5f68 6173  ssert ts.who_has
-000068d0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000068e0: 6572 7420 7365 6c66 2069 6e20 7473 2e77  ert self in ts.w
-000068f0: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
-00006900: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-00006910: 7365 6c66 2e68 6173 5f77 6861 740a 2020  self.has_what.  
-00006920: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00006930: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
-00006940: 6e65 6564 735f 7768 6174 0a0a 2020 2020  needs_what..    
-00006950: 2020 2020 7365 6c66 2e6e 6279 7465 7320      self.nbytes 
-00006960: 2d3d 2074 732e 6765 745f 6e62 7974 6573  -= ts.get_nbytes
-00006970: 2829 0a20 2020 2020 2020 2064 656c 2073  ().        del s
-00006980: 656c 662e 5f68 6173 5f77 6861 745b 7473  elf._has_what[ts
-00006990: 5d0a 2020 2020 2020 2020 7473 2e77 686f  ].        ts.who
-000069a0: 5f68 6173 2e72 656d 6f76 6528 7365 6c66  _has.remove(self
-000069b0: 2920 2023 2074 7970 653a 2069 676e 6f72  )  # type: ignor
-000069c0: 650a 2020 2020 2020 2020 6966 206e 6f74  e.        if not
-000069d0: 2074 732e 7768 6f5f 6861 733a 0a20 2020   ts.who_has:.   
-000069e0: 2020 2020 2020 2020 2074 732e 7768 6f5f           ts.who_
-000069f0: 6861 7320 3d20 4e6f 6e65 0a0a 2020 2020  has = None..    
-00006a00: 6465 6620 5f69 6e63 5f6e 6565 6473 5f72  def _inc_needs_r
-00006a10: 6570 6c69 6361 2873 656c 662c 2074 733a  eplica(self, ts:
-00006a20: 2054 6173 6b53 7461 7465 2920 2d3e 204e   TaskState) -> N
-00006a30: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00006a40: 4173 7369 676e 2061 2074 6173 6b20 6665  Assign a task fe
-00006a50: 7463 6820 746f 2074 6869 7320 776f 726b  tch to this work
-00006a60: 6572 2061 6e64 2075 7064 6174 6520 6e65  er and update ne
-00006a70: 7477 6f72 6b20 6f63 6375 7061 6e63 6965  twork occupancie
-00006a80: 7322 2222 0a20 2020 2020 2020 2069 6620  s""".        if 
-00006a90: 7365 6c66 2e73 6368 6564 756c 6572 2e76  self.scheduler.v
-00006aa0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00006ab0: 2020 2020 2061 7373 6572 7420 7473 2e77       assert ts.w
-00006ac0: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
-00006ad0: 2020 2061 7373 6572 7420 7365 6c66 206e     assert self n
-00006ae0: 6f74 2069 6e20 7473 2e77 686f 5f68 6173  ot in ts.who_has
-00006af0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00006b00: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
-00006b10: 6c66 2e68 6173 5f77 6861 740a 2020 2020  lf.has_what.    
-00006b20: 2020 2020 6966 2074 7320 6e6f 7420 696e      if ts not in
-00006b30: 2073 656c 662e 6e65 6564 735f 7768 6174   self.needs_what
-00006b40: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00006b50: 6c66 2e6e 6565 6473 5f77 6861 745b 7473  lf.needs_what[ts
-00006b60: 5d20 3d20 310a 2020 2020 2020 2020 2020  ] = 1.          
-00006b70: 2020 6e62 7974 6573 203d 2074 732e 6765    nbytes = ts.ge
-00006b80: 745f 6e62 7974 6573 2829 0a20 2020 2020  t_nbytes().     
-00006b90: 2020 2020 2020 2073 656c 662e 5f6e 6574         self._net
-00006ba0: 776f 726b 5f6f 6363 202b 3d20 6e62 7974  work_occ += nbyt
-00006bb0: 6573 0a20 2020 2020 2020 2020 2020 2073  es.            s
-00006bc0: 656c 662e 7363 6865 6475 6c65 722e 5f6e  elf.scheduler._n
-00006bd0: 6574 776f 726b 5f6f 6363 5f67 6c6f 6261  etwork_occ_globa
-00006be0: 6c20 2b3d 206e 6279 7465 730a 2020 2020  l += nbytes.    
-00006bf0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00006c00: 2020 2020 2020 7365 6c66 2e6e 6565 6473        self.needs
-00006c10: 5f77 6861 745b 7473 5d20 2b3d 2031 0a0a  _what[ts] += 1..
-00006c20: 2020 2020 6465 6620 5f64 6563 5f6e 6565      def _dec_nee
-00006c30: 6473 5f72 6570 6c69 6361 2873 656c 662c  ds_replica(self,
-00006c40: 2074 733a 2054 6173 6b53 7461 7465 2920   ts: TaskState) 
-00006c50: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00006c60: 2069 6620 7365 6c66 2e73 6368 6564 756c   if self.schedul
-00006c70: 6572 2e76 616c 6964 6174 653a 0a20 2020  er.validate:.   
-00006c80: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00006c90: 7473 2069 6e20 7365 6c66 2e6e 6565 6473  ts in self.needs
-00006ca0: 5f77 6861 740a 0a20 2020 2020 2020 2073  _what..        s
-00006cb0: 656c 662e 6e65 6564 735f 7768 6174 5b74  elf.needs_what[t
-00006cc0: 735d 202d 3d20 310a 2020 2020 2020 2020  s] -= 1.        
-00006cd0: 6966 2073 656c 662e 6e65 6564 735f 7768  if self.needs_wh
-00006ce0: 6174 5b74 735d 203d 3d20 303a 0a20 2020  at[ts] == 0:.   
-00006cf0: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
-00006d00: 662e 6e65 6564 735f 7768 6174 5b74 735d  f.needs_what[ts]
-00006d10: 0a20 2020 2020 2020 2020 2020 206e 6279  .            nby
-00006d20: 7465 7320 3d20 7473 2e67 6574 5f6e 6279  tes = ts.get_nby
-00006d30: 7465 7328 290a 2020 2020 2020 2020 2020  tes().          
-00006d40: 2020 7365 6c66 2e5f 6e65 7477 6f72 6b5f    self._network_
-00006d50: 6f63 6320 2d3d 206e 6279 7465 730a 2020  occ -= nbytes.  
-00006d60: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
-00006d70: 6368 6564 756c 6572 2e5f 6e65 7477 6f72  cheduler._networ
-00006d80: 6b5f 6f63 635f 676c 6f62 616c 202d 3d20  k_occ_global -= 
-00006d90: 6e62 7974 6573 0a0a 2020 2020 6465 6620  nbytes..    def 
-00006da0: 6164 645f 7265 706c 6963 6128 7365 6c66  add_replica(self
-00006db0: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
-00006dc0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00006dd0: 2020 2222 2254 6865 2077 6f72 6b65 7220    """The worker 
-00006de0: 6163 7175 6972 6564 2061 2072 6570 6c69  acquired a repli
-00006df0: 6361 206f 6620 7461 736b 2222 220a 2020  ca of task""".  
-00006e00: 2020 2020 2020 6966 2074 732e 7768 6f5f        if ts.who_
-00006e10: 6861 7320 6973 204e 6f6e 653a 0a20 2020  has is None:.   
-00006e20: 2020 2020 2020 2020 2074 732e 7768 6f5f           ts.who_
-00006e30: 6861 7320 3d20 7365 7428 290a 2020 2020  has = set().    
-00006e40: 2020 2020 6966 2074 7320 696e 2073 656c      if ts in sel
-00006e50: 662e 5f68 6173 5f77 6861 743a 0a20 2020  f._has_what:.   
-00006e60: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00006e70: 2020 2020 2020 2020 6e62 7974 6573 203d          nbytes =
-00006e80: 2074 732e 6765 745f 6e62 7974 6573 2829   ts.get_nbytes()
-00006e90: 0a20 2020 2020 2020 2069 6620 7473 2069  .        if ts i
-00006ea0: 6e20 7365 6c66 2e6e 6565 6473 5f77 6861  n self.needs_wha
-00006eb0: 743a 0a20 2020 2020 2020 2020 2020 2064  t:.            d
-00006ec0: 656c 2073 656c 662e 6e65 6564 735f 7768  el self.needs_wh
-00006ed0: 6174 5b74 735d 0a20 2020 2020 2020 2020  at[ts].         
-00006ee0: 2020 2073 656c 662e 5f6e 6574 776f 726b     self._network
-00006ef0: 5f6f 6363 202d 3d20 6e62 7974 6573 0a20  _occ -= nbytes. 
-00006f00: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00006f10: 7363 6865 6475 6c65 722e 5f6e 6574 776f  scheduler._netwo
-00006f20: 726b 5f6f 6363 5f67 6c6f 6261 6c20 2d3d  rk_occ_global -=
-00006f30: 206e 6279 7465 730a 2020 2020 2020 2020   nbytes.        
-00006f40: 7473 2e77 686f 5f68 6173 2e61 6464 2873  ts.who_has.add(s
-00006f50: 656c 6629 0a20 2020 2020 2020 2073 656c  elf).        sel
-00006f60: 662e 6e62 7974 6573 202b 3d20 6e62 7974  f.nbytes += nbyt
-00006f70: 6573 0a20 2020 2020 2020 2073 656c 662e  es.        self.
-00006f80: 5f68 6173 5f77 6861 745b 7473 5d20 3d20  _has_what[ts] = 
-00006f90: 4e6f 6e65 0a0a 2020 2020 4070 726f 7065  None..    @prope
-00006fa0: 7274 790a 2020 2020 6465 6620 6f63 6375  rty.    def occu
-00006fb0: 7061 6e63 7928 7365 6c66 2920 2d3e 2066  pancy(self) -> f
-00006fc0: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
-00006fd0: 7475 726e 2073 656c 662e 5f6f 6363 7570  turn self._occup
-00006fe0: 616e 6379 5f63 6163 6865 206f 7220 7365  ancy_cache or se
-00006ff0: 6c66 2e73 6368 6564 756c 6572 2e5f 6361  lf.scheduler._ca
-00007000: 6c63 5f6f 6363 7570 616e 6379 280a 2020  lc_occupancy(.  
-00007010: 2020 2020 2020 2020 2020 7365 6c66 2e74            self.t
-00007020: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
-00007030: 2c20 7365 6c66 2e5f 6e65 7477 6f72 6b5f  , self._network_
-00007040: 6f63 630a 2020 2020 2020 2020 290a 0a0a  occ.        )...
-00007050: 4064 6174 6163 6c61 7373 6573 2e64 6174  @dataclasses.dat
-00007060: 6163 6c61 7373 0a63 6c61 7373 2045 7272  aclass.class Err
-00007070: 6564 5461 736b 3a0a 2020 2020 2222 224c  edTask:.    """L
-00007080: 6967 6874 7765 6967 6874 2072 6570 7265  ightweight repre
-00007090: 7365 6e74 6174 696f 6e20 6f66 2061 6e20  sentation of an 
-000070a0: 6572 7265 6420 7461 736b 2077 6974 686f  erred task witho
-000070b0: 7574 2061 6e79 2064 6570 656e 6465 6e63  ut any dependenc
-000070c0: 7920 696e 666f 726d 6174 696f 6e0a 2020  y information.  
-000070d0: 2020 6f72 2072 756e 7370 6563 2e0a 0a20    or runspec... 
-000070e0: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
-000070f0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2054 6173  --------.    Tas
-00007100: 6b53 7461 7465 0a20 2020 2022 2222 0a0a  kState.    """..
-00007110: 2020 2020 6b65 793a 2048 6173 6861 626c      key: Hashabl
-00007120: 650a 2020 2020 7469 6d65 7374 616d 703a  e.    timestamp:
-00007130: 2066 6c6f 6174 0a20 2020 2065 7272 6564   float.    erred
-00007140: 5f6f 6e3a 2073 6574 5b73 7472 5d0a 2020  _on: set[str].  
-00007150: 2020 6578 6365 7074 696f 6e5f 7465 7874    exception_text
-00007160: 3a20 7374 720a 2020 2020 7472 6163 6562  : str.    traceb
-00007170: 6163 6b5f 7465 7874 3a20 7374 720a 0a0a  ack_text: str...
-00007180: 636c 6173 7320 436f 6d70 7574 6174 696f  class Computatio
-00007190: 6e3a 0a20 2020 2022 2222 436f 6c6c 6563  n:.    """Collec
-000071a0: 7469 6f6e 2074 7261 636b 696e 6720 6120  tion tracking a 
-000071b0: 7369 6e67 6c65 2063 6f6d 7075 7465 206f  single compute o
-000071c0: 7220 7065 7273 6973 7420 6361 6c6c 0a0a  r persist call..
-000071d0: 2020 2020 4445 5052 4543 4154 4544 3a20      DEPRECATED: 
-000071e0: 706c 6561 7365 2075 7365 2073 7061 6e73  please use spans
-000071f0: 2069 6e73 7465 6164 0a0a 2020 2020 5365   instead..    Se
-00007200: 6520 616c 736f 0a20 2020 202d 2d2d 2d2d  e also.    -----
-00007210: 2d2d 2d0a 2020 2020 5461 736b 5072 6566  ---.    TaskPref
-00007220: 6978 0a20 2020 2054 6173 6b47 726f 7570  ix.    TaskGroup
-00007230: 0a20 2020 2054 6173 6b53 7461 7465 0a20  .    TaskState. 
-00007240: 2020 2022 2222 0a0a 2020 2020 7374 6172     """..    star
-00007250: 743a 2066 6c6f 6174 0a20 2020 2067 726f  t: float.    gro
-00007260: 7570 733a 2073 6574 5b54 6173 6b47 726f  ups: set[TaskGro
-00007270: 7570 5d0a 2020 2020 636f 6465 3a20 536f  up].    code: So
-00007280: 7274 6564 5365 745b 7475 706c 655b 536f  rtedSet[tuple[So
-00007290: 7572 6365 436f 6465 2c20 2e2e 2e5d 5d0a  urceCode, ...]].
-000072a0: 2020 2020 6964 3a20 7575 6964 2e55 5549      id: uuid.UUI
-000072b0: 440a 2020 2020 616e 6e6f 7461 7469 6f6e  D.    annotation
-000072c0: 733a 2064 6963 740a 0a20 2020 205f 5f73  s: dict..    __s
-000072d0: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
-000072e0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
-000072f0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00007300: 5f28 7365 6c66 293a 0a20 2020 2020 2020  _(self):.       
-00007310: 2073 656c 662e 7374 6172 7420 3d20 7469   self.start = ti
-00007320: 6d65 2829 0a20 2020 2020 2020 2073 656c  me().        sel
-00007330: 662e 6772 6f75 7073 203d 2073 6574 2829  f.groups = set()
-00007340: 0a20 2020 2020 2020 2073 656c 662e 636f  .        self.co
-00007350: 6465 203d 2053 6f72 7465 6453 6574 2829  de = SortedSet()
-00007360: 0a20 2020 2020 2020 2073 656c 662e 6964  .        self.id
-00007370: 203d 2075 7569 642e 7575 6964 3428 290a   = uuid.uuid4().
-00007380: 2020 2020 2020 2020 7365 6c66 2e61 6e6e          self.ann
-00007390: 6f74 6174 696f 6e73 203d 207b 7d0a 0a20  otations = {}.. 
-000073a0: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-000073b0: 2064 6566 2073 746f 7028 7365 6c66 2920   def stop(self) 
-000073c0: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
-000073d0: 2020 6966 2073 656c 662e 6772 6f75 7073    if self.groups
-000073e0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000073f0: 7475 726e 206d 6178 2874 672e 7374 6f70  turn max(tg.stop
-00007400: 2066 6f72 2074 6720 696e 2073 656c 662e   for tg in self.
-00007410: 6772 6f75 7073 290a 2020 2020 2020 2020  groups).        
-00007420: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00007430: 2020 7265 7475 726e 202d 310a 0a20 2020    return -1..   
-00007440: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00007450: 6566 2073 7461 7465 7328 7365 6c66 2920  ef states(self) 
-00007460: 2d3e 2064 6963 745b 5461 736b 5374 6174  -> dict[TaskStat
-00007470: 6553 7461 7465 2c20 696e 745d 3a0a 2020  eState, int]:.  
-00007480: 2020 2020 2020 7265 7475 726e 206d 6572        return mer
-00007490: 6765 5f77 6974 6828 7375 6d2c 2028 7467  ge_with(sum, (tg
-000074a0: 2e73 7461 7465 7320 666f 7220 7467 2069  .states for tg i
-000074b0: 6e20 7365 6c66 2e67 726f 7570 7329 290a  n self.groups)).
-000074c0: 0a20 2020 2064 6566 205f 5f72 6570 725f  .    def __repr_
-000074d0: 5f28 7365 6c66 2920 2d3e 2073 7472 3a0a  _(self) -> str:.
-000074e0: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-000074f0: 0a20 2020 2020 2020 2020 2020 2066 223c  .            f"<
-00007500: 436f 6d70 7574 6174 696f 6e20 7b73 656c  Computation {sel
-00007510: 662e 6964 7d3a 2022 0a20 2020 2020 2020  f.id}: ".       
-00007520: 2020 2020 202b 2022 5461 736b 733a 2022       + "Tasks: "
-00007530: 0a20 2020 2020 2020 2020 2020 202b 2022  .            + "
-00007540: 2c20 222e 6a6f 696e 280a 2020 2020 2020  , ".join(.      
-00007550: 2020 2020 2020 2020 2020 2225 733a 2025            "%s: %
-00007560: 6422 2025 2028 6b2c 2076 2920 666f 7220  d" % (k, v) for 
-00007570: 286b 2c20 7629 2069 6e20 736f 7274 6564  (k, v) in sorted
-00007580: 2873 656c 662e 7374 6174 6573 2e69 7465  (self.states.ite
-00007590: 6d73 2829 2920 6966 2076 0a20 2020 2020  ms()) if v.     
-000075a0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000075b0: 2020 2020 202b 2022 3e22 0a20 2020 2020       + ">".     
-000075c0: 2020 2029 0a0a 2020 2020 6465 6620 5f72     )..    def _r
-000075d0: 6570 725f 6874 6d6c 5f28 7365 6c66 2920  epr_html_(self) 
-000075e0: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-000075f0: 7265 7475 726e 2067 6574 5f74 656d 706c  return get_templ
-00007600: 6174 6528 2263 6f6d 7075 7461 7469 6f6e  ate("computation
-00007610: 2e68 746d 6c2e 6a32 2229 2e72 656e 6465  .html.j2").rende
-00007620: 7228 0a20 2020 2020 2020 2020 2020 2069  r(.            i
-00007630: 643d 7365 6c66 2e69 642c 0a20 2020 2020  d=self.id,.     
-00007640: 2020 2020 2020 2073 7461 7274 3d73 656c         start=sel
-00007650: 662e 7374 6172 742c 0a20 2020 2020 2020  f.start,.       
-00007660: 2020 2020 2073 746f 703d 7365 6c66 2e73       stop=self.s
-00007670: 746f 702c 0a20 2020 2020 2020 2020 2020  top,.           
-00007680: 2067 726f 7570 733d 7365 6c66 2e67 726f   groups=self.gro
-00007690: 7570 732c 0a20 2020 2020 2020 2020 2020  ups,.           
-000076a0: 2073 7461 7465 733d 7365 6c66 2e73 7461   states=self.sta
-000076b0: 7465 732c 0a20 2020 2020 2020 2020 2020  tes,.           
-000076c0: 2063 6f64 653d 7365 6c66 2e63 6f64 652c   code=self.code,
-000076d0: 0a20 2020 2020 2020 2029 0a0a 0a63 6c61  .        )...cla
-000076e0: 7373 2054 6173 6b50 7265 6669 783a 0a20  ss TaskPrefix:. 
-000076f0: 2020 2022 2222 436f 6c6c 6563 7469 6f6e     """Collection
-00007700: 2074 7261 636b 696e 6720 616c 6c20 7461   tracking all ta
-00007710: 736b 7320 7769 7468 696e 2061 2067 726f  sks within a gro
-00007720: 7570 0a0a 2020 2020 4b65 7973 206f 6674  up..    Keys oft
-00007730: 656e 2068 6176 6520 6120 7374 7275 6374  en have a struct
-00007740: 7572 6520 6c69 6b65 2060 6028 2278 2d31  ure like ``("x-1
-00007750: 3233 222c 2030 2960 600a 2020 2020 4120  23", 0)``.    A 
-00007760: 6772 6f75 7020 7461 6b65 7320 7468 6520  group takes the 
-00007770: 6669 7273 7420 7365 6374 696f 6e2c 206c  first section, l
-00007780: 696b 6520 6060 2278 2260 600a 0a20 2020  ike ``"x"``..   
-00007790: 2053 6565 2041 6c73 6f0a 2020 2020 2d2d   See Also.    --
-000077a0: 2d2d 2d2d 2d2d 0a20 2020 2054 6173 6b47  ------.    TaskG
-000077b0: 726f 7570 0a20 2020 2022 2222 0a0a 2020  roup.    """..  
-000077c0: 2020 233a 2054 6865 206e 616d 6520 6f66    #: The name of
-000077d0: 2061 2067 726f 7570 206f 6620 7461 736b   a group of task
-000077e0: 732e 0a20 2020 2023 3a20 466f 7220 6120  s..    #: For a 
-000077f0: 7461 736b 206c 696b 6520 6060 2822 782d  task like ``("x-
-00007800: 3132 3322 2c20 3029 6060 2074 6869 7320  123", 0)`` this 
-00007810: 6973 2074 6865 2074 6578 7420 6060 2278  is the text ``"x
-00007820: 2260 600a 2020 2020 6e61 6d65 3a20 7374  "``.    name: st
-00007830: 720a 0a20 2020 2023 3a20 416e 2065 7870  r..    #: An exp
-00007840: 6f6e 656e 7469 616c 6c79 2077 6569 6768  onentially weigh
-00007850: 7465 6420 6d6f 7669 6e67 2061 7665 7261  ted moving avera
-00007860: 6765 2064 7572 6174 696f 6e20 6f66 2061  ge duration of a
-00007870: 6c6c 2074 6173 6b73 2077 6974 6820 7468  ll tasks with th
-00007880: 6973 2070 7265 6669 780a 2020 2020 6475  is prefix.    du
-00007890: 7261 7469 6f6e 5f61 7665 7261 6765 3a20  ration_average: 
-000078a0: 666c 6f61 740a 0a20 2020 2023 3a20 4e75  float..    #: Nu
-000078b0: 6d62 6572 7320 6f66 2074 696d 6573 2061  mbers of times a
-000078c0: 2074 6173 6b20 7761 7320 6d61 726b 6564   task was marked
-000078d0: 2061 7320 7375 7370 6963 696f 7573 2077   as suspicious w
-000078e0: 6974 6820 7468 6973 2070 7265 6669 780a  ith this prefix.
-000078f0: 2020 2020 7375 7370 6963 696f 7573 3a20      suspicious: 
-00007900: 696e 740a 0a20 2020 2023 3a20 5374 6f72  int..    #: Stor
-00007910: 6520 7469 6d69 6e67 7320 666f 7220 6561  e timings for ea
-00007920: 6368 2070 7265 6669 782d 6163 7469 6f6e  ch prefix-action
-00007930: 0a20 2020 2061 6c6c 5f64 7572 6174 696f  .    all_duratio
-00007940: 6e73 3a20 6465 6661 756c 7464 6963 745b  ns: defaultdict[
-00007950: 7374 722c 2066 6c6f 6174 5d0a 0a20 2020  str, float]..   
-00007960: 2023 3a20 5468 6973 206d 6561 7375 7265   #: This measure
-00007970: 7320 7468 6520 6d61 7869 6d75 6d20 7265  s the maximum re
-00007980: 636f 7264 6564 206c 6976 6520 6578 6563  corded live exec
-00007990: 7574 696f 6e20 7469 6d65 2061 6e64 2063  ution time and c
-000079a0: 616e 2062 6520 7573 6564 2074 6f0a 2020  an be used to.  
-000079b0: 2020 233a 2064 6574 6563 7420 6f75 746c    #: detect outl
-000079c0: 6965 7273 0a20 2020 206d 6178 5f65 7865  iers.    max_exe
-000079d0: 635f 7469 6d65 3a20 666c 6f61 740a 0a20  c_time: float.. 
-000079e0: 2020 2023 3a20 5461 736b 2067 726f 7570     #: Task group
-000079f0: 7320 6173 736f 6369 6174 6564 2074 6f20  s associated to 
-00007a00: 7468 6973 2070 7265 6669 780a 2020 2020  this prefix.    
-00007a10: 6772 6f75 7073 3a20 6c69 7374 5b54 6173  groups: list[Tas
-00007a20: 6b47 726f 7570 5d0a 0a20 2020 2023 3a20  kGroup]..    #: 
-00007a30: 4163 6375 6d75 6c61 7465 2063 6f75 6e74  Accumulate count
-00007a40: 206f 6620 6e75 6d62 6572 206f 6620 7461   of number of ta
-00007a50: 736b 7320 696e 2065 6163 6820 7374 6174  sks in each stat
-00007a60: 650a 2020 2020 7374 6174 655f 636f 756e  e.    state_coun
-00007a70: 7473 3a20 6465 6661 756c 7464 6963 745b  ts: defaultdict[
-00007a80: 5461 736b 5374 6174 6553 7461 7465 2c20  TaskStateState, 
-00007a90: 696e 745d 0a0a 2020 2020 5f5f 736c 6f74  int]..    __slot
-00007aa0: 735f 5f20 3d20 7475 706c 6528 5f5f 616e  s__ = tuple(__an
-00007ab0: 6e6f 7461 7469 6f6e 735f 5f29 0a0a 2020  notations__)..  
-00007ac0: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00007ad0: 656c 662c 206e 616d 653a 2073 7472 293a  elf, name: str):
-00007ae0: 0a20 2020 2020 2020 2073 656c 662e 6e61  .        self.na
-00007af0: 6d65 203d 206e 616d 650a 2020 2020 2020  me = name.      
-00007b00: 2020 7365 6c66 2e67 726f 7570 7320 3d20    self.groups = 
-00007b10: 5b5d 0a20 2020 2020 2020 2073 656c 662e  [].        self.
-00007b20: 616c 6c5f 6475 7261 7469 6f6e 7320 3d20  all_durations = 
-00007b30: 6465 6661 756c 7464 6963 7428 666c 6f61  defaultdict(floa
-00007b40: 7429 0a20 2020 2020 2020 2073 656c 662e  t).        self.
-00007b50: 7374 6174 655f 636f 756e 7473 203d 2064  state_counts = d
-00007b60: 6566 6175 6c74 6469 6374 2869 6e74 290a  efaultdict(int).
-00007b70: 2020 2020 2020 2020 7461 736b 5f64 7572          task_dur
-00007b80: 6174 696f 6e73 203d 2064 6173 6b2e 636f  ations = dask.co
-00007b90: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
-00007ba0: 6275 7465 642e 7363 6865 6475 6c65 722e  buted.scheduler.
-00007bb0: 6465 6661 756c 742d 7461 736b 2d64 7572  default-task-dur
-00007bc0: 6174 696f 6e73 2229 0a20 2020 2020 2020  ations").       
-00007bd0: 2069 6620 7365 6c66 2e6e 616d 6520 696e   if self.name in
-00007be0: 2074 6173 6b5f 6475 7261 7469 6f6e 733a   task_durations:
-00007bf0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00007c00: 662e 6475 7261 7469 6f6e 5f61 7665 7261  f.duration_avera
-00007c10: 6765 203d 2070 6172 7365 5f74 696d 6564  ge = parse_timed
-00007c20: 656c 7461 2874 6173 6b5f 6475 7261 7469  elta(task_durati
-00007c30: 6f6e 735b 7365 6c66 2e6e 616d 655d 290a  ons[self.name]).
-00007c40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00007c50: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-00007c60: 7572 6174 696f 6e5f 6176 6572 6167 6520  uration_average 
-00007c70: 3d20 2d31 0a20 2020 2020 2020 2073 656c  = -1.        sel
-00007c80: 662e 6d61 785f 6578 6563 5f74 696d 6520  f.max_exec_time 
-00007c90: 3d20 2d31 0a20 2020 2020 2020 2073 656c  = -1.        sel
-00007ca0: 662e 7375 7370 6963 696f 7573 203d 2030  f.suspicious = 0
-00007cb0: 0a0a 2020 2020 6465 6620 6164 645f 6578  ..    def add_ex
-00007cc0: 6563 5f74 696d 6528 7365 6c66 2c20 6475  ec_time(self, du
-00007cd0: 7261 7469 6f6e 3a20 666c 6f61 7429 202d  ration: float) -
-00007ce0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00007cf0: 7365 6c66 2e6d 6178 5f65 7865 635f 7469  self.max_exec_ti
-00007d00: 6d65 203d 206d 6178 2864 7572 6174 696f  me = max(duratio
-00007d10: 6e2c 2073 656c 662e 6d61 785f 6578 6563  n, self.max_exec
-00007d20: 5f74 696d 6529 0a20 2020 2020 2020 2069  _time).        i
-00007d30: 6620 6475 7261 7469 6f6e 203e 2032 202a  f duration > 2 *
-00007d40: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
-00007d50: 7665 7261 6765 3a0a 2020 2020 2020 2020  verage:.        
-00007d60: 2020 2020 7365 6c66 2e64 7572 6174 696f      self.duratio
-00007d70: 6e5f 6176 6572 6167 6520 3d20 2d31 0a0a  n_average = -1..
-00007d80: 2020 2020 6465 6620 6164 645f 6475 7261      def add_dura
-00007d90: 7469 6f6e 2873 656c 662c 2061 6374 696f  tion(self, actio
-00007da0: 6e3a 2073 7472 2c20 7374 6172 743a 2066  n: str, start: f
-00007db0: 6c6f 6174 2c20 7374 6f70 3a20 666c 6f61  loat, stop: floa
-00007dc0: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
-00007dd0: 2020 2020 6475 7261 7469 6f6e 203d 2073      duration = s
-00007de0: 746f 7020 2d20 7374 6172 740a 2020 2020  top - start.    
-00007df0: 2020 2020 7365 6c66 2e61 6c6c 5f64 7572      self.all_dur
-00007e00: 6174 696f 6e73 5b61 6374 696f 6e5d 202b  ations[action] +
-00007e10: 3d20 6475 7261 7469 6f6e 0a20 2020 2020  = duration.     
-00007e20: 2020 2069 6620 6163 7469 6f6e 203d 3d20     if action == 
-00007e30: 2263 6f6d 7075 7465 223a 0a20 2020 2020  "compute":.     
-00007e40: 2020 2020 2020 206f 6c64 203d 2073 656c         old = sel
-00007e50: 662e 6475 7261 7469 6f6e 5f61 7665 7261  f.duration_avera
-00007e60: 6765 0a20 2020 2020 2020 2020 2020 2069  ge.            i
-00007e70: 6620 6f6c 6420 3c20 303a 0a20 2020 2020  f old < 0:.     
-00007e80: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00007e90: 6475 7261 7469 6f6e 5f61 7665 7261 6765  duration_average
-00007ea0: 203d 2064 7572 6174 696f 6e0a 2020 2020   = duration.    
-00007eb0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00007ec0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00007ed0: 6c66 2e64 7572 6174 696f 6e5f 6176 6572  lf.duration_aver
-00007ee0: 6167 6520 3d20 302e 3520 2a20 6475 7261  age = 0.5 * dura
-00007ef0: 7469 6f6e 202b 2030 2e35 202a 206f 6c64  tion + 0.5 * old
-00007f00: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00007f10: 2020 2020 6465 6620 7374 6174 6573 2873      def states(s
-00007f20: 656c 6629 202d 3e20 6469 6374 5b54 6173  elf) -> dict[Tas
-00007f30: 6b53 7461 7465 5374 6174 652c 2069 6e74  kStateState, int
-00007f40: 5d3a 0a20 2020 2020 2020 2022 2222 5468  ]:.        """Th
-00007f50: 6520 6e75 6d62 6572 206f 6620 7461 736b  e number of task
-00007f60: 7320 696e 2065 6163 6820 7374 6174 652c  s in each state,
-00007f70: 0a20 2020 2020 2020 206c 696b 6520 6060  .        like ``
-00007f80: 7b22 6d65 6d6f 7279 223a 2031 302c 2022  {"memory": 10, "
-00007f90: 7072 6f63 6573 7369 6e67 223a 2033 2c20  processing": 3, 
-00007fa0: 2272 656c 6561 7365 6422 3a20 342c 202e  "released": 4, .
-00007fb0: 2e2e 7d60 600a 2020 2020 2020 2020 2222  ..}``.        ""
-00007fc0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-00007fd0: 206d 6572 6765 5f77 6974 6828 7375 6d2c   merge_with(sum,
-00007fe0: 205b 7467 2e73 7461 7465 7320 666f 7220   [tg.states for 
-00007ff0: 7467 2069 6e20 7365 6c66 2e67 726f 7570  tg in self.group
-00008000: 735d 290a 0a20 2020 2040 7072 6f70 6572  s])..    @proper
-00008010: 7479 0a20 2020 2064 6566 2061 6374 6976  ty.    def activ
-00008020: 6528 7365 6c66 2920 2d3e 206c 6973 745b  e(self) -> list[
-00008030: 5461 736b 4772 6f75 705d 3a0a 2020 2020  TaskGroup]:.    
-00008040: 2020 2020 7265 7475 726e 205b 0a20 2020      return [.   
-00008050: 2020 2020 2020 2020 2074 670a 2020 2020           tg.    
-00008060: 2020 2020 2020 2020 666f 7220 7467 2069          for tg i
-00008070: 6e20 7365 6c66 2e67 726f 7570 730a 2020  n self.groups.  
-00008080: 2020 2020 2020 2020 2020 6966 2061 6e79            if any
-00008090: 286b 2021 3d20 2266 6f72 676f 7474 656e  (k != "forgotten
-000080a0: 2220 616e 6420 7620 213d 2030 2066 6f72  " and v != 0 for
-000080b0: 206b 2c20 7620 696e 2074 672e 7374 6174   k, v in tg.stat
-000080c0: 6573 2e69 7465 6d73 2829 290a 2020 2020  es.items()).    
-000080d0: 2020 2020 5d0a 0a20 2020 2040 7072 6f70      ]..    @prop
-000080e0: 6572 7479 0a20 2020 2064 6566 2061 6374  erty.    def act
-000080f0: 6976 655f 7374 6174 6573 2873 656c 6629  ive_states(self)
-00008100: 202d 3e20 6469 6374 5b54 6173 6b53 7461   -> dict[TaskSta
-00008110: 7465 5374 6174 652c 2069 6e74 5d3a 0a20  teState, int]:. 
-00008120: 2020 2020 2020 2072 6574 7572 6e20 6d65         return me
-00008130: 7267 655f 7769 7468 2873 756d 2c20 5b74  rge_with(sum, [t
-00008140: 672e 7374 6174 6573 2066 6f72 2074 6720  g.states for tg 
-00008150: 696e 2073 656c 662e 6163 7469 7665 5d29  in self.active])
-00008160: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
-00008170: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
-00008180: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00008190: 280a 2020 2020 2020 2020 2020 2020 223c  (.            "<
-000081a0: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
-000081b0: 7365 6c66 2e6e 616d 650a 2020 2020 2020  self.name.      
-000081c0: 2020 2020 2020 2b20 223a 2022 0a20 2020        + ": ".   
-000081d0: 2020 2020 2020 2020 202b 2022 2c20 222e           + ", ".
-000081e0: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-000081f0: 2020 2020 2020 2225 733a 2025 6422 2025        "%s: %d" %
-00008200: 2028 6b2c 2076 2920 666f 7220 286b 2c20   (k, v) for (k, 
-00008210: 7629 2069 6e20 736f 7274 6564 2873 656c  v) in sorted(sel
-00008220: 662e 7374 6174 6573 2e69 7465 6d73 2829  f.states.items()
-00008230: 2920 6966 2076 0a20 2020 2020 2020 2020  ) if v.         
-00008240: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00008250: 202b 2022 3e22 0a20 2020 2020 2020 2029   + ">".        )
-00008260: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-00008270: 2020 2020 6465 6620 6e62 7974 6573 5f74      def nbytes_t
-00008280: 6f74 616c 2873 656c 6629 202d 3e20 696e  otal(self) -> in
-00008290: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
-000082a0: 6e20 7375 6d28 7467 2e6e 6279 7465 735f  n sum(tg.nbytes_
-000082b0: 746f 7461 6c20 666f 7220 7467 2069 6e20  total for tg in 
-000082c0: 7365 6c66 2e67 726f 7570 7329 0a0a 2020  self.groups)..  
-000082d0: 2020 6465 6620 5f5f 6c65 6e5f 5f28 7365    def __len__(se
-000082e0: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
-000082f0: 2020 2020 7265 7475 726e 2073 756d 286d      return sum(m
-00008300: 6170 286c 656e 2c20 7365 6c66 2e67 726f  ap(len, self.gro
-00008310: 7570 7329 290a 0a20 2020 2040 7072 6f70  ups))..    @prop
-00008320: 6572 7479 0a20 2020 2064 6566 2064 7572  erty.    def dur
-00008330: 6174 696f 6e28 7365 6c66 2920 2d3e 2066  ation(self) -> f
-00008340: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
-00008350: 7475 726e 2073 756d 2874 672e 6475 7261  turn sum(tg.dura
-00008360: 7469 6f6e 2066 6f72 2074 6720 696e 2073  tion for tg in s
-00008370: 656c 662e 6772 6f75 7073 290a 0a20 2020  elf.groups)..   
-00008380: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00008390: 6566 2074 7970 6573 2873 656c 6629 202d  ef types(self) -
-000083a0: 3e20 7365 745b 7374 725d 3a0a 2020 2020  > set[str]:.    
-000083b0: 2020 2020 7265 7475 726e 207b 7479 7020      return {typ 
-000083c0: 666f 7220 7467 2069 6e20 7365 6c66 2e67  for tg in self.g
-000083d0: 726f 7570 7320 666f 7220 7479 7020 696e  roups for typ in
-000083e0: 2074 672e 7479 7065 737d 0a0a 0a63 6c61   tg.types}...cla
-000083f0: 7373 2054 6173 6b47 726f 7570 3a0a 2020  ss TaskGroup:.  
-00008400: 2020 2222 2243 6f6c 6c65 6374 696f 6e20    """Collection 
-00008410: 7472 6163 6b69 6e67 2061 6c6c 2074 6173  tracking all tas
-00008420: 6b73 2077 6974 6869 6e20 6120 6772 6f75  ks within a grou
-00008430: 700a 0a20 2020 204b 6579 7320 6f66 7465  p..    Keys ofte
-00008440: 6e20 6861 7665 2061 2073 7472 7563 7475  n have a structu
-00008450: 7265 206c 696b 6520 6060 2822 782d 3132  re like ``("x-12
-00008460: 3322 2c20 3029 6060 0a20 2020 2041 2067  3", 0)``.    A g
-00008470: 726f 7570 2074 616b 6573 2074 6865 2066  roup takes the f
-00008480: 6972 7374 2073 6563 7469 6f6e 2c20 6c69  irst section, li
-00008490: 6b65 2060 6022 782d 3132 3322 6060 0a0a  ke ``"x-123"``..
-000084a0: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
-000084b0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 5461   --------.    Ta
-000084c0: 736b 5072 6566 6978 0a20 2020 2022 2222  skPrefix.    """
-000084d0: 0a0a 2020 2020 233a 2054 6865 206e 616d  ..    #: The nam
-000084e0: 6520 6f66 2061 2067 726f 7570 206f 6620  e of a group of 
-000084f0: 7461 736b 732e 0a20 2020 2023 3a20 466f  tasks..    #: Fo
-00008500: 7220 6120 7461 736b 206c 696b 6520 6060  r a task like ``
-00008510: 2822 782d 3132 3322 2c20 3029 6060 2074  ("x-123", 0)`` t
-00008520: 6869 7320 6973 2074 6865 2074 6578 7420  his is the text 
-00008530: 6060 2278 2d31 3233 2260 600a 2020 2020  ``"x-123"``.    
-00008540: 6e61 6d65 3a20 7374 720a 0a20 2020 2023  name: str..    #
-00008550: 3a20 5468 6520 6e75 6d62 6572 206f 6620  : The number of 
-00008560: 7461 736b 7320 696e 2065 6163 6820 7374  tasks in each st
-00008570: 6174 652c 0a20 2020 2023 3a20 6c69 6b65  ate,.    #: like
-00008580: 2060 607b 226d 656d 6f72 7922 3a20 3130   ``{"memory": 10
-00008590: 2c20 2270 726f 6365 7373 696e 6722 3a20  , "processing": 
-000085a0: 332c 2022 7265 6c65 6173 6564 223a 2034  3, "released": 4
-000085b0: 2c20 2e2e 2e7d 6060 0a20 2020 2073 7461  , ...}``.    sta
-000085c0: 7465 733a 2064 6963 745b 5461 736b 5374  tes: dict[TaskSt
-000085d0: 6174 6553 7461 7465 2c20 696e 745d 0a0a  ateState, int]..
-000085e0: 2020 2020 233a 2054 6865 206f 7468 6572      #: The other
-000085f0: 2054 6173 6b47 726f 7570 7320 6f6e 2077   TaskGroups on w
-00008600: 6869 6368 2074 6869 7320 6f6e 6520 6465  hich this one de
-00008610: 7065 6e64 730a 2020 2020 6465 7065 6e64  pends.    depend
-00008620: 656e 6369 6573 3a20 7365 745b 5461 736b  encies: set[Task
-00008630: 4772 6f75 705d 0a0a 2020 2020 233a 2054  Group]..    #: T
-00008640: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
-00008650: 6f66 2062 7974 6573 2074 6861 7420 7468  of bytes that th
-00008660: 6973 2074 6173 6b20 6772 6f75 7020 6861  is task group ha
-00008670: 7320 7072 6f64 7563 6564 0a20 2020 206e  s produced.    n
-00008680: 6279 7465 735f 746f 7461 6c3a 2069 6e74  bytes_total: int
-00008690: 0a0a 2020 2020 233a 2054 6865 2074 6f74  ..    #: The tot
-000086a0: 616c 2061 6d6f 756e 7420 6f66 2074 696d  al amount of tim
-000086b0: 6520 7370 656e 7420 6f6e 2061 6c6c 2074  e spent on all t
-000086c0: 6173 6b73 2069 6e20 7468 6973 2054 6173  asks in this Tas
-000086d0: 6b47 726f 7570 0a20 2020 2064 7572 6174  kGroup.    durat
-000086e0: 696f 6e3a 2066 6c6f 6174 0a0a 2020 2020  ion: float..    
-000086f0: 233a 2054 6865 2072 6573 756c 7420 7479  #: The result ty
-00008700: 7065 7320 6f66 2074 6869 7320 5461 736b  pes of this Task
-00008710: 4772 6f75 700a 2020 2020 7479 7065 733a  Group.    types:
-00008720: 2073 6574 5b73 7472 5d0a 0a20 2020 2023   set[str]..    #
-00008730: 3a20 5468 6520 776f 726b 6572 206d 6f73  : The worker mos
-00008740: 7420 7265 6365 6e74 6c79 2061 7373 6967  t recently assig
-00008750: 6e65 6420 6120 7461 736b 2066 726f 6d20  ned a task from 
-00008760: 7468 6973 2067 726f 7570 2c20 6f72 204e  this group, or N
-00008770: 6f6e 6520 7768 656e 2074 6865 2067 726f  one when the gro
-00008780: 7570 0a20 2020 2023 3a20 6973 206e 6f74  up.    #: is not
-00008790: 2069 6465 6e74 6966 6965 6420 746f 2062   identified to b
-000087a0: 6520 726f 6f74 2d6c 696b 6520 6279 2060  e root-like by `
-000087b0: 5363 6865 6475 6c65 7253 7461 7465 2e64  SchedulerState.d
-000087c0: 6563 6964 655f 776f 726b 6572 602e 0a20  ecide_worker`.. 
-000087d0: 2020 206c 6173 745f 776f 726b 6572 3a20     last_worker: 
-000087e0: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
-000087f0: 6e65 0a0a 2020 2020 233a 2049 6620 606c  ne..    #: If `l
-00008800: 6173 745f 776f 726b 6572 6020 6973 206e  ast_worker` is n
-00008810: 6f74 204e 6f6e 652c 2074 6865 206e 756d  ot None, the num
-00008820: 6265 7220 6f66 2074 696d 6573 2074 6861  ber of times tha
-00008830: 7420 776f 726b 6572 2073 686f 756c 6420  t worker should 
-00008840: 6265 2061 7373 6967 6e65 640a 2020 2020  be assigned.    
-00008850: 233a 2073 7562 7365 7175 656e 7420 7461  #: subsequent ta
-00008860: 736b 7320 756e 7469 6c20 6120 6e65 7720  sks until a new 
-00008870: 776f 726b 6572 2069 7320 6368 6f73 656e  worker is chosen
-00008880: 2e0a 2020 2020 6c61 7374 5f77 6f72 6b65  ..    last_worke
-00008890: 725f 7461 736b 735f 6c65 6674 3a20 696e  r_tasks_left: in
-000088a0: 740a 0a20 2020 2070 7265 6669 783a 2054  t..    prefix: T
-000088b0: 6173 6b50 7265 6669 7820 7c20 4e6f 6e65  askPrefix | None
-000088c0: 0a0a 2020 2020 233a 2045 6172 6c69 6573  ..    #: Earlies
-000088d0: 7420 7469 6d65 2077 6865 6e20 6120 7461  t time when a ta
-000088e0: 736b 2062 656c 6f6e 6769 6e67 2074 6f20  sk belonging to 
-000088f0: 7468 6973 2067 726f 7570 2073 7461 7274  this group start
-00008900: 6564 2063 6f6d 7075 7469 6e67 3b0a 2020  ed computing;.  
-00008910: 2020 233a 2030 2069 6620 6e6f 2074 6173    #: 0 if no tas
-00008920: 6b20 6861 7320 2a66 696e 6973 6865 642a  k has *finished*
-00008930: 2063 6f6d 7075 7469 6e67 2079 6574 0a20   computing yet. 
-00008940: 2020 2023 3a0a 2020 2020 233a 204e 6f74     #:.    #: Not
-00008950: 6573 0a20 2020 2023 3a20 2d2d 2d2d 2d0a  es.    #: -----.
-00008960: 2020 2020 233a 2054 6869 7320 6973 206e      #: This is n
-00008970: 6f74 2075 7064 6174 6564 2075 6e74 696c  ot updated until
-00008980: 2061 7420 6c65 6173 7420 6f6e 6520 7461   at least one ta
-00008990: 736b 2068 6173 202a 6669 6e69 7368 6564  sk has *finished
-000089a0: 2a20 636f 6d70 7574 696e 672e 0a20 2020  * computing..   
-000089b0: 2023 3a20 4974 2063 6f75 6c64 206d 6f76   #: It could mov
-000089c0: 6520 6261 636b 7761 7264 7320 6173 2074  e backwards as t
-000089d0: 6173 6b73 2063 6f6d 706c 6574 652e 0a20  asks complete.. 
-000089e0: 2020 2073 7461 7274 3a20 666c 6f61 740a     start: float.
-000089f0: 0a20 2020 2023 3a20 4c61 7465 7374 2074  .    #: Latest t
-00008a00: 696d 6520 7768 656e 2061 2074 6173 6b20  ime when a task 
-00008a10: 6265 6c6f 6e67 696e 6720 746f 2074 6869  belonging to thi
-00008a20: 7320 6772 6f75 7020 6669 6e69 7368 6564  s group finished
-00008a30: 2063 6f6d 7075 7469 6e67 2c0a 2020 2020   computing,.    
-00008a40: 233a 2030 2069 6620 6e6f 2074 6173 6b20  #: 0 if no task 
-00008a50: 6861 7320 6669 6e69 7368 6564 2063 6f6d  has finished com
-00008a60: 7075 7469 6e67 2079 6574 0a20 2020 2073  puting yet.    s
-00008a70: 746f 703a 2066 6c6f 6174 0a0a 2020 2020  top: float..    
-00008a80: 233a 2043 756d 756c 6174 6976 6520 6475  #: Cumulative du
-00008a90: 7261 7469 6f6e 206f 6620 616c 6c20 636f  ration of all co
-00008aa0: 6d70 6c65 7465 6420 6163 7469 6f6e 732c  mpleted actions,
-00008ab0: 2062 7920 6163 7469 6f6e 0a20 2020 2061   by action.    a
-00008ac0: 6c6c 5f64 7572 6174 696f 6e73 3a20 6465  ll_durations: de
-00008ad0: 6661 756c 7464 6963 745b 7374 722c 2066  faultdict[str, f
-00008ae0: 6c6f 6174 5d0a 0a20 2020 2023 3a20 5370  loat]..    #: Sp
-00008af0: 616e 2049 4420 2873 6565 2060 6064 6973  an ID (see ``dis
-00008b00: 7472 6962 7574 6564 2e73 7061 6e73 6060  tributed.spans``
-00008b10: 292e 0a20 2020 2023 3a20 4d61 7463 6865  )..    #: Matche
-00008b20: 7320 6060 6469 7374 7269 6275 7465 642e  s ``distributed.
-00008b30: 776f 726b 6572 5f73 7461 7465 5f6d 6163  worker_state_mac
-00008b40: 6869 6e65 2e54 6173 6b53 7461 7465 2e73  hine.TaskState.s
-00008b50: 7061 6e5f 6964 6060 2e0a 2020 2020 233a  pan_id``..    #:
-00008b60: 2049 7420 6973 2070 6f73 7369 626c 6520   It is possible 
-00008b70: 746f 2065 6e64 2075 7020 696e 2073 6974  to end up in sit
-00008b80: 7561 7469 6f6e 2077 6865 7265 2064 6966  uation where dif
-00008b90: 6665 7265 6e74 2074 6173 6b73 206f 6620  ferent tasks of 
-00008ba0: 7468 6520 7361 6d65 2054 6173 6b47 726f  the same TaskGro
-00008bb0: 7570 0a20 2020 2023 3a20 6265 6c6f 6e67  up.    #: belong
-00008bc0: 2074 6f20 6469 6666 6572 656e 7420 7370   to different sp
-00008bd0: 616e 733b 2074 6865 2070 7572 706f 7365  ans; the purpose
-00008be0: 206f 6620 7468 6973 2061 7474 7269 6275   of this attribu
-00008bf0: 7465 2069 7320 746f 2061 7262 6974 7261  te is to arbitra
-00008c00: 7269 6c79 2066 6f72 6365 0a20 2020 2023  rily force.    #
-00008c10: 3a20 6576 6572 7974 6869 6e67 206f 6e74  : everything ont
-00008c20: 6f20 7468 6520 6561 726c 6965 7374 2065  o the earliest e
-00008c30: 6e63 6f75 6e74 6572 6564 206f 6e65 2e0a  ncountered one..
-00008c40: 2020 2020 7370 616e 5f69 643a 2073 7472      span_id: str
-00008c50: 207c 204e 6f6e 650a 0a20 2020 205f 5f73   | None..    __s
-00008c60: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
-00008c70: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
-00008c80: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
-00008c90: 5f28 7365 6c66 2c20 6e61 6d65 3a20 7374  _(self, name: st
-00008ca0: 7229 3a0a 2020 2020 2020 2020 7365 6c66  r):.        self
-00008cb0: 2e6e 616d 6520 3d20 6e61 6d65 0a20 2020  .name = name.   
-00008cc0: 2020 2020 2073 656c 662e 7072 6566 6978       self.prefix
-00008cd0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00008ce0: 7365 6c66 2e73 7461 7465 7320 3d20 6469  self.states = di
-00008cf0: 6374 2e66 726f 6d6b 6579 7328 414c 4c5f  ct.fromkeys(ALL_
-00008d00: 5441 534b 5f53 5441 5445 532c 2030 290a  TASK_STATES, 0).
-00008d10: 2020 2020 2020 2020 7365 6c66 2e64 6570          self.dep
-00008d20: 656e 6465 6e63 6965 7320 3d20 7365 7428  endencies = set(
-00008d30: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
-00008d40: 6279 7465 735f 746f 7461 6c20 3d20 300a  bytes_total = 0.
-00008d50: 2020 2020 2020 2020 7365 6c66 2e64 7572          self.dur
-00008d60: 6174 696f 6e20 3d20 300a 2020 2020 2020  ation = 0.      
-00008d70: 2020 7365 6c66 2e74 7970 6573 203d 2073    self.types = s
-00008d80: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
-00008d90: 662e 7374 6172 7420 3d20 302e 300a 2020  f.start = 0.0.  
-00008da0: 2020 2020 2020 7365 6c66 2e73 746f 7020        self.stop 
-00008db0: 3d20 302e 300a 2020 2020 2020 2020 7365  = 0.0.        se
-00008dc0: 6c66 2e61 6c6c 5f64 7572 6174 696f 6e73  lf.all_durations
-00008dd0: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
-00008de0: 6c6f 6174 290a 2020 2020 2020 2020 7365  loat).        se
-00008df0: 6c66 2e6c 6173 745f 776f 726b 6572 203d  lf.last_worker =
-00008e00: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-00008e10: 6c66 2e6c 6173 745f 776f 726b 6572 5f74  lf.last_worker_t
-00008e20: 6173 6b73 5f6c 6566 7420 3d20 300a 2020  asks_left = 0.  
-00008e30: 2020 2020 2020 7365 6c66 2e73 7061 6e5f        self.span_
-00008e40: 6964 203d 204e 6f6e 650a 0a20 2020 2064  id = None..    d
-00008e50: 6566 2061 6464 5f64 7572 6174 696f 6e28  ef add_duration(
-00008e60: 7365 6c66 2c20 6163 7469 6f6e 3a20 7374  self, action: st
-00008e70: 722c 2073 7461 7274 3a20 666c 6f61 742c  r, start: float,
-00008e80: 2073 746f 703a 2066 6c6f 6174 2920 2d3e   stop: float) ->
-00008e90: 204e 6f6e 653a 0a20 2020 2020 2020 2064   None:.        d
-00008ea0: 7572 6174 696f 6e20 3d20 7374 6f70 202d  uration = stop -
-00008eb0: 2073 7461 7274 0a20 2020 2020 2020 2073   start.        s
-00008ec0: 656c 662e 6475 7261 7469 6f6e 202b 3d20  elf.duration += 
-00008ed0: 6475 7261 7469 6f6e 0a20 2020 2020 2020  duration.       
-00008ee0: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
-00008ef0: 6f6e 735b 6163 7469 6f6e 5d20 2b3d 2064  ons[action] += d
-00008f00: 7572 6174 696f 6e0a 2020 2020 2020 2020  uration.        
-00008f10: 6966 2061 6374 696f 6e20 3d3d 2022 636f  if action == "co
-00008f20: 6d70 7574 6522 3a0a 2020 2020 2020 2020  mpute":.        
-00008f30: 2020 2020 6966 2073 656c 662e 7374 6f70      if self.stop
-00008f40: 203c 2073 746f 703a 0a20 2020 2020 2020   < stop:.       
-00008f50: 2020 2020 2020 2020 2073 656c 662e 7374           self.st
-00008f60: 6f70 203d 2073 746f 700a 2020 2020 2020  op = stop.      
-00008f70: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
-00008f80: 6172 7420 3d3d 2030 2e30 206f 7220 7365  art == 0.0 or se
-00008f90: 6c66 2e73 7461 7274 203e 2073 7461 7274  lf.start > start
-00008fa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008fb0: 2020 7365 6c66 2e73 7461 7274 203d 2073    self.start = s
-00008fc0: 7461 7274 0a20 2020 2020 2020 2061 7373  tart.        ass
-00008fd0: 6572 7420 7365 6c66 2e70 7265 6669 7820  ert self.prefix 
-00008fe0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-00008ff0: 2020 2020 7365 6c66 2e70 7265 6669 782e      self.prefix.
-00009000: 6164 645f 6475 7261 7469 6f6e 2861 6374  add_duration(act
-00009010: 696f 6e2c 2073 7461 7274 2c20 7374 6f70  ion, start, stop
-00009020: 290a 0a20 2020 2064 6566 2061 6464 2873  )..    def add(s
-00009030: 656c 662c 206f 7468 6572 3a20 5461 736b  elf, other: Task
-00009040: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-00009050: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
-00009060: 7465 735b 6f74 6865 722e 7374 6174 655d  tes[other.state]
-00009070: 202b 3d20 310a 2020 2020 2020 2020 6f74   += 1.        ot
-00009080: 6865 722e 6772 6f75 7020 3d20 7365 6c66  her.group = self
-00009090: 0a0a 2020 2020 6465 6620 5f5f 7265 7072  ..    def __repr
-000090a0: 5f5f 2873 656c 6629 202d 3e20 7374 723a  __(self) -> str:
-000090b0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000090c0: 280a 2020 2020 2020 2020 2020 2020 223c  (.            "<
-000090d0: 220a 2020 2020 2020 2020 2020 2020 2b20  ".            + 
-000090e0: 2873 656c 662e 6e61 6d65 206f 7220 226e  (self.name or "n
-000090f0: 6f2d 6772 6f75 7022 290a 2020 2020 2020  o-group").      
-00009100: 2020 2020 2020 2b20 223a 2022 0a20 2020        + ": ".   
-00009110: 2020 2020 2020 2020 202b 2022 2c20 222e           + ", ".
-00009120: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-00009130: 2020 2020 2020 2225 733a 2025 6422 2025        "%s: %d" %
-00009140: 2028 6b2c 2076 2920 666f 7220 286b 2c20   (k, v) for (k, 
-00009150: 7629 2069 6e20 736f 7274 6564 2873 656c  v) in sorted(sel
-00009160: 662e 7374 6174 6573 2e69 7465 6d73 2829  f.states.items()
-00009170: 2920 6966 2076 0a20 2020 2020 2020 2020  ) if v.         
-00009180: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00009190: 202b 2022 3e22 0a20 2020 2020 2020 2029   + ">".        )
-000091a0: 0a0a 2020 2020 6465 6620 5f5f 6c65 6e5f  ..    def __len_
-000091b0: 5f28 7365 6c66 2920 2d3e 2069 6e74 3a0a  _(self) -> int:.
-000091c0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-000091d0: 756d 2873 656c 662e 7374 6174 6573 2e76  um(self.states.v
-000091e0: 616c 7565 7328 2929 0a0a 2020 2020 6465  alues())..    de
-000091f0: 6620 5f74 6f5f 6469 6374 5f6e 6f5f 6e65  f _to_dict_no_ne
-00009200: 7374 2873 656c 662c 202a 2c20 6578 636c  st(self, *, excl
-00009210: 7564 653a 2043 6f6e 7461 696e 6572 5b73  ude: Container[s
-00009220: 7472 5d20 3d20 2829 2920 2d3e 2064 6963  tr] = ()) -> dic
-00009230: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
-00009240: 2020 2020 2022 2222 4469 6374 696f 6e61       """Dictiona
-00009250: 7279 2072 6570 7265 7365 6e74 6174 696f  ry representatio
-00009260: 6e20 666f 7220 6465 6275 6767 696e 6720  n for debugging 
-00009270: 7075 7270 6f73 6573 2e0a 2020 2020 2020  purposes..      
-00009280: 2020 4e6f 7420 7479 7065 2073 7461 626c    Not type stabl
-00009290: 6520 616e 6420 6e6f 7420 696e 7465 6e64  e and not intend
-000092a0: 6564 2066 6f72 2072 6f75 6e64 7472 6970  ed for roundtrip
-000092b0: 732e 0a0a 2020 2020 2020 2020 5365 6520  s...        See 
-000092c0: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
-000092d0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 436c  -----.        Cl
-000092e0: 6965 6e74 2e64 756d 705f 636c 7573 7465  ient.dump_cluste
-000092f0: 725f 7374 6174 650a 2020 2020 2020 2020  r_state.        
-00009300: 6469 7374 7269 6275 7465 642e 7574 696c  distributed.util
-00009310: 732e 7265 6375 7273 6976 655f 746f 5f64  s.recursive_to_d
-00009320: 6963 740a 2020 2020 2020 2020 5461 736b  ict.        Task
-00009330: 5374 6174 652e 5f74 6f5f 6469 6374 0a20  State._to_dict. 
-00009340: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00009350: 2020 2072 6574 7572 6e20 7265 6375 7273     return recurs
-00009360: 6976 655f 746f 5f64 6963 7428 7365 6c66  ive_to_dict(self
-00009370: 2c20 6578 636c 7564 653d 6578 636c 7564  , exclude=exclud
-00009380: 652c 206d 656d 6265 7273 3d54 7275 6529  e, members=True)
-00009390: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-000093a0: 2020 2020 6465 6620 646f 6e65 2873 656c      def done(sel
-000093b0: 6629 202d 3e20 626f 6f6c 3a0a 2020 2020  f) -> bool:.    
-000093c0: 2020 2020 2222 2252 6574 7572 6e20 5472      """Return Tr
-000093d0: 7565 2069 6620 616c 6c20 636f 6d70 7574  ue if all comput
-000093e0: 6174 696f 6e73 2066 6f72 2074 6869 7320  ations for this 
-000093f0: 6772 6f75 7020 6861 7665 2063 6f6d 706c  group have compl
-00009400: 6574 6564 3b20 4661 6c73 650a 2020 2020  eted; False.    
-00009410: 2020 2020 6f74 6865 7277 6973 652e 0a0a      otherwise...
-00009420: 2020 2020 2020 2020 4e6f 7465 730a 2020          Notes.  
-00009430: 2020 2020 2020 2d2d 2d2d 2d0a 2020 2020        -----.    
-00009440: 2020 2020 5468 6973 2070 726f 7065 7274      This propert
-00009450: 7920 6d61 7920 7472 616e 7369 7469 6f6e  y may transition
-00009460: 2066 726f 6d20 5472 7565 2074 6f20 4661   from True to Fa
-00009470: 6c73 652c 2065 2e67 2e20 7768 656e 2061  lse, e.g. when a
-00009480: 2077 6f72 6b65 7220 7468 6174 0a20 2020   worker that.   
-00009490: 2020 2020 2063 6f6e 7461 696e 6564 2074       contained t
-000094a0: 6865 206f 6e6c 7920 7265 706c 6963 6120  he only replica 
-000094b0: 6f66 2061 2074 6173 6b20 696e 206d 656d  of a task in mem
-000094c0: 6f72 7920 6372 6173 6865 7320 616e 6420  ory crashes and 
-000094d0: 7468 6520 7461 736b 206e 6565 6420 746f  the task need to
-000094e0: 2062 650a 2020 2020 2020 2020 7265 636f   be.        reco
-000094f0: 6d70 7574 6564 2e0a 2020 2020 2020 2020  mputed..        
-00009500: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-00009510: 726e 2061 6c6c 280a 2020 2020 2020 2020  rn all(.        
-00009520: 2020 2020 636f 756e 7420 3d3d 2030 206f      count == 0 o
-00009530: 7220 7374 6174 6520 696e 207b 226d 656d  r state in {"mem
-00009540: 6f72 7922 2c20 2265 7272 6564 222c 2022  ory", "erred", "
-00009550: 7265 6c65 6173 6564 222c 2022 666f 7267  released", "forg
-00009560: 6f74 7465 6e22 7d0a 2020 2020 2020 2020  otten"}.        
-00009570: 2020 2020 666f 7220 7374 6174 652c 2063      for state, c
-00009580: 6f75 6e74 2069 6e20 7365 6c66 2e73 7461  ount in self.sta
-00009590: 7465 732e 6974 656d 7328 290a 2020 2020  tes.items().    
-000095a0: 2020 2020 290a 0a0a 636c 6173 7320 5461      )...class Ta
-000095b0: 736b 5374 6174 653a 0a20 2020 2022 2222  skState:.    """
-000095c0: 4120 7369 6d70 6c65 206f 626a 6563 7420  A simple object 
-000095d0: 686f 6c64 696e 6720 696e 666f 726d 6174  holding informat
-000095e0: 696f 6e20 6162 6f75 7420 6120 7461 736b  ion about a task
-000095f0: 2e0a 0a20 2020 204e 6f74 2074 6f20 6265  ...    Not to be
-00009600: 2063 6f6e 6675 7365 6420 7769 7468 203a   confused with :
-00009610: 636c 6173 733a 6064 6973 7472 6962 7574  class:`distribut
-00009620: 6564 2e77 6f72 6b65 725f 7374 6174 655f  ed.worker_state_
-00009630: 6d61 6368 696e 652e 5461 736b 5374 6174  machine.TaskStat
-00009640: 6560 2c20 7768 6963 680a 2020 2020 686f  e`, which.    ho
-00009650: 6c64 7320 7369 6d69 6c61 7220 696e 666f  lds similar info
-00009660: 726d 6174 696f 6e20 6f6e 2074 6865 2057  rmation on the W
-00009670: 6f72 6b65 7220 7369 6465 2e0a 2020 2020  orker side..    
-00009680: 2222 220a 0a20 2020 2023 3a20 5468 6520  """..    #: The 
-00009690: 6b65 7920 6973 2074 6865 2075 6e69 7175  key is the uniqu
-000096a0: 6520 6964 656e 7469 6669 6572 206f 6620  e identifier of 
-000096b0: 6120 7461 736b 2c20 6765 6e65 7261 6c6c  a task, generall
-000096c0: 7920 666f 726d 6564 2066 726f 6d20 7468  y formed from th
-000096d0: 6520 6e61 6d65 206f 6620 7468 650a 2020  e name of the.  
-000096e0: 2020 233a 2066 756e 6374 696f 6e2c 2066    #: function, f
-000096f0: 6f6c 6c6f 7765 6420 6279 2061 2068 6173  ollowed by a has
-00009700: 6820 6f66 2074 6865 2066 756e 6374 696f  h of the functio
-00009710: 6e20 616e 6420 6172 6775 6d65 6e74 732c  n and arguments,
-00009720: 206c 696b 650a 2020 2020 233a 2060 6027   like.    #: ``'
-00009730: 696e 632d 6162 3331 6330 3130 3434 3439  inc-ab31c0104449
-00009740: 3737 3030 3464 3635 3636 3130 6432 6434  77004d656610d2d4
-00009750: 3231 6563 2760 602e 0a20 2020 206b 6579  21ec'``..    key
-00009760: 3a20 4b65 790a 0a20 2020 2023 3a20 5468  : Key..    #: Th
-00009770: 6520 6272 6f61 6420 636c 6173 7320 6f66  e broad class of
-00009780: 2074 6173 6b73 2074 6f20 7768 6963 6820   tasks to which 
-00009790: 7468 6973 2074 6173 6b20 6265 6c6f 6e67  this task belong
-000097a0: 7320 6c69 6b65 2022 696e 6322 206f 7220  s like "inc" or 
-000097b0: 2272 6561 645f 6373 7622 0a20 2020 2070  "read_csv".    p
-000097c0: 7265 6669 783a 2054 6173 6b50 7265 6669  refix: TaskPrefi
-000097d0: 780a 0a20 2020 2023 3a20 4120 7370 6563  x..    #: A spec
-000097e0: 6966 6963 6174 696f 6e20 6f66 2068 6f77  ification of how
-000097f0: 2074 6f20 7275 6e20 7468 6520 7461 736b   to run the task
-00009800: 2e20 2054 6865 2074 7970 6520 616e 6420  .  The type and 
-00009810: 6d65 616e 696e 6720 6f66 2074 6869 7320  meaning of this 
-00009820: 7661 6c75 6520 6973 0a20 2020 2023 3a20  value is.    #: 
-00009830: 6f70 6171 7565 2074 6f20 7468 6520 7363  opaque to the sc
-00009840: 6865 6475 6c65 722c 2061 7320 6974 2069  heduler, as it i
-00009850: 7320 6f6e 6c79 2069 6e74 6572 7072 6574  s only interpret
-00009860: 6564 2062 7920 7468 6520 776f 726b 6572  ed by the worker
-00009870: 2074 6f20 7768 6963 6820 7468 650a 2020   to which the.  
-00009880: 2020 233a 2074 6173 6b20 6973 2073 656e    #: task is sen
-00009890: 7420 666f 7220 6578 6563 7574 696e 672e  t for executing.
-000098a0: 0a20 2020 2023 3a0a 2020 2020 233a 2041  .    #:.    #: A
-000098b0: 7320 6120 7370 6563 6961 6c20 6361 7365  s a special case
-000098c0: 2c20 7468 6973 2061 7474 7269 6275 7465  , this attribute
-000098d0: 206d 6179 2061 6c73 6f20 6265 2060 604e   may also be ``N
-000098e0: 6f6e 6560 602c 2069 6e20 7768 6963 6820  one``, in which 
-000098f0: 6361 7365 2074 6865 2074 6173 6b20 6973  case the task is
-00009900: 0a20 2020 2023 3a20 2270 7572 6520 6461  .    #: "pure da
-00009910: 7461 2220 2873 7563 6820 6173 2c20 666f  ta" (such as, fo
-00009920: 7220 6578 616d 706c 652c 2061 2070 6965  r example, a pie
-00009930: 6365 206f 6620 6461 7461 206c 6f61 6465  ce of data loade
-00009940: 6420 696e 2074 6865 2073 6368 6564 756c  d in the schedul
-00009950: 6572 2075 7369 6e67 0a20 2020 2023 3a20  er using.    #: 
-00009960: 3a6d 6574 683a 6043 6c69 656e 742e 7363  :meth:`Client.sc
-00009970: 6174 7465 7260 292e 2020 4120 2270 7572  atter`).  A "pur
-00009980: 6520 6461 7461 2220 7461 736b 2063 616e  e data" task can
-00009990: 6e6f 7420 6265 2063 6f6d 7075 7465 6420  not be computed 
-000099a0: 6167 6169 6e20 6966 2069 7473 0a20 2020  again if its.   
-000099b0: 2023 3a20 7661 6c75 6520 6973 206c 6f73   #: value is los
-000099c0: 742e 0a20 2020 2072 756e 5f73 7065 633a  t..    run_spec:
-000099d0: 2054 5f72 756e 7370 6563 207c 204e 6f6e   T_runspec | Non
-000099e0: 650a 0a20 2020 2023 3a20 5468 6520 7072  e..    #: The pr
-000099f0: 696f 7269 7479 2070 726f 7669 6465 7320  iority provides 
-00009a00: 6561 6368 2074 6173 6b20 7769 7468 2061  each task with a
-00009a10: 2072 656c 6174 6976 6520 7261 6e6b 696e   relative rankin
-00009a20: 6720 7768 6963 6820 6973 2075 7365 6420  g which is used 
-00009a30: 746f 2062 7265 616b 0a20 2020 2023 3a20  to break.    #: 
-00009a40: 7469 6573 2077 6865 6e20 6d61 6e79 2074  ties when many t
-00009a50: 6173 6b73 2061 7265 2062 6569 6e67 2063  asks are being c
-00009a60: 6f6e 7369 6465 7265 6420 666f 7220 6578  onsidered for ex
-00009a70: 6563 7574 696f 6e2e 0a20 2020 2023 3a0a  ecution..    #:.
-00009a80: 2020 2020 233a 2054 6869 7320 7261 6e6b      #: This rank
-00009a90: 696e 6720 6973 2067 656e 6572 616c 6c79  ing is generally
-00009aa0: 2061 2032 2d69 7465 6d20 7475 706c 652e   a 2-item tuple.
-00009ab0: 2020 5468 6520 6669 7273 7420 2861 6e64    The first (and
-00009ac0: 2064 6f6d 696e 616e 7429 2069 7465 6d0a   dominant) item.
-00009ad0: 2020 2020 233a 2063 6f72 7265 7370 6f6e      #: correspon
-00009ae0: 6473 2074 6f20 7768 656e 2069 7420 7761  ds to when it wa
-00009af0: 7320 7375 626d 6974 7465 642e 2020 4765  s submitted.  Ge
-00009b00: 6e65 7261 6c6c 792c 2065 6172 6c69 6572  nerally, earlier
-00009b10: 2074 6173 6b73 2074 616b 6520 7072 6563   tasks take prec
-00009b20: 6564 656e 6365 2e0a 2020 2020 233a 2054  edence..    #: T
-00009b30: 6865 2073 6563 6f6e 6420 6974 656d 2069  he second item i
-00009b40: 7320 6465 7465 726d 696e 6564 2062 7920  s determined by 
-00009b50: 7468 6520 636c 6965 6e74 2c20 616e 6420  the client, and 
-00009b60: 6973 2061 2077 6179 2074 6f20 7072 696f  is a way to prio
-00009b70: 7269 7469 7a65 2074 6173 6b73 0a20 2020  ritize tasks.   
-00009b80: 2023 3a20 7769 7468 696e 2061 206c 6172   #: within a lar
-00009b90: 6765 2067 7261 7068 2074 6861 7420 6d61  ge graph that ma
-00009ba0: 7920 6265 2069 6d70 6f72 7461 6e74 2c20  y be important, 
-00009bb0: 7375 6368 2061 7320 6966 2074 6865 7920  such as if they 
-00009bc0: 6172 6520 6f6e 2074 6865 2063 7269 7469  are on the criti
-00009bd0: 6361 6c0a 2020 2020 233a 2070 6174 682c  cal.    #: path,
-00009be0: 206f 7220 676f 6f64 2074 6f20 7275 6e20   or good to run 
-00009bf0: 696e 206f 7264 6572 2074 6f20 7265 6c65  in order to rele
-00009c00: 6173 6520 6d61 6e79 2064 6570 656e 6465  ase many depende
-00009c10: 6e63 6965 732e 2020 5468 6973 2069 7320  ncies.  This is 
-00009c20: 6578 706c 6169 6e65 640a 2020 2020 233a  explained.    #:
-00009c30: 2066 7572 7468 6572 2069 6e20 3a64 6f63   further in :doc
-00009c40: 3a60 5363 6865 6475 6c69 6e67 2050 6f6c  :`Scheduling Pol
-00009c50: 6963 7920 3c73 6368 6564 756c 696e 672d  icy <scheduling-
-00009c60: 706f 6c69 6369 6573 3e60 2e0a 2020 2020  policies>`..    
-00009c70: 7072 696f 7269 7479 3a20 7475 706c 655b  priority: tuple[
-00009c80: 666c 6f61 742c 202e 2e2e 5d20 7c20 4e6f  float, ...] | No
-00009c90: 6e65 0a0a 2020 2020 2320 4174 7472 6962  ne..    # Attrib
-00009ca0: 7574 6520 756e 6465 726c 7969 6e67 2074  ute underlying t
-00009cb0: 6865 2073 7461 7465 2070 726f 7065 7274  he state propert
-00009cc0: 790a 2020 2020 5f73 7461 7465 3a20 5461  y.    _state: Ta
-00009cd0: 736b 5374 6174 6553 7461 7465 0a0a 2020  skStateState..  
-00009ce0: 2020 233a 2054 6865 2073 6574 206f 6620    #: The set of 
-00009cf0: 7461 736b 7320 7468 6973 2074 6173 6b20  tasks this task 
-00009d00: 6465 7065 6e64 7320 6f6e 2066 6f72 2070  depends on for p
-00009d10: 726f 7065 7220 6578 6563 7574 696f 6e2e  roper execution.
-00009d20: 204f 6e6c 7920 7461 736b 7320 7374 696c   Only tasks stil
-00009d30: 6c0a 2020 2020 233a 2061 6c69 7665 2061  l.    #: alive a
-00009d40: 7265 206c 6973 7465 6420 696e 2074 6869  re listed in thi
-00009d50: 7320 7365 742e 2049 662c 2066 6f72 2077  s set. If, for w
-00009d60: 6861 7465 7665 7220 7265 6173 6f6e 2c20  hatever reason, 
-00009d70: 7468 6973 2074 6173 6b20 616c 736f 2064  this task also d
-00009d80: 6570 656e 6473 206f 6e0a 2020 2020 233a  epends on.    #:
-00009d90: 2061 2066 6f72 676f 7474 656e 2074 6173   a forgotten tas
-00009da0: 6b2c 2074 6865 203a 6174 7472 3a60 6861  k, the :attr:`ha
-00009db0: 735f 6c6f 7374 5f64 6570 656e 6465 6e63  s_lost_dependenc
-00009dc0: 6965 7360 2066 6c61 6720 6973 2073 6574  ies` flag is set
-00009dd0: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
-00009de0: 4120 7461 736b 2063 616e 206f 6e6c 7920  A task can only 
-00009df0: 6265 2065 7865 6375 7465 6420 6f6e 6365  be executed once
-00009e00: 2061 6c6c 2069 7473 2064 6570 656e 6465   all its depende
-00009e10: 6e63 6965 7320 6861 7665 2061 6c72 6561  ncies have alrea
-00009e20: 6479 2062 6565 6e0a 2020 2020 233a 2073  dy been.    #: s
-00009e30: 7563 6365 7373 6675 6c6c 7920 6578 6563  uccessfully exec
-00009e40: 7574 6564 2061 6e64 2068 6176 6520 7468  uted and have th
-00009e50: 6569 7220 7265 7375 6c74 2073 746f 7265  eir result store
-00009e60: 6420 6f6e 2061 7420 6c65 6173 7420 6f6e  d on at least on
-00009e70: 6520 776f 726b 6572 2e20 5468 6973 0a20  e worker. This. 
-00009e80: 2020 2023 3a20 6973 2074 7261 636b 6564     #: is tracked
-00009e90: 2062 7920 7072 6f67 7265 7373 6976 656c   by progressivel
-00009ea0: 7920 6472 6169 6e69 6e67 2074 6865 203a  y draining the :
-00009eb0: 6174 7472 3a60 7761 6974 696e 675f 6f6e  attr:`waiting_on
-00009ec0: 6020 7365 742e 0a20 2020 2064 6570 656e  ` set..    depen
-00009ed0: 6465 6e63 6965 733a 2073 6574 5b54 6173  dencies: set[Tas
-00009ee0: 6b53 7461 7465 5d0a 0a20 2020 2023 3a20  kState]..    #: 
-00009ef0: 5468 6520 7365 7420 6f66 2074 6173 6b73  The set of tasks
-00009f00: 2077 6869 6368 2064 6570 656e 6420 6f6e   which depend on
-00009f10: 2074 6869 7320 7461 736b 2e20 204f 6e6c   this task.  Onl
-00009f20: 7920 7461 736b 7320 7374 696c 6c20 616c  y tasks still al
-00009f30: 6976 6520 6172 6520 6c69 7374 6564 2069  ive are listed i
-00009f40: 6e0a 2020 2020 233a 2074 6869 7320 7365  n.    #: this se
-00009f50: 742e 2054 6869 7320 6973 2074 6865 2072  t. This is the r
-00009f60: 6576 6572 7365 206d 6170 7069 6e67 206f  everse mapping o
-00009f70: 6620 3a61 7474 723a 6064 6570 656e 6465  f :attr:`depende
-00009f80: 6e63 6965 7360 2e0a 2020 2020 6465 7065  ncies`..    depe
-00009f90: 6e64 656e 7473 3a20 7365 745b 5461 736b  ndents: set[Task
-00009fa0: 5374 6174 655d 0a0a 2020 2020 233a 2057  State]..    #: W
-00009fb0: 6865 7468 6572 2061 6e79 206f 6620 7468  hether any of th
-00009fc0: 6520 6465 7065 6e64 656e 6369 6573 206f  e dependencies o
-00009fd0: 6620 7468 6973 2074 6173 6b20 6861 7320  f this task has 
-00009fe0: 6265 656e 2066 6f72 676f 7474 656e 2e20  been forgotten. 
-00009ff0: 466f 7220 6d65 6d6f 7279 0a20 2020 2023  For memory.    #
-0000a000: 3a20 636f 6e73 756d 7074 696f 6e20 7265  : consumption re
-0000a010: 6173 6f6e 732c 2066 6f72 676f 7474 656e  asons, forgotten
-0000a020: 2074 6173 6b73 2061 7265 206e 6f74 206b   tasks are not k
-0000a030: 6570 7420 696e 206d 656d 6f72 7920 6576  ept in memory ev
-0000a040: 656e 2074 686f 7567 6820 7468 6579 206d  en though they m
-0000a050: 6179 0a20 2020 2023 3a20 6861 7665 2064  ay.    #: have d
-0000a060: 6570 656e 6465 6e74 2074 6173 6b73 2e20  ependent tasks. 
-0000a070: 2057 6865 6e20 6120 7461 736b 2069 7320   When a task is 
-0000a080: 666f 7267 6f74 7465 6e2c 2074 6865 7265  forgotten, there
-0000a090: 666f 7265 2c20 6561 6368 206f 6620 6974  fore, each of it
-0000a0a0: 730a 2020 2020 233a 2064 6570 656e 6465  s.    #: depende
-0000a0b0: 6e74 7320 6861 7320 7468 6569 7220 3a61  nts has their :a
-0000a0c0: 7474 723a 6068 6173 5f6c 6f73 745f 6465  ttr:`has_lost_de
-0000a0d0: 7065 6e64 656e 6369 6573 6020 6174 7472  pendencies` attr
-0000a0e0: 6962 7574 6520 7365 7420 746f 2060 6054  ibute set to ``T
-0000a0f0: 7275 6560 602e 0a20 2020 2023 3a0a 2020  rue``..    #:.  
-0000a100: 2020 233a 2049 6620 3a61 7474 723a 6068    #: If :attr:`h
-0000a110: 6173 5f6c 6f73 745f 6465 7065 6e64 656e  as_lost_dependen
-0000a120: 6369 6573 6020 6973 2074 7275 652c 2074  cies` is true, t
-0000a130: 6869 7320 7461 736b 2063 616e 6e6f 7420  his task cannot 
-0000a140: 676f 2069 6e74 6f20 7468 650a 2020 2020  go into the.    
-0000a150: 233a 2022 7072 6f63 6573 7369 6e67 2220  #: "processing" 
-0000a160: 7374 6174 6520 616e 796d 6f72 652e 0a20  state anymore.. 
-0000a170: 2020 2068 6173 5f6c 6f73 745f 6465 7065     has_lost_depe
-0000a180: 6e64 656e 6369 6573 3a20 626f 6f6c 0a0a  ndencies: bool..
-0000a190: 2020 2020 233a 2054 6865 2073 6574 206f      #: The set o
-0000a1a0: 6620 7461 736b 7320 7468 6973 2074 6173  f tasks this tas
-0000a1b0: 6b20 6973 2077 6169 7469 6e67 206f 6e20  k is waiting on 
-0000a1c0: 2a62 6566 6f72 652a 2069 7420 6361 6e20  *before* it can 
-0000a1d0: 6265 2065 7865 6375 7465 642e 2054 6869  be executed. Thi
-0000a1e0: 7320 6973 0a20 2020 2023 3a20 616c 7761  s is.    #: alwa
-0000a1f0: 7973 2061 2073 7562 7365 7420 6f66 203a  ys a subset of :
-0000a200: 6174 7472 3a60 6465 7065 6e64 656e 6369  attr:`dependenci
-0000a210: 6573 602e 2020 4561 6368 2074 696d 6520  es`.  Each time 
-0000a220: 6f6e 6520 6f66 2074 6865 2064 6570 656e  one of the depen
-0000a230: 6465 6e63 6965 7320 6861 730a 2020 2020  dencies has.    
-0000a240: 233a 2066 696e 6973 6865 6420 7072 6f63  #: finished proc
-0000a250: 6573 7369 6e67 2c20 6974 2069 7320 7265  essing, it is re
-0000a260: 6d6f 7665 6420 6672 6f6d 2074 6865 203a  moved from the :
-0000a270: 6174 7472 3a60 7761 6974 696e 675f 6f6e  attr:`waiting_on
-0000a280: 6020 7365 742e 0a20 2020 2023 3a0a 2020  ` set..    #:.  
-0000a290: 2020 233a 204f 6e63 6520 3a61 7474 723a    #: Once :attr:
-0000a2a0: 6077 6169 7469 6e67 5f6f 6e60 2062 6563  `waiting_on` bec
-0000a2b0: 6f6d 6573 2065 6d70 7479 2c20 7468 6973  omes empty, this
-0000a2c0: 2074 6173 6b20 6361 6e20 6d6f 7665 2066   task can move f
-0000a2d0: 726f 6d20 7468 6520 2277 6169 7469 6e67  rom the "waiting
-0000a2e0: 220a 2020 2020 233a 2073 7461 7465 2074  ".    #: state t
-0000a2f0: 6f20 7468 6520 2270 726f 6365 7373 696e  o the "processin
-0000a300: 6722 2073 7461 7465 2028 756e 6c65 7373  g" state (unless
-0000a310: 206f 6e65 206f 6620 7468 6520 6465 7065   one of the depe
-0000a320: 6e64 656e 6369 6573 2065 7272 6f72 6564  ndencies errored
-0000a330: 206f 7574 2c20 696e 0a20 2020 2023 3a20   out, in.    #: 
-0000a340: 7768 6963 6820 6361 7365 2074 6869 7320  which case this 
-0000a350: 7461 736b 2069 7320 696e 7374 6561 6420  task is instead 
-0000a360: 6d61 726b 6564 2022 6572 7265 6422 292e  marked "erred").
-0000a370: 0a20 2020 2077 6169 7469 6e67 5f6f 6e3a  .    waiting_on:
-0000a380: 2073 6574 5b54 6173 6b53 7461 7465 5d20   set[TaskState] 
-0000a390: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2054  | None..    #: T
-0000a3a0: 6865 2073 6574 206f 6620 7461 736b 7320  he set of tasks 
-0000a3b0: 7768 6963 6820 6e65 6564 2074 6869 7320  which need this 
-0000a3c0: 7461 736b 2074 6f20 7265 6d61 696e 2061  task to remain a
-0000a3d0: 6c69 7665 2e20 2054 6869 7320 6973 2061  live.  This is a
-0000a3e0: 6c77 6179 7320 6120 7375 6273 6574 0a20  lways a subset. 
-0000a3f0: 2020 2023 3a20 6f66 203a 6174 7472 3a60     #: of :attr:`
-0000a400: 6465 7065 6e64 656e 7473 602e 2020 4561  dependents`.  Ea
-0000a410: 6368 2074 696d 6520 6f6e 6520 6f66 2074  ch time one of t
-0000a420: 6865 2064 6570 656e 6465 6e74 7320 6861  he dependents ha
-0000a430: 7320 6669 6e69 7368 6564 2070 726f 6365  s finished proce
-0000a440: 7373 696e 672c 0a20 2020 2023 3a20 6974  ssing,.    #: it
-0000a450: 2069 7320 7265 6d6f 7665 6420 6672 6f6d   is removed from
-0000a460: 2074 6865 203a 6174 7472 3a60 7761 6974   the :attr:`wait
-0000a470: 6572 7360 2073 6574 2e0a 2020 2020 233a  ers` set..    #:
-0000a480: 0a20 2020 2023 3a20 4f6e 6365 2062 6f74  .    #: Once bot
-0000a490: 6820 3a61 7474 723a 6077 6169 7465 7273  h :attr:`waiters
-0000a4a0: 6020 616e 6420 3a61 7474 723a 6077 686f  ` and :attr:`who
-0000a4b0: 5f77 616e 7473 6020 6265 636f 6d65 2065  _wants` become e
-0000a4c0: 6d70 7479 2c20 7468 6973 2074 6173 6b20  mpty, this task 
-0000a4d0: 6361 6e20 6265 0a20 2020 2023 3a20 7265  can be.    #: re
-0000a4e0: 6c65 6173 6564 2028 6966 2069 7420 6861  leased (if it ha
-0000a4f0: 7320 6120 6e6f 6e2d 656d 7074 7920 3a61  s a non-empty :a
-0000a500: 7474 723a 6072 756e 5f73 7065 6360 2920  ttr:`run_spec`) 
-0000a510: 6f72 2066 6f72 676f 7474 656e 2028 6f74  or forgotten (ot
-0000a520: 6865 7277 6973 6529 2062 7920 7468 650a  herwise) by the.
-0000a530: 2020 2020 233a 2073 6368 6564 756c 6572      #: scheduler
-0000a540: 2c20 616e 6420 6279 2061 6e79 2077 6f72  , and by any wor
-0000a550: 6b65 7273 2069 6e20 3a61 7474 723a 6077  kers in :attr:`w
-0000a560: 686f 5f68 6173 602e 0a20 2020 2023 3a0a  ho_has`..    #:.
-0000a570: 2020 2020 233a 202e 2e20 6e6f 7465 3a3a      #: .. note::
-0000a580: 0a20 2020 2023 3a20 2020 2043 6f75 6e74  .    #:    Count
-0000a590: 6572 2d69 6e74 7569 7469 7665 6c79 2c20  er-intuitively, 
-0000a5a0: 3a61 7474 723a 6077 6169 7469 6e67 5f6f  :attr:`waiting_o
-0000a5b0: 6e60 2061 6e64 203a 6174 7472 3a60 7761  n` and :attr:`wa
-0000a5c0: 6974 6572 7360 2061 7265 206e 6f74 2072  iters` are not r
-0000a5d0: 6576 6572 7365 0a20 2020 2023 3a20 2020  everse.    #:   
-0000a5e0: 206d 6170 7069 6e67 7320 6f66 2065 6163   mappings of eac
-0000a5f0: 6820 6f74 6865 722e 0a20 2020 2077 6169  h other..    wai
-0000a600: 7465 7273 3a20 7365 745b 5461 736b 5374  ters: set[TaskSt
-0000a610: 6174 655d 207c 204e 6f6e 650a 0a20 2020  ate] | None..   
-0000a620: 2023 3a20 5468 6520 7365 7420 6f66 2063   #: The set of c
-0000a630: 6c69 656e 7473 2077 686f 2077 616e 7420  lients who want 
-0000a640: 7468 6520 7265 7375 6c74 206f 6620 7468  the result of th
-0000a650: 6973 2074 6173 6b20 746f 2072 656d 6169  is task to remai
-0000a660: 6e20 616c 6976 652e 0a20 2020 2023 3a20  n alive..    #: 
-0000a670: 5468 6973 2069 7320 7468 6520 7265 7665  This is the reve
-0000a680: 7273 6520 6d61 7070 696e 6720 6f66 203a  rse mapping of :
-0000a690: 6174 7472 3a60 436c 6965 6e74 5374 6174  attr:`ClientStat
-0000a6a0: 652e 7761 6e74 735f 7768 6174 602e 0a20  e.wants_what`.. 
-0000a6b0: 2020 2023 3a0a 2020 2020 233a 2057 6865     #:.    #: Whe
-0000a6c0: 6e20 6120 636c 6965 6e74 2073 7562 6d69  n a client submi
-0000a6d0: 7473 2061 2067 7261 7068 2074 6f20 7468  ts a graph to th
-0000a6e0: 6520 7363 6865 6475 6c65 7220 6974 2061  e scheduler it a
-0000a6f0: 6c73 6f20 7370 6563 6966 6965 7320 7768  lso specifies wh
-0000a700: 6963 6820 6f75 7470 7574 0a20 2020 2023  ich output.    #
-0000a710: 3a20 7461 736b 7320 6974 2064 6573 6972  : tasks it desir
-0000a720: 6573 2c20 7375 6368 2074 6861 7420 7468  es, such that th
-0000a730: 6569 7220 7265 7375 6c74 7320 6172 6520  eir results are 
-0000a740: 6e6f 7420 7265 6c65 6173 6564 2066 726f  not released fro
-0000a750: 6d20 6d65 6d6f 7279 2e0a 2020 2020 233a  m memory..    #:
-0000a760: 0a20 2020 2023 3a20 4f6e 6365 2061 2074  .    #: Once a t
-0000a770: 6173 6b20 6861 7320 6669 6e69 7368 6564  ask has finished
-0000a780: 2065 7865 6375 7469 6e67 2028 692e 652e   executing (i.e.
-0000a790: 206d 6f76 6573 2069 6e74 6f20 7468 6520   moves into the 
-0000a7a0: 226d 656d 6f72 7922 206f 7220 2265 7272  "memory" or "err
-0000a7b0: 6564 220a 2020 2020 233a 2073 7461 7465  ed".    #: state
-0000a7c0: 292c 2074 6865 2063 6c69 656e 7473 2069  ), the clients i
-0000a7d0: 6e20 3a61 7474 723a 6077 686f 5f77 616e  n :attr:`who_wan
-0000a7e0: 7473 6020 6172 6520 6e6f 7469 6669 6564  ts` are notified
-0000a7f0: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
-0000a800: 4f6e 6365 2062 6f74 6820 3a61 7474 723a  Once both :attr:
-0000a810: 6077 6169 7465 7273 6020 616e 6420 3a61  `waiters` and :a
-0000a820: 7474 723a 6077 686f 5f77 616e 7473 6020  ttr:`who_wants` 
-0000a830: 6265 636f 6d65 2065 6d70 7479 2c20 7468  become empty, th
-0000a840: 6973 2074 6173 6b20 6361 6e20 6265 0a20  is task can be. 
-0000a850: 2020 2023 3a20 7265 6c65 6173 6564 2028     #: released (
-0000a860: 6966 2069 7420 6861 7320 6120 6e6f 6e2d  if it has a non-
-0000a870: 656d 7074 7920 3a61 7474 723a 6072 756e  empty :attr:`run
-0000a880: 5f73 7065 6360 2920 6f72 2066 6f72 676f  _spec`) or forgo
-0000a890: 7474 656e 2028 6f74 6865 7277 6973 6529  tten (otherwise)
-0000a8a0: 2062 7920 7468 650a 2020 2020 233a 2073   by the.    #: s
-0000a8b0: 6368 6564 756c 6572 2c20 616e 6420 6279  cheduler, and by
-0000a8c0: 2061 6e79 2077 6f72 6b65 7273 2069 6e20   any workers in 
-0000a8d0: 3a61 7474 723a 6077 686f 5f68 6173 602e  :attr:`who_has`.
-0000a8e0: 0a20 2020 2077 686f 5f77 616e 7473 3a20  .    who_wants: 
-0000a8f0: 7365 745b 436c 6965 6e74 5374 6174 655d  set[ClientState]
-0000a900: 207c 204e 6f6e 650a 0a20 2020 2023 3a20   | None..    #: 
-0000a910: 5468 6520 7365 7420 6f66 2077 6f72 6b65  The set of worke
-0000a920: 7273 2077 686f 2068 6176 6520 7468 6973  rs who have this
-0000a930: 2074 6173 6b27 7320 7265 7375 6c74 2069   task's result i
-0000a940: 6e20 6d65 6d6f 7279 2e20 4974 2069 7320  n memory. It is 
-0000a950: 6e6f 6e2d 656d 7074 7920 6966 6620 7468  non-empty iff th
-0000a960: 650a 2020 2020 233a 2074 6173 6b20 6973  e.    #: task is
-0000a970: 2069 6e20 7468 6520 226d 656d 6f72 7922   in the "memory"
-0000a980: 2073 7461 7465 2e20 2054 6865 7265 2063   state.  There c
-0000a990: 616e 2062 6520 6d6f 7265 2074 6861 6e20  an be more than 
-0000a9a0: 6f6e 6520 776f 726b 6572 2069 6e20 7468  one worker in th
-0000a9b0: 6973 2073 6574 2069 662c 0a20 2020 2023  is set if,.    #
-0000a9c0: 3a20 666f 7220 6578 616d 706c 652c 203a  : for example, :
-0000a9d0: 6d65 7468 3a60 436c 6965 6e74 2e73 6361  meth:`Client.sca
-0000a9e0: 7474 6572 6020 6f72 203a 6d65 7468 3a60  tter` or :meth:`
-0000a9f0: 436c 6965 6e74 2e72 6570 6c69 6361 7465  Client.replicate
-0000aa00: 6020 7761 7320 7573 6564 2e0a 2020 2020  ` was used..    
-0000aa10: 233a 0a20 2020 2023 3a20 5468 6973 2069  #:.    #: This i
-0000aa20: 7320 7468 6520 7265 7665 7273 6520 6d61  s the reverse ma
-0000aa30: 7070 696e 6720 6f66 203a 6174 7472 3a60  pping of :attr:`
-0000aa40: 576f 726b 6572 5374 6174 652e 6861 735f  WorkerState.has_
-0000aa50: 7768 6174 602e 0a20 2020 2077 686f 5f68  what`..    who_h
-0000aa60: 6173 3a20 7365 745b 576f 726b 6572 5374  as: set[WorkerSt
-0000aa70: 6174 655d 207c 204e 6f6e 650a 0a20 2020  ate] | None..   
-0000aa80: 2023 3a20 4966 2074 6869 7320 7461 736b   #: If this task
-0000aa90: 2069 7320 696e 2074 6865 2022 7072 6f63   is in the "proc
-0000aaa0: 6573 7369 6e67 2220 7374 6174 652c 2077  essing" state, w
-0000aab0: 6869 6368 2077 6f72 6b65 7220 6973 2063  hich worker is c
-0000aac0: 7572 7265 6e74 6c79 2070 726f 6365 7373  urrently process
-0000aad0: 696e 670a 2020 2020 233a 2069 742e 2054  ing.    #: it. T
-0000aae0: 6869 7320 6174 7472 6962 7574 6520 6973  his attribute is
-0000aaf0: 206b 6570 7420 696e 2073 796e 6320 7769   kept in sync wi
-0000ab00: 7468 203a 6174 7472 3a60 576f 726b 6572  th :attr:`Worker
-0000ab10: 5374 6174 652e 7072 6f63 6573 7369 6e67  State.processing
-0000ab20: 602e 0a20 2020 2070 726f 6365 7373 696e  `..    processin
-0000ab30: 675f 6f6e 3a20 576f 726b 6572 5374 6174  g_on: WorkerStat
-0000ab40: 6520 7c20 4e6f 6e65 0a0a 2020 2020 233a  e | None..    #:
-0000ab50: 2054 6865 206e 756d 6265 7220 6f66 2074   The number of t
-0000ab60: 696d 6573 2074 6869 7320 7461 736b 2063  imes this task c
-0000ab70: 616e 2061 7574 6f6d 6174 6963 616c 6c79  an automatically
-0000ab80: 2062 6520 7265 7472 6965 6420 696e 2063   be retried in c
-0000ab90: 6173 6520 6f66 2066 6169 6c75 7265 2e0a  ase of failure..
-0000aba0: 2020 2020 233a 2049 6620 6120 7461 736b      #: If a task
-0000abb0: 2066 6169 6c73 2065 7865 6375 7469 6e67   fails executing
-0000abc0: 2028 7468 6520 776f 726b 6572 2072 6574   (the worker ret
-0000abd0: 7572 6e73 2077 6974 6820 616e 2065 7272  urns with an err
-0000abe0: 6f72 292c 2069 7473 203a 6174 7472 3a60  or), its :attr:`
-0000abf0: 7265 7472 6965 7360 0a20 2020 2023 3a20  retries`.    #: 
-0000ac00: 6174 7472 6962 7574 6520 6973 2063 6865  attribute is che
-0000ac10: 636b 6564 2e20 4966 2069 7420 6973 2065  cked. If it is e
-0000ac20: 7175 616c 2074 6f20 302c 2074 6865 2074  qual to 0, the t
-0000ac30: 6173 6b20 6973 206d 6172 6b65 6420 2265  ask is marked "e
-0000ac40: 7272 6564 222e 2049 6620 6974 2069 730a  rred". If it is.
-0000ac50: 2020 2020 233a 2067 7265 6174 6572 2074      #: greater t
-0000ac60: 6861 6e20 302c 2074 6865 203a 6174 7472  han 0, the :attr
-0000ac70: 3a60 7265 7472 6965 7360 2061 7474 7269  :`retries` attri
-0000ac80: 6275 7465 2069 7320 6465 6372 656d 656e  bute is decremen
-0000ac90: 7465 6420 616e 6420 6578 6563 7574 696f  ted and executio
-0000aca0: 6e20 6973 0a20 2020 2023 3a20 6174 7465  n is.    #: atte
-0000acb0: 6d70 7465 6420 6167 6169 6e2e 0a20 2020  mpted again..   
-0000acc0: 2072 6574 7269 6573 3a20 696e 740a 0a20   retries: int.. 
-0000acd0: 2020 2023 3a20 5468 6520 6e75 6d62 6572     #: The number
-0000ace0: 206f 6620 6279 7465 732c 2061 7320 6465   of bytes, as de
-0000acf0: 7465 726d 696e 6564 2062 7920 6060 7369  termined by ``si
-0000ad00: 7a65 6f66 6060 2c20 6f66 2074 6865 2072  zeof``, of the r
-0000ad10: 6573 756c 7420 6f66 2061 2066 696e 6973  esult of a finis
-0000ad20: 6865 640a 2020 2020 233a 2074 6173 6b2e  hed.    #: task.
-0000ad30: 2054 6869 7320 6e75 6d62 6572 2069 7320   This number is 
-0000ad40: 7573 6564 2066 6f72 2064 6961 676e 6f73  used for diagnos
-0000ad50: 7469 6373 2061 6e64 2074 6f20 6865 6c70  tics and to help
-0000ad60: 2070 7269 6f72 6974 697a 6520 776f 726b   prioritize work
-0000ad70: 2e0a 2020 2020 233a 2053 6574 2074 6f20  ..    #: Set to 
-0000ad80: 2d31 2066 6f72 2075 6e66 696e 6973 6865  -1 for unfinishe
-0000ad90: 6420 7461 736b 732e 0a20 2020 206e 6279  d tasks..    nby
-0000ada0: 7465 733a 2069 6e74 0a0a 2020 2020 233a  tes: int..    #:
-0000adb0: 2054 6865 2074 7970 6520 6f66 2074 6865   The type of the
-0000adc0: 206f 626a 6563 7420 6173 2061 2073 7472   object as a str
-0000add0: 696e 672e 204f 6e6c 7920 7072 6573 656e  ing. Only presen
-0000ade0: 7420 666f 7220 7461 736b 7320 7468 6174  t for tasks that
-0000adf0: 2068 6176 6520 6265 656e 0a20 2020 2023   have been.    #
-0000ae00: 3a20 636f 6d70 7574 6564 2e0a 2020 2020  : computed..    
-0000ae10: 7479 7065 3a20 7374 720a 0a20 2020 2023  type: str..    #
-0000ae20: 3a20 4966 2074 6869 7320 7461 736b 2066  : If this task f
-0000ae30: 6169 6c65 6420 6578 6563 7574 696e 672c  ailed executing,
-0000ae40: 2074 6865 2065 7863 6570 7469 6f6e 206f   the exception o
-0000ae50: 626a 6563 7420 6973 2073 746f 7265 6420  bject is stored 
-0000ae60: 6865 7265 2e0a 2020 2020 6578 6365 7074  here..    except
-0000ae70: 696f 6e3a 2053 6572 6961 6c69 7a65 6420  ion: Serialized 
-0000ae80: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2049  | None..    #: I
-0000ae90: 6620 7468 6973 2074 6173 6b20 6661 696c  f this task fail
-0000aea0: 6564 2065 7865 6375 7469 6e67 2c20 7468  ed executing, th
-0000aeb0: 6520 7472 6163 6562 6163 6b20 6f62 6a65  e traceback obje
-0000aec0: 6374 2069 7320 7374 6f72 6564 2068 6572  ct is stored her
-0000aed0: 652e 0a20 2020 2074 7261 6365 6261 636b  e..    traceback
-0000aee0: 3a20 5365 7269 616c 697a 6564 207c 204e  : Serialized | N
-0000aef0: 6f6e 650a 0a20 2020 2023 3a20 7374 7269  one..    #: stri
-0000af00: 6e67 2072 6570 7265 7365 6e74 6174 696f  ng representatio
-0000af10: 6e20 6f66 2065 7863 6570 7469 6f6e 0a20  n of exception. 
-0000af20: 2020 2065 7863 6570 7469 6f6e 5f74 6578     exception_tex
-0000af30: 743a 2073 7472 207c 204e 6f6e 650a 0a20  t: str | None.. 
-0000af40: 2020 2023 3a20 7374 7269 6e67 2072 6570     #: string rep
-0000af50: 7265 7365 6e74 6174 696f 6e20 6f66 2074  resentation of t
-0000af60: 7261 6365 6261 636b 0a20 2020 2074 7261  raceback.    tra
-0000af70: 6365 6261 636b 5f74 6578 743a 2073 7472  ceback_text: str
-0000af80: 207c 204e 6f6e 650a 0a20 2020 2023 3a20   | None..    #: 
-0000af90: 4966 2074 6869 7320 7461 736b 206f 7220  If this task or 
-0000afa0: 6f6e 6520 6f66 2069 7473 2064 6570 656e  one of its depen
-0000afb0: 6465 6e63 6965 7320 6661 696c 6564 2065  dencies failed e
-0000afc0: 7865 6375 7469 6e67 2c20 7468 6520 6661  xecuting, the fa
-0000afd0: 696c 6564 2074 6173 6b20 6973 0a20 2020  iled task is.   
-0000afe0: 2023 3a20 7374 6f72 6564 2068 6572 6520   #: stored here 
-0000aff0: 2870 6f73 7369 626c 7920 6974 7365 6c66  (possibly itself
-0000b000: 292e 0a20 2020 2065 7863 6570 7469 6f6e  )..    exception
-0000b010: 5f62 6c61 6d65 3a20 5461 736b 5374 6174  _blame: TaskStat
-0000b020: 6520 7c20 4e6f 6e65 0a0a 2020 2020 233a  e | None..    #:
-0000b030: 2057 6f72 6b65 7220 6164 6472 6573 7365   Worker addresse
-0000b040: 7320 6f6e 2077 6869 6368 2065 7272 6f72  s on which error
-0000b050: 7320 6170 7065 6172 6564 2c20 6361 7573  s appeared, caus
-0000b060: 696e 6720 7468 6973 2074 6173 6b20 746f  ing this task to
-0000b070: 2062 6520 696e 2061 6e20 6572 726f 720a   be in an error.
-0000b080: 2020 2020 233a 2073 7461 7465 2e0a 2020      #: state..  
-0000b090: 2020 6572 7265 645f 6f6e 3a20 7365 745b    erred_on: set[
-0000b0a0: 7374 725d 207c 204e 6f6e 650a 0a20 2020  str] | None..   
-0000b0b0: 2023 3a20 5468 6520 6e75 6d62 6572 206f   #: The number o
-0000b0c0: 6620 7469 6d65 7320 7468 6973 2074 6173  f times this tas
-0000b0d0: 6b20 6861 7320 6265 656e 2069 6e76 6f6c  k has been invol
-0000b0e0: 7665 6420 696e 2061 2077 6f72 6b65 7220  ved in a worker 
-0000b0f0: 6465 6174 682e 0a20 2020 2023 3a0a 2020  death..    #:.  
-0000b100: 2020 233a 2053 6f6d 6520 7461 736b 7320    #: Some tasks 
-0000b110: 6d61 7920 6361 7573 6520 776f 726b 6572  may cause worker
-0000b120: 7320 746f 2064 6965 2028 7375 6368 2061  s to die (such a
-0000b130: 7320 6361 6c6c 696e 6720 6060 6f73 2e5f  s calling ``os._
-0000b140: 6578 6974 2830 2960 6029 2e20 5768 656e  exit(0)``). When
-0000b150: 2061 0a20 2020 2023 3a20 776f 726b 6572   a.    #: worker
-0000b160: 2064 6965 732c 2061 6c6c 206f 6620 7468   dies, all of th
-0000b170: 6520 7461 736b 7320 6f6e 2074 6861 7420  e tasks on that 
-0000b180: 776f 726b 6572 2061 7265 2072 6561 7373  worker are reass
-0000b190: 6967 6e65 6420 746f 206f 7468 6572 732e  igned to others.
-0000b1a0: 2054 6869 730a 2020 2020 233a 2063 6f6d   This.    #: com
-0000b1b0: 6269 6e61 7469 6f6e 206f 6620 6265 6861  bination of beha
-0000b1c0: 7669 6f72 7320 6361 6e20 6361 7573 6520  viors can cause 
-0000b1d0: 6120 6261 6420 7461 736b 2074 6f20 6361  a bad task to ca
-0000b1e0: 7461 7374 726f 7068 6963 616c 6c79 2064  tastrophically d
-0000b1f0: 6573 7472 6f79 2061 6c6c 0a20 2020 2023  estroy all.    #
-0000b200: 3a20 776f 726b 6572 7320 6f6e 2074 6865  : workers on the
-0000b210: 2063 6c75 7374 6572 2c20 6f6e 6520 6166   cluster, one af
-0000b220: 7465 7220 616e 6f74 6865 722e 2057 6865  ter another. Whe
-0000b230: 6e65 7665 7220 6120 776f 726b 6572 2064  never a worker d
-0000b240: 6965 732c 2077 6520 6d61 726b 2065 6163  ies, we mark eac
-0000b250: 680a 2020 2020 233a 2074 6173 6b20 6375  h.    #: task cu
-0000b260: 7272 656e 746c 7920 7072 6f63 6573 7369  rrently processi
-0000b270: 6e67 206f 6e20 7468 6174 2077 6f72 6b65  ng on that worke
-0000b280: 7220 2861 7320 7265 636f 7264 6564 2062  r (as recorded b
-0000b290: 790a 2020 2020 233a 203a 6174 7472 3a60  y.    #: :attr:`
-0000b2a0: 576f 726b 6572 5374 6174 652e 7072 6f63  WorkerState.proc
-0000b2b0: 6573 7369 6e67 6029 2061 7320 7375 7370  essing`) as susp
-0000b2c0: 6963 696f 7573 2e20 4966 2061 2074 6173  icious. If a tas
-0000b2d0: 6b20 6973 2069 6e76 6f6c 7665 6420 696e  k is involved in
-0000b2e0: 2074 6872 6565 0a20 2020 2023 3a20 6465   three.    #: de
-0000b2f0: 6174 6873 2028 6f72 2073 6f6d 6520 6f74  aths (or some ot
-0000b300: 6865 7220 6669 7865 6420 636f 6e73 7461  her fixed consta
-0000b310: 6e74 2920 7468 656e 2077 6520 6d61 726b  nt) then we mark
-0000b320: 2074 6865 2074 6173 6b20 6173 2060 6065   the task as ``e
-0000b330: 7272 6564 6060 2e0a 2020 2020 7375 7370  rred``..    susp
-0000b340: 6963 696f 7573 3a20 696e 740a 0a20 2020  icious: int..   
-0000b350: 2023 3a20 4120 7365 7420 6f66 2068 6f73   #: A set of hos
-0000b360: 746e 616d 6573 2077 6865 7265 2074 6869  tnames where thi
-0000b370: 7320 7461 736b 2063 616e 2062 6520 7275  s task can be ru
-0000b380: 6e20 286f 7220 6060 4e6f 6e65 6060 2069  n (or ``None`` i
-0000b390: 6620 656d 7074 7929 2e20 5573 7561 6c6c  f empty). Usuall
-0000b3a0: 790a 2020 2020 233a 2074 6869 7320 6973  y.    #: this is
-0000b3b0: 2065 6d70 7479 2075 6e6c 6573 7320 7468   empty unless th
-0000b3c0: 6520 7461 736b 2068 6173 2062 6565 6e20  e task has been 
-0000b3d0: 7370 6563 6966 6963 616c 6c79 2072 6573  specifically res
-0000b3e0: 7472 6963 7465 6420 746f 206f 6e6c 7920  tricted to only 
-0000b3f0: 7275 6e20 6f6e 0a20 2020 2023 3a20 6365  run on.    #: ce
-0000b400: 7274 6169 6e20 686f 7374 732e 2041 2068  rtain hosts. A h
-0000b410: 6f73 746e 616d 6520 6d61 7920 636f 7272  ostname may corr
-0000b420: 6573 706f 6e64 2074 6f20 6f6e 6520 6f72  espond to one or
-0000b430: 2073 6576 6572 616c 2063 6f6e 6e65 6374   several connect
-0000b440: 6564 2077 6f72 6b65 7273 2e0a 2020 2020  ed workers..    
-0000b450: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
-0000b460: 733a 2073 6574 5b73 7472 5d20 7c20 4e6f  s: set[str] | No
-0000b470: 6e65 0a0a 2020 2020 233a 2041 2073 6574  ne..    #: A set
-0000b480: 206f 6620 636f 6d70 6c65 7465 2077 6f72   of complete wor
-0000b490: 6b65 7220 6164 6472 6573 7365 7320 7768  ker addresses wh
-0000b4a0: 6572 6520 7468 6973 2063 616e 2062 6520  ere this can be 
-0000b4b0: 7275 6e20 286f 7220 6060 4e6f 6e65 6060  run (or ``None``
-0000b4c0: 2069 6620 656d 7074 7929 2e0a 2020 2020   if empty)..    
-0000b4d0: 233a 2055 7375 616c 6c79 2074 6869 7320  #: Usually this 
-0000b4e0: 6973 2065 6d70 7479 2075 6e6c 6573 7320  is empty unless 
-0000b4f0: 7468 6520 7461 736b 2068 6173 2062 6565  the task has bee
-0000b500: 6e20 7370 6563 6966 6963 616c 6c79 2072  n specifically r
-0000b510: 6573 7472 6963 7465 6420 746f 206f 6e6c  estricted to onl
-0000b520: 790a 2020 2020 233a 2072 756e 206f 6e20  y.    #: run on 
-0000b530: 6365 7274 6169 6e20 776f 726b 6572 732e  certain workers.
-0000b540: 0a20 2020 2023 3a20 4e6f 7465 2074 6869  .    #: Note thi
-0000b550: 7320 6973 2074 7261 636b 696e 6720 776f  s is tracking wo
-0000b560: 726b 6572 2061 6464 7265 7373 6573 2c20  rker addresses, 
-0000b570: 6e6f 7420 776f 726b 6572 2073 7461 7465  not worker state
-0000b580: 732c 2073 696e 6365 2074 6865 2073 7065  s, since the spe
-0000b590: 6369 6669 630a 2020 2020 233a 2077 6f72  cific.    #: wor
-0000b5a0: 6b65 7273 206d 6179 206e 6f74 2062 6520  kers may not be 
-0000b5b0: 636f 6e6e 6563 7465 6420 6174 2074 6869  connected at thi
-0000b5c0: 7320 7469 6d65 2e0a 2020 2020 776f 726b  s time..    work
-0000b5d0: 6572 5f72 6573 7472 6963 7469 6f6e 733a  er_restrictions:
-0000b5e0: 2073 6574 5b73 7472 5d20 7c20 4e6f 6e65   set[str] | None
-0000b5f0: 0a0a 2020 2020 233a 2052 6573 6f75 7263  ..    #: Resourc
-0000b600: 6573 2072 6571 7569 7265 6420 6279 2074  es required by t
-0000b610: 6869 7320 7461 736b 2c20 7375 6368 2061  his task, such a
-0000b620: 7320 6060 7b27 6770 7527 3a20 317d 6060  s ``{'gpu': 1}``
-0000b630: 206f 7220 6060 7b27 6d65 6d6f 7279 273a   or ``{'memory':
-0000b640: 2031 6539 7d60 600a 2020 2020 233a 2054   1e9}``.    #: T
-0000b650: 6865 7365 2061 7265 2075 7365 722d 6465  hese are user-de
-0000b660: 6669 6e65 6420 6e61 6d65 7320 616e 6420  fined names and 
-0000b670: 6172 6520 6d61 7463 6865 6420 6167 6169  are matched agai
-0000b680: 6e73 7420 7468 6520 3a20 636f 6e74 656e  nst the : conten
-0000b690: 7473 206f 6620 6561 6368 0a20 2020 2023  ts of each.    #
-0000b6a0: 3a20 3a61 7474 723a 6057 6f72 6b65 7253  : :attr:`WorkerS
-0000b6b0: 7461 7465 2e72 6573 6f75 7263 6573 6020  tate.resources` 
-0000b6c0: 6469 6374 696f 6e61 7279 2e0a 2020 2020  dictionary..    
-0000b6d0: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
-0000b6e0: 7469 6f6e 733a 2064 6963 745b 7374 722c  tions: dict[str,
-0000b6f0: 2066 6c6f 6174 5d20 7c20 4e6f 6e65 0a0a   float] | None..
-0000b700: 2020 2020 233a 2046 616c 7365 0a20 2020      #: False.   
-0000b710: 2023 3a20 2020 2020 4561 6368 206f 6620   #:     Each of 
-0000b720: 3a61 7474 723a 6068 6f73 745f 7265 7374  :attr:`host_rest
-0000b730: 7269 6374 696f 6e73 602c 203a 6174 7472  rictions`, :attr
-0000b740: 3a60 776f 726b 6572 5f72 6573 7472 6963  :`worker_restric
-0000b750: 7469 6f6e 7360 2061 6e64 0a20 2020 2023  tions` and.    #
-0000b760: 3a20 2020 2020 3a61 7474 723a 6072 6573  :     :attr:`res
-0000b770: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
-0000b780: 6e73 6020 6973 2061 2068 6172 6420 636f  ns` is a hard co
-0000b790: 6e73 7472 6169 6e74 3a20 6966 206e 6f20  nstraint: if no 
-0000b7a0: 776f 726b 6572 2069 7320 6176 6169 6c61  worker is availa
-0000b7b0: 626c 650a 2020 2020 233a 2020 2020 2073  ble.    #:     s
-0000b7c0: 6174 6973 6679 696e 6720 7468 6f73 6520  atisfying those 
-0000b7d0: 7265 7374 7269 6374 696f 6e73 2c20 7468  restrictions, th
-0000b7e0: 6520 7461 736b 2063 616e 6e6f 7420 676f  e task cannot go
-0000b7f0: 2069 6e74 6f20 7468 6520 2270 726f 6365   into the "proce
-0000b800: 7373 696e 6722 2073 7461 7465 0a20 2020  ssing" state.   
-0000b810: 2023 3a20 2020 2020 616e 6420 7769 6c6c   #:     and will
-0000b820: 2069 6e73 7465 6164 2067 6f20 696e 746f   instead go into
-0000b830: 2074 6865 2022 6e6f 2d77 6f72 6b65 7222   the "no-worker"
-0000b840: 2073 7461 7465 2e0a 2020 2020 233a 2054   state..    #: T
-0000b850: 7275 650a 2020 2020 233a 2020 2020 2054  rue.    #:     T
-0000b860: 6865 2061 626f 7665 2072 6573 7472 6963  he above restric
-0000b870: 7469 6f6e 7320 6172 6520 6d65 7265 2070  tions are mere p
-0000b880: 7265 6665 7265 6e63 6573 3a20 6966 206e  references: if n
-0000b890: 6f20 776f 726b 6572 2069 7320 6176 6169  o worker is avai
-0000b8a0: 6c61 626c 650a 2020 2020 233a 2020 2020  lable.    #:    
-0000b8b0: 2073 6174 6973 6679 696e 6720 7468 6f73   satisfying thos
-0000b8c0: 6520 7265 7374 7269 6374 696f 6e73 2c20  e restrictions, 
-0000b8d0: 7468 6520 7461 736b 2063 616e 2073 7469  the task can sti
-0000b8e0: 6c6c 2067 6f20 696e 746f 2074 6865 0a20  ll go into the. 
-0000b8f0: 2020 2023 3a20 2020 2020 2270 726f 6365     #:     "proce
-0000b900: 7373 696e 6722 2073 7461 7465 2061 6e64  ssing" state and
-0000b910: 2062 6520 7365 6e74 2066 6f72 2065 7865   be sent for exe
-0000b920: 6375 7469 6f6e 2074 6f20 616e 6f74 6865  cution to anothe
-0000b930: 7220 636f 6e6e 6563 7465 6420 776f 726b  r connected work
-0000b940: 6572 2e0a 2020 2020 6c6f 6f73 655f 7265  er..    loose_re
-0000b950: 7374 7269 6374 696f 6e73 3a20 626f 6f6c  strictions: bool
-0000b960: 0a0a 2020 2020 233a 2057 6865 7468 6572  ..    #: Whether
-0000b970: 2074 6869 7320 7461 736b 2069 7320 616e   this task is an
-0000b980: 2041 6374 6f72 0a20 2020 2061 6374 6f72   Actor.    actor
-0000b990: 3a20 626f 6f6c 0a0a 2020 2020 233a 2054  : bool..    #: T
-0000b9a0: 6865 2067 726f 7570 206f 6620 7461 736b  he group of task
-0000b9b0: 7320 746f 2077 6869 6368 2074 6869 7320  s to which this 
-0000b9c0: 6f6e 6520 6265 6c6f 6e67 730a 2020 2020  one belongs.    
-0000b9d0: 6772 6f75 703a 2054 6173 6b47 726f 7570  group: TaskGroup
-0000b9e0: 0a0a 2020 2020 233a 2053 616d 6520 6173  ..    #: Same as
-0000b9f0: 206f 6620 6772 6f75 702e 6e61 6d65 0a20   of group.name. 
-0000ba00: 2020 2067 726f 7570 5f6b 6579 3a20 7374     group_key: st
-0000ba10: 720a 0a20 2020 2023 3a20 4d65 7461 6461  r..    #: Metada
-0000ba20: 7461 2072 656c 6174 6564 2074 6f20 7461  ta related to ta
-0000ba30: 736b 0a20 2020 206d 6574 6164 6174 613a  sk.    metadata:
-0000ba40: 2064 6963 745b 7374 722c 2041 6e79 5d20   dict[str, Any] 
-0000ba50: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2054  | None..    #: T
-0000ba60: 6173 6b20 616e 6e6f 7461 7469 6f6e 730a  ask annotations.
-0000ba70: 2020 2020 616e 6e6f 7461 7469 6f6e 733a      annotations:
-0000ba80: 2064 6963 745b 7374 722c 2041 6e79 5d20   dict[str, Any] 
-0000ba90: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2054  | None..    #: T
-0000baa0: 6865 2075 6e69 7175 6520 6964 656e 7469  he unique identi
-0000bab0: 6669 6572 206f 6620 6120 7370 6563 6966  fier of a specif
-0000bac0: 6963 2065 7865 6375 7469 6f6e 206f 6620  ic execution of 
-0000bad0: 6120 7461 736b 2e20 5468 6973 2069 6465  a task. This ide
-0000bae0: 6e74 6966 6965 720a 2020 2020 233a 2069  ntifier.    #: i
-0000baf0: 7320 7573 6564 2074 6f20 7369 676e 2061  s used to sign a
-0000bb00: 2074 6173 6b20 7375 6368 2074 6861 7420   task such that 
-0000bb10: 7468 6520 6173 7369 676e 6564 2077 6f72  the assigned wor
-0000bb20: 6b65 7220 6973 2065 7870 6563 7465 6420  ker is expected 
-0000bb30: 746f 2072 6574 7572 6e0a 2020 2020 233a  to return.    #:
-0000bb40: 2074 6865 2073 616d 6520 6964 656e 7469   the same identi
-0000bb50: 6669 6572 2069 6e20 7468 6520 7461 736b  fier in the task
-0000bb60: 2d66 696e 6973 6865 6420 6d65 7373 6167  -finished messag
-0000bb70: 652e 2054 6869 7320 6973 2075 7365 6420  e. This is used 
-0000bb80: 746f 2063 6f72 7265 6c61 7465 0a20 2020  to correlate.   
-0000bb90: 2023 3a20 7265 7370 6f6e 7365 732e 0a20   #: responses.. 
-0000bba0: 2020 2023 3a20 4f6e 6c79 2074 6865 206d     #: Only the m
-0000bbb0: 6f73 7420 7265 6365 6e74 6c79 2061 7373  ost recently ass
-0000bbc0: 6967 6e65 6420 776f 726b 6572 2069 7320  igned worker is 
-0000bbd0: 7472 7573 7465 642e 2041 6c6c 206f 7468  trusted. All oth
-0000bbe0: 6572 2072 6573 756c 7473 2077 696c 6c0a  er results will.
-0000bbf0: 2020 2020 233a 2062 6520 7265 6a65 6374      #: be reject
-0000bc00: 6564 2e0a 2020 2020 7275 6e5f 6964 3a20  ed..    run_id: 
-0000bc10: 696e 7420 7c20 4e6f 6e65 0a0a 2020 2020  int | None..    
-0000bc20: 233a 2057 6865 7468 6572 2074 6f20 636f  #: Whether to co
-0000bc30: 6e73 6964 6572 2074 6869 7320 7461 736b  nsider this task
-0000bc40: 2072 6f6f 7469 7368 2069 6e20 7468 6520   rootish in the 
-0000bc50: 636f 6e74 6578 7420 6f66 2074 6173 6b20  context of task 
-0000bc60: 7175 6575 6569 6e67 0a20 2020 2023 3a20  queueing.    #: 
-0000bc70: 5472 7565 0a20 2020 2023 3a20 2020 2020  True.    #:     
-0000bc80: 416c 7761 7973 2063 6f6e 7369 6465 7220  Always consider 
-0000bc90: 7468 6973 2074 6173 6b20 726f 6f74 6973  this task rootis
-0000bca0: 680a 2020 2020 233a 2046 616c 7365 0a20  h.    #: False. 
-0000bcb0: 2020 2023 3a20 2020 2020 4e65 7665 7220     #:     Never 
-0000bcc0: 636f 6e73 6964 6572 2074 6869 7320 7461  consider this ta
-0000bcd0: 736b 2072 6f6f 7469 7368 0a20 2020 2023  sk rootish.    #
-0000bce0: 3a20 4e6f 6e65 0a20 2020 2023 3a20 2020  : None.    #:   
-0000bcf0: 2020 5573 6520 6120 6865 7572 6973 7469    Use a heuristi
-0000bd00: 6320 746f 2064 6574 6572 6d69 6e65 2077  c to determine w
-0000bd10: 6865 7468 6572 2074 6869 7320 7461 736b  hether this task
-0000bd20: 2073 686f 756c 6420 6265 2063 6f6e 7369   should be consi
-0000bd30: 6465 7265 6420 726f 6f74 6973 680a 2020  dered rootish.  
-0000bd40: 2020 5f72 6f6f 7469 7368 3a20 626f 6f6c    _rootish: bool
-0000bd50: 207c 204e 6f6e 650a 0a20 2020 2023 3a20   | None..    #: 
-0000bd60: 4361 6368 6564 2068 6173 6820 6f66 203a  Cached hash of :
-0000bd70: 6174 7472 3a60 7e54 6173 6b53 7461 7465  attr:`~TaskState
-0000bd80: 2e63 6c69 656e 745f 6b65 7960 0a20 2020  .client_key`.   
-0000bd90: 205f 6861 7368 3a20 696e 740a 0a20 2020   _hash: int..   
-0000bda0: 2023 2053 7570 706f 7274 2066 6f72 2077   # Support for w
-0000bdb0: 6561 6b72 6566 7320 746f 2061 2063 6c61  eakrefs to a cla
-0000bdc0: 7373 2077 6974 6820 5f5f 736c 6f74 735f  ss with __slots_
-0000bdd0: 5f0a 2020 2020 5f5f 7765 616b 7265 665f  _.    __weakref_
-0000bde0: 5f3a 2041 6e79 203d 204e 6f6e 650a 2020  _: Any = None.  
-0000bdf0: 2020 5f5f 736c 6f74 735f 5f20 3d20 7475    __slots__ = tu
-0000be00: 706c 6528 5f5f 616e 6e6f 7461 7469 6f6e  ple(__annotation
-0000be10: 735f 5f29 0a0a 2020 2020 233a 2047 6c6f  s__)..    #: Glo
-0000be20: 6261 6c20 6974 6572 6174 6f72 2075 7365  bal iterator use
-0000be30: 6420 746f 2063 7265 6174 6520 756e 6971  d to create uniq
-0000be40: 7565 2074 6173 6b20 7275 6e20 4944 730a  ue task run IDs.
-0000be50: 2020 2020 5f72 756e 5f69 645f 6974 6572      _run_id_iter
-0000be60: 6174 6f72 3a20 436c 6173 7356 6172 5b69  ator: ClassVar[i
-0000be70: 7465 7274 6f6f 6c73 2e63 6f75 6e74 5d20  tertools.count] 
-0000be80: 3d20 6974 6572 746f 6f6c 732e 636f 756e  = itertools.coun
-0000be90: 7428 290a 0a20 2020 2023 2049 6e73 7461  t()..    # Insta
-0000bea0: 6e63 6573 206e 6f74 2070 6172 7420 6f66  nces not part of
-0000beb0: 2073 6c6f 7473 2073 696e 6365 2063 6c61   slots since cla
-0000bec0: 7373 2076 6172 6961 626c 650a 2020 2020  ss variable.    
-0000bed0: 5f69 6e73 7461 6e63 6573 3a20 436c 6173  _instances: Clas
-0000bee0: 7356 6172 5b77 6561 6b72 6566 2e57 6561  sVar[weakref.Wea
-0000bef0: 6b53 6574 5b54 6173 6b53 7461 7465 5d5d  kSet[TaskState]]
-0000bf00: 203d 2077 6561 6b72 6566 2e57 6561 6b53   = weakref.WeakS
-0000bf10: 6574 2829 0a0a 2020 2020 6465 6620 5f5f  et()..    def __
-0000bf20: 696e 6974 5f5f 280a 2020 2020 2020 2020  init__(.        
-0000bf30: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
-0000bf40: 793a 204b 6579 2c0a 2020 2020 2020 2020  y: Key,.        
-0000bf50: 7275 6e5f 7370 6563 3a20 545f 7275 6e73  run_spec: T_runs
-0000bf60: 7065 6320 7c20 4e6f 6e65 2c0a 2020 2020  pec | None,.    
-0000bf70: 2020 2020 7374 6174 653a 2054 6173 6b53      state: TaskS
-0000bf80: 7461 7465 5374 6174 652c 0a20 2020 2029  tateState,.    )
-0000bf90: 3a0a 2020 2020 2020 2020 2320 4d6f 7374  :.        # Most
-0000bfa0: 206f 6620 7468 6520 6174 7472 6962 7574   of the attribut
-0000bfb0: 6573 2062 656c 6f77 2061 7265 206e 6f74  es below are not
-0000bfc0: 2069 6e69 7469 616c 697a 6564 2073 696e   initialized sin
-0000bfd0: 6365 2074 6865 7265 2061 7265 206e 6f74  ce there are not
-0000bfe0: 0a20 2020 2020 2020 2023 2061 6c77 6179  .        # alway
-0000bff0: 7320 7265 7175 6972 6564 2066 6f72 2065  s required for e
-0000c000: 7665 7279 2074 6173 6b73 2e20 5061 7274  very tasks. Part
-0000c010: 6963 756c 6172 6c79 2066 6f72 206c 6172  icularly for lar
-0000c020: 6765 2067 7261 7068 732c 2074 6865 7365  ge graphs, these
-0000c030: 0a20 2020 2020 2020 2023 2063 616e 2061  .        # can a
-0000c040: 6464 2075 7020 7369 676e 6966 6963 616e  dd up significan
-0000c050: 7420 6d65 6d6f 7279 2c20 7365 650a 2020  t memory, see.  
-0000c060: 2020 2020 2020 2320 6874 7470 733a 2f2f        # https://
-0000c070: 6769 7468 7562 2e63 6f6d 2f64 6173 6b2f  github.com/dask/
-0000c080: 6469 7374 7269 6275 7465 642f 7075 6c6c  distributed/pull
-0000c090: 2f38 3333 310a 2020 2020 2020 2020 2320  /8331.        # 
-0000c0a0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-0000c0b0: 6f6d 2f64 6173 6b2f 6469 7374 7269 6275  om/dask/distribu
-0000c0c0: 7465 642f 6973 7375 6573 2f37 3939 3823  ted/issues/7998#
-0000c0d0: 6973 7375 6563 6f6d 6d65 6e74 2d31 3637  issuecomment-167
-0000c0e0: 3731 3637 3437 380a 2020 2020 2020 2020  7167478.        
-0000c0f0: 7365 6c66 2e6b 6579 203d 206b 6579 0a20  self.key = key. 
-0000c100: 2020 2020 2020 2073 656c 662e 5f68 6173         self._has
-0000c110: 6820 3d20 6861 7368 286b 6579 290a 2020  h = hash(key).  
-0000c120: 2020 2020 2020 7365 6c66 2e72 756e 5f73        self.run_s
-0000c130: 7065 6320 3d20 7275 6e5f 7370 6563 0a20  pec = run_spec. 
-0000c140: 2020 2020 2020 2073 656c 662e 5f73 7461         self._sta
-0000c150: 7465 203d 2073 7461 7465 0a20 2020 2020  te = state.     
-0000c160: 2020 2073 656c 662e 6578 6365 7074 696f     self.exceptio
-0000c170: 6e20 3d20 4e6f 6e65 0a20 2020 2020 2020  n = None.       
-0000c180: 2073 656c 662e 6578 6365 7074 696f 6e5f   self.exception_
-0000c190: 626c 616d 6520 3d20 4e6f 6e65 0a20 2020  blame = None.   
-0000c1a0: 2020 2020 2073 656c 662e 7472 6163 6562       self.traceb
-0000c1b0: 6163 6b20 3d20 4e6f 6e65 0a20 2020 2020  ack = None.     
-0000c1c0: 2020 2073 656c 662e 6578 6365 7074 696f     self.exceptio
-0000c1d0: 6e5f 7465 7874 203d 204e 6f6e 650a 2020  n_text = None.  
-0000c1e0: 2020 2020 2020 7365 6c66 2e74 7261 6365        self.trace
-0000c1f0: 6261 636b 5f74 6578 7420 3d20 4e6f 6e65  back_text = None
-0000c200: 0a20 2020 2020 2020 2073 656c 662e 7375  .        self.su
-0000c210: 7370 6963 696f 7573 203d 2030 0a20 2020  spicious = 0.   
-0000c220: 2020 2020 2073 656c 662e 7265 7472 6965       self.retrie
-0000c230: 7320 3d20 300a 2020 2020 2020 2020 7365  s = 0.        se
-0000c240: 6c66 2e6e 6279 7465 7320 3d20 2d31 0a20  lf.nbytes = -1. 
-0000c250: 2020 2020 2020 2073 656c 662e 7072 696f         self.prio
-0000c260: 7269 7479 203d 204e 6f6e 650a 2020 2020  rity = None.    
-0000c270: 2020 2020 7365 6c66 2e77 686f 5f77 616e      self.who_wan
-0000c280: 7473 203d 204e 6f6e 650a 2020 2020 2020  ts = None.      
-0000c290: 2020 7365 6c66 2e64 6570 656e 6465 6e63    self.dependenc
-0000c2a0: 6965 7320 3d20 7365 7428 290a 2020 2020  ies = set().    
-0000c2b0: 2020 2020 7365 6c66 2e64 6570 656e 6465      self.depende
-0000c2c0: 6e74 7320 3d20 7365 7428 290a 2020 2020  nts = set().    
-0000c2d0: 2020 2020 7365 6c66 2e77 6169 7469 6e67      self.waiting
-0000c2e0: 5f6f 6e20 3d20 4e6f 6e65 0a20 2020 2020  _on = None.     
-0000c2f0: 2020 2073 656c 662e 7761 6974 6572 7320     self.waiters 
-0000c300: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
-0000c310: 656c 662e 7768 6f5f 6861 7320 3d20 4e6f  elf.who_has = No
-0000c320: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-0000c330: 7072 6f63 6573 7369 6e67 5f6f 6e20 3d20  processing_on = 
-0000c340: 4e6f 6e65 0a20 2020 2020 2020 2073 656c  None.        sel
-0000c350: 662e 6861 735f 6c6f 7374 5f64 6570 656e  f.has_lost_depen
-0000c360: 6465 6e63 6965 7320 3d20 4661 6c73 650a  dencies = False.
-0000c370: 2020 2020 2020 2020 7365 6c66 2e68 6f73          self.hos
-0000c380: 745f 7265 7374 7269 6374 696f 6e73 203d  t_restrictions =
-0000c390: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-0000c3a0: 6c66 2e77 6f72 6b65 725f 7265 7374 7269  lf.worker_restri
-0000c3b0: 6374 696f 6e73 203d 204e 6f6e 650a 2020  ctions = None.  
-0000c3c0: 2020 2020 2020 7365 6c66 2e72 6573 6f75        self.resou
-0000c3d0: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-0000c3e0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0000c3f0: 7365 6c66 2e6c 6f6f 7365 5f72 6573 7472  self.loose_restr
-0000c400: 6963 7469 6f6e 7320 3d20 4661 6c73 650a  ictions = False.
-0000c410: 2020 2020 2020 2020 7365 6c66 2e61 6374          self.act
-0000c420: 6f72 203d 2046 616c 7365 0a20 2020 2020  or = False.     
-0000c430: 2020 2073 656c 662e 7072 6566 6978 203d     self.prefix =
-0000c440: 204e 6f6e 6520 2023 2074 7970 653a 2069   None  # type: i
-0000c450: 676e 6f72 650a 2020 2020 2020 2020 7365  gnore.        se
-0000c460: 6c66 2e74 7970 6520 3d20 4e6f 6e65 2020  lf.type = None  
-0000c470: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
-0000c480: 2020 2020 2020 2073 656c 662e 6772 6f75         self.grou
-0000c490: 705f 6b65 7920 3d20 6b65 795f 7370 6c69  p_key = key_spli
-0000c4a0: 745f 6772 6f75 7028 6b65 7929 0a20 2020  t_group(key).   
-0000c4b0: 2020 2020 2073 656c 662e 6772 6f75 7020       self.group 
-0000c4c0: 3d20 4e6f 6e65 2020 2320 7479 7065 3a20  = None  # type: 
-0000c4d0: 6967 6e6f 7265 0a20 2020 2020 2020 2073  ignore.        s
-0000c4e0: 656c 662e 6d65 7461 6461 7461 203d 204e  elf.metadata = N
-0000c4f0: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-0000c500: 2e61 6e6e 6f74 6174 696f 6e73 203d 204e  .annotations = N
-0000c510: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
-0000c520: 2e65 7272 6564 5f6f 6e20 3d20 4e6f 6e65  .erred_on = None
-0000c530: 0a20 2020 2020 2020 2073 656c 662e 5f72  .        self._r
-0000c540: 6f6f 7469 7368 203d 204e 6f6e 650a 2020  ootish = None.  
-0000c550: 2020 2020 2020 7365 6c66 2e72 756e 5f69        self.run_i
-0000c560: 6420 3d20 4e6f 6e65 0a20 2020 2020 2020  d = None.       
-0000c570: 2054 6173 6b53 7461 7465 2e5f 696e 7374   TaskState._inst
-0000c580: 616e 6365 732e 6164 6428 7365 6c66 290a  ances.add(self).
-0000c590: 0a20 2020 2064 6566 205f 5f68 6173 685f  .    def __hash_
-0000c5a0: 5f28 7365 6c66 2920 2d3e 2069 6e74 3a0a  _(self) -> int:.
-0000c5b0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0000c5c0: 656c 662e 5f68 6173 680a 0a20 2020 2064  elf._hash..    d
-0000c5d0: 6566 205f 5f65 715f 5f28 7365 6c66 2c20  ef __eq__(self, 
-0000c5e0: 6f74 6865 723a 206f 626a 6563 7429 202d  other: object) -
-0000c5f0: 3e20 626f 6f6c 3a0a 2020 2020 2020 2020  > bool:.        
-0000c600: 7265 7475 726e 2069 7369 6e73 7461 6e63  return isinstanc
-0000c610: 6528 6f74 6865 722c 2054 6173 6b53 7461  e(other, TaskSta
-0000c620: 7465 2920 616e 6420 7365 6c66 2e6b 6579  te) and self.key
-0000c630: 203d 3d20 6f74 6865 722e 6b65 790a 0a20   == other.key.. 
-0000c640: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-0000c650: 2064 6566 2073 7461 7465 2873 656c 6629   def state(self)
-0000c660: 202d 3e20 5461 736b 5374 6174 6553 7461   -> TaskStateSta
-0000c670: 7465 3a0a 2020 2020 2020 2020 2222 2254  te:.        """T
-0000c680: 6869 7320 7461 736b 2773 2063 7572 7265  his task's curre
-0000c690: 6e74 2073 7461 7465 2e20 2056 616c 6964  nt state.  Valid
-0000c6a0: 2073 7461 7465 7320 6172 6520 6060 7265   states are ``re
-0000c6b0: 6c65 6173 6564 6060 2c20 6060 7761 6974  leased``, ``wait
-0000c6c0: 696e 6760 602c 0a20 2020 2020 2020 2060  ing``,.        `
-0000c6d0: 606e 6f2d 776f 726b 6572 6060 2c20 6060  `no-worker``, ``
-0000c6e0: 7072 6f63 6573 7369 6e67 6060 2c20 6060  processing``, ``
-0000c6f0: 6d65 6d6f 7279 6060 2c20 6060 6572 7265  memory``, ``erre
-0000c700: 6460 6020 616e 6420 6060 666f 7267 6f74  d`` and ``forgot
-0000c710: 7465 6e60 602e 2020 4966 2069 740a 2020  ten``.  If it.  
-0000c720: 2020 2020 2020 6973 2060 6066 6f72 676f        is ``forgo
-0000c730: 7474 656e 6060 2c20 7468 6520 7461 736b  tten``, the task
-0000c740: 2069 736e 2774 2073 746f 7265 6420 696e   isn't stored in
-0000c750: 2074 6865 2060 6074 6173 6b73 6060 2064   the ``tasks`` d
-0000c760: 6963 7469 6f6e 6172 7920 616e 796d 6f72  ictionary anymor
-0000c770: 6520 616e 640a 2020 2020 2020 2020 7769  e and.        wi
-0000c780: 6c6c 2070 726f 6261 626c 7920 6469 7361  ll probably disa
-0000c790: 7070 6561 7220 736f 6f6e 2066 726f 6d20  ppear soon from 
-0000c7a0: 6d65 6d6f 7279 2e0a 2020 2020 2020 2020  memory..        
-0000c7b0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
-0000c7c0: 726e 2073 656c 662e 5f73 7461 7465 0a0a  rn self._state..
-0000c7d0: 2020 2020 4073 7461 7465 2e73 6574 7465      @state.sette
-0000c7e0: 720a 2020 2020 6465 6620 7374 6174 6528  r.    def state(
-0000c7f0: 7365 6c66 2c20 7661 6c75 653a 2054 6173  self, value: Tas
-0000c800: 6b53 7461 7465 5374 6174 6529 202d 3e20  kStateState) -> 
-0000c810: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
-0000c820: 6c66 2e67 726f 7570 2e73 7461 7465 735b  lf.group.states[
-0000c830: 7365 6c66 2e5f 7374 6174 655d 202d 3d20  self._state] -= 
-0000c840: 310a 2020 2020 2020 2020 7365 6c66 2e67  1.        self.g
-0000c850: 726f 7570 2e73 7461 7465 735b 7661 6c75  roup.states[valu
-0000c860: 655d 202b 3d20 310a 2020 2020 2020 2020  e] += 1.        
-0000c870: 7365 6c66 2e5f 7374 6174 6520 3d20 7661  self._state = va
-0000c880: 6c75 650a 2020 2020 2020 2020 7365 6c66  lue.        self
-0000c890: 2e70 7265 6669 782e 7374 6174 655f 636f  .prefix.state_co
-0000c8a0: 756e 7473 5b76 616c 7565 5d20 2b3d 2031  unts[value] += 1
-0000c8b0: 0a0a 2020 2020 6465 6620 6164 645f 6465  ..    def add_de
-0000c8c0: 7065 6e64 656e 6379 2873 656c 662c 206f  pendency(self, o
-0000c8d0: 7468 6572 3a20 5461 736b 5374 6174 6529  ther: TaskState)
-0000c8e0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0000c8f0: 2020 2222 2241 6464 2061 6e6f 7468 6572    """Add another
-0000c900: 2074 6173 6b20 6173 2061 2064 6570 656e   task as a depen
-0000c910: 6465 6e63 7920 6f66 2074 6869 7320 7461  dency of this ta
-0000c920: 736b 2222 220a 2020 2020 2020 2020 7365  sk""".        se
-0000c930: 6c66 2e64 6570 656e 6465 6e63 6965 732e  lf.dependencies.
-0000c940: 6164 6428 6f74 6865 7229 0a20 2020 2020  add(other).     
-0000c950: 2020 2073 656c 662e 6772 6f75 702e 6465     self.group.de
-0000c960: 7065 6e64 656e 6369 6573 2e61 6464 286f  pendencies.add(o
-0000c970: 7468 6572 2e67 726f 7570 290a 2020 2020  ther.group).    
-0000c980: 2020 2020 6f74 6865 722e 6465 7065 6e64      other.depend
-0000c990: 656e 7473 2e61 6464 2873 656c 6629 0a0a  ents.add(self)..
-0000c9a0: 2020 2020 6465 6620 6765 745f 6e62 7974      def get_nbyt
-0000c9b0: 6573 2873 656c 6629 202d 3e20 696e 743a  es(self) -> int:
-0000c9c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000c9d0: 7365 6c66 2e6e 6279 7465 7320 6966 2073  self.nbytes if s
-0000c9e0: 656c 662e 6e62 7974 6573 203e 3d20 3020  elf.nbytes >= 0 
-0000c9f0: 656c 7365 2044 4546 4155 4c54 5f44 4154  else DEFAULT_DAT
-0000ca00: 415f 5349 5a45 0a0a 2020 2020 6465 6620  A_SIZE..    def 
-0000ca10: 7365 745f 6e62 7974 6573 2873 656c 662c  set_nbytes(self,
-0000ca20: 206e 6279 7465 733a 2069 6e74 2920 2d3e   nbytes: int) ->
-0000ca30: 204e 6f6e 653a 0a20 2020 2020 2020 2064   None:.        d
-0000ca40: 6966 6620 3d20 6e62 7974 6573 0a20 2020  iff = nbytes.   
-0000ca50: 2020 2020 206f 6c64 5f6e 6279 7465 7320       old_nbytes 
-0000ca60: 3d20 7365 6c66 2e6e 6279 7465 730a 2020  = self.nbytes.  
-0000ca70: 2020 2020 2020 6966 206f 6c64 5f6e 6279        if old_nby
-0000ca80: 7465 7320 3e3d 2030 3a0a 2020 2020 2020  tes >= 0:.      
-0000ca90: 2020 2020 2020 6469 6666 202d 3d20 6f6c        diff -= ol
-0000caa0: 645f 6e62 7974 6573 0a20 2020 2020 2020  d_nbytes.       
-0000cab0: 2073 656c 662e 6772 6f75 702e 6e62 7974   self.group.nbyt
-0000cac0: 6573 5f74 6f74 616c 202b 3d20 6469 6666  es_total += diff
-0000cad0: 0a20 2020 2020 2020 2066 6f72 2077 7320  .        for ws 
-0000cae0: 696e 2073 656c 662e 7768 6f5f 6861 7320  in self.who_has 
-0000caf0: 6f72 2028 293a 0a20 2020 2020 2020 2020  or ():.         
-0000cb00: 2020 2077 732e 6e62 7974 6573 202b 3d20     ws.nbytes += 
-0000cb10: 6469 6666 0a20 2020 2020 2020 2073 656c  diff.        sel
-0000cb20: 662e 6e62 7974 6573 203d 206e 6279 7465  f.nbytes = nbyte
-0000cb30: 730a 0a20 2020 2064 6566 205f 5f72 6570  s..    def __rep
-0000cb40: 725f 5f28 7365 6c66 2920 2d3e 2073 7472  r__(self) -> str
-0000cb50: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-0000cb60: 2066 223c 5461 736b 5374 6174 6520 7b73   f"<TaskState {s
-0000cb70: 656c 662e 6b65 7921 727d 207b 7365 6c66  elf.key!r} {self
-0000cb80: 2e5f 7374 6174 657d 3e22 0a0a 2020 2020  ._state}>"..    
-0000cb90: 6465 6620 5f72 6570 725f 6874 6d6c 5f28  def _repr_html_(
-0000cba0: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
-0000cbb0: 2020 2020 2020 7265 7475 726e 2067 6574        return get
-0000cbc0: 5f74 656d 706c 6174 6528 2274 6173 6b5f  _template("task_
-0000cbd0: 7374 6174 652e 6874 6d6c 2e6a 3222 292e  state.html.j2").
-0000cbe0: 7265 6e64 6572 280a 2020 2020 2020 2020  render(.        
-0000cbf0: 2020 2020 7374 6174 653d 7365 6c66 2e73      state=self.s
-0000cc00: 7461 7465 2c0a 2020 2020 2020 2020 2020  tate,.          
-0000cc10: 2020 6e62 7974 6573 3d73 656c 662e 6e62    nbytes=self.nb
-0000cc20: 7974 6573 2c0a 2020 2020 2020 2020 2020  ytes,.          
-0000cc30: 2020 6b65 793d 7374 7228 7365 6c66 2e6b    key=str(self.k
-0000cc40: 6579 292c 0a20 2020 2020 2020 2029 0a0a  ey),.        )..
-0000cc50: 2020 2020 6465 6620 7661 6c69 6461 7465      def validate
-0000cc60: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
-0000cc70: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000cc80: 2020 2020 2020 2020 2066 6f72 2063 7320           for cs 
-0000cc90: 696e 2073 656c 662e 7768 6f5f 7761 6e74  in self.who_want
-0000cca0: 7320 6f72 2028 293a 0a20 2020 2020 2020  s or ():.       
-0000ccb0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000ccc0: 6973 696e 7374 616e 6365 2863 732c 2043  isinstance(cs, C
-0000ccd0: 6c69 656e 7453 7461 7465 292c 2028 7265  lientState), (re
-0000cce0: 7072 2863 7329 2c20 7365 6c66 2e77 686f  pr(cs), self.who
-0000ccf0: 5f77 616e 7473 290a 2020 2020 2020 2020  _wants).        
-0000cd00: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
-0000cd10: 6c66 2e77 686f 5f68 6173 206f 7220 2829  lf.who_has or ()
-0000cd20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000cd30: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-0000cd40: 6e63 6528 7773 2c20 576f 726b 6572 5374  nce(ws, WorkerSt
-0000cd50: 6174 6529 2c20 2872 6570 7228 7773 292c  ate), (repr(ws),
-0000cd60: 2073 656c 662e 7768 6f5f 6861 7329 0a20   self.who_has). 
-0000cd70: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
-0000cd80: 7320 696e 2073 656c 662e 6465 7065 6e64  s in self.depend
-0000cd90: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-0000cda0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-0000cdb0: 7369 6e73 7461 6e63 6528 7473 2c20 5461  sinstance(ts, Ta
-0000cdc0: 736b 5374 6174 6529 2c20 2872 6570 7228  skState), (repr(
-0000cdd0: 7473 292c 2073 656c 662e 6465 7065 6e64  ts), self.depend
-0000cde0: 656e 6369 6573 290a 2020 2020 2020 2020  encies).        
-0000cdf0: 2020 2020 666f 7220 7473 2069 6e20 7365      for ts in se
-0000ce00: 6c66 2e64 6570 656e 6465 6e74 733a 0a20  lf.dependents:. 
-0000ce10: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000ce20: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-0000ce30: 2874 732c 2054 6173 6b53 7461 7465 292c  (ts, TaskState),
-0000ce40: 2028 7265 7072 2874 7329 2c20 7365 6c66   (repr(ts), self
-0000ce50: 2e64 6570 656e 6465 6e74 7329 0a20 2020  .dependents).   
-0000ce60: 2020 2020 2020 2020 2076 616c 6964 6174           validat
-0000ce70: 655f 7461 736b 5f73 7461 7465 2873 656c  e_task_state(sel
-0000ce80: 6629 0a20 2020 2020 2020 2065 7863 6570  f).        excep
-0000ce90: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
-0000cea0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-0000ceb0: 6767 6572 2e65 7863 6570 7469 6f6e 2865  gger.exception(e
-0000cec0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0000ced0: 204c 4f47 5f50 4442 3a0a 2020 2020 2020   LOG_PDB:.      
-0000cee0: 2020 2020 2020 2020 2020 696d 706f 7274            import
-0000cef0: 2070 6462 0a0a 2020 2020 2020 2020 2020   pdb..          
-0000cf00: 2020 2020 2020 7064 622e 7365 745f 7472        pdb.set_tr
-0000cf10: 6163 6528 290a 0a20 2020 2064 6566 2067  ace()..    def g
-0000cf20: 6574 5f6e 6279 7465 735f 6465 7073 2873  et_nbytes_deps(s
-0000cf30: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
-0000cf40: 2020 2020 2072 6574 7572 6e20 7375 6d28       return sum(
-0000cf50: 7473 2e67 6574 5f6e 6279 7465 7328 2920  ts.get_nbytes() 
-0000cf60: 666f 7220 7473 2069 6e20 7365 6c66 2e64  for ts in self.d
-0000cf70: 6570 656e 6465 6e63 6965 7329 0a0a 2020  ependencies)..  
-0000cf80: 2020 6465 6620 5f74 6f5f 6469 6374 5f6e    def _to_dict_n
-0000cf90: 6f5f 6e65 7374 2873 656c 662c 202a 2c20  o_nest(self, *, 
-0000cfa0: 6578 636c 7564 653a 2043 6f6e 7461 696e  exclude: Contain
-0000cfb0: 6572 5b73 7472 5d20 3d20 2829 2920 2d3e  er[str] = ()) ->
-0000cfc0: 2064 6963 745b 7374 722c 2041 6e79 5d3a   dict[str, Any]:
-0000cfd0: 0a20 2020 2020 2020 2022 2222 4469 6374  .        """Dict
-0000cfe0: 696f 6e61 7279 2072 6570 7265 7365 6e74  ionary represent
-0000cff0: 6174 696f 6e20 666f 7220 6465 6275 6767  ation for debugg
-0000d000: 696e 6720 7075 7270 6f73 6573 2e0a 2020  ing purposes..  
-0000d010: 2020 2020 2020 4e6f 7420 7479 7065 2073        Not type s
-0000d020: 7461 626c 6520 616e 6420 6e6f 7420 696e  table and not in
-0000d030: 7465 6e64 6564 2066 6f72 2072 6f75 6e64  tended for round
-0000d040: 7472 6970 732e 0a0a 2020 2020 2020 2020  trips...        
-0000d050: 5365 6520 616c 736f 0a20 2020 2020 2020  See also.       
-0000d060: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
-0000d070: 2020 436c 6965 6e74 2e64 756d 705f 636c    Client.dump_cl
-0000d080: 7573 7465 725f 7374 6174 650a 2020 2020  uster_state.    
-0000d090: 2020 2020 6469 7374 7269 6275 7465 642e      distributed.
-0000d0a0: 7574 696c 732e 7265 6375 7273 6976 655f  utils.recursive_
-0000d0b0: 746f 5f64 6963 740a 0a20 2020 2020 2020  to_dict..       
-0000d0c0: 204e 6f74 6573 0a20 2020 2020 2020 202d   Notes.        -
-0000d0d0: 2d2d 2d2d 0a20 2020 2020 2020 2054 6869  ----.        Thi
-0000d0e0: 7320 636c 6173 7320 7573 6573 2060 605f  s class uses ``_
-0000d0f0: 746f 5f64 6963 745f 6e6f 5f6e 6573 7460  to_dict_no_nest`
-0000d100: 6020 696e 7374 6561 6420 6f66 2060 605f  ` instead of ``_
-0000d110: 746f 5f64 6963 7460 602e 0a20 2020 2020  to_dict``..     
-0000d120: 2020 2057 6865 6e20 6120 7461 736b 2072     When a task r
-0000d130: 6566 6572 656e 6365 7320 616e 6f74 6865  eferences anothe
-0000d140: 7220 7461 736b 2c20 6f72 2077 6865 6e20  r task, or when 
-0000d150: 6120 576f 726b 6572 5374 6174 652e 7461  a WorkerState.ta
-0000d160: 736b 7320 636f 6e74 6169 6e73 2074 6173  sks contains tas
-0000d170: 6b73 2c0a 2020 2020 2020 2020 7468 6973  ks,.        this
-0000d180: 206d 6574 686f 6420 6973 206e 6f74 2065   method is not e
-0000d190: 7865 6375 7465 6420 666f 7220 7468 6520  xecuted for the 
-0000d1a0: 696e 6e65 7220 7461 736b 2c20 6576 656e  inner task, even
-0000d1b0: 2069 6620 7468 6520 696e 6e65 7220 7461   if the inner ta
-0000d1c0: 736b 2077 6173 206e 6576 6572 0a20 2020  sk was never.   
-0000d1d0: 2020 2020 2073 6565 6e20 6265 666f 7265       seen before
-0000d1e0: 3b20 796f 7520 6765 7420 6120 7265 7072  ; you get a repr
-0000d1f0: 2069 6e73 7465 6164 2e20 416c 6c20 7461   instead. All ta
-0000d200: 736b 7320 7368 6f75 6c64 206e 6561 746c  sks should neatl
-0000d210: 7920 6170 7065 6172 2075 6e64 6572 0a20  y appear under. 
-0000d220: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
-0000d230: 2e74 6173 6b73 2e20 5468 6973 2061 6c73  .tasks. This als
-0000d240: 6f20 7072 6576 656e 7473 2061 2052 6563  o prevents a Rec
-0000d250: 7572 7369 6f6e 4572 726f 7220 6475 7269  ursionError duri
-0000d260: 6e67 2070 6172 7469 6375 6c61 726c 7920  ng particularly 
-0000d270: 6865 6176 790a 2020 2020 2020 2020 6c6f  heavy.        lo
-0000d280: 6164 732c 2077 6869 6368 2068 6176 6520  ads, which have 
-0000d290: 6265 656e 206f 6273 6572 7665 6420 746f  been observed to
-0000d2a0: 2068 6170 7065 6e20 7768 656e 6576 6572   happen whenever
-0000d2b0: 2074 6865 7265 2773 2061 6e20 6163 7963   there's an acyc
-0000d2c0: 6c69 6320 6465 7065 6e64 656e 6379 0a20  lic dependency. 
-0000d2d0: 2020 2020 2020 2063 6861 696e 206f 6620         chain of 
-0000d2e0: 7e32 3030 2b20 7461 736b 732e 0a20 2020  ~200+ tasks..   
-0000d2f0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000d300: 2072 6574 7572 6e20 7265 6375 7273 6976   return recursiv
-0000d310: 655f 746f 5f64 6963 7428 7365 6c66 2c20  e_to_dict(self, 
-0000d320: 6578 636c 7564 653d 6578 636c 7564 652c  exclude=exclude,
-0000d330: 206d 656d 6265 7273 3d54 7275 6529 0a0a   members=True)..
-0000d340: 0a63 6c61 7373 2054 7261 6e73 6974 696f  .class Transitio
-0000d350: 6e28 4e61 6d65 6454 7570 6c65 293a 0a20  n(NamedTuple):. 
-0000d360: 2020 2022 2222 416e 2065 6e74 7279 2069     """An entry i
-0000d370: 6e20 3a61 7474 723a 6053 6368 6564 756c  n :attr:`Schedul
-0000d380: 6572 5374 6174 652e 7472 616e 7369 7469  erState.transiti
-0000d390: 6f6e 5f6c 6f67 6022 2222 0a0a 2020 2020  on_log`"""..    
-0000d3a0: 6b65 793a 204b 6579 0a20 2020 2073 7461  key: Key.    sta
-0000d3b0: 7274 3a20 5461 736b 5374 6174 6553 7461  rt: TaskStateSta
-0000d3c0: 7465 0a20 2020 2066 696e 6973 683a 2054  te.    finish: T
-0000d3d0: 6173 6b53 7461 7465 5374 6174 650a 2020  askStateState.  
-0000d3e0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0000d3f0: 733a 2052 6563 730a 2020 2020 7374 696d  s: Recs.    stim
-0000d400: 756c 7573 5f69 643a 2073 7472 0a20 2020  ulus_id: str.   
-0000d410: 2074 696d 6573 7461 6d70 3a20 666c 6f61   timestamp: floa
-0000d420: 740a 0a0a 636c 6173 7320 5363 6865 6475  t...class Schedu
-0000d430: 6c65 7253 7461 7465 3a0a 2020 2020 2222  lerState:.    ""
-0000d440: 2255 6e64 6572 6c79 696e 6720 7461 736b  "Underlying task
-0000d450: 2073 7461 7465 206f 6620 6479 6e61 6d69   state of dynami
-0000d460: 6320 7363 6865 6475 6c65 720a 0a20 2020  c scheduler..   
-0000d470: 2054 7261 636b 7320 7468 6520 6375 7272   Tracks the curr
-0000d480: 656e 7420 7374 6174 6520 6f66 2077 6f72  ent state of wor
-0000d490: 6b65 7273 2c20 6461 7461 2c20 616e 6420  kers, data, and 
-0000d4a0: 636f 6d70 7574 6174 696f 6e73 2e0a 0a20  computations... 
-0000d4b0: 2020 2048 616e 646c 6573 2074 7261 6e73     Handles trans
-0000d4c0: 6974 696f 6e73 2062 6574 7765 656e 2064  itions between d
-0000d4d0: 6966 6665 7265 6e74 2074 6173 6b20 7374  ifferent task st
-0000d4e0: 6174 6573 2e20 4e6f 7469 6669 6573 2074  ates. Notifies t
-0000d4f0: 6865 0a20 2020 2053 6368 6564 756c 6572  he.    Scheduler
-0000d500: 206f 6620 6368 616e 6765 7320 6279 206d   of changes by m
-0000d510: 6573 7361 6769 6e67 2070 6173 7369 6e67  essaging passing
-0000d520: 2074 6872 6f75 6768 2051 7565 7565 732c   through Queues,
-0000d530: 2077 6869 6368 2074 6865 0a20 2020 2053   which the.    S
-0000d540: 6368 6564 756c 6572 206c 6973 7465 6e73  cheduler listens
-0000d550: 2074 6f20 7265 7370 6f6e 6473 2061 6363   to responds acc
-0000d560: 6f72 6469 6e67 6c79 2e0a 0a20 2020 2041  ordingly...    A
-0000d570: 6c6c 2065 7665 6e74 7320 6172 6520 6861  ll events are ha
-0000d580: 6e64 6c65 6420 7175 6963 6b6c 792c 2069  ndled quickly, i
-0000d590: 6e20 6c69 6e65 6172 2074 696d 6520 7769  n linear time wi
-0000d5a0: 7468 2072 6573 7065 6374 2074 6f20 7468  th respect to th
-0000d5b0: 6569 720a 2020 2020 696e 7075 7420 2877  eir.    input (w
-0000d5c0: 6869 6368 2069 7320 6f66 7465 6e20 6f66  hich is often of
-0000d5d0: 2063 6f6e 7374 616e 7420 7369 7a65 2920   constant size) 
-0000d5e0: 616e 6420 6765 6e65 7261 6c6c 7920 7769  and generally wi
-0000d5f0: 7468 696e 2061 0a20 2020 206d 696c 6c69  thin a.    milli
-0000d600: 7365 636f 6e64 2e0a 0a20 2020 2055 7365  second...    Use
-0000d610: 7273 2074 7970 6963 616c 6c79 2064 6f20  rs typically do 
-0000d620: 6e6f 7420 696e 7465 7261 6374 2077 6974  not interact wit
-0000d630: 6820 6060 5472 616e 7369 7469 6f6e 7360  h ``Transitions`
-0000d640: 6020 6469 7265 6374 6c79 2e20 496e 7374  ` directly. Inst
-0000d650: 6561 640a 2020 2020 7573 6572 7320 696e  ead.    users in
-0000d660: 7465 7261 6374 2077 6974 6820 7468 6520  teract with the 
-0000d670: 6060 436c 6965 6e74 6060 2c20 7768 6963  ``Client``, whic
-0000d680: 6820 696e 2074 7572 6e20 656e 6761 6765  h in turn engage
-0000d690: 7320 7468 650a 2020 2020 6060 5363 6865  s the.    ``Sche
-0000d6a0: 6475 6c65 7260 6020 6166 6665 6374 696e  duler`` affectin
-0000d6b0: 6720 6469 6666 6572 656e 7420 7472 616e  g different tran
-0000d6c0: 7369 7469 6f6e 7320 6865 7265 2075 6e64  sitions here und
-0000d6d0: 6572 2d74 6865 2d68 6f6f 642e 2049 6e0a  er-the-hood. In.
-0000d6e0: 2020 2020 7468 6520 6261 636b 6772 6f75      the backgrou
-0000d6f0: 6e64 2060 6057 6f72 6b65 7260 6073 2061  nd ``Worker``s a
-0000d700: 6c73 6f20 656e 6761 6765 2077 6974 6820  lso engage with 
-0000d710: 7468 6520 6060 5363 6865 6475 6c65 7260  the ``Scheduler`
-0000d720: 600a 2020 2020 6166 6665 6374 696e 6720  `.    affecting 
-0000d730: 7468 6573 6520 7374 6174 6520 7472 616e  these state tran
-0000d740: 7369 7469 6f6e 7320 6173 2077 656c 6c2e  sitions as well.
-0000d750: 0a20 2020 2022 2222 0a0a 2020 2020 6261  .    """..    ba
-0000d760: 6e64 7769 6474 683a 2069 6e74 0a0a 2020  ndwidth: int..  
-0000d770: 2020 233a 2043 6c69 656e 7473 2063 7572    #: Clients cur
-0000d780: 7265 6e74 6c79 2063 6f6e 6e65 6374 6564  rently connected
-0000d790: 2074 6f20 7468 6520 7363 6865 6475 6c65   to the schedule
-0000d7a0: 720a 2020 2020 636c 6965 6e74 733a 2064  r.    clients: d
-0000d7b0: 6963 745b 7374 722c 2043 6c69 656e 7453  ict[str, ClientS
-0000d7c0: 7461 7465 5d0a 0a20 2020 2065 7874 656e  tate]..    exten
-0000d7d0: 7369 6f6e 733a 2064 6963 745b 7374 722c  sions: dict[str,
-0000d7e0: 2041 6e79 5d20 2023 2054 4f44 4f20 7772   Any]  # TODO wr
-0000d7f0: 6974 6520 6120 7363 6865 6475 6c65 7220  ite a scheduler 
-0000d800: 6578 7465 6e73 696f 6e20 5072 6f74 6f63  extension Protoc
-0000d810: 6f6c 0a20 2020 2070 6c75 6769 6e73 3a20  ol.    plugins: 
-0000d820: 6469 6374 5b73 7472 2c20 5363 6865 6475  dict[str, Schedu
-0000d830: 6c65 7250 6c75 6769 6e5d 0a20 2020 2068  lerPlugin].    h
-0000d840: 6f73 745f 696e 666f 3a20 6469 6374 5b73  ost_info: dict[s
-0000d850: 7472 2c20 6469 6374 5b73 7472 2c20 416e  tr, dict[str, An
-0000d860: 795d 5d0a 0a20 2020 2023 3a20 4966 2054  y]]..    #: If T
-0000d870: 7275 652c 2065 6e61 626c 6520 6578 7065  rue, enable expe
-0000d880: 6e73 6976 6520 696e 7465 726e 616c 2063  nsive internal c
-0000d890: 6f6e 7369 7374 656e 6379 2063 6865 636b  onsistency check
-0000d8a0: 2e0a 2020 2020 233a 2054 7970 6963 616c  ..    #: Typical
-0000d8b0: 6c79 2064 6973 6162 6c65 6420 696e 2070  ly disabled in p
-0000d8c0: 726f 6475 6374 696f 6e2e 0a20 2020 2076  roduction..    v
-0000d8d0: 616c 6964 6174 653a 2062 6f6f 6c0a 0a20  alidate: bool.. 
-0000d8e0: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-0000d8f0: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-0000d900: 2057 6f72 6b65 7273 2d72 656c 6174 6564   Workers-related
-0000d910: 2073 7461 7465 0a20 2020 2023 2323 2323   state.    #####
+00000970: 7269 6373 2069 6d70 6f72 7420 7469 6d65  rics import time
+00000980: 0a66 726f 6d20 6469 7374 7269 6275 7465  .from distribute
+00000990: 642e 6d75 6c74 695f 6c6f 636b 2069 6d70  d.multi_lock imp
+000009a0: 6f72 7420 4d75 6c74 694c 6f63 6b45 7874  ort MultiLockExt
+000009b0: 656e 7369 6f6e 0a66 726f 6d20 6469 7374  ension.from dist
+000009c0: 7269 6275 7465 642e 6e6f 6465 2069 6d70  ributed.node imp
+000009d0: 6f72 7420 5365 7276 6572 4e6f 6465 0a66  ort ServerNode.f
+000009e0: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
+000009f0: 7072 6f63 7469 746c 6520 696d 706f 7274  proctitle import
+00000a00: 2073 6574 7072 6f63 7469 746c 650a 6672   setproctitle.fr
+00000a10: 6f6d 2064 6973 7472 6962 7574 6564 2e70  om distributed.p
+00000a20: 726f 746f 636f 6c20 696d 706f 7274 2064  rotocol import d
+00000a30: 6573 6572 6961 6c69 7a65 0a66 726f 6d20  eserialize.from 
+00000a40: 6469 7374 7269 6275 7465 642e 7072 6f74  distributed.prot
+00000a50: 6f63 6f6c 2e70 6963 6b6c 6520 696d 706f  ocol.pickle impo
+00000a60: 7274 2064 756d 7073 2c20 6c6f 6164 730a  rt dumps, loads.
+00000a70: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
+00000a80: 2e70 726f 746f 636f 6c2e 7365 7269 616c  .protocol.serial
+00000a90: 697a 6520 696d 706f 7274 2053 6572 6961  ize import Seria
+00000aa0: 6c69 7a65 642c 2054 6f50 6963 6b6c 652c  lized, ToPickle,
+00000ab0: 2073 6572 6961 6c69 7a65 0a66 726f 6d20   serialize.from 
+00000ac0: 6469 7374 7269 6275 7465 642e 7075 626c  distributed.publ
+00000ad0: 6973 6820 696d 706f 7274 2050 7562 6c69  ish import Publi
+00000ae0: 7368 4578 7465 6e73 696f 6e0a 6672 6f6d  shExtension.from
+00000af0: 2064 6973 7472 6962 7574 6564 2e70 7562   distributed.pub
+00000b00: 7375 6220 696d 706f 7274 2050 7562 5375  sub import PubSu
+00000b10: 6253 6368 6564 756c 6572 4578 7465 6e73  bSchedulerExtens
+00000b20: 696f 6e0a 6672 6f6d 2064 6973 7472 6962  ion.from distrib
+00000b30: 7574 6564 2e71 7565 7565 7320 696d 706f  uted.queues impo
+00000b40: 7274 2051 7565 7565 4578 7465 6e73 696f  rt QueueExtensio
+00000b50: 6e0a 6672 6f6d 2064 6973 7472 6962 7574  n.from distribut
+00000b60: 6564 2e72 6563 7265 6174 655f 7461 736b  ed.recreate_task
+00000b70: 7320 696d 706f 7274 2052 6570 6c61 7954  s import ReplayT
+00000b80: 6173 6b53 6368 6564 756c 6572 0a66 726f  askScheduler.fro
+00000b90: 6d20 6469 7374 7269 6275 7465 642e 7365  m distributed.se
+00000ba0: 6375 7269 7479 2069 6d70 6f72 7420 5365  curity import Se
+00000bb0: 6375 7269 7479 0a66 726f 6d20 6469 7374  curity.from dist
+00000bc0: 7269 6275 7465 642e 7365 6d61 7068 6f72  ributed.semaphor
+00000bd0: 6520 696d 706f 7274 2053 656d 6170 686f  e import Semapho
+00000be0: 7265 4578 7465 6e73 696f 6e0a 6672 6f6d  reExtension.from
+00000bf0: 2064 6973 7472 6962 7574 6564 2e73 6875   distributed.shu
+00000c00: 6666 6c65 2069 6d70 6f72 7420 5368 7566  ffle import Shuf
+00000c10: 666c 6553 6368 6564 756c 6572 506c 7567  fleSchedulerPlug
+00000c20: 696e 0a66 726f 6d20 6469 7374 7269 6275  in.from distribu
+00000c30: 7465 642e 7370 616e 7320 696d 706f 7274  ted.spans import
+00000c40: 2053 7061 6e73 5363 6865 6475 6c65 7245   SpansSchedulerE
+00000c50: 7874 656e 7369 6f6e 0a66 726f 6d20 6469  xtension.from di
+00000c60: 7374 7269 6275 7465 642e 7374 6561 6c69  stributed.steali
+00000c70: 6e67 2069 6d70 6f72 7420 576f 726b 5374  ng import WorkSt
+00000c80: 6561 6c69 6e67 0a66 726f 6d20 6469 7374  ealing.from dist
+00000c90: 7269 6275 7465 642e 7574 696c 7320 696d  ributed.utils im
+00000ca0: 706f 7274 2028 0a20 2020 2041 6c6c 2c0a  port (.    All,.
+00000cb0: 2020 2020 4465 6164 6c69 6e65 2c0a 2020      Deadline,.  
+00000cc0: 2020 5469 6d65 6f75 7445 7272 6f72 2c0a    TimeoutError,.
+00000cd0: 2020 2020 666f 726d 6174 5f64 6173 6862      format_dashb
+00000ce0: 6f61 7264 5f6c 696e 6b2c 0a20 2020 2067  oard_link,.    g
+00000cf0: 6574 5f66 696c 656e 6f5f 6c69 6d69 742c  et_fileno_limit,
+00000d00: 0a20 2020 2069 735f 7079 7468 6f6e 5f73  .    is_python_s
+00000d10: 6875 7474 696e 675f 646f 776e 2c0a 2020  hutting_down,.  
+00000d20: 2020 6b65 795f 7370 6c69 745f 6772 6f75    key_split_grou
+00000d30: 702c 0a20 2020 206c 6f67 5f65 7272 6f72  p,.    log_error
+00000d40: 732c 0a20 2020 206f 6666 6c6f 6164 2c0a  s,.    offload,.
+00000d50: 2020 2020 7265 6375 7273 6976 655f 746f      recursive_to
+00000d60: 5f64 6963 742c 0a20 2020 2077 6169 745f  _dict,.    wait_
+00000d70: 666f 722c 0a29 0a66 726f 6d20 6469 7374  for,.).from dist
+00000d80: 7269 6275 7465 642e 7574 696c 735f 636f  ributed.utils_co
+00000d90: 6d6d 2069 6d70 6f72 7420 280a 2020 2020  mm import (.    
+00000da0: 6761 7468 6572 5f66 726f 6d5f 776f 726b  gather_from_work
+00000db0: 6572 732c 0a20 2020 2072 6574 7279 5f6f  ers,.    retry_o
+00000dc0: 7065 7261 7469 6f6e 2c0a 2020 2020 7363  peration,.    sc
+00000dd0: 6174 7465 725f 746f 5f77 6f72 6b65 7273  atter_to_workers
+00000de0: 2c0a 2020 2020 756e 7061 636b 5f72 656d  ,.    unpack_rem
+00000df0: 6f74 6564 6174 612c 0a29 0a66 726f 6d20  otedata,.).from 
+00000e00: 6469 7374 7269 6275 7465 642e 7574 696c  distributed.util
+00000e10: 735f 7065 7266 2069 6d70 6f72 7420 6469  s_perf import di
+00000e20: 7361 626c 655f 6763 5f64 6961 676e 6f73  sable_gc_diagnos
+00000e30: 6973 2c20 656e 6162 6c65 5f67 635f 6469  is, enable_gc_di
+00000e40: 6167 6e6f 7369 730a 6672 6f6d 2064 6973  agnosis.from dis
+00000e50: 7472 6962 7574 6564 2e76 6172 6961 626c  tributed.variabl
+00000e60: 6520 696d 706f 7274 2056 6172 6961 626c  e import Variabl
+00000e70: 6545 7874 656e 7369 6f6e 0a66 726f 6d20  eExtension.from 
+00000e80: 6469 7374 7269 6275 7465 642e 776f 726b  distributed.work
+00000e90: 6572 2069 6d70 6f72 7420 5f6e 6f72 6d61  er import _norma
+00000ea0: 6c69 7a65 5f74 6173 6b0a 0a69 6620 5459  lize_task..if TY
+00000eb0: 5045 5f43 4845 434b 494e 473a 0a20 2020  PE_CHECKING:.   
+00000ec0: 2023 2054 4f44 4f20 696d 706f 7274 2066   # TODO import f
+00000ed0: 726f 6d20 7479 7069 6e67 2028 7265 7175  rom typing (requ
+00000ee0: 6972 6573 2050 7974 686f 6e20 3e3d 332e  ires Python >=3.
+00000ef0: 3130 290a 2020 2020 2320 544f 444f 2069  10).    # TODO i
+00000f00: 6d70 6f72 7420 6672 6f6d 2074 7970 696e  mport from typin
+00000f10: 6720 2872 6571 7569 7265 7320 5079 7468  g (requires Pyth
+00000f20: 6f6e 203e 3d33 2e31 3129 0a20 2020 2066  on >=3.11).    f
+00000f30: 726f 6d20 7479 7069 6e67 5f65 7874 656e  rom typing_exten
+00000f40: 7369 6f6e 7320 696d 706f 7274 2053 656c  sions import Sel
+00000f50: 662c 2054 7970 6541 6c69 6173 0a0a 2020  f, TypeAlias..  
+00000f60: 2020 6672 6f6d 2064 6173 6b2e 6869 6768    from dask.high
+00000f70: 6c65 7665 6c67 7261 7068 2069 6d70 6f72  levelgraph impor
+00000f80: 7420 4869 6768 4c65 7665 6c47 7261 7068  t HighLevelGraph
+00000f90: 0a0a 2320 4e6f 7420 746f 2062 6520 636f  ..# Not to be co
+00000fa0: 6e66 7573 6564 2077 6974 6820 6469 7374  nfused with dist
+00000fb0: 7269 6275 7465 642e 776f 726b 6572 5f73  ributed.worker_s
+00000fc0: 7461 7465 5f6d 6163 6869 6e65 2e54 6173  tate_machine.Tas
+00000fd0: 6b53 7461 7465 5374 6174 650a 5461 736b  kStateState.Task
+00000fe0: 5374 6174 6553 7461 7465 3a20 5479 7065  StateState: Type
+00000ff0: 416c 6961 7320 3d20 4c69 7465 7261 6c5b  Alias = Literal[
+00001000: 0a20 2020 2022 7265 6c65 6173 6564 222c  .    "released",
+00001010: 0a20 2020 2022 7761 6974 696e 6722 2c0a  .    "waiting",.
+00001020: 2020 2020 226e 6f2d 776f 726b 6572 222c      "no-worker",
+00001030: 0a20 2020 2022 7175 6575 6564 222c 0a20  .    "queued",. 
+00001040: 2020 2022 7072 6f63 6573 7369 6e67 222c     "processing",
+00001050: 0a20 2020 2022 6d65 6d6f 7279 222c 0a20  .    "memory",. 
+00001060: 2020 2022 6572 7265 6422 2c0a 2020 2020     "erred",.    
+00001070: 2266 6f72 676f 7474 656e 222c 0a5d 0a0a  "forgotten",.]..
+00001080: 414c 4c5f 5441 534b 5f53 5441 5445 533a  ALL_TASK_STATES:
+00001090: 2053 6574 5b54 6173 6b53 7461 7465 5374   Set[TaskStateSt
+000010a0: 6174 655d 203d 2073 6574 2854 6173 6b53  ate] = set(TaskS
+000010b0: 7461 7465 5374 6174 652e 5f5f 6172 6773  tateState.__args
+000010c0: 5f5f 2920 2023 2074 7970 653a 2069 676e  __)  # type: ign
+000010d0: 6f72 650a 0a23 207b 7461 736b 206b 6579  ore..# {task key
+000010e0: 202d 3e20 6669 6e69 7368 2073 7461 7465   -> finish state
+000010f0: 7d0a 2320 4e6f 7420 746f 2062 6520 636f  }.# Not to be co
+00001100: 6e66 7573 6564 2077 6974 6820 6469 7374  nfused with dist
+00001110: 7269 6275 7465 642e 776f 726b 6572 5f73  ributed.worker_s
+00001120: 7461 7465 5f6d 6163 6869 6e65 2e52 6563  tate_machine.Rec
+00001130: 730a 5265 6373 3a20 5479 7065 416c 6961  s.Recs: TypeAlia
+00001140: 7320 3d20 6469 6374 5b4b 6579 2c20 5461  s = dict[Key, Ta
+00001150: 736b 5374 6174 6553 7461 7465 5d0a 2320  skStateState].# 
+00001160: 7b63 6c69 656e 7420 6f72 2077 6f72 6b65  {client or worke
+00001170: 7220 6164 6472 6573 733a 205b 7b6f 703a  r address: [{op:
+00001180: 203c 6b65 793e 2c20 2e2e 2e7d 2c20 2e2e   <key>, ...}, ..
+00001190: 2e5d 7d0a 4d73 6773 3a20 5479 7065 416c  .]}.Msgs: TypeAl
+000011a0: 6961 7320 3d20 6469 6374 5b73 7472 2c20  ias = dict[str, 
+000011b0: 6c69 7374 5b64 6963 745b 7374 722c 2041  list[dict[str, A
+000011c0: 6e79 5d5d 5d0a 2320 2872 6563 6f6d 6d65  ny]]].# (recomme
+000011d0: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+000011e0: 206d 6573 7361 6765 732c 2077 6f72 6b65   messages, worke
+000011f0: 7220 6d65 7373 6167 6573 290a 5265 6373  r messages).Recs
+00001200: 4d73 6773 3a20 5479 7065 416c 6961 7320  Msgs: TypeAlias 
+00001210: 3d20 7475 706c 655b 5265 6373 2c20 4d73  = tuple[Recs, Ms
+00001220: 6773 2c20 4d73 6773 5d0a 0a54 5f72 756e  gs, Msgs]..T_run
+00001230: 7370 6563 3a20 5479 7065 416c 6961 7320  spec: TypeAlias 
+00001240: 3d20 7475 706c 655b 4361 6c6c 6162 6c65  = tuple[Callable
+00001250: 2c20 7475 706c 652c 2064 6963 745b 7374  , tuple, dict[st
+00001260: 722c 2041 6e79 5d5d 0a0a 6c6f 6767 6572  r, Any]]..logger
+00001270: 203d 206c 6f67 6769 6e67 2e67 6574 4c6f   = logging.getLo
+00001280: 6767 6572 285f 5f6e 616d 655f 5f29 0a4c  gger(__name__).L
+00001290: 4f47 5f50 4442 203d 2064 6173 6b2e 636f  OG_PDB = dask.co
+000012a0: 6e66 6967 2e67 6574 2822 6469 7374 7269  nfig.get("distri
+000012b0: 6275 7465 642e 6164 6d69 6e2e 7064 622d  buted.admin.pdb-
+000012c0: 6f6e 2d65 7272 2229 0a44 4546 4155 4c54  on-err").DEFAULT
+000012d0: 5f44 4154 415f 5349 5a45 203d 2070 6172  _DATA_SIZE = par
+000012e0: 7365 5f62 7974 6573 280a 2020 2020 6461  se_bytes(.    da
+000012f0: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
+00001300: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+00001310: 756c 6572 2e64 6566 6175 6c74 2d64 6174  uler.default-dat
+00001320: 612d 7369 7a65 2229 0a29 0a53 5449 4d55  a-size").).STIMU
+00001330: 4c55 535f 4944 5f55 4e53 4554 203d 2022  LUS_ID_UNSET = "
+00001340: 3c73 7469 6d75 6c75 735f 6964 2075 6e73  <stimulus_id uns
+00001350: 6574 3e22 0a0a 4445 4641 554c 545f 4558  et>"..DEFAULT_EX
+00001360: 5445 4e53 494f 4e53 203d 207b 0a20 2020  TENSIONS = {.   
+00001370: 2022 6c6f 636b 7322 3a20 4c6f 636b 4578   "locks": LockEx
+00001380: 7465 6e73 696f 6e2c 0a20 2020 2022 6d75  tension,.    "mu
+00001390: 6c74 695f 6c6f 636b 7322 3a20 4d75 6c74  lti_locks": Mult
+000013a0: 694c 6f63 6b45 7874 656e 7369 6f6e 2c0a  iLockExtension,.
+000013b0: 2020 2020 2270 7562 6c69 7368 223a 2050      "publish": P
+000013c0: 7562 6c69 7368 4578 7465 6e73 696f 6e2c  ublishExtension,
+000013d0: 0a20 2020 2022 7265 706c 6179 2d74 6173  .    "replay-tas
+000013e0: 6b73 223a 2052 6570 6c61 7954 6173 6b53  ks": ReplayTaskS
+000013f0: 6368 6564 756c 6572 2c0a 2020 2020 2271  cheduler,.    "q
+00001400: 7565 7565 7322 3a20 5175 6575 6545 7874  ueues": QueueExt
+00001410: 656e 7369 6f6e 2c0a 2020 2020 2276 6172  ension,.    "var
+00001420: 6961 626c 6573 223a 2056 6172 6961 626c  iables": Variabl
+00001430: 6545 7874 656e 7369 6f6e 2c0a 2020 2020  eExtension,.    
+00001440: 2270 7562 7375 6222 3a20 5075 6253 7562  "pubsub": PubSub
+00001450: 5363 6865 6475 6c65 7245 7874 656e 7369  SchedulerExtensi
+00001460: 6f6e 2c0a 2020 2020 2273 656d 6170 686f  on,.    "semapho
+00001470: 7265 7322 3a20 5365 6d61 7068 6f72 6545  res": SemaphoreE
+00001480: 7874 656e 7369 6f6e 2c0a 2020 2020 2265  xtension,.    "e
+00001490: 7665 6e74 7322 3a20 4576 656e 7445 7874  vents": EventExt
+000014a0: 656e 7369 6f6e 2c0a 2020 2020 2261 6d6d  ension,.    "amm
+000014b0: 223a 2041 6374 6976 654d 656d 6f72 794d  ": ActiveMemoryM
+000014c0: 616e 6167 6572 4578 7465 6e73 696f 6e2c  anagerExtension,
+000014d0: 0a20 2020 2022 6d65 6d6f 7279 5f73 616d  .    "memory_sam
+000014e0: 706c 6572 223a 204d 656d 6f72 7953 616d  pler": MemorySam
+000014f0: 706c 6572 4578 7465 6e73 696f 6e2c 0a20  plerExtension,. 
+00001500: 2020 2022 7368 7566 666c 6522 3a20 5368     "shuffle": Sh
+00001510: 7566 666c 6553 6368 6564 756c 6572 506c  uffleSchedulerPl
+00001520: 7567 696e 2c0a 2020 2020 2273 7061 6e73  ugin,.    "spans
+00001530: 223a 2053 7061 6e73 5363 6865 6475 6c65  ": SpansSchedule
+00001540: 7245 7874 656e 7369 6f6e 2c0a 2020 2020  rExtension,.    
+00001550: 2273 7465 616c 696e 6722 3a20 576f 726b  "stealing": Work
+00001560: 5374 6561 6c69 6e67 2c0a 7d0a 0a0a 636c  Stealing,.}...cl
+00001570: 6173 7320 436c 6965 6e74 5374 6174 653a  ass ClientState:
+00001580: 0a20 2020 2022 2222 4120 7369 6d70 6c65  .    """A simple
+00001590: 206f 626a 6563 7420 686f 6c64 696e 6720   object holding 
+000015a0: 696e 666f 726d 6174 696f 6e20 6162 6f75  information abou
+000015b0: 7420 6120 636c 6965 6e74 2e22 2222 0a0a  t a client."""..
+000015c0: 2020 2020 233a 2041 2075 6e69 7175 6520      #: A unique 
+000015d0: 6964 656e 7469 6669 6572 2066 6f72 2074  identifier for t
+000015e0: 6869 7320 636c 6965 6e74 2e20 5468 6973  his client. This
+000015f0: 2069 7320 6765 6e65 7261 6c6c 7920 616e   is generally an
+00001600: 206f 7061 7175 650a 2020 2020 233a 2073   opaque.    #: s
+00001610: 7472 696e 6720 6765 6e65 7261 7465 6420  tring generated 
+00001620: 6279 2074 6865 2063 6c69 656e 7420 6974  by the client it
+00001630: 7365 6c66 2e0a 2020 2020 636c 6965 6e74  self..    client
+00001640: 5f6b 6579 3a20 7374 720a 0a20 2020 2023  _key: str..    #
+00001650: 3a20 4361 6368 6564 2068 6173 6820 6f66  : Cached hash of
+00001660: 203a 6174 7472 3a60 7e43 6c69 656e 7453   :attr:`~ClientS
+00001670: 7461 7465 2e63 6c69 656e 745f 6b65 7960  tate.client_key`
+00001680: 0a20 2020 205f 6861 7368 3a20 696e 740a  .    _hash: int.
+00001690: 0a20 2020 2023 3a20 4120 7365 7420 6f66  .    #: A set of
+000016a0: 2074 6173 6b73 2074 6869 7320 636c 6965   tasks this clie
+000016b0: 6e74 2077 616e 7473 2074 6f20 6265 206b  nt wants to be k
+000016c0: 6570 7420 696e 206d 656d 6f72 792c 2073  ept in memory, s
+000016d0: 6f20 7468 6174 2069 7420 6361 6e20 646f  o that it can do
+000016e0: 776e 6c6f 6164 0a20 2020 2023 3a20 6974  wnload.    #: it
+000016f0: 7320 7265 7375 6c74 2077 6865 6e20 6465  s result when de
+00001700: 7369 7265 642e 2054 6869 7320 6973 2074  sired. This is t
+00001710: 6865 2072 6576 6572 7365 206d 6170 7069  he reverse mappi
+00001720: 6e67 206f 660a 2020 2020 233a 203a 636c  ng of.    #: :cl
+00001730: 6173 733a 6054 6173 6b53 7461 7465 2e77  ass:`TaskState.w
+00001740: 686f 5f77 616e 7473 602e 2054 6173 6b73  ho_wants`. Tasks
+00001750: 2061 7265 2074 7970 6963 616c 6c79 2072   are typically r
+00001760: 656d 6f76 6564 2066 726f 6d20 7468 6973  emoved from this
+00001770: 2073 6574 2077 6865 6e20 7468 650a 2020   set when the.  
+00001780: 2020 233a 2063 6f72 7265 7370 6f6e 6469    #: correspondi
+00001790: 6e67 206f 626a 6563 7420 696e 2074 6865  ng object in the
+000017a0: 2063 6c69 656e 7427 7320 7370 6163 6520   client's space 
+000017b0: 2866 6f72 2065 7861 6d70 6c65 2061 2060  (for example a `
+000017c0: 6046 7574 7572 6560 6020 6f72 2061 2044  `Future`` or a D
+000017d0: 6173 6b0a 2020 2020 233a 2063 6f6c 6c65  ask.    #: colle
+000017e0: 6374 696f 6e29 2067 6574 7320 6761 7262  ction) gets garb
+000017f0: 6167 652d 636f 6c6c 6563 7465 642e 0a20  age-collected.. 
+00001800: 2020 2077 616e 7473 5f77 6861 743a 2073     wants_what: s
+00001810: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
+00001820: 2020 2023 3a20 5468 6520 6c61 7374 2074     #: The last t
+00001830: 696d 6520 7765 2072 6563 6569 7665 6420  ime we received 
+00001840: 6120 6865 6172 7462 6561 7420 6672 6f6d  a heartbeat from
+00001850: 2074 6869 7320 636c 6965 6e74 2c20 696e   this client, in
+00001860: 206c 6f63 616c 2073 6368 6564 756c 6572   local scheduler
+00001870: 2074 696d 652e 0a20 2020 206c 6173 745f   time..    last_
+00001880: 7365 656e 3a20 666c 6f61 740a 0a20 2020  seen: float..   
+00001890: 2023 3a20 4f75 7470 7574 206f 6620 3a66   #: Output of :f
+000018a0: 756e 633a 6064 6973 7472 6962 7574 6564  unc:`distributed
+000018b0: 2e76 6572 7369 6f6e 732e 6765 745f 7665  .versions.get_ve
+000018c0: 7273 696f 6e73 6020 6f6e 2074 6865 2063  rsions` on the c
+000018d0: 6c69 656e 740a 2020 2020 7665 7273 696f  lient.    versio
+000018e0: 6e73 3a20 6469 6374 5b73 7472 2c20 416e  ns: dict[str, An
+000018f0: 795d 0a0a 2020 2020 5f5f 736c 6f74 735f  y]..    __slots_
+00001900: 5f20 3d20 7475 706c 6528 5f5f 616e 6e6f  _ = tuple(__anno
+00001910: 7461 7469 6f6e 735f 5f29 0a0a 2020 2020  tations__)..    
+00001920: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+00001930: 662c 2063 6c69 656e 743a 2073 7472 2c20  f, client: str, 
+00001940: 2a2c 2076 6572 7369 6f6e 733a 2064 6963  *, versions: dic
+00001950: 745b 7374 722c 2041 6e79 5d20 7c20 4e6f  t[str, Any] | No
+00001960: 6e65 203d 204e 6f6e 6529 3a0a 2020 2020  ne = None):.    
+00001970: 2020 2020 7365 6c66 2e63 6c69 656e 745f      self.client_
+00001980: 6b65 7920 3d20 636c 6965 6e74 0a20 2020  key = client.   
+00001990: 2020 2020 2073 656c 662e 5f68 6173 6820       self._hash 
+000019a0: 3d20 6861 7368 2863 6c69 656e 7429 0a20  = hash(client). 
+000019b0: 2020 2020 2020 2073 656c 662e 7761 6e74         self.want
+000019c0: 735f 7768 6174 203d 2073 6574 2829 0a20  s_what = set(). 
+000019d0: 2020 2020 2020 2073 656c 662e 6c61 7374         self.last
+000019e0: 5f73 6565 6e20 3d20 7469 6d65 2829 0a20  _seen = time(). 
+000019f0: 2020 2020 2020 2073 656c 662e 7665 7273         self.vers
+00001a00: 696f 6e73 203d 2076 6572 7369 6f6e 7320  ions = versions 
+00001a10: 6f72 207b 7d0a 0a20 2020 2064 6566 205f  or {}..    def _
+00001a20: 5f68 6173 685f 5f28 7365 6c66 2920 2d3e  _hash__(self) ->
+00001a30: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
+00001a40: 7475 726e 2073 656c 662e 5f68 6173 680a  turn self._hash.
+00001a50: 0a20 2020 2064 6566 205f 5f65 715f 5f28  .    def __eq__(
+00001a60: 7365 6c66 2c20 6f74 6865 723a 206f 626a  self, other: obj
+00001a70: 6563 7429 202d 3e20 626f 6f6c 3a0a 2020  ect) -> bool:.  
+00001a80: 2020 2020 2020 6966 206e 6f74 2069 7369        if not isi
+00001a90: 6e73 7461 6e63 6528 6f74 6865 722c 2043  nstance(other, C
+00001aa0: 6c69 656e 7453 7461 7465 293a 0a20 2020  lientState):.   
+00001ab0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00001ac0: 4661 6c73 650a 2020 2020 2020 2020 7265  False.        re
+00001ad0: 7475 726e 2073 656c 662e 636c 6965 6e74  turn self.client
+00001ae0: 5f6b 6579 203d 3d20 6f74 6865 722e 636c  _key == other.cl
+00001af0: 6965 6e74 5f6b 6579 0a0a 2020 2020 6465  ient_key..    de
+00001b00: 6620 5f5f 7265 7072 5f5f 2873 656c 6629  f __repr__(self)
+00001b10: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+00001b20: 2072 6574 7572 6e20 6622 3c43 6c69 656e   return f"<Clien
+00001b30: 7420 7b73 656c 662e 636c 6965 6e74 5f6b  t {self.client_k
+00001b40: 6579 2172 7d3e 220a 0a20 2020 2064 6566  ey!r}>"..    def
+00001b50: 205f 5f73 7472 5f5f 2873 656c 6629 202d   __str__(self) -
+00001b60: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
+00001b70: 6574 7572 6e20 7365 6c66 2e63 6c69 656e  eturn self.clien
+00001b80: 745f 6b65 790a 0a20 2020 2064 6566 205f  t_key..    def _
+00001b90: 746f 5f64 6963 745f 6e6f 5f6e 6573 7428  to_dict_no_nest(
+00001ba0: 7365 6c66 2c20 2a2c 2065 7863 6c75 6465  self, *, exclude
+00001bb0: 3a20 436f 6e74 6169 6e65 725b 7374 725d  : Container[str]
+00001bc0: 203d 2028 2929 202d 3e20 6469 6374 3a0a   = ()) -> dict:.
+00001bd0: 2020 2020 2020 2020 2222 2244 6963 7469          """Dicti
+00001be0: 6f6e 6172 7920 7265 7072 6573 656e 7461  onary representa
+00001bf0: 7469 6f6e 2066 6f72 2064 6562 7567 6769  tion for debuggi
+00001c00: 6e67 2070 7572 706f 7365 732e 0a20 2020  ng purposes..   
+00001c10: 2020 2020 204e 6f74 2074 7970 6520 7374       Not type st
+00001c20: 6162 6c65 2061 6e64 206e 6f74 2069 6e74  able and not int
+00001c30: 656e 6465 6420 666f 7220 726f 756e 6474  ended for roundt
+00001c40: 7269 7073 2e0a 0a20 2020 2020 2020 2053  rips...        S
+00001c50: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
+00001c60: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+00001c70: 2043 6c69 656e 742e 6475 6d70 5f63 6c75   Client.dump_clu
+00001c80: 7374 6572 5f73 7461 7465 0a20 2020 2020  ster_state.     
+00001c90: 2020 2064 6973 7472 6962 7574 6564 2e75     distributed.u
+00001ca0: 7469 6c73 2e72 6563 7572 7369 7665 5f74  tils.recursive_t
+00001cb0: 6f5f 6469 6374 0a20 2020 2020 2020 2054  o_dict.        T
+00001cc0: 6173 6b53 7461 7465 2e5f 746f 5f64 6963  askState._to_dic
+00001cd0: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
+00001ce0: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
+00001cf0: 7572 7369 7665 5f74 6f5f 6469 6374 280a  ursive_to_dict(.
+00001d00: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00001d10: 2c0a 2020 2020 2020 2020 2020 2020 6578  ,.            ex
+00001d20: 636c 7564 653d 7365 7428 6578 636c 7564  clude=set(exclud
+00001d30: 6529 207c 207b 2276 6572 7369 6f6e 7322  e) | {"versions"
+00001d40: 7d2c 2020 2320 7479 7065 3a20 6967 6e6f  },  # type: igno
+00001d50: 7265 0a20 2020 2020 2020 2020 2020 206d  re.            m
+00001d60: 656d 6265 7273 3d54 7275 652c 0a20 2020  embers=True,.   
+00001d70: 2020 2020 2029 0a0a 0a63 6c61 7373 204d       )...class M
+00001d80: 656d 6f72 7953 7461 7465 3a0a 2020 2020  emoryState:.    
+00001d90: 2222 224d 656d 6f72 7920 7265 6164 696e  """Memory readin
+00001da0: 6773 206f 6e20 6120 776f 726b 6572 206f  gs on a worker o
+00001db0: 7220 6f6e 2074 6865 2077 686f 6c65 2063  r on the whole c
+00001dc0: 6c75 7374 6572 2e0a 0a20 2020 2053 6565  luster...    See
+00001dd0: 203a 646f 633a 6077 6f72 6b65 722d 6d65   :doc:`worker-me
+00001de0: 6d6f 7279 602e 0a0a 2020 2020 4174 7472  mory`...    Attr
+00001df0: 6962 7574 6573 202f 2070 726f 7065 7274  ibutes / propert
+00001e00: 6965 733a 0a0a 2020 2020 6d61 6e61 6765  ies:..    manage
+00001e10: 645f 746f 7461 6c0a 2020 2020 2020 2020  d_total.        
+00001e20: 5375 6d20 6f66 2074 6865 206f 7574 7075  Sum of the outpu
+00001e30: 7420 6f66 2073 697a 656f 6628 2920 666f  t of sizeof() fo
+00001e40: 7220 616c 6c20 6461 736b 206b 6579 7320  r all dask keys 
+00001e50: 6865 6c64 2062 7920 7468 6520 776f 726b  held by the work
+00001e60: 6572 2069 6e20 6d65 6d6f 7279 2c0a 2020  er in memory,.  
+00001e70: 2020 2020 2020 706c 7573 206e 756d 6265        plus numbe
+00001e80: 7220 6f66 2062 7974 6573 2073 7069 6c6c  r of bytes spill
+00001e90: 6564 2074 6f20 6469 736b 0a0a 2020 2020  ed to disk..    
+00001ea0: 6d61 6e61 6765 640a 2020 2020 2020 2020  managed.        
+00001eb0: 5375 6d20 6f66 2074 6865 206f 7574 7075  Sum of the outpu
+00001ec0: 7420 6f66 2073 697a 656f 6628 2920 666f  t of sizeof() fo
+00001ed0: 7220 7468 6520 6461 736b 206b 6579 7320  r the dask keys 
+00001ee0: 6865 6c64 2069 6e20 5241 4d2e 204e 6f74  held in RAM. Not
+00001ef0: 6520 7468 6174 2074 6869 7320 6d61 790a  e that this may.
+00001f00: 2020 2020 2020 2020 6265 2069 6e61 6363          be inacc
+00001f10: 7572 6174 652c 2077 6869 6368 206d 6179  urate, which may
+00001f20: 2063 6175 7365 2069 6e61 6363 7572 6174   cause inaccurat
+00001f30: 6520 756e 6d61 6e61 6765 6420 6d65 6d6f  e unmanaged memo
+00001f40: 7279 2028 7365 6520 6265 6c6f 7729 2e0a  ry (see below)..
+00001f50: 0a20 2020 2073 7069 6c6c 6564 0a20 2020  .    spilled.   
+00001f60: 2020 2020 204e 756d 6265 7220 6f66 2062       Number of b
+00001f70: 7974 6573 2020 666f 7220 7468 6520 6461  ytes  for the da
+00001f80: 736b 206b 6579 7320 7370 696c 6c65 6420  sk keys spilled 
+00001f90: 746f 2074 6865 2068 6172 6420 6472 6976  to the hard driv
+00001fa0: 652e 0a20 2020 2020 2020 204e 6f74 6520  e..        Note 
+00001fb0: 7468 6174 2074 6869 7320 6973 2074 6865  that this is the
+00001fc0: 2073 697a 6520 6f6e 2064 6973 6b3b 2073   size on disk; s
+00001fd0: 697a 6520 696e 206d 656d 6f72 7920 6d61  ize in memory ma
+00001fe0: 7920 6265 2064 6966 6665 7265 6e74 2064  y be different d
+00001ff0: 7565 2074 6f0a 2020 2020 2020 2020 636f  ue to.        co
+00002000: 6d70 7265 7373 696f 6e20 616e 6420 696e  mpression and in
+00002010: 6163 6375 7261 6369 6573 2069 6e20 7369  accuracies in si
+00002020: 7a65 6f66 2829 2e20 496e 206f 7468 6572  zeof(). In other
+00002030: 2077 6f72 6473 2c20 6769 7665 6e20 7468   words, given th
+00002040: 6520 7361 6d65 206b 6579 732c 0a20 2020  e same keys,.   
+00002050: 2020 2020 2027 6d61 6e61 6765 6427 2077       'managed' w
+00002060: 696c 6c20 6368 616e 6765 2064 6570 656e  ill change depen
+00002070: 6469 6e67 206f 6e20 7468 6520 6b65 7973  ding on the keys
+00002080: 2062 6569 6e67 2069 6e20 6d65 6d6f 7279   being in memory
+00002090: 206f 7220 7370 696c 6c65 642e 0a0a 2020   or spilled...  
+000020a0: 2020 7072 6f63 6573 730a 2020 2020 2020    process.      
+000020b0: 2020 546f 7461 6c20 5253 5320 6d65 6d6f    Total RSS memo
+000020c0: 7279 206d 6561 7375 7265 6420 6279 2074  ry measured by t
+000020d0: 6865 204f 5320 6f6e 2074 6865 2077 6f72  he OS on the wor
+000020e0: 6b65 7220 7072 6f63 6573 732e 0a20 2020  ker process..   
+000020f0: 2020 2020 2054 6869 7320 6973 2061 6c77       This is alw
+00002100: 6179 7320 6578 6163 746c 7920 6571 7561  ays exactly equa
+00002110: 6c20 746f 206d 616e 6167 6564 202b 2075  l to managed + u
+00002120: 6e6d 616e 6167 6564 2e0a 0a20 2020 2075  nmanaged...    u
+00002130: 6e6d 616e 6167 6564 0a20 2020 2020 2020  nmanaged.       
+00002140: 2070 726f 6365 7373 202d 206d 616e 6167   process - manag
+00002150: 6564 2e20 5468 6973 2069 7320 7468 6520  ed. This is the 
+00002160: 7375 6d20 6f66 0a0a 2020 2020 2020 2020  sum of..        
+00002170: 2d20 5079 7468 6f6e 2069 6e74 6572 7072  - Python interpr
+00002180: 6574 6572 2061 6e64 206d 6f64 756c 6573  eter and modules
+00002190: 0a20 2020 2020 2020 202d 2067 6c6f 6261  .        - globa
+000021a0: 6c20 7661 7269 6162 6c65 730a 2020 2020  l variables.    
+000021b0: 2020 2020 2d20 6d65 6d6f 7279 2074 656d      - memory tem
+000021c0: 706f 7261 7269 6c79 2061 6c6c 6f63 6174  porarily allocat
+000021d0: 6564 2062 7920 7468 6520 6461 736b 2074  ed by the dask t
+000021e0: 6173 6b73 2074 6861 7420 6172 6520 6375  asks that are cu
+000021f0: 7272 656e 746c 7920 7275 6e6e 696e 670a  rrently running.
+00002200: 2020 2020 2020 2020 2d20 6d65 6d6f 7279          - memory
+00002210: 2066 7261 676d 656e 7461 7469 6f6e 0a20   fragmentation. 
+00002220: 2020 2020 2020 202d 206d 656d 6f72 7920         - memory 
+00002230: 6c65 616b 730a 2020 2020 2020 2020 2d20  leaks.        - 
+00002240: 6d65 6d6f 7279 206e 6f74 2079 6574 2067  memory not yet g
+00002250: 6172 6261 6765 2063 6f6c 6c65 6374 6564  arbage collected
+00002260: 0a20 2020 2020 2020 202d 206d 656d 6f72  .        - memor
+00002270: 7920 6e6f 7420 7965 7420 6672 6565 2829  y not yet free()
+00002280: 2764 2062 7920 7468 6520 5079 7468 6f6e  'd by the Python
+00002290: 206d 656d 6f72 7920 6d61 6e61 6765 7220   memory manager 
+000022a0: 746f 2074 6865 204f 530a 0a20 2020 2075  to the OS..    u
+000022b0: 6e6d 616e 6167 6564 5f6f 6c64 0a20 2020  nmanaged_old.   
+000022c0: 2020 2020 204d 696e 696d 756d 206f 6620       Minimum of 
+000022d0: 7468 6520 2775 6e6d 616e 6167 6564 2720  the 'unmanaged' 
+000022e0: 6d65 6173 7572 6573 206f 7665 7220 7468  measures over th
+000022f0: 6520 6c61 7374 0a20 2020 2020 2020 2060  e last.        `
+00002300: 6064 6973 7472 6962 7574 6564 2e6d 656d  `distributed.mem
+00002310: 6f72 792e 7265 6365 6e74 2d74 6f2d 6f6c  ory.recent-to-ol
+00002320: 642d 7469 6d65 6060 2073 6563 6f6e 6473  d-time`` seconds
+00002330: 0a0a 2020 2020 756e 6d61 6e61 6765 645f  ..    unmanaged_
+00002340: 7265 6365 6e74 0a20 2020 2020 2020 2075  recent.        u
+00002350: 6e6d 616e 6167 6564 202d 2075 6e6d 616e  nmanaged - unman
+00002360: 6167 6564 5f6f 6c64 3b20 696e 206f 7468  aged_old; in oth
+00002370: 6572 2077 6f72 6473 2070 726f 6365 7373  er words process
+00002380: 206d 656d 6f72 7920 7468 6174 2068 6173   memory that has
+00002390: 2062 6565 6e20 7265 6365 6e74 6c79 0a20   been recently. 
+000023a0: 2020 2020 2020 2061 6c6c 6f63 6174 6564         allocated
+000023b0: 2062 7574 2069 7320 6e6f 7420 6163 636f   but is not acco
+000023c0: 756e 7465 6420 666f 7220 6279 2064 6173  unted for by das
+000023d0: 6b3b 2068 6f70 6566 756c 6c79 2069 7427  k; hopefully it'
+000023e0: 7320 6d6f 7374 6c79 2061 2074 656d 706f  s mostly a tempo
+000023f0: 7261 7279 0a20 2020 2020 2020 2073 7069  rary.        spi
+00002400: 6b65 2e0a 0a20 2020 206f 7074 696d 6973  ke...    optimis
+00002410: 7469 630a 2020 2020 2020 2020 6d61 6e61  tic.        mana
+00002420: 6765 6420 2b20 756e 6d61 6e61 6765 645f  ged + unmanaged_
+00002430: 6f6c 643b 2069 6e20 6f74 6865 7220 776f  old; in other wo
+00002440: 7264 7320 7468 6520 6d65 6d6f 7279 2068  rds the memory h
+00002450: 656c 6420 6c6f 6e67 2d74 6572 6d20 6279  eld long-term by
+00002460: 0a20 2020 2020 2020 2074 6865 2070 726f  .        the pro
+00002470: 6365 7373 2075 6e64 6572 2074 6865 2068  cess under the h
+00002480: 6f70 6566 756c 2061 7373 756d 7074 696f  opeful assumptio
+00002490: 6e20 7468 6174 2061 6c6c 2075 6e6d 616e  n that all unman
+000024a0: 6167 6564 5f72 6563 656e 7420 6d65 6d6f  aged_recent memo
+000024b0: 7279 2069 7320 610a 2020 2020 2020 2020  ry is a.        
+000024c0: 7465 6d70 6f72 6172 7920 7370 696b 650a  temporary spike.
+000024d0: 2020 2020 2222 220a 0a20 2020 2070 726f      """..    pro
+000024e0: 6365 7373 3a20 696e 740a 2020 2020 756e  cess: int.    un
+000024f0: 6d61 6e61 6765 645f 6f6c 643a 2069 6e74  managed_old: int
+00002500: 0a20 2020 206d 616e 6167 6564 3a20 696e  .    managed: in
+00002510: 740a 2020 2020 7370 696c 6c65 643a 2069  t.    spilled: i
+00002520: 6e74 0a0a 2020 2020 5f5f 736c 6f74 735f  nt..    __slots_
+00002530: 5f20 3d20 7475 706c 6528 5f5f 616e 6e6f  _ = tuple(__anno
+00002540: 7461 7469 6f6e 735f 5f29 0a0a 2020 2020  tations__)..    
+00002550: 6465 6620 5f5f 696e 6974 5f5f 280a 2020  def __init__(.  
+00002560: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00002570: 2020 2020 2a2c 0a20 2020 2020 2020 2070      *,.        p
+00002580: 726f 6365 7373 3a20 696e 742c 0a20 2020  rocess: int,.   
+00002590: 2020 2020 2075 6e6d 616e 6167 6564 5f6f       unmanaged_o
+000025a0: 6c64 3a20 696e 742c 0a20 2020 2020 2020  ld: int,.       
+000025b0: 206d 616e 6167 6564 3a20 696e 742c 0a20   managed: int,. 
+000025c0: 2020 2020 2020 2073 7069 6c6c 6564 3a20         spilled: 
+000025d0: 696e 742c 0a20 2020 2029 3a0a 2020 2020  int,.    ):.    
+000025e0: 2020 2020 2320 536f 6d65 2064 6174 6120      # Some data 
+000025f0: 6172 7269 7665 7320 7769 7468 2074 6865  arrives with the
+00002600: 2068 6561 7274 6265 6174 2c20 736f 6d65   heartbeat, some
+00002610: 206f 7468 6572 2061 7272 6976 6573 2069   other arrives i
+00002620: 6e20 7265 616c 7469 6d65 2061 7320 7468  n realtime as th
+00002630: 650a 2020 2020 2020 2020 2320 7461 736b  e.        # task
+00002640: 7320 7072 6f67 7265 7373 2e20 416c 736f  s progress. Also
+00002650: 2c20 7369 7a65 6f66 2829 2069 7320 6e6f  , sizeof() is no
+00002660: 7420 6775 6172 616e 7465 6564 2074 6f20  t guaranteed to 
+00002670: 7265 7475 726e 2063 6f72 7265 6374 2072  return correct r
+00002680: 6573 756c 7473 2e0a 2020 2020 2020 2020  esults..        
+00002690: 2320 5468 6973 2063 616e 2063 6175 7365  # This can cause
+000026a0: 2067 6c69 7463 6865 7320 7768 6572 6520   glitches where 
+000026b0: 6120 7061 7274 6961 6c20 6d65 6173 7572  a partial measur
+000026c0: 6520 6973 206c 6172 6765 7220 7468 616e  e is larger than
+000026d0: 2074 6865 2077 686f 6c65 2c20 736f 0a20   the whole, so. 
+000026e0: 2020 2020 2020 2023 2077 6520 6e65 6564         # we need
+000026f0: 2074 6f20 666f 7263 6520 616c 6c20 6e75   to force all nu
+00002700: 6d62 6572 7320 746f 2061 6464 2075 7020  mbers to add up 
+00002710: 6578 6163 746c 7920 6279 2064 6566 696e  exactly by defin
+00002720: 6974 696f 6e2e 0a20 2020 2020 2020 2073  ition..        s
+00002730: 656c 662e 7072 6f63 6573 7320 3d20 7072  elf.process = pr
+00002740: 6f63 6573 730a 2020 2020 2020 2020 7365  ocess.        se
+00002750: 6c66 2e6d 616e 6167 6564 203d 206d 696e  lf.managed = min
+00002760: 2873 656c 662e 7072 6f63 6573 732c 206d  (self.process, m
+00002770: 616e 6167 6564 290a 2020 2020 2020 2020  anaged).        
+00002780: 7365 6c66 2e73 7069 6c6c 6564 203d 2073  self.spilled = s
+00002790: 7069 6c6c 6564 0a20 2020 2020 2020 2023  pilled.        #
+000027a0: 2053 7562 7472 6163 7469 6f6e 7320 6265   Subtractions be
+000027b0: 7477 6565 6e20 756e 7369 676e 6564 2069  tween unsigned i
+000027c0: 6e74 7320 6775 6172 616e 7465 6564 2062  nts guaranteed b
+000027d0: 7920 636f 6e73 7472 7563 7469 6f6e 2074  y construction t
+000027e0: 6f20 6265 203e 3d20 300a 2020 2020 2020  o be >= 0.      
+000027f0: 2020 7365 6c66 2e75 6e6d 616e 6167 6564    self.unmanaged
+00002800: 5f6f 6c64 203d 206d 696e 2875 6e6d 616e  _old = min(unman
+00002810: 6167 6564 5f6f 6c64 2c20 7072 6f63 6573  aged_old, proces
+00002820: 7320 2d20 7365 6c66 2e6d 616e 6167 6564  s - self.managed
+00002830: 290a 0a20 2020 2040 7374 6174 6963 6d65  )..    @staticme
+00002840: 7468 6f64 0a20 2020 2064 6566 2073 756d  thod.    def sum
+00002850: 282a 696e 666f 733a 204d 656d 6f72 7953  (*infos: MemoryS
+00002860: 7461 7465 2920 2d3e 204d 656d 6f72 7953  tate) -> MemoryS
+00002870: 7461 7465 3a0a 2020 2020 2020 2020 7072  tate:.        pr
+00002880: 6f63 6573 7320 3d20 300a 2020 2020 2020  ocess = 0.      
+00002890: 2020 756e 6d61 6e61 6765 645f 6f6c 6420    unmanaged_old 
+000028a0: 3d20 300a 2020 2020 2020 2020 6d61 6e61  = 0.        mana
+000028b0: 6765 6420 3d20 300a 2020 2020 2020 2020  ged = 0.        
+000028c0: 7370 696c 6c65 6420 3d20 300a 2020 2020  spilled = 0.    
+000028d0: 2020 2020 666f 7220 6d73 2069 6e20 696e      for ms in in
+000028e0: 666f 733a 0a20 2020 2020 2020 2020 2020  fos:.           
+000028f0: 2070 726f 6365 7373 202b 3d20 6d73 2e70   process += ms.p
+00002900: 726f 6365 7373 0a20 2020 2020 2020 2020  rocess.         
+00002910: 2020 2075 6e6d 616e 6167 6564 5f6f 6c64     unmanaged_old
+00002920: 202b 3d20 6d73 2e75 6e6d 616e 6167 6564   += ms.unmanaged
+00002930: 5f6f 6c64 0a20 2020 2020 2020 2020 2020  _old.           
+00002940: 2073 7069 6c6c 6564 202b 3d20 6d73 2e73   spilled += ms.s
+00002950: 7069 6c6c 6564 0a20 2020 2020 2020 2020  pilled.         
+00002960: 2020 206d 616e 6167 6564 202b 3d20 6d73     managed += ms
+00002970: 2e6d 616e 6167 6564 0a20 2020 2020 2020  .managed.       
+00002980: 2072 6574 7572 6e20 4d65 6d6f 7279 5374   return MemorySt
+00002990: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
+000029a0: 2070 726f 6365 7373 3d70 726f 6365 7373   process=process
+000029b0: 2c0a 2020 2020 2020 2020 2020 2020 756e  ,.            un
+000029c0: 6d61 6e61 6765 645f 6f6c 643d 756e 6d61  managed_old=unma
+000029d0: 6e61 6765 645f 6f6c 642c 0a20 2020 2020  naged_old,.     
+000029e0: 2020 2020 2020 206d 616e 6167 6564 3d6d         managed=m
+000029f0: 616e 6167 6564 2c0a 2020 2020 2020 2020  anaged,.        
+00002a00: 2020 2020 7370 696c 6c65 643d 7370 696c      spilled=spil
+00002a10: 6c65 642c 0a20 2020 2020 2020 2029 0a0a  led,.        )..
+00002a20: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00002a30: 2020 6465 6620 6d61 6e61 6765 645f 746f    def managed_to
+00002a40: 7461 6c28 7365 6c66 2920 2d3e 2069 6e74  tal(self) -> int
+00002a50: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00002a60: 2073 656c 662e 6d61 6e61 6765 6420 2b20   self.managed + 
+00002a70: 7365 6c66 2e73 7069 6c6c 6564 0a0a 2020  self.spilled..  
+00002a80: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00002a90: 6465 6620 756e 6d61 6e61 6765 6428 7365  def unmanaged(se
+00002aa0: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
+00002ab0: 2020 2020 2320 5468 6973 2069 7320 6e65      # This is ne
+00002ac0: 7665 7220 6e65 6761 7469 7665 2074 6861  ver negative tha
+00002ad0: 6e6b 7320 746f 205f 5f69 6e69 745f 5f0a  nks to __init__.
+00002ae0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00002af0: 656c 662e 7072 6f63 6573 7320 2d20 7365  elf.process - se
+00002b00: 6c66 2e6d 616e 6167 6564 0a0a 2020 2020  lf.managed..    
+00002b10: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+00002b20: 6620 756e 6d61 6e61 6765 645f 7265 6365  f unmanaged_rece
+00002b30: 6e74 2873 656c 6629 202d 3e20 696e 743a  nt(self) -> int:
+00002b40: 0a20 2020 2020 2020 2023 2054 6869 7320  .        # This 
+00002b50: 6973 206e 6576 6572 206e 6567 6174 6976  is never negativ
+00002b60: 6520 7468 616e 6b73 2074 6f20 5f5f 696e  e thanks to __in
+00002b70: 6974 5f5f 0a20 2020 2020 2020 2072 6574  it__.        ret
+00002b80: 7572 6e20 7365 6c66 2e70 726f 6365 7373  urn self.process
+00002b90: 202d 2073 656c 662e 6d61 6e61 6765 6420   - self.managed 
+00002ba0: 2d20 7365 6c66 2e75 6e6d 616e 6167 6564  - self.unmanaged
+00002bb0: 5f6f 6c64 0a0a 2020 2020 4070 726f 7065  _old..    @prope
+00002bc0: 7274 790a 2020 2020 6465 6620 6f70 7469  rty.    def opti
+00002bd0: 6d69 7374 6963 2873 656c 6629 202d 3e20  mistic(self) -> 
+00002be0: 696e 743a 0a20 2020 2020 2020 2072 6574  int:.        ret
+00002bf0: 7572 6e20 7365 6c66 2e6d 616e 6167 6564  urn self.managed
+00002c00: 202b 2073 656c 662e 756e 6d61 6e61 6765   + self.unmanage
+00002c10: 645f 6f6c 640a 0a20 2020 2040 7072 6f70  d_old..    @prop
+00002c20: 6572 7479 0a20 2020 2064 6566 206d 616e  erty.    def man
+00002c30: 6167 6564 5f69 6e5f 6d65 6d6f 7279 2873  aged_in_memory(s
+00002c40: 656c 6629 202d 3e20 696e 743a 0a20 2020  elf) -> int:.   
+00002c50: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
+00002c60: 726e 2822 6d61 6e61 6765 645f 696e 5f6d  rn("managed_in_m
+00002c70: 656d 6f72 7920 6861 7320 6265 656e 2072  emory has been r
+00002c80: 656e 616d 6564 2074 6f20 6d61 6e61 6765  enamed to manage
+00002c90: 6422 2c20 4675 7475 7265 5761 726e 696e  d", FutureWarnin
+00002ca0: 6729 0a20 2020 2020 2020 2072 6574 7572  g).        retur
+00002cb0: 6e20 7365 6c66 2e6d 616e 6167 6564 0a0a  n self.managed..
+00002cc0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00002cd0: 2020 6465 6620 6d61 6e61 6765 645f 7370    def managed_sp
+00002ce0: 696c 6c65 6428 7365 6c66 2920 2d3e 2069  illed(self) -> i
+00002cf0: 6e74 3a0a 2020 2020 2020 2020 7761 726e  nt:.        warn
+00002d00: 696e 6773 2e77 6172 6e28 226d 616e 6167  ings.warn("manag
+00002d10: 6564 5f73 7069 6c6c 6564 2068 6173 2062  ed_spilled has b
+00002d20: 6565 6e20 7265 6e61 6d65 6420 746f 2073  een renamed to s
+00002d30: 7069 6c6c 6564 222c 2046 7574 7572 6557  pilled", FutureW
+00002d40: 6172 6e69 6e67 290a 2020 2020 2020 2020  arning).        
+00002d50: 7265 7475 726e 2073 656c 662e 7370 696c  return self.spil
+00002d60: 6c65 640a 0a20 2020 2064 6566 205f 5f72  led..    def __r
+00002d70: 6570 725f 5f28 7365 6c66 2920 2d3e 2073  epr__(self) -> s
+00002d80: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
+00002d90: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
+00002da0: 2066 2250 726f 6365 7373 206d 656d 6f72   f"Process memor
+00002db0: 7920 2852 5353 2920 203a 207b 666f 726d  y (RSS)  : {form
+00002dc0: 6174 5f62 7974 6573 2873 656c 662e 7072  at_bytes(self.pr
+00002dd0: 6f63 6573 7329 7d5c 6e22 0a20 2020 2020  ocess)}\n".     
+00002de0: 2020 2020 2020 2066 2220 202d 206d 616e         f"  - man
+00002df0: 6167 6564 2062 7920 4461 736b 2020 203a  aged by Dask   :
+00002e00: 207b 666f 726d 6174 5f62 7974 6573 2873   {format_bytes(s
+00002e10: 656c 662e 6d61 6e61 6765 6429 7d5c 6e22  elf.managed)}\n"
+00002e20: 0a20 2020 2020 2020 2020 2020 2066 2220  .            f" 
+00002e30: 202d 2075 6e6d 616e 6167 6564 2028 6f6c   - unmanaged (ol
+00002e40: 6429 2020 203a 207b 666f 726d 6174 5f62  d)   : {format_b
+00002e50: 7974 6573 2873 656c 662e 756e 6d61 6e61  ytes(self.unmana
+00002e60: 6765 645f 6f6c 6429 7d5c 6e22 0a20 2020  ged_old)}\n".   
+00002e70: 2020 2020 2020 2020 2066 2220 202d 2075           f"  - u
+00002e80: 6e6d 616e 6167 6564 2028 7265 6365 6e74  nmanaged (recent
+00002e90: 293a 207b 666f 726d 6174 5f62 7974 6573  ): {format_bytes
+00002ea0: 2873 656c 662e 756e 6d61 6e61 6765 645f  (self.unmanaged_
+00002eb0: 7265 6365 6e74 297d 5c6e 220a 2020 2020  recent)}\n".    
+00002ec0: 2020 2020 2020 2020 6622 5370 696c 6c65          f"Spille
+00002ed0: 6420 746f 2064 6973 6b20 2020 2020 2020  d to disk       
+00002ee0: 3a20 7b66 6f72 6d61 745f 6279 7465 7328  : {format_bytes(
+00002ef0: 7365 6c66 2e73 7069 6c6c 6564 297d 5c6e  self.spilled)}\n
+00002f00: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
+00002f10: 2064 6566 205f 746f 5f64 6963 7428 7365   def _to_dict(se
+00002f20: 6c66 2c20 2a2c 2065 7863 6c75 6465 3a20  lf, *, exclude: 
+00002f30: 436f 6e74 6169 6e65 725b 7374 725d 203d  Container[str] =
+00002f40: 2028 2929 202d 3e20 6469 6374 3a0a 2020   ()) -> dict:.  
+00002f50: 2020 2020 2020 2222 2244 6963 7469 6f6e        """Diction
+00002f60: 6172 7920 7265 7072 6573 656e 7461 7469  ary representati
+00002f70: 6f6e 2066 6f72 2064 6562 7567 6769 6e67  on for debugging
+00002f80: 2070 7572 706f 7365 732e 0a0a 2020 2020   purposes...    
+00002f90: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
+00002fa0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
+00002fb0: 2020 2020 2020 436c 6965 6e74 2e64 756d        Client.dum
+00002fc0: 705f 636c 7573 7465 725f 7374 6174 650a  p_cluster_state.
+00002fd0: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
+00002fe0: 7465 642e 7574 696c 732e 7265 6375 7273  ted.utils.recurs
+00002ff0: 6976 655f 746f 5f64 6963 740a 2020 2020  ive_to_dict.    
+00003000: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00003010: 7265 7475 726e 207b 0a20 2020 2020 2020  return {.       
+00003020: 2020 2020 206b 3a20 6765 7461 7474 7228       k: getattr(
+00003030: 7365 6c66 2c20 6b29 0a20 2020 2020 2020  self, k).       
+00003040: 2020 2020 2066 6f72 206b 2069 6e20 6469       for k in di
+00003050: 7228 7365 6c66 290a 2020 2020 2020 2020  r(self).        
+00003060: 2020 2020 6966 206e 6f74 206b 2e73 7461      if not k.sta
+00003070: 7274 7377 6974 6828 225f 2229 0a20 2020  rtswith("_").   
+00003080: 2020 2020 2020 2020 2061 6e64 206b 206e           and k n
+00003090: 6f74 2069 6e20 7b22 7375 6d22 2c20 226d  ot in {"sum", "m
+000030a0: 616e 6167 6564 5f69 6e5f 6d65 6d6f 7279  anaged_in_memory
+000030b0: 222c 2022 6d61 6e61 6765 645f 7370 696c  ", "managed_spil
+000030c0: 6c65 6422 7d0a 2020 2020 2020 2020 7d0a  led"}.        }.
+000030d0: 0a0a 636c 6173 7320 576f 726b 6572 5374  ..class WorkerSt
+000030e0: 6174 653a 0a20 2020 2022 2222 4120 7369  ate:.    """A si
+000030f0: 6d70 6c65 206f 626a 6563 7420 686f 6c64  mple object hold
+00003100: 696e 6720 696e 666f 726d 6174 696f 6e20  ing information 
+00003110: 6162 6f75 7420 6120 776f 726b 6572 2e0a  about a worker..
+00003120: 0a20 2020 204e 6f74 2074 6f20 6265 2063  .    Not to be c
+00003130: 6f6e 6675 7365 6420 7769 7468 203a 636c  onfused with :cl
+00003140: 6173 733a 6064 6973 7472 6962 7574 6564  ass:`distributed
+00003150: 2e77 6f72 6b65 725f 7374 6174 655f 6d61  .worker_state_ma
+00003160: 6368 696e 652e 576f 726b 6572 5374 6174  chine.WorkerStat
+00003170: 6560 2e0a 2020 2020 2222 220a 0a20 2020  e`..    """..   
+00003180: 2023 3a20 5468 6973 2077 6f72 6b65 7227   #: This worker'
+00003190: 7320 756e 6971 7565 206b 6579 2e20 5468  s unique key. Th
+000031a0: 6973 2063 616e 2062 6520 6974 7320 636f  is can be its co
+000031b0: 6e6e 6563 7465 6420 6164 6472 6573 730a  nnected address.
+000031c0: 2020 2020 233a 2028 7375 6368 2061 7320      #: (such as 
+000031d0: 6060 2274 6370 3a2f 2f31 3237 2e30 2e30  ``"tcp://127.0.0
+000031e0: 2e31 3a38 3839 3122 6060 2920 6f72 2061  .1:8891"``) or a
+000031f0: 6e20 616c 6961 7320 2873 7563 6820 6173  n alias (such as
+00003200: 2060 6022 616c 6963 6522 6060 292e 0a20   ``"alice"``).. 
+00003210: 2020 2061 6464 7265 7373 3a20 7374 720a     address: str.
+00003220: 0a20 2020 2070 6964 3a20 696e 740a 2020  .    pid: int.  
+00003230: 2020 6e61 6d65 3a20 4861 7368 6162 6c65    name: Hashable
+00003240: 0a0a 2020 2020 233a 2054 6865 206e 756d  ..    #: The num
+00003250: 6265 7220 6f66 2043 5055 2074 6872 6561  ber of CPU threa
+00003260: 6473 206d 6164 6520 6176 6169 6c61 626c  ds made availabl
+00003270: 6520 6f6e 2074 6869 7320 776f 726b 6572  e on this worker
+00003280: 0a20 2020 206e 7468 7265 6164 733a 2069  .    nthreads: i
+00003290: 6e74 0a0a 2020 2020 233a 204d 656d 6f72  nt..    #: Memor
+000032a0: 7920 6176 6169 6c61 626c 6520 746f 2074  y available to t
+000032b0: 6865 2077 6f72 6b65 722c 2069 6e20 6279  he worker, in by
+000032c0: 7465 730a 2020 2020 6d65 6d6f 7279 5f6c  tes.    memory_l
+000032d0: 696d 6974 3a20 696e 740a 0a20 2020 206c  imit: int..    l
+000032e0: 6f63 616c 5f64 6972 6563 746f 7279 3a20  ocal_directory: 
+000032f0: 7374 720a 2020 2020 7365 7276 6963 6573  str.    services
+00003300: 3a20 6469 6374 5b73 7472 2c20 696e 745d  : dict[str, int]
+00003310: 0a0a 2020 2020 233a 204f 7574 7075 7420  ..    #: Output 
+00003320: 6f66 203a 6d65 7468 3a60 6469 7374 7269  of :meth:`distri
+00003330: 6275 7465 642e 7665 7273 696f 6e73 2e67  buted.versions.g
+00003340: 6574 5f76 6572 7369 6f6e 7360 206f 6e20  et_versions` on 
+00003350: 7468 6520 776f 726b 6572 0a20 2020 2076  the worker.    v
+00003360: 6572 7369 6f6e 733a 2064 6963 745b 7374  ersions: dict[st
+00003370: 722c 2041 6e79 5d0a 0a20 2020 2023 3a20  r, Any]..    #: 
+00003380: 4164 6472 6573 7320 6f66 2074 6865 2061  Address of the a
+00003390: 7373 6f63 6961 7465 6420 3a63 6c61 7373  ssociated :class
+000033a0: 3a60 7e64 6973 7472 6962 7574 6564 2e6e  :`~distributed.n
+000033b0: 616e 6e79 2e4e 616e 6e79 602c 2069 6620  anny.Nanny`, if 
+000033c0: 7072 6573 656e 740a 2020 2020 6e61 6e6e  present.    nann
+000033d0: 793a 2073 7472 207c 204e 6f6e 650a 0a20  y: str | None.. 
+000033e0: 2020 2023 3a20 5265 6164 2d6f 6e6c 7920     #: Read-only 
+000033f0: 776f 726b 6572 2073 7461 7475 732c 2073  worker status, s
+00003400: 796e 6365 6420 6f6e 6520 7761 7920 6672  ynced one way fr
+00003410: 6f6d 2074 6865 2072 656d 6f74 6520 576f  om the remote Wo
+00003420: 726b 6572 206f 626a 6563 740a 2020 2020  rker object.    
+00003430: 7374 6174 7573 3a20 5374 6174 7573 0a0a  status: Status..
+00003440: 2020 2020 233a 2043 6163 6865 6420 6861      #: Cached ha
+00003450: 7368 206f 6620 3a61 7474 723a 607e 576f  sh of :attr:`~Wo
+00003460: 726b 6572 5374 6174 652e 7365 7276 6572  rkerState.server
+00003470: 5f69 6460 0a20 2020 205f 6861 7368 3a20  _id`.    _hash: 
+00003480: 696e 740a 0a20 2020 2023 3a20 5468 6520  int..    #: The 
+00003490: 746f 7461 6c20 6d65 6d6f 7279 2073 697a  total memory siz
+000034a0: 652c 2069 6e20 6279 7465 732c 2075 7365  e, in bytes, use
+000034b0: 6420 6279 2074 6865 2074 6173 6b73 2074  d by the tasks t
+000034c0: 6869 7320 776f 726b 6572 2068 6f6c 6473  his worker holds
+000034d0: 2069 6e20 6d65 6d6f 7279 0a20 2020 2023   in memory.    #
+000034e0: 3a20 2869 2e65 2e20 7468 6520 7461 736b  : (i.e. the task
+000034f0: 7320 696e 2074 6869 7320 776f 726b 6572  s in this worker
+00003500: 2773 203a 6174 7472 3a60 7e57 6f72 6b65  's :attr:`~Worke
+00003510: 7253 7461 7465 2e68 6173 5f77 6861 7460  rState.has_what`
+00003520: 292e 0a20 2020 206e 6279 7465 733a 2069  )..    nbytes: i
+00003530: 6e74 0a0a 2020 2020 233a 2057 6f72 6b65  nt..    #: Worke
+00003540: 7220 6d65 6d6f 7279 2075 6e6b 6e6f 776e  r memory unknown
+00003550: 2074 6f20 7468 6520 776f 726b 6572 2c20   to the worker, 
+00003560: 696e 2062 7974 6573 2c20 7768 6963 6820  in bytes, which 
+00003570: 6861 7320 6265 656e 2074 6865 7265 2066  has been there f
+00003580: 6f72 206d 6f72 6520 7468 616e 0a20 2020  or more than.   
+00003590: 2023 3a20 3330 2073 6563 6f6e 6473 2e20   #: 30 seconds. 
+000035a0: 5365 6520 3a63 6c61 7373 3a60 4d65 6d6f  See :class:`Memo
+000035b0: 7279 5374 6174 6560 2e0a 2020 2020 5f6d  ryState`..    _m
+000035c0: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+000035d0: 6f6c 643a 2069 6e74 0a0a 2020 2020 233a  old: int..    #:
+000035e0: 2048 6973 746f 7279 206f 6620 7468 6520   History of the 
+000035f0: 6c61 7374 2033 3020 7365 636f 6e64 7327  last 30 seconds'
+00003600: 2077 6f72 7468 206f 6620 756e 6d61 6e61   worth of unmana
+00003610: 6765 6420 6d65 6d6f 7279 2e20 5573 6564  ged memory. Used
+00003620: 2074 6f20 6469 6666 6572 656e 7469 6174   to differentiat
+00003630: 650a 2020 2020 233a 2062 6574 7765 656e  e.    #: between
+00003640: 2022 6f6c 6422 2061 6e64 2022 6e65 7722   "old" and "new"
+00003650: 2075 6e6d 616e 6167 6564 206d 656d 6f72   unmanaged memor
+00003660: 792e 0a20 2020 2023 3a20 466f 726d 6174  y..    #: Format
+00003670: 3a20 6060 5b28 7469 6d65 7374 616d 702c  : ``[(timestamp,
+00003680: 2062 7974 6573 292c 2028 7469 6d65 7374   bytes), (timest
+00003690: 616d 702c 2062 7974 6573 292c 202e 2e2e  amp, bytes), ...
+000036a0: 5d60 600a 2020 2020 5f6d 656d 6f72 795f  ]``.    _memory_
+000036b0: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
+000036c0: 793a 2064 6571 7565 5b74 7570 6c65 5b66  y: deque[tuple[f
+000036d0: 6c6f 6174 2c20 696e 745d 5d0a 0a20 2020  loat, int]]..   
+000036e0: 206d 6574 7269 6373 3a20 6469 6374 5b73   metrics: dict[s
+000036f0: 7472 2c20 416e 795d 0a0a 2020 2020 233a  tr, Any]..    #:
+00003700: 2054 6865 206c 6173 7420 7469 6d65 2077   The last time w
+00003710: 6520 7265 6365 6976 6564 2061 2068 6561  e received a hea
+00003720: 7274 6265 6174 2066 726f 6d20 7468 6973  rtbeat from this
+00003730: 2077 6f72 6b65 722c 2069 6e20 6c6f 6361   worker, in loca
+00003740: 6c20 7363 6865 6475 6c65 7220 7469 6d65  l scheduler time
+00003750: 2e0a 2020 2020 6c61 7374 5f73 6565 6e3a  ..    last_seen:
+00003760: 2066 6c6f 6174 0a0a 2020 2020 7469 6d65   float..    time
+00003770: 5f64 656c 6179 3a20 666c 6f61 740a 2020  _delay: float.  
+00003780: 2020 6261 6e64 7769 6474 683a 2066 6c6f    bandwidth: flo
+00003790: 6174 0a0a 2020 2020 233a 2041 2073 6574  at..    #: A set
+000037a0: 206f 6620 616c 6c20 5461 736b 5374 6174   of all TaskStat
+000037b0: 6573 206f 6e20 7468 6973 2077 6f72 6b65  es on this worke
+000037c0: 7220 7468 6174 2061 7265 2061 6374 6f72  r that are actor
+000037d0: 732e 2054 6869 7320 6f6e 6c79 2069 6e63  s. This only inc
+000037e0: 6c75 6465 7320 7468 6f73 650a 2020 2020  ludes those.    
+000037f0: 233a 2061 6374 6f72 7320 7768 6f73 6520  #: actors whose 
+00003800: 7374 6174 6520 6163 7475 616c 6c79 206c  state actually l
+00003810: 6976 6573 206f 6e20 7468 6973 2077 6f72  ives on this wor
+00003820: 6b65 722c 206e 6f74 2061 6374 6f72 7320  ker, not actors 
+00003830: 746f 2077 6869 6368 2074 6869 7320 776f  to which this wo
+00003840: 726b 6572 0a20 2020 2023 3a20 6861 7320  rker.    #: has 
+00003850: 6120 7265 6665 7265 6e63 652e 0a20 2020  a reference..   
+00003860: 2061 6374 6f72 733a 2073 6574 5b54 6173   actors: set[Tas
+00003870: 6b53 7461 7465 5d0a 0a20 2020 2023 3a20  kState]..    #: 
+00003880: 556e 6465 726c 7969 6e67 2064 6174 6120  Underlying data 
+00003890: 6f66 203a 6d65 7468 3a60 576f 726b 6572  of :meth:`Worker
+000038a0: 5374 6174 652e 6861 735f 7768 6174 600a  State.has_what`.
+000038b0: 2020 2020 5f68 6173 5f77 6861 743a 2064      _has_what: d
+000038c0: 6963 745b 5461 736b 5374 6174 652c 204e  ict[TaskState, N
+000038d0: 6f6e 655d 0a0a 2020 2020 233a 2041 2073  one]..    #: A s
+000038e0: 6574 206f 6620 7461 736b 7320 7468 6174  et of tasks that
+000038f0: 2068 6176 6520 6265 656e 2073 7562 6d69   have been submi
+00003900: 7474 6564 2074 6f20 7468 6973 2077 6f72  tted to this wor
+00003910: 6b65 722e 204d 756c 7469 706c 6520 7461  ker. Multiple ta
+00003920: 736b 7320 6d61 7920 6265 0a20 2020 2023  sks may be.    #
+00003930: 2073 7562 6d69 7474 6564 2074 6f20 6120   submitted to a 
+00003940: 776f 726b 6572 2069 6e20 6164 7661 6e63  worker in advanc
+00003950: 6520 616e 6420 7468 6520 776f 726b 6572  e and the worker
+00003960: 2077 696c 6c20 7275 6e20 7468 656d 2065   will run them e
+00003970: 7665 6e74 7561 6c6c 792c 0a20 2020 2023  ventually,.    #
+00003980: 2064 6570 656e 6469 6e67 206f 6e20 6974   depending on it
+00003990: 7320 6578 6563 7574 696f 6e20 7265 736f  s execution reso
+000039a0: 7572 6365 7320 2862 7574 2073 6565 203a  urces (but see :
+000039b0: 646f 633a 6077 6f72 6b2d 7374 6561 6c69  doc:`work-steali
+000039c0: 6e67 6029 2e0a 2020 2020 233a 0a20 2020  ng`)..    #:.   
+000039d0: 2023 3a20 416c 6c20 7468 6520 7461 736b   #: All the task
+000039e0: 7320 6865 7265 2061 7265 2069 6e20 7468  s here are in th
+000039f0: 6520 2270 726f 6365 7373 696e 6722 2073  e "processing" s
+00003a00: 7461 7465 2e0a 2020 2020 233a 2054 6869  tate..    #: Thi
+00003a10: 7320 6174 7472 6962 7574 6520 6973 206b  s attribute is k
+00003a20: 6570 7420 696e 2073 796e 6320 7769 7468  ept in sync with
+00003a30: 203a 6174 7472 3a60 5461 736b 5374 6174   :attr:`TaskStat
+00003a40: 652e 7072 6f63 6573 7369 6e67 5f6f 6e60  e.processing_on`
+00003a50: 2e0a 2020 2020 7072 6f63 6573 7369 6e67  ..    processing
+00003a60: 3a20 7365 745b 5461 736b 5374 6174 655d  : set[TaskState]
+00003a70: 0a0a 2020 2020 233a 2052 756e 6e69 6e67  ..    #: Running
+00003a80: 2074 6173 6b73 2074 6861 7420 696e 766f   tasks that invo
+00003a90: 6b65 6420 3a66 756e 633a 6064 6973 7472  ked :func:`distr
+00003aa0: 6962 7574 6564 2e73 6563 6564 6560 0a20  ibuted.secede`. 
+00003ab0: 2020 206c 6f6e 675f 7275 6e6e 696e 673a     long_running:
+00003ac0: 2073 6574 5b54 6173 6b53 7461 7465 5d0a   set[TaskState].
+00003ad0: 0a20 2020 2023 3a20 4120 6469 6374 696f  .    #: A dictio
+00003ae0: 6e61 7279 206f 6620 7461 736b 7320 7468  nary of tasks th
+00003af0: 6174 2061 7265 2063 7572 7265 6e74 6c79  at are currently
+00003b00: 2062 6569 6e67 2072 756e 206f 6e20 7468   being run on th
+00003b10: 6973 2077 6f72 6b65 722e 0a20 2020 2023  is worker..    #
+00003b20: 3a20 4561 6368 2074 6173 6b20 7374 6174  : Each task stat
+00003b30: 6520 6973 2061 7373 6f63 6961 7465 6420  e is associated 
+00003b40: 7769 7468 2074 6865 2064 7572 6174 696f  with the duratio
+00003b50: 6e20 696e 2073 6563 6f6e 6473 2077 6869  n in seconds whi
+00003b60: 6368 2074 6865 2074 6173 6b20 6861 730a  ch the task has.
+00003b70: 2020 2020 233a 2062 6565 6e20 7275 6e6e      #: been runn
+00003b80: 696e 672e 0a20 2020 2065 7865 6375 7469  ing..    executi
+00003b90: 6e67 3a20 6469 6374 5b54 6173 6b53 7461  ng: dict[TaskSta
+00003ba0: 7465 2c20 666c 6f61 745d 0a0a 2020 2020  te, float]..    
+00003bb0: 233a 2054 6865 2061 7661 696c 6162 6c65  #: The available
+00003bc0: 2072 6573 6f75 7263 6573 206f 6e20 7468   resources on th
+00003bd0: 6973 2077 6f72 6b65 722c 2065 2e67 2e20  is worker, e.g. 
+00003be0: 6060 7b22 4750 5522 3a20 327d 6060 2e0a  ``{"GPU": 2}``..
+00003bf0: 2020 2020 233a 2054 6865 7365 2061 7265      #: These are
+00003c00: 2061 6273 7472 6163 7420 7175 616e 7469   abstract quanti
+00003c10: 7469 6573 2074 6861 7420 636f 6e73 7472  ties that constr
+00003c20: 6169 6e20 6365 7274 6169 6e20 7461 736b  ain certain task
+00003c30: 7320 6672 6f6d 2072 756e 6e69 6e67 2061  s from running a
+00003c40: 7420 7468 650a 2020 2020 233a 2073 616d  t the.    #: sam
+00003c50: 6520 7469 6d65 206f 6e20 7468 6973 2077  e time on this w
+00003c60: 6f72 6b65 722e 0a20 2020 2072 6573 6f75  orker..    resou
+00003c70: 7263 6573 3a20 6469 6374 5b73 7472 2c20  rces: dict[str, 
+00003c80: 666c 6f61 745d 0a0a 2020 2020 233a 2054  float]..    #: T
+00003c90: 6865 2073 756d 206f 6620 6561 6368 2072  he sum of each r
+00003ca0: 6573 6f75 7263 6520 7573 6564 2062 7920  esource used by 
+00003cb0: 616c 6c20 7461 736b 7320 616c 6c6f 6361  all tasks alloca
+00003cc0: 7465 6420 746f 2074 6869 7320 776f 726b  ted to this work
+00003cd0: 6572 2e0a 2020 2020 233a 2054 6865 206e  er..    #: The n
+00003ce0: 756d 6265 7273 2069 6e20 7468 6973 2064  umbers in this d
+00003cf0: 6963 7469 6f6e 6172 7920 6361 6e20 6f6e  ictionary can on
+00003d00: 6c79 2062 6520 6c65 7373 206f 7220 6571  ly be less or eq
+00003d10: 7561 6c20 7468 616e 2074 686f 7365 2069  ual than those i
+00003d20: 6e20 7468 6973 0a20 2020 2023 3a20 776f  n this.    #: wo
+00003d30: 726b 6572 2773 203a 6174 7472 3a60 7e57  rker's :attr:`~W
+00003d40: 6f72 6b65 7253 7461 7465 2e72 6573 6f75  orkerState.resou
+00003d50: 7263 6573 602e 0a20 2020 2075 7365 645f  rces`..    used_
+00003d60: 7265 736f 7572 6365 733a 2064 6963 745b  resources: dict[
+00003d70: 7374 722c 2066 6c6f 6174 5d0a 0a20 2020  str, float]..   
+00003d80: 2023 3a20 4172 6269 7472 6172 7920 6164   #: Arbitrary ad
+00003d90: 6469 7469 6f6e 616c 206d 6574 6164 6174  ditional metadat
+00003da0: 6120 746f 2062 6520 6164 6465 6420 746f  a to be added to
+00003db0: 203a 6d65 7468 3a60 7e57 6f72 6b65 7253   :meth:`~WorkerS
+00003dc0: 7461 7465 2e69 6465 6e74 6974 7960 0a20  tate.identity`. 
+00003dd0: 2020 2065 7874 7261 3a20 6469 6374 5b73     extra: dict[s
+00003de0: 7472 2c20 416e 795d 0a0a 2020 2020 2320  tr, Any]..    # 
+00003df0: 5468 6520 756e 6971 7565 2073 6572 7665  The unique serve
+00003e00: 7220 4944 2074 6869 7320 576f 726b 6572  r ID this Worker
+00003e10: 5374 6174 6520 6973 2072 6566 6572 656e  State is referen
+00003e20: 6369 6e67 0a20 2020 2073 6572 7665 725f  cing.    server_
+00003e30: 6964 3a20 7374 720a 0a20 2020 2023 2052  id: str..    # R
+00003e40: 6566 6572 656e 6365 2074 6f20 7363 6865  eference to sche
+00003e50: 6475 6c65 7220 7461 736b 5f67 726f 7570  duler task_group
+00003e60: 730a 2020 2020 7363 6865 6475 6c65 725f  s.    scheduler_
+00003e70: 7265 663a 2077 6561 6b72 6566 2e72 6566  ref: weakref.ref
+00003e80: 5b53 6368 6564 756c 6572 5374 6174 655d  [SchedulerState]
+00003e90: 207c 204e 6f6e 650a 2020 2020 7461 736b   | None.    task
+00003ea0: 5f70 7265 6669 785f 636f 756e 743a 2064  _prefix_count: d
+00003eb0: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
+00003ec0: 696e 745d 0a20 2020 205f 6e65 7477 6f72  int].    _networ
+00003ed0: 6b5f 6f63 633a 2066 6c6f 6174 0a20 2020  k_occ: float.   
+00003ee0: 205f 6f63 6375 7061 6e63 795f 6361 6368   _occupancy_cach
+00003ef0: 653a 2066 6c6f 6174 207c 204e 6f6e 650a  e: float | None.
+00003f00: 0a20 2020 2023 3a20 4b65 7973 2074 6861  .    #: Keys tha
+00003f10: 7420 6d61 7920 6e65 6564 2074 6f20 6265  t may need to be
+00003f20: 2066 6574 6368 6564 2074 6f20 7468 6973   fetched to this
+00003f30: 2077 6f72 6b65 722c 2061 6e64 2074 6865   worker, and the
+00003f40: 206e 756d 6265 7220 6f66 2074 6173 6b73   number of tasks
+00003f50: 2074 6861 7420 6e65 6564 2074 6865 6d2e   that need them.
+00003f60: 0a20 2020 2023 3a20 416c 6c20 7461 736b  .    #: All task
+00003f70: 7320 6172 6520 6375 7272 656e 746c 7920  s are currently 
+00003f80: 696e 2060 6d65 6d6f 7279 6020 6f6e 2061  in `memory` on a
+00003f90: 2077 6f72 6b65 7220 6f74 6865 7220 7468   worker other th
+00003fa0: 616e 2074 6869 7320 6f6e 652e 0a20 2020  an this one..   
+00003fb0: 2023 3a20 4d75 6368 206c 696b 6520 6070   #: Much like `p
+00003fc0: 726f 6365 7373 696e 6760 2c20 7468 6973  rocessing`, this
+00003fd0: 2064 6f65 7320 6e6f 7420 6578 6163 746c   does not exactl
+00003fe0: 7920 7265 666c 6563 7420 776f 726b 6572  y reflect worker
+00003ff0: 2073 7461 7465 3a0a 2020 2020 233a 206b   state:.    #: k
+00004000: 6579 7320 6865 7265 206d 6179 2062 6520  eys here may be 
+00004010: 7175 6575 6564 2074 6f20 6665 7463 682c  queued to fetch,
+00004020: 2069 6e20 666c 6967 6874 2c20 6f72 2061   in flight, or a
+00004030: 6c72 6561 6479 2069 6e20 6d65 6d6f 7279  lready in memory
+00004040: 0a20 2020 2023 3a20 6f6e 2074 6865 2077  .    #: on the w
+00004050: 6f72 6b65 722e 0a20 2020 206e 6565 6473  orker..    needs
+00004060: 5f77 6861 743a 2064 6963 745b 5461 736b  _what: dict[Task
+00004070: 5374 6174 652c 2069 6e74 5d0a 0a20 2020  State, int]..   
+00004080: 205f 5f73 6c6f 7473 5f5f 203d 2074 7570   __slots__ = tup
+00004090: 6c65 285f 5f61 6e6e 6f74 6174 696f 6e73  le(__annotations
+000040a0: 5f5f 290a 0a20 2020 2064 6566 205f 5f69  __)..    def __i
+000040b0: 6e69 745f 5f28 0a20 2020 2020 2020 2073  nit__(.        s
+000040c0: 656c 662c 0a20 2020 2020 2020 202a 2c0a  elf,.        *,.
+000040d0: 2020 2020 2020 2020 6164 6472 6573 733a          address:
+000040e0: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
+000040f0: 6174 7573 3a20 5374 6174 7573 2c0a 2020  atus: Status,.  
+00004100: 2020 2020 2020 7069 643a 2069 6e74 2c0a        pid: int,.
+00004110: 2020 2020 2020 2020 6e61 6d65 3a20 6f62          name: ob
+00004120: 6a65 6374 2c0a 2020 2020 2020 2020 6e74  ject,.        nt
+00004130: 6872 6561 6473 3a20 696e 7420 3d20 302c  hreads: int = 0,
+00004140: 0a20 2020 2020 2020 206d 656d 6f72 795f  .        memory_
+00004150: 6c69 6d69 743a 2069 6e74 2c0a 2020 2020  limit: int,.    
+00004160: 2020 2020 6c6f 6361 6c5f 6469 7265 6374      local_direct
+00004170: 6f72 793a 2073 7472 2c0a 2020 2020 2020  ory: str,.      
+00004180: 2020 6e61 6e6e 793a 2073 7472 207c 204e    nanny: str | N
+00004190: 6f6e 652c 0a20 2020 2020 2020 2073 6572  one,.        ser
+000041a0: 7665 725f 6964 3a20 7374 722c 0a20 2020  ver_id: str,.   
+000041b0: 2020 2020 2073 6572 7669 6365 733a 2064       services: d
+000041c0: 6963 745b 7374 722c 2069 6e74 5d20 7c20  ict[str, int] | 
+000041d0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+000041e0: 2020 2020 2076 6572 7369 6f6e 733a 2064       versions: d
+000041f0: 6963 745b 7374 722c 2041 6e79 5d20 7c20  ict[str, Any] | 
+00004200: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00004210: 2020 2020 2065 7874 7261 3a20 6469 6374       extra: dict
+00004220: 5b73 7472 2c20 416e 795d 207c 204e 6f6e  [str, Any] | Non
+00004230: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00004240: 2020 7363 6865 6475 6c65 723a 2053 6368    scheduler: Sch
+00004250: 6564 756c 6572 5374 6174 6520 7c20 4e6f  edulerState | No
+00004260: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
+00004270: 3a0a 2020 2020 2020 2020 7365 6c66 2e73  :.        self.s
+00004280: 6572 7665 725f 6964 203d 2073 6572 7665  erver_id = serve
+00004290: 725f 6964 0a20 2020 2020 2020 2073 656c  r_id.        sel
+000042a0: 662e 6164 6472 6573 7320 3d20 6164 6472  f.address = addr
+000042b0: 6573 730a 2020 2020 2020 2020 7365 6c66  ess.        self
+000042c0: 2e70 6964 203d 2070 6964 0a20 2020 2020  .pid = pid.     
+000042d0: 2020 2073 656c 662e 6e61 6d65 203d 206e     self.name = n
+000042e0: 616d 650a 2020 2020 2020 2020 7365 6c66  ame.        self
+000042f0: 2e6e 7468 7265 6164 7320 3d20 6e74 6872  .nthreads = nthr
+00004300: 6561 6473 0a20 2020 2020 2020 2073 656c  eads.        sel
+00004310: 662e 6d65 6d6f 7279 5f6c 696d 6974 203d  f.memory_limit =
+00004320: 206d 656d 6f72 795f 6c69 6d69 740a 2020   memory_limit.  
+00004330: 2020 2020 2020 7365 6c66 2e6c 6f63 616c        self.local
+00004340: 5f64 6972 6563 746f 7279 203d 206c 6f63  _directory = loc
+00004350: 616c 5f64 6972 6563 746f 7279 0a20 2020  al_directory.   
+00004360: 2020 2020 2073 656c 662e 7365 7276 6963       self.servic
+00004370: 6573 203d 2073 6572 7669 6365 7320 6f72  es = services or
+00004380: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
+00004390: 2e76 6572 7369 6f6e 7320 3d20 7665 7273  .versions = vers
+000043a0: 696f 6e73 206f 7220 7b7d 0a20 2020 2020  ions or {}.     
+000043b0: 2020 2073 656c 662e 6e61 6e6e 7920 3d20     self.nanny = 
+000043c0: 6e61 6e6e 790a 2020 2020 2020 2020 7365  nanny.        se
+000043d0: 6c66 2e73 7461 7475 7320 3d20 7374 6174  lf.status = stat
+000043e0: 7573 0a20 2020 2020 2020 2073 656c 662e  us.        self.
+000043f0: 5f68 6173 6820 3d20 6861 7368 2873 656c  _hash = hash(sel
+00004400: 662e 7365 7276 6572 5f69 6429 0a20 2020  f.server_id).   
+00004410: 2020 2020 2073 656c 662e 6e62 7974 6573       self.nbytes
+00004420: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+00004430: 662e 5f6d 656d 6f72 795f 756e 6d61 6e61  f._memory_unmana
+00004440: 6765 645f 6f6c 6420 3d20 300a 2020 2020  ged_old = 0.    
+00004450: 2020 2020 7365 6c66 2e5f 6d65 6d6f 7279      self._memory
+00004460: 5f75 6e6d 616e 6167 6564 5f68 6973 746f  _unmanaged_histo
+00004470: 7279 203d 2064 6571 7565 2829 0a20 2020  ry = deque().   
+00004480: 2020 2020 2073 656c 662e 6d65 7472 6963       self.metric
+00004490: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
+000044a0: 656c 662e 6c61 7374 5f73 6565 6e20 3d20  elf.last_seen = 
+000044b0: 300a 2020 2020 2020 2020 7365 6c66 2e74  0.        self.t
+000044c0: 696d 655f 6465 6c61 7920 3d20 300a 2020  ime_delay = 0.  
+000044d0: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
+000044e0: 6964 7468 203d 2070 6172 7365 5f62 7974  idth = parse_byt
+000044f0: 6573 2864 6173 6b2e 636f 6e66 6967 2e67  es(dask.config.g
+00004500: 6574 2822 6469 7374 7269 6275 7465 642e  et("distributed.
+00004510: 7363 6865 6475 6c65 722e 6261 6e64 7769  scheduler.bandwi
+00004520: 6474 6822 2929 0a20 2020 2020 2020 2073  dth")).        s
+00004530: 656c 662e 6163 746f 7273 203d 2073 6574  elf.actors = set
+00004540: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+00004550: 5f68 6173 5f77 6861 7420 3d20 7b7d 0a20  _has_what = {}. 
+00004560: 2020 2020 2020 2073 656c 662e 7072 6f63         self.proc
+00004570: 6573 7369 6e67 203d 2073 6574 2829 0a20  essing = set(). 
+00004580: 2020 2020 2020 2073 656c 662e 6c6f 6e67         self.long
+00004590: 5f72 756e 6e69 6e67 203d 2073 6574 2829  _running = set()
+000045a0: 0a20 2020 2020 2020 2073 656c 662e 6578  .        self.ex
+000045b0: 6563 7574 696e 6720 3d20 7b7d 0a20 2020  ecuting = {}.   
+000045c0: 2020 2020 2073 656c 662e 7265 736f 7572       self.resour
+000045d0: 6365 7320 3d20 7b7d 0a20 2020 2020 2020  ces = {}.       
+000045e0: 2073 656c 662e 7573 6564 5f72 6573 6f75   self.used_resou
+000045f0: 7263 6573 203d 207b 7d0a 2020 2020 2020  rces = {}.      
+00004600: 2020 7365 6c66 2e65 7874 7261 203d 2065    self.extra = e
+00004610: 7874 7261 206f 7220 7b7d 0a20 2020 2020  xtra or {}.     
+00004620: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
+00004630: 725f 7265 6620 3d20 7765 616b 7265 662e  r_ref = weakref.
+00004640: 7265 6628 7363 6865 6475 6c65 7229 2069  ref(scheduler) i
+00004650: 6620 7363 6865 6475 6c65 7220 656c 7365  f scheduler else
+00004660: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
+00004670: 6c66 2e74 6173 6b5f 7072 6566 6978 5f63  lf.task_prefix_c
+00004680: 6f75 6e74 203d 2064 6566 6175 6c74 6469  ount = defaultdi
+00004690: 6374 2869 6e74 290a 2020 2020 2020 2020  ct(int).        
+000046a0: 7365 6c66 2e6e 6565 6473 5f77 6861 7420  self.needs_what 
+000046b0: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+000046c0: 662e 5f6e 6574 776f 726b 5f6f 6363 203d  f._network_occ =
+000046d0: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+000046e0: 5f6f 6363 7570 616e 6379 5f63 6163 6865  _occupancy_cache
+000046f0: 203d 204e 6f6e 650a 0a20 2020 2064 6566   = None..    def
+00004700: 205f 5f68 6173 685f 5f28 7365 6c66 2920   __hash__(self) 
+00004710: 2d3e 2069 6e74 3a0a 2020 2020 2020 2020  -> int:.        
+00004720: 7265 7475 726e 2073 656c 662e 5f68 6173  return self._has
+00004730: 680a 0a20 2020 2064 6566 205f 5f65 715f  h..    def __eq_
+00004740: 5f28 7365 6c66 2c20 6f74 6865 723a 206f  _(self, other: o
+00004750: 626a 6563 7429 202d 3e20 626f 6f6c 3a0a  bject) -> bool:.
+00004760: 2020 2020 2020 2020 7265 7475 726e 2069          return i
+00004770: 7369 6e73 7461 6e63 6528 6f74 6865 722c  sinstance(other,
+00004780: 2057 6f72 6b65 7253 7461 7465 2920 616e   WorkerState) an
+00004790: 6420 6f74 6865 722e 7365 7276 6572 5f69  d other.server_i
+000047a0: 6420 3d3d 2073 656c 662e 7365 7276 6572  d == self.server
+000047b0: 5f69 640a 0a20 2020 2040 7072 6f70 6572  _id..    @proper
+000047c0: 7479 0a20 2020 2064 6566 2068 6173 5f77  ty.    def has_w
+000047d0: 6861 7428 7365 6c66 2920 2d3e 2053 6574  hat(self) -> Set
+000047e0: 5b54 6173 6b53 7461 7465 5d3a 0a20 2020  [TaskState]:.   
+000047f0: 2020 2020 2022 2222 416e 2069 6e73 6572       """An inser
+00004800: 7469 6f6e 2d73 6f72 7465 6420 7365 742d  tion-sorted set-
+00004810: 6c69 6b65 206f 6620 7461 736b 7320 7768  like of tasks wh
+00004820: 6963 6820 6375 7272 656e 746c 7920 7265  ich currently re
+00004830: 7369 6465 206f 6e20 7468 6973 2077 6f72  side on this wor
+00004840: 6b65 722e 0a20 2020 2020 2020 2041 6c6c  ker..        All
+00004850: 2074 6865 2074 6173 6b73 2068 6572 6520   the tasks here 
+00004860: 6172 6520 696e 2074 6865 2022 6d65 6d6f  are in the "memo
+00004870: 7279 2220 7374 6174 652e 0a20 2020 2020  ry" state..     
+00004880: 2020 2054 6869 7320 6973 2074 6865 2072     This is the r
+00004890: 6576 6572 7365 206d 6170 7069 6e67 206f  everse mapping o
+000048a0: 6620 3a61 7474 723a 6054 6173 6b53 7461  f :attr:`TaskSta
+000048b0: 7465 2e77 686f 5f68 6173 602e 0a0a 2020  te.who_has`...  
+000048c0: 2020 2020 2020 5468 6973 2069 7320 6120        This is a 
+000048d0: 7265 6164 2d6f 6e6c 7920 7075 626c 6963  read-only public
+000048e0: 2061 6363 6573 736f 722e 2054 6865 2064   accessor. The d
+000048f0: 6174 6120 6973 2069 6d70 6c65 6d65 6e74  ata is implement
+00004900: 6564 2061 7320 6120 6469 6374 2077 6974  ed as a dict wit
+00004910: 686f 7574 0a20 2020 2020 2020 2076 616c  hout.        val
+00004920: 7565 732c 2062 6563 6175 7365 2072 6562  ues, because reb
+00004930: 616c 616e 6365 2829 2072 656c 6965 7320  alance() relies 
+00004940: 6f6e 2064 6963 7473 2062 6569 6e67 2069  on dicts being i
+00004950: 6e73 6572 7469 6f6e 2d73 6f72 7465 642e  nsertion-sorted.
+00004960: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00004970: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00004980: 2e5f 6861 735f 7768 6174 2e6b 6579 7328  ._has_what.keys(
+00004990: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+000049a0: 0a20 2020 2064 6566 2068 6f73 7428 7365  .    def host(se
+000049b0: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
+000049c0: 2020 2020 7265 7475 726e 2067 6574 5f61      return get_a
+000049d0: 6464 7265 7373 5f68 6f73 7428 7365 6c66  ddress_host(self
+000049e0: 2e61 6464 7265 7373 290a 0a20 2020 2040  .address)..    @
+000049f0: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00004a00: 206d 656d 6f72 7928 7365 6c66 2920 2d3e   memory(self) ->
+00004a10: 204d 656d 6f72 7953 7461 7465 3a0a 2020   MemoryState:.  
+00004a20: 2020 2020 2020 2222 2250 6f6c 6973 6865        """Polishe
+00004a30: 6420 6d65 6d6f 7279 206d 6574 7269 6373  d memory metrics
+00004a40: 2066 6f72 2074 6865 2077 6f72 6b65 722e   for the worker.
+00004a50: 0a0a 2020 2020 2020 2020 2a2a 4465 7369  ..        **Desi
+00004a60: 676e 206e 6f74 6520 6f6e 206d 616e 6167  gn note on manag
+00004a70: 6564 206d 656d 6f72 792a 2a0a 0a20 2020  ed memory**..   
+00004a80: 2020 2020 2054 6865 7265 2061 7265 2074       There are t
+00004a90: 776f 206d 6561 7375 7265 7320 6176 6169  wo measures avai
+00004aa0: 6c61 626c 6520 666f 7220 6d61 6e61 6765  lable for manage
+00004ab0: 6420 6d65 6d6f 7279 3a0a 0a20 2020 2020  d memory:..     
+00004ac0: 2020 202d 2060 6073 656c 662e 6e62 7974     - ``self.nbyt
+00004ad0: 6573 6060 0a20 2020 2020 2020 202d 2060  es``.        - `
+00004ae0: 6073 656c 662e 6d65 7472 6963 735b 226d  `self.metrics["m
+00004af0: 616e 6167 6564 5f62 7974 6573 225d 6060  anaged_bytes"]``
+00004b00: 0a0a 2020 2020 2020 2020 4174 2072 6573  ..        At res
+00004b10: 742c 2074 6865 2074 776f 206e 756d 6265  t, the two numbe
+00004b20: 7273 206d 7573 7420 6265 2069 6465 6e74  rs must be ident
+00004b30: 6963 616c 2e20 486f 7765 7665 722c 2060  ical. However, `
+00004b40: 6073 656c 662e 6e62 7974 6573 6060 2069  `self.nbytes`` i
+00004b50: 730a 2020 2020 2020 2020 696d 6d65 6469  s.        immedi
+00004b60: 6174 656c 7920 7570 6461 7465 6420 7468  ately updated th
+00004b70: 726f 7567 6820 7468 6520 6261 7463 6865  rough the batche
+00004b80: 6420 636f 6d6d 7320 6173 2073 6f6f 6e20  d comms as soon 
+00004b90: 6173 2065 6163 6820 7461 736b 206c 616e  as each task lan
+00004ba0: 6473 2069 6e0a 2020 2020 2020 2020 6d65  ds in.        me
+00004bb0: 6d6f 7279 206f 6e20 7468 6520 776f 726b  mory on the work
+00004bc0: 6572 3b20 6060 7365 6c66 2e6d 6574 7269  er; ``self.metri
+00004bd0: 6373 5b22 6d61 6e61 6765 645f 6279 7465  cs["managed_byte
+00004be0: 7322 5d60 6020 696e 7374 6561 6420 6973  s"]`` instead is
+00004bf0: 2075 7064 6174 6564 2062 790a 2020 2020   updated by.    
+00004c00: 2020 2020 7468 6520 6865 6172 7462 6561      the heartbea
+00004c10: 742c 2077 6869 6368 2063 616e 206c 6167  t, which can lag
+00004c20: 2073 6576 6572 616c 2073 6563 6f6e 6473   several seconds
+00004c30: 2062 6568 696e 642e 0a0a 2020 2020 2020   behind...      
+00004c40: 2020 4265 6c6f 7720 7765 2061 7265 206d    Below we are m
+00004c50: 6978 696e 6720 6c69 6b65 6c79 206e 6577  ixing likely new
+00004c60: 6572 206d 616e 6167 6564 206d 656d 6f72  er managed memor
+00004c70: 7920 696e 666f 2066 726f 6d20 6060 7365  y info from ``se
+00004c80: 6c66 2e6e 6279 7465 7360 6020 7769 7468  lf.nbytes`` with
+00004c90: 0a20 2020 2020 2020 2070 726f 6365 7373  .        process
+00004ca0: 2061 6e64 2073 7069 6c6c 6564 206d 656d   and spilled mem
+00004cb0: 6f72 7920 6672 6f6d 2074 6865 2068 6561  ory from the hea
+00004cc0: 7274 6265 6174 2e20 5468 6973 2069 7320  rtbeat. This is 
+00004cd0: 6465 6c69 6265 7261 7465 2c20 736f 2074  deliberate, so t
+00004ce0: 6861 740a 2020 2020 2020 2020 6d61 6e61  hat.        mana
+00004cf0: 6765 6420 6d65 6d6f 7279 2074 6f74 616c  ged memory total
+00004d00: 2069 7320 7570 6461 7465 6420 6d6f 7265   is updated more
+00004d10: 2066 7265 7175 656e 746c 792e 0a0a 2020   frequently...  
+00004d20: 2020 2020 2020 4d61 6e61 6765 6420 6d65        Managed me
+00004d30: 6d6f 7279 2064 6972 6563 746c 7920 616e  mory directly an
+00004d40: 6420 696d 6d65 6469 6174 656c 7920 636f  d immediately co
+00004d50: 6e74 7269 6275 7465 7320 746f 206f 7074  ntributes to opt
+00004d60: 696d 6973 7469 6320 6d65 6d6f 7279 2c20  imistic memory, 
+00004d70: 7768 6963 680a 2020 2020 2020 2020 6973  which.        is
+00004d80: 2069 6e20 7475 726e 2075 7365 6420 696e   in turn used in
+00004d90: 2041 6374 6976 6520 4d65 6d6f 7279 204d   Active Memory M
+00004da0: 616e 6167 6572 2068 6575 7269 7374 6963  anager heuristic
+00004db0: 7320 2861 7420 7468 6520 6d6f 6d65 6e74  s (at the moment
+00004dc0: 206f 6620 7772 6974 696e 673b 0a20 2020   of writing;.   
+00004dd0: 2020 2020 206d 6f72 6520 7573 6573 2077       more uses w
+00004de0: 696c 6c20 6c69 6b65 6c79 2062 6520 6164  ill likely be ad
+00004df0: 6465 6420 696e 2074 6865 2066 7574 7572  ded in the futur
+00004e00: 6529 2e20 536f 2069 7427 7320 696d 706f  e). So it's impo
+00004e10: 7274 616e 7420 746f 2068 6176 6520 6974  rtant to have it
+00004e20: 0a20 2020 2020 2020 2075 7020 746f 2064  .        up to d
+00004e30: 6174 653b 206d 7563 6820 6d6f 7265 2074  ate; much more t
+00004e40: 6861 6e20 6974 2069 7320 666f 7220 7072  han it is for pr
+00004e50: 6f63 6573 7320 6d65 6d6f 7279 2e0a 0a20  ocess memory... 
+00004e60: 2020 2020 2020 2048 6176 696e 6720 7570         Having up
+00004e70: 2d74 6f2d 6461 7465 206d 616e 6167 6564  -to-date managed
+00004e80: 206d 656d 6f72 7920 696e 666f 2061 7320   memory info as 
+00004e90: 736f 6f6e 2061 7320 7468 6520 7363 6865  soon as the sche
+00004ea0: 6475 6c65 7220 6c65 6172 6e73 2061 626f  duler learns abo
+00004eb0: 7574 0a20 2020 2020 2020 2074 6173 6b20  ut.        task 
+00004ec0: 636f 6d70 6c65 7469 6f6e 2061 6c73 6f20  completion also 
+00004ed0: 7375 6273 7461 6e74 6961 6c6c 7920 7369  substantially si
+00004ee0: 6d70 6c69 6669 6573 2075 6e69 7420 7465  mplifies unit te
+00004ef0: 7374 732e 0a0a 2020 2020 2020 2020 5468  sts...        Th
+00004f00: 6520 666c 6970 2073 6964 6520 6f66 2074  e flip side of t
+00004f10: 6869 7320 6465 7369 676e 2069 7320 7468  his design is th
+00004f20: 6174 2069 7420 6d61 7920 6361 7573 6520  at it may cause 
+00004f30: 736f 6d65 206e 6f69 7365 2069 6e20 7468  some noise in th
+00004f40: 650a 2020 2020 2020 2020 756e 6d61 6e61  e.        unmana
+00004f50: 6765 645f 7265 6365 6e74 206d 6561 7375  ged_recent measu
+00004f60: 7265 2e20 652e 672e 3a0a 0a20 2020 2020  re. e.g.:..     
+00004f70: 2020 2031 2e20 4465 6c65 7465 2031 3030     1. Delete 100
+00004f80: 4d42 206f 6620 6d61 6e61 6765 6420 6461  MB of managed da
+00004f90: 7461 0a20 2020 2020 2020 2032 2e20 5468  ta.        2. Th
+00004fa0: 6520 7570 6461 7465 6420 6d61 6e61 6765  e updated manage
+00004fb0: 6420 6d65 6d6f 7279 2072 6561 6368 6573  d memory reaches
+00004fc0: 2074 6865 2073 6368 6564 756c 6572 2066   the scheduler f
+00004fd0: 6173 7465 7220 7468 616e 2074 6865 0a20  aster than the. 
+00004fe0: 2020 2020 2020 2020 2020 7570 6461 7465            update
+00004ff0: 6420 7072 6f63 6573 7320 6d65 6d6f 7279  d process memory
+00005000: 0a20 2020 2020 2020 2033 2e20 5468 6572  .        3. Ther
+00005010: 6527 7320 6120 626c 6970 2077 6865 7265  e's a blip where
+00005020: 2074 6865 2073 6368 6564 756c 6572 2074   the scheduler t
+00005030: 6869 6e6b 7320 7468 6174 2074 6865 7265  hinks that there
+00005040: 2773 2061 2073 7564 6465 6e20 3130 304d  's a sudden 100M
+00005050: 420a 2020 2020 2020 2020 2020 2069 6e63  B.           inc
+00005060: 7265 6173 6520 696e 2075 6e6d 616e 6167  rease in unmanag
+00005070: 6564 5f72 6563 656e 742c 2073 696e 6365  ed_recent, since
+00005080: 2070 726f 6365 7373 206d 656d 6f72 7920   process memory 
+00005090: 6861 736e 2774 2063 6861 6e67 6564 2062  hasn't changed b
+000050a0: 7574 206d 616e 6167 6564 0a20 2020 2020  ut managed.     
+000050b0: 2020 2020 2020 6d65 6d6f 7279 2068 6173        memory has
+000050c0: 2064 6563 7265 6173 6564 2062 7920 3130   decreased by 10
+000050d0: 304d 420a 2020 2020 2020 2020 342e 2057  0MB.        4. W
+000050e0: 6865 6e20 7468 6520 6865 6172 7462 6561  hen the heartbea
+000050f0: 7420 6172 7269 7665 732c 2070 726f 6365  t arrives, proce
+00005100: 7373 206d 656d 6f72 7920 676f 6573 2064  ss memory goes d
+00005110: 6f77 6e20 616e 6420 736f 2064 6f65 7320  own and so does 
+00005120: 7468 650a 2020 2020 2020 2020 2020 2075  the.           u
+00005130: 6e6d 616e 6167 6564 5f72 6563 656e 742e  nmanaged_recent.
+00005140: 0a0a 2020 2020 2020 2020 5468 6973 2069  ..        This i
+00005150: 7320 4f4b 202d 206f 6e65 206f 6620 7468  s OK - one of th
+00005160: 6520 6d61 696e 2072 6561 736f 6e73 2066  e main reasons f
+00005170: 6f72 2074 6865 2075 6e6d 616e 6167 6564  or the unmanaged
+00005180: 5f72 6563 656e 7420 2f20 756e 6d61 6e61  _recent / unmana
+00005190: 6765 645f 6f6c 640a 2020 2020 2020 2020  ged_old.        
+000051a0: 7370 6c69 7420 6973 2065 7861 6374 6c79  split is exactly
+000051b0: 2074 6f20 636f 6e63 656e 7472 6174 6520   to concentrate 
+000051c0: 616c 6c20 7468 6520 6e6f 6973 6520 696e  all the noise in
+000051d0: 2075 6e6d 616e 6167 6564 5f72 6563 656e   unmanaged_recen
+000051e0: 7420 616e 6420 6578 636c 7564 6520 6974  t and exclude it
+000051f0: 0a20 2020 2020 2020 2066 726f 6d20 6f70  .        from op
+00005200: 7469 6d69 7374 6963 206d 656d 6f72 792c  timistic memory,
+00005210: 2077 6869 6368 2069 7320 7573 6564 2066   which is used f
+00005220: 6f72 2068 6575 7269 7374 6963 732e 0a0a  or heuristics...
+00005230: 2020 2020 2020 2020 536f 6d65 7468 696e          Somethin
+00005240: 6720 7468 6174 2069 7320 6c65 7373 204f  g that is less O
+00005250: 4b2c 2062 7574 2061 6c73 6f20 6c65 7373  K, but also less
+00005260: 2066 7265 7175 656e 742c 2069 7320 7468   frequent, is th
+00005270: 6174 2074 6865 2073 7564 6465 6e20 6465  at the sudden de
+00005280: 6c65 7469 6f6e 0a20 2020 2020 2020 206f  letion.        o
+00005290: 6620 7370 696c 6c65 6420 6b65 7973 2077  f spilled keys w
+000052a0: 696c 6c20 6361 7573 6520 6120 6e65 6761  ill cause a nega
+000052b0: 7469 7665 2062 6c69 7020 696e 206d 616e  tive blip in man
+000052c0: 6167 6564 206d 656d 6f72 793a 0a0a 2020  aged memory:..  
+000052d0: 2020 2020 2020 312e 2044 656c 6574 6520        1. Delete 
+000052e0: 3130 304d 4220 6f66 2073 7069 6c6c 6564  100MB of spilled
+000052f0: 2064 6174 610a 2020 2020 2020 2020 322e   data.        2.
+00005300: 2054 6865 2075 7064 6174 6564 206d 616e   The updated man
+00005310: 6167 6564 206d 656d 6f72 7920 2a74 6f74  aged memory *tot
+00005320: 616c 2a20 7265 6163 6865 7320 7468 6520  al* reaches the 
+00005330: 7363 6865 6475 6c65 7220 6661 7374 6572  scheduler faster
+00005340: 2074 6861 6e20 7468 650a 2020 2020 2020   than the.      
+00005350: 2020 2020 2075 7064 6174 6564 2073 7069       updated spi
+00005360: 6c6c 6564 2070 6f72 7469 6f6e 0a20 2020  lled portion.   
+00005370: 2020 2020 2033 2e20 5468 6973 2063 6175       3. This cau
+00005380: 7365 7320 7468 6520 6d61 6e61 6765 6420  ses the managed 
+00005390: 6d65 6d6f 7279 2074 6f20 7465 6d70 6f72  memory to tempor
+000053a0: 6172 696c 7920 706c 756d 6d65 7420 616e  arily plummet an
+000053b0: 6420 6265 2072 6570 6c61 6365 6420 6279  d be replaced by
+000053c0: 0a20 2020 2020 2020 2020 2020 756e 6d61  .           unma
+000053d0: 6e61 6765 645f 7265 6365 6e74 2c20 7768  naged_recent, wh
+000053e0: 696c 6520 7370 696c 6c65 6420 6d65 6d6f  ile spilled memo
+000053f0: 7279 2072 656d 6169 6e73 2075 6e61 6c74  ry remains unalt
+00005400: 6572 6564 0a20 2020 2020 2020 2034 2e20  ered.        4. 
+00005410: 5768 656e 2074 6865 2068 6561 7274 6265  When the heartbe
+00005420: 6174 2061 7272 6976 6573 2c20 6d61 6e61  at arrives, mana
+00005430: 6765 6420 676f 6573 2062 6163 6b20 7570  ged goes back up
+00005440: 2c20 756e 6d61 6e61 6765 645f 7265 6365  , unmanaged_rece
+00005450: 6e74 0a20 2020 2020 2020 2020 2020 676f  nt.           go
+00005460: 6573 2062 6163 6b20 646f 776e 2c20 616e  es back down, an
+00005470: 6420 7370 696c 6c65 6420 676f 6573 2064  d spilled goes d
+00005480: 6f77 6e20 6279 2031 3030 4d42 2061 7320  own by 100MB as 
+00005490: 6974 2073 686f 756c 6420 6861 7665 2074  it should have t
+000054a0: 6f0a 2020 2020 2020 2020 2020 2062 6567  o.           beg
+000054b0: 696e 2077 6974 682e 0a0a 2020 2020 2020  in with...      
+000054c0: 2020 3a69 7373 7565 3a60 3630 3032 6020    :issue:`6002` 
+000054d0: 7769 6c6c 206c 6574 2075 7320 736f 6c76  will let us solv
+000054e0: 6520 7468 6973 2e0a 2020 2020 2020 2020  e this..        
+000054f0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+00005500: 726e 204d 656d 6f72 7953 7461 7465 280a  rn MemoryState(.
+00005510: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+00005520: 6573 733d 7365 6c66 2e6d 6574 7269 6373  ess=self.metrics
+00005530: 5b22 6d65 6d6f 7279 225d 2c0a 2020 2020  ["memory"],.    
+00005540: 2020 2020 2020 2020 6d61 6e61 6765 643d          managed=
+00005550: 6d61 7828 302c 2073 656c 662e 6e62 7974  max(0, self.nbyt
+00005560: 6573 202d 2073 656c 662e 6d65 7472 6963  es - self.metric
+00005570: 735b 2273 7069 6c6c 6564 5f62 7974 6573  s["spilled_bytes
+00005580: 225d 5b22 6d65 6d6f 7279 225d 292c 0a20  "]["memory"]),. 
+00005590: 2020 2020 2020 2020 2020 2073 7069 6c6c             spill
+000055a0: 6564 3d73 656c 662e 6d65 7472 6963 735b  ed=self.metrics[
+000055b0: 2273 7069 6c6c 6564 5f62 7974 6573 225d  "spilled_bytes"]
+000055c0: 5b22 6469 736b 225d 2c0a 2020 2020 2020  ["disk"],.      
+000055d0: 2020 2020 2020 756e 6d61 6e61 6765 645f        unmanaged_
+000055e0: 6f6c 643d 7365 6c66 2e5f 6d65 6d6f 7279  old=self._memory
+000055f0: 5f75 6e6d 616e 6167 6564 5f6f 6c64 2c0a  _unmanaged_old,.
+00005600: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00005610: 6566 2063 6c65 616e 2873 656c 6629 202d  ef clean(self) -
+00005620: 3e20 576f 726b 6572 5374 6174 653a 0a20  > WorkerState:. 
+00005630: 2020 2020 2020 2022 2222 5265 7475 726e         """Return
+00005640: 2061 2076 6572 7369 6f6e 206f 6620 7468   a version of th
+00005650: 6973 206f 626a 6563 7420 7468 6174 2069  is object that i
+00005660: 7320 6170 7072 6f70 7269 6174 6520 666f  s appropriate fo
+00005670: 7220 7365 7269 616c 697a 6174 696f 6e22  r serialization"
+00005680: 2222 0a20 2020 2020 2020 2077 7320 3d20  "".        ws = 
+00005690: 576f 726b 6572 5374 6174 6528 0a20 2020  WorkerState(.   
+000056a0: 2020 2020 2020 2020 2061 6464 7265 7373           address
+000056b0: 3d73 656c 662e 6164 6472 6573 732c 0a20  =self.address,. 
+000056c0: 2020 2020 2020 2020 2020 2073 7461 7475             statu
+000056d0: 733d 7365 6c66 2e73 7461 7475 732c 0a20  s=self.status,. 
+000056e0: 2020 2020 2020 2020 2020 2070 6964 3d73             pid=s
+000056f0: 656c 662e 7069 642c 0a20 2020 2020 2020  elf.pid,.       
+00005700: 2020 2020 206e 616d 653d 7365 6c66 2e6e       name=self.n
+00005710: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+00005720: 206e 7468 7265 6164 733d 7365 6c66 2e6e   nthreads=self.n
+00005730: 7468 7265 6164 732c 0a20 2020 2020 2020  threads,.       
+00005740: 2020 2020 206d 656d 6f72 795f 6c69 6d69       memory_limi
+00005750: 743d 7365 6c66 2e6d 656d 6f72 795f 6c69  t=self.memory_li
+00005760: 6d69 742c 0a20 2020 2020 2020 2020 2020  mit,.           
+00005770: 206c 6f63 616c 5f64 6972 6563 746f 7279   local_directory
+00005780: 3d73 656c 662e 6c6f 6361 6c5f 6469 7265  =self.local_dire
+00005790: 6374 6f72 792c 0a20 2020 2020 2020 2020  ctory,.         
+000057a0: 2020 2073 6572 7669 6365 733d 7365 6c66     services=self
+000057b0: 2e73 6572 7669 6365 732c 0a20 2020 2020  .services,.     
+000057c0: 2020 2020 2020 206e 616e 6e79 3d73 656c         nanny=sel
+000057d0: 662e 6e61 6e6e 792c 0a20 2020 2020 2020  f.nanny,.       
+000057e0: 2020 2020 2065 7874 7261 3d73 656c 662e       extra=self.
+000057f0: 6578 7472 612c 0a20 2020 2020 2020 2020  extra,.         
+00005800: 2020 2073 6572 7665 725f 6964 3d73 656c     server_id=sel
+00005810: 662e 7365 7276 6572 5f69 642c 0a20 2020  f.server_id,.   
+00005820: 2020 2020 2029 0a20 2020 2020 2020 2077       ).        w
+00005830: 732e 5f6f 6363 7570 616e 6379 5f63 6163  s._occupancy_cac
+00005840: 6865 203d 2073 656c 662e 6f63 6375 7061  he = self.occupa
+00005850: 6e63 790a 0a20 2020 2020 2020 2077 732e  ncy..        ws.
+00005860: 6578 6563 7574 696e 6720 3d20 7b0a 2020  executing = {.  
+00005870: 2020 2020 2020 2020 2020 7473 2e6b 6579            ts.key
+00005880: 3a20 6475 7261 7469 6f6e 2066 6f72 2074  : duration for t
+00005890: 732c 2064 7572 6174 696f 6e20 696e 2073  s, duration in s
+000058a0: 656c 662e 6578 6563 7574 696e 672e 6974  elf.executing.it
+000058b0: 656d 7328 2920 2023 2074 7970 653a 2069  ems()  # type: i
+000058c0: 676e 6f72 650a 2020 2020 2020 2020 7d0a  gnore.        }.
+000058d0: 2020 2020 2020 2020 7265 7475 726e 2077          return w
+000058e0: 730a 0a20 2020 2064 6566 205f 5f72 6570  s..    def __rep
+000058f0: 725f 5f28 7365 6c66 2920 2d3e 2073 7472  r__(self) -> str
+00005900: 3a0a 2020 2020 2020 2020 6e61 6d65 203d  :.        name =
+00005910: 2066 222c 206e 616d 653a 207b 7365 6c66   f", name: {self
+00005920: 2e6e 616d 657d 2220 6966 2073 656c 662e  .name}" if self.
+00005930: 6e61 6d65 2021 3d20 7365 6c66 2e61 6464  name != self.add
+00005940: 7265 7373 2065 6c73 6520 2222 0a20 2020  ress else "".   
+00005950: 2020 2020 2072 6574 7572 6e20 280a 2020       return (.  
+00005960: 2020 2020 2020 2020 2020 6622 3c57 6f72            f"<Wor
+00005970: 6b65 7253 7461 7465 207b 7365 6c66 2e61  kerState {self.a
+00005980: 6464 7265 7373 2172 7d7b 6e61 6d65 7d2c  ddress!r}{name},
+00005990: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
+000059a0: 2273 7461 7475 733a 207b 7365 6c66 2e73  "status: {self.s
+000059b0: 7461 7475 732e 6e61 6d65 7d2c 2022 0a20  tatus.name}, ". 
+000059c0: 2020 2020 2020 2020 2020 2066 226d 656d             f"mem
+000059d0: 6f72 793a 207b 6c65 6e28 7365 6c66 2e68  ory: {len(self.h
+000059e0: 6173 5f77 6861 7429 7d2c 2022 0a20 2020  as_what)}, ".   
+000059f0: 2020 2020 2020 2020 2066 2270 726f 6365           f"proce
+00005a00: 7373 696e 673a 207b 6c65 6e28 7365 6c66  ssing: {len(self
+00005a10: 2e70 726f 6365 7373 696e 6729 7d3e 220a  .processing)}>".
+00005a20: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00005a30: 6566 205f 7265 7072 5f68 746d 6c5f 2873  ef _repr_html_(s
+00005a40: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+00005a50: 2020 2020 2072 6574 7572 6e20 6765 745f       return get_
+00005a60: 7465 6d70 6c61 7465 2822 776f 726b 6572  template("worker
+00005a70: 5f73 7461 7465 2e68 746d 6c2e 6a32 2229  _state.html.j2")
+00005a80: 2e72 656e 6465 7228 0a20 2020 2020 2020  .render(.       
+00005a90: 2020 2020 2061 6464 7265 7373 3d73 656c       address=sel
+00005aa0: 662e 6164 6472 6573 732c 0a20 2020 2020  f.address,.     
+00005ab0: 2020 2020 2020 206e 616d 653d 7365 6c66         name=self
+00005ac0: 2e6e 616d 652c 0a20 2020 2020 2020 2020  .name,.         
+00005ad0: 2020 2073 7461 7475 733d 7365 6c66 2e73     status=self.s
+00005ae0: 7461 7475 732e 6e61 6d65 2c0a 2020 2020  tatus.name,.    
+00005af0: 2020 2020 2020 2020 6861 735f 7768 6174          has_what
+00005b00: 3d73 656c 662e 6861 735f 7768 6174 2c0a  =self.has_what,.
+00005b10: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+00005b20: 6573 7369 6e67 3d73 656c 662e 7072 6f63  essing=self.proc
+00005b30: 6573 7369 6e67 2c0a 2020 2020 2020 2020  essing,.        
+00005b40: 290a 0a20 2020 2064 6566 2069 6465 6e74  )..    def ident
+00005b50: 6974 7928 7365 6c66 2920 2d3e 2064 6963  ity(self) -> dic
+00005b60: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
+00005b70: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+00005b80: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
+00005b90: 3a20 2257 6f72 6b65 7222 2c0a 2020 2020  : "Worker",.    
+00005ba0: 2020 2020 2020 2020 2269 6422 3a20 7365          "id": se
+00005bb0: 6c66 2e6e 616d 652c 0a20 2020 2020 2020  lf.name,.       
+00005bc0: 2020 2020 2022 686f 7374 223a 2073 656c       "host": sel
+00005bd0: 662e 686f 7374 2c0a 2020 2020 2020 2020  f.host,.        
+00005be0: 2020 2020 2272 6573 6f75 7263 6573 223a      "resources":
+00005bf0: 2073 656c 662e 7265 736f 7572 6365 732c   self.resources,
+00005c00: 0a20 2020 2020 2020 2020 2020 2022 6c6f  .            "lo
+00005c10: 6361 6c5f 6469 7265 6374 6f72 7922 3a20  cal_directory": 
+00005c20: 7365 6c66 2e6c 6f63 616c 5f64 6972 6563  self.local_direc
+00005c30: 746f 7279 2c0a 2020 2020 2020 2020 2020  tory,.          
+00005c40: 2020 226e 616d 6522 3a20 7365 6c66 2e6e    "name": self.n
+00005c50: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+00005c60: 2022 6e74 6872 6561 6473 223a 2073 656c   "nthreads": sel
+00005c70: 662e 6e74 6872 6561 6473 2c0a 2020 2020  f.nthreads,.    
+00005c80: 2020 2020 2020 2020 226d 656d 6f72 795f          "memory_
+00005c90: 6c69 6d69 7422 3a20 7365 6c66 2e6d 656d  limit": self.mem
+00005ca0: 6f72 795f 6c69 6d69 742c 0a20 2020 2020  ory_limit,.     
+00005cb0: 2020 2020 2020 2022 6c61 7374 5f73 6565         "last_see
+00005cc0: 6e22 3a20 7365 6c66 2e6c 6173 745f 7365  n": self.last_se
+00005cd0: 656e 2c0a 2020 2020 2020 2020 2020 2020  en,.            
+00005ce0: 2273 6572 7669 6365 7322 3a20 7365 6c66  "services": self
+00005cf0: 2e73 6572 7669 6365 732c 0a20 2020 2020  .services,.     
+00005d00: 2020 2020 2020 2022 6d65 7472 6963 7322         "metrics"
+00005d10: 3a20 7365 6c66 2e6d 6574 7269 6373 2c0a  : self.metrics,.
+00005d20: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00005d30: 7475 7322 3a20 7365 6c66 2e73 7461 7475  tus": self.statu
+00005d40: 732e 6e61 6d65 2c0a 2020 2020 2020 2020  s.name,.        
+00005d50: 2020 2020 226e 616e 6e79 223a 2073 656c      "nanny": sel
+00005d60: 662e 6e61 6e6e 792c 0a20 2020 2020 2020  f.nanny,.       
+00005d70: 2020 2020 202a 2a73 656c 662e 6578 7472       **self.extr
+00005d80: 612c 0a20 2020 2020 2020 207d 0a0a 2020  a,.        }..  
+00005d90: 2020 6465 6620 5f74 6f5f 6469 6374 5f6e    def _to_dict_n
+00005da0: 6f5f 6e65 7374 2873 656c 662c 202a 2c20  o_nest(self, *, 
+00005db0: 6578 636c 7564 653a 2043 6f6e 7461 696e  exclude: Contain
+00005dc0: 6572 5b73 7472 5d20 3d20 2829 2920 2d3e  er[str] = ()) ->
+00005dd0: 2064 6963 745b 7374 722c 2041 6e79 5d3a   dict[str, Any]:
+00005de0: 0a20 2020 2020 2020 2022 2222 4469 6374  .        """Dict
+00005df0: 696f 6e61 7279 2072 6570 7265 7365 6e74  ionary represent
+00005e00: 6174 696f 6e20 666f 7220 6465 6275 6767  ation for debugg
+00005e10: 696e 6720 7075 7270 6f73 6573 2e0a 2020  ing purposes..  
+00005e20: 2020 2020 2020 4e6f 7420 7479 7065 2073        Not type s
+00005e30: 7461 626c 6520 616e 6420 6e6f 7420 696e  table and not in
+00005e40: 7465 6e64 6564 2066 6f72 2072 6f75 6e64  tended for round
+00005e50: 7472 6970 732e 0a0a 2020 2020 2020 2020  trips...        
+00005e60: 5365 6520 616c 736f 0a20 2020 2020 2020  See also.       
+00005e70: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+00005e80: 2020 436c 6965 6e74 2e64 756d 705f 636c    Client.dump_cl
+00005e90: 7573 7465 725f 7374 6174 650a 2020 2020  uster_state.    
+00005ea0: 2020 2020 6469 7374 7269 6275 7465 642e      distributed.
+00005eb0: 7574 696c 732e 7265 6375 7273 6976 655f  utils.recursive_
+00005ec0: 746f 5f64 6963 740a 2020 2020 2020 2020  to_dict.        
+00005ed0: 5461 736b 5374 6174 652e 5f74 6f5f 6469  TaskState._to_di
+00005ee0: 6374 0a20 2020 2020 2020 2022 2222 0a20  ct.        """. 
+00005ef0: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00005f00: 6375 7273 6976 655f 746f 5f64 6963 7428  cursive_to_dict(
+00005f10: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00005f20: 662c 0a20 2020 2020 2020 2020 2020 2065  f,.            e
+00005f30: 7863 6c75 6465 3d73 6574 2865 7863 6c75  xclude=set(exclu
+00005f40: 6465 2920 7c20 7b22 7665 7273 696f 6e73  de) | {"versions
+00005f50: 227d 2c20 2023 2074 7970 653a 2069 676e  "},  # type: ign
+00005f60: 6f72 650a 2020 2020 2020 2020 2020 2020  ore.            
+00005f70: 6d65 6d62 6572 733d 5472 7565 2c0a 2020  members=True,.  
+00005f80: 2020 2020 2020 290a 0a20 2020 2040 7072        )..    @pr
+00005f90: 6f70 6572 7479 0a20 2020 2064 6566 2073  operty.    def s
+00005fa0: 6368 6564 756c 6572 2873 656c 6629 202d  cheduler(self) -
+00005fb0: 3e20 5363 6865 6475 6c65 7253 7461 7465  > SchedulerState
+00005fc0: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
+00005fd0: 2073 656c 662e 7363 6865 6475 6c65 725f   self.scheduler_
+00005fe0: 7265 660a 2020 2020 2020 2020 7320 3d20  ref.        s = 
+00005ff0: 7365 6c66 2e73 6368 6564 756c 6572 5f72  self.scheduler_r
+00006000: 6566 2829 0a20 2020 2020 2020 2061 7373  ef().        ass
+00006010: 6572 7420 730a 2020 2020 2020 2020 7265  ert s.        re
+00006020: 7475 726e 2073 0a0a 2020 2020 6465 6620  turn s..    def 
+00006030: 6164 645f 746f 5f70 726f 6365 7373 696e  add_to_processin
+00006040: 6728 7365 6c66 2c20 7473 3a20 5461 736b  g(self, ts: Task
+00006050: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+00006060: 2020 2020 2020 2020 2222 2241 7373 6967          """Assig
+00006070: 6e20 6120 7461 736b 2074 6f20 7468 6973  n a task to this
+00006080: 2077 6f72 6b65 7220 666f 7220 636f 6d70   worker for comp
+00006090: 7574 652e 2222 220a 2020 2020 2020 2020  ute.""".        
+000060a0: 6966 2073 656c 662e 7363 6865 6475 6c65  if self.schedule
+000060b0: 722e 7661 6c69 6461 7465 3a0a 2020 2020  r.validate:.    
+000060c0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+000060d0: 7320 6e6f 7420 696e 2073 656c 662e 7072  s not in self.pr
+000060e0: 6f63 6573 7369 6e67 0a0a 2020 2020 2020  ocessing..      
+000060f0: 2020 7470 203d 2074 732e 7072 6566 6978    tp = ts.prefix
+00006100: 0a20 2020 2020 2020 2073 656c 662e 7461  .        self.ta
+00006110: 736b 5f70 7265 6669 785f 636f 756e 745b  sk_prefix_count[
+00006120: 7470 2e6e 616d 655d 202b 3d20 310a 2020  tp.name] += 1.  
+00006130: 2020 2020 2020 7365 6c66 2e73 6368 6564        self.sched
+00006140: 756c 6572 2e5f 7461 736b 5f70 7265 6669  uler._task_prefi
+00006150: 785f 636f 756e 745f 676c 6f62 616c 5b74  x_count_global[t
+00006160: 702e 6e61 6d65 5d20 2b3d 2031 0a20 2020  p.name] += 1.   
+00006170: 2020 2020 2073 656c 662e 7072 6f63 6573       self.proces
+00006180: 7369 6e67 2e61 6464 2874 7329 0a20 2020  sing.add(ts).   
+00006190: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
+000061a0: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
+000061b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000061c0: 6572 7420 6474 732e 7768 6f5f 6861 730a  ert dts.who_has.
+000061d0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+000061e0: 656c 6620 6e6f 7420 696e 2064 7473 2e77  elf not in dts.w
+000061f0: 686f 5f68 6173 3a0a 2020 2020 2020 2020  ho_has:.        
+00006200: 2020 2020 2020 2020 7365 6c66 2e5f 696e          self._in
+00006210: 635f 6e65 6564 735f 7265 706c 6963 6128  c_needs_replica(
+00006220: 6474 7329 0a0a 2020 2020 6465 6620 6164  dts)..    def ad
+00006230: 645f 746f 5f6c 6f6e 675f 7275 6e6e 696e  d_to_long_runnin
+00006240: 6728 7365 6c66 2c20 7473 3a20 5461 736b  g(self, ts: Task
+00006250: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
+00006260: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00006270: 7363 6865 6475 6c65 722e 7661 6c69 6461  scheduler.valida
+00006280: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+00006290: 6173 7365 7274 2074 7320 696e 2073 656c  assert ts in sel
+000062a0: 662e 7072 6f63 6573 7369 6e67 0a20 2020  f.processing.   
+000062b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+000062c0: 7473 206e 6f74 2069 6e20 7365 6c66 2e6c  ts not in self.l
+000062d0: 6f6e 675f 7275 6e6e 696e 670a 0a20 2020  ong_running..   
+000062e0: 2020 2020 2073 656c 662e 5f72 656d 6f76       self._remov
+000062f0: 655f 6672 6f6d 5f74 6173 6b5f 7072 6566  e_from_task_pref
+00006300: 6978 5f63 6f75 6e74 2874 7329 0a20 2020  ix_count(ts).   
+00006310: 2020 2020 2023 2043 616e 6e6f 7420 7265       # Cannot re
+00006320: 6d6f 7665 2066 726f 6d20 7072 6f63 6573  move from proces
+00006330: 7369 6e67 2073 696e 6365 2077 6527 7265  sing since we're
+00006340: 2075 7369 6e67 2074 6869 7320 666f 7220   using this for 
+00006350: 7468 696e 6773 206c 696b 650a 2020 2020  things like.    
+00006360: 2020 2020 2320 6964 6c65 6e65 7373 2064      # idleness d
+00006370: 6574 6563 7469 6f6e 2e20 4964 6c65 2077  etection. Idle w
+00006380: 6f72 6b65 7273 2061 7265 2074 7970 6963  orkers are typic
+00006390: 616c 6c79 2074 6172 6765 7465 6420 666f  ally targeted fo
+000063a0: 720a 2020 2020 2020 2020 2320 646f 776e  r.        # down
+000063b0: 7363 616c 696e 6720 6275 7420 7765 2073  scaling but we s
+000063c0: 686f 756c 6420 6e6f 7420 646f 776e 7363  hould not downsc
+000063d0: 616c 6520 776f 726b 6572 7320 7769 7468  ale workers with
+000063e0: 206c 6f6e 6720 7275 6e6e 696e 670a 2020   long running.  
+000063f0: 2020 2020 2020 2320 7461 736b 730a 2020        # tasks.  
+00006400: 2020 2020 2020 7365 6c66 2e6c 6f6e 675f        self.long_
+00006410: 7275 6e6e 696e 672e 6164 6428 7473 290a  running.add(ts).
+00006420: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
+00006430: 6672 6f6d 5f70 726f 6365 7373 696e 6728  from_processing(
+00006440: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+00006450: 6174 6529 202d 3e20 4e6f 6e65 3a0a 2020  ate) -> None:.  
+00006460: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
+00006470: 6120 7461 736b 2066 726f 6d20 6120 776f  a task from a wo
+00006480: 726b 6572 7320 7072 6f63 6573 7369 6e67  rkers processing
+00006490: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
+000064a0: 656c 662e 7363 6865 6475 6c65 722e 7661  elf.scheduler.va
+000064b0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+000064c0: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+000064d0: 2073 656c 662e 7072 6f63 6573 7369 6e67   self.processing
+000064e0: 0a0a 2020 2020 2020 2020 6966 2074 7320  ..        if ts 
+000064f0: 696e 2073 656c 662e 6c6f 6e67 5f72 756e  in self.long_run
+00006500: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+00006510: 2020 7365 6c66 2e6c 6f6e 675f 7275 6e6e    self.long_runn
+00006520: 696e 672e 6469 7363 6172 6428 7473 290a  ing.discard(ts).
+00006530: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00006540: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00006550: 7265 6d6f 7665 5f66 726f 6d5f 7461 736b  remove_from_task
+00006560: 5f70 7265 6669 785f 636f 756e 7428 7473  _prefix_count(ts
+00006570: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+00006580: 726f 6365 7373 696e 672e 7265 6d6f 7665  rocessing.remove
+00006590: 2874 7329 0a20 2020 2020 2020 2066 6f72  (ts).        for
+000065a0: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+000065b0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+000065c0: 2020 2020 2069 6620 6474 7320 696e 2073       if dts in s
+000065d0: 656c 662e 6e65 6564 735f 7768 6174 3a0a  elf.needs_what:.
+000065e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000065f0: 7365 6c66 2e5f 6465 635f 6e65 6564 735f  self._dec_needs_
+00006600: 7265 706c 6963 6128 6474 7329 0a0a 2020  replica(dts)..  
+00006610: 2020 6465 6620 5f72 656d 6f76 655f 6672    def _remove_fr
+00006620: 6f6d 5f74 6173 6b5f 7072 6566 6978 5f63  om_task_prefix_c
+00006630: 6f75 6e74 2873 656c 662c 2074 733a 2054  ount(self, ts: T
+00006640: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
+00006650: 653a 0a20 2020 2020 2020 2063 6f75 6e74  e:.        count
+00006660: 203d 2073 656c 662e 7461 736b 5f70 7265   = self.task_pre
+00006670: 6669 785f 636f 756e 745b 7473 2e70 7265  fix_count[ts.pre
+00006680: 6669 782e 6e61 6d65 5d20 2d20 310a 2020  fix.name] - 1.  
+00006690: 2020 2020 2020 6966 2063 6f75 6e74 3a0a        if count:.
+000066a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000066b0: 2e74 6173 6b5f 7072 6566 6978 5f63 6f75  .task_prefix_cou
+000066c0: 6e74 5b74 732e 7072 6566 6978 2e6e 616d  nt[ts.prefix.nam
+000066d0: 655d 203d 2063 6f75 6e74 0a20 2020 2020  e] = count.     
+000066e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000066f0: 2020 2020 2064 656c 2073 656c 662e 7461       del self.ta
+00006700: 736b 5f70 7265 6669 785f 636f 756e 745b  sk_prefix_count[
+00006710: 7473 2e70 7265 6669 782e 6e61 6d65 5d0a  ts.prefix.name].
+00006720: 0a20 2020 2020 2020 2063 6f75 6e74 203d  .        count =
+00006730: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00006740: 5f74 6173 6b5f 7072 6566 6978 5f63 6f75  _task_prefix_cou
+00006750: 6e74 5f67 6c6f 6261 6c5b 7473 2e70 7265  nt_global[ts.pre
+00006760: 6669 782e 6e61 6d65 5d20 2d20 310a 2020  fix.name] - 1.  
+00006770: 2020 2020 2020 6966 2063 6f75 6e74 3a0a        if count:.
+00006780: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006790: 2e73 6368 6564 756c 6572 2e5f 7461 736b  .scheduler._task
+000067a0: 5f70 7265 6669 785f 636f 756e 745f 676c  _prefix_count_gl
+000067b0: 6f62 616c 5b74 732e 7072 6566 6978 2e6e  obal[ts.prefix.n
+000067c0: 616d 655d 203d 2063 6f75 6e74 0a20 2020  ame] = count.   
+000067d0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000067e0: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
+000067f0: 7363 6865 6475 6c65 722e 5f74 6173 6b5f  scheduler._task_
+00006800: 7072 6566 6978 5f63 6f75 6e74 5f67 6c6f  prefix_count_glo
+00006810: 6261 6c5b 7473 2e70 7265 6669 782e 6e61  bal[ts.prefix.na
+00006820: 6d65 5d0a 0a20 2020 2064 6566 2072 656d  me]..    def rem
+00006830: 6f76 655f 7265 706c 6963 6128 7365 6c66  ove_replica(self
+00006840: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
+00006850: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00006860: 2020 2222 2254 6865 2077 6f72 6b65 7220    """The worker 
+00006870: 6e6f 206c 6f6e 6765 7220 6861 7320 6120  no longer has a 
+00006880: 7461 736b 2069 6e20 6d65 6d6f 7279 2222  task in memory""
+00006890: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+000068a0: 662e 7363 6865 6475 6c65 722e 7661 6c69  f.scheduler.vali
+000068b0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+000068c0: 2020 6173 7365 7274 2074 732e 7768 6f5f    assert ts.who_
+000068d0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+000068e0: 6173 7365 7274 2073 656c 6620 696e 2074  assert self in t
+000068f0: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+00006900: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
+00006910: 696e 2073 656c 662e 6861 735f 7768 6174  in self.has_what
+00006920: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00006930: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
+00006940: 6c66 2e6e 6565 6473 5f77 6861 740a 0a20  lf.needs_what.. 
+00006950: 2020 2020 2020 2073 656c 662e 6e62 7974         self.nbyt
+00006960: 6573 202d 3d20 7473 2e67 6574 5f6e 6279  es -= ts.get_nby
+00006970: 7465 7328 290a 2020 2020 2020 2020 6465  tes().        de
+00006980: 6c20 7365 6c66 2e5f 6861 735f 7768 6174  l self._has_what
+00006990: 5b74 735d 0a20 2020 2020 2020 2074 732e  [ts].        ts.
+000069a0: 7768 6f5f 6861 732e 7265 6d6f 7665 2873  who_has.remove(s
+000069b0: 656c 6629 2020 2320 7479 7065 3a20 6967  elf)  # type: ig
+000069c0: 6e6f 7265 0a20 2020 2020 2020 2069 6620  nore.        if 
+000069d0: 6e6f 7420 7473 2e77 686f 5f68 6173 3a0a  not ts.who_has:.
+000069e0: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
+000069f0: 686f 5f68 6173 203d 204e 6f6e 650a 0a20  ho_has = None.. 
+00006a00: 2020 2064 6566 205f 696e 635f 6e65 6564     def _inc_need
+00006a10: 735f 7265 706c 6963 6128 7365 6c66 2c20  s_replica(self, 
+00006a20: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
+00006a30: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00006a40: 2222 2241 7373 6967 6e20 6120 7461 736b  """Assign a task
+00006a50: 2066 6574 6368 2074 6f20 7468 6973 2077   fetch to this w
+00006a60: 6f72 6b65 7220 616e 6420 7570 6461 7465  orker and update
+00006a70: 206e 6574 776f 726b 206f 6363 7570 616e   network occupan
+00006a80: 6369 6573 2222 220a 2020 2020 2020 2020  cies""".        
+00006a90: 6966 2073 656c 662e 7363 6865 6475 6c65  if self.schedule
+00006aa0: 722e 7661 6c69 6461 7465 3a0a 2020 2020  r.validate:.    
+00006ab0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00006ac0: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+00006ad0: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+00006ae0: 6620 6e6f 7420 696e 2074 732e 7768 6f5f  f not in ts.who_
+00006af0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+00006b00: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
+00006b10: 2073 656c 662e 6861 735f 7768 6174 0a20   self.has_what. 
+00006b20: 2020 2020 2020 2069 6620 7473 206e 6f74         if ts not
+00006b30: 2069 6e20 7365 6c66 2e6e 6565 6473 5f77   in self.needs_w
+00006b40: 6861 743a 0a20 2020 2020 2020 2020 2020  hat:.           
+00006b50: 2073 656c 662e 6e65 6564 735f 7768 6174   self.needs_what
+00006b60: 5b74 735d 203d 2031 0a20 2020 2020 2020  [ts] = 1.       
+00006b70: 2020 2020 206e 6279 7465 7320 3d20 7473       nbytes = ts
+00006b80: 2e67 6574 5f6e 6279 7465 7328 290a 2020  .get_nbytes().  
+00006b90: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00006ba0: 6e65 7477 6f72 6b5f 6f63 6320 2b3d 206e  network_occ += n
+00006bb0: 6279 7465 730a 2020 2020 2020 2020 2020  bytes.          
+00006bc0: 2020 7365 6c66 2e73 6368 6564 756c 6572    self.scheduler
+00006bd0: 2e5f 6e65 7477 6f72 6b5f 6f63 635f 676c  ._network_occ_gl
+00006be0: 6f62 616c 202b 3d20 6e62 7974 6573 0a20  obal += nbytes. 
+00006bf0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00006c00: 2020 2020 2020 2020 2073 656c 662e 6e65           self.ne
+00006c10: 6564 735f 7768 6174 5b74 735d 202b 3d20  eds_what[ts] += 
+00006c20: 310a 0a20 2020 2064 6566 205f 6465 635f  1..    def _dec_
+00006c30: 6e65 6564 735f 7265 706c 6963 6128 7365  needs_replica(se
+00006c40: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
+00006c50: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
+00006c60: 2020 2020 6966 2073 656c 662e 7363 6865      if self.sche
+00006c70: 6475 6c65 722e 7661 6c69 6461 7465 3a0a  duler.validate:.
+00006c80: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00006c90: 7274 2074 7320 696e 2073 656c 662e 6e65  rt ts in self.ne
+00006ca0: 6564 735f 7768 6174 0a0a 2020 2020 2020  eds_what..      
+00006cb0: 2020 7365 6c66 2e6e 6565 6473 5f77 6861    self.needs_wha
+00006cc0: 745b 7473 5d20 2d3d 2031 0a20 2020 2020  t[ts] -= 1.     
+00006cd0: 2020 2069 6620 7365 6c66 2e6e 6565 6473     if self.needs
+00006ce0: 5f77 6861 745b 7473 5d20 3d3d 2030 3a0a  _what[ts] == 0:.
+00006cf0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+00006d00: 7365 6c66 2e6e 6565 6473 5f77 6861 745b  self.needs_what[
+00006d10: 7473 5d0a 2020 2020 2020 2020 2020 2020  ts].            
+00006d20: 6e62 7974 6573 203d 2074 732e 6765 745f  nbytes = ts.get_
+00006d30: 6e62 7974 6573 2829 0a20 2020 2020 2020  nbytes().       
+00006d40: 2020 2020 2073 656c 662e 5f6e 6574 776f       self._netwo
+00006d50: 726b 5f6f 6363 202d 3d20 6e62 7974 6573  rk_occ -= nbytes
+00006d60: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006d70: 662e 7363 6865 6475 6c65 722e 5f6e 6574  f.scheduler._net
+00006d80: 776f 726b 5f6f 6363 5f67 6c6f 6261 6c20  work_occ_global 
+00006d90: 2d3d 206e 6279 7465 730a 0a20 2020 2064  -= nbytes..    d
+00006da0: 6566 2061 6464 5f72 6570 6c69 6361 2873  ef add_replica(s
+00006db0: 656c 662c 2074 733a 2054 6173 6b53 7461  elf, ts: TaskSta
+00006dc0: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
+00006dd0: 2020 2020 2022 2222 5468 6520 776f 726b       """The work
+00006de0: 6572 2061 6371 7569 7265 6420 6120 7265  er acquired a re
+00006df0: 706c 6963 6120 6f66 2074 6173 6b22 2222  plica of task"""
+00006e00: 0a20 2020 2020 2020 2069 6620 7473 2e77  .        if ts.w
+00006e10: 686f 5f68 6173 2069 7320 4e6f 6e65 3a0a  ho_has is None:.
+00006e20: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
+00006e30: 686f 5f68 6173 203d 2073 6574 2829 0a20  ho_has = set(). 
+00006e40: 2020 2020 2020 2069 6620 7473 2069 6e20         if ts in 
+00006e50: 7365 6c66 2e5f 6861 735f 7768 6174 3a0a  self._has_what:.
+00006e60: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00006e70: 726e 0a20 2020 2020 2020 206e 6279 7465  rn.        nbyte
+00006e80: 7320 3d20 7473 2e67 6574 5f6e 6279 7465  s = ts.get_nbyte
+00006e90: 7328 290a 2020 2020 2020 2020 6966 2074  s().        if t
+00006ea0: 7320 696e 2073 656c 662e 6e65 6564 735f  s in self.needs_
+00006eb0: 7768 6174 3a0a 2020 2020 2020 2020 2020  what:.          
+00006ec0: 2020 6465 6c20 7365 6c66 2e6e 6565 6473    del self.needs
+00006ed0: 5f77 6861 745b 7473 5d0a 2020 2020 2020  _what[ts].      
+00006ee0: 2020 2020 2020 7365 6c66 2e5f 6e65 7477        self._netw
+00006ef0: 6f72 6b5f 6f63 6320 2d3d 206e 6279 7465  ork_occ -= nbyte
+00006f00: 730a 2020 2020 2020 2020 2020 2020 7365  s.            se
+00006f10: 6c66 2e73 6368 6564 756c 6572 2e5f 6e65  lf.scheduler._ne
+00006f20: 7477 6f72 6b5f 6f63 635f 676c 6f62 616c  twork_occ_global
+00006f30: 202d 3d20 6e62 7974 6573 0a20 2020 2020   -= nbytes.     
+00006f40: 2020 2074 732e 7768 6f5f 6861 732e 6164     ts.who_has.ad
+00006f50: 6428 7365 6c66 290a 2020 2020 2020 2020  d(self).        
+00006f60: 7365 6c66 2e6e 6279 7465 7320 2b3d 206e  self.nbytes += n
+00006f70: 6279 7465 730a 2020 2020 2020 2020 7365  bytes.        se
+00006f80: 6c66 2e5f 6861 735f 7768 6174 5b74 735d  lf._has_what[ts]
+00006f90: 203d 204e 6f6e 650a 0a20 2020 2040 7072   = None..    @pr
+00006fa0: 6f70 6572 7479 0a20 2020 2064 6566 206f  operty.    def o
+00006fb0: 6363 7570 616e 6379 2873 656c 6629 202d  ccupancy(self) -
+00006fc0: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
+00006fd0: 2072 6574 7572 6e20 7365 6c66 2e5f 6f63   return self._oc
+00006fe0: 6375 7061 6e63 795f 6361 6368 6520 6f72  cupancy_cache or
+00006ff0: 2073 656c 662e 7363 6865 6475 6c65 722e   self.scheduler.
+00007000: 5f63 616c 635f 6f63 6375 7061 6e63 7928  _calc_occupancy(
+00007010: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00007020: 662e 7461 736b 5f70 7265 6669 785f 636f  f.task_prefix_co
+00007030: 756e 742c 2073 656c 662e 5f6e 6574 776f  unt, self._netwo
+00007040: 726b 5f6f 6363 0a20 2020 2020 2020 2029  rk_occ.        )
+00007050: 0a0a 0a40 6461 7461 636c 6173 7365 732e  ...@dataclasses.
+00007060: 6461 7461 636c 6173 730a 636c 6173 7320  dataclass.class 
+00007070: 4572 7265 6454 6173 6b3a 0a20 2020 2022  ErredTask:.    "
+00007080: 2222 4c69 6768 7477 6569 6768 7420 7265  ""Lightweight re
+00007090: 7072 6573 656e 7461 7469 6f6e 206f 6620  presentation of 
+000070a0: 616e 2065 7272 6564 2074 6173 6b20 7769  an erred task wi
+000070b0: 7468 6f75 7420 616e 7920 6465 7065 6e64  thout any depend
+000070c0: 656e 6379 2069 6e66 6f72 6d61 7469 6f6e  ency information
+000070d0: 0a20 2020 206f 7220 7275 6e73 7065 632e  .    or runspec.
+000070e0: 0a0a 2020 2020 5365 6520 616c 736f 0a20  ..    See also. 
+000070f0: 2020 202d 2d2d 2d2d 2d2d 2d0a 2020 2020     --------.    
+00007100: 5461 736b 5374 6174 650a 2020 2020 2222  TaskState.    ""
+00007110: 220a 0a20 2020 206b 6579 3a20 4861 7368  "..    key: Hash
+00007120: 6162 6c65 0a20 2020 2074 696d 6573 7461  able.    timesta
+00007130: 6d70 3a20 666c 6f61 740a 2020 2020 6572  mp: float.    er
+00007140: 7265 645f 6f6e 3a20 7365 745b 7374 725d  red_on: set[str]
+00007150: 0a20 2020 2065 7863 6570 7469 6f6e 5f74  .    exception_t
+00007160: 6578 743a 2073 7472 0a20 2020 2074 7261  ext: str.    tra
+00007170: 6365 6261 636b 5f74 6578 743a 2073 7472  ceback_text: str
+00007180: 0a0a 0a63 6c61 7373 2043 6f6d 7075 7461  ...class Computa
+00007190: 7469 6f6e 3a0a 2020 2020 2222 2243 6f6c  tion:.    """Col
+000071a0: 6c65 6374 696f 6e20 7472 6163 6b69 6e67  lection tracking
+000071b0: 2061 2073 696e 676c 6520 636f 6d70 7574   a single comput
+000071c0: 6520 6f72 2070 6572 7369 7374 2063 616c  e or persist cal
+000071d0: 6c0a 0a20 2020 2044 4550 5245 4341 5445  l..    DEPRECATE
+000071e0: 443a 2070 6c65 6173 6520 7573 6520 7370  D: please use sp
+000071f0: 616e 7320 696e 7374 6561 640a 0a20 2020  ans instead..   
+00007200: 2053 6565 2061 6c73 6f0a 2020 2020 2d2d   See also.    --
+00007210: 2d2d 2d2d 2d2d 0a20 2020 2054 6173 6b50  ------.    TaskP
+00007220: 7265 6669 780a 2020 2020 5461 736b 4772  refix.    TaskGr
+00007230: 6f75 700a 2020 2020 5461 736b 5374 6174  oup.    TaskStat
+00007240: 650a 2020 2020 2222 220a 0a20 2020 2073  e.    """..    s
+00007250: 7461 7274 3a20 666c 6f61 740a 2020 2020  tart: float.    
+00007260: 6772 6f75 7073 3a20 7365 745b 5461 736b  groups: set[Task
+00007270: 4772 6f75 705d 0a20 2020 2063 6f64 653a  Group].    code:
+00007280: 2053 6f72 7465 6453 6574 5b74 7570 6c65   SortedSet[tuple
+00007290: 5b53 6f75 7263 6543 6f64 652c 202e 2e2e  [SourceCode, ...
+000072a0: 5d5d 0a20 2020 2069 643a 2075 7569 642e  ]].    id: uuid.
+000072b0: 5555 4944 0a20 2020 2061 6e6e 6f74 6174  UUID.    annotat
+000072c0: 696f 6e73 3a20 6469 6374 0a0a 2020 2020  ions: dict..    
+000072d0: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
+000072e0: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
+000072f0: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
+00007300: 6974 5f5f 2873 656c 6629 3a0a 2020 2020  it__(self):.    
+00007310: 2020 2020 7365 6c66 2e73 7461 7274 203d      self.start =
+00007320: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
+00007330: 7365 6c66 2e67 726f 7570 7320 3d20 7365  self.groups = se
+00007340: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+00007350: 2e63 6f64 6520 3d20 536f 7274 6564 5365  .code = SortedSe
+00007360: 7428 290a 2020 2020 2020 2020 7365 6c66  t().        self
+00007370: 2e69 6420 3d20 7575 6964 2e75 7569 6434  .id = uuid.uuid4
+00007380: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+00007390: 616e 6e6f 7461 7469 6f6e 7320 3d20 7b7d  annotations = {}
+000073a0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+000073b0: 2020 2020 6465 6620 7374 6f70 2873 656c      def stop(sel
+000073c0: 6629 202d 3e20 666c 6f61 743a 0a20 2020  f) -> float:.   
+000073d0: 2020 2020 2069 6620 7365 6c66 2e67 726f       if self.gro
+000073e0: 7570 733a 0a20 2020 2020 2020 2020 2020  ups:.           
+000073f0: 2072 6574 7572 6e20 6d61 7828 7467 2e73   return max(tg.s
+00007400: 746f 7020 666f 7220 7467 2069 6e20 7365  top for tg in se
+00007410: 6c66 2e67 726f 7570 7329 0a20 2020 2020  lf.groups).     
+00007420: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00007430: 2020 2020 2072 6574 7572 6e20 2d31 0a0a       return -1..
+00007440: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00007450: 2020 6465 6620 7374 6174 6573 2873 656c    def states(sel
+00007460: 6629 202d 3e20 6469 6374 5b54 6173 6b53  f) -> dict[TaskS
+00007470: 7461 7465 5374 6174 652c 2069 6e74 5d3a  tateState, int]:
+00007480: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00007490: 6d65 7267 655f 7769 7468 2873 756d 2c20  merge_with(sum, 
+000074a0: 2874 672e 7374 6174 6573 2066 6f72 2074  (tg.states for t
+000074b0: 6720 696e 2073 656c 662e 6772 6f75 7073  g in self.groups
+000074c0: 2929 0a0a 2020 2020 6465 6620 5f5f 7265  ))..    def __re
+000074d0: 7072 5f5f 2873 656c 6629 202d 3e20 7374  pr__(self) -> st
+000074e0: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
+000074f0: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
+00007500: 6622 3c43 6f6d 7075 7461 7469 6f6e 207b  f"<Computation {
+00007510: 7365 6c66 2e69 647d 3a20 220a 2020 2020  self.id}: ".    
+00007520: 2020 2020 2020 2020 2b20 2254 6173 6b73          + "Tasks
+00007530: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
+00007540: 2b20 222c 2022 2e6a 6f69 6e28 0a20 2020  + ", ".join(.   
+00007550: 2020 2020 2020 2020 2020 2020 2022 2573               "%s
+00007560: 3a20 2564 2220 2520 286b 2c20 7629 2066  : %d" % (k, v) f
+00007570: 6f72 2028 6b2c 2076 2920 696e 2073 6f72  or (k, v) in sor
+00007580: 7465 6428 7365 6c66 2e73 7461 7465 732e  ted(self.states.
+00007590: 6974 656d 7328 2929 2069 6620 760a 2020  items()) if v.  
+000075a0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+000075b0: 2020 2020 2020 2020 2b20 223e 220a 2020          + ">".  
+000075c0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+000075d0: 205f 7265 7072 5f68 746d 6c5f 2873 656c   _repr_html_(sel
+000075e0: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
+000075f0: 2020 2072 6574 7572 6e20 6765 745f 7465     return get_te
+00007600: 6d70 6c61 7465 2822 636f 6d70 7574 6174  mplate("computat
+00007610: 696f 6e2e 6874 6d6c 2e6a 3222 292e 7265  ion.html.j2").re
+00007620: 6e64 6572 280a 2020 2020 2020 2020 2020  nder(.          
+00007630: 2020 6964 3d73 656c 662e 6964 2c0a 2020    id=self.id,.  
+00007640: 2020 2020 2020 2020 2020 7374 6172 743d            start=
+00007650: 7365 6c66 2e73 7461 7274 2c0a 2020 2020  self.start,.    
+00007660: 2020 2020 2020 2020 7374 6f70 3d73 656c          stop=sel
+00007670: 662e 7374 6f70 2c0a 2020 2020 2020 2020  f.stop,.        
+00007680: 2020 2020 6772 6f75 7073 3d73 656c 662e      groups=self.
+00007690: 6772 6f75 7073 2c0a 2020 2020 2020 2020  groups,.        
+000076a0: 2020 2020 7374 6174 6573 3d73 656c 662e      states=self.
+000076b0: 7374 6174 6573 2c0a 2020 2020 2020 2020  states,.        
+000076c0: 2020 2020 636f 6465 3d73 656c 662e 636f      code=self.co
+000076d0: 6465 2c0a 2020 2020 2020 2020 290a 0a0a  de,.        )...
+000076e0: 636c 6173 7320 5461 736b 5072 6566 6978  class TaskPrefix
+000076f0: 3a0a 2020 2020 2222 2243 6f6c 6c65 6374  :.    """Collect
+00007700: 696f 6e20 7472 6163 6b69 6e67 2061 6c6c  ion tracking all
+00007710: 2074 6173 6b73 2077 6974 6869 6e20 6120   tasks within a 
+00007720: 6772 6f75 700a 0a20 2020 204b 6579 7320  group..    Keys 
+00007730: 6f66 7465 6e20 6861 7665 2061 2073 7472  often have a str
+00007740: 7563 7475 7265 206c 696b 6520 6060 2822  ucture like ``("
+00007750: 782d 3132 3322 2c20 3029 6060 0a20 2020  x-123", 0)``.   
+00007760: 2041 2067 726f 7570 2074 616b 6573 2074   A group takes t
+00007770: 6865 2066 6972 7374 2073 6563 7469 6f6e  he first section
+00007780: 2c20 6c69 6b65 2060 6022 7822 6060 0a0a  , like ``"x"``..
+00007790: 2020 2020 5365 6520 416c 736f 0a20 2020      See Also.   
+000077a0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 5461   --------.    Ta
+000077b0: 736b 4772 6f75 700a 2020 2020 2222 220a  skGroup.    """.
+000077c0: 0a20 2020 2023 3a20 5468 6520 6e61 6d65  .    #: The name
+000077d0: 206f 6620 6120 6772 6f75 7020 6f66 2074   of a group of t
+000077e0: 6173 6b73 2e0a 2020 2020 233a 2046 6f72  asks..    #: For
+000077f0: 2061 2074 6173 6b20 6c69 6b65 2060 6028   a task like ``(
+00007800: 2278 2d31 3233 222c 2030 2960 6020 7468  "x-123", 0)`` th
+00007810: 6973 2069 7320 7468 6520 7465 7874 2060  is is the text `
+00007820: 6022 7822 6060 0a20 2020 206e 616d 653a  `"x"``.    name:
+00007830: 2073 7472 0a0a 2020 2020 233a 2041 6e20   str..    #: An 
+00007840: 6578 706f 6e65 6e74 6961 6c6c 7920 7765  exponentially we
+00007850: 6967 6874 6564 206d 6f76 696e 6720 6176  ighted moving av
+00007860: 6572 6167 6520 6475 7261 7469 6f6e 206f  erage duration o
+00007870: 6620 616c 6c20 7461 736b 7320 7769 7468  f all tasks with
+00007880: 2074 6869 7320 7072 6566 6978 0a20 2020   this prefix.   
+00007890: 2064 7572 6174 696f 6e5f 6176 6572 6167   duration_averag
+000078a0: 653a 2066 6c6f 6174 0a0a 2020 2020 233a  e: float..    #:
+000078b0: 204e 756d 6265 7273 206f 6620 7469 6d65   Numbers of time
+000078c0: 7320 6120 7461 736b 2077 6173 206d 6172  s a task was mar
+000078d0: 6b65 6420 6173 2073 7573 7069 6369 6f75  ked as suspiciou
+000078e0: 7320 7769 7468 2074 6869 7320 7072 6566  s with this pref
+000078f0: 6978 0a20 2020 2073 7573 7069 6369 6f75  ix.    suspiciou
+00007900: 733a 2069 6e74 0a0a 2020 2020 233a 2053  s: int..    #: S
+00007910: 746f 7265 2074 696d 696e 6773 2066 6f72  tore timings for
+00007920: 2065 6163 6820 7072 6566 6978 2d61 6374   each prefix-act
+00007930: 696f 6e0a 2020 2020 616c 6c5f 6475 7261  ion.    all_dura
+00007940: 7469 6f6e 733a 2064 6566 6175 6c74 6469  tions: defaultdi
+00007950: 6374 5b73 7472 2c20 666c 6f61 745d 0a0a  ct[str, float]..
+00007960: 2020 2020 233a 2054 6869 7320 6d65 6173      #: This meas
+00007970: 7572 6573 2074 6865 206d 6178 696d 756d  ures the maximum
+00007980: 2072 6563 6f72 6465 6420 6c69 7665 2065   recorded live e
+00007990: 7865 6375 7469 6f6e 2074 696d 6520 616e  xecution time an
+000079a0: 6420 6361 6e20 6265 2075 7365 6420 746f  d can be used to
+000079b0: 0a20 2020 2023 3a20 6465 7465 6374 206f  .    #: detect o
+000079c0: 7574 6c69 6572 730a 2020 2020 6d61 785f  utliers.    max_
+000079d0: 6578 6563 5f74 696d 653a 2066 6c6f 6174  exec_time: float
+000079e0: 0a0a 2020 2020 233a 2054 6173 6b20 6772  ..    #: Task gr
+000079f0: 6f75 7073 2061 7373 6f63 6961 7465 6420  oups associated 
+00007a00: 746f 2074 6869 7320 7072 6566 6978 0a20  to this prefix. 
+00007a10: 2020 2067 726f 7570 733a 206c 6973 745b     groups: list[
+00007a20: 5461 736b 4772 6f75 705d 0a0a 2020 2020  TaskGroup]..    
+00007a30: 233a 2041 6363 756d 756c 6174 6520 636f  #: Accumulate co
+00007a40: 756e 7420 6f66 206e 756d 6265 7220 6f66  unt of number of
+00007a50: 2074 6173 6b73 2069 6e20 6561 6368 2073   tasks in each s
+00007a60: 7461 7465 0a20 2020 2073 7461 7465 5f63  tate.    state_c
+00007a70: 6f75 6e74 733a 2064 6566 6175 6c74 6469  ounts: defaultdi
+00007a80: 6374 5b54 6173 6b53 7461 7465 5374 6174  ct[TaskStateStat
+00007a90: 652c 2069 6e74 5d0a 0a20 2020 205f 5f73  e, int]..    __s
+00007aa0: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
+00007ab0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
+00007ac0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00007ad0: 5f28 7365 6c66 2c20 6e61 6d65 3a20 7374  _(self, name: st
+00007ae0: 7229 3a0a 2020 2020 2020 2020 7365 6c66  r):.        self
+00007af0: 2e6e 616d 6520 3d20 6e61 6d65 0a20 2020  .name = name.   
+00007b00: 2020 2020 2073 656c 662e 6772 6f75 7073       self.groups
+00007b10: 203d 205b 5d0a 2020 2020 2020 2020 7365   = [].        se
+00007b20: 6c66 2e61 6c6c 5f64 7572 6174 696f 6e73  lf.all_durations
+00007b30: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
+00007b40: 6c6f 6174 290a 2020 2020 2020 2020 7365  loat).        se
+00007b50: 6c66 2e73 7461 7465 5f63 6f75 6e74 7320  lf.state_counts 
+00007b60: 3d20 6465 6661 756c 7464 6963 7428 696e  = defaultdict(in
+00007b70: 7429 0a20 2020 2020 2020 2074 6173 6b5f  t).        task_
+00007b80: 6475 7261 7469 6f6e 7320 3d20 6461 736b  durations = dask
+00007b90: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
+00007ba0: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
+00007bb0: 6572 2e64 6566 6175 6c74 2d74 6173 6b2d  er.default-task-
+00007bc0: 6475 7261 7469 6f6e 7322 290a 2020 2020  durations").    
+00007bd0: 2020 2020 6966 2073 656c 662e 6e61 6d65      if self.name
+00007be0: 2069 6e20 7461 736b 5f64 7572 6174 696f   in task_duratio
+00007bf0: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00007c00: 7365 6c66 2e64 7572 6174 696f 6e5f 6176  self.duration_av
+00007c10: 6572 6167 6520 3d20 7061 7273 655f 7469  erage = parse_ti
+00007c20: 6d65 6465 6c74 6128 7461 736b 5f64 7572  medelta(task_dur
+00007c30: 6174 696f 6e73 5b73 656c 662e 6e61 6d65  ations[self.name
+00007c40: 5d29 0a20 2020 2020 2020 2065 6c73 653a  ]).        else:
+00007c50: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00007c60: 662e 6475 7261 7469 6f6e 5f61 7665 7261  f.duration_avera
+00007c70: 6765 203d 202d 310a 2020 2020 2020 2020  ge = -1.        
+00007c80: 7365 6c66 2e6d 6178 5f65 7865 635f 7469  self.max_exec_ti
+00007c90: 6d65 203d 202d 310a 2020 2020 2020 2020  me = -1.        
+00007ca0: 7365 6c66 2e73 7573 7069 6369 6f75 7320  self.suspicious 
+00007cb0: 3d20 300a 0a20 2020 2064 6566 2061 6464  = 0..    def add
+00007cc0: 5f65 7865 635f 7469 6d65 2873 656c 662c  _exec_time(self,
+00007cd0: 2064 7572 6174 696f 6e3a 2066 6c6f 6174   duration: float
+00007ce0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00007cf0: 2020 2073 656c 662e 6d61 785f 6578 6563     self.max_exec
+00007d00: 5f74 696d 6520 3d20 6d61 7828 6475 7261  _time = max(dura
+00007d10: 7469 6f6e 2c20 7365 6c66 2e6d 6178 5f65  tion, self.max_e
+00007d20: 7865 635f 7469 6d65 290a 2020 2020 2020  xec_time).      
+00007d30: 2020 6966 2064 7572 6174 696f 6e20 3e20    if duration > 
+00007d40: 3220 2a20 7365 6c66 2e64 7572 6174 696f  2 * self.duratio
+00007d50: 6e5f 6176 6572 6167 653a 0a20 2020 2020  n_average:.     
+00007d60: 2020 2020 2020 2073 656c 662e 6475 7261         self.dura
+00007d70: 7469 6f6e 5f61 7665 7261 6765 203d 202d  tion_average = -
+00007d80: 310a 0a20 2020 2064 6566 2061 6464 5f64  1..    def add_d
+00007d90: 7572 6174 696f 6e28 7365 6c66 2c20 6163  uration(self, ac
+00007da0: 7469 6f6e 3a20 7374 722c 2073 7461 7274  tion: str, start
+00007db0: 3a20 666c 6f61 742c 2073 746f 703a 2066  : float, stop: f
+00007dc0: 6c6f 6174 2920 2d3e 204e 6f6e 653a 0a20  loat) -> None:. 
+00007dd0: 2020 2020 2020 2064 7572 6174 696f 6e20         duration 
+00007de0: 3d20 7374 6f70 202d 2073 7461 7274 0a20  = stop - start. 
+00007df0: 2020 2020 2020 2073 656c 662e 616c 6c5f         self.all_
+00007e00: 6475 7261 7469 6f6e 735b 6163 7469 6f6e  durations[action
+00007e10: 5d20 2b3d 2064 7572 6174 696f 6e0a 2020  ] += duration.  
+00007e20: 2020 2020 2020 6966 2061 6374 696f 6e20        if action 
+00007e30: 3d3d 2022 636f 6d70 7574 6522 3a0a 2020  == "compute":.  
+00007e40: 2020 2020 2020 2020 2020 6f6c 6420 3d20            old = 
+00007e50: 7365 6c66 2e64 7572 6174 696f 6e5f 6176  self.duration_av
+00007e60: 6572 6167 650a 2020 2020 2020 2020 2020  erage.          
+00007e70: 2020 6966 206f 6c64 203c 2030 3a0a 2020    if old < 0:.  
+00007e80: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00007e90: 6c66 2e64 7572 6174 696f 6e5f 6176 6572  lf.duration_aver
+00007ea0: 6167 6520 3d20 6475 7261 7469 6f6e 0a20  age = duration. 
+00007eb0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00007ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007ed0: 2073 656c 662e 6475 7261 7469 6f6e 5f61   self.duration_a
+00007ee0: 7665 7261 6765 203d 2030 2e35 202a 2064  verage = 0.5 * d
+00007ef0: 7572 6174 696f 6e20 2b20 302e 3520 2a20  uration + 0.5 * 
+00007f00: 6f6c 640a 0a20 2020 2040 7072 6f70 6572  old..    @proper
+00007f10: 7479 0a20 2020 2064 6566 2073 7461 7465  ty.    def state
+00007f20: 7328 7365 6c66 2920 2d3e 2064 6963 745b  s(self) -> dict[
+00007f30: 5461 736b 5374 6174 6553 7461 7465 2c20  TaskStateState, 
+00007f40: 696e 745d 3a0a 2020 2020 2020 2020 2222  int]:.        ""
+00007f50: 2254 6865 206e 756d 6265 7220 6f66 2074  "The number of t
+00007f60: 6173 6b73 2069 6e20 6561 6368 2073 7461  asks in each sta
+00007f70: 7465 2c0a 2020 2020 2020 2020 6c69 6b65  te,.        like
+00007f80: 2060 607b 226d 656d 6f72 7922 3a20 3130   ``{"memory": 10
+00007f90: 2c20 2270 726f 6365 7373 696e 6722 3a20  , "processing": 
+00007fa0: 332c 2022 7265 6c65 6173 6564 223a 2034  3, "released": 4
+00007fb0: 2c20 2e2e 2e7d 6060 0a20 2020 2020 2020  , ...}``.       
+00007fc0: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
+00007fd0: 7572 6e20 6d65 7267 655f 7769 7468 2873  urn merge_with(s
+00007fe0: 756d 2c20 5b74 672e 7374 6174 6573 2066  um, [tg.states f
+00007ff0: 6f72 2074 6720 696e 2073 656c 662e 6772  or tg in self.gr
+00008000: 6f75 7073 5d29 0a0a 2020 2020 4070 726f  oups])..    @pro
+00008010: 7065 7274 790a 2020 2020 6465 6620 6163  perty.    def ac
+00008020: 7469 7665 2873 656c 6629 202d 3e20 6c69  tive(self) -> li
+00008030: 7374 5b54 6173 6b47 726f 7570 5d3a 0a20  st[TaskGroup]:. 
+00008040: 2020 2020 2020 2072 6574 7572 6e20 5b0a         return [.
+00008050: 2020 2020 2020 2020 2020 2020 7467 0a20              tg. 
+00008060: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+00008070: 6720 696e 2073 656c 662e 6772 6f75 7073  g in self.groups
+00008080: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00008090: 616e 7928 6b20 213d 2022 666f 7267 6f74  any(k != "forgot
+000080a0: 7465 6e22 2061 6e64 2076 2021 3d20 3020  ten" and v != 0 
+000080b0: 666f 7220 6b2c 2076 2069 6e20 7467 2e73  for k, v in tg.s
+000080c0: 7461 7465 732e 6974 656d 7328 2929 0a20  tates.items()). 
+000080d0: 2020 2020 2020 205d 0a0a 2020 2020 4070         ]..    @p
+000080e0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+000080f0: 6163 7469 7665 5f73 7461 7465 7328 7365  active_states(se
+00008100: 6c66 2920 2d3e 2064 6963 745b 5461 736b  lf) -> dict[Task
+00008110: 5374 6174 6553 7461 7465 2c20 696e 745d  StateState, int]
+00008120: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00008130: 206d 6572 6765 5f77 6974 6828 7375 6d2c   merge_with(sum,
+00008140: 205b 7467 2e73 7461 7465 7320 666f 7220   [tg.states for 
+00008150: 7467 2069 6e20 7365 6c66 2e61 6374 6976  tg in self.activ
+00008160: 655d 290a 0a20 2020 2064 6566 205f 5f72  e])..    def __r
+00008170: 6570 725f 5f28 7365 6c66 2920 2d3e 2073  epr__(self) -> s
+00008180: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
+00008190: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
+000081a0: 2022 3c22 0a20 2020 2020 2020 2020 2020   "<".           
+000081b0: 202b 2073 656c 662e 6e61 6d65 0a20 2020   + self.name.   
+000081c0: 2020 2020 2020 2020 202b 2022 3a20 220a           + ": ".
+000081d0: 2020 2020 2020 2020 2020 2020 2b20 222c              + ",
+000081e0: 2022 2e6a 6f69 6e28 0a20 2020 2020 2020   ".join(.       
+000081f0: 2020 2020 2020 2020 2022 2573 3a20 2564           "%s: %d
+00008200: 2220 2520 286b 2c20 7629 2066 6f72 2028  " % (k, v) for (
+00008210: 6b2c 2076 2920 696e 2073 6f72 7465 6428  k, v) in sorted(
+00008220: 7365 6c66 2e73 7461 7465 732e 6974 656d  self.states.item
+00008230: 7328 2929 2069 6620 760a 2020 2020 2020  s()) if v.      
+00008240: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00008250: 2020 2020 2b20 223e 220a 2020 2020 2020      + ">".      
+00008260: 2020 290a 0a20 2020 2040 7072 6f70 6572    )..    @proper
+00008270: 7479 0a20 2020 2064 6566 206e 6279 7465  ty.    def nbyte
+00008280: 735f 746f 7461 6c28 7365 6c66 2920 2d3e  s_total(self) ->
+00008290: 2069 6e74 3a0a 2020 2020 2020 2020 7265   int:.        re
+000082a0: 7475 726e 2073 756d 2874 672e 6e62 7974  turn sum(tg.nbyt
+000082b0: 6573 5f74 6f74 616c 2066 6f72 2074 6720  es_total for tg 
+000082c0: 696e 2073 656c 662e 6772 6f75 7073 290a  in self.groups).
+000082d0: 0a20 2020 2064 6566 205f 5f6c 656e 5f5f  .    def __len__
+000082e0: 2873 656c 6629 202d 3e20 696e 743a 0a20  (self) -> int:. 
+000082f0: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
+00008300: 6d28 6d61 7028 6c65 6e2c 2073 656c 662e  m(map(len, self.
+00008310: 6772 6f75 7073 2929 0a0a 2020 2020 4070  groups))..    @p
+00008320: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00008330: 6475 7261 7469 6f6e 2873 656c 6629 202d  duration(self) -
+00008340: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
+00008350: 2072 6574 7572 6e20 7375 6d28 7467 2e64   return sum(tg.d
+00008360: 7572 6174 696f 6e20 666f 7220 7467 2069  uration for tg i
+00008370: 6e20 7365 6c66 2e67 726f 7570 7329 0a0a  n self.groups)..
+00008380: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
+00008390: 2020 6465 6620 7479 7065 7328 7365 6c66    def types(self
+000083a0: 2920 2d3e 2073 6574 5b73 7472 5d3a 0a20  ) -> set[str]:. 
+000083b0: 2020 2020 2020 2072 6574 7572 6e20 7b74         return {t
+000083c0: 7970 2066 6f72 2074 6720 696e 2073 656c  yp for tg in sel
+000083d0: 662e 6772 6f75 7073 2066 6f72 2074 7970  f.groups for typ
+000083e0: 2069 6e20 7467 2e74 7970 6573 7d0a 0a0a   in tg.types}...
+000083f0: 636c 6173 7320 5461 736b 4772 6f75 703a  class TaskGroup:
+00008400: 0a20 2020 2022 2222 436f 6c6c 6563 7469  .    """Collecti
+00008410: 6f6e 2074 7261 636b 696e 6720 616c 6c20  on tracking all 
+00008420: 7461 736b 7320 7769 7468 696e 2061 2067  tasks within a g
+00008430: 726f 7570 0a0a 2020 2020 4b65 7973 206f  roup..    Keys o
+00008440: 6674 656e 2068 6176 6520 6120 7374 7275  ften have a stru
+00008450: 6374 7572 6520 6c69 6b65 2060 6028 2278  cture like ``("x
+00008460: 2d31 3233 222c 2030 2960 600a 2020 2020  -123", 0)``.    
+00008470: 4120 6772 6f75 7020 7461 6b65 7320 7468  A group takes th
+00008480: 6520 6669 7273 7420 7365 6374 696f 6e2c  e first section,
+00008490: 206c 696b 6520 6060 2278 2d31 3233 2260   like ``"x-123"`
+000084a0: 600a 0a20 2020 2053 6565 2061 6c73 6f0a  `..    See also.
+000084b0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+000084c0: 2054 6173 6b50 7265 6669 780a 2020 2020   TaskPrefix.    
+000084d0: 2222 220a 0a20 2020 2023 3a20 5468 6520  """..    #: The 
+000084e0: 6e61 6d65 206f 6620 6120 6772 6f75 7020  name of a group 
+000084f0: 6f66 2074 6173 6b73 2e0a 2020 2020 233a  of tasks..    #:
+00008500: 2046 6f72 2061 2074 6173 6b20 6c69 6b65   For a task like
+00008510: 2060 6028 2278 2d31 3233 222c 2030 2960   ``("x-123", 0)`
+00008520: 6020 7468 6973 2069 7320 7468 6520 7465  ` this is the te
+00008530: 7874 2060 6022 782d 3132 3322 6060 0a20  xt ``"x-123"``. 
+00008540: 2020 206e 616d 653a 2073 7472 0a0a 2020     name: str..  
+00008550: 2020 233a 2054 6865 206e 756d 6265 7220    #: The number 
+00008560: 6f66 2074 6173 6b73 2069 6e20 6561 6368  of tasks in each
+00008570: 2073 7461 7465 2c0a 2020 2020 233a 206c   state,.    #: l
+00008580: 696b 6520 6060 7b22 6d65 6d6f 7279 223a  ike ``{"memory":
+00008590: 2031 302c 2022 7072 6f63 6573 7369 6e67   10, "processing
+000085a0: 223a 2033 2c20 2272 656c 6561 7365 6422  ": 3, "released"
+000085b0: 3a20 342c 202e 2e2e 7d60 600a 2020 2020  : 4, ...}``.    
+000085c0: 7374 6174 6573 3a20 6469 6374 5b54 6173  states: dict[Tas
+000085d0: 6b53 7461 7465 5374 6174 652c 2069 6e74  kStateState, int
+000085e0: 5d0a 0a20 2020 2023 3a20 5468 6520 6f74  ]..    #: The ot
+000085f0: 6865 7220 5461 736b 4772 6f75 7073 206f  her TaskGroups o
+00008600: 6e20 7768 6963 6820 7468 6973 206f 6e65  n which this one
+00008610: 2064 6570 656e 6473 0a20 2020 2064 6570   depends.    dep
+00008620: 656e 6465 6e63 6965 733a 2073 6574 5b54  endencies: set[T
+00008630: 6173 6b47 726f 7570 5d0a 0a20 2020 2023  askGroup]..    #
+00008640: 3a20 5468 6520 746f 7461 6c20 6e75 6d62  : The total numb
+00008650: 6572 206f 6620 6279 7465 7320 7468 6174  er of bytes that
+00008660: 2074 6869 7320 7461 736b 2067 726f 7570   this task group
+00008670: 2068 6173 2070 726f 6475 6365 640a 2020   has produced.  
+00008680: 2020 6e62 7974 6573 5f74 6f74 616c 3a20    nbytes_total: 
+00008690: 696e 740a 0a20 2020 2023 3a20 5468 6520  int..    #: The 
+000086a0: 746f 7461 6c20 616d 6f75 6e74 206f 6620  total amount of 
+000086b0: 7469 6d65 2073 7065 6e74 206f 6e20 616c  time spent on al
+000086c0: 6c20 7461 736b 7320 696e 2074 6869 7320  l tasks in this 
+000086d0: 5461 736b 4772 6f75 700a 2020 2020 6475  TaskGroup.    du
+000086e0: 7261 7469 6f6e 3a20 666c 6f61 740a 0a20  ration: float.. 
+000086f0: 2020 2023 3a20 5468 6520 7265 7375 6c74     #: The result
+00008700: 2074 7970 6573 206f 6620 7468 6973 2054   types of this T
+00008710: 6173 6b47 726f 7570 0a20 2020 2074 7970  askGroup.    typ
+00008720: 6573 3a20 7365 745b 7374 725d 0a0a 2020  es: set[str]..  
+00008730: 2020 233a 2054 6865 2077 6f72 6b65 7220    #: The worker 
+00008740: 6d6f 7374 2072 6563 656e 746c 7920 6173  most recently as
+00008750: 7369 676e 6564 2061 2074 6173 6b20 6672  signed a task fr
+00008760: 6f6d 2074 6869 7320 6772 6f75 702c 206f  om this group, o
+00008770: 7220 4e6f 6e65 2077 6865 6e20 7468 6520  r None when the 
+00008780: 6772 6f75 700a 2020 2020 233a 2069 7320  group.    #: is 
+00008790: 6e6f 7420 6964 656e 7469 6669 6564 2074  not identified t
+000087a0: 6f20 6265 2072 6f6f 742d 6c69 6b65 2062  o be root-like b
+000087b0: 7920 6053 6368 6564 756c 6572 5374 6174  y `SchedulerStat
+000087c0: 652e 6465 6369 6465 5f77 6f72 6b65 7260  e.decide_worker`
+000087d0: 2e0a 2020 2020 6c61 7374 5f77 6f72 6b65  ..    last_worke
+000087e0: 723a 2057 6f72 6b65 7253 7461 7465 207c  r: WorkerState |
+000087f0: 204e 6f6e 650a 0a20 2020 2023 3a20 4966   None..    #: If
+00008800: 2060 6c61 7374 5f77 6f72 6b65 7260 2069   `last_worker` i
+00008810: 7320 6e6f 7420 4e6f 6e65 2c20 7468 6520  s not None, the 
+00008820: 6e75 6d62 6572 206f 6620 7469 6d65 7320  number of times 
+00008830: 7468 6174 2077 6f72 6b65 7220 7368 6f75  that worker shou
+00008840: 6c64 2062 6520 6173 7369 676e 6564 0a20  ld be assigned. 
+00008850: 2020 2023 3a20 7375 6273 6571 7565 6e74     #: subsequent
+00008860: 2074 6173 6b73 2075 6e74 696c 2061 206e   tasks until a n
+00008870: 6577 2077 6f72 6b65 7220 6973 2063 686f  ew worker is cho
+00008880: 7365 6e2e 0a20 2020 206c 6173 745f 776f  sen..    last_wo
+00008890: 726b 6572 5f74 6173 6b73 5f6c 6566 743a  rker_tasks_left:
+000088a0: 2069 6e74 0a0a 2020 2020 7072 6566 6978   int..    prefix
+000088b0: 3a20 5461 736b 5072 6566 6978 207c 204e  : TaskPrefix | N
+000088c0: 6f6e 650a 0a20 2020 2023 3a20 4561 726c  one..    #: Earl
+000088d0: 6965 7374 2074 696d 6520 7768 656e 2061  iest time when a
+000088e0: 2074 6173 6b20 6265 6c6f 6e67 696e 6720   task belonging 
+000088f0: 746f 2074 6869 7320 6772 6f75 7020 7374  to this group st
+00008900: 6172 7465 6420 636f 6d70 7574 696e 673b  arted computing;
+00008910: 0a20 2020 2023 3a20 3020 6966 206e 6f20  .    #: 0 if no 
+00008920: 7461 736b 2068 6173 202a 6669 6e69 7368  task has *finish
+00008930: 6564 2a20 636f 6d70 7574 696e 6720 7965  ed* computing ye
+00008940: 740a 2020 2020 233a 0a20 2020 2023 3a20  t.    #:.    #: 
+00008950: 4e6f 7465 730a 2020 2020 233a 202d 2d2d  Notes.    #: ---
+00008960: 2d2d 0a20 2020 2023 3a20 5468 6973 2069  --.    #: This i
+00008970: 7320 6e6f 7420 7570 6461 7465 6420 756e  s not updated un
+00008980: 7469 6c20 6174 206c 6561 7374 206f 6e65  til at least one
+00008990: 2074 6173 6b20 6861 7320 2a66 696e 6973   task has *finis
+000089a0: 6865 642a 2063 6f6d 7075 7469 6e67 2e0a  hed* computing..
+000089b0: 2020 2020 233a 2049 7420 636f 756c 6420      #: It could 
+000089c0: 6d6f 7665 2062 6163 6b77 6172 6473 2061  move backwards a
+000089d0: 7320 7461 736b 7320 636f 6d70 6c65 7465  s tasks complete
+000089e0: 2e0a 2020 2020 7374 6172 743a 2066 6c6f  ..    start: flo
+000089f0: 6174 0a0a 2020 2020 233a 204c 6174 6573  at..    #: Lates
+00008a00: 7420 7469 6d65 2077 6865 6e20 6120 7461  t time when a ta
+00008a10: 736b 2062 656c 6f6e 6769 6e67 2074 6f20  sk belonging to 
+00008a20: 7468 6973 2067 726f 7570 2066 696e 6973  this group finis
+00008a30: 6865 6420 636f 6d70 7574 696e 672c 0a20  hed computing,. 
+00008a40: 2020 2023 3a20 3020 6966 206e 6f20 7461     #: 0 if no ta
+00008a50: 736b 2068 6173 2066 696e 6973 6865 6420  sk has finished 
+00008a60: 636f 6d70 7574 696e 6720 7965 740a 2020  computing yet.  
+00008a70: 2020 7374 6f70 3a20 666c 6f61 740a 0a20    stop: float.. 
+00008a80: 2020 2023 3a20 4375 6d75 6c61 7469 7665     #: Cumulative
+00008a90: 2064 7572 6174 696f 6e20 6f66 2061 6c6c   duration of all
+00008aa0: 2063 6f6d 706c 6574 6564 2061 6374 696f   completed actio
+00008ab0: 6e73 2c20 6279 2061 6374 696f 6e0a 2020  ns, by action.  
+00008ac0: 2020 616c 6c5f 6475 7261 7469 6f6e 733a    all_durations:
+00008ad0: 2064 6566 6175 6c74 6469 6374 5b73 7472   defaultdict[str
+00008ae0: 2c20 666c 6f61 745d 0a0a 2020 2020 233a  , float]..    #:
+00008af0: 2053 7061 6e20 4944 2028 7365 6520 6060   Span ID (see ``
+00008b00: 6469 7374 7269 6275 7465 642e 7370 616e  distributed.span
+00008b10: 7360 6029 2e0a 2020 2020 233a 204d 6174  s``)..    #: Mat
+00008b20: 6368 6573 2060 6064 6973 7472 6962 7574  ches ``distribut
+00008b30: 6564 2e77 6f72 6b65 725f 7374 6174 655f  ed.worker_state_
+00008b40: 6d61 6368 696e 652e 5461 736b 5374 6174  machine.TaskStat
+00008b50: 652e 7370 616e 5f69 6460 602e 0a20 2020  e.span_id``..   
+00008b60: 2023 3a20 4974 2069 7320 706f 7373 6962   #: It is possib
+00008b70: 6c65 2074 6f20 656e 6420 7570 2069 6e20  le to end up in 
+00008b80: 7369 7475 6174 696f 6e20 7768 6572 6520  situation where 
+00008b90: 6469 6666 6572 656e 7420 7461 736b 7320  different tasks 
+00008ba0: 6f66 2074 6865 2073 616d 6520 5461 736b  of the same Task
+00008bb0: 4772 6f75 700a 2020 2020 233a 2062 656c  Group.    #: bel
+00008bc0: 6f6e 6720 746f 2064 6966 6665 7265 6e74  ong to different
+00008bd0: 2073 7061 6e73 3b20 7468 6520 7075 7270   spans; the purp
+00008be0: 6f73 6520 6f66 2074 6869 7320 6174 7472  ose of this attr
+00008bf0: 6962 7574 6520 6973 2074 6f20 6172 6269  ibute is to arbi
+00008c00: 7472 6172 696c 7920 666f 7263 650a 2020  trarily force.  
+00008c10: 2020 233a 2065 7665 7279 7468 696e 6720    #: everything 
+00008c20: 6f6e 746f 2074 6865 2065 6172 6c69 6573  onto the earlies
+00008c30: 7420 656e 636f 756e 7465 7265 6420 6f6e  t encountered on
+00008c40: 652e 0a20 2020 2073 7061 6e5f 6964 3a20  e..    span_id: 
+00008c50: 7374 7220 7c20 4e6f 6e65 0a0a 2020 2020  str | None..    
+00008c60: 5f5f 736c 6f74 735f 5f20 3d20 7475 706c  __slots__ = tupl
+00008c70: 6528 5f5f 616e 6e6f 7461 7469 6f6e 735f  e(__annotations_
+00008c80: 5f29 0a0a 2020 2020 6465 6620 5f5f 696e  _)..    def __in
+00008c90: 6974 5f5f 2873 656c 662c 206e 616d 653a  it__(self, name:
+00008ca0: 2073 7472 293a 0a20 2020 2020 2020 2073   str):.        s
+00008cb0: 656c 662e 6e61 6d65 203d 206e 616d 650a  elf.name = name.
+00008cc0: 2020 2020 2020 2020 7365 6c66 2e70 7265          self.pre
+00008cd0: 6669 7820 3d20 4e6f 6e65 0a20 2020 2020  fix = None.     
+00008ce0: 2020 2073 656c 662e 7374 6174 6573 203d     self.states =
+00008cf0: 2064 6963 742e 6672 6f6d 6b65 7973 2841   dict.fromkeys(A
+00008d00: 4c4c 5f54 4153 4b5f 5354 4154 4553 2c20  LL_TASK_STATES, 
+00008d10: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+00008d20: 6465 7065 6e64 656e 6369 6573 203d 2073  dependencies = s
+00008d30: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+00008d40: 662e 6e62 7974 6573 5f74 6f74 616c 203d  f.nbytes_total =
+00008d50: 2030 0a20 2020 2020 2020 2073 656c 662e   0.        self.
+00008d60: 6475 7261 7469 6f6e 203d 2030 0a20 2020  duration = 0.   
+00008d70: 2020 2020 2073 656c 662e 7479 7065 7320       self.types 
+00008d80: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
+00008d90: 7365 6c66 2e73 7461 7274 203d 2030 2e30  self.start = 0.0
+00008da0: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+00008db0: 6f70 203d 2030 2e30 0a20 2020 2020 2020  op = 0.0.       
+00008dc0: 2073 656c 662e 616c 6c5f 6475 7261 7469   self.all_durati
+00008dd0: 6f6e 7320 3d20 6465 6661 756c 7464 6963  ons = defaultdic
+00008de0: 7428 666c 6f61 7429 0a20 2020 2020 2020  t(float).       
+00008df0: 2073 656c 662e 6c61 7374 5f77 6f72 6b65   self.last_worke
+00008e00: 7220 3d20 4e6f 6e65 0a20 2020 2020 2020  r = None.       
+00008e10: 2073 656c 662e 6c61 7374 5f77 6f72 6b65   self.last_worke
+00008e20: 725f 7461 736b 735f 6c65 6674 203d 2030  r_tasks_left = 0
+00008e30: 0a20 2020 2020 2020 2073 656c 662e 7370  .        self.sp
+00008e40: 616e 5f69 6420 3d20 4e6f 6e65 0a0a 2020  an_id = None..  
+00008e50: 2020 6465 6620 6164 645f 6475 7261 7469    def add_durati
+00008e60: 6f6e 2873 656c 662c 2061 6374 696f 6e3a  on(self, action:
+00008e70: 2073 7472 2c20 7374 6172 743a 2066 6c6f   str, start: flo
+00008e80: 6174 2c20 7374 6f70 3a20 666c 6f61 7429  at, stop: float)
+00008e90: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00008ea0: 2020 6475 7261 7469 6f6e 203d 2073 746f    duration = sto
+00008eb0: 7020 2d20 7374 6172 740a 2020 2020 2020  p - start.      
+00008ec0: 2020 7365 6c66 2e64 7572 6174 696f 6e20    self.duration 
+00008ed0: 2b3d 2064 7572 6174 696f 6e0a 2020 2020  += duration.    
+00008ee0: 2020 2020 7365 6c66 2e61 6c6c 5f64 7572      self.all_dur
+00008ef0: 6174 696f 6e73 5b61 6374 696f 6e5d 202b  ations[action] +
+00008f00: 3d20 6475 7261 7469 6f6e 0a20 2020 2020  = duration.     
+00008f10: 2020 2069 6620 6163 7469 6f6e 203d 3d20     if action == 
+00008f20: 2263 6f6d 7075 7465 223a 0a20 2020 2020  "compute":.     
+00008f30: 2020 2020 2020 2069 6620 7365 6c66 2e73         if self.s
+00008f40: 746f 7020 3c20 7374 6f70 3a0a 2020 2020  top < stop:.    
+00008f50: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00008f60: 2e73 746f 7020 3d20 7374 6f70 0a20 2020  .stop = stop.   
+00008f70: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00008f80: 2e73 7461 7274 203d 3d20 302e 3020 6f72  .start == 0.0 or
+00008f90: 2073 656c 662e 7374 6172 7420 3e20 7374   self.start > st
+00008fa0: 6172 743a 0a20 2020 2020 2020 2020 2020  art:.           
+00008fb0: 2020 2020 2073 656c 662e 7374 6172 7420       self.start 
+00008fc0: 3d20 7374 6172 740a 2020 2020 2020 2020  = start.        
+00008fd0: 6173 7365 7274 2073 656c 662e 7072 6566  assert self.pref
+00008fe0: 6978 2069 7320 6e6f 7420 4e6f 6e65 0a20  ix is not None. 
+00008ff0: 2020 2020 2020 2073 656c 662e 7072 6566         self.pref
+00009000: 6978 2e61 6464 5f64 7572 6174 696f 6e28  ix.add_duration(
+00009010: 6163 7469 6f6e 2c20 7374 6172 742c 2073  action, start, s
+00009020: 746f 7029 0a0a 2020 2020 6465 6620 6164  top)..    def ad
+00009030: 6428 7365 6c66 2c20 6f74 6865 723a 2054  d(self, other: T
+00009040: 6173 6b53 7461 7465 2920 2d3e 204e 6f6e  askState) -> Non
+00009050: 653a 0a20 2020 2020 2020 2073 656c 662e  e:.        self.
+00009060: 7374 6174 6573 5b6f 7468 6572 2e73 7461  states[other.sta
+00009070: 7465 5d20 2b3d 2031 0a20 2020 2020 2020  te] += 1.       
+00009080: 206f 7468 6572 2e67 726f 7570 203d 2073   other.group = s
+00009090: 656c 660a 0a20 2020 2064 6566 205f 5f72  elf..    def __r
+000090a0: 6570 725f 5f28 7365 6c66 2920 2d3e 2073  epr__(self) -> s
+000090b0: 7472 3a0a 2020 2020 2020 2020 7265 7475  tr:.        retu
+000090c0: 726e 2028 0a20 2020 2020 2020 2020 2020  rn (.           
+000090d0: 2022 3c22 0a20 2020 2020 2020 2020 2020   "<".           
+000090e0: 202b 2028 7365 6c66 2e6e 616d 6520 6f72   + (self.name or
+000090f0: 2022 6e6f 2d67 726f 7570 2229 0a20 2020   "no-group").   
+00009100: 2020 2020 2020 2020 202b 2022 3a20 220a           + ": ".
+00009110: 2020 2020 2020 2020 2020 2020 2b20 222c              + ",
+00009120: 2022 2e6a 6f69 6e28 0a20 2020 2020 2020   ".join(.       
+00009130: 2020 2020 2020 2020 2022 2573 3a20 2564           "%s: %d
+00009140: 2220 2520 286b 2c20 7629 2066 6f72 2028  " % (k, v) for (
+00009150: 6b2c 2076 2920 696e 2073 6f72 7465 6428  k, v) in sorted(
+00009160: 7365 6c66 2e73 7461 7465 732e 6974 656d  self.states.item
+00009170: 7328 2929 2069 6620 760a 2020 2020 2020  s()) if v.      
+00009180: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00009190: 2020 2020 2b20 223e 220a 2020 2020 2020      + ">".      
+000091a0: 2020 290a 0a20 2020 2064 6566 205f 5f6c    )..    def __l
+000091b0: 656e 5f5f 2873 656c 6629 202d 3e20 696e  en__(self) -> in
+000091c0: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
+000091d0: 6e20 7375 6d28 7365 6c66 2e73 7461 7465  n sum(self.state
+000091e0: 732e 7661 6c75 6573 2829 290a 0a20 2020  s.values())..   
+000091f0: 2064 6566 205f 746f 5f64 6963 745f 6e6f   def _to_dict_no
+00009200: 5f6e 6573 7428 7365 6c66 2c20 2a2c 2065  _nest(self, *, e
+00009210: 7863 6c75 6465 3a20 436f 6e74 6169 6e65  xclude: Containe
+00009220: 725b 7374 725d 203d 2028 2929 202d 3e20  r[str] = ()) -> 
+00009230: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
+00009240: 2020 2020 2020 2020 2222 2244 6963 7469          """Dicti
+00009250: 6f6e 6172 7920 7265 7072 6573 656e 7461  onary representa
+00009260: 7469 6f6e 2066 6f72 2064 6562 7567 6769  tion for debuggi
+00009270: 6e67 2070 7572 706f 7365 732e 0a20 2020  ng purposes..   
+00009280: 2020 2020 204e 6f74 2074 7970 6520 7374       Not type st
+00009290: 6162 6c65 2061 6e64 206e 6f74 2069 6e74  able and not int
+000092a0: 656e 6465 6420 666f 7220 726f 756e 6474  ended for roundt
+000092b0: 7269 7073 2e0a 0a20 2020 2020 2020 2053  rips...        S
+000092c0: 6565 2061 6c73 6f0a 2020 2020 2020 2020  ee also.        
+000092d0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+000092e0: 2043 6c69 656e 742e 6475 6d70 5f63 6c75   Client.dump_clu
+000092f0: 7374 6572 5f73 7461 7465 0a20 2020 2020  ster_state.     
+00009300: 2020 2064 6973 7472 6962 7574 6564 2e75     distributed.u
+00009310: 7469 6c73 2e72 6563 7572 7369 7665 5f74  tils.recursive_t
+00009320: 6f5f 6469 6374 0a20 2020 2020 2020 2054  o_dict.        T
+00009330: 6173 6b53 7461 7465 2e5f 746f 5f64 6963  askState._to_dic
+00009340: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
+00009350: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
+00009360: 7572 7369 7665 5f74 6f5f 6469 6374 2873  ursive_to_dict(s
+00009370: 656c 662c 2065 7863 6c75 6465 3d65 7863  elf, exclude=exc
+00009380: 6c75 6465 2c20 6d65 6d62 6572 733d 5472  lude, members=Tr
+00009390: 7565 290a 0a20 2020 2040 7072 6f70 6572  ue)..    @proper
+000093a0: 7479 0a20 2020 2064 6566 2064 6f6e 6528  ty.    def done(
+000093b0: 7365 6c66 2920 2d3e 2062 6f6f 6c3a 0a20  self) -> bool:. 
+000093c0: 2020 2020 2020 2022 2222 5265 7475 726e         """Return
+000093d0: 2054 7275 6520 6966 2061 6c6c 2063 6f6d   True if all com
+000093e0: 7075 7461 7469 6f6e 7320 666f 7220 7468  putations for th
+000093f0: 6973 2067 726f 7570 2068 6176 6520 636f  is group have co
+00009400: 6d70 6c65 7465 643b 2046 616c 7365 0a20  mpleted; False. 
+00009410: 2020 2020 2020 206f 7468 6572 7769 7365         otherwise
+00009420: 2e0a 0a20 2020 2020 2020 204e 6f74 6573  ...        Notes
+00009430: 0a20 2020 2020 2020 202d 2d2d 2d2d 0a20  .        -----. 
+00009440: 2020 2020 2020 2054 6869 7320 7072 6f70         This prop
+00009450: 6572 7479 206d 6179 2074 7261 6e73 6974  erty may transit
+00009460: 696f 6e20 6672 6f6d 2054 7275 6520 746f  ion from True to
+00009470: 2046 616c 7365 2c20 652e 672e 2077 6865   False, e.g. whe
+00009480: 6e20 6120 776f 726b 6572 2074 6861 740a  n a worker that.
+00009490: 2020 2020 2020 2020 636f 6e74 6169 6e65          containe
+000094a0: 6420 7468 6520 6f6e 6c79 2072 6570 6c69  d the only repli
+000094b0: 6361 206f 6620 6120 7461 736b 2069 6e20  ca of a task in 
+000094c0: 6d65 6d6f 7279 2063 7261 7368 6573 2061  memory crashes a
+000094d0: 6e64 2074 6865 2074 6173 6b20 6e65 6564  nd the task need
+000094e0: 2074 6f20 6265 0a20 2020 2020 2020 2072   to be.        r
+000094f0: 6563 6f6d 7075 7465 642e 0a20 2020 2020  ecomputed..     
+00009500: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+00009510: 6574 7572 6e20 616c 6c28 0a20 2020 2020  eturn all(.     
+00009520: 2020 2020 2020 2063 6f75 6e74 203d 3d20         count == 
+00009530: 3020 6f72 2073 7461 7465 2069 6e20 7b22  0 or state in {"
+00009540: 6d65 6d6f 7279 222c 2022 6572 7265 6422  memory", "erred"
+00009550: 2c20 2272 656c 6561 7365 6422 2c20 2266  , "released", "f
+00009560: 6f72 676f 7474 656e 227d 0a20 2020 2020  orgotten"}.     
+00009570: 2020 2020 2020 2066 6f72 2073 7461 7465         for state
+00009580: 2c20 636f 756e 7420 696e 2073 656c 662e  , count in self.
+00009590: 7374 6174 6573 2e69 7465 6d73 2829 0a20  states.items(). 
+000095a0: 2020 2020 2020 2029 0a0a 0a63 6c61 7373         )...class
+000095b0: 2054 6173 6b53 7461 7465 3a0a 2020 2020   TaskState:.    
+000095c0: 2222 2241 2073 696d 706c 6520 6f62 6a65  """A simple obje
+000095d0: 6374 2068 6f6c 6469 6e67 2069 6e66 6f72  ct holding infor
+000095e0: 6d61 7469 6f6e 2061 626f 7574 2061 2074  mation about a t
+000095f0: 6173 6b2e 0a0a 2020 2020 4e6f 7420 746f  ask...    Not to
+00009600: 2062 6520 636f 6e66 7573 6564 2077 6974   be confused wit
+00009610: 6820 3a63 6c61 7373 3a60 6469 7374 7269  h :class:`distri
+00009620: 6275 7465 642e 776f 726b 6572 5f73 7461  buted.worker_sta
+00009630: 7465 5f6d 6163 6869 6e65 2e54 6173 6b53  te_machine.TaskS
+00009640: 7461 7465 602c 2077 6869 6368 0a20 2020  tate`, which.   
+00009650: 2068 6f6c 6473 2073 696d 696c 6172 2069   holds similar i
+00009660: 6e66 6f72 6d61 7469 6f6e 206f 6e20 7468  nformation on th
+00009670: 6520 576f 726b 6572 2073 6964 652e 0a20  e Worker side.. 
+00009680: 2020 2022 2222 0a0a 2020 2020 233a 2054     """..    #: T
+00009690: 6865 206b 6579 2069 7320 7468 6520 756e  he key is the un
+000096a0: 6971 7565 2069 6465 6e74 6966 6965 7220  ique identifier 
+000096b0: 6f66 2061 2074 6173 6b2c 2067 656e 6572  of a task, gener
+000096c0: 616c 6c79 2066 6f72 6d65 6420 6672 6f6d  ally formed from
+000096d0: 2074 6865 206e 616d 6520 6f66 2074 6865   the name of the
+000096e0: 0a20 2020 2023 3a20 6675 6e63 7469 6f6e  .    #: function
+000096f0: 2c20 666f 6c6c 6f77 6564 2062 7920 6120  , followed by a 
+00009700: 6861 7368 206f 6620 7468 6520 6675 6e63  hash of the func
+00009710: 7469 6f6e 2061 6e64 2061 7267 756d 656e  tion and argumen
+00009720: 7473 2c20 6c69 6b65 0a20 2020 2023 3a20  ts, like.    #: 
+00009730: 6060 2769 6e63 2d61 6233 3163 3031 3034  ``'inc-ab31c0104
+00009740: 3434 3937 3730 3034 6436 3536 3631 3064  44977004d656610d
+00009750: 3264 3432 3165 6327 6060 2e0a 2020 2020  2d421ec'``..    
+00009760: 6b65 793a 204b 6579 0a0a 2020 2020 233a  key: Key..    #:
+00009770: 2054 6865 2062 726f 6164 2063 6c61 7373   The broad class
+00009780: 206f 6620 7461 736b 7320 746f 2077 6869   of tasks to whi
+00009790: 6368 2074 6869 7320 7461 736b 2062 656c  ch this task bel
+000097a0: 6f6e 6773 206c 696b 6520 2269 6e63 2220  ongs like "inc" 
+000097b0: 6f72 2022 7265 6164 5f63 7376 220a 2020  or "read_csv".  
+000097c0: 2020 7072 6566 6978 3a20 5461 736b 5072    prefix: TaskPr
+000097d0: 6566 6978 0a0a 2020 2020 233a 2041 2073  efix..    #: A s
+000097e0: 7065 6369 6669 6361 7469 6f6e 206f 6620  pecification of 
+000097f0: 686f 7720 746f 2072 756e 2074 6865 2074  how to run the t
+00009800: 6173 6b2e 2020 5468 6520 7479 7065 2061  ask.  The type a
+00009810: 6e64 206d 6561 6e69 6e67 206f 6620 7468  nd meaning of th
+00009820: 6973 2076 616c 7565 2069 730a 2020 2020  is value is.    
+00009830: 233a 206f 7061 7175 6520 746f 2074 6865  #: opaque to the
+00009840: 2073 6368 6564 756c 6572 2c20 6173 2069   scheduler, as i
+00009850: 7420 6973 206f 6e6c 7920 696e 7465 7270  t is only interp
+00009860: 7265 7465 6420 6279 2074 6865 2077 6f72  reted by the wor
+00009870: 6b65 7220 746f 2077 6869 6368 2074 6865  ker to which the
+00009880: 0a20 2020 2023 3a20 7461 736b 2069 7320  .    #: task is 
+00009890: 7365 6e74 2066 6f72 2065 7865 6375 7469  sent for executi
+000098a0: 6e67 2e0a 2020 2020 233a 0a20 2020 2023  ng..    #:.    #
+000098b0: 3a20 4173 2061 2073 7065 6369 616c 2063  : As a special c
+000098c0: 6173 652c 2074 6869 7320 6174 7472 6962  ase, this attrib
+000098d0: 7574 6520 6d61 7920 616c 736f 2062 6520  ute may also be 
+000098e0: 6060 4e6f 6e65 6060 2c20 696e 2077 6869  ``None``, in whi
+000098f0: 6368 2063 6173 6520 7468 6520 7461 736b  ch case the task
+00009900: 2069 730a 2020 2020 233a 2022 7075 7265   is.    #: "pure
+00009910: 2064 6174 6122 2028 7375 6368 2061 732c   data" (such as,
+00009920: 2066 6f72 2065 7861 6d70 6c65 2c20 6120   for example, a 
+00009930: 7069 6563 6520 6f66 2064 6174 6120 6c6f  piece of data lo
+00009940: 6164 6564 2069 6e20 7468 6520 7363 6865  aded in the sche
+00009950: 6475 6c65 7220 7573 696e 670a 2020 2020  duler using.    
+00009960: 233a 203a 6d65 7468 3a60 436c 6965 6e74  #: :meth:`Client
+00009970: 2e73 6361 7474 6572 6029 2e20 2041 2022  .scatter`).  A "
+00009980: 7075 7265 2064 6174 6122 2074 6173 6b20  pure data" task 
+00009990: 6361 6e6e 6f74 2062 6520 636f 6d70 7574  cannot be comput
+000099a0: 6564 2061 6761 696e 2069 6620 6974 730a  ed again if its.
+000099b0: 2020 2020 233a 2076 616c 7565 2069 7320      #: value is 
+000099c0: 6c6f 7374 2e0a 2020 2020 7275 6e5f 7370  lost..    run_sp
+000099d0: 6563 3a20 545f 7275 6e73 7065 6320 7c20  ec: T_runspec | 
+000099e0: 4e6f 6e65 0a0a 2020 2020 233a 2054 6865  None..    #: The
+000099f0: 2070 7269 6f72 6974 7920 7072 6f76 6964   priority provid
+00009a00: 6573 2065 6163 6820 7461 736b 2077 6974  es each task wit
+00009a10: 6820 6120 7265 6c61 7469 7665 2072 616e  h a relative ran
+00009a20: 6b69 6e67 2077 6869 6368 2069 7320 7573  king which is us
+00009a30: 6564 2074 6f20 6272 6561 6b0a 2020 2020  ed to break.    
+00009a40: 233a 2074 6965 7320 7768 656e 206d 616e  #: ties when man
+00009a50: 7920 7461 736b 7320 6172 6520 6265 696e  y tasks are bein
+00009a60: 6720 636f 6e73 6964 6572 6564 2066 6f72  g considered for
+00009a70: 2065 7865 6375 7469 6f6e 2e0a 2020 2020   execution..    
+00009a80: 233a 0a20 2020 2023 3a20 5468 6973 2072  #:.    #: This r
+00009a90: 616e 6b69 6e67 2069 7320 6765 6e65 7261  anking is genera
+00009aa0: 6c6c 7920 6120 322d 6974 656d 2074 7570  lly a 2-item tup
+00009ab0: 6c65 2e20 2054 6865 2066 6972 7374 2028  le.  The first (
+00009ac0: 616e 6420 646f 6d69 6e61 6e74 2920 6974  and dominant) it
+00009ad0: 656d 0a20 2020 2023 3a20 636f 7272 6573  em.    #: corres
+00009ae0: 706f 6e64 7320 746f 2077 6865 6e20 6974  ponds to when it
+00009af0: 2077 6173 2073 7562 6d69 7474 6564 2e20   was submitted. 
+00009b00: 2047 656e 6572 616c 6c79 2c20 6561 726c   Generally, earl
+00009b10: 6965 7220 7461 736b 7320 7461 6b65 2070  ier tasks take p
+00009b20: 7265 6365 6465 6e63 652e 0a20 2020 2023  recedence..    #
+00009b30: 3a20 5468 6520 7365 636f 6e64 2069 7465  : The second ite
+00009b40: 6d20 6973 2064 6574 6572 6d69 6e65 6420  m is determined 
+00009b50: 6279 2074 6865 2063 6c69 656e 742c 2061  by the client, a
+00009b60: 6e64 2069 7320 6120 7761 7920 746f 2070  nd is a way to p
+00009b70: 7269 6f72 6974 697a 6520 7461 736b 730a  rioritize tasks.
+00009b80: 2020 2020 233a 2077 6974 6869 6e20 6120      #: within a 
+00009b90: 6c61 7267 6520 6772 6170 6820 7468 6174  large graph that
+00009ba0: 206d 6179 2062 6520 696d 706f 7274 616e   may be importan
+00009bb0: 742c 2073 7563 6820 6173 2069 6620 7468  t, such as if th
+00009bc0: 6579 2061 7265 206f 6e20 7468 6520 6372  ey are on the cr
+00009bd0: 6974 6963 616c 0a20 2020 2023 3a20 7061  itical.    #: pa
+00009be0: 7468 2c20 6f72 2067 6f6f 6420 746f 2072  th, or good to r
+00009bf0: 756e 2069 6e20 6f72 6465 7220 746f 2072  un in order to r
+00009c00: 656c 6561 7365 206d 616e 7920 6465 7065  elease many depe
+00009c10: 6e64 656e 6369 6573 2e20 2054 6869 7320  ndencies.  This 
+00009c20: 6973 2065 7870 6c61 696e 6564 0a20 2020  is explained.   
+00009c30: 2023 3a20 6675 7274 6865 7220 696e 203a   #: further in :
+00009c40: 646f 633a 6053 6368 6564 756c 696e 6720  doc:`Scheduling 
+00009c50: 506f 6c69 6379 203c 7363 6865 6475 6c69  Policy <scheduli
+00009c60: 6e67 2d70 6f6c 6963 6965 733e 602e 0a20  ng-policies>`.. 
+00009c70: 2020 2070 7269 6f72 6974 793a 2074 7570     priority: tup
+00009c80: 6c65 5b66 6c6f 6174 2c20 2e2e 2e5d 207c  le[float, ...] |
+00009c90: 204e 6f6e 650a 0a20 2020 2023 2041 7474   None..    # Att
+00009ca0: 7269 6275 7465 2075 6e64 6572 6c79 696e  ribute underlyin
+00009cb0: 6720 7468 6520 7374 6174 6520 7072 6f70  g the state prop
+00009cc0: 6572 7479 0a20 2020 205f 7374 6174 653a  erty.    _state:
+00009cd0: 2054 6173 6b53 7461 7465 5374 6174 650a   TaskStateState.
+00009ce0: 0a20 2020 2023 3a20 5468 6520 7365 7420  .    #: The set 
+00009cf0: 6f66 2074 6173 6b73 2074 6869 7320 7461  of tasks this ta
+00009d00: 736b 2064 6570 656e 6473 206f 6e20 666f  sk depends on fo
+00009d10: 7220 7072 6f70 6572 2065 7865 6375 7469  r proper executi
+00009d20: 6f6e 2e20 4f6e 6c79 2074 6173 6b73 2073  on. Only tasks s
+00009d30: 7469 6c6c 0a20 2020 2023 3a20 616c 6976  till.    #: aliv
+00009d40: 6520 6172 6520 6c69 7374 6564 2069 6e20  e are listed in 
+00009d50: 7468 6973 2073 6574 2e20 4966 2c20 666f  this set. If, fo
+00009d60: 7220 7768 6174 6576 6572 2072 6561 736f  r whatever reaso
+00009d70: 6e2c 2074 6869 7320 7461 736b 2061 6c73  n, this task als
+00009d80: 6f20 6465 7065 6e64 7320 6f6e 0a20 2020  o depends on.   
+00009d90: 2023 3a20 6120 666f 7267 6f74 7465 6e20   #: a forgotten 
+00009da0: 7461 736b 2c20 7468 6520 3a61 7474 723a  task, the :attr:
+00009db0: 6068 6173 5f6c 6f73 745f 6465 7065 6e64  `has_lost_depend
+00009dc0: 656e 6369 6573 6020 666c 6167 2069 7320  encies` flag is 
+00009dd0: 7365 742e 0a20 2020 2023 3a0a 2020 2020  set..    #:.    
+00009de0: 233a 2041 2074 6173 6b20 6361 6e20 6f6e  #: A task can on
+00009df0: 6c79 2062 6520 6578 6563 7574 6564 206f  ly be executed o
+00009e00: 6e63 6520 616c 6c20 6974 7320 6465 7065  nce all its depe
+00009e10: 6e64 656e 6369 6573 2068 6176 6520 616c  ndencies have al
+00009e20: 7265 6164 7920 6265 656e 0a20 2020 2023  ready been.    #
+00009e30: 3a20 7375 6363 6573 7366 756c 6c79 2065  : successfully e
+00009e40: 7865 6375 7465 6420 616e 6420 6861 7665  xecuted and have
+00009e50: 2074 6865 6972 2072 6573 756c 7420 7374   their result st
+00009e60: 6f72 6564 206f 6e20 6174 206c 6561 7374  ored on at least
+00009e70: 206f 6e65 2077 6f72 6b65 722e 2054 6869   one worker. Thi
+00009e80: 730a 2020 2020 233a 2069 7320 7472 6163  s.    #: is trac
+00009e90: 6b65 6420 6279 2070 726f 6772 6573 7369  ked by progressi
+00009ea0: 7665 6c79 2064 7261 696e 696e 6720 7468  vely draining th
+00009eb0: 6520 3a61 7474 723a 6077 6169 7469 6e67  e :attr:`waiting
+00009ec0: 5f6f 6e60 2073 6574 2e0a 2020 2020 6465  _on` set..    de
+00009ed0: 7065 6e64 656e 6369 6573 3a20 7365 745b  pendencies: set[
+00009ee0: 5461 736b 5374 6174 655d 0a0a 2020 2020  TaskState]..    
+00009ef0: 233a 2054 6865 2073 6574 206f 6620 7461  #: The set of ta
+00009f00: 736b 7320 7768 6963 6820 6465 7065 6e64  sks which depend
+00009f10: 206f 6e20 7468 6973 2074 6173 6b2e 2020   on this task.  
+00009f20: 4f6e 6c79 2074 6173 6b73 2073 7469 6c6c  Only tasks still
+00009f30: 2061 6c69 7665 2061 7265 206c 6973 7465   alive are liste
+00009f40: 6420 696e 0a20 2020 2023 3a20 7468 6973  d in.    #: this
+00009f50: 2073 6574 2e20 5468 6973 2069 7320 7468   set. This is th
+00009f60: 6520 7265 7665 7273 6520 6d61 7070 696e  e reverse mappin
+00009f70: 6720 6f66 203a 6174 7472 3a60 6465 7065  g of :attr:`depe
+00009f80: 6e64 656e 6369 6573 602e 0a20 2020 2064  ndencies`..    d
+00009f90: 6570 656e 6465 6e74 733a 2073 6574 5b54  ependents: set[T
+00009fa0: 6173 6b53 7461 7465 5d0a 0a20 2020 2023  askState]..    #
+00009fb0: 3a20 5768 6574 6865 7220 616e 7920 6f66  : Whether any of
+00009fc0: 2074 6865 2064 6570 656e 6465 6e63 6965   the dependencie
+00009fd0: 7320 6f66 2074 6869 7320 7461 736b 2068  s of this task h
+00009fe0: 6173 2062 6565 6e20 666f 7267 6f74 7465  as been forgotte
+00009ff0: 6e2e 2046 6f72 206d 656d 6f72 790a 2020  n. For memory.  
+0000a000: 2020 233a 2063 6f6e 7375 6d70 7469 6f6e    #: consumption
+0000a010: 2072 6561 736f 6e73 2c20 666f 7267 6f74   reasons, forgot
+0000a020: 7465 6e20 7461 736b 7320 6172 6520 6e6f  ten tasks are no
+0000a030: 7420 6b65 7074 2069 6e20 6d65 6d6f 7279  t kept in memory
+0000a040: 2065 7665 6e20 7468 6f75 6768 2074 6865   even though the
+0000a050: 7920 6d61 790a 2020 2020 233a 2068 6176  y may.    #: hav
+0000a060: 6520 6465 7065 6e64 656e 7420 7461 736b  e dependent task
+0000a070: 732e 2020 5768 656e 2061 2074 6173 6b20  s.  When a task 
+0000a080: 6973 2066 6f72 676f 7474 656e 2c20 7468  is forgotten, th
+0000a090: 6572 6566 6f72 652c 2065 6163 6820 6f66  erefore, each of
+0000a0a0: 2069 7473 0a20 2020 2023 3a20 6465 7065   its.    #: depe
+0000a0b0: 6e64 656e 7473 2068 6173 2074 6865 6972  ndents has their
+0000a0c0: 203a 6174 7472 3a60 6861 735f 6c6f 7374   :attr:`has_lost
+0000a0d0: 5f64 6570 656e 6465 6e63 6965 7360 2061  _dependencies` a
+0000a0e0: 7474 7269 6275 7465 2073 6574 2074 6f20  ttribute set to 
+0000a0f0: 6060 5472 7565 6060 2e0a 2020 2020 233a  ``True``..    #:
+0000a100: 0a20 2020 2023 3a20 4966 203a 6174 7472  .    #: If :attr
+0000a110: 3a60 6861 735f 6c6f 7374 5f64 6570 656e  :`has_lost_depen
+0000a120: 6465 6e63 6965 7360 2069 7320 7472 7565  dencies` is true
+0000a130: 2c20 7468 6973 2074 6173 6b20 6361 6e6e  , this task cann
+0000a140: 6f74 2067 6f20 696e 746f 2074 6865 0a20  ot go into the. 
+0000a150: 2020 2023 3a20 2270 726f 6365 7373 696e     #: "processin
+0000a160: 6722 2073 7461 7465 2061 6e79 6d6f 7265  g" state anymore
+0000a170: 2e0a 2020 2020 6861 735f 6c6f 7374 5f64  ..    has_lost_d
+0000a180: 6570 656e 6465 6e63 6965 733a 2062 6f6f  ependencies: boo
+0000a190: 6c0a 0a20 2020 2023 3a20 5468 6520 7365  l..    #: The se
+0000a1a0: 7420 6f66 2074 6173 6b73 2074 6869 7320  t of tasks this 
+0000a1b0: 7461 736b 2069 7320 7761 6974 696e 6720  task is waiting 
+0000a1c0: 6f6e 202a 6265 666f 7265 2a20 6974 2063  on *before* it c
+0000a1d0: 616e 2062 6520 6578 6563 7574 6564 2e20  an be executed. 
+0000a1e0: 5468 6973 2069 730a 2020 2020 233a 2061  This is.    #: a
+0000a1f0: 6c77 6179 7320 6120 7375 6273 6574 206f  lways a subset o
+0000a200: 6620 3a61 7474 723a 6064 6570 656e 6465  f :attr:`depende
+0000a210: 6e63 6965 7360 2e20 2045 6163 6820 7469  ncies`.  Each ti
+0000a220: 6d65 206f 6e65 206f 6620 7468 6520 6465  me one of the de
+0000a230: 7065 6e64 656e 6369 6573 2068 6173 0a20  pendencies has. 
+0000a240: 2020 2023 3a20 6669 6e69 7368 6564 2070     #: finished p
+0000a250: 726f 6365 7373 696e 672c 2069 7420 6973  rocessing, it is
+0000a260: 2072 656d 6f76 6564 2066 726f 6d20 7468   removed from th
+0000a270: 6520 3a61 7474 723a 6077 6169 7469 6e67  e :attr:`waiting
+0000a280: 5f6f 6e60 2073 6574 2e0a 2020 2020 233a  _on` set..    #:
+0000a290: 0a20 2020 2023 3a20 4f6e 6365 203a 6174  .    #: Once :at
+0000a2a0: 7472 3a60 7761 6974 696e 675f 6f6e 6020  tr:`waiting_on` 
+0000a2b0: 6265 636f 6d65 7320 656d 7074 792c 2074  becomes empty, t
+0000a2c0: 6869 7320 7461 736b 2063 616e 206d 6f76  his task can mov
+0000a2d0: 6520 6672 6f6d 2074 6865 2022 7761 6974  e from the "wait
+0000a2e0: 696e 6722 0a20 2020 2023 3a20 7374 6174  ing".    #: stat
+0000a2f0: 6520 746f 2074 6865 2022 7072 6f63 6573  e to the "proces
+0000a300: 7369 6e67 2220 7374 6174 6520 2875 6e6c  sing" state (unl
+0000a310: 6573 7320 6f6e 6520 6f66 2074 6865 2064  ess one of the d
+0000a320: 6570 656e 6465 6e63 6965 7320 6572 726f  ependencies erro
+0000a330: 7265 6420 6f75 742c 2069 6e0a 2020 2020  red out, in.    
+0000a340: 233a 2077 6869 6368 2063 6173 6520 7468  #: which case th
+0000a350: 6973 2074 6173 6b20 6973 2069 6e73 7465  is task is inste
+0000a360: 6164 206d 6172 6b65 6420 2265 7272 6564  ad marked "erred
+0000a370: 2229 2e0a 2020 2020 7761 6974 696e 675f  ")..    waiting_
+0000a380: 6f6e 3a20 7365 745b 5461 736b 5374 6174  on: set[TaskStat
+0000a390: 655d 207c 204e 6f6e 650a 0a20 2020 2023  e] | None..    #
+0000a3a0: 3a20 5468 6520 7365 7420 6f66 2074 6173  : The set of tas
+0000a3b0: 6b73 2077 6869 6368 206e 6565 6420 7468  ks which need th
+0000a3c0: 6973 2074 6173 6b20 746f 2072 656d 6169  is task to remai
+0000a3d0: 6e20 616c 6976 652e 2020 5468 6973 2069  n alive.  This i
+0000a3e0: 7320 616c 7761 7973 2061 2073 7562 7365  s always a subse
+0000a3f0: 740a 2020 2020 233a 206f 6620 3a61 7474  t.    #: of :att
+0000a400: 723a 6064 6570 656e 6465 6e74 7360 2e20  r:`dependents`. 
+0000a410: 2045 6163 6820 7469 6d65 206f 6e65 206f   Each time one o
+0000a420: 6620 7468 6520 6465 7065 6e64 656e 7473  f the dependents
+0000a430: 2068 6173 2066 696e 6973 6865 6420 7072   has finished pr
+0000a440: 6f63 6573 7369 6e67 2c0a 2020 2020 233a  ocessing,.    #:
+0000a450: 2069 7420 6973 2072 656d 6f76 6564 2066   it is removed f
+0000a460: 726f 6d20 7468 6520 3a61 7474 723a 6077  rom the :attr:`w
+0000a470: 6169 7465 7273 6020 7365 742e 0a20 2020  aiters` set..   
+0000a480: 2023 3a0a 2020 2020 233a 204f 6e63 6520   #:.    #: Once 
+0000a490: 626f 7468 203a 6174 7472 3a60 7761 6974  both :attr:`wait
+0000a4a0: 6572 7360 2061 6e64 203a 6174 7472 3a60  ers` and :attr:`
+0000a4b0: 7768 6f5f 7761 6e74 7360 2062 6563 6f6d  who_wants` becom
+0000a4c0: 6520 656d 7074 792c 2074 6869 7320 7461  e empty, this ta
+0000a4d0: 736b 2063 616e 2062 650a 2020 2020 233a  sk can be.    #:
+0000a4e0: 2072 656c 6561 7365 6420 2869 6620 6974   released (if it
+0000a4f0: 2068 6173 2061 206e 6f6e 2d65 6d70 7479   has a non-empty
+0000a500: 203a 6174 7472 3a60 7275 6e5f 7370 6563   :attr:`run_spec
+0000a510: 6029 206f 7220 666f 7267 6f74 7465 6e20  `) or forgotten 
+0000a520: 286f 7468 6572 7769 7365 2920 6279 2074  (otherwise) by t
+0000a530: 6865 0a20 2020 2023 3a20 7363 6865 6475  he.    #: schedu
+0000a540: 6c65 722c 2061 6e64 2062 7920 616e 7920  ler, and by any 
+0000a550: 776f 726b 6572 7320 696e 203a 6174 7472  workers in :attr
+0000a560: 3a60 7768 6f5f 6861 7360 2e0a 2020 2020  :`who_has`..    
+0000a570: 233a 0a20 2020 2023 3a20 2e2e 206e 6f74  #:.    #: .. not
+0000a580: 653a 3a0a 2020 2020 233a 2020 2020 436f  e::.    #:    Co
+0000a590: 756e 7465 722d 696e 7475 6974 6976 656c  unter-intuitivel
+0000a5a0: 792c 203a 6174 7472 3a60 7761 6974 696e  y, :attr:`waitin
+0000a5b0: 675f 6f6e 6020 616e 6420 3a61 7474 723a  g_on` and :attr:
+0000a5c0: 6077 6169 7465 7273 6020 6172 6520 6e6f  `waiters` are no
+0000a5d0: 7420 7265 7665 7273 650a 2020 2020 233a  t reverse.    #:
+0000a5e0: 2020 2020 6d61 7070 696e 6773 206f 6620      mappings of 
+0000a5f0: 6561 6368 206f 7468 6572 2e0a 2020 2020  each other..    
+0000a600: 7761 6974 6572 733a 2073 6574 5b54 6173  waiters: set[Tas
+0000a610: 6b53 7461 7465 5d20 7c20 4e6f 6e65 0a0a  kState] | None..
+0000a620: 2020 2020 233a 2054 6865 2073 6574 206f      #: The set o
+0000a630: 6620 636c 6965 6e74 7320 7768 6f20 7761  f clients who wa
+0000a640: 6e74 2074 6865 2072 6573 756c 7420 6f66  nt the result of
+0000a650: 2074 6869 7320 7461 736b 2074 6f20 7265   this task to re
+0000a660: 6d61 696e 2061 6c69 7665 2e0a 2020 2020  main alive..    
+0000a670: 233a 2054 6869 7320 6973 2074 6865 2072  #: This is the r
+0000a680: 6576 6572 7365 206d 6170 7069 6e67 206f  everse mapping o
+0000a690: 6620 3a61 7474 723a 6043 6c69 656e 7453  f :attr:`ClientS
+0000a6a0: 7461 7465 2e77 616e 7473 5f77 6861 7460  tate.wants_what`
+0000a6b0: 2e0a 2020 2020 233a 0a20 2020 2023 3a20  ..    #:.    #: 
+0000a6c0: 5768 656e 2061 2063 6c69 656e 7420 7375  When a client su
+0000a6d0: 626d 6974 7320 6120 6772 6170 6820 746f  bmits a graph to
+0000a6e0: 2074 6865 2073 6368 6564 756c 6572 2069   the scheduler i
+0000a6f0: 7420 616c 736f 2073 7065 6369 6669 6573  t also specifies
+0000a700: 2077 6869 6368 206f 7574 7075 740a 2020   which output.  
+0000a710: 2020 233a 2074 6173 6b73 2069 7420 6465    #: tasks it de
+0000a720: 7369 7265 732c 2073 7563 6820 7468 6174  sires, such that
+0000a730: 2074 6865 6972 2072 6573 756c 7473 2061   their results a
+0000a740: 7265 206e 6f74 2072 656c 6561 7365 6420  re not released 
+0000a750: 6672 6f6d 206d 656d 6f72 792e 0a20 2020  from memory..   
+0000a760: 2023 3a0a 2020 2020 233a 204f 6e63 6520   #:.    #: Once 
+0000a770: 6120 7461 736b 2068 6173 2066 696e 6973  a task has finis
+0000a780: 6865 6420 6578 6563 7574 696e 6720 2869  hed executing (i
+0000a790: 2e65 2e20 6d6f 7665 7320 696e 746f 2074  .e. moves into t
+0000a7a0: 6865 2022 6d65 6d6f 7279 2220 6f72 2022  he "memory" or "
+0000a7b0: 6572 7265 6422 0a20 2020 2023 3a20 7374  erred".    #: st
+0000a7c0: 6174 6529 2c20 7468 6520 636c 6965 6e74  ate), the client
+0000a7d0: 7320 696e 203a 6174 7472 3a60 7768 6f5f  s in :attr:`who_
+0000a7e0: 7761 6e74 7360 2061 7265 206e 6f74 6966  wants` are notif
+0000a7f0: 6965 642e 0a20 2020 2023 3a0a 2020 2020  ied..    #:.    
+0000a800: 233a 204f 6e63 6520 626f 7468 203a 6174  #: Once both :at
+0000a810: 7472 3a60 7761 6974 6572 7360 2061 6e64  tr:`waiters` and
+0000a820: 203a 6174 7472 3a60 7768 6f5f 7761 6e74   :attr:`who_want
+0000a830: 7360 2062 6563 6f6d 6520 656d 7074 792c  s` become empty,
+0000a840: 2074 6869 7320 7461 736b 2063 616e 2062   this task can b
+0000a850: 650a 2020 2020 233a 2072 656c 6561 7365  e.    #: release
+0000a860: 6420 2869 6620 6974 2068 6173 2061 206e  d (if it has a n
+0000a870: 6f6e 2d65 6d70 7479 203a 6174 7472 3a60  on-empty :attr:`
+0000a880: 7275 6e5f 7370 6563 6029 206f 7220 666f  run_spec`) or fo
+0000a890: 7267 6f74 7465 6e20 286f 7468 6572 7769  rgotten (otherwi
+0000a8a0: 7365 2920 6279 2074 6865 0a20 2020 2023  se) by the.    #
+0000a8b0: 3a20 7363 6865 6475 6c65 722c 2061 6e64  : scheduler, and
+0000a8c0: 2062 7920 616e 7920 776f 726b 6572 7320   by any workers 
+0000a8d0: 696e 203a 6174 7472 3a60 7768 6f5f 6861  in :attr:`who_ha
+0000a8e0: 7360 2e0a 2020 2020 7768 6f5f 7761 6e74  s`..    who_want
+0000a8f0: 733a 2073 6574 5b43 6c69 656e 7453 7461  s: set[ClientSta
+0000a900: 7465 5d20 7c20 4e6f 6e65 0a0a 2020 2020  te] | None..    
+0000a910: 233a 2054 6865 2073 6574 206f 6620 776f  #: The set of wo
+0000a920: 726b 6572 7320 7768 6f20 6861 7665 2074  rkers who have t
+0000a930: 6869 7320 7461 736b 2773 2072 6573 756c  his task's resul
+0000a940: 7420 696e 206d 656d 6f72 792e 2049 7420  t in memory. It 
+0000a950: 6973 206e 6f6e 2d65 6d70 7479 2069 6666  is non-empty iff
+0000a960: 2074 6865 0a20 2020 2023 3a20 7461 736b   the.    #: task
+0000a970: 2069 7320 696e 2074 6865 2022 6d65 6d6f   is in the "memo
+0000a980: 7279 2220 7374 6174 652e 2020 5468 6572  ry" state.  Ther
+0000a990: 6520 6361 6e20 6265 206d 6f72 6520 7468  e can be more th
+0000a9a0: 616e 206f 6e65 2077 6f72 6b65 7220 696e  an one worker in
+0000a9b0: 2074 6869 7320 7365 7420 6966 2c0a 2020   this set if,.  
+0000a9c0: 2020 233a 2066 6f72 2065 7861 6d70 6c65    #: for example
+0000a9d0: 2c20 3a6d 6574 683a 6043 6c69 656e 742e  , :meth:`Client.
+0000a9e0: 7363 6174 7465 7260 206f 7220 3a6d 6574  scatter` or :met
+0000a9f0: 683a 6043 6c69 656e 742e 7265 706c 6963  h:`Client.replic
+0000aa00: 6174 6560 2077 6173 2075 7365 642e 0a20  ate` was used.. 
+0000aa10: 2020 2023 3a0a 2020 2020 233a 2054 6869     #:.    #: Thi
+0000aa20: 7320 6973 2074 6865 2072 6576 6572 7365  s is the reverse
+0000aa30: 206d 6170 7069 6e67 206f 6620 3a61 7474   mapping of :att
+0000aa40: 723a 6057 6f72 6b65 7253 7461 7465 2e68  r:`WorkerState.h
+0000aa50: 6173 5f77 6861 7460 2e0a 2020 2020 7768  as_what`..    wh
+0000aa60: 6f5f 6861 733a 2073 6574 5b57 6f72 6b65  o_has: set[Worke
+0000aa70: 7253 7461 7465 5d20 7c20 4e6f 6e65 0a0a  rState] | None..
+0000aa80: 2020 2020 233a 2049 6620 7468 6973 2074      #: If this t
+0000aa90: 6173 6b20 6973 2069 6e20 7468 6520 2270  ask is in the "p
+0000aaa0: 726f 6365 7373 696e 6722 2073 7461 7465  rocessing" state
+0000aab0: 2c20 7768 6963 6820 776f 726b 6572 2069  , which worker i
+0000aac0: 7320 6375 7272 656e 746c 7920 7072 6f63  s currently proc
+0000aad0: 6573 7369 6e67 0a20 2020 2023 3a20 6974  essing.    #: it
+0000aae0: 2e20 5468 6973 2061 7474 7269 6275 7465  . This attribute
+0000aaf0: 2069 7320 6b65 7074 2069 6e20 7379 6e63   is kept in sync
+0000ab00: 2077 6974 6820 3a61 7474 723a 6057 6f72   with :attr:`Wor
+0000ab10: 6b65 7253 7461 7465 2e70 726f 6365 7373  kerState.process
+0000ab20: 696e 6760 2e0a 2020 2020 7072 6f63 6573  ing`..    proces
+0000ab30: 7369 6e67 5f6f 6e3a 2057 6f72 6b65 7253  sing_on: WorkerS
+0000ab40: 7461 7465 207c 204e 6f6e 650a 0a20 2020  tate | None..   
+0000ab50: 2023 3a20 5468 6520 6e75 6d62 6572 206f   #: The number o
+0000ab60: 6620 7469 6d65 7320 7468 6973 2074 6173  f times this tas
+0000ab70: 6b20 6361 6e20 6175 746f 6d61 7469 6361  k can automatica
+0000ab80: 6c6c 7920 6265 2072 6574 7269 6564 2069  lly be retried i
+0000ab90: 6e20 6361 7365 206f 6620 6661 696c 7572  n case of failur
+0000aba0: 652e 0a20 2020 2023 3a20 4966 2061 2074  e..    #: If a t
+0000abb0: 6173 6b20 6661 696c 7320 6578 6563 7574  ask fails execut
+0000abc0: 696e 6720 2874 6865 2077 6f72 6b65 7220  ing (the worker 
+0000abd0: 7265 7475 726e 7320 7769 7468 2061 6e20  returns with an 
+0000abe0: 6572 726f 7229 2c20 6974 7320 3a61 7474  error), its :att
+0000abf0: 723a 6072 6574 7269 6573 600a 2020 2020  r:`retries`.    
+0000ac00: 233a 2061 7474 7269 6275 7465 2069 7320  #: attribute is 
+0000ac10: 6368 6563 6b65 642e 2049 6620 6974 2069  checked. If it i
+0000ac20: 7320 6571 7561 6c20 746f 2030 2c20 7468  s equal to 0, th
+0000ac30: 6520 7461 736b 2069 7320 6d61 726b 6564  e task is marked
+0000ac40: 2022 6572 7265 6422 2e20 4966 2069 7420   "erred". If it 
+0000ac50: 6973 0a20 2020 2023 3a20 6772 6561 7465  is.    #: greate
+0000ac60: 7220 7468 616e 2030 2c20 7468 6520 3a61  r than 0, the :a
+0000ac70: 7474 723a 6072 6574 7269 6573 6020 6174  ttr:`retries` at
+0000ac80: 7472 6962 7574 6520 6973 2064 6563 7265  tribute is decre
+0000ac90: 6d65 6e74 6564 2061 6e64 2065 7865 6375  mented and execu
+0000aca0: 7469 6f6e 2069 730a 2020 2020 233a 2061  tion is.    #: a
+0000acb0: 7474 656d 7074 6564 2061 6761 696e 2e0a  ttempted again..
+0000acc0: 2020 2020 7265 7472 6965 733a 2069 6e74      retries: int
+0000acd0: 0a0a 2020 2020 233a 2054 6865 206e 756d  ..    #: The num
+0000ace0: 6265 7220 6f66 2062 7974 6573 2c20 6173  ber of bytes, as
+0000acf0: 2064 6574 6572 6d69 6e65 6420 6279 2060   determined by `
+0000ad00: 6073 697a 656f 6660 602c 206f 6620 7468  `sizeof``, of th
+0000ad10: 6520 7265 7375 6c74 206f 6620 6120 6669  e result of a fi
+0000ad20: 6e69 7368 6564 0a20 2020 2023 3a20 7461  nished.    #: ta
+0000ad30: 736b 2e20 5468 6973 206e 756d 6265 7220  sk. This number 
+0000ad40: 6973 2075 7365 6420 666f 7220 6469 6167  is used for diag
+0000ad50: 6e6f 7374 6963 7320 616e 6420 746f 2068  nostics and to h
+0000ad60: 656c 7020 7072 696f 7269 7469 7a65 2077  elp prioritize w
+0000ad70: 6f72 6b2e 0a20 2020 2023 3a20 5365 7420  ork..    #: Set 
+0000ad80: 746f 202d 3120 666f 7220 756e 6669 6e69  to -1 for unfini
+0000ad90: 7368 6564 2074 6173 6b73 2e0a 2020 2020  shed tasks..    
+0000ada0: 6e62 7974 6573 3a20 696e 740a 0a20 2020  nbytes: int..   
+0000adb0: 2023 3a20 5468 6520 7479 7065 206f 6620   #: The type of 
+0000adc0: 7468 6520 6f62 6a65 6374 2061 7320 6120  the object as a 
+0000add0: 7374 7269 6e67 2e20 4f6e 6c79 2070 7265  string. Only pre
+0000ade0: 7365 6e74 2066 6f72 2074 6173 6b73 2074  sent for tasks t
+0000adf0: 6861 7420 6861 7665 2062 6565 6e0a 2020  hat have been.  
+0000ae00: 2020 233a 2063 6f6d 7075 7465 642e 0a20    #: computed.. 
+0000ae10: 2020 2074 7970 653a 2073 7472 0a0a 2020     type: str..  
+0000ae20: 2020 233a 2049 6620 7468 6973 2074 6173    #: If this tas
+0000ae30: 6b20 6661 696c 6564 2065 7865 6375 7469  k failed executi
+0000ae40: 6e67 2c20 7468 6520 6578 6365 7074 696f  ng, the exceptio
+0000ae50: 6e20 6f62 6a65 6374 2069 7320 7374 6f72  n object is stor
+0000ae60: 6564 2068 6572 652e 0a20 2020 2065 7863  ed here..    exc
+0000ae70: 6570 7469 6f6e 3a20 5365 7269 616c 697a  eption: Serializ
+0000ae80: 6564 207c 204e 6f6e 650a 0a20 2020 2023  ed | None..    #
+0000ae90: 3a20 4966 2074 6869 7320 7461 736b 2066  : If this task f
+0000aea0: 6169 6c65 6420 6578 6563 7574 696e 672c  ailed executing,
+0000aeb0: 2074 6865 2074 7261 6365 6261 636b 206f   the traceback o
+0000aec0: 626a 6563 7420 6973 2073 746f 7265 6420  bject is stored 
+0000aed0: 6865 7265 2e0a 2020 2020 7472 6163 6562  here..    traceb
+0000aee0: 6163 6b3a 2053 6572 6961 6c69 7a65 6420  ack: Serialized 
+0000aef0: 7c20 4e6f 6e65 0a0a 2020 2020 233a 2073  | None..    #: s
+0000af00: 7472 696e 6720 7265 7072 6573 656e 7461  tring representa
+0000af10: 7469 6f6e 206f 6620 6578 6365 7074 696f  tion of exceptio
+0000af20: 6e0a 2020 2020 6578 6365 7074 696f 6e5f  n.    exception_
+0000af30: 7465 7874 3a20 7374 7220 7c20 4e6f 6e65  text: str | None
+0000af40: 0a0a 2020 2020 233a 2073 7472 696e 6720  ..    #: string 
+0000af50: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
+0000af60: 6620 7472 6163 6562 6163 6b0a 2020 2020  f traceback.    
+0000af70: 7472 6163 6562 6163 6b5f 7465 7874 3a20  traceback_text: 
+0000af80: 7374 7220 7c20 4e6f 6e65 0a0a 2020 2020  str | None..    
+0000af90: 233a 2049 6620 7468 6973 2074 6173 6b20  #: If this task 
+0000afa0: 6f72 206f 6e65 206f 6620 6974 7320 6465  or one of its de
+0000afb0: 7065 6e64 656e 6369 6573 2066 6169 6c65  pendencies faile
+0000afc0: 6420 6578 6563 7574 696e 672c 2074 6865  d executing, the
+0000afd0: 2066 6169 6c65 6420 7461 736b 2069 730a   failed task is.
+0000afe0: 2020 2020 233a 2073 746f 7265 6420 6865      #: stored he
+0000aff0: 7265 2028 706f 7373 6962 6c79 2069 7473  re (possibly its
+0000b000: 656c 6629 2e0a 2020 2020 6578 6365 7074  elf)..    except
+0000b010: 696f 6e5f 626c 616d 653a 2054 6173 6b53  ion_blame: TaskS
+0000b020: 7461 7465 207c 204e 6f6e 650a 0a20 2020  tate | None..   
+0000b030: 2023 3a20 576f 726b 6572 2061 6464 7265   #: Worker addre
+0000b040: 7373 6573 206f 6e20 7768 6963 6820 6572  sses on which er
+0000b050: 726f 7273 2061 7070 6561 7265 642c 2063  rors appeared, c
+0000b060: 6175 7369 6e67 2074 6869 7320 7461 736b  ausing this task
+0000b070: 2074 6f20 6265 2069 6e20 616e 2065 7272   to be in an err
+0000b080: 6f72 0a20 2020 2023 3a20 7374 6174 652e  or.    #: state.
+0000b090: 0a20 2020 2065 7272 6564 5f6f 6e3a 2073  .    erred_on: s
+0000b0a0: 6574 5b73 7472 5d20 7c20 4e6f 6e65 0a0a  et[str] | None..
+0000b0b0: 2020 2020 233a 2054 6865 206e 756d 6265      #: The numbe
+0000b0c0: 7220 6f66 2074 696d 6573 2074 6869 7320  r of times this 
+0000b0d0: 7461 736b 2068 6173 2062 6565 6e20 696e  task has been in
+0000b0e0: 766f 6c76 6564 2069 6e20 6120 776f 726b  volved in a work
+0000b0f0: 6572 2064 6561 7468 2e0a 2020 2020 233a  er death..    #:
+0000b100: 0a20 2020 2023 3a20 536f 6d65 2074 6173  .    #: Some tas
+0000b110: 6b73 206d 6179 2063 6175 7365 2077 6f72  ks may cause wor
+0000b120: 6b65 7273 2074 6f20 6469 6520 2873 7563  kers to die (suc
+0000b130: 6820 6173 2063 616c 6c69 6e67 2060 606f  h as calling ``o
+0000b140: 732e 5f65 7869 7428 3029 6060 292e 2057  s._exit(0)``). W
+0000b150: 6865 6e20 610a 2020 2020 233a 2077 6f72  hen a.    #: wor
+0000b160: 6b65 7220 6469 6573 2c20 616c 6c20 6f66  ker dies, all of
+0000b170: 2074 6865 2074 6173 6b73 206f 6e20 7468   the tasks on th
+0000b180: 6174 2077 6f72 6b65 7220 6172 6520 7265  at worker are re
+0000b190: 6173 7369 676e 6564 2074 6f20 6f74 6865  assigned to othe
+0000b1a0: 7273 2e20 5468 6973 0a20 2020 2023 3a20  rs. This.    #: 
+0000b1b0: 636f 6d62 696e 6174 696f 6e20 6f66 2062  combination of b
+0000b1c0: 6568 6176 696f 7273 2063 616e 2063 6175  ehaviors can cau
+0000b1d0: 7365 2061 2062 6164 2074 6173 6b20 746f  se a bad task to
+0000b1e0: 2063 6174 6173 7472 6f70 6869 6361 6c6c   catastrophicall
+0000b1f0: 7920 6465 7374 726f 7920 616c 6c0a 2020  y destroy all.  
+0000b200: 2020 233a 2077 6f72 6b65 7273 206f 6e20    #: workers on 
+0000b210: 7468 6520 636c 7573 7465 722c 206f 6e65  the cluster, one
+0000b220: 2061 6674 6572 2061 6e6f 7468 6572 2e20   after another. 
+0000b230: 5768 656e 6576 6572 2061 2077 6f72 6b65  Whenever a worke
+0000b240: 7220 6469 6573 2c20 7765 206d 6172 6b20  r dies, we mark 
+0000b250: 6561 6368 0a20 2020 2023 3a20 7461 736b  each.    #: task
+0000b260: 2063 7572 7265 6e74 6c79 2070 726f 6365   currently proce
+0000b270: 7373 696e 6720 6f6e 2074 6861 7420 776f  ssing on that wo
+0000b280: 726b 6572 2028 6173 2072 6563 6f72 6465  rker (as recorde
+0000b290: 6420 6279 0a20 2020 2023 3a20 3a61 7474  d by.    #: :att
+0000b2a0: 723a 6057 6f72 6b65 7253 7461 7465 2e70  r:`WorkerState.p
+0000b2b0: 726f 6365 7373 696e 6760 2920 6173 2073  rocessing`) as s
+0000b2c0: 7573 7069 6369 6f75 732e 2049 6620 6120  uspicious. If a 
+0000b2d0: 7461 736b 2069 7320 696e 766f 6c76 6564  task is involved
+0000b2e0: 2069 6e20 7468 7265 650a 2020 2020 233a   in three.    #:
+0000b2f0: 2064 6561 7468 7320 286f 7220 736f 6d65   deaths (or some
+0000b300: 206f 7468 6572 2066 6978 6564 2063 6f6e   other fixed con
+0000b310: 7374 616e 7429 2074 6865 6e20 7765 206d  stant) then we m
+0000b320: 6172 6b20 7468 6520 7461 736b 2061 7320  ark the task as 
+0000b330: 6060 6572 7265 6460 602e 0a20 2020 2073  ``erred``..    s
+0000b340: 7573 7069 6369 6f75 733a 2069 6e74 0a0a  uspicious: int..
+0000b350: 2020 2020 233a 2041 2073 6574 206f 6620      #: A set of 
+0000b360: 686f 7374 6e61 6d65 7320 7768 6572 6520  hostnames where 
+0000b370: 7468 6973 2074 6173 6b20 6361 6e20 6265  this task can be
+0000b380: 2072 756e 2028 6f72 2060 604e 6f6e 6560   run (or ``None`
+0000b390: 6020 6966 2065 6d70 7479 292e 2055 7375  ` if empty). Usu
+0000b3a0: 616c 6c79 0a20 2020 2023 3a20 7468 6973  ally.    #: this
+0000b3b0: 2069 7320 656d 7074 7920 756e 6c65 7373   is empty unless
+0000b3c0: 2074 6865 2074 6173 6b20 6861 7320 6265   the task has be
+0000b3d0: 656e 2073 7065 6369 6669 6361 6c6c 7920  en specifically 
+0000b3e0: 7265 7374 7269 6374 6564 2074 6f20 6f6e  restricted to on
+0000b3f0: 6c79 2072 756e 206f 6e0a 2020 2020 233a  ly run on.    #:
+0000b400: 2063 6572 7461 696e 2068 6f73 7473 2e20   certain hosts. 
+0000b410: 4120 686f 7374 6e61 6d65 206d 6179 2063  A hostname may c
+0000b420: 6f72 7265 7370 6f6e 6420 746f 206f 6e65  orrespond to one
+0000b430: 206f 7220 7365 7665 7261 6c20 636f 6e6e   or several conn
+0000b440: 6563 7465 6420 776f 726b 6572 732e 0a20  ected workers.. 
+0000b450: 2020 2068 6f73 745f 7265 7374 7269 6374     host_restrict
+0000b460: 696f 6e73 3a20 7365 745b 7374 725d 207c  ions: set[str] |
+0000b470: 204e 6f6e 650a 0a20 2020 2023 3a20 4120   None..    #: A 
+0000b480: 7365 7420 6f66 2063 6f6d 706c 6574 6520  set of complete 
+0000b490: 776f 726b 6572 2061 6464 7265 7373 6573  worker addresses
+0000b4a0: 2077 6865 7265 2074 6869 7320 6361 6e20   where this can 
+0000b4b0: 6265 2072 756e 2028 6f72 2060 604e 6f6e  be run (or ``Non
+0000b4c0: 6560 6020 6966 2065 6d70 7479 292e 0a20  e`` if empty).. 
+0000b4d0: 2020 2023 3a20 5573 7561 6c6c 7920 7468     #: Usually th
+0000b4e0: 6973 2069 7320 656d 7074 7920 756e 6c65  is is empty unle
+0000b4f0: 7373 2074 6865 2074 6173 6b20 6861 7320  ss the task has 
+0000b500: 6265 656e 2073 7065 6369 6669 6361 6c6c  been specificall
+0000b510: 7920 7265 7374 7269 6374 6564 2074 6f20  y restricted to 
+0000b520: 6f6e 6c79 0a20 2020 2023 3a20 7275 6e20  only.    #: run 
+0000b530: 6f6e 2063 6572 7461 696e 2077 6f72 6b65  on certain worke
+0000b540: 7273 2e0a 2020 2020 233a 204e 6f74 6520  rs..    #: Note 
+0000b550: 7468 6973 2069 7320 7472 6163 6b69 6e67  this is tracking
+0000b560: 2077 6f72 6b65 7220 6164 6472 6573 7365   worker addresse
+0000b570: 732c 206e 6f74 2077 6f72 6b65 7220 7374  s, not worker st
+0000b580: 6174 6573 2c20 7369 6e63 6520 7468 6520  ates, since the 
+0000b590: 7370 6563 6966 6963 0a20 2020 2023 3a20  specific.    #: 
+0000b5a0: 776f 726b 6572 7320 6d61 7920 6e6f 7420  workers may not 
+0000b5b0: 6265 2063 6f6e 6e65 6374 6564 2061 7420  be connected at 
+0000b5c0: 7468 6973 2074 696d 652e 0a20 2020 2077  this time..    w
+0000b5d0: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
+0000b5e0: 6e73 3a20 7365 745b 7374 725d 207c 204e  ns: set[str] | N
+0000b5f0: 6f6e 650a 0a20 2020 2023 3a20 5265 736f  one..    #: Reso
+0000b600: 7572 6365 7320 7265 7175 6972 6564 2062  urces required b
+0000b610: 7920 7468 6973 2074 6173 6b2c 2073 7563  y this task, suc
+0000b620: 6820 6173 2060 607b 2767 7075 273a 2031  h as ``{'gpu': 1
+0000b630: 7d60 6020 6f72 2060 607b 276d 656d 6f72  }`` or ``{'memor
+0000b640: 7927 3a20 3165 397d 6060 0a20 2020 2023  y': 1e9}``.    #
+0000b650: 3a20 5468 6573 6520 6172 6520 7573 6572  : These are user
+0000b660: 2d64 6566 696e 6564 206e 616d 6573 2061  -defined names a
+0000b670: 6e64 2061 7265 206d 6174 6368 6564 2061  nd are matched a
+0000b680: 6761 696e 7374 2074 6865 203a 2063 6f6e  gainst the : con
+0000b690: 7465 6e74 7320 6f66 2065 6163 680a 2020  tents of each.  
+0000b6a0: 2020 233a 203a 6174 7472 3a60 576f 726b    #: :attr:`Work
+0000b6b0: 6572 5374 6174 652e 7265 736f 7572 6365  erState.resource
+0000b6c0: 7360 2064 6963 7469 6f6e 6172 792e 0a20  s` dictionary.. 
+0000b6d0: 2020 2072 6573 6f75 7263 655f 7265 7374     resource_rest
+0000b6e0: 7269 6374 696f 6e73 3a20 6469 6374 5b73  rictions: dict[s
+0000b6f0: 7472 2c20 666c 6f61 745d 207c 204e 6f6e  tr, float] | Non
+0000b700: 650a 0a20 2020 2023 3a20 4661 6c73 650a  e..    #: False.
+0000b710: 2020 2020 233a 2020 2020 2045 6163 6820      #:     Each 
+0000b720: 6f66 203a 6174 7472 3a60 686f 7374 5f72  of :attr:`host_r
+0000b730: 6573 7472 6963 7469 6f6e 7360 2c20 3a61  estrictions`, :a
+0000b740: 7474 723a 6077 6f72 6b65 725f 7265 7374  ttr:`worker_rest
+0000b750: 7269 6374 696f 6e73 6020 616e 640a 2020  rictions` and.  
+0000b760: 2020 233a 2020 2020 203a 6174 7472 3a60    #:     :attr:`
+0000b770: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
+0000b780: 7469 6f6e 7360 2069 7320 6120 6861 7264  tions` is a hard
+0000b790: 2063 6f6e 7374 7261 696e 743a 2069 6620   constraint: if 
+0000b7a0: 6e6f 2077 6f72 6b65 7220 6973 2061 7661  no worker is ava
+0000b7b0: 696c 6162 6c65 0a20 2020 2023 3a20 2020  ilable.    #:   
+0000b7c0: 2020 7361 7469 7366 7969 6e67 2074 686f    satisfying tho
+0000b7d0: 7365 2072 6573 7472 6963 7469 6f6e 732c  se restrictions,
+0000b7e0: 2074 6865 2074 6173 6b20 6361 6e6e 6f74   the task cannot
+0000b7f0: 2067 6f20 696e 746f 2074 6865 2022 7072   go into the "pr
+0000b800: 6f63 6573 7369 6e67 2220 7374 6174 650a  ocessing" state.
+0000b810: 2020 2020 233a 2020 2020 2061 6e64 2077      #:     and w
+0000b820: 696c 6c20 696e 7374 6561 6420 676f 2069  ill instead go i
+0000b830: 6e74 6f20 7468 6520 226e 6f2d 776f 726b  nto the "no-work
+0000b840: 6572 2220 7374 6174 652e 0a20 2020 2023  er" state..    #
+0000b850: 3a20 5472 7565 0a20 2020 2023 3a20 2020  : True.    #:   
+0000b860: 2020 5468 6520 6162 6f76 6520 7265 7374    The above rest
+0000b870: 7269 6374 696f 6e73 2061 7265 206d 6572  rictions are mer
+0000b880: 6520 7072 6566 6572 656e 6365 733a 2069  e preferences: i
+0000b890: 6620 6e6f 2077 6f72 6b65 7220 6973 2061  f no worker is a
+0000b8a0: 7661 696c 6162 6c65 0a20 2020 2023 3a20  vailable.    #: 
+0000b8b0: 2020 2020 7361 7469 7366 7969 6e67 2074      satisfying t
+0000b8c0: 686f 7365 2072 6573 7472 6963 7469 6f6e  hose restriction
+0000b8d0: 732c 2074 6865 2074 6173 6b20 6361 6e20  s, the task can 
+0000b8e0: 7374 696c 6c20 676f 2069 6e74 6f20 7468  still go into th
+0000b8f0: 650a 2020 2020 233a 2020 2020 2022 7072  e.    #:     "pr
+0000b900: 6f63 6573 7369 6e67 2220 7374 6174 6520  ocessing" state 
+0000b910: 616e 6420 6265 2073 656e 7420 666f 7220  and be sent for 
+0000b920: 6578 6563 7574 696f 6e20 746f 2061 6e6f  execution to ano
+0000b930: 7468 6572 2063 6f6e 6e65 6374 6564 2077  ther connected w
+0000b940: 6f72 6b65 722e 0a20 2020 206c 6f6f 7365  orker..    loose
+0000b950: 5f72 6573 7472 6963 7469 6f6e 733a 2062  _restrictions: b
+0000b960: 6f6f 6c0a 0a20 2020 2023 3a20 5768 6574  ool..    #: Whet
+0000b970: 6865 7220 7468 6973 2074 6173 6b20 6973  her this task is
+0000b980: 2061 6e20 4163 746f 720a 2020 2020 6163   an Actor.    ac
+0000b990: 746f 723a 2062 6f6f 6c0a 0a20 2020 2023  tor: bool..    #
+0000b9a0: 3a20 5468 6520 6772 6f75 7020 6f66 2074  : The group of t
+0000b9b0: 6173 6b73 2074 6f20 7768 6963 6820 7468  asks to which th
+0000b9c0: 6973 206f 6e65 2062 656c 6f6e 6773 0a20  is one belongs. 
+0000b9d0: 2020 2067 726f 7570 3a20 5461 736b 4772     group: TaskGr
+0000b9e0: 6f75 700a 0a20 2020 2023 3a20 5361 6d65  oup..    #: Same
+0000b9f0: 2061 7320 6f66 2067 726f 7570 2e6e 616d   as of group.nam
+0000ba00: 650a 2020 2020 6772 6f75 705f 6b65 793a  e.    group_key:
+0000ba10: 2073 7472 0a0a 2020 2020 233a 204d 6574   str..    #: Met
+0000ba20: 6164 6174 6120 7265 6c61 7465 6420 746f  adata related to
+0000ba30: 2074 6173 6b0a 2020 2020 6d65 7461 6461   task.    metada
+0000ba40: 7461 3a20 6469 6374 5b73 7472 2c20 416e  ta: dict[str, An
+0000ba50: 795d 207c 204e 6f6e 650a 0a20 2020 2023  y] | None..    #
+0000ba60: 3a20 5461 736b 2061 6e6e 6f74 6174 696f  : Task annotatio
+0000ba70: 6e73 0a20 2020 2061 6e6e 6f74 6174 696f  ns.    annotatio
+0000ba80: 6e73 3a20 6469 6374 5b73 7472 2c20 416e  ns: dict[str, An
+0000ba90: 795d 207c 204e 6f6e 650a 0a20 2020 2023  y] | None..    #
+0000baa0: 3a20 5468 6520 756e 6971 7565 2069 6465  : The unique ide
+0000bab0: 6e74 6966 6965 7220 6f66 2061 2073 7065  ntifier of a spe
+0000bac0: 6369 6669 6320 6578 6563 7574 696f 6e20  cific execution 
+0000bad0: 6f66 2061 2074 6173 6b2e 2054 6869 7320  of a task. This 
+0000bae0: 6964 656e 7469 6669 6572 0a20 2020 2023  identifier.    #
+0000baf0: 3a20 6973 2075 7365 6420 746f 2073 6967  : is used to sig
+0000bb00: 6e20 6120 7461 736b 2073 7563 6820 7468  n a task such th
+0000bb10: 6174 2074 6865 2061 7373 6967 6e65 6420  at the assigned 
+0000bb20: 776f 726b 6572 2069 7320 6578 7065 6374  worker is expect
+0000bb30: 6564 2074 6f20 7265 7475 726e 0a20 2020  ed to return.   
+0000bb40: 2023 3a20 7468 6520 7361 6d65 2069 6465   #: the same ide
+0000bb50: 6e74 6966 6965 7220 696e 2074 6865 2074  ntifier in the t
+0000bb60: 6173 6b2d 6669 6e69 7368 6564 206d 6573  ask-finished mes
+0000bb70: 7361 6765 2e20 5468 6973 2069 7320 7573  sage. This is us
+0000bb80: 6564 2074 6f20 636f 7272 656c 6174 650a  ed to correlate.
+0000bb90: 2020 2020 233a 2072 6573 706f 6e73 6573      #: responses
+0000bba0: 2e0a 2020 2020 233a 204f 6e6c 7920 7468  ..    #: Only th
+0000bbb0: 6520 6d6f 7374 2072 6563 656e 746c 7920  e most recently 
+0000bbc0: 6173 7369 676e 6564 2077 6f72 6b65 7220  assigned worker 
+0000bbd0: 6973 2074 7275 7374 6564 2e20 416c 6c20  is trusted. All 
+0000bbe0: 6f74 6865 7220 7265 7375 6c74 7320 7769  other results wi
+0000bbf0: 6c6c 0a20 2020 2023 3a20 6265 2072 656a  ll.    #: be rej
+0000bc00: 6563 7465 642e 0a20 2020 2072 756e 5f69  ected..    run_i
+0000bc10: 643a 2069 6e74 207c 204e 6f6e 650a 0a20  d: int | None.. 
+0000bc20: 2020 2023 3a20 5768 6574 6865 7220 746f     #: Whether to
+0000bc30: 2063 6f6e 7369 6465 7220 7468 6973 2074   consider this t
+0000bc40: 6173 6b20 726f 6f74 6973 6820 696e 2074  ask rootish in t
+0000bc50: 6865 2063 6f6e 7465 7874 206f 6620 7461  he context of ta
+0000bc60: 736b 2071 7565 7565 696e 670a 2020 2020  sk queueing.    
+0000bc70: 233a 2054 7275 650a 2020 2020 233a 2020  #: True.    #:  
+0000bc80: 2020 2041 6c77 6179 7320 636f 6e73 6964     Always consid
+0000bc90: 6572 2074 6869 7320 7461 736b 2072 6f6f  er this task roo
+0000bca0: 7469 7368 0a20 2020 2023 3a20 4661 6c73  tish.    #: Fals
+0000bcb0: 650a 2020 2020 233a 2020 2020 204e 6576  e.    #:     Nev
+0000bcc0: 6572 2063 6f6e 7369 6465 7220 7468 6973  er consider this
+0000bcd0: 2074 6173 6b20 726f 6f74 6973 680a 2020   task rootish.  
+0000bce0: 2020 233a 204e 6f6e 650a 2020 2020 233a    #: None.    #:
+0000bcf0: 2020 2020 2055 7365 2061 2068 6575 7269       Use a heuri
+0000bd00: 7374 6963 2074 6f20 6465 7465 726d 696e  stic to determin
+0000bd10: 6520 7768 6574 6865 7220 7468 6973 2074  e whether this t
+0000bd20: 6173 6b20 7368 6f75 6c64 2062 6520 636f  ask should be co
+0000bd30: 6e73 6964 6572 6564 2072 6f6f 7469 7368  nsidered rootish
+0000bd40: 0a20 2020 205f 726f 6f74 6973 683a 2062  .    _rootish: b
+0000bd50: 6f6f 6c20 7c20 4e6f 6e65 0a0a 2020 2020  ool | None..    
+0000bd60: 233a 2043 6163 6865 6420 6861 7368 206f  #: Cached hash o
+0000bd70: 6620 3a61 7474 723a 607e 5461 736b 5374  f :attr:`~TaskSt
+0000bd80: 6174 652e 636c 6965 6e74 5f6b 6579 600a  ate.client_key`.
+0000bd90: 2020 2020 5f68 6173 683a 2069 6e74 0a0a      _hash: int..
+0000bda0: 2020 2020 2320 5375 7070 6f72 7420 666f      # Support fo
+0000bdb0: 7220 7765 616b 7265 6673 2074 6f20 6120  r weakrefs to a 
+0000bdc0: 636c 6173 7320 7769 7468 205f 5f73 6c6f  class with __slo
+0000bdd0: 7473 5f5f 0a20 2020 205f 5f77 6561 6b72  ts__.    __weakr
+0000bde0: 6566 5f5f 3a20 416e 7920 3d20 4e6f 6e65  ef__: Any = None
+0000bdf0: 0a20 2020 205f 5f73 6c6f 7473 5f5f 203d  .    __slots__ =
+0000be00: 2074 7570 6c65 285f 5f61 6e6e 6f74 6174   tuple(__annotat
+0000be10: 696f 6e73 5f5f 290a 0a20 2020 2023 3a20  ions__)..    #: 
+0000be20: 476c 6f62 616c 2069 7465 7261 746f 7220  Global iterator 
+0000be30: 7573 6564 2074 6f20 6372 6561 7465 2075  used to create u
+0000be40: 6e69 7175 6520 7461 736b 2072 756e 2049  nique task run I
+0000be50: 4473 0a20 2020 205f 7275 6e5f 6964 5f69  Ds.    _run_id_i
+0000be60: 7465 7261 746f 723a 2043 6c61 7373 5661  terator: ClassVa
+0000be70: 725b 6974 6572 746f 6f6c 732e 636f 756e  r[itertools.coun
+0000be80: 745d 203d 2069 7465 7274 6f6f 6c73 2e63  t] = itertools.c
+0000be90: 6f75 6e74 2829 0a0a 2020 2020 2320 496e  ount()..    # In
+0000bea0: 7374 616e 6365 7320 6e6f 7420 7061 7274  stances not part
+0000beb0: 206f 6620 736c 6f74 7320 7369 6e63 6520   of slots since 
+0000bec0: 636c 6173 7320 7661 7269 6162 6c65 0a20  class variable. 
+0000bed0: 2020 205f 696e 7374 616e 6365 733a 2043     _instances: C
+0000bee0: 6c61 7373 5661 725b 7765 616b 7265 662e  lassVar[weakref.
+0000bef0: 5765 616b 5365 745b 5461 736b 5374 6174  WeakSet[TaskStat
+0000bf00: 655d 5d20 3d20 7765 616b 7265 662e 5765  e]] = weakref.We
+0000bf10: 616b 5365 7428 290a 0a20 2020 2064 6566  akSet()..    def
+0000bf20: 205f 5f69 6e69 745f 5f28 0a20 2020 2020   __init__(.     
+0000bf30: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0000bf40: 206b 6579 3a20 4b65 792c 0a20 2020 2020   key: Key,.     
+0000bf50: 2020 2072 756e 5f73 7065 633a 2054 5f72     run_spec: T_r
+0000bf60: 756e 7370 6563 207c 204e 6f6e 652c 0a20  unspec | None,. 
+0000bf70: 2020 2020 2020 2073 7461 7465 3a20 5461         state: Ta
+0000bf80: 736b 5374 6174 6553 7461 7465 2c0a 2020  skStateState,.  
+0000bf90: 2020 293a 0a20 2020 2020 2020 2023 204d    ):.        # M
+0000bfa0: 6f73 7420 6f66 2074 6865 2061 7474 7269  ost of the attri
+0000bfb0: 6275 7465 7320 6265 6c6f 7720 6172 6520  butes below are 
+0000bfc0: 6e6f 7420 696e 6974 6961 6c69 7a65 6420  not initialized 
+0000bfd0: 7369 6e63 6520 7468 6572 6520 6172 6520  since there are 
+0000bfe0: 6e6f 740a 2020 2020 2020 2020 2320 616c  not.        # al
+0000bff0: 7761 7973 2072 6571 7569 7265 6420 666f  ways required fo
+0000c000: 7220 6576 6572 7920 7461 736b 732e 2050  r every tasks. P
+0000c010: 6172 7469 6375 6c61 726c 7920 666f 7220  articularly for 
+0000c020: 6c61 7267 6520 6772 6170 6873 2c20 7468  large graphs, th
+0000c030: 6573 650a 2020 2020 2020 2020 2320 6361  ese.        # ca
+0000c040: 6e20 6164 6420 7570 2073 6967 6e69 6669  n add up signifi
+0000c050: 6361 6e74 206d 656d 6f72 792c 2073 6565  cant memory, see
+0000c060: 0a20 2020 2020 2020 2023 2068 7474 7073  .        # https
+0000c070: 3a2f 2f67 6974 6875 622e 636f 6d2f 6461  ://github.com/da
+0000c080: 736b 2f64 6973 7472 6962 7574 6564 2f70  sk/distributed/p
+0000c090: 756c 6c2f 3833 3331 0a20 2020 2020 2020  ull/8331.       
+0000c0a0: 2023 2068 7474 7073 3a2f 2f67 6974 6875   # https://githu
+0000c0b0: 622e 636f 6d2f 6461 736b 2f64 6973 7472  b.com/dask/distr
+0000c0c0: 6962 7574 6564 2f69 7373 7565 732f 3739  ibuted/issues/79
+0000c0d0: 3938 2369 7373 7565 636f 6d6d 656e 742d  98#issuecomment-
+0000c0e0: 3136 3737 3136 3734 3738 0a20 2020 2020  1677167478.     
+0000c0f0: 2020 2073 656c 662e 6b65 7920 3d20 6b65     self.key = ke
+0000c100: 790a 2020 2020 2020 2020 7365 6c66 2e5f  y.        self._
+0000c110: 6861 7368 203d 2068 6173 6828 6b65 7929  hash = hash(key)
+0000c120: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
+0000c130: 6e5f 7370 6563 203d 2072 756e 5f73 7065  n_spec = run_spe
+0000c140: 630a 2020 2020 2020 2020 7365 6c66 2e5f  c.        self._
+0000c150: 7374 6174 6520 3d20 7374 6174 650a 2020  state = state.  
+0000c160: 2020 2020 2020 7365 6c66 2e65 7863 6570        self.excep
+0000c170: 7469 6f6e 203d 204e 6f6e 650a 2020 2020  tion = None.    
+0000c180: 2020 2020 7365 6c66 2e65 7863 6570 7469      self.excepti
+0000c190: 6f6e 5f62 6c61 6d65 203d 204e 6f6e 650a  on_blame = None.
+0000c1a0: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
+0000c1b0: 6365 6261 636b 203d 204e 6f6e 650a 2020  ceback = None.  
+0000c1c0: 2020 2020 2020 7365 6c66 2e65 7863 6570        self.excep
+0000c1d0: 7469 6f6e 5f74 6578 7420 3d20 4e6f 6e65  tion_text = None
+0000c1e0: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
+0000c1f0: 6163 6562 6163 6b5f 7465 7874 203d 204e  aceback_text = N
+0000c200: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0000c210: 2e73 7573 7069 6369 6f75 7320 3d20 300a  .suspicious = 0.
+0000c220: 2020 2020 2020 2020 7365 6c66 2e72 6574          self.ret
+0000c230: 7269 6573 203d 2030 0a20 2020 2020 2020  ries = 0.       
+0000c240: 2073 656c 662e 6e62 7974 6573 203d 202d   self.nbytes = -
+0000c250: 310a 2020 2020 2020 2020 7365 6c66 2e70  1.        self.p
+0000c260: 7269 6f72 6974 7920 3d20 4e6f 6e65 0a20  riority = None. 
+0000c270: 2020 2020 2020 2073 656c 662e 7768 6f5f         self.who_
+0000c280: 7761 6e74 7320 3d20 4e6f 6e65 0a20 2020  wants = None.   
+0000c290: 2020 2020 2073 656c 662e 6465 7065 6e64       self.depend
+0000c2a0: 656e 6369 6573 203d 2073 6574 2829 0a20  encies = set(). 
+0000c2b0: 2020 2020 2020 2073 656c 662e 6465 7065         self.depe
+0000c2c0: 6e64 656e 7473 203d 2073 6574 2829 0a20  ndents = set(). 
+0000c2d0: 2020 2020 2020 2073 656c 662e 7761 6974         self.wait
+0000c2e0: 696e 675f 6f6e 203d 204e 6f6e 650a 2020  ing_on = None.  
+0000c2f0: 2020 2020 2020 7365 6c66 2e77 6169 7465        self.waite
+0000c300: 7273 203d 204e 6f6e 650a 2020 2020 2020  rs = None.      
+0000c310: 2020 7365 6c66 2e77 686f 5f68 6173 203d    self.who_has =
+0000c320: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
+0000c330: 6c66 2e70 726f 6365 7373 696e 675f 6f6e  lf.processing_on
+0000c340: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+0000c350: 7365 6c66 2e68 6173 5f6c 6f73 745f 6465  self.has_lost_de
+0000c360: 7065 6e64 656e 6369 6573 203d 2046 616c  pendencies = Fal
+0000c370: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
+0000c380: 686f 7374 5f72 6573 7472 6963 7469 6f6e  host_restriction
+0000c390: 7320 3d20 4e6f 6e65 0a20 2020 2020 2020  s = None.       
+0000c3a0: 2073 656c 662e 776f 726b 6572 5f72 6573   self.worker_res
+0000c3b0: 7472 6963 7469 6f6e 7320 3d20 4e6f 6e65  trictions = None
+0000c3c0: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+0000c3d0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
+0000c3e0: 6f6e 7320 3d20 4e6f 6e65 0a20 2020 2020  ons = None.     
+0000c3f0: 2020 2073 656c 662e 6c6f 6f73 655f 7265     self.loose_re
+0000c400: 7374 7269 6374 696f 6e73 203d 2046 616c  strictions = Fal
+0000c410: 7365 0a20 2020 2020 2020 2073 656c 662e  se.        self.
+0000c420: 6163 746f 7220 3d20 4661 6c73 650a 2020  actor = False.  
+0000c430: 2020 2020 2020 7365 6c66 2e70 7265 6669        self.prefi
+0000c440: 7820 3d20 4e6f 6e65 2020 2320 7479 7065  x = None  # type
+0000c450: 3a20 6967 6e6f 7265 0a20 2020 2020 2020  : ignore.       
+0000c460: 2073 656c 662e 7479 7065 203d 204e 6f6e   self.type = Non
+0000c470: 6520 2023 2074 7970 653a 2069 676e 6f72  e  # type: ignor
+0000c480: 650a 2020 2020 2020 2020 7365 6c66 2e67  e.        self.g
+0000c490: 726f 7570 5f6b 6579 203d 206b 6579 5f73  roup_key = key_s
+0000c4a0: 706c 6974 5f67 726f 7570 286b 6579 290a  plit_group(key).
+0000c4b0: 2020 2020 2020 2020 7365 6c66 2e67 726f          self.gro
+0000c4c0: 7570 203d 204e 6f6e 6520 2023 2074 7970  up = None  # typ
+0000c4d0: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
+0000c4e0: 2020 7365 6c66 2e6d 6574 6164 6174 6120    self.metadata 
+0000c4f0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+0000c500: 656c 662e 616e 6e6f 7461 7469 6f6e 7320  elf.annotations 
+0000c510: 3d20 4e6f 6e65 0a20 2020 2020 2020 2073  = None.        s
+0000c520: 656c 662e 6572 7265 645f 6f6e 203d 204e  elf.erred_on = N
+0000c530: 6f6e 650a 2020 2020 2020 2020 7365 6c66  one.        self
+0000c540: 2e5f 726f 6f74 6973 6820 3d20 4e6f 6e65  ._rootish = None
+0000c550: 0a20 2020 2020 2020 2073 656c 662e 7275  .        self.ru
+0000c560: 6e5f 6964 203d 204e 6f6e 650a 2020 2020  n_id = None.    
+0000c570: 2020 2020 5461 736b 5374 6174 652e 5f69      TaskState._i
+0000c580: 6e73 7461 6e63 6573 2e61 6464 2873 656c  nstances.add(sel
+0000c590: 6629 0a0a 2020 2020 6465 6620 5f5f 6861  f)..    def __ha
+0000c5a0: 7368 5f5f 2873 656c 6629 202d 3e20 696e  sh__(self) -> in
+0000c5b0: 743a 0a20 2020 2020 2020 2072 6574 7572  t:.        retur
+0000c5c0: 6e20 7365 6c66 2e5f 6861 7368 0a0a 2020  n self._hash..  
+0000c5d0: 2020 6465 6620 5f5f 6571 5f5f 2873 656c    def __eq__(sel
+0000c5e0: 662c 206f 7468 6572 3a20 6f62 6a65 6374  f, other: object
+0000c5f0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+0000c600: 2020 2072 6574 7572 6e20 6973 696e 7374     return isinst
+0000c610: 616e 6365 286f 7468 6572 2c20 5461 736b  ance(other, Task
+0000c620: 5374 6174 6529 2061 6e64 2073 656c 662e  State) and self.
+0000c630: 6b65 7920 3d3d 206f 7468 6572 2e6b 6579  key == other.key
+0000c640: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+0000c650: 2020 2020 6465 6620 7374 6174 6528 7365      def state(se
+0000c660: 6c66 2920 2d3e 2054 6173 6b53 7461 7465  lf) -> TaskState
+0000c670: 5374 6174 653a 0a20 2020 2020 2020 2022  State:.        "
+0000c680: 2222 5468 6973 2074 6173 6b27 7320 6375  ""This task's cu
+0000c690: 7272 656e 7420 7374 6174 652e 2020 5661  rrent state.  Va
+0000c6a0: 6c69 6420 7374 6174 6573 2061 7265 2060  lid states are `
+0000c6b0: 6072 656c 6561 7365 6460 602c 2060 6077  `released``, ``w
+0000c6c0: 6169 7469 6e67 6060 2c0a 2020 2020 2020  aiting``,.      
+0000c6d0: 2020 6060 6e6f 2d77 6f72 6b65 7260 602c    ``no-worker``,
+0000c6e0: 2060 6070 726f 6365 7373 696e 6760 602c   ``processing``,
+0000c6f0: 2060 606d 656d 6f72 7960 602c 2060 6065   ``memory``, ``e
+0000c700: 7272 6564 6060 2061 6e64 2060 6066 6f72  rred`` and ``for
+0000c710: 676f 7474 656e 6060 2e20 2049 6620 6974  gotten``.  If it
+0000c720: 0a20 2020 2020 2020 2069 7320 6060 666f  .        is ``fo
+0000c730: 7267 6f74 7465 6e60 602c 2074 6865 2074  rgotten``, the t
+0000c740: 6173 6b20 6973 6e27 7420 7374 6f72 6564  ask isn't stored
+0000c750: 2069 6e20 7468 6520 6060 7461 736b 7360   in the ``tasks`
+0000c760: 6020 6469 6374 696f 6e61 7279 2061 6e79  ` dictionary any
+0000c770: 6d6f 7265 2061 6e64 0a20 2020 2020 2020  more and.       
+0000c780: 2077 696c 6c20 7072 6f62 6162 6c79 2064   will probably d
+0000c790: 6973 6170 7065 6172 2073 6f6f 6e20 6672  isappear soon fr
+0000c7a0: 6f6d 206d 656d 6f72 792e 0a20 2020 2020  om memory..     
+0000c7b0: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
+0000c7c0: 6574 7572 6e20 7365 6c66 2e5f 7374 6174  eturn self._stat
+0000c7d0: 650a 0a20 2020 2040 7374 6174 652e 7365  e..    @state.se
+0000c7e0: 7474 6572 0a20 2020 2064 6566 2073 7461  tter.    def sta
+0000c7f0: 7465 2873 656c 662c 2076 616c 7565 3a20  te(self, value: 
+0000c800: 5461 736b 5374 6174 6553 7461 7465 2920  TaskStateState) 
+0000c810: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0000c820: 2073 656c 662e 6772 6f75 702e 7374 6174   self.group.stat
+0000c830: 6573 5b73 656c 662e 5f73 7461 7465 5d20  es[self._state] 
+0000c840: 2d3d 2031 0a20 2020 2020 2020 2073 656c  -= 1.        sel
+0000c850: 662e 6772 6f75 702e 7374 6174 6573 5b76  f.group.states[v
+0000c860: 616c 7565 5d20 2b3d 2031 0a20 2020 2020  alue] += 1.     
+0000c870: 2020 2073 656c 662e 5f73 7461 7465 203d     self._state =
+0000c880: 2076 616c 7565 0a20 2020 2020 2020 2073   value.        s
+0000c890: 656c 662e 7072 6566 6978 2e73 7461 7465  elf.prefix.state
+0000c8a0: 5f63 6f75 6e74 735b 7661 6c75 655d 202b  _counts[value] +
+0000c8b0: 3d20 310a 0a20 2020 2064 6566 2061 6464  = 1..    def add
+0000c8c0: 5f64 6570 656e 6465 6e63 7928 7365 6c66  _dependency(self
+0000c8d0: 2c20 6f74 6865 723a 2054 6173 6b53 7461  , other: TaskSta
+0000c8e0: 7465 2920 2d3e 204e 6f6e 653a 0a20 2020  te) -> None:.   
+0000c8f0: 2020 2020 2022 2222 4164 6420 616e 6f74       """Add anot
+0000c900: 6865 7220 7461 736b 2061 7320 6120 6465  her task as a de
+0000c910: 7065 6e64 656e 6379 206f 6620 7468 6973  pendency of this
+0000c920: 2074 6173 6b22 2222 0a20 2020 2020 2020   task""".       
+0000c930: 2073 656c 662e 6465 7065 6e64 656e 6369   self.dependenci
+0000c940: 6573 2e61 6464 286f 7468 6572 290a 2020  es.add(other).  
+0000c950: 2020 2020 2020 7365 6c66 2e67 726f 7570        self.group
+0000c960: 2e64 6570 656e 6465 6e63 6965 732e 6164  .dependencies.ad
+0000c970: 6428 6f74 6865 722e 6772 6f75 7029 0a20  d(other.group). 
+0000c980: 2020 2020 2020 206f 7468 6572 2e64 6570         other.dep
+0000c990: 656e 6465 6e74 732e 6164 6428 7365 6c66  endents.add(self
+0000c9a0: 290a 0a20 2020 2064 6566 2067 6574 5f6e  )..    def get_n
+0000c9b0: 6279 7465 7328 7365 6c66 2920 2d3e 2069  bytes(self) -> i
+0000c9c0: 6e74 3a0a 2020 2020 2020 2020 7265 7475  nt:.        retu
+0000c9d0: 726e 2073 656c 662e 6e62 7974 6573 2069  rn self.nbytes i
+0000c9e0: 6620 7365 6c66 2e6e 6279 7465 7320 3e3d  f self.nbytes >=
+0000c9f0: 2030 2065 6c73 6520 4445 4641 554c 545f   0 else DEFAULT_
+0000ca00: 4441 5441 5f53 495a 450a 0a20 2020 2064  DATA_SIZE..    d
+0000ca10: 6566 2073 6574 5f6e 6279 7465 7328 7365  ef set_nbytes(se
+0000ca20: 6c66 2c20 6e62 7974 6573 3a20 696e 7429  lf, nbytes: int)
+0000ca30: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0000ca40: 2020 6469 6666 203d 206e 6279 7465 730a    diff = nbytes.
+0000ca50: 2020 2020 2020 2020 6f6c 645f 6e62 7974          old_nbyt
+0000ca60: 6573 203d 2073 656c 662e 6e62 7974 6573  es = self.nbytes
+0000ca70: 0a20 2020 2020 2020 2069 6620 6f6c 645f  .        if old_
+0000ca80: 6e62 7974 6573 203e 3d20 303a 0a20 2020  nbytes >= 0:.   
+0000ca90: 2020 2020 2020 2020 2064 6966 6620 2d3d           diff -=
+0000caa0: 206f 6c64 5f6e 6279 7465 730a 2020 2020   old_nbytes.    
+0000cab0: 2020 2020 7365 6c66 2e67 726f 7570 2e6e      self.group.n
+0000cac0: 6279 7465 735f 746f 7461 6c20 2b3d 2064  bytes_total += d
+0000cad0: 6966 660a 2020 2020 2020 2020 666f 7220  iff.        for 
+0000cae0: 7773 2069 6e20 7365 6c66 2e77 686f 5f68  ws in self.who_h
+0000caf0: 6173 206f 7220 2829 3a0a 2020 2020 2020  as or ():.      
+0000cb00: 2020 2020 2020 7773 2e6e 6279 7465 7320        ws.nbytes 
+0000cb10: 2b3d 2064 6966 660a 2020 2020 2020 2020  += diff.        
+0000cb20: 7365 6c66 2e6e 6279 7465 7320 3d20 6e62  self.nbytes = nb
+0000cb30: 7974 6573 0a0a 2020 2020 6465 6620 5f5f  ytes..    def __
+0000cb40: 7265 7072 5f5f 2873 656c 6629 202d 3e20  repr__(self) -> 
+0000cb50: 7374 723a 0a20 2020 2020 2020 2072 6574  str:.        ret
+0000cb60: 7572 6e20 6622 3c54 6173 6b53 7461 7465  urn f"<TaskState
+0000cb70: 207b 7365 6c66 2e6b 6579 2172 7d20 7b73   {self.key!r} {s
+0000cb80: 656c 662e 5f73 7461 7465 7d3e 220a 0a20  elf._state}>".. 
+0000cb90: 2020 2064 6566 205f 7265 7072 5f68 746d     def _repr_htm
+0000cba0: 6c5f 2873 656c 6629 202d 3e20 7374 723a  l_(self) -> str:
+0000cbb0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000cbc0: 6765 745f 7465 6d70 6c61 7465 2822 7461  get_template("ta
+0000cbd0: 736b 5f73 7461 7465 2e68 746d 6c2e 6a32  sk_state.html.j2
+0000cbe0: 2229 2e72 656e 6465 7228 0a20 2020 2020  ").render(.     
+0000cbf0: 2020 2020 2020 2073 7461 7465 3d73 656c         state=sel
+0000cc00: 662e 7374 6174 652c 0a20 2020 2020 2020  f.state,.       
+0000cc10: 2020 2020 206e 6279 7465 733d 7365 6c66       nbytes=self
+0000cc20: 2e6e 6279 7465 732c 0a20 2020 2020 2020  .nbytes,.       
+0000cc30: 2020 2020 206b 6579 3d73 7472 2873 656c       key=str(sel
+0000cc40: 662e 6b65 7929 2c0a 2020 2020 2020 2020  f.key),.        
+0000cc50: 290a 0a20 2020 2064 6566 2076 616c 6964  )..    def valid
+0000cc60: 6174 6528 7365 6c66 2920 2d3e 204e 6f6e  ate(self) -> Non
+0000cc70: 653a 0a20 2020 2020 2020 2074 7279 3a0a  e:.        try:.
+0000cc80: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0000cc90: 6373 2069 6e20 7365 6c66 2e77 686f 5f77  cs in self.who_w
+0000cca0: 616e 7473 206f 7220 2829 3a0a 2020 2020  ants or ():.    
+0000ccb0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0000ccc0: 7274 2069 7369 6e73 7461 6e63 6528 6373  rt isinstance(cs
+0000ccd0: 2c20 436c 6965 6e74 5374 6174 6529 2c20  , ClientState), 
+0000cce0: 2872 6570 7228 6373 292c 2073 656c 662e  (repr(cs), self.
+0000ccf0: 7768 6f5f 7761 6e74 7329 0a20 2020 2020  who_wants).     
+0000cd00: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
+0000cd10: 2073 656c 662e 7768 6f5f 6861 7320 6f72   self.who_has or
+0000cd20: 2028 293a 0a20 2020 2020 2020 2020 2020   ():.           
+0000cd30: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+0000cd40: 7374 616e 6365 2877 732c 2057 6f72 6b65  stance(ws, Worke
+0000cd50: 7253 7461 7465 292c 2028 7265 7072 2877  rState), (repr(w
+0000cd60: 7329 2c20 7365 6c66 2e77 686f 5f68 6173  s), self.who_has
+0000cd70: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+0000cd80: 7220 7473 2069 6e20 7365 6c66 2e64 6570  r ts in self.dep
+0000cd90: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
+0000cda0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0000cdb0: 7420 6973 696e 7374 616e 6365 2874 732c  t isinstance(ts,
+0000cdc0: 2054 6173 6b53 7461 7465 292c 2028 7265   TaskState), (re
+0000cdd0: 7072 2874 7329 2c20 7365 6c66 2e64 6570  pr(ts), self.dep
+0000cde0: 656e 6465 6e63 6965 7329 0a20 2020 2020  endencies).     
+0000cdf0: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
+0000ce00: 2073 656c 662e 6465 7065 6e64 656e 7473   self.dependents
+0000ce10: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ce20: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+0000ce30: 6e63 6528 7473 2c20 5461 736b 5374 6174  nce(ts, TaskStat
+0000ce40: 6529 2c20 2872 6570 7228 7473 292c 2073  e), (repr(ts), s
+0000ce50: 656c 662e 6465 7065 6e64 656e 7473 290a  elf.dependents).
+0000ce60: 2020 2020 2020 2020 2020 2020 7661 6c69              vali
+0000ce70: 6461 7465 5f74 6173 6b5f 7374 6174 6528  date_task_state(
+0000ce80: 7365 6c66 290a 2020 2020 2020 2020 6578  self).        ex
+0000ce90: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
+0000cea0: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0000ceb0: 206c 6f67 6765 722e 6578 6365 7074 696f   logger.exceptio
+0000cec0: 6e28 6529 0a20 2020 2020 2020 2020 2020  n(e).           
+0000ced0: 2069 6620 4c4f 475f 5044 423a 0a20 2020   if LOG_PDB:.   
+0000cee0: 2020 2020 2020 2020 2020 2020 2069 6d70               imp
+0000cef0: 6f72 7420 7064 620a 0a20 2020 2020 2020  ort pdb..       
+0000cf00: 2020 2020 2020 2020 2070 6462 2e73 6574           pdb.set
+0000cf10: 5f74 7261 6365 2829 0a0a 2020 2020 6465  _trace()..    de
+0000cf20: 6620 6765 745f 6e62 7974 6573 5f64 6570  f get_nbytes_dep
+0000cf30: 7328 7365 6c66 2920 2d3e 2069 6e74 3a0a  s(self) -> int:.
+0000cf40: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0000cf50: 756d 2874 732e 6765 745f 6e62 7974 6573  um(ts.get_nbytes
+0000cf60: 2829 2066 6f72 2074 7320 696e 2073 656c  () for ts in sel
+0000cf70: 662e 6465 7065 6e64 656e 6369 6573 290a  f.dependencies).
+0000cf80: 0a20 2020 2064 6566 205f 746f 5f64 6963  .    def _to_dic
+0000cf90: 745f 6e6f 5f6e 6573 7428 7365 6c66 2c20  t_no_nest(self, 
+0000cfa0: 2a2c 2065 7863 6c75 6465 3a20 436f 6e74  *, exclude: Cont
+0000cfb0: 6169 6e65 725b 7374 725d 203d 2028 2929  ainer[str] = ())
+0000cfc0: 202d 3e20 6469 6374 5b73 7472 2c20 416e   -> dict[str, An
+0000cfd0: 795d 3a0a 2020 2020 2020 2020 2222 2244  y]:.        """D
+0000cfe0: 6963 7469 6f6e 6172 7920 7265 7072 6573  ictionary repres
+0000cff0: 656e 7461 7469 6f6e 2066 6f72 2064 6562  entation for deb
+0000d000: 7567 6769 6e67 2070 7572 706f 7365 732e  ugging purposes.
+0000d010: 0a20 2020 2020 2020 204e 6f74 2074 7970  .        Not typ
+0000d020: 6520 7374 6162 6c65 2061 6e64 206e 6f74  e stable and not
+0000d030: 2069 6e74 656e 6465 6420 666f 7220 726f   intended for ro
+0000d040: 756e 6474 7269 7073 2e0a 0a20 2020 2020  undtrips...     
+0000d050: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
+0000d060: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+0000d070: 2020 2020 2043 6c69 656e 742e 6475 6d70       Client.dump
+0000d080: 5f63 6c75 7374 6572 5f73 7461 7465 0a20  _cluster_state. 
+0000d090: 2020 2020 2020 2064 6973 7472 6962 7574         distribut
+0000d0a0: 6564 2e75 7469 6c73 2e72 6563 7572 7369  ed.utils.recursi
+0000d0b0: 7665 5f74 6f5f 6469 6374 0a0a 2020 2020  ve_to_dict..    
+0000d0c0: 2020 2020 4e6f 7465 730a 2020 2020 2020      Notes.      
+0000d0d0: 2020 2d2d 2d2d 2d0a 2020 2020 2020 2020    -----.        
+0000d0e0: 5468 6973 2063 6c61 7373 2075 7365 7320  This class uses 
+0000d0f0: 6060 5f74 6f5f 6469 6374 5f6e 6f5f 6e65  ``_to_dict_no_ne
+0000d100: 7374 6060 2069 6e73 7465 6164 206f 6620  st`` instead of 
+0000d110: 6060 5f74 6f5f 6469 6374 6060 2e0a 2020  ``_to_dict``..  
+0000d120: 2020 2020 2020 5768 656e 2061 2074 6173        When a tas
+0000d130: 6b20 7265 6665 7265 6e63 6573 2061 6e6f  k references ano
+0000d140: 7468 6572 2074 6173 6b2c 206f 7220 7768  ther task, or wh
+0000d150: 656e 2061 2057 6f72 6b65 7253 7461 7465  en a WorkerState
+0000d160: 2e74 6173 6b73 2063 6f6e 7461 696e 7320  .tasks contains 
+0000d170: 7461 736b 732c 0a20 2020 2020 2020 2074  tasks,.        t
+0000d180: 6869 7320 6d65 7468 6f64 2069 7320 6e6f  his method is no
+0000d190: 7420 6578 6563 7574 6564 2066 6f72 2074  t executed for t
+0000d1a0: 6865 2069 6e6e 6572 2074 6173 6b2c 2065  he inner task, e
+0000d1b0: 7665 6e20 6966 2074 6865 2069 6e6e 6572  ven if the inner
+0000d1c0: 2074 6173 6b20 7761 7320 6e65 7665 720a   task was never.
+0000d1d0: 2020 2020 2020 2020 7365 656e 2062 6566          seen bef
+0000d1e0: 6f72 653b 2079 6f75 2067 6574 2061 2072  ore; you get a r
+0000d1f0: 6570 7220 696e 7374 6561 642e 2041 6c6c  epr instead. All
+0000d200: 2074 6173 6b73 2073 686f 756c 6420 6e65   tasks should ne
+0000d210: 6174 6c79 2061 7070 6561 7220 756e 6465  atly appear unde
+0000d220: 720a 2020 2020 2020 2020 5363 6865 6475  r.        Schedu
+0000d230: 6c65 722e 7461 736b 732e 2054 6869 7320  ler.tasks. This 
+0000d240: 616c 736f 2070 7265 7665 6e74 7320 6120  also prevents a 
+0000d250: 5265 6375 7273 696f 6e45 7272 6f72 2064  RecursionError d
+0000d260: 7572 696e 6720 7061 7274 6963 756c 6172  uring particular
+0000d270: 6c79 2068 6561 7679 0a20 2020 2020 2020  ly heavy.       
+0000d280: 206c 6f61 6473 2c20 7768 6963 6820 6861   loads, which ha
+0000d290: 7665 2062 6565 6e20 6f62 7365 7276 6564  ve been observed
+0000d2a0: 2074 6f20 6861 7070 656e 2077 6865 6e65   to happen whene
+0000d2b0: 7665 7220 7468 6572 6527 7320 616e 2061  ver there's an a
+0000d2c0: 6379 636c 6963 2064 6570 656e 6465 6e63  cyclic dependenc
+0000d2d0: 790a 2020 2020 2020 2020 6368 6169 6e20  y.        chain 
+0000d2e0: 6f66 207e 3230 302b 2074 6173 6b73 2e0a  of ~200+ tasks..
+0000d2f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000d300: 2020 2020 7265 7475 726e 2072 6563 7572      return recur
+0000d310: 7369 7665 5f74 6f5f 6469 6374 2873 656c  sive_to_dict(sel
+0000d320: 662c 2065 7863 6c75 6465 3d65 7863 6c75  f, exclude=exclu
+0000d330: 6465 2c20 6d65 6d62 6572 733d 5472 7565  de, members=True
+0000d340: 290a 0a0a 636c 6173 7320 5472 616e 7369  )...class Transi
+0000d350: 7469 6f6e 284e 616d 6564 5475 706c 6529  tion(NamedTuple)
+0000d360: 3a0a 2020 2020 2222 2241 6e20 656e 7472  :.    """An entr
+0000d370: 7920 696e 203a 6174 7472 3a60 5363 6865  y in :attr:`Sche
+0000d380: 6475 6c65 7253 7461 7465 2e74 7261 6e73  dulerState.trans
+0000d390: 6974 696f 6e5f 6c6f 6760 2222 220a 0a20  ition_log`""".. 
+0000d3a0: 2020 206b 6579 3a20 4b65 790a 2020 2020     key: Key.    
+0000d3b0: 7374 6172 743a 2054 6173 6b53 7461 7465  start: TaskState
+0000d3c0: 5374 6174 650a 2020 2020 6669 6e69 7368  State.    finish
+0000d3d0: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
+0000d3e0: 0a20 2020 2072 6563 6f6d 6d65 6e64 6174  .    recommendat
+0000d3f0: 696f 6e73 3a20 5265 6373 0a20 2020 2073  ions: Recs.    s
+0000d400: 7469 6d75 6c75 735f 6964 3a20 7374 720a  timulus_id: str.
+0000d410: 2020 2020 7469 6d65 7374 616d 703a 2066      timestamp: f
+0000d420: 6c6f 6174 0a0a 0a63 6c61 7373 2053 6368  loat...class Sch
+0000d430: 6564 756c 6572 5374 6174 653a 0a20 2020  edulerState:.   
+0000d440: 2022 2222 556e 6465 726c 7969 6e67 2074   """Underlying t
+0000d450: 6173 6b20 7374 6174 6520 6f66 2064 796e  ask state of dyn
+0000d460: 616d 6963 2073 6368 6564 756c 6572 0a0a  amic scheduler..
+0000d470: 2020 2020 5472 6163 6b73 2074 6865 2063      Tracks the c
+0000d480: 7572 7265 6e74 2073 7461 7465 206f 6620  urrent state of 
+0000d490: 776f 726b 6572 732c 2064 6174 612c 2061  workers, data, a
+0000d4a0: 6e64 2063 6f6d 7075 7461 7469 6f6e 732e  nd computations.
+0000d4b0: 0a0a 2020 2020 4861 6e64 6c65 7320 7472  ..    Handles tr
+0000d4c0: 616e 7369 7469 6f6e 7320 6265 7477 6565  ansitions betwee
+0000d4d0: 6e20 6469 6666 6572 656e 7420 7461 736b  n different task
+0000d4e0: 2073 7461 7465 732e 204e 6f74 6966 6965   states. Notifie
+0000d4f0: 7320 7468 650a 2020 2020 5363 6865 6475  s the.    Schedu
+0000d500: 6c65 7220 6f66 2063 6861 6e67 6573 2062  ler of changes b
+0000d510: 7920 6d65 7373 6167 696e 6720 7061 7373  y messaging pass
+0000d520: 696e 6720 7468 726f 7567 6820 5175 6575  ing through Queu
+0000d530: 6573 2c20 7768 6963 6820 7468 650a 2020  es, which the.  
+0000d540: 2020 5363 6865 6475 6c65 7220 6c69 7374    Scheduler list
+0000d550: 656e 7320 746f 2072 6573 706f 6e64 7320  ens to responds 
+0000d560: 6163 636f 7264 696e 676c 792e 0a0a 2020  accordingly...  
+0000d570: 2020 416c 6c20 6576 656e 7473 2061 7265    All events are
+0000d580: 2068 616e 646c 6564 2071 7569 636b 6c79   handled quickly
+0000d590: 2c20 696e 206c 696e 6561 7220 7469 6d65  , in linear time
+0000d5a0: 2077 6974 6820 7265 7370 6563 7420 746f   with respect to
+0000d5b0: 2074 6865 6972 0a20 2020 2069 6e70 7574   their.    input
+0000d5c0: 2028 7768 6963 6820 6973 206f 6674 656e   (which is often
+0000d5d0: 206f 6620 636f 6e73 7461 6e74 2073 697a   of constant siz
+0000d5e0: 6529 2061 6e64 2067 656e 6572 616c 6c79  e) and generally
+0000d5f0: 2077 6974 6869 6e20 610a 2020 2020 6d69   within a.    mi
+0000d600: 6c6c 6973 6563 6f6e 642e 0a0a 2020 2020  llisecond...    
+0000d610: 5573 6572 7320 7479 7069 6361 6c6c 7920  Users typically 
+0000d620: 646f 206e 6f74 2069 6e74 6572 6163 7420  do not interact 
+0000d630: 7769 7468 2060 6054 7261 6e73 6974 696f  with ``Transitio
+0000d640: 6e73 6060 2064 6972 6563 746c 792e 2049  ns`` directly. I
+0000d650: 6e73 7465 6164 0a20 2020 2075 7365 7273  nstead.    users
+0000d660: 2069 6e74 6572 6163 7420 7769 7468 2074   interact with t
+0000d670: 6865 2060 6043 6c69 656e 7460 602c 2077  he ``Client``, w
+0000d680: 6869 6368 2069 6e20 7475 726e 2065 6e67  hich in turn eng
+0000d690: 6167 6573 2074 6865 0a20 2020 2060 6053  ages the.    ``S
+0000d6a0: 6368 6564 756c 6572 6060 2061 6666 6563  cheduler`` affec
+0000d6b0: 7469 6e67 2064 6966 6665 7265 6e74 2074  ting different t
+0000d6c0: 7261 6e73 6974 696f 6e73 2068 6572 6520  ransitions here 
+0000d6d0: 756e 6465 722d 7468 652d 686f 6f64 2e20  under-the-hood. 
+0000d6e0: 496e 0a20 2020 2074 6865 2062 6163 6b67  In.    the backg
+0000d6f0: 726f 756e 6420 6060 576f 726b 6572 6060  round ``Worker``
+0000d700: 7320 616c 736f 2065 6e67 6167 6520 7769  s also engage wi
+0000d710: 7468 2074 6865 2060 6053 6368 6564 756c  th the ``Schedul
+0000d720: 6572 6060 0a20 2020 2061 6666 6563 7469  er``.    affecti
+0000d730: 6e67 2074 6865 7365 2073 7461 7465 2074  ng these state t
+0000d740: 7261 6e73 6974 696f 6e73 2061 7320 7765  ransitions as we
+0000d750: 6c6c 2e0a 2020 2020 2222 220a 0a20 2020  ll..    """..   
+0000d760: 2062 616e 6477 6964 7468 3a20 696e 740a   bandwidth: int.
+0000d770: 0a20 2020 2023 3a20 436c 6965 6e74 7320  .    #: Clients 
+0000d780: 6375 7272 656e 746c 7920 636f 6e6e 6563  currently connec
+0000d790: 7465 6420 746f 2074 6865 2073 6368 6564  ted to the sched
+0000d7a0: 756c 6572 0a20 2020 2063 6c69 656e 7473  uler.    clients
+0000d7b0: 3a20 6469 6374 5b73 7472 2c20 436c 6965  : dict[str, Clie
+0000d7c0: 6e74 5374 6174 655d 0a0a 2020 2020 6578  ntState]..    ex
+0000d7d0: 7465 6e73 696f 6e73 3a20 6469 6374 5b73  tensions: dict[s
+0000d7e0: 7472 2c20 416e 795d 2020 2320 544f 444f  tr, Any]  # TODO
+0000d7f0: 2077 7269 7465 2061 2073 6368 6564 756c   write a schedul
+0000d800: 6572 2065 7874 656e 7369 6f6e 2050 726f  er extension Pro
+0000d810: 746f 636f 6c0a 2020 2020 706c 7567 696e  tocol.    plugin
+0000d820: 733a 2064 6963 745b 7374 722c 2053 6368  s: dict[str, Sch
+0000d830: 6564 756c 6572 506c 7567 696e 5d0a 2020  edulerPlugin].  
+0000d840: 2020 686f 7374 5f69 6e66 6f3a 2064 6963    host_info: dic
+0000d850: 745b 7374 722c 2064 6963 745b 7374 722c  t[str, dict[str,
+0000d860: 2041 6e79 5d5d 0a0a 2020 2020 233a 2049   Any]]..    #: I
+0000d870: 6620 5472 7565 2c20 656e 6162 6c65 2065  f True, enable e
+0000d880: 7870 656e 7369 7665 2069 6e74 6572 6e61  xpensive interna
+0000d890: 6c20 636f 6e73 6973 7465 6e63 7920 6368  l consistency ch
+0000d8a0: 6563 6b2e 0a20 2020 2023 3a20 5479 7069  eck..    #: Typi
+0000d8b0: 6361 6c6c 7920 6469 7361 626c 6564 2069  cally disabled i
+0000d8c0: 6e20 7072 6f64 7563 7469 6f6e 2e0a 2020  n production..  
+0000d8d0: 2020 7661 6c69 6461 7465 3a20 626f 6f6c    validate: bool
+0000d8e0: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
+0000d8f0: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
+0000d900: 2020 2320 576f 726b 6572 732d 7265 6c61    # Workers-rela
+0000d910: 7465 6420 7374 6174 650a 2020 2020 2323  ted state.    ##
 0000d920: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000d930: 2323 0a0a 2020 2020 233a 2057 6f72 6b65  ##..    #: Worke
-0000d940: 7273 2063 7572 7265 6e74 6c79 2063 6f6e  rs currently con
-0000d950: 6e65 6374 6564 2074 6f20 7468 6520 7363  nected to the sc
-0000d960: 6865 6475 6c65 720a 2020 2020 233a 2028  heduler.    #: (
-0000d970: 6163 7475 616c 6c79 2061 2053 6f72 7465  actually a Sorte
-0000d980: 6444 6963 742c 2062 7574 2074 6865 2073  dDict, but the s
-0000d990: 6f72 7465 6463 6f6e 7461 696e 6572 7320  ortedcontainers 
-0000d9a0: 7061 636b 6167 6520 6973 6e27 7420 616e  package isn't an
-0000d9b0: 6e6f 7461 7465 6429 0a20 2020 2077 6f72  notated).    wor
-0000d9c0: 6b65 7273 3a20 6469 6374 5b73 7472 2c20  kers: dict[str, 
-0000d9d0: 576f 726b 6572 5374 6174 655d 0a20 2020  WorkerState].   
-0000d9e0: 2023 3a20 576f 726b 6572 207b 6e61 6d65   #: Worker {name
-0000d9f0: 3a20 6164 6472 6573 737d 0a20 2020 2061  : address}.    a
-0000da00: 6c69 6173 6573 3a20 6469 6374 5b48 6173  liases: dict[Has
-0000da10: 6861 626c 652c 2073 7472 5d0a 2020 2020  hable, str].    
-0000da20: 233a 2057 6f72 6b65 7273 2074 6861 7420  #: Workers that 
-0000da30: 6172 6520 6375 7272 656e 746c 7920 696e  are currently in
-0000da40: 2072 756e 6e69 6e67 2073 7461 7465 0a20   running state. 
-0000da50: 2020 2072 756e 6e69 6e67 3a20 7365 745b     running: set[
-0000da60: 576f 726b 6572 5374 6174 655d 0a20 2020  WorkerState].   
-0000da70: 2023 3a20 576f 726b 6572 7320 7468 6174   #: Workers that
-0000da80: 2061 7265 2063 7572 7265 6e74 6c79 2069   are currently i
-0000da90: 6e20 7275 6e6e 696e 6720 7374 6174 6520  n running state 
-0000daa0: 616e 6420 6e6f 7420 6675 6c6c 7920 7574  and not fully ut
-0000dab0: 696c 697a 6564 0a20 2020 2023 3a20 4465  ilized.    #: De
-0000dac0: 6669 6e69 7469 6f6e 2062 6173 6564 206f  finition based o
-0000dad0: 6e20 6f63 6375 7061 6e63 790a 2020 2020  n occupancy.    
-0000dae0: 233a 2028 6163 7475 616c 6c79 2061 2053  #: (actually a S
-0000daf0: 6f72 7465 6444 6963 742c 2062 7574 2074  ortedDict, but t
-0000db00: 6865 2073 6f72 7465 6463 6f6e 7461 696e  he sortedcontain
-0000db10: 6572 7320 7061 636b 6167 6520 6973 6e27  ers package isn'
-0000db20: 7420 616e 6e6f 7461 7465 6429 2e0a 2020  t annotated)..  
-0000db30: 2020 233a 204e 6f74 2074 6f20 6265 2063    #: Not to be c
-0000db40: 6f6e 6675 7365 6420 7769 7468 203a 6d65  onfused with :me
-0000db50: 7468 3a60 6973 5f69 646c 6560 2e0a 2020  th:`is_idle`..  
-0000db60: 2020 6964 6c65 3a20 6469 6374 5b73 7472    idle: dict[str
-0000db70: 2c20 576f 726b 6572 5374 6174 655d 0a20  , WorkerState]. 
-0000db80: 2020 2023 3a20 5369 6d69 6c61 7220 746f     #: Similar to
-0000db90: 2060 6964 6c65 600a 2020 2020 233a 2044   `idle`.    #: D
-0000dba0: 6566 696e 6974 696f 6e20 6261 7365 6420  efinition based 
-0000dbb0: 6f6e 2061 7373 6967 6e65 6420 7461 736b  on assigned task
-0000dbc0: 730a 2020 2020 6964 6c65 5f74 6173 6b5f  s.    idle_task_
-0000dbd0: 636f 756e 743a 2073 6574 5b57 6f72 6b65  count: set[Worke
-0000dbe0: 7253 7461 7465 5d0a 2020 2020 233a 2057  rState].    #: W
-0000dbf0: 6f72 6b65 7273 2074 6861 7420 6172 6520  orkers that are 
-0000dc00: 6675 6c6c 7920 7574 696c 697a 6564 2e20  fully utilized. 
-0000dc10: 4d61 7920 696e 636c 7564 6520 6e6f 6e2d  May include non-
-0000dc20: 7275 6e6e 696e 6720 776f 726b 6572 732e  running workers.
-0000dc30: 0a20 2020 2073 6174 7572 6174 6564 3a20  .    saturated: 
-0000dc40: 7365 745b 576f 726b 6572 5374 6174 655d  set[WorkerState]
-0000dc50: 0a20 2020 2023 3a20 4375 7272 656e 7420  .    #: Current 
-0000dc60: 6e75 6d62 6572 206f 6620 7468 7265 6164  number of thread
-0000dc70: 7320 6163 726f 7373 2061 6c6c 2077 6f72  s across all wor
-0000dc80: 6b65 7273 0a20 2020 2074 6f74 616c 5f6e  kers.    total_n
-0000dc90: 7468 7265 6164 733a 2069 6e74 0a20 2020  threads: int.   
-0000dca0: 2023 3a20 4869 7374 6f72 7920 6f66 206e   #: History of n
-0000dcb0: 756d 6265 7220 6f66 2074 6872 6561 6473  umber of threads
-0000dcc0: 0a20 2020 2023 3a20 2874 696d 6573 7461  .    #: (timesta
-0000dcd0: 6d70 2c20 6e65 7720 6e75 6d62 6572 206f  mp, new number o
-0000dce0: 6620 7468 7265 6164 7329 0a20 2020 2074  f threads).    t
-0000dcf0: 6f74 616c 5f6e 7468 7265 6164 735f 6869  otal_nthreads_hi
-0000dd00: 7374 6f72 793a 206c 6973 745b 7475 706c  story: list[tupl
-0000dd10: 655b 666c 6f61 742c 2069 6e74 5d5d 0a20  e[float, int]]. 
-0000dd20: 2020 2023 3a20 436c 7573 7465 722d 7769     #: Cluster-wi
-0000dd30: 6465 2072 6573 6f75 7263 6573 2e20 7b72  de resources. {r
-0000dd40: 6573 6f75 7263 6520 6e61 6d65 3a20 7b77  esource name: {w
-0000dd50: 6f72 6b65 7220 6164 6472 6573 733a 2061  orker address: a
-0000dd60: 6d6f 756e 747d 7d0a 2020 2020 7265 736f  mount}}.    reso
-0000dd70: 7572 6365 733a 2064 6963 745b 7374 722c  urces: dict[str,
-0000dd80: 2064 6963 745b 7374 722c 2066 6c6f 6174   dict[str, float
-0000dd90: 5d5d 0a0a 2020 2020 2323 2323 2323 2323  ]]..    ########
-0000dda0: 2323 2323 2323 2323 2323 2323 230a 2020  #############.  
-0000ddb0: 2020 2320 5461 736b 732d 7265 6c61 7465    # Tasks-relate
-0000ddc0: 6420 7374 6174 650a 2020 2020 2323 2323  d state.    ####
+0000d930: 2323 2323 230a 0a20 2020 2023 3a20 576f  #####..    #: Wo
+0000d940: 726b 6572 7320 6375 7272 656e 746c 7920  rkers currently 
+0000d950: 636f 6e6e 6563 7465 6420 746f 2074 6865  connected to the
+0000d960: 2073 6368 6564 756c 6572 0a20 2020 2023   scheduler.    #
+0000d970: 3a20 2861 6374 7561 6c6c 7920 6120 536f  : (actually a So
+0000d980: 7274 6564 4469 6374 2c20 6275 7420 7468  rtedDict, but th
+0000d990: 6520 736f 7274 6564 636f 6e74 6169 6e65  e sortedcontaine
+0000d9a0: 7273 2070 6163 6b61 6765 2069 736e 2774  rs package isn't
+0000d9b0: 2061 6e6e 6f74 6174 6564 290a 2020 2020   annotated).    
+0000d9c0: 776f 726b 6572 733a 2064 6963 745b 7374  workers: dict[st
+0000d9d0: 722c 2057 6f72 6b65 7253 7461 7465 5d0a  r, WorkerState].
+0000d9e0: 2020 2020 233a 2057 6f72 6b65 7220 7b6e      #: Worker {n
+0000d9f0: 616d 653a 2061 6464 7265 7373 7d0a 2020  ame: address}.  
+0000da00: 2020 616c 6961 7365 733a 2064 6963 745b    aliases: dict[
+0000da10: 4861 7368 6162 6c65 2c20 7374 725d 0a20  Hashable, str]. 
+0000da20: 2020 2023 3a20 576f 726b 6572 7320 7468     #: Workers th
+0000da30: 6174 2061 7265 2063 7572 7265 6e74 6c79  at are currently
+0000da40: 2069 6e20 7275 6e6e 696e 6720 7374 6174   in running stat
+0000da50: 650a 2020 2020 7275 6e6e 696e 673a 2073  e.    running: s
+0000da60: 6574 5b57 6f72 6b65 7253 7461 7465 5d0a  et[WorkerState].
+0000da70: 2020 2020 233a 2057 6f72 6b65 7273 2074      #: Workers t
+0000da80: 6861 7420 6172 6520 6375 7272 656e 746c  hat are currentl
+0000da90: 7920 696e 2072 756e 6e69 6e67 2073 7461  y in running sta
+0000daa0: 7465 2061 6e64 206e 6f74 2066 756c 6c79  te and not fully
+0000dab0: 2075 7469 6c69 7a65 640a 2020 2020 233a   utilized.    #:
+0000dac0: 2044 6566 696e 6974 696f 6e20 6261 7365   Definition base
+0000dad0: 6420 6f6e 206f 6363 7570 616e 6379 0a20  d on occupancy. 
+0000dae0: 2020 2023 3a20 2861 6374 7561 6c6c 7920     #: (actually 
+0000daf0: 6120 536f 7274 6564 4469 6374 2c20 6275  a SortedDict, bu
+0000db00: 7420 7468 6520 736f 7274 6564 636f 6e74  t the sortedcont
+0000db10: 6169 6e65 7273 2070 6163 6b61 6765 2069  ainers package i
+0000db20: 736e 2774 2061 6e6e 6f74 6174 6564 292e  sn't annotated).
+0000db30: 0a20 2020 2023 3a20 4e6f 7420 746f 2062  .    #: Not to b
+0000db40: 6520 636f 6e66 7573 6564 2077 6974 6820  e confused with 
+0000db50: 3a6d 6574 683a 6069 735f 6964 6c65 602e  :meth:`is_idle`.
+0000db60: 0a20 2020 2069 646c 653a 2064 6963 745b  .    idle: dict[
+0000db70: 7374 722c 2057 6f72 6b65 7253 7461 7465  str, WorkerState
+0000db80: 5d0a 2020 2020 233a 2053 696d 696c 6172  ].    #: Similar
+0000db90: 2074 6f20 6069 646c 6560 0a20 2020 2023   to `idle`.    #
+0000dba0: 3a20 4465 6669 6e69 7469 6f6e 2062 6173  : Definition bas
+0000dbb0: 6564 206f 6e20 6173 7369 676e 6564 2074  ed on assigned t
+0000dbc0: 6173 6b73 0a20 2020 2069 646c 655f 7461  asks.    idle_ta
+0000dbd0: 736b 5f63 6f75 6e74 3a20 7365 745b 576f  sk_count: set[Wo
+0000dbe0: 726b 6572 5374 6174 655d 0a20 2020 2023  rkerState].    #
+0000dbf0: 3a20 576f 726b 6572 7320 7468 6174 2061  : Workers that a
+0000dc00: 7265 2066 756c 6c79 2075 7469 6c69 7a65  re fully utilize
+0000dc10: 642e 204d 6179 2069 6e63 6c75 6465 206e  d. May include n
+0000dc20: 6f6e 2d72 756e 6e69 6e67 2077 6f72 6b65  on-running worke
+0000dc30: 7273 2e0a 2020 2020 7361 7475 7261 7465  rs..    saturate
+0000dc40: 643a 2073 6574 5b57 6f72 6b65 7253 7461  d: set[WorkerSta
+0000dc50: 7465 5d0a 2020 2020 233a 2043 7572 7265  te].    #: Curre
+0000dc60: 6e74 206e 756d 6265 7220 6f66 2074 6872  nt number of thr
+0000dc70: 6561 6473 2061 6372 6f73 7320 616c 6c20  eads across all 
+0000dc80: 776f 726b 6572 730a 2020 2020 746f 7461  workers.    tota
+0000dc90: 6c5f 6e74 6872 6561 6473 3a20 696e 740a  l_nthreads: int.
+0000dca0: 2020 2020 233a 2048 6973 746f 7279 206f      #: History o
+0000dcb0: 6620 6e75 6d62 6572 206f 6620 7468 7265  f number of thre
+0000dcc0: 6164 730a 2020 2020 233a 2028 7469 6d65  ads.    #: (time
+0000dcd0: 7374 616d 702c 206e 6577 206e 756d 6265  stamp, new numbe
+0000dce0: 7220 6f66 2074 6872 6561 6473 290a 2020  r of threads).  
+0000dcf0: 2020 746f 7461 6c5f 6e74 6872 6561 6473    total_nthreads
+0000dd00: 5f68 6973 746f 7279 3a20 6c69 7374 5b74  _history: list[t
+0000dd10: 7570 6c65 5b66 6c6f 6174 2c20 696e 745d  uple[float, int]
+0000dd20: 5d0a 2020 2020 233a 2043 6c75 7374 6572  ].    #: Cluster
+0000dd30: 2d77 6964 6520 7265 736f 7572 6365 732e  -wide resources.
+0000dd40: 207b 7265 736f 7572 6365 206e 616d 653a   {resource name:
+0000dd50: 207b 776f 726b 6572 2061 6464 7265 7373   {worker address
+0000dd60: 3a20 616d 6f75 6e74 7d7d 0a20 2020 2072  : amount}}.    r
+0000dd70: 6573 6f75 7263 6573 3a20 6469 6374 5b73  esources: dict[s
+0000dd80: 7472 2c20 6469 6374 5b73 7472 2c20 666c  tr, dict[str, fl
+0000dd90: 6f61 745d 5d0a 0a20 2020 2023 2323 2323  oat]]..    #####
+0000dda0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+0000ddb0: 0a20 2020 2023 2054 6173 6b73 2d72 656c  .    # Tasks-rel
+0000ddc0: 6174 6564 2073 7461 7465 0a20 2020 2023  ated state.    #
 0000ddd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000dde0: 230a 0a20 2020 2023 3a20 546f 7461 6c20  #..    #: Total 
-0000ddf0: 6e75 6d62 6572 206f 6620 7461 736b 7320  number of tasks 
-0000de00: 6576 6572 2070 726f 6365 7373 6564 0a20  ever processed. 
-0000de10: 2020 206e 5f74 6173 6b73 3a20 696e 740a     n_tasks: int.
-0000de20: 0a20 2020 2023 3a20 416c 6c20 7461 736b  .    #: All task
-0000de30: 7320 6375 7272 656e 746c 7920 6b6e 6f77  s currently know
-0000de40: 6e20 746f 2074 6865 2073 6368 6564 756c  n to the schedul
-0000de50: 6572 0a20 2020 2074 6173 6b73 3a20 6469  er.    tasks: di
-0000de60: 6374 5b4b 6579 2c20 5461 736b 5374 6174  ct[Key, TaskStat
-0000de70: 655d 0a0a 2020 2020 233a 2054 6173 6b73  e]..    #: Tasks
-0000de80: 2069 6e20 7468 6520 2271 7565 7565 6422   in the "queued"
-0000de90: 2073 7461 7465 2c20 6f72 6465 7265 6420   state, ordered 
-0000dea0: 6279 2070 7269 6f72 6974 790a 2020 2020  by priority.    
-0000deb0: 7175 6575 6564 3a20 4865 6170 5365 745b  queued: HeapSet[
-0000dec0: 5461 736b 5374 6174 655d 0a0a 2020 2020  TaskState]..    
-0000ded0: 233a 2054 6173 6b73 2069 6e20 7468 6520  #: Tasks in the 
-0000dee0: 226e 6f2d 776f 726b 6572 2220 7374 6174  "no-worker" stat
-0000def0: 650a 2020 2020 756e 7275 6e6e 6162 6c65  e.    unrunnable
-0000df00: 3a20 7365 745b 5461 736b 5374 6174 655d  : set[TaskState]
-0000df10: 0a0a 2020 2020 233a 2053 7562 7365 7420  ..    #: Subset 
-0000df20: 6f66 2074 6173 6b73 2074 6861 7420 6578  of tasks that ex
-0000df30: 6973 7420 696e 206d 656d 6f72 7920 6f6e  ist in memory on
-0000df40: 206d 6f72 6520 7468 616e 206f 6e65 2077   more than one w
-0000df50: 6f72 6b65 720a 2020 2020 7265 706c 6963  orker.    replic
-0000df60: 6174 6564 5f74 6173 6b73 3a20 7365 745b  ated_tasks: set[
-0000df70: 5461 736b 5374 6174 655d 0a0a 2020 2020  TaskState]..    
-0000df80: 233a 2054 6173 6b73 2077 6974 6820 756e  #: Tasks with un
-0000df90: 6b6e 6f77 6e20 6475 7261 7469 6f6e 2c20  known duration, 
-0000dfa0: 6772 6f75 7065 6420 6279 2070 7265 6669  grouped by prefi
-0000dfb0: 780a 2020 2020 233a 207b 7461 736b 2070  x.    #: {task p
-0000dfc0: 7265 6669 783a 207b 7473 2c20 7473 2c20  refix: {ts, ts, 
-0000dfd0: 2e2e 2e7d 7d0a 2020 2020 756e 6b6e 6f77  ...}}.    unknow
-0000dfe0: 6e5f 6475 7261 7469 6f6e 733a 2064 6963  n_durations: dic
-0000dff0: 745b 7374 722c 2073 6574 5b54 6173 6b53  t[str, set[TaskS
-0000e000: 7461 7465 5d5d 0a20 2020 2074 6173 6b5f  tate]].    task_
-0000e010: 6772 6f75 7073 3a20 6469 6374 5b73 7472  groups: dict[str
-0000e020: 2c20 5461 736b 4772 6f75 705d 0a20 2020  , TaskGroup].   
-0000e030: 2074 6173 6b5f 7072 6566 6978 6573 3a20   task_prefixes: 
-0000e040: 6469 6374 5b73 7472 2c20 5461 736b 5072  dict[str, TaskPr
-0000e050: 6566 6978 5d0a 2020 2020 7461 736b 5f6d  efix].    task_m
-0000e060: 6574 6164 6174 613a 2064 6963 745b 4b65  etadata: dict[Ke
-0000e070: 792c 2041 6e79 5d0a 0a20 2020 2023 2323  y, Any]..    ###
-0000e080: 2323 2323 2323 0a20 2020 2023 2048 6973  ######.    # His
-0000e090: 746f 7279 0a20 2020 2023 2323 2323 2323  tory.    #######
-0000e0a0: 2323 0a0a 2020 2020 233a 2048 6973 746f  ##..    #: Histo
-0000e0b0: 7279 206f 6620 636f 6d70 7574 6174 696f  ry of computatio
-0000e0c0: 6e73 2e0a 2020 2020 233a 2054 6865 206c  ns..    #: The l
-0000e0d0: 656e 6774 6820 6361 6e20 6265 2074 7765  ength can be twe
-0000e0e0: 616b 6564 2074 6872 6f75 6768 0a20 2020  aked through.   
-0000e0f0: 2023 3a20 6469 7374 7269 6275 7465 642e   #: distributed.
-0000e100: 6469 6167 6e6f 7374 6963 732e 636f 6d70  diagnostics.comp
-0000e110: 7574 6174 696f 6e73 2e6d 6178 2d68 6973  utations.max-his
-0000e120: 746f 7279 0a20 2020 2063 6f6d 7075 7461  tory.    computa
-0000e130: 7469 6f6e 733a 2064 6571 7565 5b43 6f6d  tions: deque[Com
-0000e140: 7075 7461 7469 6f6e 5d0a 0a20 2020 2023  putation]..    #
-0000e150: 3a20 4869 7374 6f72 7920 6f66 2065 7272  : History of err
-0000e160: 6564 2074 6173 6b73 2e0a 2020 2020 233a  ed tasks..    #:
-0000e170: 2054 6865 206c 656e 6774 6820 6361 6e20   The length can 
-0000e180: 6265 2074 7765 616b 6564 2074 6872 6f75  be tweaked throu
-0000e190: 6768 0a20 2020 2023 3a20 6469 7374 7269  gh.    #: distri
-0000e1a0: 6275 7465 642e 6469 6167 6e6f 7374 6963  buted.diagnostic
-0000e1b0: 732e 6572 7265 642d 7461 736b 732e 6d61  s.erred-tasks.ma
-0000e1c0: 782d 6869 7374 6f72 790a 2020 2020 6572  x-history.    er
-0000e1d0: 7265 645f 7461 736b 733a 2064 6571 7565  red_tasks: deque
-0000e1e0: 5b45 7272 6564 5461 736b 5d0a 0a20 2020  [ErredTask]..   
-0000e1f0: 2023 3a20 4869 7374 6f72 7920 6f66 2074   #: History of t
-0000e200: 6173 6b20 7374 6174 6520 7472 616e 7369  ask state transi
-0000e210: 7469 6f6e 732e 0a20 2020 2023 3a20 5468  tions..    #: Th
-0000e220: 6520 6c65 6e67 7468 2063 616e 2062 6520  e length can be 
-0000e230: 7477 6561 6b65 6420 7468 726f 7567 680a  tweaked through.
-0000e240: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
-0000e250: 6564 2e61 646d 696e 2e6c 6f77 2d6c 6576  ed.admin.low-lev
-0000e260: 656c 2d6c 6f67 2d6c 656e 6774 680a 2020  el-log-length.  
-0000e270: 2020 7472 616e 7369 7469 6f6e 5f6c 6f67    transition_log
-0000e280: 3a20 6465 7175 655b 5472 616e 7369 7469  : deque[Transiti
-0000e290: 6f6e 5d0a 0a20 2020 2023 3a20 546f 7461  on]..    #: Tota
-0000e2a0: 6c20 6e75 6d62 6572 206f 6620 7472 616e  l number of tran
-0000e2b0: 7369 7469 6f6e 7320 7369 6e63 6520 7468  sitions since th
-0000e2c0: 6520 636c 7573 7465 7220 7761 7320 7374  e cluster was st
-0000e2d0: 6172 7465 640a 2020 2020 7472 616e 7369  arted.    transi
-0000e2e0: 7469 6f6e 5f63 6f75 6e74 6572 3a20 696e  tion_counter: in
-0000e2f0: 740a 0a20 2020 2023 3a20 546f 7461 6c20  t..    #: Total 
-0000e300: 6e75 6d62 6572 206f 6620 7472 616e 7369  number of transi
-0000e310: 7469 6f6e 7320 6173 206f 6620 7468 6520  tions as of the 
-0000e320: 7072 6576 696f 7573 2063 616c 6c20 746f  previous call to
-0000e330: 2063 6865 636b 5f69 646c 6528 290a 2020   check_idle().  
-0000e340: 2020 5f69 646c 655f 7472 616e 7369 7469    _idle_transiti
-0000e350: 6f6e 5f63 6f75 6e74 6572 3a20 696e 740a  on_counter: int.
-0000e360: 0a20 2020 2023 3a20 5261 6973 6520 616e  .    #: Raise an
-0000e370: 2065 7272 6f72 2069 6620 7468 6520 3a61   error if the :a
-0000e380: 7474 723a 6074 7261 6e73 6974 696f 6e5f  ttr:`transition_
-0000e390: 636f 756e 7465 7260 2065 7665 7220 7265  counter` ever re
-0000e3a0: 6163 6865 7320 7468 6973 2076 616c 7565  aches this value
-0000e3b0: 2e0a 2020 2020 233a 2054 6869 7320 6973  ..    #: This is
-0000e3c0: 206d 6561 6e74 2066 6f72 2064 6562 7567   meant for debug
-0000e3d0: 6769 6e67 206f 6e6c 792c 2074 6f20 6361  ging only, to ca
-0000e3e0: 7463 6820 696e 6669 6e69 7465 2072 6563  tch infinite rec
-0000e3f0: 7572 7369 6f6e 206c 6f6f 7073 2e0a 2020  ursion loops..  
-0000e400: 2020 233a 2049 6e20 7072 6f64 7563 7469    #: In producti
-0000e410: 6f6e 2c20 6974 2073 686f 756c 6420 616c  on, it should al
-0000e420: 7761 7973 2062 6520 7365 7420 746f 2046  ways be set to F
-0000e430: 616c 7365 2e0a 2020 2020 7472 616e 7369  alse..    transi
-0000e440: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
-0000e450: 3a20 696e 7420 7c20 4c69 7465 7261 6c5b  : int | Literal[
-0000e460: 4661 6c73 655d 0a0a 2020 2020 5f74 6173  False]..    _tas
-0000e470: 6b5f 7072 6566 6978 5f63 6f75 6e74 5f67  k_prefix_count_g
-0000e480: 6c6f 6261 6c3a 2064 6566 6175 6c74 6469  lobal: defaultdi
-0000e490: 6374 5b73 7472 2c20 696e 745d 0a20 2020  ct[str, int].   
-0000e4a0: 205f 6e65 7477 6f72 6b5f 6f63 635f 676c   _network_occ_gl
-0000e4b0: 6f62 616c 3a20 666c 6f61 740a 2020 2020  obal: float.    
-0000e4c0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-0000e4d0: 2323 2323 2323 0a20 2020 2023 2043 6163  ######.    # Cac
-0000e4e0: 6865 6420 636f 6e66 6967 7572 6174 696f  hed configuratio
-0000e4f0: 6e0a 2020 2020 2323 2323 2323 2323 2323  n.    ##########
-0000e500: 2323 2323 2323 2323 2323 2323 0a0a 2020  ############..  
-0000e510: 2020 233a 2064 6973 7472 6962 7574 6564    #: distributed
-0000e520: 2e73 6368 6564 756c 6572 2e75 6e6b 6e6f  .scheduler.unkno
-0000e530: 776e 2d74 6173 6b2d 6475 7261 7469 6f6e  wn-task-duration
-0000e540: 0a20 2020 2055 4e4b 4e4f 574e 5f54 4153  .    UNKNOWN_TAS
-0000e550: 4b5f 4455 5241 5449 4f4e 3a20 666c 6f61  K_DURATION: floa
-0000e560: 740a 2020 2020 233a 2064 6973 7472 6962  t.    #: distrib
-0000e570: 7574 6564 2e77 6f72 6b65 722e 6d65 6d6f  uted.worker.memo
-0000e580: 7279 2e72 6563 656e 742d 746f 2d6f 6c64  ry.recent-to-old
-0000e590: 2d74 696d 650a 2020 2020 4d45 4d4f 5259  -time.    MEMORY
-0000e5a0: 5f52 4543 454e 545f 544f 5f4f 4c44 5f54  _RECENT_TO_OLD_T
-0000e5b0: 494d 453a 2066 6c6f 6174 0a20 2020 2023  IME: float.    #
-0000e5c0: 3a20 6469 7374 7269 6275 7465 642e 776f  : distributed.wo
-0000e5d0: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
-0000e5e0: 6c61 6e63 652e 6d65 6173 7572 650a 2020  lance.measure.  
-0000e5f0: 2020 4d45 4d4f 5259 5f52 4542 414c 414e    MEMORY_REBALAN
-0000e600: 4345 5f4d 4541 5355 5245 3a20 7374 720a  CE_MEASURE: str.
-0000e610: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
-0000e620: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
-0000e630: 2e72 6562 616c 616e 6365 2e73 656e 6465  .rebalance.sende
-0000e640: 722d 6d69 6e0a 2020 2020 4d45 4d4f 5259  r-min.    MEMORY
-0000e650: 5f52 4542 414c 414e 4345 5f53 454e 4445  _REBALANCE_SENDE
-0000e660: 525f 4d49 4e3a 2066 6c6f 6174 0a20 2020  R_MIN: float.   
-0000e670: 2023 3a20 6469 7374 7269 6275 7465 642e   #: distributed.
-0000e680: 776f 726b 6572 2e6d 656d 6f72 792e 7265  worker.memory.re
-0000e690: 6261 6c61 6e63 652e 7265 6369 7069 656e  balance.recipien
-0000e6a0: 742d 6d61 780a 2020 2020 4d45 4d4f 5259  t-max.    MEMORY
-0000e6b0: 5f52 4542 414c 414e 4345 5f52 4543 4950  _REBALANCE_RECIP
-0000e6c0: 4945 4e54 5f4d 4158 3a20 666c 6f61 740a  IENT_MAX: float.
-0000e6d0: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
-0000e6e0: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
-0000e6f0: 2e72 6562 616c 616e 6365 2e73 656e 6465  .rebalance.sende
-0000e700: 722d 7265 6369 7069 656e 742d 6761 7020  r-recipient-gap 
-0000e710: 2f20 320a 2020 2020 4d45 4d4f 5259 5f52  / 2.    MEMORY_R
-0000e720: 4542 414c 414e 4345 5f48 414c 465f 4741  EBALANCE_HALF_GA
-0000e730: 503a 2066 6c6f 6174 0a20 2020 2023 3a20  P: float.    #: 
-0000e740: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-0000e750: 6475 6c65 722e 776f 726b 6572 2d73 6174  duler.worker-sat
-0000e760: 7572 6174 696f 6e0a 2020 2020 574f 524b  uration.    WORK
-0000e770: 4552 5f53 4154 5552 4154 494f 4e3a 2066  ER_SATURATION: f
-0000e780: 6c6f 6174 0a0a 2020 2020 5f5f 736c 6f74  loat..    __slot
-0000e790: 735f 5f20 3d20 7475 706c 6528 5f5f 616e  s__ = tuple(__an
-0000e7a0: 6e6f 7461 7469 6f6e 735f 5f29 0a0a 2020  notations__)..  
-0000e7b0: 2020 6465 6620 5f5f 696e 6974 5f5f 280a    def __init__(.
-0000e7c0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-0000e7d0: 2020 2020 2020 616c 6961 7365 733a 2064        aliases: d
-0000e7e0: 6963 745b 4861 7368 6162 6c65 2c20 7374  ict[Hashable, st
-0000e7f0: 725d 2c0a 2020 2020 2020 2020 636c 6965  r],.        clie
-0000e800: 6e74 733a 2064 6963 745b 7374 722c 2043  nts: dict[str, C
-0000e810: 6c69 656e 7453 7461 7465 5d2c 0a20 2020  lientState],.   
-0000e820: 2020 2020 2077 6f72 6b65 7273 3a20 536f       workers: So
-0000e830: 7274 6564 4469 6374 5b73 7472 2c20 576f  rtedDict[str, Wo
-0000e840: 726b 6572 5374 6174 655d 2c0a 2020 2020  rkerState],.    
-0000e850: 2020 2020 686f 7374 5f69 6e66 6f3a 2064      host_info: d
-0000e860: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
-0000e870: 722c 2041 6e79 5d5d 2c0a 2020 2020 2020  r, Any]],.      
-0000e880: 2020 7265 736f 7572 6365 733a 2064 6963    resources: dic
-0000e890: 745b 7374 722c 2064 6963 745b 7374 722c  t[str, dict[str,
-0000e8a0: 2066 6c6f 6174 5d5d 2c0a 2020 2020 2020   float]],.      
-0000e8b0: 2020 7461 736b 733a 2064 6963 745b 4b65    tasks: dict[Ke
-0000e8c0: 792c 2054 6173 6b53 7461 7465 5d2c 0a20  y, TaskState],. 
-0000e8d0: 2020 2020 2020 2075 6e72 756e 6e61 626c         unrunnabl
-0000e8e0: 653a 2073 6574 5b54 6173 6b53 7461 7465  e: set[TaskState
-0000e8f0: 5d2c 0a20 2020 2020 2020 2071 7565 7565  ],.        queue
-0000e900: 643a 2048 6561 7053 6574 5b54 6173 6b53  d: HeapSet[TaskS
-0000e910: 7461 7465 5d2c 0a20 2020 2020 2020 2076  tate],.        v
-0000e920: 616c 6964 6174 653a 2062 6f6f 6c2c 0a20  alidate: bool,. 
-0000e930: 2020 2020 2020 2070 6c75 6769 6e73 3a20         plugins: 
-0000e940: 4974 6572 6162 6c65 5b53 6368 6564 756c  Iterable[Schedul
-0000e950: 6572 506c 7567 696e 5d20 3d20 2829 2c0a  erPlugin] = (),.
-0000e960: 2020 2020 2020 2020 7472 616e 7369 7469          transiti
-0000e970: 6f6e 5f63 6f75 6e74 6572 5f6d 6178 3a20  on_counter_max: 
-0000e980: 696e 7420 7c20 4c69 7465 7261 6c5b 4661  int | Literal[Fa
-0000e990: 6c73 655d 203d 2046 616c 7365 2c0a 2020  lse] = False,.  
-0000e9a0: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-0000e9b0: 416e 792c 2020 2320 5061 7373 6564 2076  Any,  # Passed v
-0000e9c0: 6572 6261 7469 6d20 746f 2053 6572 7665  erbatim to Serve
-0000e9d0: 722e 5f5f 696e 6974 5f5f 2829 0a20 2020  r.__init__().   
-0000e9e0: 2029 3a0a 2020 2020 2020 2020 6c6f 6767   ):.        logg
-0000e9f0: 6572 2e69 6e66 6f28 2253 7461 7465 2073  er.info("State s
-0000ea00: 7461 7274 2229 0a20 2020 2020 2020 2073  tart").        s
-0000ea10: 656c 662e 616c 6961 7365 7320 3d20 616c  elf.aliases = al
-0000ea20: 6961 7365 730a 2020 2020 2020 2020 7365  iases.        se
-0000ea30: 6c66 2e62 616e 6477 6964 7468 203d 2070  lf.bandwidth = p
-0000ea40: 6172 7365 5f62 7974 6573 2864 6173 6b2e  arse_bytes(dask.
-0000ea50: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-0000ea60: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-0000ea70: 722e 6261 6e64 7769 6474 6822 2929 0a20  r.bandwidth")). 
-0000ea80: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
-0000ea90: 6e74 7320 3d20 636c 6965 6e74 730a 2020  nts = clients.  
-0000eaa0: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-0000eab0: 7473 5b22 6669 7265 2d61 6e64 2d66 6f72  ts["fire-and-for
-0000eac0: 6765 7422 5d20 3d20 436c 6965 6e74 5374  get"] = ClientSt
-0000ead0: 6174 6528 2266 6972 652d 616e 642d 666f  ate("fire-and-fo
-0000eae0: 7267 6574 2229 0a20 2020 2020 2020 2073  rget").        s
-0000eaf0: 656c 662e 6578 7465 6e73 696f 6e73 203d  elf.extensions =
-0000eb00: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
-0000eb10: 2e68 6f73 745f 696e 666f 203d 2068 6f73  .host_info = hos
-0000eb20: 745f 696e 666f 0a20 2020 2020 2020 2073  t_info.        s
-0000eb30: 656c 662e 6964 6c65 203d 2053 6f72 7465  elf.idle = Sorte
-0000eb40: 6444 6963 7428 290a 2020 2020 2020 2020  dDict().        
-0000eb50: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
-0000eb60: 6f75 6e74 203d 2073 6574 2829 0a20 2020  ount = set().   
-0000eb70: 2020 2020 2073 656c 662e 6e5f 7461 736b       self.n_task
-0000eb80: 7320 3d20 300a 2020 2020 2020 2020 7365  s = 0.        se
-0000eb90: 6c66 2e72 6573 6f75 7263 6573 203d 2072  lf.resources = r
-0000eba0: 6573 6f75 7263 6573 0a20 2020 2020 2020  esources.       
-0000ebb0: 2073 656c 662e 7361 7475 7261 7465 6420   self.saturated 
-0000ebc0: 3d20 7365 7428 290a 2020 2020 2020 2020  = set().        
-0000ebd0: 7365 6c66 2e74 6173 6b73 203d 2074 6173  self.tasks = tas
-0000ebe0: 6b73 0a20 2020 2020 2020 2073 656c 662e  ks.        self.
-0000ebf0: 7265 706c 6963 6174 6564 5f74 6173 6b73  replicated_tasks
-0000ec00: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-0000ec10: 2074 7320 666f 7220 7473 2069 6e20 7365   ts for ts in se
-0000ec20: 6c66 2e74 6173 6b73 2e76 616c 7565 7328  lf.tasks.values(
-0000ec30: 2920 6966 206c 656e 2874 732e 7768 6f5f  ) if len(ts.who_
-0000ec40: 6861 7320 6f72 2028 2929 203e 2031 0a20  has or ()) > 1. 
-0000ec50: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0000ec60: 2073 656c 662e 636f 6d70 7574 6174 696f   self.computatio
-0000ec70: 6e73 203d 2064 6571 7565 280a 2020 2020  ns = deque(.    
-0000ec80: 2020 2020 2020 2020 6d61 786c 656e 3d64          maxlen=d
-0000ec90: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-0000eca0: 6469 7374 7269 6275 7465 642e 6469 6167  distributed.diag
-0000ecb0: 6e6f 7374 6963 732e 636f 6d70 7574 6174  nostics.computat
-0000ecc0: 696f 6e73 2e6d 6178 2d68 6973 746f 7279  ions.max-history
-0000ecd0: 2229 0a20 2020 2020 2020 2029 0a20 2020  ").        ).   
-0000ece0: 2020 2020 2073 656c 662e 6572 7265 645f       self.erred_
-0000ecf0: 7461 736b 7320 3d20 6465 7175 6528 0a20  tasks = deque(. 
-0000ed00: 2020 2020 2020 2020 2020 206d 6178 6c65             maxle
-0000ed10: 6e3d 6461 736b 2e63 6f6e 6669 672e 6765  n=dask.config.ge
-0000ed20: 7428 2264 6973 7472 6962 7574 6564 2e64  t("distributed.d
-0000ed30: 6961 676e 6f73 7469 6373 2e65 7272 6564  iagnostics.erred
-0000ed40: 2d74 6173 6b73 2e6d 6178 2d68 6973 746f  -tasks.max-histo
-0000ed50: 7279 2229 0a20 2020 2020 2020 2029 0a20  ry").        ). 
-0000ed60: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
-0000ed70: 5f67 726f 7570 7320 3d20 7b7d 0a20 2020  _groups = {}.   
-0000ed80: 2020 2020 2073 656c 662e 7461 736b 5f70       self.task_p
-0000ed90: 7265 6669 7865 7320 3d20 7b7d 0a20 2020  refixes = {}.   
-0000eda0: 2020 2020 2073 656c 662e 7461 736b 5f6d       self.task_m
-0000edb0: 6574 6164 6174 6120 3d20 7b7d 0a20 2020  etadata = {}.   
-0000edc0: 2020 2020 2073 656c 662e 746f 7461 6c5f       self.total_
-0000edd0: 6e74 6872 6561 6473 203d 2030 0a20 2020  nthreads = 0.   
-0000ede0: 2020 2020 2073 656c 662e 746f 7461 6c5f       self.total_
-0000edf0: 6e74 6872 6561 6473 5f68 6973 746f 7279  nthreads_history
-0000ee00: 203d 205b 2874 696d 6528 292c 2030 295d   = [(time(), 0)]
-0000ee10: 0a20 2020 2020 2020 2073 656c 662e 756e  .        self.un
-0000ee20: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 7320  known_durations 
-0000ee30: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
-0000ee40: 662e 7175 6575 6564 203d 2071 7565 7565  f.queued = queue
-0000ee50: 640a 2020 2020 2020 2020 7365 6c66 2e75  d.        self.u
-0000ee60: 6e72 756e 6e61 626c 6520 3d20 756e 7275  nrunnable = unru
-0000ee70: 6e6e 6162 6c65 0a20 2020 2020 2020 2073  nnable.        s
-0000ee80: 656c 662e 7661 6c69 6461 7465 203d 2076  elf.validate = v
-0000ee90: 616c 6964 6174 650a 2020 2020 2020 2020  alidate.        
-0000eea0: 7365 6c66 2e77 6f72 6b65 7273 203d 2077  self.workers = w
-0000eeb0: 6f72 6b65 7273 0a20 2020 2020 2020 2073  orkers.        s
-0000eec0: 656c 662e 5f74 6173 6b5f 7072 6566 6978  elf._task_prefix
-0000eed0: 5f63 6f75 6e74 5f67 6c6f 6261 6c20 3d20  _count_global = 
-0000eee0: 6465 6661 756c 7464 6963 7428 696e 7429  defaultdict(int)
-0000eef0: 0a20 2020 2020 2020 2073 656c 662e 5f6e  .        self._n
-0000ef00: 6574 776f 726b 5f6f 6363 5f67 6c6f 6261  etwork_occ_globa
-0000ef10: 6c20 3d20 302e 300a 2020 2020 2020 2020  l = 0.0.        
-0000ef20: 7365 6c66 2e72 756e 6e69 6e67 203d 207b  self.running = {
-0000ef30: 0a20 2020 2020 2020 2020 2020 2077 7320  .            ws 
-0000ef40: 666f 7220 7773 2069 6e20 7365 6c66 2e77  for ws in self.w
-0000ef50: 6f72 6b65 7273 2e76 616c 7565 7328 2920  orkers.values() 
-0000ef60: 6966 2077 732e 7374 6174 7573 203d 3d20  if ws.status == 
-0000ef70: 5374 6174 7573 2e72 756e 6e69 6e67 0a20  Status.running. 
-0000ef80: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-0000ef90: 2073 656c 662e 706c 7567 696e 7320 3d20   self.plugins = 
-0000efa0: 7b7d 2069 6620 6e6f 7420 706c 7567 696e  {} if not plugin
-0000efb0: 7320 656c 7365 207b 5f67 6574 5f70 6c75  s else {_get_plu
-0000efc0: 6769 6e5f 6e61 6d65 2870 293a 2070 2066  gin_name(p): p f
-0000efd0: 6f72 2070 2069 6e20 706c 7567 696e 737d  or p in plugins}
-0000efe0: 0a0a 2020 2020 2020 2020 7365 6c66 2e74  ..        self.t
-0000eff0: 7261 6e73 6974 696f 6e5f 6c6f 6720 3d20  ransition_log = 
-0000f000: 6465 7175 6528 0a20 2020 2020 2020 2020  deque(.         
-0000f010: 2020 206d 6178 6c65 6e3d 6461 736b 2e63     maxlen=dask.c
-0000f020: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
-0000f030: 6962 7574 6564 2e61 646d 696e 2e6c 6f77  ibuted.admin.low
-0000f040: 2d6c 6576 656c 2d6c 6f67 2d6c 656e 6774  -level-log-lengt
-0000f050: 6822 290a 2020 2020 2020 2020 290a 2020  h").        ).  
-0000f060: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
-0000f070: 6974 696f 6e5f 636f 756e 7465 7220 3d20  ition_counter = 
-0000f080: 300a 2020 2020 2020 2020 7365 6c66 2e5f  0.        self._
-0000f090: 6964 6c65 5f74 7261 6e73 6974 696f 6e5f  idle_transition_
-0000f0a0: 636f 756e 7465 7220 3d20 300a 2020 2020  counter = 0.    
-0000f0b0: 2020 2020 7365 6c66 2e74 7261 6e73 6974      self.transit
-0000f0c0: 696f 6e5f 636f 756e 7465 725f 6d61 7820  ion_counter_max 
-0000f0d0: 3d20 7472 616e 7369 7469 6f6e 5f63 6f75  = transition_cou
-0000f0e0: 6e74 6572 5f6d 6178 0a0a 2020 2020 2020  nter_max..      
-0000f0f0: 2020 2320 5661 7269 6162 6c65 7320 6672    # Variables fr
-0000f100: 6f6d 2064 6173 6b2e 636f 6e66 6967 2c20  om dask.config, 
-0000f110: 6361 6368 6564 2062 7920 5f5f 696e 6974  cached by __init
-0000f120: 5f5f 2066 6f72 2070 6572 666f 726d 616e  __ for performan
-0000f130: 6365 0a20 2020 2020 2020 2073 656c 662e  ce.        self.
-0000f140: 554e 4b4e 4f57 4e5f 5441 534b 5f44 5552  UNKNOWN_TASK_DUR
-0000f150: 4154 494f 4e20 3d20 7061 7273 655f 7469  ATION = parse_ti
-0000f160: 6d65 6465 6c74 6128 0a20 2020 2020 2020  medelta(.       
-0000f170: 2020 2020 2064 6173 6b2e 636f 6e66 6967       dask.config
-0000f180: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-0000f190: 642e 7363 6865 6475 6c65 722e 756e 6b6e  d.scheduler.unkn
-0000f1a0: 6f77 6e2d 7461 736b 2d64 7572 6174 696f  own-task-duratio
-0000f1b0: 6e22 290a 2020 2020 2020 2020 290a 2020  n").        ).  
-0000f1c0: 2020 2020 2020 7365 6c66 2e4d 454d 4f52        self.MEMOR
-0000f1d0: 595f 5245 4345 4e54 5f54 4f5f 4f4c 445f  Y_RECENT_TO_OLD_
-0000f1e0: 5449 4d45 203d 2070 6172 7365 5f74 696d  TIME = parse_tim
-0000f1f0: 6564 656c 7461 280a 2020 2020 2020 2020  edelta(.        
-0000f200: 2020 2020 6461 736b 2e63 6f6e 6669 672e      dask.config.
-0000f210: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-0000f220: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
-0000f230: 6563 656e 742d 746f 2d6f 6c64 2d74 696d  ecent-to-old-tim
-0000f240: 6522 290a 2020 2020 2020 2020 290a 2020  e").        ).  
-0000f250: 2020 2020 2020 7365 6c66 2e4d 454d 4f52        self.MEMOR
-0000f260: 595f 5245 4241 4c41 4e43 455f 4d45 4153  Y_REBALANCE_MEAS
-0000f270: 5552 4520 3d20 6461 736b 2e63 6f6e 6669  URE = dask.confi
-0000f280: 672e 6765 7428 0a20 2020 2020 2020 2020  g.get(.         
-0000f290: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
-0000f2a0: 776f 726b 6572 2e6d 656d 6f72 792e 7265  worker.memory.re
-0000f2b0: 6261 6c61 6e63 652e 6d65 6173 7572 6522  balance.measure"
-0000f2c0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-0000f2d0: 2020 2073 656c 662e 4d45 4d4f 5259 5f52     self.MEMORY_R
-0000f2e0: 4542 414c 414e 4345 5f53 454e 4445 525f  EBALANCE_SENDER_
-0000f2f0: 4d49 4e20 3d20 6461 736b 2e63 6f6e 6669  MIN = dask.confi
-0000f300: 672e 6765 7428 0a20 2020 2020 2020 2020  g.get(.         
-0000f310: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
-0000f320: 776f 726b 6572 2e6d 656d 6f72 792e 7265  worker.memory.re
-0000f330: 6261 6c61 6e63 652e 7365 6e64 6572 2d6d  balance.sender-m
-0000f340: 696e 220a 2020 2020 2020 2020 290a 2020  in".        ).  
-0000f350: 2020 2020 2020 7365 6c66 2e4d 454d 4f52        self.MEMOR
-0000f360: 595f 5245 4241 4c41 4e43 455f 5245 4349  Y_REBALANCE_RECI
-0000f370: 5049 454e 545f 4d41 5820 3d20 6461 736b  PIENT_MAX = dask
-0000f380: 2e63 6f6e 6669 672e 6765 7428 0a20 2020  .config.get(.   
-0000f390: 2020 2020 2020 2020 2022 6469 7374 7269           "distri
-0000f3a0: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
-0000f3b0: 6f72 792e 7265 6261 6c61 6e63 652e 7265  ory.rebalance.re
-0000f3c0: 6369 7069 656e 742d 6d61 7822 0a20 2020  cipient-max".   
-0000f3d0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
-0000f3e0: 656c 662e 4d45 4d4f 5259 5f52 4542 414c  elf.MEMORY_REBAL
-0000f3f0: 414e 4345 5f48 414c 465f 4741 5020 3d20  ANCE_HALF_GAP = 
-0000f400: 280a 2020 2020 2020 2020 2020 2020 6461  (.            da
-0000f410: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
-0000f420: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
-0000f430: 722e 6d65 6d6f 7279 2e72 6562 616c 616e  r.memory.rebalan
-0000f440: 6365 2e73 656e 6465 722d 7265 6369 7069  ce.sender-recipi
-0000f450: 656e 742d 6761 7022 290a 2020 2020 2020  ent-gap").      
-0000f460: 2020 2020 2020 2f20 322e 300a 2020 2020        / 2.0.    
-0000f470: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-0000f480: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
-0000f490: 4154 494f 4e20 3d20 6461 736b 2e63 6f6e  ATION = dask.con
-0000f4a0: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
-0000f4b0: 2020 2020 2022 6469 7374 7269 6275 7465       "distribute
-0000f4c0: 642e 7363 6865 6475 6c65 722e 776f 726b  d.scheduler.work
-0000f4d0: 6572 2d73 6174 7572 6174 696f 6e22 0a20  er-saturation". 
-0000f4e0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0000f4f0: 2069 6620 7365 6c66 2e57 4f52 4b45 525f   if self.WORKER_
-0000f500: 5341 5455 5241 5449 4f4e 203d 3d20 2269  SATURATION == "i
-0000f510: 6e66 223a 0a20 2020 2020 2020 2020 2020  nf":.           
-0000f520: 2023 2053 7065 6369 616c 2063 6173 6520   # Special case 
-0000f530: 6e65 6365 7373 6172 7920 6265 6361 7573  necessary becaus
-0000f540: 6520 7468 6572 6527 7320 6e6f 2077 6179  e there's no way
-0000f550: 2074 6f20 7061 7273 6520 6120 666c 6f61   to parse a floa
-0000f560: 7420 696e 6669 6e69 7479 0a20 2020 2020  t infinity.     
-0000f570: 2020 2020 2020 2023 2066 726f 6d20 6120         # from a 
-0000f580: 4441 534b 5f2a 2065 6e76 6972 6f6e 6d65  DASK_* environme
-0000f590: 6e74 2076 6172 6961 626c 650a 2020 2020  nt variable.    
-0000f5a0: 2020 2020 2020 2020 7365 6c66 2e57 4f52          self.WOR
-0000f5b0: 4b45 525f 5341 5455 5241 5449 4f4e 203d  KER_SATURATION =
-0000f5c0: 206d 6174 682e 696e 660a 2020 2020 2020   math.inf.      
-0000f5d0: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
-0000f5e0: 2020 206e 6f74 2069 7369 6e73 7461 6e63     not isinstanc
-0000f5f0: 6528 7365 6c66 2e57 4f52 4b45 525f 5341  e(self.WORKER_SA
-0000f600: 5455 5241 5449 4f4e 2c20 2869 6e74 2c20  TURATION, (int, 
-0000f610: 666c 6f61 7429 290a 2020 2020 2020 2020  float)).        
-0000f620: 2020 2020 6f72 2073 656c 662e 574f 524b      or self.WORK
-0000f630: 4552 5f53 4154 5552 4154 494f 4e20 3c3d  ER_SATURATION <=
-0000f640: 2030 0a20 2020 2020 2020 2029 3a0a 2020   0.        ):.  
-0000f650: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0000f660: 5661 6c75 6545 7272 6f72 2820 2023 2070  ValueError(  # p
-0000f670: 7261 676d 613a 206e 6f63 6f76 6572 0a20  ragma: nocover. 
-0000f680: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0000f690: 6064 6973 7472 6962 7574 6564 2e73 6368  `distributed.sch
-0000f6a0: 6564 756c 6572 2e77 6f72 6b65 722d 7361  eduler.worker-sa
-0000f6b0: 7475 7261 7469 6f6e 6020 6d75 7374 2062  turation` must b
-0000f6c0: 6520 6120 666c 6f61 7420 3e20 303b 2067  e a float > 0; g
-0000f6d0: 6f74 2022 0a20 2020 2020 2020 2020 2020  ot ".           
-0000f6e0: 2020 2020 202b 2072 6570 7228 7365 6c66       + repr(self
-0000f6f0: 2e57 4f52 4b45 525f 5341 5455 5241 5449  .WORKER_SATURATI
-0000f700: 4f4e 290a 2020 2020 2020 2020 2020 2020  ON).            
-0000f710: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
-0000f720: 0a20 2020 2064 6566 206d 656d 6f72 7928  .    def memory(
-0000f730: 7365 6c66 2920 2d3e 204d 656d 6f72 7953  self) -> MemoryS
-0000f740: 7461 7465 3a0a 2020 2020 2020 2020 7265  tate:.        re
-0000f750: 7475 726e 204d 656d 6f72 7953 7461 7465  turn MemoryState
-0000f760: 2e73 756d 282a 2877 2e6d 656d 6f72 7920  .sum(*(w.memory 
-0000f770: 666f 7220 7720 696e 2073 656c 662e 776f  for w in self.wo
-0000f780: 726b 6572 732e 7661 6c75 6573 2829 2929  rkers.values()))
-0000f790: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-0000f7a0: 2020 2020 6465 6620 5f5f 7064 6963 745f      def __pdict_
-0000f7b0: 5f28 7365 6c66 2920 2d3e 2064 6963 745b  _(self) -> dict[
-0000f7c0: 7374 722c 2041 6e79 5d3a 0a20 2020 2020  str, Any]:.     
-0000f7d0: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-0000f7e0: 2020 2020 2020 2020 2262 616e 6477 6964          "bandwid
-0000f7f0: 7468 223a 2073 656c 662e 6261 6e64 7769  th": self.bandwi
-0000f800: 6474 682c 0a20 2020 2020 2020 2020 2020  dth,.           
-0000f810: 2022 7265 736f 7572 6365 7322 3a20 7365   "resources": se
-0000f820: 6c66 2e72 6573 6f75 7263 6573 2c0a 2020  lf.resources,.  
-0000f830: 2020 2020 2020 2020 2020 2273 6174 7572            "satur
-0000f840: 6174 6564 223a 2073 656c 662e 7361 7475  ated": self.satu
-0000f850: 7261 7465 642c 0a20 2020 2020 2020 2020  rated,.         
-0000f860: 2020 2022 756e 7275 6e6e 6162 6c65 223a     "unrunnable":
-0000f870: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
-0000f880: 2c0a 2020 2020 2020 2020 2020 2020 2271  ,.            "q
-0000f890: 7565 7565 6422 3a20 7365 6c66 2e71 7565  ueued": self.que
-0000f8a0: 7565 642c 0a20 2020 2020 2020 2020 2020  ued,.           
-0000f8b0: 2022 6e5f 7461 736b 7322 3a20 7365 6c66   "n_tasks": self
-0000f8c0: 2e6e 5f74 6173 6b73 2c0a 2020 2020 2020  .n_tasks,.      
-0000f8d0: 2020 2020 2020 2275 6e6b 6e6f 776e 5f64        "unknown_d
-0000f8e0: 7572 6174 696f 6e73 223a 2073 656c 662e  urations": self.
-0000f8f0: 756e 6b6e 6f77 6e5f 6475 7261 7469 6f6e  unknown_duration
-0000f900: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0000f910: 7661 6c69 6461 7465 223a 2073 656c 662e  validate": self.
-0000f920: 7661 6c69 6461 7465 2c0a 2020 2020 2020  validate,.      
-0000f930: 2020 2020 2020 2274 6173 6b73 223a 2073        "tasks": s
-0000f940: 656c 662e 7461 736b 732c 0a20 2020 2020  elf.tasks,.     
-0000f950: 2020 2020 2020 2022 7461 736b 5f67 726f         "task_gro
-0000f960: 7570 7322 3a20 7365 6c66 2e74 6173 6b5f  ups": self.task_
-0000f970: 6772 6f75 7073 2c0a 2020 2020 2020 2020  groups,.        
-0000f980: 2020 2020 2274 6173 6b5f 7072 6566 6978      "task_prefix
-0000f990: 6573 223a 2073 656c 662e 7461 736b 5f70  es": self.task_p
-0000f9a0: 7265 6669 7865 732c 0a20 2020 2020 2020  refixes,.       
-0000f9b0: 2020 2020 2022 746f 7461 6c5f 6e74 6872       "total_nthr
-0000f9c0: 6561 6473 223a 2073 656c 662e 746f 7461  eads": self.tota
-0000f9d0: 6c5f 6e74 6872 6561 6473 2c0a 2020 2020  l_nthreads,.    
-0000f9e0: 2020 2020 2020 2020 2274 6f74 616c 5f6f          "total_o
-0000f9f0: 6363 7570 616e 6379 223a 2073 656c 662e  ccupancy": self.
-0000fa00: 746f 7461 6c5f 6f63 6375 7061 6e63 792c  total_occupancy,
-0000fa10: 0a20 2020 2020 2020 2020 2020 2022 6572  .            "er
-0000fa20: 7265 645f 7461 736b 7322 3a20 7365 6c66  red_tasks": self
-0000fa30: 2e65 7272 6564 5f74 6173 6b73 2c0a 2020  .erred_tasks,.  
-0000fa40: 2020 2020 2020 2020 2020 2265 7874 656e            "exten
-0000fa50: 7369 6f6e 7322 3a20 7365 6c66 2e65 7874  sions": self.ext
-0000fa60: 656e 7369 6f6e 732c 0a20 2020 2020 2020  ensions,.       
-0000fa70: 2020 2020 2022 636c 6965 6e74 7322 3a20       "clients": 
-0000fa80: 7365 6c66 2e63 6c69 656e 7473 2c0a 2020  self.clients,.  
-0000fa90: 2020 2020 2020 2020 2020 2277 6f72 6b65            "worke
-0000faa0: 7273 223a 2073 656c 662e 776f 726b 6572  rs": self.worker
-0000fab0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0000fac0: 6964 6c65 223a 2073 656c 662e 6964 6c65  idle": self.idle
-0000fad0: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
-0000fae0: 6f73 745f 696e 666f 223a 2073 656c 662e  ost_info": self.
-0000faf0: 686f 7374 5f69 6e66 6f2c 0a20 2020 2020  host_info,.     
-0000fb00: 2020 207d 0a0a 2020 2020 6465 6620 6e65     }..    def ne
-0000fb10: 775f 7461 736b 280a 2020 2020 2020 2020  w_task(.        
-0000fb20: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
-0000fb30: 793a 204b 6579 2c0a 2020 2020 2020 2020  y: Key,.        
-0000fb40: 7370 6563 3a20 545f 7275 6e73 7065 6320  spec: T_runspec 
-0000fb50: 7c20 4e6f 6e65 2c0a 2020 2020 2020 2020  | None,.        
-0000fb60: 7374 6174 653a 2054 6173 6b53 7461 7465  state: TaskState
-0000fb70: 5374 6174 652c 0a20 2020 2020 2020 2063  State,.        c
-0000fb80: 6f6d 7075 7461 7469 6f6e 3a20 436f 6d70  omputation: Comp
-0000fb90: 7574 6174 696f 6e20 7c20 4e6f 6e65 203d  utation | None =
-0000fba0: 204e 6f6e 652c 0a20 2020 2029 202d 3e20   None,.    ) -> 
-0000fbb0: 5461 736b 5374 6174 653a 0a20 2020 2020  TaskState:.     
-0000fbc0: 2020 2022 2222 4372 6561 7465 2061 206e     """Create a n
-0000fbd0: 6577 2074 6173 6b2c 2061 6e64 2061 7373  ew task, and ass
-0000fbe0: 6f63 6961 7465 6420 7374 6174 6573 2222  ociated states""
-0000fbf0: 220a 2020 2020 2020 2020 7473 203d 2054  ".        ts = T
-0000fc00: 6173 6b53 7461 7465 286b 6579 2c20 7370  askState(key, sp
-0000fc10: 6563 2c20 7374 6174 6529 0a0a 2020 2020  ec, state)..    
-0000fc20: 2020 2020 7072 6566 6978 5f6b 6579 203d      prefix_key =
-0000fc30: 206b 6579 5f73 706c 6974 286b 6579 290a   key_split(key).
-0000fc40: 2020 2020 2020 2020 7470 203d 2073 656c          tp = sel
-0000fc50: 662e 7461 736b 5f70 7265 6669 7865 732e  f.task_prefixes.
-0000fc60: 6765 7428 7072 6566 6978 5f6b 6579 290a  get(prefix_key).
-0000fc70: 2020 2020 2020 2020 6966 2074 7020 6973          if tp is
-0000fc80: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0000fc90: 2020 2073 656c 662e 7461 736b 5f70 7265     self.task_pre
-0000fca0: 6669 7865 735b 7072 6566 6978 5f6b 6579  fixes[prefix_key
-0000fcb0: 5d20 3d20 7470 203d 2054 6173 6b50 7265  ] = tp = TaskPre
-0000fcc0: 6669 7828 7072 6566 6978 5f6b 6579 290a  fix(prefix_key).
-0000fcd0: 2020 2020 2020 2020 7473 2e70 7265 6669          ts.prefi
-0000fce0: 7820 3d20 7470 0a0a 2020 2020 2020 2020  x = tp..        
-0000fcf0: 6772 6f75 705f 6b65 7920 3d20 7473 2e67  group_key = ts.g
-0000fd00: 726f 7570 5f6b 6579 0a20 2020 2020 2020  roup_key.       
-0000fd10: 2074 6720 3d20 7365 6c66 2e74 6173 6b5f   tg = self.task_
-0000fd20: 6772 6f75 7073 2e67 6574 2867 726f 7570  groups.get(group
-0000fd30: 5f6b 6579 290a 2020 2020 2020 2020 6966  _key).        if
-0000fd40: 2074 6720 6973 204e 6f6e 653a 0a20 2020   tg is None:.   
-0000fd50: 2020 2020 2020 2020 2073 656c 662e 7461           self.ta
-0000fd60: 736b 5f67 726f 7570 735b 6772 6f75 705f  sk_groups[group_
-0000fd70: 6b65 795d 203d 2074 6720 3d20 5461 736b  key] = tg = Task
-0000fd80: 4772 6f75 7028 6772 6f75 705f 6b65 7929  Group(group_key)
-0000fd90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000fda0: 636f 6d70 7574 6174 696f 6e3a 0a20 2020  computation:.   
-0000fdb0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-0000fdc0: 7075 7461 7469 6f6e 2e67 726f 7570 732e  putation.groups.
-0000fdd0: 6164 6428 7467 290a 2020 2020 2020 2020  add(tg).        
-0000fde0: 2020 2020 7467 2e70 7265 6669 7820 3d20      tg.prefix = 
-0000fdf0: 7470 0a20 2020 2020 2020 2020 2020 2074  tp.            t
-0000fe00: 702e 6772 6f75 7073 2e61 7070 656e 6428  p.groups.append(
-0000fe10: 7467 290a 2020 2020 2020 2020 7467 2e61  tg).        tg.a
-0000fe20: 6464 2874 7329 0a0a 2020 2020 2020 2020  dd(ts)..        
-0000fe30: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d20  self.tasks[key] 
-0000fe40: 3d20 7473 0a0a 2020 2020 2020 2020 7265  = ts..        re
-0000fe50: 7475 726e 2074 730a 0a20 2020 2064 6566  turn ts..    def
-0000fe60: 205f 636c 6561 725f 7461 736b 5f73 7461   _clear_task_sta
-0000fe70: 7465 2873 656c 6629 202d 3e20 4e6f 6e65  te(self) -> None
-0000fe80: 3a0a 2020 2020 2020 2020 6c6f 6767 6572  :.        logger
-0000fe90: 2e64 6562 7567 2822 436c 6561 7220 7461  .debug("Clear ta
-0000fea0: 736b 2073 7461 7465 2229 0a20 2020 2020  sk state").     
-0000feb0: 2020 2066 6f72 2063 6f6c 6c65 6374 696f     for collectio
-0000fec0: 6e20 696e 2028 0a20 2020 2020 2020 2020  n in (.         
-0000fed0: 2020 2073 656c 662e 756e 7275 6e6e 6162     self.unrunnab
-0000fee0: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
-0000fef0: 7365 6c66 2e65 7272 6564 5f74 6173 6b73  self.erred_tasks
-0000ff00: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
-0000ff10: 6c66 2e63 6f6d 7075 7461 7469 6f6e 732c  lf.computations,
-0000ff20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000ff30: 662e 7461 736b 5f70 7265 6669 7865 732c  f.task_prefixes,
-0000ff40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000ff50: 662e 7461 736b 5f67 726f 7570 732c 0a20  f.task_groups,. 
-0000ff60: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000ff70: 7461 736b 5f6d 6574 6164 6174 612c 0a20  task_metadata,. 
-0000ff80: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000ff90: 756e 6b6e 6f77 6e5f 6475 7261 7469 6f6e  unknown_duration
-0000ffa0: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
-0000ffb0: 656c 662e 7265 706c 6963 6174 6564 5f74  elf.replicated_t
-0000ffc0: 6173 6b73 2c0a 2020 2020 2020 2020 293a  asks,.        ):
-0000ffd0: 0a20 2020 2020 2020 2020 2020 2063 6f6c  .            col
-0000ffe0: 6c65 6374 696f 6e2e 636c 6561 7228 2920  lection.clear() 
-0000fff0: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-00010000: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00010010: 2020 2064 6566 2069 735f 6964 6c65 2873     def is_idle(s
-00010020: 656c 6629 202d 3e20 626f 6f6c 3a0a 2020  elf) -> bool:.  
-00010030: 2020 2020 2020 2222 2252 6574 7572 6e20        """Return 
-00010040: 5472 7565 2069 6666 2074 6865 7265 2061  True iff there a
-00010050: 7265 206e 6f20 7461 736b 7320 7468 6174  re no tasks that
-00010060: 2068 6176 656e 2774 2066 696e 6973 6865   haven't finishe
-00010070: 6420 636f 6d70 7574 696e 672e 0a0a 2020  d computing...  
-00010080: 2020 2020 2020 556e 6c69 6b65 2074 6573        Unlike tes
-00010090: 7469 6e67 2060 6073 656c 662e 746f 7461  ting ``self.tota
-000100a0: 6c5f 6f63 6375 7061 6e63 7960 602c 2074  l_occupancy``, t
-000100b0: 6869 7320 7072 6f70 6572 7479 2072 6574  his property ret
-000100c0: 7572 6e73 2046 616c 7365 2069 6620 7468  urns False if th
-000100d0: 6572 650a 2020 2020 2020 2020 6172 6520  ere.        are 
-000100e0: 6c6f 6e67 2d72 756e 6e69 6e67 2074 6173  long-running tas
-000100f0: 6b73 2c20 6e6f 2d77 6f72 6b65 722c 206f  ks, no-worker, o
-00010100: 7220 7175 6575 6564 2074 6173 6b73 2028  r queued tasks (
-00010110: 6475 6520 746f 206e 6f74 2068 6176 696e  due to not havin
-00010120: 6720 616e 790a 2020 2020 2020 2020 776f  g any.        wo
-00010130: 726b 6572 7329 2e0a 0a20 2020 2020 2020  rkers)...       
-00010140: 204e 6f74 2074 6f20 6265 2063 6f6e 6675   Not to be confu
-00010150: 7365 6420 7769 7468 2060 6069 646c 6560  sed with ``idle`
-00010160: 602e 0a20 2020 2020 2020 2022 2222 0a20  `..        """. 
-00010170: 2020 2020 2020 2072 6574 7572 6e20 616c         return al
-00010180: 6c28 7467 2e64 6f6e 6520 666f 7220 7467  l(tg.done for tg
-00010190: 2069 6e20 7365 6c66 2e74 6173 6b5f 6772   in self.task_gr
-000101a0: 6f75 7073 2e76 616c 7565 7328 2929 0a0a  oups.values())..
-000101b0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-000101c0: 2020 6465 6620 746f 7461 6c5f 6f63 6375    def total_occu
-000101d0: 7061 6e63 7928 7365 6c66 2920 2d3e 2066  pancy(self) -> f
-000101e0: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
-000101f0: 7475 726e 2073 656c 662e 5f63 616c 635f  turn self._calc_
-00010200: 6f63 6375 7061 6e63 7928 0a20 2020 2020  occupancy(.     
-00010210: 2020 2020 2020 2073 656c 662e 5f74 6173         self._tas
-00010220: 6b5f 7072 6566 6978 5f63 6f75 6e74 5f67  k_prefix_count_g
-00010230: 6c6f 6261 6c2c 0a20 2020 2020 2020 2020  lobal,.         
-00010240: 2020 2073 656c 662e 5f6e 6574 776f 726b     self._network
-00010250: 5f6f 6363 5f67 6c6f 6261 6c2c 0a20 2020  _occ_global,.   
-00010260: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-00010270: 5f63 616c 635f 6f63 6375 7061 6e63 7928  _calc_occupancy(
-00010280: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-00010290: 2020 2020 2020 2074 6173 6b5f 7072 6566         task_pref
-000102a0: 6978 5f63 6f75 6e74 3a20 6469 6374 5b73  ix_count: dict[s
-000102b0: 7472 2c20 696e 745d 2c0a 2020 2020 2020  tr, int],.      
-000102c0: 2020 6e65 7477 6f72 6b5f 6f63 633a 2066    network_occ: f
-000102d0: 6c6f 6174 2c0a 2020 2020 2920 2d3e 2066  loat,.    ) -> f
-000102e0: 6c6f 6174 3a0a 2020 2020 2020 2020 7265  loat:.        re
-000102f0: 7320 3d20 302e 300a 2020 2020 2020 2020  s = 0.0.        
-00010300: 666f 7220 7072 6566 6978 5f6e 616d 652c  for prefix_name,
-00010310: 2063 6f75 6e74 2069 6e20 7461 736b 5f70   count in task_p
-00010320: 7265 6669 785f 636f 756e 742e 6974 656d  refix_count.item
-00010330: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00010340: 2023 2054 4f44 4f3a 2044 6561 6c20 7769   # TODO: Deal wi
-00010350: 7468 2075 6e6b 6e6f 776e 2074 6173 6b73  th unknown tasks
-00010360: 2062 6574 7465 720a 2020 2020 2020 2020   better.        
-00010370: 2020 2020 7072 6566 6978 203d 2073 656c      prefix = sel
-00010380: 662e 7461 736b 5f70 7265 6669 7865 735b  f.task_prefixes[
-00010390: 7072 6566 6978 5f6e 616d 655d 0a20 2020  prefix_name].   
-000103a0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000103b0: 7072 6566 6978 2069 7320 6e6f 7420 4e6f  prefix is not No
-000103c0: 6e65 0a20 2020 2020 2020 2020 2020 2064  ne.            d
-000103d0: 7572 6174 696f 6e20 3d20 7072 6566 6978  uration = prefix
-000103e0: 2e64 7572 6174 696f 6e5f 6176 6572 6167  .duration_averag
-000103f0: 650a 2020 2020 2020 2020 2020 2020 6966  e.            if
-00010400: 2064 7572 6174 696f 6e20 3c20 303a 0a20   duration < 0:. 
-00010410: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00010420: 6620 7072 6566 6978 2e6d 6178 5f65 7865  f prefix.max_exe
-00010430: 635f 7469 6d65 203e 2030 3a0a 2020 2020  c_time > 0:.    
+0000dde0: 2323 2323 0a0a 2020 2020 233a 2054 6f74  ####..    #: Tot
+0000ddf0: 616c 206e 756d 6265 7220 6f66 2074 6173  al number of tas
+0000de00: 6b73 2065 7665 7220 7072 6f63 6573 7365  ks ever processe
+0000de10: 640a 2020 2020 6e5f 7461 736b 733a 2069  d.    n_tasks: i
+0000de20: 6e74 0a0a 2020 2020 233a 2041 6c6c 2074  nt..    #: All t
+0000de30: 6173 6b73 2063 7572 7265 6e74 6c79 206b  asks currently k
+0000de40: 6e6f 776e 2074 6f20 7468 6520 7363 6865  nown to the sche
+0000de50: 6475 6c65 720a 2020 2020 7461 736b 733a  duler.    tasks:
+0000de60: 2064 6963 745b 4b65 792c 2054 6173 6b53   dict[Key, TaskS
+0000de70: 7461 7465 5d0a 0a20 2020 2023 3a20 5461  tate]..    #: Ta
+0000de80: 736b 7320 696e 2074 6865 2022 7175 6575  sks in the "queu
+0000de90: 6564 2220 7374 6174 652c 206f 7264 6572  ed" state, order
+0000dea0: 6564 2062 7920 7072 696f 7269 7479 0a20  ed by priority. 
+0000deb0: 2020 2071 7565 7565 643a 2048 6561 7053     queued: HeapS
+0000dec0: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
+0000ded0: 2020 2023 3a20 5461 736b 7320 696e 2074     #: Tasks in t
+0000dee0: 6865 2022 6e6f 2d77 6f72 6b65 7222 2073  he "no-worker" s
+0000def0: 7461 7465 0a20 2020 2075 6e72 756e 6e61  tate.    unrunna
+0000df00: 626c 653a 2073 6574 5b54 6173 6b53 7461  ble: set[TaskSta
+0000df10: 7465 5d0a 0a20 2020 2023 3a20 5375 6273  te]..    #: Subs
+0000df20: 6574 206f 6620 7461 736b 7320 7468 6174  et of tasks that
+0000df30: 2065 7869 7374 2069 6e20 6d65 6d6f 7279   exist in memory
+0000df40: 206f 6e20 6d6f 7265 2074 6861 6e20 6f6e   on more than on
+0000df50: 6520 776f 726b 6572 0a20 2020 2072 6570  e worker.    rep
+0000df60: 6c69 6361 7465 645f 7461 736b 733a 2073  licated_tasks: s
+0000df70: 6574 5b54 6173 6b53 7461 7465 5d0a 0a20  et[TaskState].. 
+0000df80: 2020 2023 3a20 5461 736b 7320 7769 7468     #: Tasks with
+0000df90: 2075 6e6b 6e6f 776e 2064 7572 6174 696f   unknown duratio
+0000dfa0: 6e2c 2067 726f 7570 6564 2062 7920 7072  n, grouped by pr
+0000dfb0: 6566 6978 0a20 2020 2023 3a20 7b74 6173  efix.    #: {tas
+0000dfc0: 6b20 7072 6566 6978 3a20 7b74 732c 2074  k prefix: {ts, t
+0000dfd0: 732c 202e 2e2e 7d7d 0a20 2020 2075 6e6b  s, ...}}.    unk
+0000dfe0: 6e6f 776e 5f64 7572 6174 696f 6e73 3a20  nown_durations: 
+0000dff0: 6469 6374 5b73 7472 2c20 7365 745b 5461  dict[str, set[Ta
+0000e000: 736b 5374 6174 655d 5d0a 2020 2020 7461  skState]].    ta
+0000e010: 736b 5f67 726f 7570 733a 2064 6963 745b  sk_groups: dict[
+0000e020: 7374 722c 2054 6173 6b47 726f 7570 5d0a  str, TaskGroup].
+0000e030: 2020 2020 7461 736b 5f70 7265 6669 7865      task_prefixe
+0000e040: 733a 2064 6963 745b 7374 722c 2054 6173  s: dict[str, Tas
+0000e050: 6b50 7265 6669 785d 0a20 2020 2074 6173  kPrefix].    tas
+0000e060: 6b5f 6d65 7461 6461 7461 3a20 6469 6374  k_metadata: dict
+0000e070: 5b4b 6579 2c20 416e 795d 0a0a 2020 2020  [Key, Any]..    
+0000e080: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
+0000e090: 4869 7374 6f72 790a 2020 2020 2323 2323  History.    ####
+0000e0a0: 2323 2323 230a 0a20 2020 2023 3a20 4869  #####..    #: Hi
+0000e0b0: 7374 6f72 7920 6f66 2063 6f6d 7075 7461  story of computa
+0000e0c0: 7469 6f6e 732e 0a20 2020 2023 3a20 5468  tions..    #: Th
+0000e0d0: 6520 6c65 6e67 7468 2063 616e 2062 6520  e length can be 
+0000e0e0: 7477 6561 6b65 6420 7468 726f 7567 680a  tweaked through.
+0000e0f0: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
+0000e100: 6564 2e64 6961 676e 6f73 7469 6373 2e63  ed.diagnostics.c
+0000e110: 6f6d 7075 7461 7469 6f6e 732e 6d61 782d  omputations.max-
+0000e120: 6869 7374 6f72 790a 2020 2020 636f 6d70  history.    comp
+0000e130: 7574 6174 696f 6e73 3a20 6465 7175 655b  utations: deque[
+0000e140: 436f 6d70 7574 6174 696f 6e5d 0a0a 2020  Computation]..  
+0000e150: 2020 233a 2048 6973 746f 7279 206f 6620    #: History of 
+0000e160: 6572 7265 6420 7461 736b 732e 0a20 2020  erred tasks..   
+0000e170: 2023 3a20 5468 6520 6c65 6e67 7468 2063   #: The length c
+0000e180: 616e 2062 6520 7477 6561 6b65 6420 7468  an be tweaked th
+0000e190: 726f 7567 680a 2020 2020 233a 2064 6973  rough.    #: dis
+0000e1a0: 7472 6962 7574 6564 2e64 6961 676e 6f73  tributed.diagnos
+0000e1b0: 7469 6373 2e65 7272 6564 2d74 6173 6b73  tics.erred-tasks
+0000e1c0: 2e6d 6178 2d68 6973 746f 7279 0a20 2020  .max-history.   
+0000e1d0: 2065 7272 6564 5f74 6173 6b73 3a20 6465   erred_tasks: de
+0000e1e0: 7175 655b 4572 7265 6454 6173 6b5d 0a0a  que[ErredTask]..
+0000e1f0: 2020 2020 233a 2048 6973 746f 7279 206f      #: History o
+0000e200: 6620 7461 736b 2073 7461 7465 2074 7261  f task state tra
+0000e210: 6e73 6974 696f 6e73 2e0a 2020 2020 233a  nsitions..    #:
+0000e220: 2054 6865 206c 656e 6774 6820 6361 6e20   The length can 
+0000e230: 6265 2074 7765 616b 6564 2074 6872 6f75  be tweaked throu
+0000e240: 6768 0a20 2020 2023 3a20 6469 7374 7269  gh.    #: distri
+0000e250: 6275 7465 642e 6164 6d69 6e2e 6c6f 772d  buted.admin.low-
+0000e260: 6c65 7665 6c2d 6c6f 672d 6c65 6e67 7468  level-log-length
+0000e270: 0a20 2020 2074 7261 6e73 6974 696f 6e5f  .    transition_
+0000e280: 6c6f 673a 2064 6571 7565 5b54 7261 6e73  log: deque[Trans
+0000e290: 6974 696f 6e5d 0a0a 2020 2020 233a 2054  ition]..    #: T
+0000e2a0: 6f74 616c 206e 756d 6265 7220 6f66 2074  otal number of t
+0000e2b0: 7261 6e73 6974 696f 6e73 2073 696e 6365  ransitions since
+0000e2c0: 2074 6865 2063 6c75 7374 6572 2077 6173   the cluster was
+0000e2d0: 2073 7461 7274 6564 0a20 2020 2074 7261   started.    tra
+0000e2e0: 6e73 6974 696f 6e5f 636f 756e 7465 723a  nsition_counter:
+0000e2f0: 2069 6e74 0a0a 2020 2020 233a 2054 6f74   int..    #: Tot
+0000e300: 616c 206e 756d 6265 7220 6f66 2074 7261  al number of tra
+0000e310: 6e73 6974 696f 6e73 2061 7320 6f66 2074  nsitions as of t
+0000e320: 6865 2070 7265 7669 6f75 7320 6361 6c6c  he previous call
+0000e330: 2074 6f20 6368 6563 6b5f 6964 6c65 2829   to check_idle()
+0000e340: 0a20 2020 205f 6964 6c65 5f74 7261 6e73  .    _idle_trans
+0000e350: 6974 696f 6e5f 636f 756e 7465 723a 2069  ition_counter: i
+0000e360: 6e74 0a0a 2020 2020 233a 2052 6169 7365  nt..    #: Raise
+0000e370: 2061 6e20 6572 726f 7220 6966 2074 6865   an error if the
+0000e380: 203a 6174 7472 3a60 7472 616e 7369 7469   :attr:`transiti
+0000e390: 6f6e 5f63 6f75 6e74 6572 6020 6576 6572  on_counter` ever
+0000e3a0: 2072 6561 6368 6573 2074 6869 7320 7661   reaches this va
+0000e3b0: 6c75 652e 0a20 2020 2023 3a20 5468 6973  lue..    #: This
+0000e3c0: 2069 7320 6d65 616e 7420 666f 7220 6465   is meant for de
+0000e3d0: 6275 6767 696e 6720 6f6e 6c79 2c20 746f  bugging only, to
+0000e3e0: 2063 6174 6368 2069 6e66 696e 6974 6520   catch infinite 
+0000e3f0: 7265 6375 7273 696f 6e20 6c6f 6f70 732e  recursion loops.
+0000e400: 0a20 2020 2023 3a20 496e 2070 726f 6475  .    #: In produ
+0000e410: 6374 696f 6e2c 2069 7420 7368 6f75 6c64  ction, it should
+0000e420: 2061 6c77 6179 7320 6265 2073 6574 2074   always be set t
+0000e430: 6f20 4661 6c73 652e 0a20 2020 2074 7261  o False..    tra
+0000e440: 6e73 6974 696f 6e5f 636f 756e 7465 725f  nsition_counter_
+0000e450: 6d61 783a 2069 6e74 207c 204c 6974 6572  max: int | Liter
+0000e460: 616c 5b46 616c 7365 5d0a 0a20 2020 205f  al[False]..    _
+0000e470: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
+0000e480: 745f 676c 6f62 616c 3a20 6465 6661 756c  t_global: defaul
+0000e490: 7464 6963 745b 7374 722c 2069 6e74 5d0a  tdict[str, int].
+0000e4a0: 2020 2020 5f6e 6574 776f 726b 5f6f 6363      _network_occ
+0000e4b0: 5f67 6c6f 6261 6c3a 2066 6c6f 6174 0a20  _global: float. 
+0000e4c0: 2020 2023 2323 2323 2323 2323 2323 2323     #############
+0000e4d0: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
+0000e4e0: 4361 6368 6564 2063 6f6e 6669 6775 7261  Cached configura
+0000e4f0: 7469 6f6e 0a20 2020 2023 2323 2323 2323  tion.    #######
+0000e500: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+0000e510: 0a20 2020 2023 3a20 6469 7374 7269 6275  .    #: distribu
+0000e520: 7465 642e 7363 6865 6475 6c65 722e 756e  ted.scheduler.un
+0000e530: 6b6e 6f77 6e2d 7461 736b 2d64 7572 6174  known-task-durat
+0000e540: 696f 6e0a 2020 2020 554e 4b4e 4f57 4e5f  ion.    UNKNOWN_
+0000e550: 5441 534b 5f44 5552 4154 494f 4e3a 2066  TASK_DURATION: f
+0000e560: 6c6f 6174 0a20 2020 2023 3a20 6469 7374  loat.    #: dist
+0000e570: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
+0000e580: 656d 6f72 792e 7265 6365 6e74 2d74 6f2d  emory.recent-to-
+0000e590: 6f6c 642d 7469 6d65 0a20 2020 204d 454d  old-time.    MEM
+0000e5a0: 4f52 595f 5245 4345 4e54 5f54 4f5f 4f4c  ORY_RECENT_TO_OL
+0000e5b0: 445f 5449 4d45 3a20 666c 6f61 740a 2020  D_TIME: float.  
+0000e5c0: 2020 233a 2064 6973 7472 6962 7574 6564    #: distributed
+0000e5d0: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
+0000e5e0: 6562 616c 616e 6365 2e6d 6561 7375 7265  ebalance.measure
+0000e5f0: 0a20 2020 204d 454d 4f52 595f 5245 4241  .    MEMORY_REBA
+0000e600: 4c41 4e43 455f 4d45 4153 5552 453a 2073  LANCE_MEASURE: s
+0000e610: 7472 0a20 2020 2023 3a20 6469 7374 7269  tr.    #: distri
+0000e620: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+0000e630: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
+0000e640: 6e64 6572 2d6d 696e 0a20 2020 204d 454d  nder-min.    MEM
+0000e650: 4f52 595f 5245 4241 4c41 4e43 455f 5345  ORY_REBALANCE_SE
+0000e660: 4e44 4552 5f4d 494e 3a20 666c 6f61 740a  NDER_MIN: float.
+0000e670: 2020 2020 233a 2064 6973 7472 6962 7574      #: distribut
+0000e680: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+0000e690: 2e72 6562 616c 616e 6365 2e72 6563 6970  .rebalance.recip
+0000e6a0: 6965 6e74 2d6d 6178 0a20 2020 204d 454d  ient-max.    MEM
+0000e6b0: 4f52 595f 5245 4241 4c41 4e43 455f 5245  ORY_REBALANCE_RE
+0000e6c0: 4349 5049 454e 545f 4d41 583a 2066 6c6f  CIPIENT_MAX: flo
+0000e6d0: 6174 0a20 2020 2023 3a20 6469 7374 7269  at.    #: distri
+0000e6e0: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
+0000e6f0: 6f72 792e 7265 6261 6c61 6e63 652e 7365  ory.rebalance.se
+0000e700: 6e64 6572 2d72 6563 6970 6965 6e74 2d67  nder-recipient-g
+0000e710: 6170 202f 2032 0a20 2020 204d 454d 4f52  ap / 2.    MEMOR
+0000e720: 595f 5245 4241 4c41 4e43 455f 4841 4c46  Y_REBALANCE_HALF
+0000e730: 5f47 4150 3a20 666c 6f61 740a 2020 2020  _GAP: float.    
+0000e740: 233a 2064 6973 7472 6962 7574 6564 2e73  #: distributed.s
+0000e750: 6368 6564 756c 6572 2e77 6f72 6b65 722d  cheduler.worker-
+0000e760: 7361 7475 7261 7469 6f6e 0a20 2020 2057  saturation.    W
+0000e770: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
+0000e780: 3a20 666c 6f61 740a 0a20 2020 205f 5f73  : float..    __s
+0000e790: 6c6f 7473 5f5f 203d 2074 7570 6c65 285f  lots__ = tuple(_
+0000e7a0: 5f61 6e6e 6f74 6174 696f 6e73 5f5f 290a  _annotations__).
+0000e7b0: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+0000e7c0: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
+0000e7d0: 0a20 2020 2020 2020 2061 6c69 6173 6573  .        aliases
+0000e7e0: 3a20 6469 6374 5b48 6173 6861 626c 652c  : dict[Hashable,
+0000e7f0: 2073 7472 5d2c 0a20 2020 2020 2020 2063   str],.        c
+0000e800: 6c69 656e 7473 3a20 6469 6374 5b73 7472  lients: dict[str
+0000e810: 2c20 436c 6965 6e74 5374 6174 655d 2c0a  , ClientState],.
+0000e820: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
+0000e830: 2053 6f72 7465 6444 6963 745b 7374 722c   SortedDict[str,
+0000e840: 2057 6f72 6b65 7253 7461 7465 5d2c 0a20   WorkerState],. 
+0000e850: 2020 2020 2020 2068 6f73 745f 696e 666f         host_info
+0000e860: 3a20 6469 6374 5b73 7472 2c20 6469 6374  : dict[str, dict
+0000e870: 5b73 7472 2c20 416e 795d 5d2c 0a20 2020  [str, Any]],.   
+0000e880: 2020 2020 2072 6573 6f75 7263 6573 3a20       resources: 
+0000e890: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
+0000e8a0: 7472 2c20 666c 6f61 745d 5d2c 0a20 2020  tr, float]],.   
+0000e8b0: 2020 2020 2074 6173 6b73 3a20 6469 6374       tasks: dict
+0000e8c0: 5b4b 6579 2c20 5461 736b 5374 6174 655d  [Key, TaskState]
+0000e8d0: 2c0a 2020 2020 2020 2020 756e 7275 6e6e  ,.        unrunn
+0000e8e0: 6162 6c65 3a20 7365 745b 5461 736b 5374  able: set[TaskSt
+0000e8f0: 6174 655d 2c0a 2020 2020 2020 2020 7175  ate],.        qu
+0000e900: 6575 6564 3a20 4865 6170 5365 745b 5461  eued: HeapSet[Ta
+0000e910: 736b 5374 6174 655d 2c0a 2020 2020 2020  skState],.      
+0000e920: 2020 7661 6c69 6461 7465 3a20 626f 6f6c    validate: bool
+0000e930: 2c0a 2020 2020 2020 2020 706c 7567 696e  ,.        plugin
+0000e940: 733a 2049 7465 7261 626c 655b 5363 6865  s: Iterable[Sche
+0000e950: 6475 6c65 7250 6c75 6769 6e5d 203d 2028  dulerPlugin] = (
+0000e960: 292c 0a20 2020 2020 2020 2074 7261 6e73  ),.        trans
+0000e970: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
+0000e980: 783a 2069 6e74 207c 204c 6974 6572 616c  x: int | Literal
+0000e990: 5b46 616c 7365 5d20 3d20 4661 6c73 652c  [False] = False,
+0000e9a0: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
+0000e9b0: 733a 2041 6e79 2c20 2023 2050 6173 7365  s: Any,  # Passe
+0000e9c0: 6420 7665 7262 6174 696d 2074 6f20 5365  d verbatim to Se
+0000e9d0: 7276 6572 2e5f 5f69 6e69 745f 5f28 290a  rver.__init__().
+0000e9e0: 2020 2020 293a 0a20 2020 2020 2020 206c      ):.        l
+0000e9f0: 6f67 6765 722e 696e 666f 2822 5374 6174  ogger.info("Stat
+0000ea00: 6520 7374 6172 7422 290a 2020 2020 2020  e start").      
+0000ea10: 2020 7365 6c66 2e61 6c69 6173 6573 203d    self.aliases =
+0000ea20: 2061 6c69 6173 6573 0a20 2020 2020 2020   aliases.       
+0000ea30: 2073 656c 662e 6261 6e64 7769 6474 6820   self.bandwidth 
+0000ea40: 3d20 7061 7273 655f 6279 7465 7328 6461  = parse_bytes(da
+0000ea50: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
+0000ea60: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0000ea70: 756c 6572 2e62 616e 6477 6964 7468 2229  uler.bandwidth")
+0000ea80: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
+0000ea90: 6c69 656e 7473 203d 2063 6c69 656e 7473  lients = clients
+0000eaa0: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+0000eab0: 6965 6e74 735b 2266 6972 652d 616e 642d  ients["fire-and-
+0000eac0: 666f 7267 6574 225d 203d 2043 6c69 656e  forget"] = Clien
+0000ead0: 7453 7461 7465 2822 6669 7265 2d61 6e64  tState("fire-and
+0000eae0: 2d66 6f72 6765 7422 290a 2020 2020 2020  -forget").      
+0000eaf0: 2020 7365 6c66 2e65 7874 656e 7369 6f6e    self.extension
+0000eb00: 7320 3d20 7b7d 0a20 2020 2020 2020 2073  s = {}.        s
+0000eb10: 656c 662e 686f 7374 5f69 6e66 6f20 3d20  elf.host_info = 
+0000eb20: 686f 7374 5f69 6e66 6f0a 2020 2020 2020  host_info.      
+0000eb30: 2020 7365 6c66 2e69 646c 6520 3d20 536f    self.idle = So
+0000eb40: 7274 6564 4469 6374 2829 0a20 2020 2020  rtedDict().     
+0000eb50: 2020 2073 656c 662e 6964 6c65 5f74 6173     self.idle_tas
+0000eb60: 6b5f 636f 756e 7420 3d20 7365 7428 290a  k_count = set().
+0000eb70: 2020 2020 2020 2020 7365 6c66 2e6e 5f74          self.n_t
+0000eb80: 6173 6b73 203d 2030 0a20 2020 2020 2020  asks = 0.       
+0000eb90: 2073 656c 662e 7265 736f 7572 6365 7320   self.resources 
+0000eba0: 3d20 7265 736f 7572 6365 730a 2020 2020  = resources.    
+0000ebb0: 2020 2020 7365 6c66 2e73 6174 7572 6174      self.saturat
+0000ebc0: 6564 203d 2073 6574 2829 0a20 2020 2020  ed = set().     
+0000ebd0: 2020 2073 656c 662e 7461 736b 7320 3d20     self.tasks = 
+0000ebe0: 7461 736b 730a 2020 2020 2020 2020 7365  tasks.        se
+0000ebf0: 6c66 2e72 6570 6c69 6361 7465 645f 7461  lf.replicated_ta
+0000ec00: 736b 7320 3d20 7b0a 2020 2020 2020 2020  sks = {.        
+0000ec10: 2020 2020 7473 2066 6f72 2074 7320 696e      ts for ts in
+0000ec20: 2073 656c 662e 7461 736b 732e 7661 6c75   self.tasks.valu
+0000ec30: 6573 2829 2069 6620 6c65 6e28 7473 2e77  es() if len(ts.w
+0000ec40: 686f 5f68 6173 206f 7220 2829 2920 3e20  ho_has or ()) > 
+0000ec50: 310a 2020 2020 2020 2020 7d0a 2020 2020  1.        }.    
+0000ec60: 2020 2020 7365 6c66 2e63 6f6d 7075 7461      self.computa
+0000ec70: 7469 6f6e 7320 3d20 6465 7175 6528 0a20  tions = deque(. 
+0000ec80: 2020 2020 2020 2020 2020 206d 6178 6c65             maxle
+0000ec90: 6e3d 6461 736b 2e63 6f6e 6669 672e 6765  n=dask.config.ge
+0000eca0: 7428 2264 6973 7472 6962 7574 6564 2e64  t("distributed.d
+0000ecb0: 6961 676e 6f73 7469 6373 2e63 6f6d 7075  iagnostics.compu
+0000ecc0: 7461 7469 6f6e 732e 6d61 782d 6869 7374  tations.max-hist
+0000ecd0: 6f72 7922 290a 2020 2020 2020 2020 290a  ory").        ).
+0000ece0: 2020 2020 2020 2020 7365 6c66 2e65 7272          self.err
+0000ecf0: 6564 5f74 6173 6b73 203d 2064 6571 7565  ed_tasks = deque
+0000ed00: 280a 2020 2020 2020 2020 2020 2020 6d61  (.            ma
+0000ed10: 786c 656e 3d64 6173 6b2e 636f 6e66 6967  xlen=dask.config
+0000ed20: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0000ed30: 642e 6469 6167 6e6f 7374 6963 732e 6572  d.diagnostics.er
+0000ed40: 7265 642d 7461 736b 732e 6d61 782d 6869  red-tasks.max-hi
+0000ed50: 7374 6f72 7922 290a 2020 2020 2020 2020  story").        
+0000ed60: 290a 2020 2020 2020 2020 7365 6c66 2e74  ).        self.t
+0000ed70: 6173 6b5f 6772 6f75 7073 203d 207b 7d0a  ask_groups = {}.
+0000ed80: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0000ed90: 6b5f 7072 6566 6978 6573 203d 207b 7d0a  k_prefixes = {}.
+0000eda0: 2020 2020 2020 2020 7365 6c66 2e74 6173          self.tas
+0000edb0: 6b5f 6d65 7461 6461 7461 203d 207b 7d0a  k_metadata = {}.
+0000edc0: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
+0000edd0: 616c 5f6e 7468 7265 6164 7320 3d20 300a  al_nthreads = 0.
+0000ede0: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
+0000edf0: 616c 5f6e 7468 7265 6164 735f 6869 7374  al_nthreads_hist
+0000ee00: 6f72 7920 3d20 5b28 7469 6d65 2829 2c20  ory = [(time(), 
+0000ee10: 3029 5d0a 2020 2020 2020 2020 7365 6c66  0)].        self
+0000ee20: 2e75 6e6b 6e6f 776e 5f64 7572 6174 696f  .unknown_duratio
+0000ee30: 6e73 203d 207b 7d0a 2020 2020 2020 2020  ns = {}.        
+0000ee40: 7365 6c66 2e71 7565 7565 6420 3d20 7175  self.queued = qu
+0000ee50: 6575 6564 0a20 2020 2020 2020 2073 656c  eued.        sel
+0000ee60: 662e 756e 7275 6e6e 6162 6c65 203d 2075  f.unrunnable = u
+0000ee70: 6e72 756e 6e61 626c 650a 2020 2020 2020  nrunnable.      
+0000ee80: 2020 7365 6c66 2e76 616c 6964 6174 6520    self.validate 
+0000ee90: 3d20 7661 6c69 6461 7465 0a20 2020 2020  = validate.     
+0000eea0: 2020 2073 656c 662e 776f 726b 6572 7320     self.workers 
+0000eeb0: 3d20 776f 726b 6572 730a 2020 2020 2020  = workers.      
+0000eec0: 2020 7365 6c66 2e5f 7461 736b 5f70 7265    self._task_pre
+0000eed0: 6669 785f 636f 756e 745f 676c 6f62 616c  fix_count_global
+0000eee0: 203d 2064 6566 6175 6c74 6469 6374 2869   = defaultdict(i
+0000eef0: 6e74 290a 2020 2020 2020 2020 7365 6c66  nt).        self
+0000ef00: 2e5f 6e65 7477 6f72 6b5f 6f63 635f 676c  ._network_occ_gl
+0000ef10: 6f62 616c 203d 2030 2e30 0a20 2020 2020  obal = 0.0.     
+0000ef20: 2020 2073 656c 662e 7275 6e6e 696e 6720     self.running 
+0000ef30: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+0000ef40: 7773 2066 6f72 2077 7320 696e 2073 656c  ws for ws in sel
+0000ef50: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
+0000ef60: 2829 2069 6620 7773 2e73 7461 7475 7320  () if ws.status 
+0000ef70: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
+0000ef80: 670a 2020 2020 2020 2020 7d0a 2020 2020  g.        }.    
+0000ef90: 2020 2020 7365 6c66 2e70 6c75 6769 6e73      self.plugins
+0000efa0: 203d 207b 7d20 6966 206e 6f74 2070 6c75   = {} if not plu
+0000efb0: 6769 6e73 2065 6c73 6520 7b5f 6765 745f  gins else {_get_
+0000efc0: 706c 7567 696e 5f6e 616d 6528 7029 3a20  plugin_name(p): 
+0000efd0: 7020 666f 7220 7020 696e 2070 6c75 6769  p for p in plugi
+0000efe0: 6e73 7d0a 0a20 2020 2020 2020 2073 656c  ns}..        sel
+0000eff0: 662e 7472 616e 7369 7469 6f6e 5f6c 6f67  f.transition_log
+0000f000: 203d 2064 6571 7565 280a 2020 2020 2020   = deque(.      
+0000f010: 2020 2020 2020 6d61 786c 656e 3d64 6173        maxlen=das
+0000f020: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
+0000f030: 7374 7269 6275 7465 642e 6164 6d69 6e2e  stributed.admin.
+0000f040: 6c6f 772d 6c65 7665 6c2d 6c6f 672d 6c65  low-level-log-le
+0000f050: 6e67 7468 2229 0a20 2020 2020 2020 2029  ngth").        )
+0000f060: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
+0000f070: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+0000f080: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
+0000f090: 662e 5f69 646c 655f 7472 616e 7369 7469  f._idle_transiti
+0000f0a0: 6f6e 5f63 6f75 6e74 6572 203d 2030 0a20  on_counter = 0. 
+0000f0b0: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
+0000f0c0: 7369 7469 6f6e 5f63 6f75 6e74 6572 5f6d  sition_counter_m
+0000f0d0: 6178 203d 2074 7261 6e73 6974 696f 6e5f  ax = transition_
+0000f0e0: 636f 756e 7465 725f 6d61 780a 0a20 2020  counter_max..   
+0000f0f0: 2020 2020 2023 2056 6172 6961 626c 6573       # Variables
+0000f100: 2066 726f 6d20 6461 736b 2e63 6f6e 6669   from dask.confi
+0000f110: 672c 2063 6163 6865 6420 6279 205f 5f69  g, cached by __i
+0000f120: 6e69 745f 5f20 666f 7220 7065 7266 6f72  nit__ for perfor
+0000f130: 6d61 6e63 650a 2020 2020 2020 2020 7365  mance.        se
+0000f140: 6c66 2e55 4e4b 4e4f 574e 5f54 4153 4b5f  lf.UNKNOWN_TASK_
+0000f150: 4455 5241 5449 4f4e 203d 2070 6172 7365  DURATION = parse
+0000f160: 5f74 696d 6564 656c 7461 280a 2020 2020  _timedelta(.    
+0000f170: 2020 2020 2020 2020 6461 736b 2e63 6f6e          dask.con
+0000f180: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0000f190: 7574 6564 2e73 6368 6564 756c 6572 2e75  uted.scheduler.u
+0000f1a0: 6e6b 6e6f 776e 2d74 6173 6b2d 6475 7261  nknown-task-dura
+0000f1b0: 7469 6f6e 2229 0a20 2020 2020 2020 2029  tion").        )
+0000f1c0: 0a20 2020 2020 2020 2073 656c 662e 4d45  .        self.ME
+0000f1d0: 4d4f 5259 5f52 4543 454e 545f 544f 5f4f  MORY_RECENT_TO_O
+0000f1e0: 4c44 5f54 494d 4520 3d20 7061 7273 655f  LD_TIME = parse_
+0000f1f0: 7469 6d65 6465 6c74 6128 0a20 2020 2020  timedelta(.     
+0000f200: 2020 2020 2020 2064 6173 6b2e 636f 6e66         dask.conf
+0000f210: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+0000f220: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
+0000f230: 792e 7265 6365 6e74 2d74 6f2d 6f6c 642d  y.recent-to-old-
+0000f240: 7469 6d65 2229 0a20 2020 2020 2020 2029  time").        )
+0000f250: 0a20 2020 2020 2020 2073 656c 662e 4d45  .        self.ME
+0000f260: 4d4f 5259 5f52 4542 414c 414e 4345 5f4d  MORY_REBALANCE_M
+0000f270: 4541 5355 5245 203d 2064 6173 6b2e 636f  EASURE = dask.co
+0000f280: 6e66 6967 2e67 6574 280a 2020 2020 2020  nfig.get(.      
+0000f290: 2020 2020 2020 2264 6973 7472 6962 7574        "distribut
+0000f2a0: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+0000f2b0: 2e72 6562 616c 616e 6365 2e6d 6561 7375  .rebalance.measu
+0000f2c0: 7265 220a 2020 2020 2020 2020 290a 2020  re".        ).  
+0000f2d0: 2020 2020 2020 7365 6c66 2e4d 454d 4f52        self.MEMOR
+0000f2e0: 595f 5245 4241 4c41 4e43 455f 5345 4e44  Y_REBALANCE_SEND
+0000f2f0: 4552 5f4d 494e 203d 2064 6173 6b2e 636f  ER_MIN = dask.co
+0000f300: 6e66 6967 2e67 6574 280a 2020 2020 2020  nfig.get(.      
+0000f310: 2020 2020 2020 2264 6973 7472 6962 7574        "distribut
+0000f320: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+0000f330: 2e72 6562 616c 616e 6365 2e73 656e 6465  .rebalance.sende
+0000f340: 722d 6d69 6e22 0a20 2020 2020 2020 2029  r-min".        )
+0000f350: 0a20 2020 2020 2020 2073 656c 662e 4d45  .        self.ME
+0000f360: 4d4f 5259 5f52 4542 414c 414e 4345 5f52  MORY_REBALANCE_R
+0000f370: 4543 4950 4945 4e54 5f4d 4158 203d 2064  ECIPIENT_MAX = d
+0000f380: 6173 6b2e 636f 6e66 6967 2e67 6574 280a  ask.config.get(.
+0000f390: 2020 2020 2020 2020 2020 2020 2264 6973              "dis
+0000f3a0: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+0000f3b0: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
+0000f3c0: 2e72 6563 6970 6965 6e74 2d6d 6178 220a  .recipient-max".
+0000f3d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0000f3e0: 2020 7365 6c66 2e4d 454d 4f52 595f 5245    self.MEMORY_RE
+0000f3f0: 4241 4c41 4e43 455f 4841 4c46 5f47 4150  BALANCE_HALF_GAP
+0000f400: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0000f410: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
+0000f420: 2822 6469 7374 7269 6275 7465 642e 776f  ("distributed.wo
+0000f430: 726b 6572 2e6d 656d 6f72 792e 7265 6261  rker.memory.reba
+0000f440: 6c61 6e63 652e 7365 6e64 6572 2d72 6563  lance.sender-rec
+0000f450: 6970 6965 6e74 2d67 6170 2229 0a20 2020  ipient-gap").   
+0000f460: 2020 2020 2020 2020 202f 2032 2e30 0a20           / 2.0. 
+0000f470: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0000f480: 2020 7365 6c66 2e57 4f52 4b45 525f 5341    self.WORKER_SA
+0000f490: 5455 5241 5449 4f4e 203d 2064 6173 6b2e  TURATION = dask.
+0000f4a0: 636f 6e66 6967 2e67 6574 280a 2020 2020  config.get(.    
+0000f4b0: 2020 2020 2020 2020 2264 6973 7472 6962          "distrib
+0000f4c0: 7574 6564 2e73 6368 6564 756c 6572 2e77  uted.scheduler.w
+0000f4d0: 6f72 6b65 722d 7361 7475 7261 7469 6f6e  orker-saturation
+0000f4e0: 220a 2020 2020 2020 2020 290a 2020 2020  ".        ).    
+0000f4f0: 2020 2020 6966 2073 656c 662e 574f 524b      if self.WORK
+0000f500: 4552 5f53 4154 5552 4154 494f 4e20 3d3d  ER_SATURATION ==
+0000f510: 2022 696e 6622 3a0a 2020 2020 2020 2020   "inf":.        
+0000f520: 2020 2020 2320 5370 6563 6961 6c20 6361      # Special ca
+0000f530: 7365 206e 6563 6573 7361 7279 2062 6563  se necessary bec
+0000f540: 6175 7365 2074 6865 7265 2773 206e 6f20  ause there's no 
+0000f550: 7761 7920 746f 2070 6172 7365 2061 2066  way to parse a f
+0000f560: 6c6f 6174 2069 6e66 696e 6974 790a 2020  loat infinity.  
+0000f570: 2020 2020 2020 2020 2020 2320 6672 6f6d            # from
+0000f580: 2061 2044 4153 4b5f 2a20 656e 7669 726f   a DASK_* enviro
+0000f590: 6e6d 656e 7420 7661 7269 6162 6c65 0a20  nment variable. 
+0000f5a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000f5b0: 574f 524b 4552 5f53 4154 5552 4154 494f  WORKER_SATURATIO
+0000f5c0: 4e20 3d20 6d61 7468 2e69 6e66 0a20 2020  N = math.inf.   
+0000f5d0: 2020 2020 2069 6620 280a 2020 2020 2020       if (.      
+0000f5e0: 2020 2020 2020 6e6f 7420 6973 696e 7374        not isinst
+0000f5f0: 616e 6365 2873 656c 662e 574f 524b 4552  ance(self.WORKER
+0000f600: 5f53 4154 5552 4154 494f 4e2c 2028 696e  _SATURATION, (in
+0000f610: 742c 2066 6c6f 6174 2929 0a20 2020 2020  t, float)).     
+0000f620: 2020 2020 2020 206f 7220 7365 6c66 2e57         or self.W
+0000f630: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
+0000f640: 203c 3d20 300a 2020 2020 2020 2020 293a   <= 0.        ):
+0000f650: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000f660: 7365 2056 616c 7565 4572 726f 7228 2020  se ValueError(  
+0000f670: 2320 7072 6167 6d61 3a20 6e6f 636f 7665  # pragma: nocove
+0000f680: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+0000f690: 2020 2260 6469 7374 7269 6275 7465 642e    "`distributed.
+0000f6a0: 7363 6865 6475 6c65 722e 776f 726b 6572  scheduler.worker
+0000f6b0: 2d73 6174 7572 6174 696f 6e60 206d 7573  -saturation` mus
+0000f6c0: 7420 6265 2061 2066 6c6f 6174 203e 2030  t be a float > 0
+0000f6d0: 3b20 676f 7420 220a 2020 2020 2020 2020  ; got ".        
+0000f6e0: 2020 2020 2020 2020 2b20 7265 7072 2873          + repr(s
+0000f6f0: 656c 662e 574f 524b 4552 5f53 4154 5552  elf.WORKER_SATUR
+0000f700: 4154 494f 4e29 0a20 2020 2020 2020 2020  ATION).         
+0000f710: 2020 2029 0a0a 2020 2020 4070 726f 7065     )..    @prope
+0000f720: 7274 790a 2020 2020 6465 6620 6d65 6d6f  rty.    def memo
+0000f730: 7279 2873 656c 6629 202d 3e20 4d65 6d6f  ry(self) -> Memo
+0000f740: 7279 5374 6174 653a 0a20 2020 2020 2020  ryState:.       
+0000f750: 2072 6574 7572 6e20 4d65 6d6f 7279 5374   return MemorySt
+0000f760: 6174 652e 7375 6d28 2a28 772e 6d65 6d6f  ate.sum(*(w.memo
+0000f770: 7279 2066 6f72 2077 2069 6e20 7365 6c66  ry for w in self
+0000f780: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
+0000f790: 2929 290a 0a20 2020 2040 7072 6f70 6572  )))..    @proper
+0000f7a0: 7479 0a20 2020 2064 6566 205f 5f70 6469  ty.    def __pdi
+0000f7b0: 6374 5f5f 2873 656c 6629 202d 3e20 6469  ct__(self) -> di
+0000f7c0: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
+0000f7d0: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
+0000f7e0: 2020 2020 2020 2020 2020 2022 6261 6e64             "band
+0000f7f0: 7769 6474 6822 3a20 7365 6c66 2e62 616e  width": self.ban
+0000f800: 6477 6964 7468 2c0a 2020 2020 2020 2020  dwidth,.        
+0000f810: 2020 2020 2272 6573 6f75 7263 6573 223a      "resources":
+0000f820: 2073 656c 662e 7265 736f 7572 6365 732c   self.resources,
+0000f830: 0a20 2020 2020 2020 2020 2020 2022 7361  .            "sa
+0000f840: 7475 7261 7465 6422 3a20 7365 6c66 2e73  turated": self.s
+0000f850: 6174 7572 6174 6564 2c0a 2020 2020 2020  aturated,.      
+0000f860: 2020 2020 2020 2275 6e72 756e 6e61 626c        "unrunnabl
+0000f870: 6522 3a20 7365 6c66 2e75 6e72 756e 6e61  e": self.unrunna
+0000f880: 626c 652c 0a20 2020 2020 2020 2020 2020  ble,.           
+0000f890: 2022 7175 6575 6564 223a 2073 656c 662e   "queued": self.
+0000f8a0: 7175 6575 6564 2c0a 2020 2020 2020 2020  queued,.        
+0000f8b0: 2020 2020 226e 5f74 6173 6b73 223a 2073      "n_tasks": s
+0000f8c0: 656c 662e 6e5f 7461 736b 732c 0a20 2020  elf.n_tasks,.   
+0000f8d0: 2020 2020 2020 2020 2022 756e 6b6e 6f77           "unknow
+0000f8e0: 6e5f 6475 7261 7469 6f6e 7322 3a20 7365  n_durations": se
+0000f8f0: 6c66 2e75 6e6b 6e6f 776e 5f64 7572 6174  lf.unknown_durat
+0000f900: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+0000f910: 2020 2276 616c 6964 6174 6522 3a20 7365    "validate": se
+0000f920: 6c66 2e76 616c 6964 6174 652c 0a20 2020  lf.validate,.   
+0000f930: 2020 2020 2020 2020 2022 7461 736b 7322           "tasks"
+0000f940: 3a20 7365 6c66 2e74 6173 6b73 2c0a 2020  : self.tasks,.  
+0000f950: 2020 2020 2020 2020 2020 2274 6173 6b5f            "task_
+0000f960: 6772 6f75 7073 223a 2073 656c 662e 7461  groups": self.ta
+0000f970: 736b 5f67 726f 7570 732c 0a20 2020 2020  sk_groups,.     
+0000f980: 2020 2020 2020 2022 7461 736b 5f70 7265         "task_pre
+0000f990: 6669 7865 7322 3a20 7365 6c66 2e74 6173  fixes": self.tas
+0000f9a0: 6b5f 7072 6566 6978 6573 2c0a 2020 2020  k_prefixes,.    
+0000f9b0: 2020 2020 2020 2020 2274 6f74 616c 5f6e          "total_n
+0000f9c0: 7468 7265 6164 7322 3a20 7365 6c66 2e74  threads": self.t
+0000f9d0: 6f74 616c 5f6e 7468 7265 6164 732c 0a20  otal_nthreads,. 
+0000f9e0: 2020 2020 2020 2020 2020 2022 746f 7461             "tota
+0000f9f0: 6c5f 6f63 6375 7061 6e63 7922 3a20 7365  l_occupancy": se
+0000fa00: 6c66 2e74 6f74 616c 5f6f 6363 7570 616e  lf.total_occupan
+0000fa10: 6379 2c0a 2020 2020 2020 2020 2020 2020  cy,.            
+0000fa20: 2265 7272 6564 5f74 6173 6b73 223a 2073  "erred_tasks": s
+0000fa30: 656c 662e 6572 7265 645f 7461 736b 732c  elf.erred_tasks,
+0000fa40: 0a20 2020 2020 2020 2020 2020 2022 6578  .            "ex
+0000fa50: 7465 6e73 696f 6e73 223a 2073 656c 662e  tensions": self.
+0000fa60: 6578 7465 6e73 696f 6e73 2c0a 2020 2020  extensions,.    
+0000fa70: 2020 2020 2020 2020 2263 6c69 656e 7473          "clients
+0000fa80: 223a 2073 656c 662e 636c 6965 6e74 732c  ": self.clients,
+0000fa90: 0a20 2020 2020 2020 2020 2020 2022 776f  .            "wo
+0000faa0: 726b 6572 7322 3a20 7365 6c66 2e77 6f72  rkers": self.wor
+0000fab0: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
+0000fac0: 2020 2269 646c 6522 3a20 7365 6c66 2e69    "idle": self.i
+0000fad0: 646c 652c 0a20 2020 2020 2020 2020 2020  dle,.           
+0000fae0: 2022 686f 7374 5f69 6e66 6f22 3a20 7365   "host_info": se
+0000faf0: 6c66 2e68 6f73 745f 696e 666f 2c0a 2020  lf.host_info,.  
+0000fb00: 2020 2020 2020 7d0a 0a20 2020 2064 6566        }..    def
+0000fb10: 206e 6577 5f74 6173 6b28 0a20 2020 2020   new_task(.     
+0000fb20: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+0000fb30: 206b 6579 3a20 4b65 792c 0a20 2020 2020   key: Key,.     
+0000fb40: 2020 2073 7065 633a 2054 5f72 756e 7370     spec: T_runsp
+0000fb50: 6563 207c 204e 6f6e 652c 0a20 2020 2020  ec | None,.     
+0000fb60: 2020 2073 7461 7465 3a20 5461 736b 5374     state: TaskSt
+0000fb70: 6174 6553 7461 7465 2c0a 2020 2020 2020  ateState,.      
+0000fb80: 2020 636f 6d70 7574 6174 696f 6e3a 2043    computation: C
+0000fb90: 6f6d 7075 7461 7469 6f6e 207c 204e 6f6e  omputation | Non
+0000fba0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2920  e = None,.    ) 
+0000fbb0: 2d3e 2054 6173 6b53 7461 7465 3a0a 2020  -> TaskState:.  
+0000fbc0: 2020 2020 2020 2222 2243 7265 6174 6520        """Create 
+0000fbd0: 6120 6e65 7720 7461 736b 2c20 616e 6420  a new task, and 
+0000fbe0: 6173 736f 6369 6174 6564 2073 7461 7465  associated state
+0000fbf0: 7322 2222 0a20 2020 2020 2020 2074 7320  s""".        ts 
+0000fc00: 3d20 5461 736b 5374 6174 6528 6b65 792c  = TaskState(key,
+0000fc10: 2073 7065 632c 2073 7461 7465 290a 0a20   spec, state).. 
+0000fc20: 2020 2020 2020 2070 7265 6669 785f 6b65         prefix_ke
+0000fc30: 7920 3d20 6b65 795f 7370 6c69 7428 6b65  y = key_split(ke
+0000fc40: 7929 0a20 2020 2020 2020 2074 7020 3d20  y).        tp = 
+0000fc50: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
+0000fc60: 6573 2e67 6574 2870 7265 6669 785f 6b65  es.get(prefix_ke
+0000fc70: 7929 0a20 2020 2020 2020 2069 6620 7470  y).        if tp
+0000fc80: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0000fc90: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
+0000fca0: 7072 6566 6978 6573 5b70 7265 6669 785f  prefixes[prefix_
+0000fcb0: 6b65 795d 203d 2074 7020 3d20 5461 736b  key] = tp = Task
+0000fcc0: 5072 6566 6978 2870 7265 6669 785f 6b65  Prefix(prefix_ke
+0000fcd0: 7929 0a20 2020 2020 2020 2074 732e 7072  y).        ts.pr
+0000fce0: 6566 6978 203d 2074 700a 0a20 2020 2020  efix = tp..     
+0000fcf0: 2020 2067 726f 7570 5f6b 6579 203d 2074     group_key = t
+0000fd00: 732e 6772 6f75 705f 6b65 790a 2020 2020  s.group_key.    
+0000fd10: 2020 2020 7467 203d 2073 656c 662e 7461      tg = self.ta
+0000fd20: 736b 5f67 726f 7570 732e 6765 7428 6772  sk_groups.get(gr
+0000fd30: 6f75 705f 6b65 7929 0a20 2020 2020 2020  oup_key).       
+0000fd40: 2069 6620 7467 2069 7320 4e6f 6e65 3a0a   if tg is None:.
+0000fd50: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000fd60: 2e74 6173 6b5f 6772 6f75 7073 5b67 726f  .task_groups[gro
+0000fd70: 7570 5f6b 6579 5d20 3d20 7467 203d 2054  up_key] = tg = T
+0000fd80: 6173 6b47 726f 7570 2867 726f 7570 5f6b  askGroup(group_k
+0000fd90: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
+0000fda0: 6966 2063 6f6d 7075 7461 7469 6f6e 3a0a  if computation:.
+0000fdb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fdc0: 636f 6d70 7574 6174 696f 6e2e 6772 6f75  computation.grou
+0000fdd0: 7073 2e61 6464 2874 6729 0a20 2020 2020  ps.add(tg).     
+0000fde0: 2020 2020 2020 2074 672e 7072 6566 6978         tg.prefix
+0000fdf0: 203d 2074 700a 2020 2020 2020 2020 2020   = tp.          
+0000fe00: 2020 7470 2e67 726f 7570 732e 6170 7065    tp.groups.appe
+0000fe10: 6e64 2874 6729 0a20 2020 2020 2020 2074  nd(tg).        t
+0000fe20: 672e 6164 6428 7473 290a 0a20 2020 2020  g.add(ts)..     
+0000fe30: 2020 2073 656c 662e 7461 736b 735b 6b65     self.tasks[ke
+0000fe40: 795d 203d 2074 730a 0a20 2020 2020 2020  y] = ts..       
+0000fe50: 2072 6574 7572 6e20 7473 0a0a 2020 2020   return ts..    
+0000fe60: 6465 6620 5f63 6c65 6172 5f74 6173 6b5f  def _clear_task_
+0000fe70: 7374 6174 6528 7365 6c66 2920 2d3e 204e  state(self) -> N
+0000fe80: 6f6e 653a 0a20 2020 2020 2020 206c 6f67  one:.        log
+0000fe90: 6765 722e 6465 6275 6728 2243 6c65 6172  ger.debug("Clear
+0000fea0: 2074 6173 6b20 7374 6174 6522 290a 2020   task state").  
+0000feb0: 2020 2020 2020 666f 7220 636f 6c6c 6563        for collec
+0000fec0: 7469 6f6e 2069 6e20 280a 2020 2020 2020  tion in (.      
+0000fed0: 2020 2020 2020 7365 6c66 2e75 6e72 756e        self.unrun
+0000fee0: 6e61 626c 652c 0a20 2020 2020 2020 2020  nable,.         
+0000fef0: 2020 2073 656c 662e 6572 7265 645f 7461     self.erred_ta
+0000ff00: 736b 732c 0a20 2020 2020 2020 2020 2020  sks,.           
+0000ff10: 2073 656c 662e 636f 6d70 7574 6174 696f   self.computatio
+0000ff20: 6e73 2c0a 2020 2020 2020 2020 2020 2020  ns,.            
+0000ff30: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
+0000ff40: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
+0000ff50: 7365 6c66 2e74 6173 6b5f 6772 6f75 7073  self.task_groups
+0000ff60: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+0000ff70: 6c66 2e74 6173 6b5f 6d65 7461 6461 7461  lf.task_metadata
+0000ff80: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
+0000ff90: 6c66 2e75 6e6b 6e6f 776e 5f64 7572 6174  lf.unknown_durat
+0000ffa0: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+0000ffb0: 2020 7365 6c66 2e72 6570 6c69 6361 7465    self.replicate
+0000ffc0: 645f 7461 736b 732c 0a20 2020 2020 2020  d_tasks,.       
+0000ffd0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+0000ffe0: 636f 6c6c 6563 7469 6f6e 2e63 6c65 6172  collection.clear
+0000fff0: 2829 2020 2320 7479 7065 3a20 6967 6e6f  ()  # type: igno
+00010000: 7265 0a0a 2020 2020 4070 726f 7065 7274  re..    @propert
+00010010: 790a 2020 2020 6465 6620 6973 5f69 646c  y.    def is_idl
+00010020: 6528 7365 6c66 2920 2d3e 2062 6f6f 6c3a  e(self) -> bool:
+00010030: 0a20 2020 2020 2020 2022 2222 5265 7475  .        """Retu
+00010040: 726e 2054 7275 6520 6966 6620 7468 6572  rn True iff ther
+00010050: 6520 6172 6520 6e6f 2074 6173 6b73 2074  e are no tasks t
+00010060: 6861 7420 6861 7665 6e27 7420 6669 6e69  hat haven't fini
+00010070: 7368 6564 2063 6f6d 7075 7469 6e67 2e0a  shed computing..
+00010080: 0a20 2020 2020 2020 2055 6e6c 696b 6520  .        Unlike 
+00010090: 7465 7374 696e 6720 6060 7365 6c66 2e74  testing ``self.t
+000100a0: 6f74 616c 5f6f 6363 7570 616e 6379 6060  otal_occupancy``
+000100b0: 2c20 7468 6973 2070 726f 7065 7274 7920  , this property 
+000100c0: 7265 7475 726e 7320 4661 6c73 6520 6966  returns False if
+000100d0: 2074 6865 7265 0a20 2020 2020 2020 2061   there.        a
+000100e0: 7265 206c 6f6e 672d 7275 6e6e 696e 6720  re long-running 
+000100f0: 7461 736b 732c 206e 6f2d 776f 726b 6572  tasks, no-worker
+00010100: 2c20 6f72 2071 7565 7565 6420 7461 736b  , or queued task
+00010110: 7320 2864 7565 2074 6f20 6e6f 7420 6861  s (due to not ha
+00010120: 7669 6e67 2061 6e79 0a20 2020 2020 2020  ving any.       
+00010130: 2077 6f72 6b65 7273 292e 0a0a 2020 2020   workers)...    
+00010140: 2020 2020 4e6f 7420 746f 2062 6520 636f      Not to be co
+00010150: 6e66 7573 6564 2077 6974 6820 6060 6964  nfused with ``id
+00010160: 6c65 6060 2e0a 2020 2020 2020 2020 2222  le``..        ""
+00010170: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+00010180: 2061 6c6c 2874 672e 646f 6e65 2066 6f72   all(tg.done for
+00010190: 2074 6720 696e 2073 656c 662e 7461 736b   tg in self.task
+000101a0: 5f67 726f 7570 732e 7661 6c75 6573 2829  _groups.values()
+000101b0: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
+000101c0: 0a20 2020 2064 6566 2074 6f74 616c 5f6f  .    def total_o
+000101d0: 6363 7570 616e 6379 2873 656c 6629 202d  ccupancy(self) -
+000101e0: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
+000101f0: 2072 6574 7572 6e20 7365 6c66 2e5f 6361   return self._ca
+00010200: 6c63 5f6f 6363 7570 616e 6379 280a 2020  lc_occupancy(.  
+00010210: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00010220: 7461 736b 5f70 7265 6669 785f 636f 756e  task_prefix_coun
+00010230: 745f 676c 6f62 616c 2c0a 2020 2020 2020  t_global,.      
+00010240: 2020 2020 2020 7365 6c66 2e5f 6e65 7477        self._netw
+00010250: 6f72 6b5f 6f63 635f 676c 6f62 616c 2c0a  ork_occ_global,.
+00010260: 2020 2020 2020 2020 290a 0a20 2020 2064          )..    d
+00010270: 6566 205f 6361 6c63 5f6f 6363 7570 616e  ef _calc_occupan
+00010280: 6379 280a 2020 2020 2020 2020 7365 6c66  cy(.        self
+00010290: 2c0a 2020 2020 2020 2020 7461 736b 5f70  ,.        task_p
+000102a0: 7265 6669 785f 636f 756e 743a 2064 6963  refix_count: dic
+000102b0: 745b 7374 722c 2069 6e74 5d2c 0a20 2020  t[str, int],.   
+000102c0: 2020 2020 206e 6574 776f 726b 5f6f 6363       network_occ
+000102d0: 3a20 666c 6f61 742c 0a20 2020 2029 202d  : float,.    ) -
+000102e0: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
+000102f0: 2072 6573 203d 2030 2e30 0a20 2020 2020   res = 0.0.     
+00010300: 2020 2066 6f72 2070 7265 6669 785f 6e61     for prefix_na
+00010310: 6d65 2c20 636f 756e 7420 696e 2074 6173  me, count in tas
+00010320: 6b5f 7072 6566 6978 5f63 6f75 6e74 2e69  k_prefix_count.i
+00010330: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00010340: 2020 2020 2320 544f 444f 3a20 4465 616c      # TODO: Deal
+00010350: 2077 6974 6820 756e 6b6e 6f77 6e20 7461   with unknown ta
+00010360: 736b 7320 6265 7474 6572 0a20 2020 2020  sks better.     
+00010370: 2020 2020 2020 2070 7265 6669 7820 3d20         prefix = 
+00010380: 7365 6c66 2e74 6173 6b5f 7072 6566 6978  self.task_prefix
+00010390: 6573 5b70 7265 6669 785f 6e61 6d65 5d0a  es[prefix_name].
+000103a0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000103b0: 7274 2070 7265 6669 7820 6973 206e 6f74  rt prefix is not
+000103c0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+000103d0: 2020 6475 7261 7469 6f6e 203d 2070 7265    duration = pre
+000103e0: 6669 782e 6475 7261 7469 6f6e 5f61 7665  fix.duration_ave
+000103f0: 7261 6765 0a20 2020 2020 2020 2020 2020  rage.           
+00010400: 2069 6620 6475 7261 7469 6f6e 203c 2030   if duration < 0
+00010410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010420: 2020 6966 2070 7265 6669 782e 6d61 785f    if prefix.max_
+00010430: 6578 6563 5f74 696d 6520 3e20 303a 0a20  exec_time > 0:. 
 00010440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010450: 6475 7261 7469 6f6e 203d 2032 202a 2070  duration = 2 * p
-00010460: 7265 6669 782e 6d61 785f 6578 6563 5f74  refix.max_exec_t
-00010470: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
-00010480: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00010490: 2020 2020 2020 2020 2020 2020 2020 6475                du
-000104a0: 7261 7469 6f6e 203d 2073 656c 662e 554e  ration = self.UN
-000104b0: 4b4e 4f57 4e5f 5441 534b 5f44 5552 4154  KNOWN_TASK_DURAT
-000104c0: 494f 4e0a 2020 2020 2020 2020 2020 2020  ION.            
-000104d0: 7265 7320 2b3d 2064 7572 6174 696f 6e20  res += duration 
-000104e0: 2a20 636f 756e 740a 2020 2020 2020 2020  * count.        
-000104f0: 6f63 6320 3d20 7265 7320 2b20 6e65 7477  occ = res + netw
-00010500: 6f72 6b5f 6f63 6320 2f20 7365 6c66 2e62  ork_occ / self.b
-00010510: 616e 6477 6964 7468 0a20 2020 2020 2020  andwidth.       
-00010520: 2061 7373 6572 7420 6f63 6320 3e3d 2030   assert occ >= 0
-00010530: 2c20 286f 6363 2c20 7265 732c 206e 6574  , (occ, res, net
-00010540: 776f 726b 5f6f 6363 2c20 7365 6c66 2e62  work_occ, self.b
-00010550: 616e 6477 6964 7468 290a 2020 2020 2020  andwidth).      
-00010560: 2020 7265 7475 726e 206f 6363 0a0a 2020    return occ..  
-00010570: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
-00010580: 2323 2323 2323 230a 2020 2020 2320 5374  #######.    # St
-00010590: 6174 6520 5472 616e 7369 7469 6f6e 7320  ate Transitions 
-000105a0: 230a 2020 2020 2323 2323 2323 2323 2323  #.    ##########
-000105b0: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
-000105c0: 2064 6566 205f 7472 616e 7369 7469 6f6e   def _transition
-000105d0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-000105e0: 6b65 793a 204b 6579 2c20 6669 6e69 7368  key: Key, finish
-000105f0: 3a20 5461 736b 5374 6174 6553 7461 7465  : TaskStateState
-00010600: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-00010610: 7472 2c20 2a2a 6b77 6172 6773 3a20 416e  tr, **kwargs: An
-00010620: 790a 2020 2020 2920 2d3e 2052 6563 734d  y.    ) -> RecsM
-00010630: 7367 733a 0a20 2020 2020 2020 2022 2222  sgs:.        """
-00010640: 5472 616e 7369 7469 6f6e 2061 206b 6579  Transition a key
-00010650: 2066 726f 6d20 6974 7320 6375 7272 656e   from its curren
-00010660: 7420 7374 6174 6520 746f 2074 6865 2066  t state to the f
-00010670: 696e 6973 6820 7374 6174 650a 0a20 2020  inish state..   
-00010680: 2020 2020 2045 7861 6d70 6c65 730a 2020       Examples.  
-00010690: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-000106a0: 2020 2020 2020 203e 3e3e 2073 656c 662e         >>> self.
-000106b0: 5f74 7261 6e73 6974 696f 6e28 2778 272c  _transition('x',
-000106c0: 2027 7761 6974 696e 6727 290a 2020 2020   'waiting').    
-000106d0: 2020 2020 7b27 7827 3a20 2770 726f 6365      {'x': 'proce
-000106e0: 7373 696e 6727 7d2c 207b 7d2c 207b 7d0a  ssing'}, {}, {}.
-000106f0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-00010700: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00010710: 0a20 2020 2020 2020 2054 7570 6c65 206f  .        Tuple o
-00010720: 663a 0a0a 2020 2020 2020 2020 2d20 4469  f:..        - Di
-00010730: 6374 696f 6e61 7279 206f 6620 7265 636f  ctionary of reco
-00010740: 6d6d 656e 6461 7469 6f6e 7320 666f 7220  mmendations for 
-00010750: 6675 7475 7265 2074 7261 6e73 6974 696f  future transitio
-00010760: 6e73 207b 6b65 793a 206e 6577 2073 7461  ns {key: new sta
-00010770: 7465 7d0a 2020 2020 2020 2020 2d20 4d65  te}.        - Me
-00010780: 7373 6167 6573 2074 6f20 636c 6965 6e74  ssages to client
-00010790: 7320 7b63 6c69 656e 7420 6164 6472 6573  s {client addres
-000107a0: 733a 205b 6d73 672c 206d 7367 2c20 2e2e  s: [msg, msg, ..
-000107b0: 2e5d 7d0a 2020 2020 2020 2020 2d20 4d65  .]}.        - Me
-000107c0: 7373 6167 6573 2074 6f20 776f 726b 6572  ssages to worker
-000107d0: 7320 7b77 6f72 6b65 7220 6164 6472 6573  s {worker addres
-000107e0: 733a 205b 6d73 672c 206d 7367 2c20 2e2e  s: [msg, msg, ..
-000107f0: 2e5d 7d0a 0a20 2020 2020 2020 2053 6565  .]}..        See
-00010800: 2041 6c73 6f0a 2020 2020 2020 2020 2d2d   Also.        --
-00010810: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
-00010820: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
-00010830: 696f 6e73 203a 2074 7261 6e73 6974 6976  ions : transitiv
-00010840: 6520 7665 7273 696f 6e20 6f66 2074 6869  e version of thi
-00010850: 7320 6675 6e63 7469 6f6e 0a20 2020 2020  s function.     
-00010860: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
-00010870: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00010880: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
-00010890: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-000108a0: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
-000108b0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000108c0: 2020 2020 7265 7475 726e 207b 7d2c 207b      return {}, {
-000108d0: 7d2c 207b 7d0a 2020 2020 2020 2020 2020  }, {}.          
-000108e0: 2020 7374 6172 7420 3d20 7473 2e5f 7374    start = ts._st
-000108f0: 6174 650a 2020 2020 2020 2020 2020 2020  ate.            
-00010900: 6966 2073 7461 7274 203d 3d20 6669 6e69  if start == fini
-00010910: 7368 3a0a 2020 2020 2020 2020 2020 2020  sh:.            
-00010920: 2020 2020 7265 7475 726e 207b 7d2c 207b      return {}, {
-00010930: 7d2c 207b 7d0a 0a20 2020 2020 2020 2020  }, {}..         
-00010940: 2020 2023 204e 6f74 6573 3a0a 2020 2020     # Notes:.    
-00010950: 2020 2020 2020 2020 2320 2d20 696e 2063          # - in c
-00010960: 6173 6520 6f66 2074 7261 6e73 6974 696f  ase of transitio
-00010970: 6e20 7468 726f 7567 6820 7265 6c65 6173  n through releas
-00010980: 6564 2c20 7468 6973 2063 6f75 6e74 6572  ed, this counter
-00010990: 2069 7320 696e 6372 656d 656e 7465 6420   is incremented 
-000109a0: 6279 2032 0a20 2020 2020 2020 2020 2020  by 2.           
-000109b0: 2023 202d 2074 6869 7320 696e 6372 6561   # - this increa
-000109c0: 7365 2068 6170 7065 6e73 2062 6566 6f72  se happens befor
-000109d0: 6520 7468 6520 6163 7475 616c 2074 7261  e the actual tra
-000109e0: 6e73 6974 696f 6e73 2c20 736f 2074 6861  nsitions, so tha
-000109f0: 7420 6974 2063 616e 0a20 2020 2020 2020  t it can.       
-00010a00: 2020 2020 2023 2020 2063 6174 6368 2070       #   catch p
-00010a10: 6f74 656e 7469 616c 2069 6e66 696e 6974  otential infinit
-00010a20: 6520 7265 6375 7273 696f 6e73 0a20 2020  e recursions.   
-00010a30: 2020 2020 2020 2020 2073 656c 662e 7472           self.tr
-00010a40: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-00010a50: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
-00010a60: 2020 6966 2073 656c 662e 7472 616e 7369    if self.transi
-00010a70: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
-00010a80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00010a90: 2020 6173 7365 7274 2073 656c 662e 7472    assert self.tr
-00010aa0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
-00010ab0: 203c 2073 656c 662e 7472 616e 7369 7469   < self.transiti
-00010ac0: 6f6e 5f63 6f75 6e74 6572 5f6d 6178 0a0a  on_counter_max..
-00010ad0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-00010ae0: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
-00010af0: 7320 3d20 7b7d 0a20 2020 2020 2020 2020  s = {}.         
-00010b00: 2020 2077 6f72 6b65 725f 6d73 6773 3a20     worker_msgs: 
-00010b10: 4d73 6773 203d 207b 7d0a 2020 2020 2020  Msgs = {}.      
-00010b20: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
-00010b30: 733a 204d 7367 7320 3d20 7b7d 0a0a 2020  s: Msgs = {}..  
-00010b40: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00010b50: 662e 706c 7567 696e 733a 0a20 2020 2020  f.plugins:.     
-00010b60: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00010b70: 6465 6e74 7320 3d20 7365 7428 7473 2e64  dents = set(ts.d
-00010b80: 6570 656e 6465 6e74 7329 0a20 2020 2020  ependents).     
-00010b90: 2020 2020 2020 2020 2020 2064 6570 656e             depen
-00010ba0: 6465 6e63 6965 7320 3d20 7365 7428 7473  dencies = set(ts
-00010bb0: 2e64 6570 656e 6465 6e63 6965 7329 0a0a  .dependencies)..
-00010bc0: 2020 2020 2020 2020 2020 2020 6675 6e63              func
-00010bd0: 203d 2073 656c 662e 5f54 5241 4e53 4954   = self._TRANSIT
-00010be0: 494f 4e53 5f54 4142 4c45 2e67 6574 2828  IONS_TABLE.get((
-00010bf0: 7374 6172 742c 2066 696e 6973 6829 290a  start, finish)).
-00010c00: 2020 2020 2020 2020 2020 2020 6966 2066              if f
-00010c10: 756e 6320 6973 206e 6f74 204e 6f6e 653a  unc is not None:
-00010c20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010c30: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00010c40: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
-00010c50: 6f72 6b65 725f 6d73 6773 203d 2066 756e  orker_msgs = fun
-00010c60: 6328 0a20 2020 2020 2020 2020 2020 2020  c(.             
-00010c70: 2020 2020 2020 2073 656c 662c 206b 6579         self, key
-00010c80: 2c20 7374 696d 756c 7573 5f69 642c 202a  , stimulus_id, *
-00010c90: 2a6b 7761 7267 730a 2020 2020 2020 2020  *kwargs.        
-00010ca0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00010cb0: 2020 2020 2020 2065 6c69 6620 2272 656c         elif "rel
-00010cc0: 6561 7365 6422 206e 6f74 2069 6e20 2873  eased" not in (s
-00010cd0: 7461 7274 2c20 6669 6e69 7368 293a 0a20  tart, finish):. 
-00010ce0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00010cf0: 7373 6572 7420 6e6f 7420 6b77 6172 6773  ssert not kwargs
-00010d00: 2c20 286b 7761 7267 732c 2073 7461 7274  , (kwargs, start
-00010d10: 2c20 6669 6e69 7368 290a 2020 2020 2020  , finish).      
-00010d20: 2020 2020 2020 2020 2020 615f 7265 6373            a_recs
-00010d30: 2c20 615f 636d 7367 732c 2061 5f77 6d73  , a_cmsgs, a_wms
-00010d40: 6773 203d 2073 656c 662e 5f74 7261 6e73  gs = self._trans
-00010d50: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
-00010d60: 2020 2020 2020 2020 2020 206b 6579 2c20             key, 
-00010d70: 2272 656c 6561 7365 6422 2c20 7374 696d  "released", stim
-00010d80: 756c 7573 5f69 640a 2020 2020 2020 2020  ulus_id.        
-00010d90: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00010da0: 2020 2020 2020 2020 2020 2076 203d 2061             v = a
-00010db0: 5f72 6563 732e 6765 7428 6b65 792c 2066  _recs.get(key, f
-00010dc0: 696e 6973 6829 0a20 2020 2020 2020 2020  inish).         
-00010dd0: 2020 2020 2020 2023 2054 6865 2069 6e6e         # The inn
-00010de0: 6572 2072 6563 2068 6173 2068 6967 6865  er rec has highe
-00010df0: 7220 7072 696f 7269 7479 3f20 4973 2074  r priority? Is t
-00010e00: 6861 7420 616c 7761 7973 2064 6573 6972  hat always desir
-00010e10: 6564 3f0a 2020 2020 2020 2020 2020 2020  ed?.            
-00010e20: 2020 2020 6675 6e63 203d 2073 656c 662e      func = self.
-00010e30: 5f54 5241 4e53 4954 494f 4e53 5f54 4142  _TRANSITIONS_TAB
-00010e40: 4c45 5b22 7265 6c65 6173 6564 222c 2076  LE["released", v
-00010e50: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00010e60: 2020 625f 7265 6373 2c20 625f 636d 7367    b_recs, b_cmsg
-00010e70: 732c 2062 5f77 6d73 6773 203d 2066 756e  s, b_wmsgs = fun
-00010e80: 6328 7365 6c66 2c20 6b65 792c 2073 7469  c(self, key, sti
-00010e90: 6d75 6c75 735f 6964 290a 0a20 2020 2020  mulus_id)..     
-00010ea0: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00010eb0: 6d65 6e64 6174 696f 6e73 2e75 7064 6174  mendations.updat
-00010ec0: 6528 615f 7265 6373 290a 2020 2020 2020  e(a_recs).      
-00010ed0: 2020 2020 2020 2020 2020 666f 7220 632c            for c,
-00010ee0: 206e 6577 5f6d 7367 7320 696e 2061 5f63   new_msgs in a_c
-00010ef0: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
-00010f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010f10: 2020 636c 6965 6e74 5f6d 7367 732e 7365    client_msgs.se
-00010f20: 7464 6566 6175 6c74 2863 2c20 5b5d 292e  tdefault(c, []).
-00010f30: 6578 7465 6e64 286e 6577 5f6d 7367 7329  extend(new_msgs)
-00010f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010f50: 2066 6f72 2077 2c20 6e65 775f 6d73 6773   for w, new_msgs
-00010f60: 2069 6e20 615f 776d 7367 732e 6974 656d   in a_wmsgs.item
-00010f70: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00010f80: 2020 2020 2020 2020 2077 6f72 6b65 725f           worker_
-00010f90: 6d73 6773 2e73 6574 6465 6661 756c 7428  msgs.setdefault(
-00010fa0: 772c 205b 5d29 2e65 7874 656e 6428 6e65  w, []).extend(ne
-00010fb0: 775f 6d73 6773 290a 0a20 2020 2020 2020  w_msgs)..       
-00010fc0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-00010fd0: 6e64 6174 696f 6e73 2e75 7064 6174 6528  ndations.update(
-00010fe0: 625f 7265 6373 290a 2020 2020 2020 2020  b_recs).        
-00010ff0: 2020 2020 2020 2020 666f 7220 632c 206e          for c, n
-00011000: 6577 5f6d 7367 7320 696e 2062 5f63 6d73  ew_msgs in b_cms
-00011010: 6773 2e69 7465 6d73 2829 3a0a 2020 2020  gs.items():.    
+00010450: 2020 2064 7572 6174 696f 6e20 3d20 3220     duration = 2 
+00010460: 2a20 7072 6566 6978 2e6d 6178 5f65 7865  * prefix.max_exe
+00010470: 635f 7469 6d65 0a20 2020 2020 2020 2020  c_time.         
+00010480: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00010490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104a0: 2064 7572 6174 696f 6e20 3d20 7365 6c66   duration = self
+000104b0: 2e55 4e4b 4e4f 574e 5f54 4153 4b5f 4455  .UNKNOWN_TASK_DU
+000104c0: 5241 5449 4f4e 0a20 2020 2020 2020 2020  RATION.         
+000104d0: 2020 2072 6573 202b 3d20 6475 7261 7469     res += durati
+000104e0: 6f6e 202a 2063 6f75 6e74 0a20 2020 2020  on * count.     
+000104f0: 2020 206f 6363 203d 2072 6573 202b 206e     occ = res + n
+00010500: 6574 776f 726b 5f6f 6363 202f 2073 656c  etwork_occ / sel
+00010510: 662e 6261 6e64 7769 6474 680a 2020 2020  f.bandwidth.    
+00010520: 2020 2020 6173 7365 7274 206f 6363 203e      assert occ >
+00010530: 3d20 302c 2028 6f63 632c 2072 6573 2c20  = 0, (occ, res, 
+00010540: 6e65 7477 6f72 6b5f 6f63 632c 2073 656c  network_occ, sel
+00010550: 662e 6261 6e64 7769 6474 6829 0a20 2020  f.bandwidth).   
+00010560: 2020 2020 2072 6574 7572 6e20 6f63 630a       return occ.
+00010570: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+00010580: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
+00010590: 2053 7461 7465 2054 7261 6e73 6974 696f   State Transitio
+000105a0: 6e73 2023 0a20 2020 2023 2323 2323 2323  ns #.    #######
+000105b0: 2323 2323 2323 2323 2323 2323 2323 0a0a  ##############..
+000105c0: 2020 2020 6465 6620 5f74 7261 6e73 6974      def _transit
+000105d0: 696f 6e28 0a20 2020 2020 2020 2073 656c  ion(.        sel
+000105e0: 662c 206b 6579 3a20 4b65 792c 2066 696e  f, key: Key, fin
+000105f0: 6973 683a 2054 6173 6b53 7461 7465 5374  ish: TaskStateSt
+00010600: 6174 652c 2073 7469 6d75 6c75 735f 6964  ate, stimulus_id
+00010610: 3a20 7374 722c 202a 2a6b 7761 7267 733a  : str, **kwargs:
+00010620: 2041 6e79 0a20 2020 2029 202d 3e20 5265   Any.    ) -> Re
+00010630: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
+00010640: 2222 2254 7261 6e73 6974 696f 6e20 6120  """Transition a 
+00010650: 6b65 7920 6672 6f6d 2069 7473 2063 7572  key from its cur
+00010660: 7265 6e74 2073 7461 7465 2074 6f20 7468  rent state to th
+00010670: 6520 6669 6e69 7368 2073 7461 7465 0a0a  e finish state..
+00010680: 2020 2020 2020 2020 4578 616d 706c 6573          Examples
+00010690: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+000106a0: 2d0a 2020 2020 2020 2020 3e3e 3e20 7365  -.        >>> se
+000106b0: 6c66 2e5f 7472 616e 7369 7469 6f6e 2827  lf._transition('
+000106c0: 7827 2c20 2777 6169 7469 6e67 2729 0a20  x', 'waiting'). 
+000106d0: 2020 2020 2020 207b 2778 273a 2027 7072         {'x': 'pr
+000106e0: 6f63 6573 7369 6e67 277d 2c20 7b7d 2c20  ocessing'}, {}, 
+000106f0: 7b7d 0a0a 2020 2020 2020 2020 5265 7475  {}..        Retu
+00010700: 726e 730a 2020 2020 2020 2020 2d2d 2d2d  rns.        ----
+00010710: 2d2d 2d0a 2020 2020 2020 2020 5475 706c  ---.        Tupl
+00010720: 6520 6f66 3a0a 0a20 2020 2020 2020 202d  e of:..        -
+00010730: 2044 6963 7469 6f6e 6172 7920 6f66 2072   Dictionary of r
+00010740: 6563 6f6d 6d65 6e64 6174 696f 6e73 2066  ecommendations f
+00010750: 6f72 2066 7574 7572 6520 7472 616e 7369  or future transi
+00010760: 7469 6f6e 7320 7b6b 6579 3a20 6e65 7720  tions {key: new 
+00010770: 7374 6174 657d 0a20 2020 2020 2020 202d  state}.        -
+00010780: 204d 6573 7361 6765 7320 746f 2063 6c69   Messages to cli
+00010790: 656e 7473 207b 636c 6965 6e74 2061 6464  ents {client add
+000107a0: 7265 7373 3a20 5b6d 7367 2c20 6d73 672c  ress: [msg, msg,
+000107b0: 202e 2e2e 5d7d 0a20 2020 2020 2020 202d   ...]}.        -
+000107c0: 204d 6573 7361 6765 7320 746f 2077 6f72   Messages to wor
+000107d0: 6b65 7273 207b 776f 726b 6572 2061 6464  kers {worker add
+000107e0: 7265 7373 3a20 5b6d 7367 2c20 6d73 672c  ress: [msg, msg,
+000107f0: 202e 2e2e 5d7d 0a0a 2020 2020 2020 2020   ...]}..        
+00010800: 5365 6520 416c 736f 0a20 2020 2020 2020  See Also.       
+00010810: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+00010820: 2020 5363 6865 6475 6c65 722e 7472 616e    Scheduler.tran
+00010830: 7369 7469 6f6e 7320 3a20 7472 616e 7369  sitions : transi
+00010840: 7469 7665 2076 6572 7369 6f6e 206f 6620  tive version of 
+00010850: 7468 6973 2066 756e 6374 696f 6e0a 2020  this function.  
+00010860: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00010870: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00010880: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00010890: 6b73 2e67 6574 286b 6579 290a 2020 2020  ks.get(key).    
+000108a0: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
+000108b0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+000108c0: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
+000108d0: 2c20 7b7d 2c20 7b7d 0a20 2020 2020 2020  , {}, {}.       
+000108e0: 2020 2020 2073 7461 7274 203d 2074 732e       start = ts.
+000108f0: 5f73 7461 7465 0a20 2020 2020 2020 2020  _state.         
+00010900: 2020 2069 6620 7374 6172 7420 3d3d 2066     if start == f
+00010910: 696e 6973 683a 0a20 2020 2020 2020 2020  inish:.         
+00010920: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
+00010930: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 2020  , {}, {}..      
+00010940: 2020 2020 2020 2320 4e6f 7465 733a 0a20        # Notes:. 
+00010950: 2020 2020 2020 2020 2020 2023 202d 2069             # - i
+00010960: 6e20 6361 7365 206f 6620 7472 616e 7369  n case of transi
+00010970: 7469 6f6e 2074 6872 6f75 6768 2072 656c  tion through rel
+00010980: 6561 7365 642c 2074 6869 7320 636f 756e  eased, this coun
+00010990: 7465 7220 6973 2069 6e63 7265 6d65 6e74  ter is increment
+000109a0: 6564 2062 7920 320a 2020 2020 2020 2020  ed by 2.        
+000109b0: 2020 2020 2320 2d20 7468 6973 2069 6e63      # - this inc
+000109c0: 7265 6173 6520 6861 7070 656e 7320 6265  rease happens be
+000109d0: 666f 7265 2074 6865 2061 6374 7561 6c20  fore the actual 
+000109e0: 7472 616e 7369 7469 6f6e 732c 2073 6f20  transitions, so 
+000109f0: 7468 6174 2069 7420 6361 6e0a 2020 2020  that it can.    
+00010a00: 2020 2020 2020 2020 2320 2020 6361 7463          #   catc
+00010a10: 6820 706f 7465 6e74 6961 6c20 696e 6669  h potential infi
+00010a20: 6e69 7465 2072 6563 7572 7369 6f6e 730a  nite recursions.
+00010a30: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00010a40: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+00010a50: 7465 7220 2b3d 2031 0a20 2020 2020 2020  ter += 1.       
+00010a60: 2020 2020 2069 6620 7365 6c66 2e74 7261       if self.tra
+00010a70: 6e73 6974 696f 6e5f 636f 756e 7465 725f  nsition_counter_
+00010a80: 6d61 783a 0a20 2020 2020 2020 2020 2020  max:.           
+00010a90: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
+00010aa0: 2e74 7261 6e73 6974 696f 6e5f 636f 756e  .transition_coun
+00010ab0: 7465 7220 3c20 7365 6c66 2e74 7261 6e73  ter < self.trans
+00010ac0: 6974 696f 6e5f 636f 756e 7465 725f 6d61  ition_counter_ma
+00010ad0: 780a 0a20 2020 2020 2020 2020 2020 2072  x..            r
+00010ae0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
+00010af0: 5265 6373 203d 207b 7d0a 2020 2020 2020  Recs = {}.      
+00010b00: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+00010b10: 733a 204d 7367 7320 3d20 7b7d 0a20 2020  s: Msgs = {}.   
+00010b20: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
+00010b30: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
+00010b40: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00010b50: 7365 6c66 2e70 6c75 6769 6e73 3a0a 2020  self.plugins:.  
+00010b60: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00010b70: 7065 6e64 656e 7473 203d 2073 6574 2874  pendents = set(t
+00010b80: 732e 6465 7065 6e64 656e 7473 290a 2020  s.dependents).  
+00010b90: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00010ba0: 7065 6e64 656e 6369 6573 203d 2073 6574  pendencies = set
+00010bb0: 2874 732e 6465 7065 6e64 656e 6369 6573  (ts.dependencies
+00010bc0: 290a 0a20 2020 2020 2020 2020 2020 2066  )..            f
+00010bd0: 756e 6320 3d20 7365 6c66 2e5f 5452 414e  unc = self._TRAN
+00010be0: 5349 5449 4f4e 535f 5441 424c 452e 6765  SITIONS_TABLE.ge
+00010bf0: 7428 2873 7461 7274 2c20 6669 6e69 7368  t((start, finish
+00010c00: 2929 0a20 2020 2020 2020 2020 2020 2069  )).            i
+00010c10: 6620 6675 6e63 2069 7320 6e6f 7420 4e6f  f func is not No
+00010c20: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00010c30: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+00010c40: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
+00010c50: 2c20 776f 726b 6572 5f6d 7367 7320 3d20  , worker_msgs = 
+00010c60: 6675 6e63 280a 2020 2020 2020 2020 2020  func(.          
+00010c70: 2020 2020 2020 2020 2020 7365 6c66 2c20            self, 
+00010c80: 6b65 792c 2073 7469 6d75 6c75 735f 6964  key, stimulus_id
+00010c90: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
+00010ca0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00010cb0: 2020 2020 2020 2020 2020 656c 6966 2022            elif "
+00010cc0: 7265 6c65 6173 6564 2220 6e6f 7420 696e  released" not in
+00010cd0: 2028 7374 6172 742c 2066 696e 6973 6829   (start, finish)
+00010ce0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010cf0: 2020 6173 7365 7274 206e 6f74 206b 7761    assert not kwa
+00010d00: 7267 732c 2028 6b77 6172 6773 2c20 7374  rgs, (kwargs, st
+00010d10: 6172 742c 2066 696e 6973 6829 0a20 2020  art, finish).   
+00010d20: 2020 2020 2020 2020 2020 2020 2061 5f72               a_r
+00010d30: 6563 732c 2061 5f63 6d73 6773 2c20 615f  ecs, a_cmsgs, a_
+00010d40: 776d 7367 7320 3d20 7365 6c66 2e5f 7472  wmsgs = self._tr
+00010d50: 616e 7369 7469 6f6e 280a 2020 2020 2020  ansition(.      
+00010d60: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
+00010d70: 792c 2022 7265 6c65 6173 6564 222c 2073  y, "released", s
+00010d80: 7469 6d75 6c75 735f 6964 0a20 2020 2020  timulus_id.     
+00010d90: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00010da0: 2020 2020 2020 2020 2020 2020 2020 7620                v 
+00010db0: 3d20 615f 7265 6373 2e67 6574 286b 6579  = a_recs.get(key
+00010dc0: 2c20 6669 6e69 7368 290a 2020 2020 2020  , finish).      
+00010dd0: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+00010de0: 696e 6e65 7220 7265 6320 6861 7320 6869  inner rec has hi
+00010df0: 6768 6572 2070 7269 6f72 6974 793f 2049  gher priority? I
+00010e00: 7320 7468 6174 2061 6c77 6179 7320 6465  s that always de
+00010e10: 7369 7265 643f 0a20 2020 2020 2020 2020  sired?.         
+00010e20: 2020 2020 2020 2066 756e 6320 3d20 7365         func = se
+00010e30: 6c66 2e5f 5452 414e 5349 5449 4f4e 535f  lf._TRANSITIONS_
+00010e40: 5441 424c 455b 2272 656c 6561 7365 6422  TABLE["released"
+00010e50: 2c20 765d 0a20 2020 2020 2020 2020 2020  , v].           
+00010e60: 2020 2020 2062 5f72 6563 732c 2062 5f63       b_recs, b_c
+00010e70: 6d73 6773 2c20 625f 776d 7367 7320 3d20  msgs, b_wmsgs = 
+00010e80: 6675 6e63 2873 656c 662c 206b 6579 2c20  func(self, key, 
+00010e90: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
+00010ea0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00010eb0: 636f 6d6d 656e 6461 7469 6f6e 732e 7570  commendations.up
+00010ec0: 6461 7465 2861 5f72 6563 7329 0a20 2020  date(a_recs).   
+00010ed0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+00010ee0: 2063 2c20 6e65 775f 6d73 6773 2069 6e20   c, new_msgs in 
+00010ef0: 615f 636d 7367 732e 6974 656d 7328 293a  a_cmsgs.items():
+00010f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010f10: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
+00010f20: 2e73 6574 6465 6661 756c 7428 632c 205b  .setdefault(c, [
+00010f30: 5d29 2e65 7874 656e 6428 6e65 775f 6d73  ]).extend(new_ms
+00010f40: 6773 290a 2020 2020 2020 2020 2020 2020  gs).            
+00010f50: 2020 2020 666f 7220 772c 206e 6577 5f6d      for w, new_m
+00010f60: 7367 7320 696e 2061 5f77 6d73 6773 2e69  sgs in a_wmsgs.i
+00010f70: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00010f80: 2020 2020 2020 2020 2020 2020 776f 726b              work
+00010f90: 6572 5f6d 7367 732e 7365 7464 6566 6175  er_msgs.setdefau
+00010fa0: 6c74 2877 2c20 5b5d 292e 6578 7465 6e64  lt(w, []).extend
+00010fb0: 286e 6577 5f6d 7367 7329 0a0a 2020 2020  (new_msgs)..    
+00010fc0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00010fd0: 6d6d 656e 6461 7469 6f6e 732e 7570 6461  mmendations.upda
+00010fe0: 7465 2862 5f72 6563 7329 0a20 2020 2020  te(b_recs).     
+00010ff0: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+00011000: 2c20 6e65 775f 6d73 6773 2069 6e20 625f  , new_msgs in b_
+00011010: 636d 7367 732e 6974 656d 7328 293a 0a20  cmsgs.items():. 
 00011020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011030: 636c 6965 6e74 5f6d 7367 732e 7365 7464  client_msgs.setd
-00011040: 6566 6175 6c74 2863 2c20 5b5d 292e 6578  efault(c, []).ex
-00011050: 7465 6e64 286e 6577 5f6d 7367 7329 0a20  tend(new_msgs). 
-00011060: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00011070: 6f72 2077 2c20 6e65 775f 6d73 6773 2069  or w, new_msgs i
-00011080: 6e20 625f 776d 7367 732e 6974 656d 7328  n b_wmsgs.items(
-00011090: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000110a0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-000110b0: 6773 2e73 6574 6465 6661 756c 7428 772c  gs.setdefault(w,
-000110c0: 205b 5d29 2e65 7874 656e 6428 6e65 775f   []).extend(new_
-000110d0: 6d73 6773 290a 0a20 2020 2020 2020 2020  msgs)..         
-000110e0: 2020 2020 2020 2073 7461 7274 203d 2022         start = "
-000110f0: 7265 6c65 6173 6564 220a 2020 2020 2020  released".      
-00011100: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00011110: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00011120: 6520 5275 6e74 696d 6545 7272 6f72 280a  e RuntimeError(.
-00011130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011140: 2020 2020 6622 496d 706f 7373 6962 6c65      f"Impossible
-00011150: 2074 7261 6e73 6974 696f 6e20 6672 6f6d   transition from
-00011160: 207b 7374 6172 747d 2074 6f20 7b66 696e   {start} to {fin
-00011170: 6973 687d 2066 6f72 207b 6b65 7921 727d  ish} for {key!r}
-00011180: 3a20 220a 2020 2020 2020 2020 2020 2020  : ".            
-00011190: 2020 2020 2020 2020 6622 7b73 7469 6d75          f"{stimu
-000111a0: 6c75 735f 6964 3d7d 2c20 7b6b 7761 7267  lus_id=}, {kwarg
-000111b0: 733d 7d2c 2073 746f 7279 3d7b 7365 6c66  s=}, story={self
-000111c0: 2e73 746f 7279 2874 7329 7d22 0a20 2020  .story(ts)}".   
-000111d0: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-000111e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-000111f0: 6f74 2073 7469 6d75 6c75 735f 6964 3a0a  ot stimulus_id:.
-00011200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011210: 7374 696d 756c 7573 5f69 6420 3d20 5354  stimulus_id = ST
-00011220: 494d 554c 5553 5f49 445f 554e 5345 540a  IMULUS_ID_UNSET.
-00011230: 0a20 2020 2020 2020 2020 2020 2061 6374  .            act
-00011240: 7561 6c5f 6669 6e69 7368 203d 2074 732e  ual_finish = ts.
-00011250: 5f73 7461 7465 0a20 2020 2020 2020 2020  _state.         
-00011260: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
-00011270: 6f6e 5f6c 6f67 2e61 7070 656e 6428 0a20  on_log.append(. 
-00011280: 2020 2020 2020 2020 2020 2020 2020 2054                 T
-00011290: 7261 6e73 6974 696f 6e28 0a20 2020 2020  ransition(.     
-000112a0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
-000112b0: 6579 2c20 7374 6172 742c 2061 6374 7561  ey, start, actua
-000112c0: 6c5f 6669 6e69 7368 2c20 7265 636f 6d6d  l_finish, recomm
-000112d0: 656e 6461 7469 6f6e 732c 2073 7469 6d75  endations, stimu
-000112e0: 6c75 735f 6964 2c20 7469 6d65 2829 0a20  lus_id, time(). 
-000112f0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00011300: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00011310: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00011320: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00011330: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00011340: 7374 696d 756c 7573 5f69 6420 3d3d 2053  stimulus_id == S
-00011350: 5449 4d55 4c55 535f 4944 5f55 4e53 4554  TIMULUS_ID_UNSET
-00011360: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011370: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
-00011380: 696d 6545 7272 6f72 280a 2020 2020 2020  imeError(.      
+00011030: 2020 2063 6c69 656e 745f 6d73 6773 2e73     client_msgs.s
+00011040: 6574 6465 6661 756c 7428 632c 205b 5d29  etdefault(c, [])
+00011050: 2e65 7874 656e 6428 6e65 775f 6d73 6773  .extend(new_msgs
+00011060: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011070: 2020 666f 7220 772c 206e 6577 5f6d 7367    for w, new_msg
+00011080: 7320 696e 2062 5f77 6d73 6773 2e69 7465  s in b_wmsgs.ite
+00011090: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
+000110a0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+000110b0: 5f6d 7367 732e 7365 7464 6566 6175 6c74  _msgs.setdefault
+000110c0: 2877 2c20 5b5d 292e 6578 7465 6e64 286e  (w, []).extend(n
+000110d0: 6577 5f6d 7367 7329 0a0a 2020 2020 2020  ew_msgs)..      
+000110e0: 2020 2020 2020 2020 2020 7374 6172 7420            start 
+000110f0: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
+00011100: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00011110: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00011120: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+00011130: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00011140: 2020 2020 2020 2066 2249 6d70 6f73 7369         f"Impossi
+00011150: 626c 6520 7472 616e 7369 7469 6f6e 2066  ble transition f
+00011160: 726f 6d20 7b73 7461 7274 7d20 746f 207b  rom {start} to {
+00011170: 6669 6e69 7368 7d20 666f 7220 7b6b 6579  finish} for {key
+00011180: 2172 7d3a 2022 0a20 2020 2020 2020 2020  !r}: ".         
+00011190: 2020 2020 2020 2020 2020 2066 227b 7374             f"{st
+000111a0: 696d 756c 7573 5f69 643d 7d2c 207b 6b77  imulus_id=}, {kw
+000111b0: 6172 6773 3d7d 2c20 7374 6f72 793d 7b73  args=}, story={s
+000111c0: 656c 662e 7374 6f72 7928 7473 297d 220a  elf.story(ts)}".
+000111d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000111e0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+000111f0: 6620 6e6f 7420 7374 696d 756c 7573 5f69  f not stimulus_i
+00011200: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00011210: 2020 2073 7469 6d75 6c75 735f 6964 203d     stimulus_id =
+00011220: 2053 5449 4d55 4c55 535f 4944 5f55 4e53   STIMULUS_ID_UNS
+00011230: 4554 0a0a 2020 2020 2020 2020 2020 2020  ET..            
+00011240: 6163 7475 616c 5f66 696e 6973 6820 3d20  actual_finish = 
+00011250: 7473 2e5f 7374 6174 650a 2020 2020 2020  ts._state.      
+00011260: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
+00011270: 6974 696f 6e5f 6c6f 672e 6170 7065 6e64  ition_log.append
+00011280: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00011290: 2020 5472 616e 7369 7469 6f6e 280a 2020    Transition(.  
+000112a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000112b0: 2020 6b65 792c 2073 7461 7274 2c20 6163    key, start, ac
+000112c0: 7475 616c 5f66 696e 6973 682c 2072 6563  tual_finish, rec
+000112d0: 6f6d 6d65 6e64 6174 696f 6e73 2c20 7374  ommendations, st
+000112e0: 696d 756c 7573 5f69 642c 2074 696d 6528  imulus_id, time(
+000112f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00011300: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+00011310: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00011320: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00011330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011340: 6966 2073 7469 6d75 6c75 735f 6964 203d  if stimulus_id =
+00011350: 3d20 5354 494d 554c 5553 5f49 445f 554e  = STIMULUS_ID_UN
+00011360: 5345 543a 0a20 2020 2020 2020 2020 2020  SET:.           
+00011370: 2020 2020 2020 2020 2072 6169 7365 2052           raise R
+00011380: 756e 7469 6d65 4572 726f 7228 0a20 2020  untimeError(.   
 00011390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000113a0: 2020 2273 7469 6d75 6c75 735f 6964 206e    "stimulus_id n
-000113b0: 6f74 2073 6574 2064 7572 696e 6720 5363  ot set during Sc
-000113c0: 6865 6475 6c65 7220 7472 616e 7369 7469  heduler transiti
-000113d0: 6f6e 220a 2020 2020 2020 2020 2020 2020  on".            
-000113e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000113f0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00011400: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00011410: 2020 2020 2020 2020 2020 2020 2254 7261              "Tra
-00011420: 6e73 6974 696f 6e65 6420 2572 2025 732d  nsitioned %r %s-
-00011430: 3e25 7320 2861 6374 7561 6c3a 2025 7329  >%s (actual: %s)
-00011440: 2e20 2043 6f6e 7365 7175 656e 6365 3a20  .  Consequence: 
-00011450: 2573 222c 0a20 2020 2020 2020 2020 2020  %s",.           
-00011460: 2020 2020 2020 2020 206b 6579 2c0a 2020           key,.  
-00011470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011480: 2020 7374 6172 742c 0a20 2020 2020 2020    start,.       
-00011490: 2020 2020 2020 2020 2020 2020 2066 696e               fin
-000114a0: 6973 682c 0a20 2020 2020 2020 2020 2020  ish,.           
-000114b0: 2020 2020 2020 2020 2061 6374 7561 6c5f           actual_
-000114c0: 6669 6e69 7368 2c0a 2020 2020 2020 2020  finish,.        
-000114d0: 2020 2020 2020 2020 2020 2020 6469 6374              dict
-000114e0: 2872 6563 6f6d 6d65 6e64 6174 696f 6e73  (recommendations
-000114f0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00011500: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00011510: 2069 6620 7365 6c66 2e70 6c75 6769 6e73   if self.plugins
-00011520: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00011530: 2020 2320 5465 6d70 6f72 6172 696c 7920    # Temporarily 
-00011540: 7075 7420 6261 636b 2066 6f72 676f 7474  put back forgott
-00011550: 656e 206b 6579 2066 6f72 2070 6c75 6769  en key for plugi
-00011560: 6e20 746f 2072 6574 7269 6576 6520 6974  n to retrieve it
-00011570: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011580: 2069 6620 7473 2e5f 7374 6174 6520 3d3d   if ts._state ==
-00011590: 2022 666f 7267 6f74 7465 6e22 3a0a 2020   "forgotten":.  
-000115a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115b0: 2020 7473 2e64 6570 656e 6465 6e74 7320    ts.dependents 
-000115c0: 3d20 6465 7065 6e64 656e 7473 0a20 2020  = dependents.   
+000113a0: 2020 2020 2022 7374 696d 756c 7573 5f69       "stimulus_i
+000113b0: 6420 6e6f 7420 7365 7420 6475 7269 6e67  d not set during
+000113c0: 2053 6368 6564 756c 6572 2074 7261 6e73   Scheduler trans
+000113d0: 6974 696f 6e22 0a20 2020 2020 2020 2020  ition".         
+000113e0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000113f0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+00011400: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
+00011410: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00011420: 5472 616e 7369 7469 6f6e 6564 2025 7220  Transitioned %r 
+00011430: 2573 2d3e 2573 2028 6163 7475 616c 3a20  %s->%s (actual: 
+00011440: 2573 292e 2020 436f 6e73 6571 7565 6e63  %s).  Consequenc
+00011450: 653a 2025 7322 2c0a 2020 2020 2020 2020  e: %s",.        
+00011460: 2020 2020 2020 2020 2020 2020 6b65 792c              key,
+00011470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011480: 2020 2020 2073 7461 7274 2c0a 2020 2020       start,.    
+00011490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000114a0: 6669 6e69 7368 2c0a 2020 2020 2020 2020  finish,.        
+000114b0: 2020 2020 2020 2020 2020 2020 6163 7475              actu
+000114c0: 616c 5f66 696e 6973 682c 0a20 2020 2020  al_finish,.     
+000114d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000114e0: 6963 7428 7265 636f 6d6d 656e 6461 7469  ict(recommendati
+000114f0: 6f6e 7329 2c0a 2020 2020 2020 2020 2020  ons),.          
+00011500: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00011510: 2020 2020 6966 2073 656c 662e 706c 7567      if self.plug
+00011520: 696e 733a 0a20 2020 2020 2020 2020 2020  ins:.           
+00011530: 2020 2020 2023 2054 656d 706f 7261 7269       # Temporari
+00011540: 6c79 2070 7574 2062 6163 6b20 666f 7267  ly put back forg
+00011550: 6f74 7465 6e20 6b65 7920 666f 7220 706c  otten key for pl
+00011560: 7567 696e 2074 6f20 7265 7472 6965 7665  ugin to retrieve
+00011570: 2069 740a 2020 2020 2020 2020 2020 2020   it.            
+00011580: 2020 2020 6966 2074 732e 5f73 7461 7465      if ts._state
+00011590: 203d 3d20 2266 6f72 676f 7474 656e 223a   == "forgotten":
+000115a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000115b0: 2020 2020 2074 732e 6465 7065 6e64 656e       ts.dependen
+000115c0: 7473 203d 2064 6570 656e 6465 6e74 730a  ts = dependents.
 000115d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000115e0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-000115f0: 203d 2064 6570 656e 6465 6e63 6965 730a   = dependencies.
-00011600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011610: 2020 2020 7365 6c66 2e74 6173 6b73 5b74      self.tasks[t
-00011620: 732e 6b65 795d 203d 2074 730a 2020 2020  s.key] = ts.    
-00011630: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00011640: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
-00011650: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
-00011660: 6573 2829 293a 0a20 2020 2020 2020 2020  es()):.         
-00011670: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-00011680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011690: 2020 2020 2020 2020 706c 7567 696e 2e74          plugin.t
-000116a0: 7261 6e73 6974 696f 6e28 0a20 2020 2020  ransition(.     
+000115e0: 2020 2020 7473 2e64 6570 656e 6465 6e63      ts.dependenc
+000115f0: 6965 7320 3d20 6465 7065 6e64 656e 6369  ies = dependenci
+00011600: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+00011610: 2020 2020 2020 2073 656c 662e 7461 736b         self.task
+00011620: 735b 7473 2e6b 6579 5d20 3d20 7473 0a20  s[ts.key] = ts. 
+00011630: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00011640: 6f72 2070 6c75 6769 6e20 696e 206c 6973  or plugin in lis
+00011650: 7428 7365 6c66 2e70 6c75 6769 6e73 2e76  t(self.plugins.v
+00011660: 616c 7565 7328 2929 3a0a 2020 2020 2020  alues()):.      
+00011670: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00011680: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00011690: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
+000116a0: 6e2e 7472 616e 7369 7469 6f6e 280a 2020  n.transition(.  
 000116b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000116c0: 2020 2020 2020 206b 6579 2c20 7374 6172         key, star
-000116d0: 742c 2061 6374 7561 6c5f 6669 6e69 7368  t, actual_finish
-000116e0: 2c20 7374 696d 756c 7573 5f69 643d 7374  , stimulus_id=st
-000116f0: 696d 756c 7573 5f69 642c 202a 2a6b 7761  imulus_id, **kwa
-00011700: 7267 730a 2020 2020 2020 2020 2020 2020  rgs.            
-00011710: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00011720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011730: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-00011740: 6f6e 3a0a 2020 2020 2020 2020 2020 2020  on:.            
-00011750: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-00011760: 6572 2e69 6e66 6f28 2250 6c75 6769 6e20  er.info("Plugin 
-00011770: 6661 696c 6564 2077 6974 6820 6578 6365  failed with exce
-00011780: 7074 696f 6e22 2c20 6578 635f 696e 666f  ption", exc_info
-00011790: 3d54 7275 6529 0a20 2020 2020 2020 2020  =True).         
-000117a0: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
-000117b0: 7465 203d 3d20 2266 6f72 676f 7474 656e  te == "forgotten
-000117c0: 223a 0a20 2020 2020 2020 2020 2020 2020  ":.             
-000117d0: 2020 2020 2020 2064 656c 2073 656c 662e         del self.
-000117e0: 7461 736b 735b 7473 2e6b 6579 5d0a 0a20  tasks[ts.key].. 
-000117f0: 2020 2020 2020 2020 2020 2074 6720 3d20             tg = 
-00011800: 7473 2e67 726f 7570 0a20 2020 2020 2020  ts.group.       
-00011810: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
-00011820: 203d 3d20 2266 6f72 676f 7474 656e 2220   == "forgotten" 
-00011830: 616e 6420 7467 2e6e 616d 6520 696e 2073  and tg.name in s
-00011840: 656c 662e 7461 736b 5f67 726f 7570 733a  elf.task_groups:
-00011850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011860: 2023 2052 656d 6f76 6520 5461 736b 4772   # Remove TaskGr
-00011870: 6f75 7020 6966 2061 6c6c 2074 6173 6b73  oup if all tasks
-00011880: 2061 7265 2069 6e20 7468 6520 666f 7267   are in the forg
-00011890: 6f74 7465 6e20 7374 6174 650a 2020 2020  otten state.    
-000118a0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-000118b0: 6c6c 2876 203d 3d20 3020 6f72 206b 203d  ll(v == 0 or k =
-000118c0: 3d20 2266 6f72 676f 7474 656e 2220 666f  = "forgotten" fo
-000118d0: 7220 6b2c 2076 2069 6e20 7467 2e73 7461  r k, v in tg.sta
-000118e0: 7465 732e 6974 656d 7328 2929 3a0a 2020  tes.items()):.  
-000118f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011900: 2020 7473 2e70 7265 6669 782e 6772 6f75    ts.prefix.grou
-00011910: 7073 2e72 656d 6f76 6528 7467 290a 2020  ps.remove(tg).  
-00011920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011930: 2020 6465 6c20 7365 6c66 2e74 6173 6b5f    del self.task_
-00011940: 6772 6f75 7073 5b74 672e 6e61 6d65 5d0a  groups[tg.name].
-00011950: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00011960: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
-00011970: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
-00011980: 2c20 776f 726b 6572 5f6d 7367 730a 2020  , worker_msgs.  
-00011990: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
-000119a0: 6570 7469 6f6e 3a0a 2020 2020 2020 2020  eption:.        
-000119b0: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
-000119c0: 7469 6f6e 2822 4572 726f 7220 7472 616e  tion("Error tran
-000119d0: 7369 7469 6f6e 696e 6720 2572 2066 726f  sitioning %r fro
-000119e0: 6d20 2572 2074 6f20 2572 222c 206b 6579  m %r to %r", key
-000119f0: 2c20 7374 6172 742c 2066 696e 6973 6829  , start, finish)
-00011a00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00011a10: 4c4f 475f 5044 423a 0a20 2020 2020 2020  LOG_PDB:.       
-00011a20: 2020 2020 2020 2020 2069 6d70 6f72 7420           import 
-00011a30: 7064 620a 0a20 2020 2020 2020 2020 2020  pdb..           
-00011a40: 2020 2020 2070 6462 2e73 6574 5f74 7261       pdb.set_tra
-00011a50: 6365 2829 0a20 2020 2020 2020 2020 2020  ce().           
-00011a60: 2072 6169 7365 0a0a 2020 2020 6465 6620   raise..    def 
-00011a70: 5f74 7261 6e73 6974 696f 6e73 280a 2020  _transitions(.  
-00011a80: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00011a90: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-00011aa0: 6f6e 733a 2052 6563 732c 0a20 2020 2020  ons: Recs,.     
-00011ab0: 2020 2063 6c69 656e 745f 6d73 6773 3a20     client_msgs: 
-00011ac0: 4d73 6773 2c0a 2020 2020 2020 2020 776f  Msgs,.        wo
-00011ad0: 726b 6572 5f6d 7367 733a 204d 7367 732c  rker_msgs: Msgs,
-00011ae0: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-00011af0: 735f 6964 3a20 7374 722c 0a20 2020 2029  s_id: str,.    )
-00011b00: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00011b10: 2020 2222 2250 726f 6365 7373 2074 7261    """Process tra
-00011b20: 6e73 6974 696f 6e73 2075 6e74 696c 206e  nsitions until n
-00011b30: 6f6e 6520 6172 6520 6c65 6674 0a0a 2020  one are left..  
-00011b40: 2020 2020 2020 5468 6973 2069 6e63 6c75        This inclu
-00011b50: 6465 7320 6665 6564 6261 636b 2066 726f  des feedback fro
-00011b60: 6d20 7072 6576 696f 7573 2074 7261 6e73  m previous trans
-00011b70: 6974 696f 6e73 2061 6e64 2063 6f6e 7469  itions and conti
-00011b80: 6e75 6573 2075 6e74 696c 2077 650a 2020  nues until we.  
-00011b90: 2020 2020 2020 7265 6163 6820 6120 7374        reach a st
-00011ba0: 6561 6479 2073 7461 7465 0a20 2020 2020  eady state.     
-00011bb0: 2020 2022 2222 0a20 2020 2020 2020 206b     """.        k
-00011bc0: 6579 733a 2073 6574 5b4b 6579 5d20 3d20  eys: set[Key] = 
-00011bd0: 7365 7428 290a 2020 2020 2020 2020 7265  set().        re
-00011be0: 636f 6d6d 656e 6461 7469 6f6e 7320 3d20  commendations = 
-00011bf0: 7265 636f 6d6d 656e 6461 7469 6f6e 732e  recommendations.
-00011c00: 636f 7079 2829 0a0a 2020 2020 2020 2020  copy()..        
-00011c10: 7768 696c 6520 7265 636f 6d6d 656e 6461  while recommenda
-00011c20: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-00011c30: 2020 206b 6579 2c20 6669 6e69 7368 203d     key, finish =
-00011c40: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00011c50: 2e70 6f70 6974 656d 2829 0a20 2020 2020  .popitem().     
-00011c60: 2020 2020 2020 206b 6579 732e 6164 6428         keys.add(
-00011c70: 6b65 7929 0a0a 2020 2020 2020 2020 2020  key)..          
-00011c80: 2020 6e65 775f 7265 6373 2c20 6e65 775f    new_recs, new_
-00011c90: 636d 7367 732c 206e 6577 5f77 6d73 6773  cmsgs, new_wmsgs
-00011ca0: 203d 2073 656c 662e 5f74 7261 6e73 6974   = self._transit
-00011cb0: 696f 6e28 6b65 792c 2066 696e 6973 682c  ion(key, finish,
-00011cc0: 2073 7469 6d75 6c75 735f 6964 290a 0a20   stimulus_id).. 
-00011cd0: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00011ce0: 6d65 6e64 6174 696f 6e73 2e75 7064 6174  mendations.updat
-00011cf0: 6528 6e65 775f 7265 6373 290a 2020 2020  e(new_recs).    
-00011d00: 2020 2020 2020 2020 666f 7220 632c 206e          for c, n
-00011d10: 6577 5f6d 7367 7320 696e 206e 6577 5f63  ew_msgs in new_c
-00011d20: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
-00011d30: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-00011d40: 6965 6e74 5f6d 7367 732e 7365 7464 6566  ient_msgs.setdef
-00011d50: 6175 6c74 2863 2c20 5b5d 292e 6578 7465  ault(c, []).exte
-00011d60: 6e64 286e 6577 5f6d 7367 7329 0a20 2020  nd(new_msgs).   
-00011d70: 2020 2020 2020 2020 2066 6f72 2077 2c20           for w, 
-00011d80: 6e65 775f 6d73 6773 2069 6e20 6e65 775f  new_msgs in new_
-00011d90: 776d 7367 732e 6974 656d 7328 293a 0a20  wmsgs.items():. 
-00011da0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00011db0: 6f72 6b65 725f 6d73 6773 2e73 6574 6465  orker_msgs.setde
-00011dc0: 6661 756c 7428 772c 205b 5d29 2e65 7874  fault(w, []).ext
-00011dd0: 656e 6428 6e65 775f 6d73 6773 290a 0a20  end(new_msgs).. 
-00011de0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-00011df0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-00011e00: 2020 2020 2023 2046 4958 4d45 2064 6f77       # FIXME dow
-00011e10: 6e63 6173 7420 616e 7469 7061 7474 6572  ncast antipatter
-00011e20: 6e0a 2020 2020 2020 2020 2020 2020 7363  n.            sc
-00011e30: 6865 6475 6c65 7220 3d20 6361 7374 2853  heduler = cast(S
-00011e40: 6368 6564 756c 6572 2c20 7365 6c66 290a  cheduler, self).
-00011e50: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00011e60: 6b65 7920 696e 206b 6579 733a 0a20 2020  key in keys:.   
-00011e70: 2020 2020 2020 2020 2020 2020 2073 6368               sch
-00011e80: 6564 756c 6572 2e76 616c 6964 6174 655f  eduler.validate_
-00011e90: 6b65 7928 6b65 7929 0a0a 2020 2020 6465  key(key)..    de
-00011ea0: 6620 5f74 7261 6e73 6974 696f 6e5f 7265  f _transition_re
-00011eb0: 6c65 6173 6564 5f77 6169 7469 6e67 2873  leased_waiting(s
-00011ec0: 656c 662c 206b 6579 3a20 4b65 792c 2073  elf, key: Key, s
-00011ed0: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
-00011ee0: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
-00011ef0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-00011f00: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
-00011f10: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00011f20: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00011f30: 2020 6173 7365 7274 2074 732e 7275 6e5f    assert ts.run_
-00011f40: 7370 6563 0a20 2020 2020 2020 2020 2020  spec.           
-00011f50: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-00011f60: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
-00011f70: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00011f80: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
-00011f90: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00011fa0: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
-00011fb0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-00011fc0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-00011fd0: 7065 6e64 656e 6369 6573 3a0a 2020 2020  pendencies:.    
-00011fe0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00011ff0: 7274 2064 7473 2e73 7461 7465 206e 6f74  rt dts.state not
-00012000: 2069 6e20 7b22 666f 7267 6f74 7465 6e22   in {"forgotten"
-00012010: 2c20 2265 7272 6564 227d 2c20 280a 2020  , "erred"}, (.  
-00012020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012030: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
-00012040: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00012050: 7472 2864 7473 292c 0a20 2020 2020 2020  tr(dts),.       
-00012060: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00012070: 662e 7472 616e 7369 7469 6f6e 5f6c 6f67  f.transition_log
-00012080: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012090: 2020 290a 0a20 2020 2020 2020 2069 6620    )..        if 
-000120a0: 7473 2e68 6173 5f6c 6f73 745f 6465 7065  ts.has_lost_depe
-000120b0: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-000120c0: 2020 2020 2020 7265 7475 726e 207b 6b65        return {ke
-000120d0: 793a 2022 666f 7267 6f74 7465 6e22 7d2c  y: "forgotten"},
-000120e0: 207b 7d2c 207b 7d0a 0a20 2020 2020 2020   {}, {}..       
-000120f0: 2074 732e 7374 6174 6520 3d20 2277 6169   ts.state = "wai
-00012100: 7469 6e67 220a 0a20 2020 2020 2020 2072  ting"..        r
-00012110: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-00012120: 5265 6373 203d 207b 7d0a 0a20 2020 2020  Recs = {}..     
-00012130: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-00012140: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
-00012150: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00012160: 7420 6474 732e 7768 6f5f 6861 733a 0a20  t dts.who_has:. 
-00012170: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00012180: 6620 6e6f 7420 7473 2e77 6169 7469 6e67  f not ts.waiting
-00012190: 5f6f 6e3a 0a20 2020 2020 2020 2020 2020  _on:.           
-000121a0: 2020 2020 2020 2020 2074 732e 7761 6974           ts.wait
-000121b0: 696e 675f 6f6e 203d 2073 6574 2829 0a20  ing_on = set(). 
-000121c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000121d0: 732e 7761 6974 696e 675f 6f6e 2e61 6464  s.waiting_on.add
-000121e0: 2864 7473 290a 2020 2020 2020 2020 2020  (dts).          
-000121f0: 2020 6966 2064 7473 2e73 7461 7465 203d    if dts.state =
-00012200: 3d20 2272 656c 6561 7365 6422 3a0a 2020  = "released":.  
-00012210: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00012220: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
-00012230: 732e 6b65 795d 203d 2022 7761 6974 696e  s.key] = "waitin
-00012240: 6722 0a20 2020 2020 2020 2020 2020 2065  g".            e
-00012250: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00012260: 2020 2020 2069 6620 6e6f 7420 6474 732e       if not dts.
-00012270: 7761 6974 6572 733a 0a20 2020 2020 2020  waiters:.       
-00012280: 2020 2020 2020 2020 2020 2020 2064 7473               dts
-00012290: 2e77 6169 7465 7273 203d 2073 6574 2829  .waiters = set()
-000122a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000122b0: 2064 7473 2e77 6169 7465 7273 2e61 6464   dts.waiters.add
-000122c0: 2874 7329 0a0a 2020 2020 2020 2020 7473  (ts)..        ts
-000122d0: 2e77 6169 7465 7273 203d 207b 6474 7320  .waiters = {dts 
-000122e0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-000122f0: 7065 6e64 656e 7473 2069 6620 6474 732e  pendents if dts.
-00012300: 7374 6174 6520 3d3d 2022 7761 6974 696e  state == "waitin
-00012310: 6722 7d0a 0a20 2020 2020 2020 2069 6620  g"}..        if 
-00012320: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
-00012330: 6e3a 0a20 2020 2020 2020 2020 2020 2023  n:.            #
-00012340: 204e 4f54 453a 2077 6169 7469 6e67 2d3e   NOTE: waiting->
-00012350: 7072 6f63 6573 7369 6e67 2077 696c 6c20  processing will 
-00012360: 7365 6e64 2074 6173 6b73 2074 6f20 7175  send tasks to qu
-00012370: 6575 6564 206f 7220 6e6f 2d77 6f72 6b65  eued or no-worke
-00012380: 7220 6173 0a20 2020 2020 2020 2020 2020  r as.           
-00012390: 2023 206e 6563 6573 7361 7279 0a20 2020   # necessary.   
-000123a0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-000123b0: 6e64 6174 696f 6e73 5b6b 6579 5d20 3d20  ndations[key] = 
-000123c0: 2270 726f 6365 7373 696e 6722 0a0a 2020  "processing"..  
-000123d0: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
-000123e0: 6f6d 6d65 6e64 6174 696f 6e73 2c20 7b7d  ommendations, {}
-000123f0: 2c20 7b7d 0a0a 2020 2020 6465 6620 5f74  , {}..    def _t
-00012400: 7261 6e73 6974 696f 6e5f 6e6f 5f77 6f72  ransition_no_wor
-00012410: 6b65 725f 7072 6f63 6573 7369 6e67 2873  ker_processing(s
-00012420: 656c 662c 206b 6579 3a20 4b65 792c 2073  elf, key: Key, s
-00012430: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
-00012440: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
-00012450: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-00012460: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
-00012470: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00012480: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00012490: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-000124a0: 6163 746f 722c 2066 2241 6374 6f72 7320  actor, f"Actors 
-000124b0: 6361 6e27 7420 6265 2069 6e20 606e 6f2d  can't be in `no-
-000124c0: 776f 726b 6572 603a 207b 7473 7d22 0a20  worker`: {ts}". 
-000124d0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000124e0: 7420 7473 2069 6e20 7365 6c66 2e75 6e72  t ts in self.unr
-000124f0: 756e 6e61 626c 650a 0a20 2020 2020 2020  unnable..       
-00012500: 2069 6620 7773 203a 3d20 7365 6c66 2e64   if ws := self.d
-00012510: 6563 6964 655f 776f 726b 6572 5f6e 6f6e  ecide_worker_non
-00012520: 5f72 6f6f 7469 7368 2874 7329 3a0a 2020  _rootish(ts):.  
-00012530: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
-00012540: 6e72 756e 6e61 626c 652e 6469 7363 6172  nrunnable.discar
-00012550: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
-00012560: 2020 7265 7475 726e 2073 656c 662e 5f61    return self._a
-00012570: 6464 5f74 6f5f 7072 6f63 6573 7369 6e67  dd_to_processing
-00012580: 2874 732c 2077 732c 2073 7469 6d75 6c75  (ts, ws, stimulu
-00012590: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
-000125a0: 290a 2020 2020 2020 2020 2320 4966 206e  ).        # If n
-000125b0: 6f20 776f 726b 6572 2c20 7461 736b 206a  o worker, task j
-000125c0: 7573 7420 7374 6179 7320 696e 2060 6e6f  ust stays in `no
-000125d0: 2d77 6f72 6b65 7260 0a0a 2020 2020 2020  -worker`..      
-000125e0: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
-000125f0: 207b 7d0a 0a20 2020 2064 6566 2064 6563   {}..    def dec
-00012600: 6964 655f 776f 726b 6572 5f72 6f6f 7469  ide_worker_rooti
-00012610: 7368 5f71 7565 7569 6e67 5f64 6973 6162  sh_queuing_disab
-00012620: 6c65 6428 0a20 2020 2020 2020 2073 656c  led(.        sel
-00012630: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
-00012640: 0a20 2020 2029 202d 3e20 576f 726b 6572  .    ) -> Worker
-00012650: 5374 6174 6520 7c20 4e6f 6e65 3a0a 2020  State | None:.  
-00012660: 2020 2020 2020 2222 2250 6963 6b20 6120        """Pick a 
-00012670: 776f 726b 6572 2066 6f72 2061 2072 756e  worker for a run
-00012680: 6e61 626c 6520 726f 6f74 2d69 7368 2074  nable root-ish t
-00012690: 6173 6b2c 2077 6974 686f 7574 2071 7565  ask, without que
-000126a0: 7569 6e67 2e0a 0a20 2020 2020 2020 2054  uing...        T
-000126b0: 6869 7320 6174 7465 6d70 7473 2074 6f20  his attempts to 
-000126c0: 7363 6865 6475 6c65 2073 6962 6c69 6e67  schedule sibling
-000126d0: 2074 6173 6b73 206f 6e20 7468 6520 7361   tasks on the sa
-000126e0: 6d65 2077 6f72 6b65 722c 2072 6564 7563  me worker, reduc
-000126f0: 696e 6720 6675 7475 7265 2064 6174 610a  ing future data.
-00012700: 2020 2020 2020 2020 7472 616e 7366 6572          transfer
-00012710: 2e20 4974 2064 6f65 7320 6e6f 7420 636f  . It does not co
-00012720: 6e73 6964 6572 2074 6865 206c 6f63 6174  nsider the locat
-00012730: 696f 6e20 6f66 2064 6570 656e 6465 6e63  ion of dependenc
-00012740: 6965 732c 2073 696e 6365 2074 6865 7927  ies, since they'
-00012750: 6c6c 2065 6e64 0a20 2020 2020 2020 2075  ll end.        u
-00012760: 7020 6f6e 2065 7665 7279 2077 6f72 6b65  p on every worke
-00012770: 7220 616e 7977 6179 2e0a 0a20 2020 2020  r anyway...     
-00012780: 2020 2049 7420 6173 7375 6d65 7320 6974     It assumes it
-00012790: 2773 2062 6569 6e67 2063 616c 6c65 6420  's being called 
-000127a0: 6f6e 2061 2062 6174 6368 206f 6620 7461  on a batch of ta
-000127b0: 736b 7320 696e 2070 7269 6f72 6974 7920  sks in priority 
-000127c0: 6f72 6465 722c 2061 6e64 0a20 2020 2020  order, and.     
-000127d0: 2020 206d 6169 6e74 6169 6e73 2073 7461     maintains sta
-000127e0: 7465 2069 6e20 6053 6368 6564 756c 6572  te in `Scheduler
-000127f0: 5374 6174 652e 6c61 7374 5f72 6f6f 745f  State.last_root_
-00012800: 776f 726b 6572 6020 616e 640a 2020 2020  worker` and.    
-00012810: 2020 2020 6053 6368 6564 756c 6572 5374      `SchedulerSt
-00012820: 6174 652e 6c61 7374 5f72 6f6f 745f 776f  ate.last_root_wo
-00012830: 726b 6572 5f74 6173 6b73 5f6c 6566 7460  rker_tasks_left`
-00012840: 2074 6f20 6163 6869 6576 6520 7468 6973   to achieve this
-00012850: 2e0a 0a20 2020 2020 2020 2054 6869 7320  ...        This 
-00012860: 7769 6c6c 2073 656e 6420 6576 6572 7920  will send every 
-00012870: 7275 6e6e 6162 6c65 2074 6173 6b20 746f  runnable task to
-00012880: 2061 2077 6f72 6b65 722c 206f 6674 656e   a worker, often
-00012890: 2063 6175 7369 6e67 2072 6f6f 7420 7461   causing root ta
-000128a0: 736b 0a20 2020 2020 2020 206f 7665 7270  sk.        overp
-000128b0: 726f 6475 6374 696f 6e2e 0a0a 2020 2020  roduction...    
-000128c0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-000128d0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-000128e0: 2020 2020 7773 3a20 576f 726b 6572 5374      ws: WorkerSt
-000128f0: 6174 6520 7c20 4e6f 6e65 0a20 2020 2020  ate | None.     
-00012900: 2020 2020 2020 2054 6865 2077 6f72 6b65         The worke
-00012910: 7220 746f 2061 7373 6967 6e20 7468 6520  r to assign the 
-00012920: 7461 736b 2074 6f2e 2049 6620 7468 6572  task to. If ther
-00012930: 6520 6172 6520 6e6f 2077 6f72 6b65 7273  e are no workers
-00012940: 2069 6e20 7468 6520 636c 7573 7465 722c   in the cluster,
-00012950: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00012960: 7572 6e73 204e 6f6e 652c 2069 6e20 7768  urns None, in wh
-00012970: 6963 6820 6361 7365 2074 6865 2074 6173  ich case the tas
-00012980: 6b20 7368 6f75 6c64 2062 6520 7472 616e  k should be tran
-00012990: 7369 7469 6f6e 6564 2074 6f0a 2020 2020  sitioned to.    
-000129a0: 2020 2020 2020 2020 6060 6e6f 2d77 6f72          ``no-wor
-000129b0: 6b65 7260 602e 0a20 2020 2020 2020 2022  ker``..        "
-000129c0: 2222 0a20 2020 2020 2020 2069 6620 7365  "".        if se
-000129d0: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-000129e0: 2020 2020 2020 2020 2023 2053 6565 2072           # See r
-000129f0: 6f6f 742d 6973 682d 6e65 7373 206e 6f74  oot-ish-ness not
-00012a00: 6520 6265 6c6f 7720 696e 2060 6465 6369  e below in `deci
-00012a10: 6465 5f77 6f72 6b65 725f 726f 6f74 6973  de_worker_rootis
-00012a20: 685f 7175 6575 696e 675f 656e 6162 6c65  h_queuing_enable
-00012a30: 6460 0a20 2020 2020 2020 2020 2020 2061  d`.            a
-00012a40: 7373 6572 7420 6d61 7468 2e69 7369 6e66  ssert math.isinf
-00012a50: 2873 656c 662e 574f 524b 4552 5f53 4154  (self.WORKER_SAT
-00012a60: 5552 4154 494f 4e29 0a0a 2020 2020 2020  URATION)..      
-00012a70: 2020 706f 6f6c 203d 2073 656c 662e 6964    pool = self.id
-00012a80: 6c65 2e76 616c 7565 7328 2920 6966 2073  le.values() if s
-00012a90: 656c 662e 6964 6c65 2065 6c73 6520 7365  elf.idle else se
-00012aa0: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
-00012ab0: 2020 2069 6620 6e6f 7420 706f 6f6c 3a0a     if not pool:.
-00012ac0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00012ad0: 726e 204e 6f6e 650a 0a20 2020 2020 2020  rn None..       
-00012ae0: 2074 6720 3d20 7473 2e67 726f 7570 0a20   tg = ts.group. 
-00012af0: 2020 2020 2020 206c 7773 203d 2074 672e         lws = tg.
-00012b00: 6c61 7374 5f77 6f72 6b65 720a 2020 2020  last_worker.    
-00012b10: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
-00012b20: 2020 2020 206c 7773 0a20 2020 2020 2020       lws.       
-00012b30: 2020 2020 2061 6e64 2074 672e 6c61 7374       and tg.last
-00012b40: 5f77 6f72 6b65 725f 7461 736b 735f 6c65  _worker_tasks_le
-00012b50: 6674 0a20 2020 2020 2020 2020 2020 2061  ft.            a
-00012b60: 6e64 206c 7773 2e73 7461 7475 7320 3d3d  nd lws.status ==
-00012b70: 2053 7461 7475 732e 7275 6e6e 696e 670a   Status.running.
-00012b80: 2020 2020 2020 2020 2020 2020 616e 6420              and 
-00012b90: 7365 6c66 2e77 6f72 6b65 7273 2e67 6574  self.workers.get
-00012ba0: 286c 7773 2e61 6464 7265 7373 2920 6973  (lws.address) is
-00012bb0: 206c 7773 0a20 2020 2020 2020 2029 3a0a   lws.        ):.
-00012bc0: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
-00012bd0: 206c 7773 0a20 2020 2020 2020 2065 6c73   lws.        els
-00012be0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00012bf0: 204c 6173 742d 7573 6564 2077 6f72 6b65   Last-used worke
-00012c00: 7220 6973 2066 756c 6c2c 2075 6e6b 6e6f  r is full, unkno
-00012c10: 776e 2c20 7265 7469 7269 6e67 2c20 6f72  wn, retiring, or
-00012c20: 2070 6175 7365 643b 0a20 2020 2020 2020   paused;.       
-00012c30: 2020 2020 2023 2070 6963 6b20 6120 6e65       # pick a ne
-00012c40: 7720 776f 726b 6572 2066 6f72 2074 6865  w worker for the
-00012c50: 206e 6578 7420 6665 7720 7461 736b 730a   next few tasks.
-00012c60: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
-00012c70: 206d 696e 2870 6f6f 6c2c 206b 6579 3d70   min(pool, key=p
-00012c80: 6172 7469 616c 2873 656c 662e 776f 726b  artial(self.work
-00012c90: 6572 5f6f 626a 6563 7469 7665 2c20 7473  er_objective, ts
-00012ca0: 2929 0a20 2020 2020 2020 2020 2020 2074  )).            t
-00012cb0: 672e 6c61 7374 5f77 6f72 6b65 725f 7461  g.last_worker_ta
-00012cc0: 736b 735f 6c65 6674 203d 206d 6174 682e  sks_left = math.
-00012cd0: 666c 6f6f 7228 0a20 2020 2020 2020 2020  floor(.         
-00012ce0: 2020 2020 2020 2028 6c65 6e28 7467 2920         (len(tg) 
-00012cf0: 2f20 7365 6c66 2e74 6f74 616c 5f6e 7468  / self.total_nth
-00012d00: 7265 6164 7329 202a 2077 732e 6e74 6872  reads) * ws.nthr
-00012d10: 6561 6473 0a20 2020 2020 2020 2020 2020  eads.           
-00012d20: 2029 0a0a 2020 2020 2020 2020 2320 5265   )..        # Re
-00012d30: 636f 7264 2060 6c61 7374 5f77 6f72 6b65  cord `last_worke
-00012d40: 7260 2c20 6f72 2063 6c65 6172 2069 7420  r`, or clear it 
-00012d50: 6f6e 2074 6865 2066 696e 616c 2074 6173  on the final tas
-00012d60: 6b0a 2020 2020 2020 2020 7467 2e6c 6173  k.        tg.las
-00012d70: 745f 776f 726b 6572 203d 2028 0a20 2020  t_worker = (.   
-00012d80: 2020 2020 2020 2020 2077 7320 6966 2074           ws if t
-00012d90: 672e 7374 6174 6573 5b22 7265 6c65 6173  g.states["releas
-00012da0: 6564 225d 202b 2074 672e 7374 6174 6573  ed"] + tg.states
-00012db0: 5b22 7761 6974 696e 6722 5d20 3e20 3120  ["waiting"] > 1 
-00012dc0: 656c 7365 204e 6f6e 650a 2020 2020 2020  else None.      
-00012dd0: 2020 290a 2020 2020 2020 2020 7467 2e6c    ).        tg.l
-00012de0: 6173 745f 776f 726b 6572 5f74 6173 6b73  ast_worker_tasks
-00012df0: 5f6c 6566 7420 2d3d 2031 0a0a 2020 2020  _left -= 1..    
-00012e00: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00012e10: 6461 7465 2061 6e64 2077 7320 6973 206e  date and ws is n
-00012e20: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00012e30: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
-00012e40: 2e77 6f72 6b65 7273 2e67 6574 2877 732e  .workers.get(ws.
-00012e50: 6164 6472 6573 7329 2069 7320 7773 0a20  address) is ws. 
-00012e60: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00012e70: 7420 7773 2069 6e20 7365 6c66 2e72 756e  t ws in self.run
-00012e80: 6e69 6e67 2c20 2877 732c 2073 656c 662e  ning, (ws, self.
-00012e90: 7275 6e6e 696e 6729 0a0a 2020 2020 2020  running)..      
-00012ea0: 2020 7265 7475 726e 2077 730a 0a20 2020    return ws..   
-00012eb0: 2064 6566 2064 6563 6964 655f 776f 726b   def decide_work
-00012ec0: 6572 5f72 6f6f 7469 7368 5f71 7565 7569  er_rootish_queui
-00012ed0: 6e67 5f65 6e61 626c 6564 2873 656c 6629  ng_enabled(self)
-00012ee0: 202d 3e20 576f 726b 6572 5374 6174 6520   -> WorkerState 
-00012ef0: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
-00012f00: 2222 2250 6963 6b20 6120 776f 726b 6572  """Pick a worker
-00012f10: 2066 6f72 2061 2072 756e 6e61 626c 6520   for a runnable 
-00012f20: 726f 6f74 2d69 7368 2074 6173 6b2c 2069  root-ish task, i
-00012f30: 6620 6e6f 7420 616c 6c20 6172 6520 6275  f not all are bu
-00012f40: 7379 2e0a 0a20 2020 2020 2020 2050 6963  sy...        Pic
-00012f50: 6b73 2074 6865 206c 6561 7374 2d62 7573  ks the least-bus
-00012f60: 7920 776f 726b 6572 206f 7574 206f 6620  y worker out of 
-00012f70: 7468 6520 6060 6964 6c65 6060 2077 6f72  the ``idle`` wor
-00012f80: 6b65 7273 2028 6964 6c65 2077 6f72 6b65  kers (idle worke
-00012f90: 7273 2068 6176 6520 6665 7765 720a 2020  rs have fewer.  
-00012fa0: 2020 2020 2020 7461 736b 7320 7275 6e6e        tasks runn
-00012fb0: 696e 6720 7468 616e 2074 6872 6561 6473  ing than threads
-00012fc0: 2c20 6173 2073 6574 2062 7920 6060 6469  , as set by ``di
-00012fd0: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-00012fe0: 6c65 722e 776f 726b 6572 2d73 6174 7572  ler.worker-satur
-00012ff0: 6174 696f 6e60 6029 2e0a 2020 2020 2020  ation``)..      
-00013000: 2020 4974 2064 6f65 7320 6e6f 7420 636f    It does not co
-00013010: 6e73 6964 6572 2074 6865 206c 6f63 6174  nsider the locat
-00013020: 696f 6e20 6f66 2064 6570 656e 6465 6e63  ion of dependenc
-00013030: 6965 732c 2073 696e 6365 2074 6865 7927  ies, since they'
-00013040: 6c6c 2065 6e64 2075 7020 6f6e 2065 7665  ll end up on eve
-00013050: 7279 0a20 2020 2020 2020 2077 6f72 6b65  ry.        worke
-00013060: 7220 616e 7977 6179 2e0a 0a20 2020 2020  r anyway...     
-00013070: 2020 2049 6620 616c 6c20 776f 726b 6572     If all worker
-00013080: 7320 6172 6520 6675 6c6c 2c20 7265 7475  s are full, retu
-00013090: 726e 7320 4e6f 6e65 2c20 6d65 616e 696e  rns None, meanin
-000130a0: 6720 7468 6520 7461 736b 2073 686f 756c  g the task shoul
-000130b0: 6420 7472 616e 7369 7469 6f6e 2074 6f0a  d transition to.
-000130c0: 2020 2020 2020 2020 6060 7175 6575 6564          ``queued
-000130d0: 6060 2e20 5468 6520 7363 6865 6475 6c65  ``. The schedule
-000130e0: 7220 7769 6c6c 2077 6169 7420 746f 2073  r will wait to s
-000130f0: 656e 6420 6974 2074 6f20 6120 776f 726b  end it to a work
-00013100: 6572 2075 6e74 696c 2061 2074 6872 6561  er until a threa
-00013110: 6420 6f70 656e 730a 2020 2020 2020 2020  d opens.        
-00013120: 7570 2e20 5468 6973 2065 6e73 7572 6573  up. This ensures
-00013130: 2074 6861 7420 646f 776e 7374 7265 616d   that downstream
-00013140: 2074 6173 6b73 2061 6c77 6179 7320 7275   tasks always ru
-00013150: 6e20 6265 666f 7265 206e 6577 2072 6f6f  n before new roo
-00013160: 7420 7461 736b 7320 6172 650a 2020 2020  t tasks are.    
-00013170: 2020 2020 7374 6172 7465 642e 0a0a 2020      started...  
-00013180: 2020 2020 2020 5468 6973 2064 6f65 7320        This does 
-00013190: 6e6f 7420 7472 7920 746f 2073 6368 6564  not try to sched
-000131a0: 756c 6520 7369 626c 696e 6720 7461 736b  ule sibling task
-000131b0: 7320 6f6e 2074 6865 2073 616d 6520 776f  s on the same wo
-000131c0: 726b 6572 3b20 696e 2066 6163 742c 2069  rker; in fact, i
-000131d0: 740a 2020 2020 2020 2020 7573 7561 6c6c  t.        usuall
-000131e0: 7920 646f 6573 2074 6865 206f 7070 6f73  y does the oppos
-000131f0: 6974 652e 2045 7665 6e20 7468 6f75 6768  ite. Even though
-00013200: 2074 6869 7320 696e 6372 6561 7365 7320   this increases 
-00013210: 7375 6273 6571 7565 6e74 2064 6174 6120  subsequent data 
-00013220: 7472 616e 7366 6572 2c0a 2020 2020 2020  transfer,.      
-00013230: 2020 6974 2074 7970 6963 616c 6c79 2072    it typically r
-00013240: 6564 7563 6573 206f 7665 7261 6c6c 206d  educes overall m
-00013250: 656d 6f72 7920 7573 6520 6279 2065 6c69  emory use by eli
-00013260: 6d69 6e61 7469 6e67 2072 6f6f 7420 7461  minating root ta
-00013270: 736b 206f 7665 7270 726f 6475 6374 696f  sk overproductio
-00013280: 6e2e 0a0a 2020 2020 2020 2020 5265 7475  n...        Retu
-00013290: 726e 730a 2020 2020 2020 2020 2d2d 2d2d  rns.        ----
-000132a0: 2d2d 2d0a 2020 2020 2020 2020 7773 3a20  ---.        ws: 
-000132b0: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
-000132c0: 6e65 0a20 2020 2020 2020 2020 2020 2054  ne.            T
-000132d0: 6865 2077 6f72 6b65 7220 746f 2061 7373  he worker to ass
-000132e0: 6967 6e20 7468 6520 7461 736b 2074 6f2e  ign the task to.
-000132f0: 2049 6620 7468 6572 6520 6172 6520 6e6f   If there are no
-00013300: 2069 646c 6520 776f 726b 6572 732c 2072   idle workers, r
-00013310: 6574 7572 6e73 0a20 2020 2020 2020 2020  eturns.         
-00013320: 2020 204e 6f6e 652c 2069 6e20 7768 6963     None, in whic
-00013330: 6820 6361 7365 2074 6865 2074 6173 6b20  h case the task 
-00013340: 7368 6f75 6c64 2062 6520 7472 616e 7369  should be transi
-00013350: 7469 6f6e 6564 2074 6f20 6060 7175 6575  tioned to ``queu
-00013360: 6564 6060 2e0a 0a20 2020 2020 2020 2022  ed``...        "
-00013370: 2222 0a20 2020 2020 2020 2069 6620 7365  "".        if se
-00013380: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00013390: 2020 2020 2020 2020 2023 2057 6520 646f           # We do
-000133a0: 6e27 7420 6061 7373 6572 7420 7365 6c66  n't `assert self
-000133b0: 2e69 735f 726f 6f74 6973 6828 7473 2960  .is_rootish(ts)`
-000133c0: 2068 6572 652c 2062 6563 6175 7365 2074   here, because t
-000133d0: 6861 7420 6368 6563 6b20 6973 0a20 2020  hat check is.   
-000133e0: 2020 2020 2020 2020 2023 2064 6570 656e           # depen
-000133f0: 6465 6e74 206f 6e20 636c 7573 7465 7220  dent on cluster 
-00013400: 7369 7a65 2e20 4974 2773 2070 6f73 7369  size. It's possi
-00013410: 626c 6520 6120 7461 736b 206c 6f6f 6b65  ble a task looke
-00013420: 6420 726f 6f74 2d69 7368 2077 6865 6e20  d root-ish when 
-00013430: 6974 0a20 2020 2020 2020 2020 2020 2023  it.            #
-00013440: 2077 6173 2071 7565 7565 642c 2062 7574   was queued, but
-00013450: 2074 6865 2063 6c75 7374 6572 2068 6173   the cluster has
-00013460: 2073 696e 6365 2073 6361 6c65 6420 7570   since scaled up
-00013470: 2061 6e64 2069 7420 6e6f 206c 6f6e 6765   and it no longe
-00013480: 7220 646f 6573 2077 6865 6e0a 2020 2020  r does when.    
-00013490: 2020 2020 2020 2020 2320 636f 6d69 6e67          # coming
-000134a0: 206f 7574 206f 6620 7468 6520 7175 6575   out of the queu
-000134b0: 652e 2049 6620 6069 735f 726f 6f74 6973  e. If `is_rootis
-000134c0: 6860 2063 6861 6e67 6573 2074 6f20 6120  h` changes to a 
-000134d0: 7374 6174 6963 2064 6566 696e 6974 696f  static definitio
-000134e0: 6e2c 0a20 2020 2020 2020 2020 2020 2023  n,.            #
-000134f0: 2074 6865 6e20 6164 6420 7468 6174 2061   then add that a
-00013500: 7373 6572 7469 6f6e 2068 6572 6520 2861  ssertion here (a
-00013510: 6e64 2061 6374 7561 6c6c 7920 7061 7373  nd actually pass
-00013520: 2069 6e20 7468 6520 7461 736b 292e 0a20   in the task).. 
-00013530: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00013540: 7420 6e6f 7420 6d61 7468 2e69 7369 6e66  t not math.isinf
-00013550: 2873 656c 662e 574f 524b 4552 5f53 4154  (self.WORKER_SAT
-00013560: 5552 4154 494f 4e29 0a0a 2020 2020 2020  URATION)..      
-00013570: 2020 6966 206e 6f74 2073 656c 662e 6964    if not self.id
-00013580: 6c65 5f74 6173 6b5f 636f 756e 743a 0a20  le_task_count:. 
-00013590: 2020 2020 2020 2020 2020 2023 2041 6c6c             # All
-000135a0: 2077 6f72 6b65 7273 2062 7573 793f 2054   workers busy? T
-000135b0: 6173 6b20 6765 7473 2f73 7461 7973 2071  ask gets/stays q
-000135c0: 7565 7565 642e 0a20 2020 2020 2020 2020  ueued..         
-000135d0: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
-000135e0: 2020 2020 2020 2020 2320 4a75 7374 2070          # Just p
-000135f0: 6963 6b20 7468 6520 6c65 6173 7420 6275  ick the least bu
-00013600: 7379 2077 6f72 6b65 722e 0a20 2020 2020  sy worker..     
-00013610: 2020 2023 204e 4f54 453a 2074 6869 7320     # NOTE: this 
-00013620: 7769 6c6c 206c 6561 6420 746f 2077 6f72  will lead to wor
-00013630: 7374 2d63 6173 6520 7363 6865 6475 6c69  st-case scheduli
-00013640: 6e67 2077 6974 6820 7265 6761 7264 7320  ng with regards 
-00013650: 746f 2063 6f2d 6173 7369 676e 6d65 6e74  to co-assignment
-00013660: 2e0a 2020 2020 2020 2020 7773 203d 206d  ..        ws = m
-00013670: 696e 280a 2020 2020 2020 2020 2020 2020  in(.            
-00013680: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
-00013690: 6f75 6e74 2c0a 2020 2020 2020 2020 2020  ount,.          
-000136a0: 2020 6b65 793d 6c61 6d62 6461 2077 733a    key=lambda ws:
-000136b0: 206c 656e 2877 732e 7072 6f63 6573 7369   len(ws.processi
-000136c0: 6e67 2920 2f20 7773 2e6e 7468 7265 6164  ng) / ws.nthread
-000136d0: 732c 0a20 2020 2020 2020 2029 0a20 2020  s,.        ).   
-000136e0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-000136f0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-00013700: 2020 2061 7373 6572 7420 7365 6c66 2e77     assert self.w
-00013710: 6f72 6b65 7273 2e67 6574 2877 732e 6164  orkers.get(ws.ad
-00013720: 6472 6573 7329 2069 7320 7773 0a20 2020  dress) is ws.   
-00013730: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00013740: 6e6f 7420 5f77 6f72 6b65 725f 6675 6c6c  not _worker_full
-00013750: 2877 732c 2073 656c 662e 574f 524b 4552  (ws, self.WORKER
-00013760: 5f53 4154 5552 4154 494f 4e29 2c20 280a  _SATURATION), (.
-00013770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013780: 7773 2c0a 2020 2020 2020 2020 2020 2020  ws,.            
-00013790: 2020 2020 5f74 6173 6b5f 736c 6f74 735f      _task_slots_
-000137a0: 6176 6169 6c61 626c 6528 7773 2c20 7365  available(ws, se
-000137b0: 6c66 2e57 4f52 4b45 525f 5341 5455 5241  lf.WORKER_SATURA
-000137c0: 5449 4f4e 292c 0a20 2020 2020 2020 2020  TION),.         
-000137d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000137e0: 2061 7373 6572 7420 7773 2069 6e20 7365   assert ws in se
-000137f0: 6c66 2e72 756e 6e69 6e67 2c20 2877 732c  lf.running, (ws,
-00013800: 2073 656c 662e 7275 6e6e 696e 6729 0a0a   self.running)..
-00013810: 2020 2020 2020 2020 7265 7475 726e 2077          return w
-00013820: 730a 0a20 2020 2064 6566 2064 6563 6964  s..    def decid
-00013830: 655f 776f 726b 6572 5f6e 6f6e 5f72 6f6f  e_worker_non_roo
-00013840: 7469 7368 2873 656c 662c 2074 733a 2054  tish(self, ts: T
-00013850: 6173 6b53 7461 7465 2920 2d3e 2057 6f72  askState) -> Wor
-00013860: 6b65 7253 7461 7465 207c 204e 6f6e 653a  kerState | None:
-00013870: 0a20 2020 2020 2020 2022 2222 5069 636b  .        """Pick
-00013880: 2061 2077 6f72 6b65 7220 666f 7220 6120   a worker for a 
-00013890: 7275 6e6e 6162 6c65 206e 6f6e 2d72 6f6f  runnable non-roo
-000138a0: 7420 7461 736b 2c20 636f 6e73 6964 6572  t task, consider
-000138b0: 696e 6720 6465 7065 6e64 656e 6369 6573  ing dependencies
-000138c0: 2061 6e64 0a20 2020 2020 2020 2072 6573   and.        res
-000138d0: 7472 6963 7469 6f6e 732e 0a0a 2020 2020  trictions...    
-000138e0: 2020 2020 4f75 7420 6f66 2065 6c69 6769      Out of eligi
-000138f0: 626c 6520 776f 726b 6572 7320 686f 6c64  ble workers hold
-00013900: 696e 6720 6465 7065 6e64 656e 6369 6573  ing dependencies
-00013910: 206f 6620 6060 7473 6060 2c20 7365 6c65   of ``ts``, sele
-00013920: 6374 7320 7468 6520 776f 726b 6572 0a20  cts the worker. 
-00013930: 2020 2020 2020 2077 6865 7265 2c20 636f         where, co
-00013940: 6e73 6964 6572 696e 6720 776f 726b 6572  nsidering worker
-00013950: 2062 6163 6b6c 6f67 2061 6e64 2064 6174   backlog and dat
-00013960: 612d 7472 616e 7366 6572 2063 6f73 7473  a-transfer costs
-00013970: 2c20 7468 6520 7461 736b 2069 730a 2020  , the task is.  
-00013980: 2020 2020 2020 6573 7469 6d61 7465 6420        estimated 
-00013990: 746f 2073 7461 7274 2072 756e 6e69 6e67  to start running
-000139a0: 2074 6865 2073 6f6f 6e65 7374 2e0a 0a20   the soonest... 
-000139b0: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
-000139c0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
-000139d0: 2020 2020 2020 2077 733a 2057 6f72 6b65         ws: Worke
-000139e0: 7253 7461 7465 207c 204e 6f6e 650a 2020  rState | None.  
-000139f0: 2020 2020 2020 2020 2020 5468 6520 776f            The wo
-00013a00: 726b 6572 2074 6f20 6173 7369 676e 2074  rker to assign t
-00013a10: 6865 2074 6173 6b20 746f 2e20 4966 206e  he task to. If n
-00013a20: 6f20 776f 726b 6572 7320 7361 7469 7366  o workers satisf
-00013a30: 7920 7468 6520 7265 7374 7269 6374 696f  y the restrictio
-00013a40: 6e73 206f 660a 2020 2020 2020 2020 2020  ns of.          
-00013a50: 2020 6060 7473 6060 206f 7220 7468 6572    ``ts`` or ther
-00013a60: 6520 6172 6520 6e6f 2072 756e 6e69 6e67  e are no running
-00013a70: 2077 6f72 6b65 7273 2c20 7265 7475 726e   workers, return
-00013a80: 7320 4e6f 6e65 2c20 696e 2077 6869 6368  s None, in which
-00013a90: 2063 6173 6520 7468 6520 7461 736b 0a20   case the task. 
-00013aa0: 2020 2020 2020 2020 2020 2073 686f 756c             shoul
-00013ab0: 6420 6265 2074 7261 6e73 6974 696f 6e65  d be transitione
-00013ac0: 6420 746f 2060 606e 6f2d 776f 726b 6572  d to ``no-worker
-00013ad0: 6060 2e0a 2020 2020 2020 2020 2222 220a  ``..        """.
-00013ae0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00013af0: 656c 662e 7275 6e6e 696e 673a 0a20 2020  elf.running:.   
-00013b00: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00013b10: 4e6f 6e65 0a0a 2020 2020 2020 2020 7661  None..        va
-00013b20: 6c69 645f 776f 726b 6572 7320 3d20 7365  lid_workers = se
-00013b30: 6c66 2e76 616c 6964 5f77 6f72 6b65 7273  lf.valid_workers
-00013b40: 2874 7329 0a20 2020 2020 2020 2069 6620  (ts).        if 
-00013b50: 7661 6c69 645f 776f 726b 6572 7320 6973  valid_workers is
-00013b60: 204e 6f6e 6520 616e 6420 6c65 6e28 7365   None and len(se
-00013b70: 6c66 2e72 756e 6e69 6e67 2920 3c20 6c65  lf.running) < le
-00013b80: 6e28 7365 6c66 2e77 6f72 6b65 7273 293a  n(self.workers):
-00013b90: 0a20 2020 2020 2020 2020 2020 2023 2049  .            # I
-00013ba0: 6620 7468 6572 6520 7765 7265 206e 6f20  f there were no 
-00013bb0: 7265 7374 7269 6374 696f 6e73 2c20 6076  restrictions, `v
-00013bc0: 616c 6964 5f77 6f72 6b65 7273 2829 6020  alid_workers()` 
-00013bd0: 6469 646e 2774 2073 7562 7365 7420 6279  didn't subset by
-00013be0: 0a20 2020 2020 2020 2020 2020 2023 2060  .            # `
-00013bf0: 7275 6e6e 696e 6760 2e0a 2020 2020 2020  running`..      
-00013c00: 2020 2020 2020 7661 6c69 645f 776f 726b        valid_work
-00013c10: 6572 7320 3d20 7365 6c66 2e72 756e 6e69  ers = self.runni
-00013c20: 6e67 0a0a 2020 2020 2020 2020 6966 2074  ng..        if t
-00013c30: 732e 6465 7065 6e64 656e 6369 6573 206f  s.dependencies o
-00013c40: 7220 7661 6c69 645f 776f 726b 6572 7320  r valid_workers 
-00013c50: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00013c60: 2020 2020 2020 2020 2077 7320 3d20 6465           ws = de
-00013c70: 6369 6465 5f77 6f72 6b65 7228 0a20 2020  cide_worker(.   
-00013c80: 2020 2020 2020 2020 2020 2020 2074 732c               ts,
-00013c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013ca0: 2073 656c 662e 7275 6e6e 696e 672c 0a20   self.running,. 
-00013cb0: 2020 2020 2020 2020 2020 2020 2020 2076                 v
-00013cc0: 616c 6964 5f77 6f72 6b65 7273 2c0a 2020  alid_workers,.  
-00013cd0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00013ce0: 7274 6961 6c28 7365 6c66 2e77 6f72 6b65  rtial(self.worke
-00013cf0: 725f 6f62 6a65 6374 6976 652c 2074 7329  r_objective, ts)
-00013d00: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00013d10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00013d20: 2020 2020 2020 2020 2020 2320 544f 444f            # TODO
-00013d30: 2069 6620 6069 735f 726f 6f74 6973 6860   if `is_rootish`
-00013d40: 2077 6f75 6c64 2061 6c77 6179 7320 7265   would always re
-00013d50: 7475 726e 2054 7275 6520 666f 7220 7461  turn True for ta
-00013d60: 736b 7320 7769 7468 6f75 740a 2020 2020  sks without.    
-00013d70: 2020 2020 2020 2020 2320 6465 7065 6e64          # depend
-00013d80: 656e 6369 6573 2c20 7765 2063 6f75 6c64  encies, we could
-00013d90: 2072 656d 6f76 6520 616c 6c20 7468 6973   remove all this
-00013da0: 206c 6f67 6963 2e20 5468 6520 726f 6f74   logic. The root
-00013db0: 6973 6820 6173 7369 676e 6d65 6e74 206c  ish assignment l
-00013dc0: 6f67 6963 0a20 2020 2020 2020 2020 2020  ogic.           
-00013dd0: 2023 2077 6f75 6c64 2062 6568 6176 6520   # would behave 
-00013de0: 6d6f 7265 206f 7220 6c65 7373 2074 6865  more or less the
-00013df0: 2073 616d 6520 6173 2074 6869 732c 206d   same as this, m
-00013e00: 6179 6265 2077 6974 686f 7574 2067 7561  aybe without gua
-00013e10: 7261 6e74 6565 640a 2020 2020 2020 2020  ranteed.        
-00013e20: 2020 2020 2320 726f 756e 642d 726f 6269      # round-robi
-00013e30: 6e20 7468 6f75 6768 3f20 5468 6973 2070  n though? This p
-00013e40: 6174 6820 6973 206f 6e6c 7920 7265 6163  ath is only reac
-00013e50: 6861 626c 6520 7768 656e 2060 7473 6020  hable when `ts` 
-00013e60: 646f 6573 6e27 7420 6861 7665 0a20 2020  doesn't have.   
-00013e70: 2020 2020 2020 2020 2023 2064 6570 656e           # depen
-00013e80: 6465 6e63 6965 732c 2062 7574 2069 7473  dencies, but its
-00013e90: 2067 726f 7570 2069 7320 616c 736f 2073   group is also s
-00013ea0: 6d61 6c6c 6572 2074 6861 6e20 7468 6520  maller than the 
-00013eb0: 636c 7573 7465 722e 0a0a 2020 2020 2020  cluster...      
-00013ec0: 2020 2020 2020 2320 4661 7374 7061 7468        # Fastpath
-00013ed0: 2077 6865 6e20 7468 6572 6520 6172 6520   when there are 
-00013ee0: 6e6f 2072 656c 6174 6564 2074 6173 6b73  no related tasks
-00013ef0: 206f 7220 7265 7374 7269 6374 696f 6e73   or restrictions
-00013f00: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-00013f10: 6b65 725f 706f 6f6c 203d 2073 656c 662e  ker_pool = self.
-00013f20: 6964 6c65 206f 7220 7365 6c66 2e77 6f72  idle or self.wor
-00013f30: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
-00013f40: 2023 2046 4958 4d45 2069 646c 6520 616e   # FIXME idle an
-00013f50: 6420 776f 726b 6572 7320 6172 6520 536f  d workers are So
-00013f60: 7274 6564 4469 6374 2773 2064 6563 6c61  rtedDict's decla
-00013f70: 7265 6420 6173 2064 6963 7473 0a20 2020  red as dicts.   
-00013f80: 2020 2020 2020 2020 2023 2020 2020 2020           #      
-00013f90: 2062 6563 6175 7365 2073 6f72 7465 6463   because sortedc
-00013fa0: 6f6e 7461 696e 6572 7320 6973 206e 6f74  ontainers is not
-00013fb0: 2061 6e6e 6f74 6174 6564 0a20 2020 2020   annotated.     
-00013fc0: 2020 2020 2020 2077 705f 7661 6c73 203d         wp_vals =
-00013fd0: 2063 6173 7428 2253 6571 7565 6e63 655b   cast("Sequence[
-00013fe0: 576f 726b 6572 5374 6174 655d 222c 2077  WorkerState]", w
-00013ff0: 6f72 6b65 725f 706f 6f6c 2e76 616c 7565  orker_pool.value
-00014000: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
-00014010: 206e 5f77 6f72 6b65 7273 203d 206c 656e   n_workers = len
-00014020: 2877 705f 7661 6c73 290a 2020 2020 2020  (wp_vals).      
-00014030: 2020 2020 2020 6966 206e 5f77 6f72 6b65        if n_worke
-00014040: 7273 203c 2032 303a 2020 2320 736d 6172  rs < 20:  # smar
-00014050: 7420 6275 7420 6c69 6e65 6172 2069 6e20  t but linear in 
-00014060: 736d 616c 6c20 6361 7365 0a20 2020 2020  small case.     
-00014070: 2020 2020 2020 2020 2020 2077 7320 3d20             ws = 
-00014080: 6d69 6e28 7770 5f76 616c 732c 206b 6579  min(wp_vals, key
-00014090: 3d6f 7065 7261 746f 722e 6174 7472 6765  =operator.attrge
-000140a0: 7474 6572 2822 6f63 6375 7061 6e63 7922  tter("occupancy"
-000140b0: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-000140c0: 2020 2061 7373 6572 7420 7773 0a20 2020     assert ws.   
-000140d0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000140e0: 7773 2e6f 6363 7570 616e 6379 203d 3d20  ws.occupancy == 
-000140f0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00014100: 2020 2020 2020 2023 2073 7065 6369 616c         # special
-00014110: 2063 6173 6520 746f 2075 7365 2072 6f75   case to use rou
-00014120: 6e64 2d72 6f62 696e 3b20 6c69 6e65 6172  nd-robin; linear
-00014130: 2073 6561 7263 680a 2020 2020 2020 2020   search.        
-00014140: 2020 2020 2020 2020 2020 2020 2320 666f              # fo
-00014150: 7220 6e65 7874 2077 6f72 6b65 7220 7769  r next worker wi
-00014160: 7468 207a 6572 6f20 6f63 6375 7061 6e63  th zero occupanc
-00014170: 7920 286f 7220 6a75 7374 0a20 2020 2020  y (or just.     
-00014180: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00014190: 206c 616e 6420 6261 636b 2077 6865 7265   land back where
-000141a0: 2077 6520 7374 6172 7465 6429 2e0a 2020   we started)..  
-000141b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141c0: 2020 7374 6172 7420 3d20 7365 6c66 2e6e    start = self.n
-000141d0: 5f74 6173 6b73 2025 206e 5f77 6f72 6b65  _tasks % n_worke
-000141e0: 7273 0a20 2020 2020 2020 2020 2020 2020  rs.             
-000141f0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-00014200: 7261 6e67 6528 6e5f 776f 726b 6572 7329  range(n_workers)
-00014210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014220: 2020 2020 2020 2020 2020 7770 5f69 203d            wp_i =
-00014230: 2077 705f 7661 6c73 5b28 6920 2b20 7374   wp_vals[(i + st
-00014240: 6172 7429 2025 206e 5f77 6f72 6b65 7273  art) % n_workers
-00014250: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00014260: 2020 2020 2020 2020 2020 6966 2077 705f            if wp_
-00014270: 692e 6f63 6375 7061 6e63 7920 3d3d 2030  i.occupancy == 0
-00014280: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014290: 2020 2020 2020 2020 2020 2020 2020 7773                ws
-000142a0: 203d 2077 705f 690a 2020 2020 2020 2020   = wp_i.        
+000116c0: 2020 2020 2020 2020 2020 6b65 792c 2073            key, s
+000116d0: 7461 7274 2c20 6163 7475 616c 5f66 696e  tart, actual_fin
+000116e0: 6973 682c 2073 7469 6d75 6c75 735f 6964  ish, stimulus_id
+000116f0: 3d73 7469 6d75 6c75 735f 6964 2c20 2a2a  =stimulus_id, **
+00011700: 6b77 6172 6773 0a20 2020 2020 2020 2020  kwargs.         
+00011710: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00011720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011730: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+00011740: 7074 696f 6e3a 0a20 2020 2020 2020 2020  ption:.         
+00011750: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00011760: 6f67 6765 722e 696e 666f 2822 506c 7567  ogger.info("Plug
+00011770: 696e 2066 6169 6c65 6420 7769 7468 2065  in failed with e
+00011780: 7863 6570 7469 6f6e 222c 2065 7863 5f69  xception", exc_i
+00011790: 6e66 6f3d 5472 7565 290a 2020 2020 2020  nfo=True).      
+000117a0: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
+000117b0: 7374 6174 6520 3d3d 2022 666f 7267 6f74  state == "forgot
+000117c0: 7465 6e22 3a0a 2020 2020 2020 2020 2020  ten":.          
+000117d0: 2020 2020 2020 2020 2020 6465 6c20 7365            del se
+000117e0: 6c66 2e74 6173 6b73 5b74 732e 6b65 795d  lf.tasks[ts.key]
+000117f0: 0a0a 2020 2020 2020 2020 2020 2020 7467  ..            tg
+00011800: 203d 2074 732e 6772 6f75 700a 2020 2020   = ts.group.    
+00011810: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
+00011820: 6174 6520 3d3d 2022 666f 7267 6f74 7465  ate == "forgotte
+00011830: 6e22 2061 6e64 2074 672e 6e61 6d65 2069  n" and tg.name i
+00011840: 6e20 7365 6c66 2e74 6173 6b5f 6772 6f75  n self.task_grou
+00011850: 7073 3a0a 2020 2020 2020 2020 2020 2020  ps:.            
+00011860: 2020 2020 2320 5265 6d6f 7665 2054 6173      # Remove Tas
+00011870: 6b47 726f 7570 2069 6620 616c 6c20 7461  kGroup if all ta
+00011880: 736b 7320 6172 6520 696e 2074 6865 2066  sks are in the f
+00011890: 6f72 676f 7474 656e 2073 7461 7465 0a20  orgotten state. 
+000118a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000118b0: 6620 616c 6c28 7620 3d3d 2030 206f 7220  f all(v == 0 or 
+000118c0: 6b20 3d3d 2022 666f 7267 6f74 7465 6e22  k == "forgotten"
+000118d0: 2066 6f72 206b 2c20 7620 696e 2074 672e   for k, v in tg.
+000118e0: 7374 6174 6573 2e69 7465 6d73 2829 293a  states.items()):
+000118f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011900: 2020 2020 2074 732e 7072 6566 6978 2e67       ts.prefix.g
+00011910: 726f 7570 732e 7265 6d6f 7665 2874 6729  roups.remove(tg)
+00011920: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011930: 2020 2020 2064 656c 2073 656c 662e 7461       del self.ta
+00011940: 736b 5f67 726f 7570 735b 7467 2e6e 616d  sk_groups[tg.nam
+00011950: 655d 0a0a 2020 2020 2020 2020 2020 2020  e]..            
+00011960: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+00011970: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
+00011980: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
+00011990: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+000119a0: 4578 6365 7074 696f 6e3a 0a20 2020 2020  Exception:.     
+000119b0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
+000119c0: 6365 7074 696f 6e28 2245 7272 6f72 2074  ception("Error t
+000119d0: 7261 6e73 6974 696f 6e69 6e67 2025 7220  ransitioning %r 
+000119e0: 6672 6f6d 2025 7220 746f 2025 7222 2c20  from %r to %r", 
+000119f0: 6b65 792c 2073 7461 7274 2c20 6669 6e69  key, start, fini
+00011a00: 7368 290a 2020 2020 2020 2020 2020 2020  sh).            
+00011a10: 6966 204c 4f47 5f50 4442 3a0a 2020 2020  if LOG_PDB:.    
+00011a20: 2020 2020 2020 2020 2020 2020 696d 706f              impo
+00011a30: 7274 2070 6462 0a0a 2020 2020 2020 2020  rt pdb..        
+00011a40: 2020 2020 2020 2020 7064 622e 7365 745f          pdb.set_
+00011a50: 7472 6163 6528 290a 2020 2020 2020 2020  trace().        
+00011a60: 2020 2020 7261 6973 650a 0a20 2020 2064      raise..    d
+00011a70: 6566 205f 7472 616e 7369 7469 6f6e 7328  ef _transitions(
+00011a80: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00011a90: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+00011aa0: 6174 696f 6e73 3a20 5265 6373 2c0a 2020  ations: Recs,.  
+00011ab0: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
+00011ac0: 733a 204d 7367 732c 0a20 2020 2020 2020  s: Msgs,.       
+00011ad0: 2077 6f72 6b65 725f 6d73 6773 3a20 4d73   worker_msgs: Ms
+00011ae0: 6773 2c0a 2020 2020 2020 2020 7374 696d  gs,.        stim
+00011af0: 756c 7573 5f69 643a 2073 7472 2c0a 2020  ulus_id: str,.  
+00011b00: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+00011b10: 2020 2020 2022 2222 5072 6f63 6573 7320       """Process 
+00011b20: 7472 616e 7369 7469 6f6e 7320 756e 7469  transitions unti
+00011b30: 6c20 6e6f 6e65 2061 7265 206c 6566 740a  l none are left.
+00011b40: 0a20 2020 2020 2020 2054 6869 7320 696e  .        This in
+00011b50: 636c 7564 6573 2066 6565 6462 6163 6b20  cludes feedback 
+00011b60: 6672 6f6d 2070 7265 7669 6f75 7320 7472  from previous tr
+00011b70: 616e 7369 7469 6f6e 7320 616e 6420 636f  ansitions and co
+00011b80: 6e74 696e 7565 7320 756e 7469 6c20 7765  ntinues until we
+00011b90: 0a20 2020 2020 2020 2072 6561 6368 2061  .        reach a
+00011ba0: 2073 7465 6164 7920 7374 6174 650a 2020   steady state.  
+00011bb0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00011bc0: 2020 6b65 7973 3a20 7365 745b 4b65 795d    keys: set[Key]
+00011bd0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+00011be0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00011bf0: 203d 2072 6563 6f6d 6d65 6e64 6174 696f   = recommendatio
+00011c00: 6e73 2e63 6f70 7928 290a 0a20 2020 2020  ns.copy()..     
+00011c10: 2020 2077 6869 6c65 2072 6563 6f6d 6d65     while recomme
+00011c20: 6e64 6174 696f 6e73 3a0a 2020 2020 2020  ndations:.      
+00011c30: 2020 2020 2020 6b65 792c 2066 696e 6973        key, finis
+00011c40: 6820 3d20 7265 636f 6d6d 656e 6461 7469  h = recommendati
+00011c50: 6f6e 732e 706f 7069 7465 6d28 290a 2020  ons.popitem().  
+00011c60: 2020 2020 2020 2020 2020 6b65 7973 2e61            keys.a
+00011c70: 6464 286b 6579 290a 0a20 2020 2020 2020  dd(key)..       
+00011c80: 2020 2020 206e 6577 5f72 6563 732c 206e       new_recs, n
+00011c90: 6577 5f63 6d73 6773 2c20 6e65 775f 776d  ew_cmsgs, new_wm
+00011ca0: 7367 7320 3d20 7365 6c66 2e5f 7472 616e  sgs = self._tran
+00011cb0: 7369 7469 6f6e 286b 6579 2c20 6669 6e69  sition(key, fini
+00011cc0: 7368 2c20 7374 696d 756c 7573 5f69 6429  sh, stimulus_id)
+00011cd0: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
+00011ce0: 636f 6d6d 656e 6461 7469 6f6e 732e 7570  commendations.up
+00011cf0: 6461 7465 286e 6577 5f72 6563 7329 0a20  date(new_recs). 
+00011d00: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
+00011d10: 2c20 6e65 775f 6d73 6773 2069 6e20 6e65  , new_msgs in ne
+00011d20: 775f 636d 7367 732e 6974 656d 7328 293a  w_cmsgs.items():
+00011d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011d40: 2063 6c69 656e 745f 6d73 6773 2e73 6574   client_msgs.set
+00011d50: 6465 6661 756c 7428 632c 205b 5d29 2e65  default(c, []).e
+00011d60: 7874 656e 6428 6e65 775f 6d73 6773 290a  xtend(new_msgs).
+00011d70: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00011d80: 772c 206e 6577 5f6d 7367 7320 696e 206e  w, new_msgs in n
+00011d90: 6577 5f77 6d73 6773 2e69 7465 6d73 2829  ew_wmsgs.items()
+00011da0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00011db0: 2020 776f 726b 6572 5f6d 7367 732e 7365    worker_msgs.se
+00011dc0: 7464 6566 6175 6c74 2877 2c20 5b5d 292e  tdefault(w, []).
+00011dd0: 6578 7465 6e64 286e 6577 5f6d 7367 7329  extend(new_msgs)
+00011de0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00011df0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+00011e00: 2020 2020 2020 2020 2320 4649 584d 4520          # FIXME 
+00011e10: 646f 776e 6361 7374 2061 6e74 6970 6174  downcast antipat
+00011e20: 7465 726e 0a20 2020 2020 2020 2020 2020  tern.           
+00011e30: 2073 6368 6564 756c 6572 203d 2063 6173   scheduler = cas
+00011e40: 7428 5363 6865 6475 6c65 722c 2073 656c  t(Scheduler, sel
+00011e50: 6629 0a20 2020 2020 2020 2020 2020 2066  f).            f
+00011e60: 6f72 206b 6579 2069 6e20 6b65 7973 3a0a  or key in keys:.
+00011e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011e80: 7363 6865 6475 6c65 722e 7661 6c69 6461  scheduler.valida
+00011e90: 7465 5f6b 6579 286b 6579 290a 0a20 2020  te_key(key)..   
+00011ea0: 2064 6566 205f 7472 616e 7369 7469 6f6e   def _transition
+00011eb0: 5f72 656c 6561 7365 645f 7761 6974 696e  _released_waitin
+00011ec0: 6728 7365 6c66 2c20 6b65 793a 204b 6579  g(self, key: Key
+00011ed0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+00011ee0: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
+00011ef0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00011f00: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
+00011f10: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00011f20: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00011f30: 2020 2020 2061 7373 6572 7420 7473 2e72       assert ts.r
+00011f40: 756e 5f73 7065 630a 2020 2020 2020 2020  un_spec.        
+00011f50: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00011f60: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+00011f70: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00011f80: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
+00011f90: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00011fa0: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
+00011fb0: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
+00011fc0: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+00011fd0: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
+00011fe0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00011ff0: 7373 6572 7420 6474 732e 7374 6174 6520  ssert dts.state 
+00012000: 6e6f 7420 696e 207b 2266 6f72 676f 7474  not in {"forgott
+00012010: 656e 222c 2022 6572 7265 6422 7d2c 2028  en", "erred"}, (
+00012020: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012030: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
+00012040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012050: 2020 7374 7228 6474 7329 2c0a 2020 2020    str(dts),.    
+00012060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012070: 7365 6c66 2e74 7261 6e73 6974 696f 6e5f  self.transition_
+00012080: 6c6f 672c 0a20 2020 2020 2020 2020 2020  log,.           
+00012090: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+000120a0: 6966 2074 732e 6861 735f 6c6f 7374 5f64  if ts.has_lost_d
+000120b0: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
+000120c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000120d0: 7b6b 6579 3a20 2266 6f72 676f 7474 656e  {key: "forgotten
+000120e0: 227d 2c20 7b7d 2c20 7b7d 0a0a 2020 2020  "}, {}, {}..    
+000120f0: 2020 2020 7473 2e73 7461 7465 203d 2022      ts.state = "
+00012100: 7761 6974 696e 6722 0a0a 2020 2020 2020  waiting"..      
+00012110: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
+00012120: 733a 2052 6563 7320 3d20 7b7d 0a0a 2020  s: Recs = {}..  
+00012130: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
+00012140: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+00012150: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00012160: 206e 6f74 2064 7473 2e77 686f 5f68 6173   not dts.who_has
+00012170: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012180: 2020 6966 206e 6f74 2074 732e 7761 6974    if not ts.wait
+00012190: 696e 675f 6f6e 3a0a 2020 2020 2020 2020  ing_on:.        
+000121a0: 2020 2020 2020 2020 2020 2020 7473 2e77              ts.w
+000121b0: 6169 7469 6e67 5f6f 6e20 3d20 7365 7428  aiting_on = set(
+000121c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000121d0: 2020 7473 2e77 6169 7469 6e67 5f6f 6e2e    ts.waiting_on.
+000121e0: 6164 6428 6474 7329 0a20 2020 2020 2020  add(dts).       
+000121f0: 2020 2020 2069 6620 6474 732e 7374 6174       if dts.stat
+00012200: 6520 3d3d 2022 7265 6c65 6173 6564 223a  e == "released":
+00012210: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012220: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00012230: 5b64 7473 2e6b 6579 5d20 3d20 2277 6169  [dts.key] = "wai
+00012240: 7469 6e67 220a 2020 2020 2020 2020 2020  ting".          
+00012250: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00012260: 2020 2020 2020 2020 6966 206e 6f74 2064          if not d
+00012270: 7473 2e77 6169 7465 7273 3a0a 2020 2020  ts.waiters:.    
+00012280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012290: 6474 732e 7761 6974 6572 7320 3d20 7365  dts.waiters = se
+000122a0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+000122b0: 2020 2020 6474 732e 7761 6974 6572 732e      dts.waiters.
+000122c0: 6164 6428 7473 290a 0a20 2020 2020 2020  add(ts)..       
+000122d0: 2074 732e 7761 6974 6572 7320 3d20 7b64   ts.waiters = {d
+000122e0: 7473 2066 6f72 2064 7473 2069 6e20 7473  ts for dts in ts
+000122f0: 2e64 6570 656e 6465 6e74 7320 6966 2064  .dependents if d
+00012300: 7473 2e73 7461 7465 203d 3d20 2277 6169  ts.state == "wai
+00012310: 7469 6e67 227d 0a0a 2020 2020 2020 2020  ting"}..        
+00012320: 6966 206e 6f74 2074 732e 7761 6974 696e  if not ts.waitin
+00012330: 675f 6f6e 3a0a 2020 2020 2020 2020 2020  g_on:.          
+00012340: 2020 2320 4e4f 5445 3a20 7761 6974 696e    # NOTE: waitin
+00012350: 672d 3e70 726f 6365 7373 696e 6720 7769  g->processing wi
+00012360: 6c6c 2073 656e 6420 7461 736b 7320 746f  ll send tasks to
+00012370: 2071 7565 7565 6420 6f72 206e 6f2d 776f   queued or no-wo
+00012380: 726b 6572 2061 730a 2020 2020 2020 2020  rker as.        
+00012390: 2020 2020 2320 6e65 6365 7373 6172 790a      # necessary.
+000123a0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+000123b0: 6d6d 656e 6461 7469 6f6e 735b 6b65 795d  mmendations[key]
+000123c0: 203d 2022 7072 6f63 6573 7369 6e67 220a   = "processing".
+000123d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000123e0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+000123f0: 207b 7d2c 207b 7d0a 0a20 2020 2064 6566   {}, {}..    def
+00012400: 205f 7472 616e 7369 7469 6f6e 5f6e 6f5f   _transition_no_
+00012410: 776f 726b 6572 5f70 726f 6365 7373 696e  worker_processin
+00012420: 6728 7365 6c66 2c20 6b65 793a 204b 6579  g(self, key: Key
+00012430: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+00012440: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
+00012450: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00012460: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
+00012470: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00012480: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00012490: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+000124a0: 7473 2e61 6374 6f72 2c20 6622 4163 746f  ts.actor, f"Acto
+000124b0: 7273 2063 616e 2774 2062 6520 696e 2060  rs can't be in `
+000124c0: 6e6f 2d77 6f72 6b65 7260 3a20 7b74 737d  no-worker`: {ts}
+000124d0: 220a 2020 2020 2020 2020 2020 2020 6173  ".            as
+000124e0: 7365 7274 2074 7320 696e 2073 656c 662e  sert ts in self.
+000124f0: 756e 7275 6e6e 6162 6c65 0a0a 2020 2020  unrunnable..    
+00012500: 2020 2020 6966 2077 7320 3a3d 2073 656c      if ws := sel
+00012510: 662e 6465 6369 6465 5f77 6f72 6b65 725f  f.decide_worker_
+00012520: 6e6f 6e5f 726f 6f74 6973 6828 7473 293a  non_rootish(ts):
+00012530: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00012540: 662e 756e 7275 6e6e 6162 6c65 2e64 6973  f.unrunnable.dis
+00012550: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+00012560: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00012570: 2e5f 6164 645f 746f 5f70 726f 6365 7373  ._add_to_process
+00012580: 696e 6728 7473 2c20 7773 2c20 7374 696d  ing(ts, ws, stim
+00012590: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+000125a0: 5f69 6429 0a20 2020 2020 2020 2023 2049  _id).        # I
+000125b0: 6620 6e6f 2077 6f72 6b65 722c 2074 6173  f no worker, tas
+000125c0: 6b20 6a75 7374 2073 7461 7973 2069 6e20  k just stays in 
+000125d0: 606e 6f2d 776f 726b 6572 600a 0a20 2020  `no-worker`..   
+000125e0: 2020 2020 2072 6574 7572 6e20 7b7d 2c20       return {}, 
+000125f0: 7b7d 2c20 7b7d 0a0a 2020 2020 6465 6620  {}, {}..    def 
+00012600: 6465 6369 6465 5f77 6f72 6b65 725f 726f  decide_worker_ro
+00012610: 6f74 6973 685f 7175 6575 696e 675f 6469  otish_queuing_di
+00012620: 7361 626c 6564 280a 2020 2020 2020 2020  sabled(.        
+00012630: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
+00012640: 6174 650a 2020 2020 2920 2d3e 2057 6f72  ate.    ) -> Wor
+00012650: 6b65 7253 7461 7465 207c 204e 6f6e 653a  kerState | None:
+00012660: 0a20 2020 2020 2020 2022 2222 5069 636b  .        """Pick
+00012670: 2061 2077 6f72 6b65 7220 666f 7220 6120   a worker for a 
+00012680: 7275 6e6e 6162 6c65 2072 6f6f 742d 6973  runnable root-is
+00012690: 6820 7461 736b 2c20 7769 7468 6f75 7420  h task, without 
+000126a0: 7175 6575 696e 672e 0a0a 2020 2020 2020  queuing...      
+000126b0: 2020 5468 6973 2061 7474 656d 7074 7320    This attempts 
+000126c0: 746f 2073 6368 6564 756c 6520 7369 626c  to schedule sibl
+000126d0: 696e 6720 7461 736b 7320 6f6e 2074 6865  ing tasks on the
+000126e0: 2073 616d 6520 776f 726b 6572 2c20 7265   same worker, re
+000126f0: 6475 6369 6e67 2066 7574 7572 6520 6461  ducing future da
+00012700: 7461 0a20 2020 2020 2020 2074 7261 6e73  ta.        trans
+00012710: 6665 722e 2049 7420 646f 6573 206e 6f74  fer. It does not
+00012720: 2063 6f6e 7369 6465 7220 7468 6520 6c6f   consider the lo
+00012730: 6361 7469 6f6e 206f 6620 6465 7065 6e64  cation of depend
+00012740: 656e 6369 6573 2c20 7369 6e63 6520 7468  encies, since th
+00012750: 6579 276c 6c20 656e 640a 2020 2020 2020  ey'll end.      
+00012760: 2020 7570 206f 6e20 6576 6572 7920 776f    up on every wo
+00012770: 726b 6572 2061 6e79 7761 792e 0a0a 2020  rker anyway...  
+00012780: 2020 2020 2020 4974 2061 7373 756d 6573        It assumes
+00012790: 2069 7427 7320 6265 696e 6720 6361 6c6c   it's being call
+000127a0: 6564 206f 6e20 6120 6261 7463 6820 6f66  ed on a batch of
+000127b0: 2074 6173 6b73 2069 6e20 7072 696f 7269   tasks in priori
+000127c0: 7479 206f 7264 6572 2c20 616e 640a 2020  ty order, and.  
+000127d0: 2020 2020 2020 6d61 696e 7461 696e 7320        maintains 
+000127e0: 7374 6174 6520 696e 2060 5363 6865 6475  state in `Schedu
+000127f0: 6c65 7253 7461 7465 2e6c 6173 745f 726f  lerState.last_ro
+00012800: 6f74 5f77 6f72 6b65 7260 2061 6e64 0a20  ot_worker` and. 
+00012810: 2020 2020 2020 2060 5363 6865 6475 6c65         `Schedule
+00012820: 7253 7461 7465 2e6c 6173 745f 726f 6f74  rState.last_root
+00012830: 5f77 6f72 6b65 725f 7461 736b 735f 6c65  _worker_tasks_le
+00012840: 6674 6020 746f 2061 6368 6965 7665 2074  ft` to achieve t
+00012850: 6869 732e 0a0a 2020 2020 2020 2020 5468  his...        Th
+00012860: 6973 2077 696c 6c20 7365 6e64 2065 7665  is will send eve
+00012870: 7279 2072 756e 6e61 626c 6520 7461 736b  ry runnable task
+00012880: 2074 6f20 6120 776f 726b 6572 2c20 6f66   to a worker, of
+00012890: 7465 6e20 6361 7573 696e 6720 726f 6f74  ten causing root
+000128a0: 2074 6173 6b0a 2020 2020 2020 2020 6f76   task.        ov
+000128b0: 6572 7072 6f64 7563 7469 6f6e 2e0a 0a20  erproduction... 
+000128c0: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
+000128d0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
+000128e0: 2020 2020 2020 2077 733a 2057 6f72 6b65         ws: Worke
+000128f0: 7253 7461 7465 207c 204e 6f6e 650a 2020  rState | None.  
+00012900: 2020 2020 2020 2020 2020 5468 6520 776f            The wo
+00012910: 726b 6572 2074 6f20 6173 7369 676e 2074  rker to assign t
+00012920: 6865 2074 6173 6b20 746f 2e20 4966 2074  he task to. If t
+00012930: 6865 7265 2061 7265 206e 6f20 776f 726b  here are no work
+00012940: 6572 7320 696e 2074 6865 2063 6c75 7374  ers in the clust
+00012950: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+00012960: 7265 7475 726e 7320 4e6f 6e65 2c20 696e  returns None, in
+00012970: 2077 6869 6368 2063 6173 6520 7468 6520   which case the 
+00012980: 7461 736b 2073 686f 756c 6420 6265 2074  task should be t
+00012990: 7261 6e73 6974 696f 6e65 6420 746f 0a20  ransitioned to. 
+000129a0: 2020 2020 2020 2020 2020 2060 606e 6f2d             ``no-
+000129b0: 776f 726b 6572 6060 2e0a 2020 2020 2020  worker``..      
+000129c0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+000129d0: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+000129e0: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
+000129f0: 6520 726f 6f74 2d69 7368 2d6e 6573 7320  e root-ish-ness 
+00012a00: 6e6f 7465 2062 656c 6f77 2069 6e20 6064  note below in `d
+00012a10: 6563 6964 655f 776f 726b 6572 5f72 6f6f  ecide_worker_roo
+00012a20: 7469 7368 5f71 7565 7569 6e67 5f65 6e61  tish_queuing_ena
+00012a30: 626c 6564 600a 2020 2020 2020 2020 2020  bled`.          
+00012a40: 2020 6173 7365 7274 206d 6174 682e 6973    assert math.is
+00012a50: 696e 6628 7365 6c66 2e57 4f52 4b45 525f  inf(self.WORKER_
+00012a60: 5341 5455 5241 5449 4f4e 290a 0a20 2020  SATURATION)..   
+00012a70: 2020 2020 2070 6f6f 6c20 3d20 7365 6c66       pool = self
+00012a80: 2e69 646c 652e 7661 6c75 6573 2829 2069  .idle.values() i
+00012a90: 6620 7365 6c66 2e69 646c 6520 656c 7365  f self.idle else
+00012aa0: 2073 656c 662e 7275 6e6e 696e 670a 2020   self.running.  
+00012ab0: 2020 2020 2020 6966 206e 6f74 2070 6f6f        if not poo
+00012ac0: 6c3a 0a20 2020 2020 2020 2020 2020 2072  l:.            r
+00012ad0: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+00012ae0: 2020 2020 7467 203d 2074 732e 6772 6f75      tg = ts.grou
+00012af0: 700a 2020 2020 2020 2020 6c77 7320 3d20  p.        lws = 
+00012b00: 7467 2e6c 6173 745f 776f 726b 6572 0a20  tg.last_worker. 
+00012b10: 2020 2020 2020 2069 6620 280a 2020 2020         if (.    
+00012b20: 2020 2020 2020 2020 6c77 730a 2020 2020          lws.    
+00012b30: 2020 2020 2020 2020 616e 6420 7467 2e6c          and tg.l
+00012b40: 6173 745f 776f 726b 6572 5f74 6173 6b73  ast_worker_tasks
+00012b50: 5f6c 6566 740a 2020 2020 2020 2020 2020  _left.          
+00012b60: 2020 616e 6420 6c77 732e 7374 6174 7573    and lws.status
+00012b70: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+00012b80: 6e67 0a20 2020 2020 2020 2020 2020 2061  ng.            a
+00012b90: 6e64 2073 656c 662e 776f 726b 6572 732e  nd self.workers.
+00012ba0: 6765 7428 6c77 732e 6164 6472 6573 7329  get(lws.address)
+00012bb0: 2069 7320 6c77 730a 2020 2020 2020 2020   is lws.        
+00012bc0: 293a 0a20 2020 2020 2020 2020 2020 2077  ):.            w
+00012bd0: 7320 3d20 6c77 730a 2020 2020 2020 2020  s = lws.        
+00012be0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00012bf0: 2020 2320 4c61 7374 2d75 7365 6420 776f    # Last-used wo
+00012c00: 726b 6572 2069 7320 6675 6c6c 2c20 756e  rker is full, un
+00012c10: 6b6e 6f77 6e2c 2072 6574 6972 696e 672c  known, retiring,
+00012c20: 206f 7220 7061 7573 6564 3b0a 2020 2020   or paused;.    
+00012c30: 2020 2020 2020 2020 2320 7069 636b 2061          # pick a
+00012c40: 206e 6577 2077 6f72 6b65 7220 666f 7220   new worker for 
+00012c50: 7468 6520 6e65 7874 2066 6577 2074 6173  the next few tas
+00012c60: 6b73 0a20 2020 2020 2020 2020 2020 2077  ks.            w
+00012c70: 7320 3d20 6d69 6e28 706f 6f6c 2c20 6b65  s = min(pool, ke
+00012c80: 793d 7061 7274 6961 6c28 7365 6c66 2e77  y=partial(self.w
+00012c90: 6f72 6b65 725f 6f62 6a65 6374 6976 652c  orker_objective,
+00012ca0: 2074 7329 290a 2020 2020 2020 2020 2020   ts)).          
+00012cb0: 2020 7467 2e6c 6173 745f 776f 726b 6572    tg.last_worker
+00012cc0: 5f74 6173 6b73 5f6c 6566 7420 3d20 6d61  _tasks_left = ma
+00012cd0: 7468 2e66 6c6f 6f72 280a 2020 2020 2020  th.floor(.      
+00012ce0: 2020 2020 2020 2020 2020 286c 656e 2874            (len(t
+00012cf0: 6729 202f 2073 656c 662e 746f 7461 6c5f  g) / self.total_
+00012d00: 6e74 6872 6561 6473 2920 2a20 7773 2e6e  nthreads) * ws.n
+00012d10: 7468 7265 6164 730a 2020 2020 2020 2020  threads.        
+00012d20: 2020 2020 290a 0a20 2020 2020 2020 2023      )..        #
+00012d30: 2052 6563 6f72 6420 606c 6173 745f 776f   Record `last_wo
+00012d40: 726b 6572 602c 206f 7220 636c 6561 7220  rker`, or clear 
+00012d50: 6974 206f 6e20 7468 6520 6669 6e61 6c20  it on the final 
+00012d60: 7461 736b 0a20 2020 2020 2020 2074 672e  task.        tg.
+00012d70: 6c61 7374 5f77 6f72 6b65 7220 3d20 280a  last_worker = (.
+00012d80: 2020 2020 2020 2020 2020 2020 7773 2069              ws i
+00012d90: 6620 7467 2e73 7461 7465 735b 2272 656c  f tg.states["rel
+00012da0: 6561 7365 6422 5d20 2b20 7467 2e73 7461  eased"] + tg.sta
+00012db0: 7465 735b 2277 6169 7469 6e67 225d 203e  tes["waiting"] >
+00012dc0: 2031 2065 6c73 6520 4e6f 6e65 0a20 2020   1 else None.   
+00012dd0: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
+00012de0: 672e 6c61 7374 5f77 6f72 6b65 725f 7461  g.last_worker_ta
+00012df0: 736b 735f 6c65 6674 202d 3d20 310a 0a20  sks_left -= 1.. 
+00012e00: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00012e10: 616c 6964 6174 6520 616e 6420 7773 2069  alidate and ws i
+00012e20: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00012e30: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
+00012e40: 656c 662e 776f 726b 6572 732e 6765 7428  elf.workers.get(
+00012e50: 7773 2e61 6464 7265 7373 2920 6973 2077  ws.address) is w
+00012e60: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+00012e70: 7365 7274 2077 7320 696e 2073 656c 662e  sert ws in self.
+00012e80: 7275 6e6e 696e 672c 2028 7773 2c20 7365  running, (ws, se
+00012e90: 6c66 2e72 756e 6e69 6e67 290a 0a20 2020  lf.running)..   
+00012ea0: 2020 2020 2072 6574 7572 6e20 7773 0a0a       return ws..
+00012eb0: 2020 2020 6465 6620 6465 6369 6465 5f77      def decide_w
+00012ec0: 6f72 6b65 725f 726f 6f74 6973 685f 7175  orker_rootish_qu
+00012ed0: 6575 696e 675f 656e 6162 6c65 6428 7365  euing_enabled(se
+00012ee0: 6c66 2920 2d3e 2057 6f72 6b65 7253 7461  lf) -> WorkerSta
+00012ef0: 7465 207c 204e 6f6e 653a 0a20 2020 2020  te | None:.     
+00012f00: 2020 2022 2222 5069 636b 2061 2077 6f72     """Pick a wor
+00012f10: 6b65 7220 666f 7220 6120 7275 6e6e 6162  ker for a runnab
+00012f20: 6c65 2072 6f6f 742d 6973 6820 7461 736b  le root-ish task
+00012f30: 2c20 6966 206e 6f74 2061 6c6c 2061 7265  , if not all are
+00012f40: 2062 7573 792e 0a0a 2020 2020 2020 2020   busy...        
+00012f50: 5069 636b 7320 7468 6520 6c65 6173 742d  Picks the least-
+00012f60: 6275 7379 2077 6f72 6b65 7220 6f75 7420  busy worker out 
+00012f70: 6f66 2074 6865 2060 6069 646c 6560 6020  of the ``idle`` 
+00012f80: 776f 726b 6572 7320 2869 646c 6520 776f  workers (idle wo
+00012f90: 726b 6572 7320 6861 7665 2066 6577 6572  rkers have fewer
+00012fa0: 0a20 2020 2020 2020 2074 6173 6b73 2072  .        tasks r
+00012fb0: 756e 6e69 6e67 2074 6861 6e20 7468 7265  unning than thre
+00012fc0: 6164 732c 2061 7320 7365 7420 6279 2060  ads, as set by `
+00012fd0: 6064 6973 7472 6962 7574 6564 2e73 6368  `distributed.sch
+00012fe0: 6564 756c 6572 2e77 6f72 6b65 722d 7361  eduler.worker-sa
+00012ff0: 7475 7261 7469 6f6e 6060 292e 0a20 2020  turation``)..   
+00013000: 2020 2020 2049 7420 646f 6573 206e 6f74       It does not
+00013010: 2063 6f6e 7369 6465 7220 7468 6520 6c6f   consider the lo
+00013020: 6361 7469 6f6e 206f 6620 6465 7065 6e64  cation of depend
+00013030: 656e 6369 6573 2c20 7369 6e63 6520 7468  encies, since th
+00013040: 6579 276c 6c20 656e 6420 7570 206f 6e20  ey'll end up on 
+00013050: 6576 6572 790a 2020 2020 2020 2020 776f  every.        wo
+00013060: 726b 6572 2061 6e79 7761 792e 0a0a 2020  rker anyway...  
+00013070: 2020 2020 2020 4966 2061 6c6c 2077 6f72        If all wor
+00013080: 6b65 7273 2061 7265 2066 756c 6c2c 2072  kers are full, r
+00013090: 6574 7572 6e73 204e 6f6e 652c 206d 6561  eturns None, mea
+000130a0: 6e69 6e67 2074 6865 2074 6173 6b20 7368  ning the task sh
+000130b0: 6f75 6c64 2074 7261 6e73 6974 696f 6e20  ould transition 
+000130c0: 746f 0a20 2020 2020 2020 2060 6071 7565  to.        ``que
+000130d0: 7565 6460 602e 2054 6865 2073 6368 6564  ued``. The sched
+000130e0: 756c 6572 2077 696c 6c20 7761 6974 2074  uler will wait t
+000130f0: 6f20 7365 6e64 2069 7420 746f 2061 2077  o send it to a w
+00013100: 6f72 6b65 7220 756e 7469 6c20 6120 7468  orker until a th
+00013110: 7265 6164 206f 7065 6e73 0a20 2020 2020  read opens.     
+00013120: 2020 2075 702e 2054 6869 7320 656e 7375     up. This ensu
+00013130: 7265 7320 7468 6174 2064 6f77 6e73 7472  res that downstr
+00013140: 6561 6d20 7461 736b 7320 616c 7761 7973  eam tasks always
+00013150: 2072 756e 2062 6566 6f72 6520 6e65 7720   run before new 
+00013160: 726f 6f74 2074 6173 6b73 2061 7265 0a20  root tasks are. 
+00013170: 2020 2020 2020 2073 7461 7274 6564 2e0a         started..
+00013180: 0a20 2020 2020 2020 2054 6869 7320 646f  .        This do
+00013190: 6573 206e 6f74 2074 7279 2074 6f20 7363  es not try to sc
+000131a0: 6865 6475 6c65 2073 6962 6c69 6e67 2074  hedule sibling t
+000131b0: 6173 6b73 206f 6e20 7468 6520 7361 6d65  asks on the same
+000131c0: 2077 6f72 6b65 723b 2069 6e20 6661 6374   worker; in fact
+000131d0: 2c20 6974 0a20 2020 2020 2020 2075 7375  , it.        usu
+000131e0: 616c 6c79 2064 6f65 7320 7468 6520 6f70  ally does the op
+000131f0: 706f 7369 7465 2e20 4576 656e 2074 686f  posite. Even tho
+00013200: 7567 6820 7468 6973 2069 6e63 7265 6173  ugh this increas
+00013210: 6573 2073 7562 7365 7175 656e 7420 6461  es subsequent da
+00013220: 7461 2074 7261 6e73 6665 722c 0a20 2020  ta transfer,.   
+00013230: 2020 2020 2069 7420 7479 7069 6361 6c6c       it typicall
+00013240: 7920 7265 6475 6365 7320 6f76 6572 616c  y reduces overal
+00013250: 6c20 6d65 6d6f 7279 2075 7365 2062 7920  l memory use by 
+00013260: 656c 696d 696e 6174 696e 6720 726f 6f74  eliminating root
+00013270: 2074 6173 6b20 6f76 6572 7072 6f64 7563   task overproduc
+00013280: 7469 6f6e 2e0a 0a20 2020 2020 2020 2052  tion...        R
+00013290: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
+000132a0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2077  ------.        w
+000132b0: 733a 2057 6f72 6b65 7253 7461 7465 207c  s: WorkerState |
+000132c0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+000132d0: 2020 5468 6520 776f 726b 6572 2074 6f20    The worker to 
+000132e0: 6173 7369 676e 2074 6865 2074 6173 6b20  assign the task 
+000132f0: 746f 2e20 4966 2074 6865 7265 2061 7265  to. If there are
+00013300: 206e 6f20 6964 6c65 2077 6f72 6b65 7273   no idle workers
+00013310: 2c20 7265 7475 726e 730a 2020 2020 2020  , returns.      
+00013320: 2020 2020 2020 4e6f 6e65 2c20 696e 2077        None, in w
+00013330: 6869 6368 2063 6173 6520 7468 6520 7461  hich case the ta
+00013340: 736b 2073 686f 756c 6420 6265 2074 7261  sk should be tra
+00013350: 6e73 6974 696f 6e65 6420 746f 2060 6071  nsitioned to ``q
+00013360: 7565 7565 6460 602e 0a0a 2020 2020 2020  ueued``...      
+00013370: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+00013380: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00013390: 2020 2020 2020 2020 2020 2020 2320 5765              # We
+000133a0: 2064 6f6e 2774 2060 6173 7365 7274 2073   don't `assert s
+000133b0: 656c 662e 6973 5f72 6f6f 7469 7368 2874  elf.is_rootish(t
+000133c0: 7329 6020 6865 7265 2c20 6265 6361 7573  s)` here, becaus
+000133d0: 6520 7468 6174 2063 6865 636b 2069 730a  e that check is.
+000133e0: 2020 2020 2020 2020 2020 2020 2320 6465              # de
+000133f0: 7065 6e64 656e 7420 6f6e 2063 6c75 7374  pendent on clust
+00013400: 6572 2073 697a 652e 2049 7427 7320 706f  er size. It's po
+00013410: 7373 6962 6c65 2061 2074 6173 6b20 6c6f  ssible a task lo
+00013420: 6f6b 6564 2072 6f6f 742d 6973 6820 7768  oked root-ish wh
+00013430: 656e 2069 740a 2020 2020 2020 2020 2020  en it.          
+00013440: 2020 2320 7761 7320 7175 6575 6564 2c20    # was queued, 
+00013450: 6275 7420 7468 6520 636c 7573 7465 7220  but the cluster 
+00013460: 6861 7320 7369 6e63 6520 7363 616c 6564  has since scaled
+00013470: 2075 7020 616e 6420 6974 206e 6f20 6c6f   up and it no lo
+00013480: 6e67 6572 2064 6f65 7320 7768 656e 0a20  nger does when. 
+00013490: 2020 2020 2020 2020 2020 2023 2063 6f6d             # com
+000134a0: 696e 6720 6f75 7420 6f66 2074 6865 2071  ing out of the q
+000134b0: 7565 7565 2e20 4966 2060 6973 5f72 6f6f  ueue. If `is_roo
+000134c0: 7469 7368 6020 6368 616e 6765 7320 746f  tish` changes to
+000134d0: 2061 2073 7461 7469 6320 6465 6669 6e69   a static defini
+000134e0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+000134f0: 2020 2320 7468 656e 2061 6464 2074 6861    # then add tha
+00013500: 7420 6173 7365 7274 696f 6e20 6865 7265  t assertion here
+00013510: 2028 616e 6420 6163 7475 616c 6c79 2070   (and actually p
+00013520: 6173 7320 696e 2074 6865 2074 6173 6b29  ass in the task)
+00013530: 2e0a 2020 2020 2020 2020 2020 2020 6173  ..            as
+00013540: 7365 7274 206e 6f74 206d 6174 682e 6973  sert not math.is
+00013550: 696e 6628 7365 6c66 2e57 4f52 4b45 525f  inf(self.WORKER_
+00013560: 5341 5455 5241 5449 4f4e 290a 0a20 2020  SATURATION)..   
+00013570: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00013580: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
+00013590: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000135a0: 416c 6c20 776f 726b 6572 7320 6275 7379  All workers busy
+000135b0: 3f20 5461 736b 2067 6574 732f 7374 6179  ? Task gets/stay
+000135c0: 7320 7175 6575 6564 2e0a 2020 2020 2020  s queued..      
+000135d0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+000135e0: 650a 0a20 2020 2020 2020 2023 204a 7573  e..        # Jus
+000135f0: 7420 7069 636b 2074 6865 206c 6561 7374  t pick the least
+00013600: 2062 7573 7920 776f 726b 6572 2e0a 2020   busy worker..  
+00013610: 2020 2020 2020 2320 4e4f 5445 3a20 7468        # NOTE: th
+00013620: 6973 2077 696c 6c20 6c65 6164 2074 6f20  is will lead to 
+00013630: 776f 7273 742d 6361 7365 2073 6368 6564  worst-case sched
+00013640: 756c 696e 6720 7769 7468 2072 6567 6172  uling with regar
+00013650: 6473 2074 6f20 636f 2d61 7373 6967 6e6d  ds to co-assignm
+00013660: 656e 742e 0a20 2020 2020 2020 2077 7320  ent..        ws 
+00013670: 3d20 6d69 6e28 0a20 2020 2020 2020 2020  = min(.         
+00013680: 2020 2073 656c 662e 6964 6c65 5f74 6173     self.idle_tas
+00013690: 6b5f 636f 756e 742c 0a20 2020 2020 2020  k_count,.       
+000136a0: 2020 2020 206b 6579 3d6c 616d 6264 6120       key=lambda 
+000136b0: 7773 3a20 6c65 6e28 7773 2e70 726f 6365  ws: len(ws.proce
+000136c0: 7373 696e 6729 202f 2077 732e 6e74 6872  ssing) / ws.nthr
+000136d0: 6561 6473 2c0a 2020 2020 2020 2020 290a  eads,.        ).
+000136e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000136f0: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00013700: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+00013710: 662e 776f 726b 6572 732e 6765 7428 7773  f.workers.get(ws
+00013720: 2e61 6464 7265 7373 2920 6973 2077 730a  .address) is ws.
+00013730: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00013740: 7274 206e 6f74 205f 776f 726b 6572 5f66  rt not _worker_f
+00013750: 756c 6c28 7773 2c20 7365 6c66 2e57 4f52  ull(ws, self.WOR
+00013760: 4b45 525f 5341 5455 5241 5449 4f4e 292c  KER_SATURATION),
+00013770: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00013780: 2020 2077 732c 0a20 2020 2020 2020 2020     ws,.         
+00013790: 2020 2020 2020 205f 7461 736b 5f73 6c6f         _task_slo
+000137a0: 7473 5f61 7661 696c 6162 6c65 2877 732c  ts_available(ws,
+000137b0: 2073 656c 662e 574f 524b 4552 5f53 4154   self.WORKER_SAT
+000137c0: 5552 4154 494f 4e29 2c0a 2020 2020 2020  URATION),.      
+000137d0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000137e0: 2020 2020 6173 7365 7274 2077 7320 696e      assert ws in
+000137f0: 2073 656c 662e 7275 6e6e 696e 672c 2028   self.running, (
+00013800: 7773 2c20 7365 6c66 2e72 756e 6e69 6e67  ws, self.running
+00013810: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00013820: 6e20 7773 0a0a 2020 2020 6465 6620 6465  n ws..    def de
+00013830: 6369 6465 5f77 6f72 6b65 725f 6e6f 6e5f  cide_worker_non_
+00013840: 726f 6f74 6973 6828 7365 6c66 2c20 7473  rootish(self, ts
+00013850: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
+00013860: 576f 726b 6572 5374 6174 6520 7c20 4e6f  WorkerState | No
+00013870: 6e65 3a0a 2020 2020 2020 2020 2222 2250  ne:.        """P
+00013880: 6963 6b20 6120 776f 726b 6572 2066 6f72  ick a worker for
+00013890: 2061 2072 756e 6e61 626c 6520 6e6f 6e2d   a runnable non-
+000138a0: 726f 6f74 2074 6173 6b2c 2063 6f6e 7369  root task, consi
+000138b0: 6465 7269 6e67 2064 6570 656e 6465 6e63  dering dependenc
+000138c0: 6965 7320 616e 640a 2020 2020 2020 2020  ies and.        
+000138d0: 7265 7374 7269 6374 696f 6e73 2e0a 0a20  restrictions... 
+000138e0: 2020 2020 2020 204f 7574 206f 6620 656c         Out of el
+000138f0: 6967 6962 6c65 2077 6f72 6b65 7273 2068  igible workers h
+00013900: 6f6c 6469 6e67 2064 6570 656e 6465 6e63  olding dependenc
+00013910: 6965 7320 6f66 2060 6074 7360 602c 2073  ies of ``ts``, s
+00013920: 656c 6563 7473 2074 6865 2077 6f72 6b65  elects the worke
+00013930: 720a 2020 2020 2020 2020 7768 6572 652c  r.        where,
+00013940: 2063 6f6e 7369 6465 7269 6e67 2077 6f72   considering wor
+00013950: 6b65 7220 6261 636b 6c6f 6720 616e 6420  ker backlog and 
+00013960: 6461 7461 2d74 7261 6e73 6665 7220 636f  data-transfer co
+00013970: 7374 732c 2074 6865 2074 6173 6b20 6973  sts, the task is
+00013980: 0a20 2020 2020 2020 2065 7374 696d 6174  .        estimat
+00013990: 6564 2074 6f20 7374 6172 7420 7275 6e6e  ed to start runn
+000139a0: 696e 6720 7468 6520 736f 6f6e 6573 742e  ing the soonest.
+000139b0: 0a0a 2020 2020 2020 2020 5265 7475 726e  ..        Return
+000139c0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+000139d0: 2d0a 2020 2020 2020 2020 7773 3a20 576f  -.        ws: Wo
+000139e0: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
+000139f0: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
+00013a00: 2077 6f72 6b65 7220 746f 2061 7373 6967   worker to assig
+00013a10: 6e20 7468 6520 7461 736b 2074 6f2e 2049  n the task to. I
+00013a20: 6620 6e6f 2077 6f72 6b65 7273 2073 6174  f no workers sat
+00013a30: 6973 6679 2074 6865 2072 6573 7472 6963  isfy the restric
+00013a40: 7469 6f6e 7320 6f66 0a20 2020 2020 2020  tions of.       
+00013a50: 2020 2020 2060 6074 7360 6020 6f72 2074       ``ts`` or t
+00013a60: 6865 7265 2061 7265 206e 6f20 7275 6e6e  here are no runn
+00013a70: 696e 6720 776f 726b 6572 732c 2072 6574  ing workers, ret
+00013a80: 7572 6e73 204e 6f6e 652c 2069 6e20 7768  urns None, in wh
+00013a90: 6963 6820 6361 7365 2074 6865 2074 6173  ich case the tas
+00013aa0: 6b0a 2020 2020 2020 2020 2020 2020 7368  k.            sh
+00013ab0: 6f75 6c64 2062 6520 7472 616e 7369 7469  ould be transiti
+00013ac0: 6f6e 6564 2074 6f20 6060 6e6f 2d77 6f72  oned to ``no-wor
+00013ad0: 6b65 7260 602e 0a20 2020 2020 2020 2022  ker``..        "
+00013ae0: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
+00013af0: 7420 7365 6c66 2e72 756e 6e69 6e67 3a0a  t self.running:.
+00013b00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00013b10: 726e 204e 6f6e 650a 0a20 2020 2020 2020  rn None..       
+00013b20: 2076 616c 6964 5f77 6f72 6b65 7273 203d   valid_workers =
+00013b30: 2073 656c 662e 7661 6c69 645f 776f 726b   self.valid_work
+00013b40: 6572 7328 7473 290a 2020 2020 2020 2020  ers(ts).        
+00013b50: 6966 2076 616c 6964 5f77 6f72 6b65 7273  if valid_workers
+00013b60: 2069 7320 4e6f 6e65 2061 6e64 206c 656e   is None and len
+00013b70: 2873 656c 662e 7275 6e6e 696e 6729 203c  (self.running) <
+00013b80: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
+00013b90: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+00013ba0: 2320 4966 2074 6865 7265 2077 6572 6520  # If there were 
+00013bb0: 6e6f 2072 6573 7472 6963 7469 6f6e 732c  no restrictions,
+00013bc0: 2060 7661 6c69 645f 776f 726b 6572 7328   `valid_workers(
+00013bd0: 2960 2064 6964 6e27 7420 7375 6273 6574  )` didn't subset
+00013be0: 2062 790a 2020 2020 2020 2020 2020 2020   by.            
+00013bf0: 2320 6072 756e 6e69 6e67 602e 0a20 2020  # `running`..   
+00013c00: 2020 2020 2020 2020 2076 616c 6964 5f77           valid_w
+00013c10: 6f72 6b65 7273 203d 2073 656c 662e 7275  orkers = self.ru
+00013c20: 6e6e 696e 670a 0a20 2020 2020 2020 2069  nning..        i
+00013c30: 6620 7473 2e64 6570 656e 6465 6e63 6965  f ts.dependencie
+00013c40: 7320 6f72 2076 616c 6964 5f77 6f72 6b65  s or valid_worke
+00013c50: 7273 2069 7320 6e6f 7420 4e6f 6e65 3a0a  rs is not None:.
+00013c60: 2020 2020 2020 2020 2020 2020 7773 203d              ws =
+00013c70: 2064 6563 6964 655f 776f 726b 6572 280a   decide_worker(.
+00013c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013c90: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+00013ca0: 2020 2020 7365 6c66 2e72 756e 6e69 6e67      self.running
+00013cb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013cc0: 2020 7661 6c69 645f 776f 726b 6572 732c    valid_workers,
+00013cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013ce0: 2070 6172 7469 616c 2873 656c 662e 776f   partial(self.wo
+00013cf0: 726b 6572 5f6f 626a 6563 7469 7665 2c20  rker_objective, 
+00013d00: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+00013d10: 2029 0a20 2020 2020 2020 2065 6c73 653a   ).        else:
+00013d20: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
+00013d30: 4f44 4f20 6966 2060 6973 5f72 6f6f 7469  ODO if `is_rooti
+00013d40: 7368 6020 776f 756c 6420 616c 7761 7973  sh` would always
+00013d50: 2072 6574 7572 6e20 5472 7565 2066 6f72   return True for
+00013d60: 2074 6173 6b73 2077 6974 686f 7574 0a20   tasks without. 
+00013d70: 2020 2020 2020 2020 2020 2023 2064 6570             # dep
+00013d80: 656e 6465 6e63 6965 732c 2077 6520 636f  endencies, we co
+00013d90: 756c 6420 7265 6d6f 7665 2061 6c6c 2074  uld remove all t
+00013da0: 6869 7320 6c6f 6769 632e 2054 6865 2072  his logic. The r
+00013db0: 6f6f 7469 7368 2061 7373 6967 6e6d 656e  ootish assignmen
+00013dc0: 7420 6c6f 6769 630a 2020 2020 2020 2020  t logic.        
+00013dd0: 2020 2020 2320 776f 756c 6420 6265 6861      # would beha
+00013de0: 7665 206d 6f72 6520 6f72 206c 6573 7320  ve more or less 
+00013df0: 7468 6520 7361 6d65 2061 7320 7468 6973  the same as this
+00013e00: 2c20 6d61 7962 6520 7769 7468 6f75 7420  , maybe without 
+00013e10: 6775 6172 616e 7465 6564 0a20 2020 2020  guaranteed.     
+00013e20: 2020 2020 2020 2023 2072 6f75 6e64 2d72         # round-r
+00013e30: 6f62 696e 2074 686f 7567 683f 2054 6869  obin though? Thi
+00013e40: 7320 7061 7468 2069 7320 6f6e 6c79 2072  s path is only r
+00013e50: 6561 6368 6162 6c65 2077 6865 6e20 6074  eachable when `t
+00013e60: 7360 2064 6f65 736e 2774 2068 6176 650a  s` doesn't have.
+00013e70: 2020 2020 2020 2020 2020 2020 2320 6465              # de
+00013e80: 7065 6e64 656e 6369 6573 2c20 6275 7420  pendencies, but 
+00013e90: 6974 7320 6772 6f75 7020 6973 2061 6c73  its group is als
+00013ea0: 6f20 736d 616c 6c65 7220 7468 616e 2074  o smaller than t
+00013eb0: 6865 2063 6c75 7374 6572 2e0a 0a20 2020  he cluster...   
+00013ec0: 2020 2020 2020 2020 2023 2046 6173 7470           # Fastp
+00013ed0: 6174 6820 7768 656e 2074 6865 7265 2061  ath when there a
+00013ee0: 7265 206e 6f20 7265 6c61 7465 6420 7461  re no related ta
+00013ef0: 736b 7320 6f72 2072 6573 7472 6963 7469  sks or restricti
+00013f00: 6f6e 730a 2020 2020 2020 2020 2020 2020  ons.            
+00013f10: 776f 726b 6572 5f70 6f6f 6c20 3d20 7365  worker_pool = se
+00013f20: 6c66 2e69 646c 6520 6f72 2073 656c 662e  lf.idle or self.
+00013f30: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
+00013f40: 2020 2020 2320 4649 584d 4520 6964 6c65      # FIXME idle
+00013f50: 2061 6e64 2077 6f72 6b65 7273 2061 7265   and workers are
+00013f60: 2053 6f72 7465 6444 6963 7427 7320 6465   SortedDict's de
+00013f70: 636c 6172 6564 2061 7320 6469 6374 730a  clared as dicts.
+00013f80: 2020 2020 2020 2020 2020 2020 2320 2020              #   
+00013f90: 2020 2020 6265 6361 7573 6520 736f 7274      because sort
+00013fa0: 6564 636f 6e74 6169 6e65 7273 2069 7320  edcontainers is 
+00013fb0: 6e6f 7420 616e 6e6f 7461 7465 640a 2020  not annotated.  
+00013fc0: 2020 2020 2020 2020 2020 7770 5f76 616c            wp_val
+00013fd0: 7320 3d20 6361 7374 2822 5365 7175 656e  s = cast("Sequen
+00013fe0: 6365 5b57 6f72 6b65 7253 7461 7465 5d22  ce[WorkerState]"
+00013ff0: 2c20 776f 726b 6572 5f70 6f6f 6c2e 7661  , worker_pool.va
+00014000: 6c75 6573 2829 290a 2020 2020 2020 2020  lues()).        
+00014010: 2020 2020 6e5f 776f 726b 6572 7320 3d20      n_workers = 
+00014020: 6c65 6e28 7770 5f76 616c 7329 0a20 2020  len(wp_vals).   
+00014030: 2020 2020 2020 2020 2069 6620 6e5f 776f           if n_wo
+00014040: 726b 6572 7320 3c20 3230 3a20 2023 2073  rkers < 20:  # s
+00014050: 6d61 7274 2062 7574 206c 696e 6561 7220  mart but linear 
+00014060: 696e 2073 6d61 6c6c 2063 6173 650a 2020  in small case.  
+00014070: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+00014080: 203d 206d 696e 2877 705f 7661 6c73 2c20   = min(wp_vals, 
+00014090: 6b65 793d 6f70 6572 6174 6f72 2e61 7474  key=operator.att
+000140a0: 7267 6574 7465 7228 226f 6363 7570 616e  rgetter("occupan
+000140b0: 6379 2229 290a 2020 2020 2020 2020 2020  cy")).          
+000140c0: 2020 2020 2020 6173 7365 7274 2077 730a        assert ws.
+000140d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000140e0: 6966 2077 732e 6f63 6375 7061 6e63 7920  if ws.occupancy 
+000140f0: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
+00014100: 2020 2020 2020 2020 2020 2320 7370 6563            # spec
+00014110: 6961 6c20 6361 7365 2074 6f20 7573 6520  ial case to use 
+00014120: 726f 756e 642d 726f 6269 6e3b 206c 696e  round-robin; lin
+00014130: 6561 7220 7365 6172 6368 0a20 2020 2020  ear search.     
+00014140: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00014150: 2066 6f72 206e 6578 7420 776f 726b 6572   for next worker
+00014160: 2077 6974 6820 7a65 726f 206f 6363 7570   with zero occup
+00014170: 616e 6379 2028 6f72 206a 7573 740a 2020  ancy (or just.  
+00014180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014190: 2020 2320 6c61 6e64 2062 6163 6b20 7768    # land back wh
+000141a0: 6572 6520 7765 2073 7461 7274 6564 292e  ere we started).
+000141b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000141c0: 2020 2020 2073 7461 7274 203d 2073 656c       start = sel
+000141d0: 662e 6e5f 7461 736b 7320 2520 6e5f 776f  f.n_tasks % n_wo
+000141e0: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
+000141f0: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+00014200: 696e 2072 616e 6765 286e 5f77 6f72 6b65  in range(n_worke
+00014210: 7273 293a 0a20 2020 2020 2020 2020 2020  rs):.           
+00014220: 2020 2020 2020 2020 2020 2020 2077 705f               wp_
+00014230: 6920 3d20 7770 5f76 616c 735b 2869 202b  i = wp_vals[(i +
+00014240: 2073 7461 7274 2920 2520 6e5f 776f 726b   start) % n_work
+00014250: 6572 735d 0a20 2020 2020 2020 2020 2020  ers].           
+00014260: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00014270: 7770 5f69 2e6f 6363 7570 616e 6379 203d  wp_i.occupancy =
+00014280: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+00014290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000142a0: 2077 7320 3d20 7770 5f69 0a20 2020 2020   ws = wp_i.     
 000142b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142c0: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-000142d0: 2020 2020 2020 656c 7365 3a20 2023 2064        else:  # d
-000142e0: 756d 6220 6275 7420 6661 7374 2069 6e20  umb but fast in 
-000142f0: 6c61 7267 6520 6361 7365 0a20 2020 2020  large case.     
-00014300: 2020 2020 2020 2020 2020 2077 7320 3d20             ws = 
-00014310: 7770 5f76 616c 735b 7365 6c66 2e6e 5f74  wp_vals[self.n_t
-00014320: 6173 6b73 2025 206e 5f77 6f72 6b65 7273  asks % n_workers
-00014330: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-00014340: 6c66 2e76 616c 6964 6174 6520 616e 6420  lf.validate and 
-00014350: 7773 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ws is not None:.
-00014360: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00014370: 7274 2073 656c 662e 776f 726b 6572 732e  rt self.workers.
-00014380: 6765 7428 7773 2e61 6464 7265 7373 2920  get(ws.address) 
-00014390: 6973 2077 730a 2020 2020 2020 2020 2020  is ws.          
-000143a0: 2020 6173 7365 7274 2077 7320 696e 2073    assert ws in s
-000143b0: 656c 662e 7275 6e6e 696e 672c 2028 7773  elf.running, (ws
-000143c0: 2c20 7365 6c66 2e72 756e 6e69 6e67 290a  , self.running).
-000143d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000143e0: 7773 0a0a 2020 2020 6465 6620 5f74 7261  ws..    def _tra
-000143f0: 6e73 6974 696f 6e5f 7761 6974 696e 675f  nsition_waiting_
-00014400: 7072 6f63 6573 7369 6e67 2873 656c 662c  processing(self,
-00014410: 206b 6579 3a20 4b65 792c 2073 7469 6d75   key: Key, stimu
-00014420: 6c75 735f 6964 3a20 7374 7229 202d 3e20  lus_id: str) -> 
-00014430: 5265 6373 4d73 6773 3a0a 2020 2020 2020  RecsMsgs:.      
-00014440: 2020 2222 2250 6f73 7369 626c 7920 7363    """Possibly sc
-00014450: 6865 6475 6c65 2061 2072 6561 6479 2074  hedule a ready t
-00014460: 6173 6b2e 2054 6869 7320 6973 2074 6865  ask. This is the
-00014470: 2070 7269 6d61 7279 2064 6973 7061 7463   primary dispatc
-00014480: 6820 666f 7220 7265 6164 7920 7461 736b  h for ready task
-00014490: 732e 0a0a 2020 2020 2020 2020 4966 2074  s...        If t
-000144a0: 6865 7265 2773 206e 6f20 6170 7072 6f70  here's no approp
-000144b0: 7269 6174 6520 776f 726b 6572 2066 6f72  riate worker for
-000144c0: 2074 6865 2074 6173 6b20 2862 7574 2074   the task (but t
-000144d0: 6865 2074 6173 6b20 6973 206f 7468 6572  he task is other
-000144e0: 7769 7365 0a20 2020 2020 2020 2072 756e  wise.        run
-000144f0: 6e61 626c 6529 2c20 6974 2077 696c 6c20  nable), it will 
-00014500: 6265 2072 6563 6f6d 6d65 6e64 6564 2074  be recommended t
-00014510: 6f20 6060 6e6f 2d77 6f72 6b65 7260 6020  o ``no-worker`` 
-00014520: 6f72 2060 6071 7565 7565 6460 602e 0a20  or ``queued``.. 
-00014530: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00014540: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00014550: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
-00014560: 2069 6620 7365 6c66 2e69 735f 726f 6f74   if self.is_root
-00014570: 6973 6828 7473 293a 0a20 2020 2020 2020  ish(ts):.       
-00014580: 2020 2020 2023 204e 4f54 453a 2068 6176       # NOTE: hav
-00014590: 696e 6720 7477 6f20 726f 6f74 2d69 7368  ing two root-ish
-000145a0: 206d 6574 686f 6473 2069 7320 7465 6d70   methods is temp
-000145b0: 6f72 6172 792e 2057 6865 6e20 7468 6520  orary. When the 
-000145c0: 6665 6174 7572 6520 666c 6167 2069 730a  feature flag is.
-000145d0: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-000145e0: 6d6f 7665 642c 2074 6865 7265 2073 686f  moved, there sho
-000145f0: 756c 6420 6f6e 6c79 2062 6520 6f6e 652c  uld only be one,
-00014600: 2077 6869 6368 2063 6f6d 6269 6e65 7320   which combines 
-00014610: 636f 2d61 7373 6967 6e6d 656e 7420 616e  co-assignment an
-00014620: 640a 2020 2020 2020 2020 2020 2020 2320  d.            # 
-00014630: 7175 6575 696e 672e 2045 7665 6e74 7561  queuing. Eventua
-00014640: 6c6c 792c 2073 7065 6369 616c 2d63 6173  lly, special-cas
-00014650: 696e 6720 726f 6f74 2074 6173 6b73 206d  ing root tasks m
-00014660: 6967 6874 2062 6520 7265 6d6f 7665 6420  ight be removed 
-00014670: 656e 7469 7265 6c79 2c0a 2020 2020 2020  entirely,.      
-00014680: 2020 2020 2020 2320 7769 7468 2062 6574        # with bet
-00014690: 7465 7220 6865 7572 6973 7469 6373 2e0a  ter heuristics..
-000146a0: 2020 2020 2020 2020 2020 2020 6966 206d              if m
-000146b0: 6174 682e 6973 696e 6628 7365 6c66 2e57  ath.isinf(self.W
-000146c0: 4f52 4b45 525f 5341 5455 5241 5449 4f4e  ORKER_SATURATION
-000146d0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-000146e0: 2020 2069 6620 6e6f 7420 2877 7320 3a3d     if not (ws :=
-000146f0: 2073 656c 662e 6465 6369 6465 5f77 6f72   self.decide_wor
-00014700: 6b65 725f 726f 6f74 6973 685f 7175 6575  ker_rootish_queu
-00014710: 696e 675f 6469 7361 626c 6564 2874 7329  ing_disabled(ts)
-00014720: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00014730: 2020 2020 2020 2072 6574 7572 6e20 7b74         return {t
-00014740: 732e 6b65 793a 2022 6e6f 2d77 6f72 6b65  s.key: "no-worke
-00014750: 7222 7d2c 207b 7d2c 207b 7d0a 2020 2020  r"}, {}, {}.    
-00014760: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00014770: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00014780: 206e 6f74 2028 7773 203a 3d20 7365 6c66   not (ws := self
-00014790: 2e64 6563 6964 655f 776f 726b 6572 5f72  .decide_worker_r
-000147a0: 6f6f 7469 7368 5f71 7565 7569 6e67 5f65  ootish_queuing_e
-000147b0: 6e61 626c 6564 2829 293a 0a20 2020 2020  nabled()):.     
-000147c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000147d0: 6574 7572 6e20 7b74 732e 6b65 793a 2022  eturn {ts.key: "
-000147e0: 7175 6575 6564 227d 2c20 7b7d 2c20 7b7d  queued"}, {}, {}
-000147f0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00014800: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00014810: 7420 2877 7320 3a3d 2073 656c 662e 6465  t (ws := self.de
-00014820: 6369 6465 5f77 6f72 6b65 725f 6e6f 6e5f  cide_worker_non_
-00014830: 726f 6f74 6973 6828 7473 2929 3a0a 2020  rootish(ts)):.  
-00014840: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00014850: 7475 726e 207b 7473 2e6b 6579 3a20 226e  turn {ts.key: "n
-00014860: 6f2d 776f 726b 6572 227d 2c20 7b7d 2c20  o-worker"}, {}, 
-00014870: 7b7d 0a0a 2020 2020 2020 2020 7265 7475  {}..        retu
-00014880: 726e 2073 656c 662e 5f61 6464 5f74 6f5f  rn self._add_to_
-00014890: 7072 6f63 6573 7369 6e67 2874 732c 2077  processing(ts, w
-000148a0: 732c 2073 7469 6d75 6c75 735f 6964 3d73  s, stimulus_id=s
-000148b0: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
-000148c0: 2064 6566 205f 7472 616e 7369 7469 6f6e   def _transition
-000148d0: 5f77 6169 7469 6e67 5f6d 656d 6f72 7928  _waiting_memory(
-000148e0: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
-000148f0: 2020 2020 2020 206b 6579 3a20 4b65 792c         key: Key,
-00014900: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-00014910: 735f 6964 3a20 7374 722c 0a20 2020 2020  s_id: str,.     
-00014920: 2020 202a 2c0a 2020 2020 2020 2020 6e62     *,.        nb
-00014930: 7974 6573 3a20 696e 7420 7c20 4e6f 6e65  ytes: int | None
-00014940: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-00014950: 2074 7970 653a 2062 7974 6573 207c 204e   type: bytes | N
-00014960: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00014970: 2020 2020 7479 7065 6e61 6d65 3a20 7374      typename: st
-00014980: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
-00014990: 0a20 2020 2020 2020 2077 6f72 6b65 723a  .        worker:
-000149a0: 2073 7472 2c0a 2020 2020 2020 2020 2a2a   str,.        **
-000149b0: 6b77 6172 6773 3a20 416e 792c 0a20 2020  kwargs: Any,.   
-000149c0: 2029 202d 3e20 5265 6373 4d73 6773 3a0a   ) -> RecsMsgs:.
-000149d0: 2020 2020 2020 2020 2222 2254 6869 7320          """This 
-000149e0: 7472 616e 7369 7469 6f6e 2065 7863 6c75  transition exclu
-000149f0: 7369 7665 6c79 2068 6170 7065 6e73 2069  sively happens i
-00014a00: 6e20 6120 7261 6365 2063 6f6e 6469 7469  n a race conditi
-00014a10: 6f6e 2077 6865 7265 2074 6865 2073 6368  on where the sch
-00014a20: 6564 756c 6572 0a20 2020 2020 2020 2062  eduler.        b
-00014a30: 656c 6965 7665 7320 7468 6174 2074 6865  elieves that the
-00014a40: 206f 6e6c 7920 636f 7079 206f 6620 6120   only copy of a 
-00014a50: 6465 7065 6e64 656e 6379 2074 6173 6b20  dependency task 
-00014a60: 6861 7320 6a75 7374 2062 6565 6e20 6c6f  has just been lo
-00014a70: 7374 2c20 736f 2069 740a 2020 2020 2020  st, so it.      
-00014a80: 2020 7472 616e 7369 7469 6f6e 7320 616c    transitions al
-00014a90: 6c20 6465 7065 6e64 656e 7473 2062 6163  l dependents bac
-00014aa0: 6b20 746f 2077 6169 7469 6e67 2c20 6275  k to waiting, bu
-00014ab0: 7420 6163 7475 616c 6c79 2061 2072 6570  t actually a rep
-00014ac0: 6c69 6361 2068 6173 2061 6c72 6561 6479  lica has already
-00014ad0: 0a20 2020 2020 2020 2062 6565 6e20 6163  .        been ac
-00014ae0: 7175 6972 6564 2062 7920 6120 776f 726b  quired by a work
-00014af0: 6572 2063 6f6d 7075 7469 6e67 2074 6865  er computing the
-00014b00: 2064 6570 656e 6465 6e63 7920 2d20 7468   dependency - th
-00014b10: 6520 7363 6865 6475 6c65 7220 6a75 7374  e scheduler just
-00014b20: 2064 6f65 736e 2774 0a20 2020 2020 2020   doesn't.       
-00014b30: 206b 6e6f 7720 7965 7420 2d20 616e 6420   know yet - and 
-00014b40: 7468 6520 6578 6563 7574 696f 6e20 6669  the execution fi
-00014b50: 6e69 7368 6573 2062 6566 6f72 6520 7468  nishes before th
-00014b60: 6520 6361 6e63 656c 6c61 7469 6f6e 206d  e cancellation m
-00014b70: 6573 7361 6765 2066 726f 6d20 7468 650a  essage from the.
-00014b80: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-00014b90: 7220 6861 7320 6120 6368 616e 6365 2074  r has a chance t
-00014ba0: 6f20 7265 6163 6820 7468 6520 776f 726b  o reach the work
-00014bb0: 6572 2e20 5368 6f72 746c 792c 2074 6865  er. Shortly, the
-00014bc0: 2063 616e 6365 6c6c 6174 696f 6e20 7265   cancellation re
-00014bd0: 7175 6573 740a 2020 2020 2020 2020 7769  quest.        wi
-00014be0: 6c6c 2072 6561 6368 2074 6865 2077 6f72  ll reach the wor
-00014bf0: 6b65 722c 2074 6875 7320 6465 6c65 7469  ker, thus deleti
-00014c00: 6e67 2074 6865 2064 6174 6120 6672 6f6d  ng the data from
-00014c10: 206d 656d 6f72 792e 0a20 2020 2020 2020   memory..       
-00014c20: 2022 2222 0a20 2020 2020 2020 2074 7320   """.        ts 
-00014c30: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-00014c40: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
-00014c50: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
-00014c60: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00014c70: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-00014c80: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
-00014c90: 2061 7373 6572 7420 7473 2e77 6169 7469   assert ts.waiti
-00014ca0: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
-00014cb0: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
-00014cc0: 6520 3d3d 2022 7761 6974 696e 6722 0a0a  e == "waiting"..
-00014cd0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00014ce0: 7d2c 207b 7d2c 207b 7d0a 0a20 2020 2064  }, {}, {}..    d
-00014cf0: 6566 205f 7472 616e 7369 7469 6f6e 5f70  ef _transition_p
-00014d00: 726f 6365 7373 696e 675f 6d65 6d6f 7279  rocessing_memory
-00014d10: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00014d20: 2020 2020 2020 2020 6b65 793a 204b 6579          key: Key
-00014d30: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
-00014d40: 7573 5f69 643a 2073 7472 2c0a 2020 2020  us_id: str,.    
-00014d50: 2020 2020 2a2c 0a20 2020 2020 2020 206e      *,.        n
-00014d60: 6279 7465 733a 2069 6e74 207c 204e 6f6e  bytes: int | Non
-00014d70: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00014d80: 2020 7479 7065 3a20 6279 7465 7320 7c20    type: bytes | 
-00014d90: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00014da0: 2020 2020 2074 7970 656e 616d 653a 2073       typename: s
-00014db0: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-00014dc0: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
-00014dd0: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
-00014de0: 7461 7274 7374 6f70 733a 206c 6973 745b  tartstops: list[
-00014df0: 6469 6374 5d20 7c20 4e6f 6e65 203d 204e  dict] | None = N
-00014e00: 6f6e 652c 0a20 2020 2020 2020 202a 2a6b  one,.        **k
-00014e10: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
-00014e20: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
-00014e30: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00014e40: 2e74 6173 6b73 5b6b 6579 5d0a 0a20 2020  .tasks[key]..   
-00014e50: 2020 2020 2061 7373 6572 7420 776f 726b       assert work
-00014e60: 6572 0a20 2020 2020 2020 2061 7373 6572  er.        asser
-00014e70: 7420 6973 696e 7374 616e 6365 2877 6f72  t isinstance(wor
-00014e80: 6b65 722c 2073 7472 290a 0a20 2020 2020  ker, str)..     
-00014e90: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00014ea0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00014eb0: 2061 7373 6572 7420 7473 2e70 726f 6365   assert ts.proce
-00014ec0: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-00014ed0: 2020 2020 2077 7373 203d 2074 732e 7072       wss = ts.pr
-00014ee0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
-00014ef0: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
-00014f00: 7373 0a20 2020 2020 2020 2020 2020 2061  ss.            a
-00014f10: 7373 6572 7420 7473 2069 6e20 7773 732e  ssert ts in wss.
-00014f20: 7072 6f63 6573 7369 6e67 0a20 2020 2020  processing.     
-00014f30: 2020 2020 2020 2064 656c 2077 7373 0a20         del wss. 
-00014f40: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00014f50: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-00014f60: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-00014f70: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
-00014f80: 6f5f 6861 732c 2028 7473 2c20 7473 2e77  o_has, (ts, ts.w
-00014f90: 686f 5f68 6173 290a 2020 2020 2020 2020  ho_has).        
-00014fa0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00014fb0: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
-00014fc0: 650a 2020 2020 2020 2020 2020 2020 6173  e.            as
-00014fd0: 7365 7274 2074 732e 7374 6174 6520 3d3d  sert ts.state ==
-00014fe0: 2022 7072 6f63 6573 7369 6e67 220a 0a20   "processing".. 
-00014ff0: 2020 2020 2020 2077 7320 3d20 7365 6c66         ws = self
-00015000: 2e77 6f72 6b65 7273 2e67 6574 2877 6f72  .workers.get(wor
-00015010: 6b65 7229 0a20 2020 2020 2020 2069 6620  ker).        if 
-00015020: 7773 2069 7320 4e6f 6e65 3a0a 2020 2020  ws is None:.    
-00015030: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00015040: 6b65 793a 2022 7265 6c65 6173 6564 227d  key: "released"}
-00015050: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 2020  , {}, {}..      
-00015060: 2020 6966 2077 7320 213d 2074 732e 7072    if ws != ts.pr
-00015070: 6f63 6573 7369 6e67 5f6f 6e3a 2020 2320  ocessing_on:  # 
-00015080: 7072 6167 6d61 3a20 6e6f 636f 7665 720a  pragma: nocover.
-00015090: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000150a0: 7274 2074 732e 7072 6f63 6573 7369 6e67  rt ts.processing
-000150b0: 5f6f 6e0a 2020 2020 2020 2020 2020 2020  _on.            
-000150c0: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-000150d0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-000150e0: 2020 2020 6622 5461 736b 207b 7473 2e6b      f"Task {ts.k
-000150f0: 6579 2172 7d20 7472 616e 7369 7469 6f6e  ey!r} transition
-00015100: 6564 2066 726f 6d20 7072 6f63 6573 7369  ed from processi
-00015110: 6e67 2074 6f20 6d65 6d6f 7279 206f 6e20  ng to memory on 
-00015120: 776f 726b 6572 2022 0a20 2020 2020 2020  worker ".       
-00015130: 2020 2020 2020 2020 2066 227b 7773 7d2c           f"{ws},
-00015140: 2077 6869 6c65 2069 7420 7761 7320 6578   while it was ex
-00015150: 7065 6374 6564 2066 726f 6d20 7b74 732e  pected from {ts.
-00015160: 7072 6f63 6573 7369 6e67 5f6f 6e7d 2e20  processing_on}. 
-00015170: 5468 6973 2073 686f 756c 6420 220a 2020  This should ".  
-00015180: 2020 2020 2020 2020 2020 2020 2020 6622                f"
-00015190: 6265 2069 6d70 6f73 7369 626c 652e 207b  be impossible. {
-000151a0: 7374 696d 756c 7573 5f69 643d 7d2c 2073  stimulus_id=}, s
-000151b0: 746f 7279 3d7b 7365 6c66 2e73 746f 7279  tory={self.story
-000151c0: 2874 7329 7d22 0a20 2020 2020 2020 2020  (ts)}".         
-000151d0: 2020 2029 0a0a 2020 2020 2020 2020 2323     )..        ##
-000151e0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000151f0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-00015200: 2020 2020 2320 5570 6461 7465 2054 696d      # Update Tim
-00015210: 696e 6720 496e 666f 726d 6174 696f 6e20  ing Information 
-00015220: 230a 2020 2020 2020 2020 2323 2323 2323  #.        ######
+000142c0: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
+000142d0: 2020 2020 2020 2020 2065 6c73 653a 2020           else:  
+000142e0: 2320 6475 6d62 2062 7574 2066 6173 7420  # dumb but fast 
+000142f0: 696e 206c 6172 6765 2063 6173 650a 2020  in large case.  
+00014300: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+00014310: 203d 2077 705f 7661 6c73 5b73 656c 662e   = wp_vals[self.
+00014320: 6e5f 7461 736b 7320 2520 6e5f 776f 726b  n_tasks % n_work
+00014330: 6572 735d 0a0a 2020 2020 2020 2020 6966  ers]..        if
+00014340: 2073 656c 662e 7661 6c69 6461 7465 2061   self.validate a
+00014350: 6e64 2077 7320 6973 206e 6f74 204e 6f6e  nd ws is not Non
+00014360: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00014370: 7373 6572 7420 7365 6c66 2e77 6f72 6b65  ssert self.worke
+00014380: 7273 2e67 6574 2877 732e 6164 6472 6573  rs.get(ws.addres
+00014390: 7329 2069 7320 7773 0a20 2020 2020 2020  s) is ws.       
+000143a0: 2020 2020 2061 7373 6572 7420 7773 2069       assert ws i
+000143b0: 6e20 7365 6c66 2e72 756e 6e69 6e67 2c20  n self.running, 
+000143c0: 2877 732c 2073 656c 662e 7275 6e6e 696e  (ws, self.runnin
+000143d0: 6729 0a0a 2020 2020 2020 2020 7265 7475  g)..        retu
+000143e0: 726e 2077 730a 0a20 2020 2064 6566 205f  rn ws..    def _
+000143f0: 7472 616e 7369 7469 6f6e 5f77 6169 7469  transition_waiti
+00014400: 6e67 5f70 726f 6365 7373 696e 6728 7365  ng_processing(se
+00014410: 6c66 2c20 6b65 793a 204b 6579 2c20 7374  lf, key: Key, st
+00014420: 696d 756c 7573 5f69 643a 2073 7472 2920  imulus_id: str) 
+00014430: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
+00014440: 2020 2020 2022 2222 506f 7373 6962 6c79       """Possibly
+00014450: 2073 6368 6564 756c 6520 6120 7265 6164   schedule a read
+00014460: 7920 7461 736b 2e20 5468 6973 2069 7320  y task. This is 
+00014470: 7468 6520 7072 696d 6172 7920 6469 7370  the primary disp
+00014480: 6174 6368 2066 6f72 2072 6561 6479 2074  atch for ready t
+00014490: 6173 6b73 2e0a 0a20 2020 2020 2020 2049  asks...        I
+000144a0: 6620 7468 6572 6527 7320 6e6f 2061 7070  f there's no app
+000144b0: 726f 7072 6961 7465 2077 6f72 6b65 7220  ropriate worker 
+000144c0: 666f 7220 7468 6520 7461 736b 2028 6275  for the task (bu
+000144d0: 7420 7468 6520 7461 736b 2069 7320 6f74  t the task is ot
+000144e0: 6865 7277 6973 650a 2020 2020 2020 2020  herwise.        
+000144f0: 7275 6e6e 6162 6c65 292c 2069 7420 7769  runnable), it wi
+00014500: 6c6c 2062 6520 7265 636f 6d6d 656e 6465  ll be recommende
+00014510: 6420 746f 2060 606e 6f2d 776f 726b 6572  d to ``no-worker
+00014520: 6060 206f 7220 6060 7175 6575 6564 6060  `` or ``queued``
+00014530: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00014540: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00014550: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
+00014560: 2020 2020 6966 2073 656c 662e 6973 5f72      if self.is_r
+00014570: 6f6f 7469 7368 2874 7329 3a0a 2020 2020  ootish(ts):.    
+00014580: 2020 2020 2020 2020 2320 4e4f 5445 3a20          # NOTE: 
+00014590: 6861 7669 6e67 2074 776f 2072 6f6f 742d  having two root-
+000145a0: 6973 6820 6d65 7468 6f64 7320 6973 2074  ish methods is t
+000145b0: 656d 706f 7261 7279 2e20 5768 656e 2074  emporary. When t
+000145c0: 6865 2066 6561 7475 7265 2066 6c61 6720  he feature flag 
+000145d0: 6973 0a20 2020 2020 2020 2020 2020 2023  is.            #
+000145e0: 2072 656d 6f76 6564 2c20 7468 6572 6520   removed, there 
+000145f0: 7368 6f75 6c64 206f 6e6c 7920 6265 206f  should only be o
+00014600: 6e65 2c20 7768 6963 6820 636f 6d62 696e  ne, which combin
+00014610: 6573 2063 6f2d 6173 7369 676e 6d65 6e74  es co-assignment
+00014620: 2061 6e64 0a20 2020 2020 2020 2020 2020   and.           
+00014630: 2023 2071 7565 7569 6e67 2e20 4576 656e   # queuing. Even
+00014640: 7475 616c 6c79 2c20 7370 6563 6961 6c2d  tually, special-
+00014650: 6361 7369 6e67 2072 6f6f 7420 7461 736b  casing root task
+00014660: 7320 6d69 6768 7420 6265 2072 656d 6f76  s might be remov
+00014670: 6564 2065 6e74 6972 656c 792c 0a20 2020  ed entirely,.   
+00014680: 2020 2020 2020 2020 2023 2077 6974 6820           # with 
+00014690: 6265 7474 6572 2068 6575 7269 7374 6963  better heuristic
+000146a0: 732e 0a20 2020 2020 2020 2020 2020 2069  s..            i
+000146b0: 6620 6d61 7468 2e69 7369 6e66 2873 656c  f math.isinf(sel
+000146c0: 662e 574f 524b 4552 5f53 4154 5552 4154  f.WORKER_SATURAT
+000146d0: 494f 4e29 3a0a 2020 2020 2020 2020 2020  ION):.          
+000146e0: 2020 2020 2020 6966 206e 6f74 2028 7773        if not (ws
+000146f0: 203a 3d20 7365 6c66 2e64 6563 6964 655f   := self.decide_
+00014700: 776f 726b 6572 5f72 6f6f 7469 7368 5f71  worker_rootish_q
+00014710: 7565 7569 6e67 5f64 6973 6162 6c65 6428  ueuing_disabled(
+00014720: 7473 2929 3a0a 2020 2020 2020 2020 2020  ts)):.          
+00014730: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00014740: 207b 7473 2e6b 6579 3a20 226e 6f2d 776f   {ts.key: "no-wo
+00014750: 726b 6572 227d 2c20 7b7d 2c20 7b7d 0a20  rker"}, {}, {}. 
+00014760: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00014770: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014780: 2069 6620 6e6f 7420 2877 7320 3a3d 2073   if not (ws := s
+00014790: 656c 662e 6465 6369 6465 5f77 6f72 6b65  elf.decide_worke
+000147a0: 725f 726f 6f74 6973 685f 7175 6575 696e  r_rootish_queuin
+000147b0: 675f 656e 6162 6c65 6428 2929 3a0a 2020  g_enabled()):.  
+000147c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000147d0: 2020 7265 7475 726e 207b 7473 2e6b 6579    return {ts.key
+000147e0: 3a20 2271 7565 7565 6422 7d2c 207b 7d2c  : "queued"}, {},
+000147f0: 207b 7d0a 2020 2020 2020 2020 656c 7365   {}.        else
+00014800: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+00014810: 206e 6f74 2028 7773 203a 3d20 7365 6c66   not (ws := self
+00014820: 2e64 6563 6964 655f 776f 726b 6572 5f6e  .decide_worker_n
+00014830: 6f6e 5f72 6f6f 7469 7368 2874 7329 293a  on_rootish(ts)):
+00014840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014850: 2072 6574 7572 6e20 7b74 732e 6b65 793a   return {ts.key:
+00014860: 2022 6e6f 2d77 6f72 6b65 7222 7d2c 207b   "no-worker"}, {
+00014870: 7d2c 207b 7d0a 0a20 2020 2020 2020 2072  }, {}..        r
+00014880: 6574 7572 6e20 7365 6c66 2e5f 6164 645f  eturn self._add_
+00014890: 746f 5f70 726f 6365 7373 696e 6728 7473  to_processing(ts
+000148a0: 2c20 7773 2c20 7374 696d 756c 7573 5f69  , ws, stimulus_i
+000148b0: 643d 7374 696d 756c 7573 5f69 6429 0a0a  d=stimulus_id)..
+000148c0: 2020 2020 6465 6620 5f74 7261 6e73 6974      def _transit
+000148d0: 696f 6e5f 7761 6974 696e 675f 6d65 6d6f  ion_waiting_memo
+000148e0: 7279 280a 2020 2020 2020 2020 7365 6c66  ry(.        self
+000148f0: 2c0a 2020 2020 2020 2020 6b65 793a 204b  ,.        key: K
+00014900: 6579 2c0a 2020 2020 2020 2020 7374 696d  ey,.        stim
+00014910: 756c 7573 5f69 643a 2073 7472 2c0a 2020  ulus_id: str,.  
+00014920: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+00014930: 206e 6279 7465 733a 2069 6e74 207c 204e   nbytes: int | N
+00014940: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00014950: 2020 2020 7479 7065 3a20 6279 7465 7320      type: bytes 
+00014960: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00014970: 2020 2020 2020 2074 7970 656e 616d 653a         typename:
+00014980: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+00014990: 6e65 2c0a 2020 2020 2020 2020 776f 726b  ne,.        work
+000149a0: 6572 3a20 7374 722c 0a20 2020 2020 2020  er: str,.       
+000149b0: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
+000149c0: 2020 2020 2920 2d3e 2052 6563 734d 7367      ) -> RecsMsg
+000149d0: 733a 0a20 2020 2020 2020 2022 2222 5468  s:.        """Th
+000149e0: 6973 2074 7261 6e73 6974 696f 6e20 6578  is transition ex
+000149f0: 636c 7573 6976 656c 7920 6861 7070 656e  clusively happen
+00014a00: 7320 696e 2061 2072 6163 6520 636f 6e64  s in a race cond
+00014a10: 6974 696f 6e20 7768 6572 6520 7468 6520  ition where the 
+00014a20: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
+00014a30: 2020 6265 6c69 6576 6573 2074 6861 7420    believes that 
+00014a40: 7468 6520 6f6e 6c79 2063 6f70 7920 6f66  the only copy of
+00014a50: 2061 2064 6570 656e 6465 6e63 7920 7461   a dependency ta
+00014a60: 736b 2068 6173 206a 7573 7420 6265 656e  sk has just been
+00014a70: 206c 6f73 742c 2073 6f20 6974 0a20 2020   lost, so it.   
+00014a80: 2020 2020 2074 7261 6e73 6974 696f 6e73       transitions
+00014a90: 2061 6c6c 2064 6570 656e 6465 6e74 7320   all dependents 
+00014aa0: 6261 636b 2074 6f20 7761 6974 696e 672c  back to waiting,
+00014ab0: 2062 7574 2061 6374 7561 6c6c 7920 6120   but actually a 
+00014ac0: 7265 706c 6963 6120 6861 7320 616c 7265  replica has alre
+00014ad0: 6164 790a 2020 2020 2020 2020 6265 656e  ady.        been
+00014ae0: 2061 6371 7569 7265 6420 6279 2061 2077   acquired by a w
+00014af0: 6f72 6b65 7220 636f 6d70 7574 696e 6720  orker computing 
+00014b00: 7468 6520 6465 7065 6e64 656e 6379 202d  the dependency -
+00014b10: 2074 6865 2073 6368 6564 756c 6572 206a   the scheduler j
+00014b20: 7573 7420 646f 6573 6e27 740a 2020 2020  ust doesn't.    
+00014b30: 2020 2020 6b6e 6f77 2079 6574 202d 2061      know yet - a
+00014b40: 6e64 2074 6865 2065 7865 6375 7469 6f6e  nd the execution
+00014b50: 2066 696e 6973 6865 7320 6265 666f 7265   finishes before
+00014b60: 2074 6865 2063 616e 6365 6c6c 6174 696f   the cancellatio
+00014b70: 6e20 6d65 7373 6167 6520 6672 6f6d 2074  n message from t
+00014b80: 6865 0a20 2020 2020 2020 2073 6368 6564  he.        sched
+00014b90: 756c 6572 2068 6173 2061 2063 6861 6e63  uler has a chanc
+00014ba0: 6520 746f 2072 6561 6368 2074 6865 2077  e to reach the w
+00014bb0: 6f72 6b65 722e 2053 686f 7274 6c79 2c20  orker. Shortly, 
+00014bc0: 7468 6520 6361 6e63 656c 6c61 7469 6f6e  the cancellation
+00014bd0: 2072 6571 7565 7374 0a20 2020 2020 2020   request.       
+00014be0: 2077 696c 6c20 7265 6163 6820 7468 6520   will reach the 
+00014bf0: 776f 726b 6572 2c20 7468 7573 2064 656c  worker, thus del
+00014c00: 6574 696e 6720 7468 6520 6461 7461 2066  eting the data f
+00014c10: 726f 6d20 6d65 6d6f 7279 2e0a 2020 2020  rom memory..    
+00014c20: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00014c30: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00014c40: 6b65 795d 0a0a 2020 2020 2020 2020 6966  key]..        if
+00014c50: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
+00014c60: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00014c70: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
+00014c80: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+00014c90: 2020 2020 6173 7365 7274 2074 732e 7761      assert ts.wa
+00014ca0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+00014cb0: 2020 2020 2061 7373 6572 7420 7473 2e73       assert ts.s
+00014cc0: 7461 7465 203d 3d20 2277 6169 7469 6e67  tate == "waiting
+00014cd0: 220a 0a20 2020 2020 2020 2072 6574 7572  "..        retur
+00014ce0: 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a0a 2020  n {}, {}, {}..  
+00014cf0: 2020 6465 6620 5f74 7261 6e73 6974 696f    def _transitio
+00014d00: 6e5f 7072 6f63 6573 7369 6e67 5f6d 656d  n_processing_mem
+00014d10: 6f72 7928 0a20 2020 2020 2020 2073 656c  ory(.        sel
+00014d20: 662c 0a20 2020 2020 2020 206b 6579 3a20  f,.        key: 
+00014d30: 4b65 792c 0a20 2020 2020 2020 2073 7469  Key,.        sti
+00014d40: 6d75 6c75 735f 6964 3a20 7374 722c 0a20  mulus_id: str,. 
+00014d50: 2020 2020 2020 202a 2c0a 2020 2020 2020         *,.      
+00014d60: 2020 6e62 7974 6573 3a20 696e 7420 7c20    nbytes: int | 
+00014d70: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00014d80: 2020 2020 2074 7970 653a 2062 7974 6573       type: bytes
+00014d90: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00014da0: 2020 2020 2020 2020 7479 7065 6e61 6d65          typename
+00014db0: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+00014dc0: 6f6e 652c 0a20 2020 2020 2020 2077 6f72  one,.        wor
+00014dd0: 6b65 723a 2073 7472 2c0a 2020 2020 2020  ker: str,.      
+00014de0: 2020 7374 6172 7473 746f 7073 3a20 6c69    startstops: li
+00014df0: 7374 5b64 6963 745d 207c 204e 6f6e 6520  st[dict] | None 
+00014e00: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+00014e10: 2a2a 6b77 6172 6773 3a20 416e 792c 0a20  **kwargs: Any,. 
+00014e20: 2020 2029 202d 3e20 5265 6373 4d73 6773     ) -> RecsMsgs
+00014e30: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
+00014e40: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
+00014e50: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+00014e60: 6f72 6b65 720a 2020 2020 2020 2020 6173  orker.        as
+00014e70: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00014e80: 776f 726b 6572 2c20 7374 7229 0a0a 2020  worker, str)..  
+00014e90: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+00014ea0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+00014eb0: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
+00014ec0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+00014ed0: 2020 2020 2020 2020 7773 7320 3d20 7473          wss = ts
+00014ee0: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
+00014ef0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00014f00: 7420 7773 730a 2020 2020 2020 2020 2020  t wss.          
+00014f10: 2020 6173 7365 7274 2074 7320 696e 2077    assert ts in w
+00014f20: 7373 2e70 726f 6365 7373 696e 670a 2020  ss.processing.  
+00014f30: 2020 2020 2020 2020 2020 6465 6c20 7773            del ws
+00014f40: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+00014f50: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
+00014f60: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
+00014f70: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00014f80: 2e77 686f 5f68 6173 2c20 2874 732c 2074  .who_has, (ts, t
+00014f90: 732e 7768 6f5f 6861 7329 0a20 2020 2020  s.who_has).     
+00014fa0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+00014fb0: 7420 7473 2e65 7863 6570 7469 6f6e 5f62  t ts.exception_b
+00014fc0: 6c61 6d65 0a20 2020 2020 2020 2020 2020  lame.           
+00014fd0: 2061 7373 6572 7420 7473 2e73 7461 7465   assert ts.state
+00014fe0: 203d 3d20 2270 726f 6365 7373 696e 6722   == "processing"
+00014ff0: 0a0a 2020 2020 2020 2020 7773 203d 2073  ..        ws = s
+00015000: 656c 662e 776f 726b 6572 732e 6765 7428  elf.workers.get(
+00015010: 776f 726b 6572 290a 2020 2020 2020 2020  worker).        
+00015020: 6966 2077 7320 6973 204e 6f6e 653a 0a20  if ws is None:. 
+00015030: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00015040: 6e20 7b6b 6579 3a20 2272 656c 6561 7365  n {key: "release
+00015050: 6422 7d2c 207b 7d2c 207b 7d0a 0a20 2020  d"}, {}, {}..   
+00015060: 2020 2020 2069 6620 7773 2021 3d20 7473       if ws != ts
+00015070: 2e70 726f 6365 7373 696e 675f 6f6e 3a20  .processing_on: 
+00015080: 2023 2070 7261 676d 613a 206e 6f63 6f76   # pragma: nocov
+00015090: 6572 0a20 2020 2020 2020 2020 2020 2061  er.            a
+000150a0: 7373 6572 7420 7473 2e70 726f 6365 7373  ssert ts.process
+000150b0: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
+000150c0: 2020 2072 6169 7365 2052 756e 7469 6d65     raise Runtime
+000150d0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+000150e0: 2020 2020 2020 2066 2254 6173 6b20 7b74         f"Task {t
+000150f0: 732e 6b65 7921 727d 2074 7261 6e73 6974  s.key!r} transit
+00015100: 696f 6e65 6420 6672 6f6d 2070 726f 6365  ioned from proce
+00015110: 7373 696e 6720 746f 206d 656d 6f72 7920  ssing to memory 
+00015120: 6f6e 2077 6f72 6b65 7220 220a 2020 2020  on worker ".    
+00015130: 2020 2020 2020 2020 2020 2020 6622 7b77              f"{w
+00015140: 737d 2c20 7768 696c 6520 6974 2077 6173  s}, while it was
+00015150: 2065 7870 6563 7465 6420 6672 6f6d 207b   expected from {
+00015160: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
+00015170: 7d2e 2054 6869 7320 7368 6f75 6c64 2022  }. This should "
+00015180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015190: 2066 2262 6520 696d 706f 7373 6962 6c65   f"be impossible
+000151a0: 2e20 7b73 7469 6d75 6c75 735f 6964 3d7d  . {stimulus_id=}
+000151b0: 2c20 7374 6f72 793d 7b73 656c 662e 7374  , story={self.st
+000151c0: 6f72 7928 7473 297d 220a 2020 2020 2020  ory(ts)}".      
+000151d0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+000151e0: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+000151f0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+00015200: 2020 2020 2020 2023 2055 7064 6174 6520         # Update 
+00015210: 5469 6d69 6e67 2049 6e66 6f72 6d61 7469  Timing Informati
+00015220: 6f6e 2023 0a20 2020 2020 2020 2023 2323  on #.        ###
 00015230: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015240: 2323 2323 2323 230a 2020 2020 2020 2020  #######.        
-00015250: 6966 2073 7461 7274 7374 6f70 733a 0a20  if startstops:. 
-00015260: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
-00015270: 7461 7274 7374 6f70 2069 6e20 7374 6172  tartstop in star
-00015280: 7473 746f 7073 3a0a 2020 2020 2020 2020  tstops:.        
-00015290: 2020 2020 2020 2020 7473 2e67 726f 7570          ts.group
-000152a0: 2e61 6464 5f64 7572 6174 696f 6e28 0a20  .add_duration(. 
-000152b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000152c0: 2020 2073 746f 703d 7374 6172 7473 746f     stop=startsto
-000152d0: 705b 2273 746f 7022 5d2c 0a20 2020 2020  p["stop"],.     
-000152e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000152f0: 7461 7274 3d73 7461 7274 7374 6f70 5b22  tart=startstop["
-00015300: 7374 6172 7422 5d2c 0a20 2020 2020 2020  start"],.       
-00015310: 2020 2020 2020 2020 2020 2020 2061 6374               act
-00015320: 696f 6e3d 7374 6172 7473 746f 705b 2261  ion=startstop["a
-00015330: 6374 696f 6e22 5d2c 0a20 2020 2020 2020  ction"],.       
-00015340: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00015350: 2020 2020 7320 3d20 7365 6c66 2e75 6e6b      s = self.unk
-00015360: 6e6f 776e 5f64 7572 6174 696f 6e73 2e70  nown_durations.p
-00015370: 6f70 2874 732e 7072 6566 6978 2e6e 616d  op(ts.prefix.nam
-00015380: 652c 2073 6574 2829 290a 2020 2020 2020  e, set()).      
-00015390: 2020 7374 6561 6c20 3d20 7365 6c66 2e65    steal = self.e
-000153a0: 7874 656e 7369 6f6e 732e 6765 7428 2273  xtensions.get("s
-000153b0: 7465 616c 696e 6722 290a 2020 2020 2020  tealing").      
-000153c0: 2020 6966 2073 7465 616c 3a0a 2020 2020    if steal:.    
-000153d0: 2020 2020 2020 2020 666f 7220 7474 7320          for tts 
-000153e0: 696e 2073 3a0a 2020 2020 2020 2020 2020  in s:.          
-000153f0: 2020 2020 2020 6966 2074 7473 2e70 726f        if tts.pro
-00015400: 6365 7373 696e 675f 6f6e 3a0a 2020 2020  cessing_on:.    
+00015240: 2323 2323 2323 2323 2323 0a20 2020 2020  ##########.     
+00015250: 2020 2069 6620 7374 6172 7473 746f 7073     if startstops
+00015260: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+00015270: 7220 7374 6172 7473 746f 7020 696e 2073  r startstop in s
+00015280: 7461 7274 7374 6f70 733a 0a20 2020 2020  tartstops:.     
+00015290: 2020 2020 2020 2020 2020 2074 732e 6772             ts.gr
+000152a0: 6f75 702e 6164 645f 6475 7261 7469 6f6e  oup.add_duration
+000152b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000152c0: 2020 2020 2020 7374 6f70 3d73 7461 7274        stop=start
+000152d0: 7374 6f70 5b22 7374 6f70 225d 2c0a 2020  stop["stop"],.  
+000152e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000152f0: 2020 7374 6172 743d 7374 6172 7473 746f    start=startsto
+00015300: 705b 2273 7461 7274 225d 2c0a 2020 2020  p["start"],.    
+00015310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015320: 6163 7469 6f6e 3d73 7461 7274 7374 6f70  action=startstop
+00015330: 5b22 6163 7469 6f6e 225d 2c0a 2020 2020  ["action"],.    
+00015340: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00015350: 2020 2020 2020 2073 203d 2073 656c 662e         s = self.
+00015360: 756e 6b6e 6f77 6e5f 6475 7261 7469 6f6e  unknown_duration
+00015370: 732e 706f 7028 7473 2e70 7265 6669 782e  s.pop(ts.prefix.
+00015380: 6e61 6d65 2c20 7365 7428 2929 0a20 2020  name, set()).   
+00015390: 2020 2020 2073 7465 616c 203d 2073 656c       steal = sel
+000153a0: 662e 6578 7465 6e73 696f 6e73 2e67 6574  f.extensions.get
+000153b0: 2822 7374 6561 6c69 6e67 2229 0a20 2020  ("stealing").   
+000153c0: 2020 2020 2069 6620 7374 6561 6c3a 0a20       if steal:. 
+000153d0: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+000153e0: 7473 2069 6e20 733a 0a20 2020 2020 2020  ts in s:.       
+000153f0: 2020 2020 2020 2020 2069 6620 7474 732e           if tts.
+00015400: 7072 6f63 6573 7369 6e67 5f6f 6e3a 0a20  processing_on:. 
 00015410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015420: 7374 6561 6c2e 7265 6361 6c63 756c 6174  steal.recalculat
-00015430: 655f 636f 7374 2874 7473 290a 0a20 2020  e_cost(tts)..   
-00015440: 2020 2020 2023 2323 2323 2323 2323 2323       ###########
+00015420: 2020 2073 7465 616c 2e72 6563 616c 6375     steal.recalcu
+00015430: 6c61 7465 5f63 6f73 7428 7474 7329 0a0a  late_cost(tts)..
+00015440: 2020 2020 2020 2020 2323 2323 2323 2323          ########
 00015450: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00015460: 230a 2020 2020 2020 2020 2320 5570 6461  #.        # Upda
-00015470: 7465 2053 7461 7465 2049 6e66 6f72 6d61  te State Informa
-00015480: 7469 6f6e 2023 0a20 2020 2020 2020 2023  tion #.        #
-00015490: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000154a0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-000154b0: 2020 2020 6966 206e 6279 7465 7320 6973      if nbytes is
-000154c0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000154d0: 2020 2020 2020 2074 732e 7365 745f 6e62         ts.set_nb
-000154e0: 7974 6573 286e 6279 7465 7329 0a0a 2020  ytes(nbytes)..  
-000154f0: 2020 2020 2020 7365 6c66 2e5f 6578 6974        self._exit
-00015500: 5f70 726f 6365 7373 696e 675f 636f 6d6d  _processing_comm
-00015510: 6f6e 2874 7329 0a0a 2020 2020 2020 2020  on(ts)..        
-00015520: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
-00015530: 2052 6563 7320 3d20 7b7d 0a20 2020 2020   Recs = {}.     
-00015540: 2020 2063 6c69 656e 745f 6d73 6773 3a20     client_msgs: 
-00015550: 4d73 6773 203d 207b 7d0a 2020 2020 2020  Msgs = {}.      
-00015560: 2020 7365 6c66 2e5f 6164 645f 746f 5f6d    self._add_to_m
-00015570: 656d 6f72 7928 0a20 2020 2020 2020 2020  emory(.         
-00015580: 2020 2074 732c 2077 732c 2072 6563 6f6d     ts, ws, recom
-00015590: 6d65 6e64 6174 696f 6e73 2c20 636c 6965  mendations, clie
-000155a0: 6e74 5f6d 7367 732c 2074 7970 653d 7479  nt_msgs, type=ty
-000155b0: 7065 2c20 7479 7065 6e61 6d65 3d74 7970  pe, typename=typ
-000155c0: 656e 616d 650a 2020 2020 2020 2020 290a  ename.        ).
-000155d0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-000155e0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-000155f0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00015600: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-00015610: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
-00015620: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
-00015630: 7469 6e67 5f6f 6e0a 0a20 2020 2020 2020  ting_on..       
-00015640: 2072 6574 7572 6e20 7265 636f 6d6d 656e   return recommen
-00015650: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
-00015660: 6d73 6773 2c20 7b7d 0a0a 2020 2020 6465  msgs, {}..    de
-00015670: 6620 5f74 7261 6e73 6974 696f 6e5f 6d65  f _transition_me
-00015680: 6d6f 7279 5f72 656c 6561 7365 6428 0a20  mory_released(. 
-00015690: 2020 2020 2020 2073 656c 662c 206b 6579         self, key
-000156a0: 3a20 4b65 792c 2073 7469 6d75 6c75 735f  : Key, stimulus_
-000156b0: 6964 3a20 7374 722c 202a 2c20 7361 6665  id: str, *, safe
-000156c0: 3a20 626f 6f6c 203d 2046 616c 7365 0a20  : bool = False. 
-000156d0: 2020 2029 202d 3e20 5265 6373 4d73 6773     ) -> RecsMsgs
-000156e0: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
-000156f0: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
-00015700: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00015710: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-00015720: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00015730: 2074 732e 7761 6974 696e 675f 6f6e 0a20   ts.waiting_on. 
-00015740: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00015750: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
-00015760: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
-00015770: 2020 2069 6620 7361 6665 3a0a 2020 2020     if safe:.    
-00015780: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00015790: 7274 206e 6f74 2074 732e 7761 6974 6572  rt not ts.waiter
-000157a0: 730a 0a20 2020 2020 2020 2069 6620 7473  s..        if ts
-000157b0: 2e61 6374 6f72 3a0a 2020 2020 2020 2020  .actor:.        
-000157c0: 2020 2020 666f 7220 7773 2069 6e20 7473      for ws in ts
-000157d0: 2e77 686f 5f68 6173 206f 7220 2829 3a0a  .who_has or ():.
-000157e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000157f0: 7773 2e61 6374 6f72 732e 6469 7363 6172  ws.actors.discar
-00015800: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
-00015810: 2020 6966 2074 732e 7768 6f5f 7761 6e74    if ts.who_want
-00015820: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00015830: 2020 2074 732e 6578 6365 7074 696f 6e5f     ts.exception_
-00015840: 626c 616d 6520 3d20 7473 0a20 2020 2020  blame = ts.     
-00015850: 2020 2020 2020 2020 2020 2074 732e 6578             ts.ex
-00015860: 6365 7074 696f 6e20 3d20 5365 7269 616c  ception = Serial
-00015870: 697a 6564 280a 2020 2020 2020 2020 2020  ized(.          
-00015880: 2020 2020 2020 2020 2020 2a73 6572 6961            *seria
-00015890: 6c69 7a65 2856 616c 7565 4572 726f 7228  lize(ValueError(
-000158a0: 2257 6f72 6b65 7220 686f 6c64 696e 6720  "Worker holding 
-000158b0: 4163 746f 7220 7761 7320 6c6f 7374 2229  Actor was lost")
-000158c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000158d0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000158e0: 2020 2020 7265 7475 726e 207b 7473 2e6b      return {ts.k
-000158f0: 6579 3a20 2265 7272 6564 227d 2c20 7b7d  ey: "erred"}, {}
-00015900: 2c20 7b7d 2020 2320 646f 6e27 7420 7472  , {}  # don't tr
-00015910: 7920 746f 2072 6563 7265 6174 650a 0a20  y to recreate.. 
-00015920: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-00015930: 6174 696f 6e73 3a20 5265 6373 203d 207b  ations: Recs = {
-00015940: 7d0a 2020 2020 2020 2020 636c 6965 6e74  }.        client
-00015950: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
-00015960: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00015970: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
-00015980: 0a20 2020 2020 2020 2023 2058 5858 2066  .        # XXX f
-00015990: 6163 746f 7220 7468 6973 206f 7574 3f0a  actor this out?.
-000159a0: 2020 2020 2020 2020 776f 726b 6572 5f6d          worker_m
-000159b0: 7367 203d 207b 0a20 2020 2020 2020 2020  sg = {.         
-000159c0: 2020 2022 6f70 223a 2022 6672 6565 2d6b     "op": "free-k
-000159d0: 6579 7322 2c0a 2020 2020 2020 2020 2020  eys",.          
-000159e0: 2020 226b 6579 7322 3a20 5b6b 6579 5d2c    "keys": [key],
-000159f0: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
-00015a00: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
-00015a10: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
-00015a20: 207d 0a20 2020 2020 2020 2066 6f72 2077   }.        for w
-00015a30: 7320 696e 2074 732e 7768 6f5f 6861 7320  s in ts.who_has 
-00015a40: 6f72 2028 293a 0a20 2020 2020 2020 2020  or ():.         
-00015a50: 2020 2077 6f72 6b65 725f 6d73 6773 5b77     worker_msgs[w
-00015a60: 732e 6164 6472 6573 735d 203d 205b 776f  s.address] = [wo
-00015a70: 726b 6572 5f6d 7367 5d0a 2020 2020 2020  rker_msg].      
-00015a80: 2020 7365 6c66 2e72 656d 6f76 655f 616c    self.remove_al
-00015a90: 6c5f 7265 706c 6963 6173 2874 7329 0a0a  l_replicas(ts)..
-00015aa0: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
-00015ab0: 203d 2022 7265 6c65 6173 6564 220a 0a20   = "released".. 
-00015ac0: 2020 2020 2020 2072 6570 6f72 745f 6d73         report_ms
-00015ad0: 6720 3d20 7b22 6f70 223a 2022 6c6f 7374  g = {"op": "lost
-00015ae0: 2d64 6174 6122 2c20 226b 6579 223a 206b  -data", "key": k
-00015af0: 6579 7d0a 2020 2020 2020 2020 666f 7220  ey}.        for 
-00015b00: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
-00015b10: 7473 206f 7220 2829 3a0a 2020 2020 2020  ts or ():.      
-00015b20: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
-00015b30: 735b 6373 2e63 6c69 656e 745f 6b65 795d  s[cs.client_key]
-00015b40: 203d 205b 7265 706f 7274 5f6d 7367 5d0a   = [report_msg].
-00015b50: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00015b60: 7473 2e72 756e 5f73 7065 633a 2020 2320  ts.run_spec:  # 
-00015b70: 7075 7265 2064 6174 610a 2020 2020 2020  pure data.      
-00015b80: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00015b90: 7469 6f6e 735b 6b65 795d 203d 2022 666f  tions[key] = "fo
-00015ba0: 7267 6f74 7465 6e22 0a20 2020 2020 2020  rgotten".       
-00015bb0: 2065 6c69 6620 7473 2e68 6173 5f6c 6f73   elif ts.has_los
-00015bc0: 745f 6465 7065 6e64 656e 6369 6573 3a0a  t_dependencies:.
-00015bd0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-00015be0: 6d6d 656e 6461 7469 6f6e 735b 6b65 795d  mmendations[key]
-00015bf0: 203d 2022 666f 7267 6f74 7465 6e22 0a20   = "forgotten". 
-00015c00: 2020 2020 2020 2065 6c69 6620 2874 732e         elif (ts.
-00015c10: 7768 6f5f 7761 6e74 7320 6f72 2074 732e  who_wants or ts.
-00015c20: 7761 6974 6572 7329 2061 6e64 206e 6f74  waiters) and not
-00015c30: 2061 6e79 280a 2020 2020 2020 2020 2020   any(.          
-00015c40: 2020 6474 732e 7374 6174 6520 3d3d 2022    dts.state == "
-00015c50: 6572 7265 6422 2066 6f72 2064 7473 2069  erred" for dts i
-00015c60: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
-00015c70: 730a 2020 2020 2020 2020 293a 0a20 2020  s.        ):.   
-00015c80: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-00015c90: 6e64 6174 696f 6e73 5b6b 6579 5d20 3d20  ndations[key] = 
-00015ca0: 2277 6169 7469 6e67 220a 0a20 2020 2020  "waiting"..     
-00015cb0: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
-00015cc0: 2e77 6169 7465 7273 206f 7220 2829 3a0a  .waiters or ():.
-00015cd0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00015ce0: 7473 2e73 7461 7465 2069 6e20 2822 6e6f  ts.state in ("no
-00015cf0: 2d77 6f72 6b65 7222 2c20 2270 726f 6365  -worker", "proce
-00015d00: 7373 696e 6722 293a 0a20 2020 2020 2020  ssing"):.       
-00015d10: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-00015d20: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
-00015d30: 5d20 3d20 2277 6169 7469 6e67 220a 2020  ] = "waiting".  
-00015d40: 2020 2020 2020 2020 2020 656c 6966 2064            elif d
-00015d50: 7473 2e73 7461 7465 203d 3d20 2277 6169  ts.state == "wai
-00015d60: 7469 6e67 223a 0a20 2020 2020 2020 2020  ting":.         
-00015d70: 2020 2020 2020 2069 6620 6e6f 7420 6474         if not dt
-00015d80: 732e 7761 6974 696e 675f 6f6e 3a0a 2020  s.waiting_on:.  
-00015d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015da0: 2020 6474 732e 7761 6974 696e 675f 6f6e    dts.waiting_on
-00015db0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
-00015dc0: 2020 2020 2020 2020 2064 7473 2e77 6169           dts.wai
-00015dd0: 7469 6e67 5f6f 6e2e 6164 6428 7473 290a  ting_on.add(ts).
-00015de0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00015df0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00015e00: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00015e10: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
-00015e20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00015e30: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
-00015e40: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
-00015e50: 726b 6572 5f6d 7367 730a 0a20 2020 2064  rker_msgs..    d
-00015e60: 6566 205f 7472 616e 7369 7469 6f6e 5f72  ef _transition_r
-00015e70: 656c 6561 7365 645f 6572 7265 6428 7365  eleased_erred(se
-00015e80: 6c66 2c20 6b65 793a 204b 6579 2c20 7374  lf, key: Key, st
-00015e90: 696d 756c 7573 5f69 643a 2073 7472 2920  imulus_id: str) 
-00015ea0: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
-00015eb0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00015ec0: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
-00015ed0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00015ee0: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
-00015ef0: 2020 2020 2063 6c69 656e 745f 6d73 6773       client_msgs
-00015f00: 3a20 4d73 6773 203d 207b 7d0a 0a20 2020  : Msgs = {}..   
-00015f10: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
-00015f20: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
-00015f30: 2020 2061 7373 6572 7420 7473 2e65 7863     assert ts.exc
-00015f40: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
-00015f50: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00015f60: 6e6f 7420 7473 2e77 686f 5f68 6173 0a20  not ts.who_has. 
-00015f70: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00015f80: 7420 6e6f 7420 7473 2e77 6169 7469 6e67  t not ts.waiting
-00015f90: 5f6f 6e0a 0a20 2020 2020 2020 2066 6169  _on..        fai
-00015fa0: 6c69 6e67 5f74 7320 3d20 7473 2e65 7863  ling_ts = ts.exc
-00015fb0: 6570 7469 6f6e 5f62 6c61 6d65 0a20 2020  eption_blame.   
-00015fc0: 2020 2020 2061 7373 6572 7420 6661 696c       assert fail
-00015fd0: 696e 675f 7473 0a0a 2020 2020 2020 2020  ing_ts..        
-00015fe0: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-00015ff0: 7065 6e64 656e 7473 3a0a 2020 2020 2020  pendents:.      
-00016000: 2020 2020 2020 6966 206e 6f74 2064 7473        if not dts
-00016010: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
-00016020: 2020 2020 2020 2020 2020 6474 732e 6578            dts.ex
-00016030: 6365 7074 696f 6e5f 626c 616d 6520 3d20  ception_blame = 
-00016040: 6661 696c 696e 675f 7473 0a20 2020 2020  failing_ts.     
-00016050: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-00016060: 6d65 6e64 6174 696f 6e73 5b64 7473 2e6b  mendations[dts.k
-00016070: 6579 5d20 3d20 2265 7272 6564 220a 0a20  ey] = "erred".. 
-00016080: 2020 2020 2020 2072 6570 6f72 745f 6d73         report_ms
-00016090: 6720 3d20 7b0a 2020 2020 2020 2020 2020  g = {.          
-000160a0: 2020 226f 7022 3a20 2274 6173 6b2d 6572    "op": "task-er
-000160b0: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
-000160c0: 2020 226b 6579 223a 206b 6579 2c0a 2020    "key": key,.  
-000160d0: 2020 2020 2020 2020 2020 2265 7863 6570            "excep
-000160e0: 7469 6f6e 223a 2066 6169 6c69 6e67 5f74  tion": failing_t
-000160f0: 732e 6578 6365 7074 696f 6e2c 0a20 2020  s.exception,.   
-00016100: 2020 2020 2020 2020 2022 7472 6163 6562           "traceb
-00016110: 6163 6b22 3a20 6661 696c 696e 675f 7473  ack": failing_ts
-00016120: 2e74 7261 6365 6261 636b 2c0a 2020 2020  .traceback,.    
-00016130: 2020 2020 7d0a 2020 2020 2020 2020 666f      }.        fo
-00016140: 7220 6373 2069 6e20 7473 2e77 686f 5f77  r cs in ts.who_w
-00016150: 616e 7473 206f 7220 2829 3a0a 2020 2020  ants or ():.    
-00016160: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
-00016170: 7367 735b 6373 2e63 6c69 656e 745f 6b65  sgs[cs.client_ke
-00016180: 795d 203d 205b 7265 706f 7274 5f6d 7367  y] = [report_msg
-00016190: 5d0a 0a20 2020 2020 2020 2074 732e 7374  ]..        ts.st
-000161a0: 6174 6520 3d20 2265 7272 6564 220a 0a20  ate = "erred".. 
-000161b0: 2020 2020 2020 2023 2054 4f44 4f3a 2077         # TODO: w
-000161c0: 6169 7469 6e67 2064 6174 613f 0a20 2020  aiting data?.   
-000161d0: 2020 2020 2072 6574 7572 6e20 7265 636f       return reco
-000161e0: 6d6d 656e 6461 7469 6f6e 732c 2063 6c69  mmendations, cli
-000161f0: 656e 745f 6d73 6773 2c20 7b7d 0a0a 2020  ent_msgs, {}..  
-00016200: 2020 6465 6620 5f74 7261 6e73 6974 696f    def _transitio
-00016210: 6e5f 6572 7265 645f 7265 6c65 6173 6564  n_erred_released
-00016220: 2873 656c 662c 206b 6579 3a20 4b65 792c  (self, key: Key,
-00016230: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00016240: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
-00016250: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00016260: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-00016270: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00016280: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
-00016290: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
-000162a0: 7367 733a 204d 7367 7320 3d20 7b7d 0a20  sgs: Msgs = {}. 
-000162b0: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-000162c0: 6773 3a20 4d73 6773 203d 207b 7d0a 0a20  gs: Msgs = {}.. 
-000162d0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
-000162e0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
-000162f0: 2020 2020 2061 7373 6572 7420 7473 2e65       assert ts.e
-00016300: 7863 6570 7469 6f6e 5f62 6c61 6d65 0a20  xception_blame. 
-00016310: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00016320: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
-00016330: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00016340: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
-00016350: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
-00016360: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-00016370: 7761 6974 6572 730a 0a20 2020 2020 2020  waiters..       
-00016380: 2074 732e 6578 6365 7074 696f 6e20 3d20   ts.exception = 
-00016390: 4e6f 6e65 0a20 2020 2020 2020 2074 732e  None.        ts.
-000163a0: 6578 6365 7074 696f 6e5f 626c 616d 6520  exception_blame 
-000163b0: 3d20 4e6f 6e65 0a20 2020 2020 2020 2074  = None.        t
-000163c0: 732e 7472 6163 6562 6163 6b20 3d20 4e6f  s.traceback = No
-000163d0: 6e65 0a0a 2020 2020 2020 2020 666f 7220  ne..        for 
-000163e0: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-000163f0: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
-00016400: 2020 6966 2064 7473 2e73 7461 7465 203d    if dts.state =
-00016410: 3d20 2265 7272 6564 223a 0a20 2020 2020  = "erred":.     
-00016420: 2020 2020 2020 2020 2020 2023 2044 6f65             # Doe
-00016430: 7320 7468 6973 206d 616b 6520 7365 6e73  s this make sens
-00016440: 653f 0a20 2020 2020 2020 2020 2020 2020  e?.             
-00016450: 2020 2023 2054 6869 7320 676f 6573 2076     # This goes v
-00016460: 6961 2072 656c 6561 7365 640a 2020 2020  ia released.    
-00016470: 2020 2020 2020 2020 2020 2020 2320 6474              # dt
-00016480: 7320 2d3e 2072 656c 6561 7365 6420 2d3e  s -> released ->
-00016490: 2077 6169 7469 6e67 0a20 2020 2020 2020   waiting.       
-000164a0: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-000164b0: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
-000164c0: 5d20 3d20 2277 6169 7469 6e67 220a 0a20  ] = "waiting".. 
-000164d0: 2020 2020 2020 2077 5f6d 7367 203d 207b         w_msg = {
-000164e0: 0a20 2020 2020 2020 2020 2020 2022 6f70  .            "op
-000164f0: 223a 2022 6672 6565 2d6b 6579 7322 2c0a  ": "free-keys",.
-00016500: 2020 2020 2020 2020 2020 2020 226b 6579              "key
-00016510: 7322 3a20 5b6b 6579 5d2c 0a20 2020 2020  s": [key],.     
-00016520: 2020 2020 2020 2022 7374 696d 756c 7573         "stimulus
-00016530: 5f69 6422 3a20 7374 696d 756c 7573 5f69  _id": stimulus_i
-00016540: 642c 0a20 2020 2020 2020 207d 0a20 2020  d,.        }.   
-00016550: 2020 2020 2066 6f72 2077 735f 6164 6472       for ws_addr
-00016560: 2069 6e20 7473 2e65 7272 6564 5f6f 6e20   in ts.erred_on 
-00016570: 6f72 2028 293a 0a20 2020 2020 2020 2020  or ():.         
-00016580: 2020 2077 6f72 6b65 725f 6d73 6773 5b77     worker_msgs[w
-00016590: 735f 6164 6472 5d20 3d20 5b77 5f6d 7367  s_addr] = [w_msg
-000165a0: 5d0a 2020 2020 2020 2020 7473 2e65 7272  ].        ts.err
-000165b0: 6564 5f6f 6e20 3d20 4e6f 6e65 0a0a 2020  ed_on = None..  
-000165c0: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
-000165d0: 203d 207b 226f 7022 3a20 2274 6173 6b2d   = {"op": "task-
-000165e0: 7265 7472 6965 6422 2c20 226b 6579 223a  retried", "key":
-000165f0: 206b 6579 7d0a 2020 2020 2020 2020 666f   key}.        fo
-00016600: 7220 6373 2069 6e20 7473 2e77 686f 5f77  r cs in ts.who_w
-00016610: 616e 7473 206f 7220 2829 3a0a 2020 2020  ants or ():.    
-00016620: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
-00016630: 7367 735b 6373 2e63 6c69 656e 745f 6b65  sgs[cs.client_ke
-00016640: 795d 203d 205b 7265 706f 7274 5f6d 7367  y] = [report_msg
-00016650: 5d0a 0a20 2020 2020 2020 2074 732e 7374  ]..        ts.st
-00016660: 6174 6520 3d20 2272 656c 6561 7365 6422  ate = "released"
-00016670: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00016680: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-00016690: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
-000166a0: 6f72 6b65 725f 6d73 6773 0a0a 2020 2020  orker_msgs..    
-000166b0: 6465 6620 5f74 7261 6e73 6974 696f 6e5f  def _transition_
-000166c0: 7761 6974 696e 675f 7265 6c65 6173 6564  waiting_released
-000166d0: 2873 656c 662c 206b 6579 3a20 4b65 792c  (self, key: Key,
-000166e0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-000166f0: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
-00016700: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00016710: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-00016720: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00016730: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
-00016740: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00016750: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-00016760: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-00016770: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
-00016780: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00016790: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-000167a0: 675f 6f6e 0a0a 2020 2020 2020 2020 666f  g_on..        fo
-000167b0: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-000167c0: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-000167d0: 2020 2020 2020 6966 2074 7320 696e 2028        if ts in (
-000167e0: 6474 732e 7761 6974 6572 7320 6f72 2028  dts.waiters or (
-000167f0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00016800: 2020 2020 6966 2064 7473 2e77 6169 7465      if dts.waite
-00016810: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
-00016820: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
-00016830: 6572 732e 6469 7363 6172 6428 7473 290a  ers.discard(ts).
-00016840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016850: 6966 206e 6f74 2064 7473 2e77 6169 7465  if not dts.waite
-00016860: 7273 2061 6e64 206e 6f74 2064 7473 2e77  rs and not dts.w
-00016870: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
-00016880: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00016890: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
-000168a0: 732e 6b65 795d 203d 2022 7265 6c65 6173  s.key] = "releas
-000168b0: 6564 220a 2020 2020 2020 2020 7473 2e77  ed".        ts.w
-000168c0: 6169 7469 6e67 5f6f 6e20 3d20 4e6f 6e65  aiting_on = None
-000168d0: 0a0a 2020 2020 2020 2020 7473 2e73 7461  ..        ts.sta
-000168e0: 7465 203d 2022 7265 6c65 6173 6564 220a  te = "released".
-000168f0: 0a20 2020 2020 2020 2069 6620 7473 2e68  .        if ts.h
-00016900: 6173 5f6c 6f73 745f 6465 7065 6e64 656e  as_lost_dependen
-00016910: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-00016920: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00016930: 735b 6b65 795d 203d 2022 666f 7267 6f74  s[key] = "forgot
-00016940: 7465 6e22 0a20 2020 2020 2020 2065 6c69  ten".        eli
-00016950: 6620 6e6f 7420 7473 2e65 7863 6570 7469  f not ts.excepti
-00016960: 6f6e 5f62 6c61 6d65 2061 6e64 2028 7473  on_blame and (ts
-00016970: 2e77 686f 5f77 616e 7473 206f 7220 7473  .who_wants or ts
-00016980: 2e77 6169 7465 7273 293a 0a20 2020 2020  .waiters):.     
-00016990: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-000169a0: 6174 696f 6e73 5b6b 6579 5d20 3d20 2277  ations[key] = "w
-000169b0: 6169 7469 6e67 220a 2020 2020 2020 2020  aiting".        
-000169c0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000169d0: 2020 7473 2e77 6169 7465 7273 203d 204e    ts.waiters = N
-000169e0: 6f6e 650a 0a20 2020 2020 2020 2072 6574  one..        ret
-000169f0: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
-00016a00: 6f6e 732c 207b 7d2c 207b 7d0a 0a20 2020  ons, {}, {}..   
-00016a10: 2064 6566 205f 7472 616e 7369 7469 6f6e   def _transition
-00016a20: 5f70 726f 6365 7373 696e 675f 7265 6c65  _processing_rele
-00016a30: 6173 6564 2873 656c 662c 206b 6579 3a20  ased(self, key: 
-00016a40: 4b65 792c 2073 7469 6d75 6c75 735f 6964  Key, stimulus_id
-00016a50: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
-00016a60: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
-00016a70: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00016a80: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
-00016a90: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
-00016aa0: 207b 7d0a 2020 2020 2020 2020 776f 726b   {}.        work
-00016ab0: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
-00016ac0: 7b7d 0a0a 2020 2020 2020 2020 6966 2073  {}..        if s
-00016ad0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00016ae0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00016af0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
-00016b00: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
-00016b10: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
-00016b20: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
-00016b30: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
-00016b40: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
-00016b50: 2020 2020 2061 7373 6572 7420 7473 2e73       assert ts.s
-00016b60: 7461 7465 203d 3d20 2270 726f 6365 7373  tate == "process
-00016b70: 696e 6722 0a0a 2020 2020 2020 2020 7773  ing"..        ws
-00016b80: 203d 2073 656c 662e 5f65 7869 745f 7072   = self._exit_pr
-00016b90: 6f63 6573 7369 6e67 5f63 6f6d 6d6f 6e28  ocessing_common(
-00016ba0: 7473 290a 2020 2020 2020 2020 6966 2077  ts).        if w
-00016bb0: 733a 0a20 2020 2020 2020 2020 2020 2077  s:.            w
-00016bc0: 6f72 6b65 725f 6d73 6773 5b77 732e 6164  orker_msgs[ws.ad
-00016bd0: 6472 6573 735d 203d 205b 0a20 2020 2020  dress] = [.     
-00016be0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00015460: 2323 2323 0a20 2020 2020 2020 2023 2055  ####.        # U
+00015470: 7064 6174 6520 5374 6174 6520 496e 666f  pdate State Info
+00015480: 726d 6174 696f 6e20 230a 2020 2020 2020  rmation #.      
+00015490: 2020 2323 2323 2323 2323 2323 2323 2323    ##############
+000154a0: 2323 2323 2323 2323 2323 2323 2323 0a20  ##############. 
+000154b0: 2020 2020 2020 2069 6620 6e62 7974 6573         if nbytes
+000154c0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000154d0: 2020 2020 2020 2020 2020 7473 2e73 6574            ts.set
+000154e0: 5f6e 6279 7465 7328 6e62 7974 6573 290a  _nbytes(nbytes).
+000154f0: 0a20 2020 2020 2020 2073 656c 662e 5f65  .        self._e
+00015500: 7869 745f 7072 6f63 6573 7369 6e67 5f63  xit_processing_c
+00015510: 6f6d 6d6f 6e28 7473 290a 0a20 2020 2020  ommon(ts)..     
+00015520: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+00015530: 6e73 3a20 5265 6373 203d 207b 7d0a 2020  ns: Recs = {}.  
+00015540: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
+00015550: 733a 204d 7367 7320 3d20 7b7d 0a20 2020  s: Msgs = {}.   
+00015560: 2020 2020 2073 656c 662e 5f61 6464 5f74       self._add_t
+00015570: 6f5f 6d65 6d6f 7279 280a 2020 2020 2020  o_memory(.      
+00015580: 2020 2020 2020 7473 2c20 7773 2c20 7265        ts, ws, re
+00015590: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
+000155a0: 6c69 656e 745f 6d73 6773 2c20 7479 7065  lient_msgs, type
+000155b0: 3d74 7970 652c 2074 7970 656e 616d 653d  =type, typename=
+000155c0: 7479 7065 6e61 6d65 0a20 2020 2020 2020  typename.       
+000155d0: 2029 0a0a 2020 2020 2020 2020 6966 2073   )..        if s
+000155e0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+000155f0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00015600: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
+00015610: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
+00015620: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+00015630: 7761 6974 696e 675f 6f6e 0a0a 2020 2020  waiting_on..    
+00015640: 2020 2020 7265 7475 726e 2072 6563 6f6d      return recom
+00015650: 6d65 6e64 6174 696f 6e73 2c20 636c 6965  mendations, clie
+00015660: 6e74 5f6d 7367 732c 207b 7d0a 0a20 2020  nt_msgs, {}..   
+00015670: 2064 6566 205f 7472 616e 7369 7469 6f6e   def _transition
+00015680: 5f6d 656d 6f72 795f 7265 6c65 6173 6564  _memory_released
+00015690: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+000156a0: 6b65 793a 204b 6579 2c20 7374 696d 756c  key: Key, stimul
+000156b0: 7573 5f69 643a 2073 7472 2c20 2a2c 2073  us_id: str, *, s
+000156c0: 6166 653a 2062 6f6f 6c20 3d20 4661 6c73  afe: bool = Fals
+000156d0: 650a 2020 2020 2920 2d3e 2052 6563 734d  e.    ) -> RecsM
+000156e0: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+000156f0: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00015700: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
+00015710: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00015720: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00015730: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
+00015740: 6e0a 2020 2020 2020 2020 2020 2020 6173  n.            as
+00015750: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
+00015760: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
+00015770: 2020 2020 2020 6966 2073 6166 653a 0a20        if safe:. 
+00015780: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00015790: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+000157a0: 7465 7273 0a0a 2020 2020 2020 2020 6966  ters..        if
+000157b0: 2074 732e 6163 746f 723a 0a20 2020 2020   ts.actor:.     
+000157c0: 2020 2020 2020 2066 6f72 2077 7320 696e         for ws in
+000157d0: 2074 732e 7768 6f5f 6861 7320 6f72 2028   ts.who_has or (
+000157e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000157f0: 2020 2077 732e 6163 746f 7273 2e64 6973     ws.actors.dis
+00015800: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+00015810: 2020 2020 2069 6620 7473 2e77 686f 5f77       if ts.who_w
+00015820: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
+00015830: 2020 2020 2020 7473 2e65 7863 6570 7469        ts.excepti
+00015840: 6f6e 5f62 6c61 6d65 203d 2074 730a 2020  on_blame = ts.  
+00015850: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00015860: 2e65 7863 6570 7469 6f6e 203d 2053 6572  .exception = Ser
+00015870: 6961 6c69 7a65 6428 0a20 2020 2020 2020  ialized(.       
+00015880: 2020 2020 2020 2020 2020 2020 202a 7365               *se
+00015890: 7269 616c 697a 6528 5661 6c75 6545 7272  rialize(ValueErr
+000158a0: 6f72 2822 576f 726b 6572 2068 6f6c 6469  or("Worker holdi
+000158b0: 6e67 2041 6374 6f72 2077 6173 206c 6f73  ng Actor was los
+000158c0: 7422 2929 0a20 2020 2020 2020 2020 2020  t")).           
+000158d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000158e0: 2020 2020 2020 2072 6574 7572 6e20 7b74         return {t
+000158f0: 732e 6b65 793a 2022 6572 7265 6422 7d2c  s.key: "erred"},
+00015900: 207b 7d2c 207b 7d20 2023 2064 6f6e 2774   {}, {}  # don't
+00015910: 2074 7279 2074 6f20 7265 6372 6561 7465   try to recreate
+00015920: 0a0a 2020 2020 2020 2020 7265 636f 6d6d  ..        recomm
+00015930: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
+00015940: 3d20 7b7d 0a20 2020 2020 2020 2063 6c69  = {}.        cli
+00015950: 656e 745f 6d73 6773 3a20 4d73 6773 203d  ent_msgs: Msgs =
+00015960: 207b 7d0a 2020 2020 2020 2020 776f 726b   {}.        work
+00015970: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
+00015980: 7b7d 0a0a 2020 2020 2020 2020 2320 5858  {}..        # XX
+00015990: 5820 6661 6374 6f72 2074 6869 7320 6f75  X factor this ou
+000159a0: 743f 0a20 2020 2020 2020 2077 6f72 6b65  t?.        worke
+000159b0: 725f 6d73 6720 3d20 7b0a 2020 2020 2020  r_msg = {.      
+000159c0: 2020 2020 2020 226f 7022 3a20 2266 7265        "op": "fre
+000159d0: 652d 6b65 7973 222c 0a20 2020 2020 2020  e-keys",.       
+000159e0: 2020 2020 2022 6b65 7973 223a 205b 6b65       "keys": [ke
+000159f0: 795d 2c0a 2020 2020 2020 2020 2020 2020  y],.            
+00015a00: 2273 7469 6d75 6c75 735f 6964 223a 2073  "stimulus_id": s
+00015a10: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
+00015a20: 2020 2020 7d0a 2020 2020 2020 2020 666f      }.        fo
+00015a30: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
+00015a40: 6173 206f 7220 2829 3a0a 2020 2020 2020  as or ():.      
+00015a50: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+00015a60: 735b 7773 2e61 6464 7265 7373 5d20 3d20  s[ws.address] = 
+00015a70: 5b77 6f72 6b65 725f 6d73 675d 0a20 2020  [worker_msg].   
+00015a80: 2020 2020 2073 656c 662e 7265 6d6f 7665       self.remove
+00015a90: 5f61 6c6c 5f72 6570 6c69 6361 7328 7473  _all_replicas(ts
+00015aa0: 290a 0a20 2020 2020 2020 2074 732e 7374  )..        ts.st
+00015ab0: 6174 6520 3d20 2272 656c 6561 7365 6422  ate = "released"
+00015ac0: 0a0a 2020 2020 2020 2020 7265 706f 7274  ..        report
+00015ad0: 5f6d 7367 203d 207b 226f 7022 3a20 226c  _msg = {"op": "l
+00015ae0: 6f73 742d 6461 7461 222c 2022 6b65 7922  ost-data", "key"
+00015af0: 3a20 6b65 797d 0a20 2020 2020 2020 2066  : key}.        f
+00015b00: 6f72 2063 7320 696e 2074 732e 7768 6f5f  or cs in ts.who_
+00015b10: 7761 6e74 7320 6f72 2028 293a 0a20 2020  wants or ():.   
+00015b20: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
+00015b30: 6d73 6773 5b63 732e 636c 6965 6e74 5f6b  msgs[cs.client_k
+00015b40: 6579 5d20 3d20 5b72 6570 6f72 745f 6d73  ey] = [report_ms
+00015b50: 675d 0a0a 2020 2020 2020 2020 6966 206e  g]..        if n
+00015b60: 6f74 2074 732e 7275 6e5f 7370 6563 3a20  ot ts.run_spec: 
+00015b70: 2023 2070 7572 6520 6461 7461 0a20 2020   # pure data.   
+00015b80: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+00015b90: 6e64 6174 696f 6e73 5b6b 6579 5d20 3d20  ndations[key] = 
+00015ba0: 2266 6f72 676f 7474 656e 220a 2020 2020  "forgotten".    
+00015bb0: 2020 2020 656c 6966 2074 732e 6861 735f      elif ts.has_
+00015bc0: 6c6f 7374 5f64 6570 656e 6465 6e63 6965  lost_dependencie
+00015bd0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00015be0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b6b  ecommendations[k
+00015bf0: 6579 5d20 3d20 2266 6f72 676f 7474 656e  ey] = "forgotten
+00015c00: 220a 2020 2020 2020 2020 656c 6966 2028  ".        elif (
+00015c10: 7473 2e77 686f 5f77 616e 7473 206f 7220  ts.who_wants or 
+00015c20: 7473 2e77 6169 7465 7273 2920 616e 6420  ts.waiters) and 
+00015c30: 6e6f 7420 616e 7928 0a20 2020 2020 2020  not any(.       
+00015c40: 2020 2020 2064 7473 2e73 7461 7465 203d       dts.state =
+00015c50: 3d20 2265 7272 6564 2220 666f 7220 6474  = "erred" for dt
+00015c60: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00015c70: 6369 6573 0a20 2020 2020 2020 2029 3a0a  cies.        ):.
+00015c80: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00015c90: 6d6d 656e 6461 7469 6f6e 735b 6b65 795d  mmendations[key]
+00015ca0: 203d 2022 7761 6974 696e 6722 0a0a 2020   = "waiting"..  
+00015cb0: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
+00015cc0: 2074 732e 7761 6974 6572 7320 6f72 2028   ts.waiters or (
+00015cd0: 293a 0a20 2020 2020 2020 2020 2020 2069  ):.            i
+00015ce0: 6620 6474 732e 7374 6174 6520 696e 2028  f dts.state in (
+00015cf0: 226e 6f2d 776f 726b 6572 222c 2022 7072  "no-worker", "pr
+00015d00: 6f63 6573 7369 6e67 2229 3a0a 2020 2020  ocessing"):.    
+00015d10: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+00015d20: 6d6d 656e 6461 7469 6f6e 735b 6474 732e  mmendations[dts.
+00015d30: 6b65 795d 203d 2022 7761 6974 696e 6722  key] = "waiting"
+00015d40: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+00015d50: 6620 6474 732e 7374 6174 6520 3d3d 2022  f dts.state == "
+00015d60: 7761 6974 696e 6722 3a0a 2020 2020 2020  waiting":.      
+00015d70: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00015d80: 2064 7473 2e77 6169 7469 6e67 5f6f 6e3a   dts.waiting_on:
+00015d90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015da0: 2020 2020 2064 7473 2e77 6169 7469 6e67       dts.waiting
+00015db0: 5f6f 6e20 3d20 7365 7428 290a 2020 2020  _on = set().    
+00015dc0: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
+00015dd0: 7761 6974 696e 675f 6f6e 2e61 6464 2874  waiting_on.add(t
+00015de0: 7329 0a0a 2020 2020 2020 2020 6966 2073  s)..        if s
+00015df0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+00015e00: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00015e10: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+00015e20: 6f6e 0a0a 2020 2020 2020 2020 7265 7475  on..        retu
+00015e30: 726e 2072 6563 6f6d 6d65 6e64 6174 696f  rn recommendatio
+00015e40: 6e73 2c20 636c 6965 6e74 5f6d 7367 732c  ns, client_msgs,
+00015e50: 2077 6f72 6b65 725f 6d73 6773 0a0a 2020   worker_msgs..  
+00015e60: 2020 6465 6620 5f74 7261 6e73 6974 696f    def _transitio
+00015e70: 6e5f 7265 6c65 6173 6564 5f65 7272 6564  n_released_erred
+00015e80: 2873 656c 662c 206b 6579 3a20 4b65 792c  (self, key: Key,
+00015e90: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00015ea0: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
+00015eb0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+00015ec0: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
+00015ed0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00015ee0: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+00015ef0: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+00015f00: 7367 733a 204d 7367 7320 3d20 7b7d 0a0a  sgs: Msgs = {}..
+00015f10: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00015f20: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
+00015f30: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
+00015f40: 6578 6365 7074 696f 6e5f 626c 616d 650a  exception_blame.
+00015f50: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00015f60: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
+00015f70: 730a 2020 2020 2020 2020 2020 2020 6173  s.            as
+00015f80: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
+00015f90: 696e 675f 6f6e 0a0a 2020 2020 2020 2020  ing_on..        
+00015fa0: 6661 696c 696e 675f 7473 203d 2074 732e  failing_ts = ts.
+00015fb0: 6578 6365 7074 696f 6e5f 626c 616d 650a  exception_blame.
+00015fc0: 2020 2020 2020 2020 6173 7365 7274 2066          assert f
+00015fd0: 6169 6c69 6e67 5f74 730a 0a20 2020 2020  ailing_ts..     
+00015fe0: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+00015ff0: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
+00016000: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00016010: 6474 732e 7768 6f5f 6861 733a 0a20 2020  dts.who_has:.   
+00016020: 2020 2020 2020 2020 2020 2020 2064 7473               dts
+00016030: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
+00016040: 203d 2066 6169 6c69 6e67 5f74 730a 2020   = failing_ts.  
+00016050: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00016060: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
+00016070: 732e 6b65 795d 203d 2022 6572 7265 6422  s.key] = "erred"
+00016080: 0a0a 2020 2020 2020 2020 7265 706f 7274  ..        report
+00016090: 5f6d 7367 203d 207b 0a20 2020 2020 2020  _msg = {.       
+000160a0: 2020 2020 2022 6f70 223a 2022 7461 736b       "op": "task
+000160b0: 2d65 7272 6564 222c 0a20 2020 2020 2020  -erred",.       
+000160c0: 2020 2020 2022 6b65 7922 3a20 6b65 792c       "key": key,
+000160d0: 0a20 2020 2020 2020 2020 2020 2022 6578  .            "ex
+000160e0: 6365 7074 696f 6e22 3a20 6661 696c 696e  ception": failin
+000160f0: 675f 7473 2e65 7863 6570 7469 6f6e 2c0a  g_ts.exception,.
+00016100: 2020 2020 2020 2020 2020 2020 2274 7261              "tra
+00016110: 6365 6261 636b 223a 2066 6169 6c69 6e67  ceback": failing
+00016120: 5f74 732e 7472 6163 6562 6163 6b2c 0a20  _ts.traceback,. 
+00016130: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00016140: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
+00016150: 6f5f 7761 6e74 7320 6f72 2028 293a 0a20  o_wants or ():. 
+00016160: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+00016170: 745f 6d73 6773 5b63 732e 636c 6965 6e74  t_msgs[cs.client
+00016180: 5f6b 6579 5d20 3d20 5b72 6570 6f72 745f  _key] = [report_
+00016190: 6d73 675d 0a0a 2020 2020 2020 2020 7473  msg]..        ts
+000161a0: 2e73 7461 7465 203d 2022 6572 7265 6422  .state = "erred"
+000161b0: 0a0a 2020 2020 2020 2020 2320 544f 444f  ..        # TODO
+000161c0: 3a20 7761 6974 696e 6720 6461 7461 3f0a  : waiting data?.
+000161d0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+000161e0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
+000161f0: 636c 6965 6e74 5f6d 7367 732c 207b 7d0a  client_msgs, {}.
+00016200: 0a20 2020 2064 6566 205f 7472 616e 7369  .    def _transi
+00016210: 7469 6f6e 5f65 7272 6564 5f72 656c 6561  tion_erred_relea
+00016220: 7365 6428 7365 6c66 2c20 6b65 793a 204b  sed(self, key: K
+00016230: 6579 2c20 7374 696d 756c 7573 5f69 643a  ey, stimulus_id:
+00016240: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
+00016250: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
+00016260: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+00016270: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00016280: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
+00016290: 7b7d 0a20 2020 2020 2020 2063 6c69 656e  {}.        clien
+000162a0: 745f 6d73 6773 3a20 4d73 6773 203d 207b  t_msgs: Msgs = {
+000162b0: 7d0a 2020 2020 2020 2020 776f 726b 6572  }.        worker
+000162c0: 5f6d 7367 733a 204d 7367 7320 3d20 7b7d  _msgs: Msgs = {}
+000162d0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+000162e0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+000162f0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00016300: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
+00016310: 650a 2020 2020 2020 2020 2020 2020 6173  e.            as
+00016320: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+00016330: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+00016340: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+00016350: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+00016360: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00016370: 7473 2e77 6169 7465 7273 0a0a 2020 2020  ts.waiters..    
+00016380: 2020 2020 7473 2e65 7863 6570 7469 6f6e      ts.exception
+00016390: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+000163a0: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
+000163b0: 6d65 203d 204e 6f6e 650a 2020 2020 2020  me = None.      
+000163c0: 2020 7473 2e74 7261 6365 6261 636b 203d    ts.traceback =
+000163d0: 204e 6f6e 650a 0a20 2020 2020 2020 2066   None..        f
+000163e0: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+000163f0: 656e 6465 6e74 733a 0a20 2020 2020 2020  endents:.       
+00016400: 2020 2020 2069 6620 6474 732e 7374 6174       if dts.stat
+00016410: 6520 3d3d 2022 6572 7265 6422 3a0a 2020  e == "erred":.  
+00016420: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00016430: 446f 6573 2074 6869 7320 6d61 6b65 2073  Does this make s
+00016440: 656e 7365 3f0a 2020 2020 2020 2020 2020  ense?.          
+00016450: 2020 2020 2020 2320 5468 6973 2067 6f65        # This goe
+00016460: 7320 7669 6120 7265 6c65 6173 6564 0a20  s via released. 
+00016470: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00016480: 2064 7473 202d 3e20 7265 6c65 6173 6564   dts -> released
+00016490: 202d 3e20 7761 6974 696e 670a 2020 2020   -> waiting.    
+000164a0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+000164b0: 6d6d 656e 6461 7469 6f6e 735b 6474 732e  mmendations[dts.
+000164c0: 6b65 795d 203d 2022 7761 6974 696e 6722  key] = "waiting"
+000164d0: 0a0a 2020 2020 2020 2020 775f 6d73 6720  ..        w_msg 
+000164e0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+000164f0: 226f 7022 3a20 2266 7265 652d 6b65 7973  "op": "free-keys
+00016500: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+00016510: 6b65 7973 223a 205b 6b65 795d 2c0a 2020  keys": [key],.  
+00016520: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
+00016530: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
+00016540: 735f 6964 2c0a 2020 2020 2020 2020 7d0a  s_id,.        }.
+00016550: 2020 2020 2020 2020 666f 7220 7773 5f61          for ws_a
+00016560: 6464 7220 696e 2074 732e 6572 7265 645f  ddr in ts.erred_
+00016570: 6f6e 206f 7220 2829 3a0a 2020 2020 2020  on or ():.      
+00016580: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+00016590: 735b 7773 5f61 6464 725d 203d 205b 775f  s[ws_addr] = [w_
+000165a0: 6d73 675d 0a20 2020 2020 2020 2074 732e  msg].        ts.
+000165b0: 6572 7265 645f 6f6e 203d 204e 6f6e 650a  erred_on = None.
+000165c0: 0a20 2020 2020 2020 2072 6570 6f72 745f  .        report_
+000165d0: 6d73 6720 3d20 7b22 6f70 223a 2022 7461  msg = {"op": "ta
+000165e0: 736b 2d72 6574 7269 6564 222c 2022 6b65  sk-retried", "ke
+000165f0: 7922 3a20 6b65 797d 0a20 2020 2020 2020  y": key}.       
+00016600: 2066 6f72 2063 7320 696e 2074 732e 7768   for cs in ts.wh
+00016610: 6f5f 7761 6e74 7320 6f72 2028 293a 0a20  o_wants or ():. 
+00016620: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
+00016630: 745f 6d73 6773 5b63 732e 636c 6965 6e74  t_msgs[cs.client
+00016640: 5f6b 6579 5d20 3d20 5b72 6570 6f72 745f  _key] = [report_
+00016650: 6d73 675d 0a0a 2020 2020 2020 2020 7473  msg]..        ts
+00016660: 2e73 7461 7465 203d 2022 7265 6c65 6173  .state = "releas
+00016670: 6564 220a 0a20 2020 2020 2020 2072 6574  ed"..        ret
+00016680: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
+00016690: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
+000166a0: 2c20 776f 726b 6572 5f6d 7367 730a 0a20  , worker_msgs.. 
+000166b0: 2020 2064 6566 205f 7472 616e 7369 7469     def _transiti
+000166c0: 6f6e 5f77 6169 7469 6e67 5f72 656c 6561  on_waiting_relea
+000166d0: 7365 6428 7365 6c66 2c20 6b65 793a 204b  sed(self, key: K
+000166e0: 6579 2c20 7374 696d 756c 7573 5f69 643a  ey, stimulus_id:
+000166f0: 2073 7472 2920 2d3e 2052 6563 734d 7367   str) -> RecsMsg
+00016700: 733a 0a20 2020 2020 2020 2074 7320 3d20  s:.        ts = 
+00016710: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+00016720: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+00016730: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
+00016740: 7b7d 0a0a 2020 2020 2020 2020 6966 2073  {}..        if s
+00016750: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+00016760: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00016770: 206e 6f74 2074 732e 7768 6f5f 6861 730a   not ts.who_has.
+00016780: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00016790: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
+000167a0: 7369 6e67 5f6f 6e0a 0a20 2020 2020 2020  sing_on..       
+000167b0: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
+000167c0: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
+000167d0: 2020 2020 2020 2020 2069 6620 7473 2069           if ts i
+000167e0: 6e20 2864 7473 2e77 6169 7465 7273 206f  n (dts.waiters o
+000167f0: 7220 2829 293a 0a20 2020 2020 2020 2020  r ()):.         
+00016800: 2020 2020 2020 2069 6620 6474 732e 7761         if dts.wa
+00016810: 6974 6572 733a 0a20 2020 2020 2020 2020  iters:.         
+00016820: 2020 2020 2020 2020 2020 2064 7473 2e77             dts.w
+00016830: 6169 7465 7273 2e64 6973 6361 7264 2874  aiters.discard(t
+00016840: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00016850: 2020 2069 6620 6e6f 7420 6474 732e 7761     if not dts.wa
+00016860: 6974 6572 7320 616e 6420 6e6f 7420 6474  iters and not dt
+00016870: 732e 7768 6f5f 7761 6e74 733a 0a20 2020  s.who_wants:.   
+00016880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016890: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+000168a0: 5b64 7473 2e6b 6579 5d20 3d20 2272 656c  [dts.key] = "rel
+000168b0: 6561 7365 6422 0a20 2020 2020 2020 2074  eased".        t
+000168c0: 732e 7761 6974 696e 675f 6f6e 203d 204e  s.waiting_on = N
+000168d0: 6f6e 650a 0a20 2020 2020 2020 2074 732e  one..        ts.
+000168e0: 7374 6174 6520 3d20 2272 656c 6561 7365  state = "release
+000168f0: 6422 0a0a 2020 2020 2020 2020 6966 2074  d"..        if t
+00016900: 732e 6861 735f 6c6f 7374 5f64 6570 656e  s.has_lost_depen
+00016910: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+00016920: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00016930: 696f 6e73 5b6b 6579 5d20 3d20 2266 6f72  ions[key] = "for
+00016940: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
+00016950: 656c 6966 206e 6f74 2074 732e 6578 6365  elif not ts.exce
+00016960: 7074 696f 6e5f 626c 616d 6520 616e 6420  ption_blame and 
+00016970: 2874 732e 7768 6f5f 7761 6e74 7320 6f72  (ts.who_wants or
+00016980: 2074 732e 7761 6974 6572 7329 3a0a 2020   ts.waiters):.  
+00016990: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+000169a0: 656e 6461 7469 6f6e 735b 6b65 795d 203d  endations[key] =
+000169b0: 2022 7761 6974 696e 6722 0a20 2020 2020   "waiting".     
+000169c0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+000169d0: 2020 2020 2074 732e 7761 6974 6572 7320       ts.waiters 
+000169e0: 3d20 4e6f 6e65 0a0a 2020 2020 2020 2020  = None..        
+000169f0: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+00016a00: 6174 696f 6e73 2c20 7b7d 2c20 7b7d 0a0a  ations, {}, {}..
+00016a10: 2020 2020 6465 6620 5f74 7261 6e73 6974      def _transit
+00016a20: 696f 6e5f 7072 6f63 6573 7369 6e67 5f72  ion_processing_r
+00016a30: 656c 6561 7365 6428 7365 6c66 2c20 6b65  eleased(self, ke
+00016a40: 793a 204b 6579 2c20 7374 696d 756c 7573  y: Key, stimulus
+00016a50: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
+00016a60: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
+00016a70: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00016a80: 6579 5d0a 2020 2020 2020 2020 7265 636f  ey].        reco
+00016a90: 6d6d 656e 6461 7469 6f6e 733a 2052 6563  mmendations: Rec
+00016aa0: 7320 3d20 7b7d 0a20 2020 2020 2020 2077  s = {}.        w
+00016ab0: 6f72 6b65 725f 6d73 6773 3a20 4d73 6773  orker_msgs: Msgs
+00016ac0: 203d 207b 7d0a 0a20 2020 2020 2020 2069   = {}..        i
+00016ad0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00016ae0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00016af0: 6572 7420 7473 2e70 726f 6365 7373 696e  ert ts.processin
+00016b00: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
+00016b10: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00016b20: 686f 5f68 6173 0a20 2020 2020 2020 2020  ho_has.         
+00016b30: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00016b40: 2e77 6169 7469 6e67 5f6f 6e0a 2020 2020  .waiting_on.    
+00016b50: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00016b60: 732e 7374 6174 6520 3d3d 2022 7072 6f63  s.state == "proc
+00016b70: 6573 7369 6e67 220a 0a20 2020 2020 2020  essing"..       
+00016b80: 2077 7320 3d20 7365 6c66 2e5f 6578 6974   ws = self._exit
+00016b90: 5f70 726f 6365 7373 696e 675f 636f 6d6d  _processing_comm
+00016ba0: 6f6e 2874 7329 0a20 2020 2020 2020 2069  on(ts).        i
+00016bb0: 6620 7773 3a0a 2020 2020 2020 2020 2020  f ws:.          
+00016bc0: 2020 776f 726b 6572 5f6d 7367 735b 7773    worker_msgs[ws
+00016bd0: 2e61 6464 7265 7373 5d20 3d20 5b0a 2020  .address] = [.  
+00016be0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
 00016bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016c00: 2022 6f70 223a 2022 6672 6565 2d6b 6579   "op": "free-key
-00016c10: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00016c20: 2020 2020 2020 2020 226b 6579 7322 3a20          "keys": 
-00016c30: 5b6b 6579 5d2c 0a20 2020 2020 2020 2020  [key],.         
-00016c40: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
-00016c50: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
-00016c60: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
-00016c70: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00016c80: 2020 2020 205d 0a0a 2020 2020 2020 2020       ]..        
-00016c90: 7365 6c66 2e5f 7072 6f70 6167 6174 655f  self._propagate_
-00016ca0: 7265 6c65 6173 6564 2874 732c 2072 6563  released(ts, rec
-00016cb0: 6f6d 6d65 6e64 6174 696f 6e73 290a 2020  ommendations).  
-00016cc0: 2020 2020 2020 7265 7475 726e 2072 6563        return rec
-00016cd0: 6f6d 6d65 6e64 6174 696f 6e73 2c20 7b7d  ommendations, {}
-00016ce0: 2c20 776f 726b 6572 5f6d 7367 730a 0a20  , worker_msgs.. 
-00016cf0: 2020 2064 6566 205f 7472 616e 7369 7469     def _transiti
-00016d00: 6f6e 5f70 726f 6365 7373 696e 675f 6572  on_processing_er
-00016d10: 7265 6428 0a20 2020 2020 2020 2073 656c  red(.        sel
-00016d20: 662c 0a20 2020 2020 2020 206b 6579 3a20  f,.        key: 
-00016d30: 4b65 792c 0a20 2020 2020 2020 2073 7469  Key,.        sti
-00016d40: 6d75 6c75 735f 6964 3a20 7374 722c 0a20  mulus_id: str,. 
-00016d50: 2020 2020 2020 2077 6f72 6b65 723a 2073         worker: s
-00016d60: 7472 2c0a 2020 2020 2020 2020 2a2c 0a20  tr,.        *,. 
-00016d70: 2020 2020 2020 2063 6175 7365 3a20 4b65         cause: Ke
-00016d80: 7920 7c20 4e6f 6e65 203d 204e 6f6e 652c  y | None = None,
-00016d90: 0a20 2020 2020 2020 2065 7863 6570 7469  .        excepti
-00016da0: 6f6e 3a20 5365 7269 616c 697a 6564 207c  on: Serialized |
-00016db0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00016dc0: 2020 2020 2020 7472 6163 6562 6163 6b3a        traceback:
-00016dd0: 2053 6572 6961 6c69 7a65 6420 7c20 4e6f   Serialized | No
-00016de0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00016df0: 2020 2065 7863 6570 7469 6f6e 5f74 6578     exception_tex
-00016e00: 743a 2073 7472 207c 204e 6f6e 6520 3d20  t: str | None = 
-00016e10: 4e6f 6e65 2c0a 2020 2020 2020 2020 7472  None,.        tr
-00016e20: 6163 6562 6163 6b5f 7465 7874 3a20 7374  aceback_text: st
-00016e30: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
-00016e40: 0a20 2020 2020 2020 202a 2a6b 7761 7267  .        **kwarg
-00016e50: 733a 2041 6e79 2c0a 2020 2020 2920 2d3e  s: Any,.    ) ->
-00016e60: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
-00016e70: 2020 2022 2222 5072 6f63 6573 7365 6420     """Processed 
-00016e80: 6120 7265 636f 6d6d 656e 6465 6420 7472  a recommended tr
-00016e90: 616e 7369 7469 6f6e 2070 726f 6365 7373  ansition process
-00016ea0: 696e 6720 2d3e 2065 7272 6564 2e0a 0a20  ing -> erred... 
-00016eb0: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
-00016ec0: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-00016ed0: 2d2d 2d2d 0a20 2020 2020 2020 206b 6579  ----.        key
-00016ee0: 0a20 2020 2020 2020 2020 2020 4b65 7920  .           Key 
-00016ef0: 6f66 2074 6865 2074 6173 6b20 746f 2074  of the task to t
-00016f00: 7261 6e73 6974 696f 6e0a 2020 2020 2020  ransition.      
-00016f10: 2020 7374 696d 756c 7573 5f69 640a 2020    stimulus_id.  
-00016f20: 2020 2020 2020 2020 2020 4944 206f 6620            ID of 
-00016f30: 7468 6520 7374 696d 756c 7573 2063 6175  the stimulus cau
-00016f40: 7369 6e67 2074 6865 2074 7261 6e73 6974  sing the transit
-00016f50: 696f 6e0a 2020 2020 2020 2020 776f 726b  ion.        work
-00016f60: 6572 0a20 2020 2020 2020 2020 2020 2041  er.            A
-00016f70: 6464 7265 7373 206f 6620 7468 6520 776f  ddress of the wo
-00016f80: 726b 6572 2077 6865 7265 2074 6865 2074  rker where the t
-00016f90: 6173 6b20 6572 7265 642e 0a20 2020 2020  ask erred..     
-00016fa0: 2020 2020 2020 204e 6f74 206e 6563 6573         Not neces
-00016fb0: 7361 7269 6c79 2060 6074 732e 7072 6f63  sarily ``ts.proc
-00016fc0: 6573 7369 6e67 5f6f 6e60 602e 0a20 2020  essing_on``..   
-00016fd0: 2020 2020 2063 6175 7365 0a20 2020 2020       cause.     
-00016fe0: 2020 2020 2020 2041 6464 7265 7373 206f         Address o
-00016ff0: 6620 7468 6520 7461 736b 2074 6861 7420  f the task that 
-00017000: 6361 7573 6564 2074 6869 7320 7461 736b  caused this task
-00017010: 2074 6f20 6265 2074 7261 6e73 6974 696f   to be transitio
-00017020: 6e65 6420 746f 2065 7272 6564 0a20 2020  ned to erred.   
-00017030: 2020 2020 2065 7863 6570 7469 6f6e 0a20       exception. 
-00017040: 2020 2020 2020 2020 2020 2045 7863 6570             Excep
-00017050: 7469 6f6e 2063 6175 7365 6420 6279 2074  tion caused by t
-00017060: 6865 2074 6173 6b0a 2020 2020 2020 2020  he task.        
-00017070: 7472 6163 6562 6163 6b0a 2020 2020 2020  traceback.      
-00017080: 2020 2020 2020 5472 6163 6562 6163 6b20        Traceback 
-00017090: 6361 7573 6564 2062 7920 7468 6520 7461  caused by the ta
-000170a0: 736b 0a20 2020 2020 2020 2065 7863 6570  sk.        excep
-000170b0: 7469 6f6e 5f74 6578 740a 2020 2020 2020  tion_text.      
-000170c0: 2020 2020 2020 5374 7269 6e67 2072 6570        String rep
-000170d0: 7265 7365 6e74 6174 696f 6e20 6f66 2074  resentation of t
-000170e0: 6865 2065 7863 6570 7469 6f6e 0a20 2020  he exception.   
-000170f0: 2020 2020 2074 7261 6365 6261 636b 5f74       traceback_t
-00017100: 6578 740a 2020 2020 2020 2020 2020 2020  ext.            
-00017110: 5374 7269 6e67 2072 6570 7265 7365 6e74  String represent
-00017120: 6174 696f 6e20 6f66 2074 6865 2074 7261  ation of the tra
-00017130: 6365 6261 636b 0a0a 2020 2020 2020 2020  ceback..        
-00017140: 5265 7475 726e 730a 2020 2020 2020 2020  Returns.        
-00017150: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00017160: 5265 636f 6d6d 656e 6461 7469 6f6e 732c  Recommendations,
-00017170: 2063 6c69 656e 7420 6d65 7373 6167 6573   client messages
-00017180: 2061 6e64 2077 6f72 6b65 7220 6d65 7373   and worker mess
-00017190: 6167 6573 2074 6f20 7072 6f63 6573 730a  ages to process.
-000171a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000171b0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-000171c0: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
-000171d0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000171e0: 3a20 5265 6373 203d 207b 7d0a 2020 2020  : Recs = {}.    
-000171f0: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
-00017200: 204d 7367 7320 3d20 7b7d 0a0a 2020 2020   Msgs = {}..    
-00017210: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00017220: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00017230: 2020 6173 7365 7274 2063 6175 7365 206f    assert cause o
-00017240: 7220 7473 2e65 7863 6570 7469 6f6e 5f62  r ts.exception_b
-00017250: 6c61 6d65 0a20 2020 2020 2020 2020 2020  lame.           
-00017260: 2061 7373 6572 7420 7473 2e70 726f 6365   assert ts.proce
-00017270: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-00017280: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
-00017290: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-000172a0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-000172b0: 7420 7473 2e77 6169 7469 6e67 5f6f 6e0a  t ts.waiting_on.
-000172c0: 0a20 2020 2020 2020 2069 6620 7473 2e61  .        if ts.a
-000172d0: 6374 6f72 3a0a 2020 2020 2020 2020 2020  ctor:.          
-000172e0: 2020 7773 203d 2074 732e 7072 6f63 6573    ws = ts.proces
-000172f0: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-00017300: 2020 2020 6173 7365 7274 2077 730a 2020      assert ws.  
-00017310: 2020 2020 2020 2020 2020 7773 2e61 6374            ws.act
-00017320: 6f72 732e 7265 6d6f 7665 2874 7329 0a0a  ors.remove(ts)..
-00017330: 2020 2020 2020 2020 7365 6c66 2e5f 6578          self._ex
-00017340: 6974 5f70 726f 6365 7373 696e 675f 636f  it_processing_co
-00017350: 6d6d 6f6e 2874 7329 0a0a 2020 2020 2020  mmon(ts)..      
-00017360: 2020 6966 206e 6f74 2074 732e 6572 7265    if not ts.erre
-00017370: 645f 6f6e 3a0a 2020 2020 2020 2020 2020  d_on:.          
-00017380: 2020 7473 2e65 7272 6564 5f6f 6e20 3d20    ts.erred_on = 
-00017390: 7365 7428 290a 2020 2020 2020 2020 7473  set().        ts
-000173a0: 2e65 7272 6564 5f6f 6e2e 6164 6428 776f  .erred_on.add(wo
-000173b0: 726b 6572 290a 2020 2020 2020 2020 6966  rker).        if
-000173c0: 2065 7863 6570 7469 6f6e 2069 7320 6e6f   exception is no
-000173d0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-000173e0: 2020 2020 7473 2e65 7863 6570 7469 6f6e      ts.exception
-000173f0: 203d 2065 7863 6570 7469 6f6e 0a20 2020   = exception.   
-00017400: 2020 2020 2020 2020 2074 732e 6578 6365           ts.exce
-00017410: 7074 696f 6e5f 7465 7874 203d 2065 7863  ption_text = exc
-00017420: 6570 7469 6f6e 5f74 6578 740a 2020 2020  eption_text.    
-00017430: 2020 2020 6966 2074 7261 6365 6261 636b      if traceback
-00017440: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
-00017450: 2020 2020 2020 2020 2020 7473 2e74 7261            ts.tra
-00017460: 6365 6261 636b 203d 2074 7261 6365 6261  ceback = traceba
-00017470: 636b 0a20 2020 2020 2020 2020 2020 2074  ck.            t
-00017480: 732e 7472 6163 6562 6163 6b5f 7465 7874  s.traceback_text
-00017490: 203d 2074 7261 6365 6261 636b 5f74 6578   = traceback_tex
-000174a0: 740a 2020 2020 2020 2020 6966 2063 6175  t.        if cau
-000174b0: 7365 2069 7320 6e6f 7420 4e6f 6e65 3a0a  se is not None:.
-000174c0: 2020 2020 2020 2020 2020 2020 6661 696c              fail
-000174d0: 696e 675f 7473 203d 2073 656c 662e 7461  ing_ts = self.ta
-000174e0: 736b 735b 6361 7573 655d 0a20 2020 2020  sks[cause].     
-000174f0: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
-00017500: 696f 6e5f 626c 616d 6520 3d20 6661 696c  ion_blame = fail
-00017510: 696e 675f 7473 0a20 2020 2020 2020 2065  ing_ts.        e
-00017520: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00017530: 2066 6169 6c69 6e67 5f74 7320 3d20 7473   failing_ts = ts
-00017540: 2e65 7863 6570 7469 6f6e 5f62 6c61 6d65  .exception_blame
-00017550: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
-00017560: 0a0a 2020 2020 2020 2020 7365 6c66 2e65  ..        self.e
-00017570: 7272 6564 5f74 6173 6b73 2e61 7070 656e  rred_tasks.appen
-00017580: 646c 6566 7428 0a20 2020 2020 2020 2020  dleft(.         
-00017590: 2020 2045 7272 6564 5461 736b 280a 2020     ErredTask(.  
-000175a0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-000175b0: 2e6b 6579 2c0a 2020 2020 2020 2020 2020  .key,.          
-000175c0: 2020 2020 2020 7469 6d65 2829 2c0a 2020        time(),.  
-000175d0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-000175e0: 2e65 7272 6564 5f6f 6e2e 636f 7079 2829  .erred_on.copy()
-000175f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00017600: 2020 6578 6365 7074 696f 6e5f 7465 7874    exception_text
-00017610: 206f 7220 2222 2c0a 2020 2020 2020 2020   or "",.        
-00017620: 2020 2020 2020 2020 7472 6163 6562 6163          tracebac
-00017630: 6b5f 7465 7874 206f 7220 2222 2c0a 2020  k_text or "",.  
-00017640: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00017650: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
-00017660: 6f72 2064 7473 2069 6e20 7473 2e77 6169  or dts in ts.wai
-00017670: 7465 7273 206f 7220 7365 7428 293a 0a20  ters or set():. 
-00017680: 2020 2020 2020 2020 2020 2064 7473 2e65             dts.e
-00017690: 7863 6570 7469 6f6e 5f62 6c61 6d65 203d  xception_blame =
-000176a0: 2066 6169 6c69 6e67 5f74 730a 2020 2020   failing_ts.    
-000176b0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-000176c0: 6461 7469 6f6e 735b 6474 732e 6b65 795d  dations[dts.key]
-000176d0: 203d 2022 6572 7265 6422 0a0a 2020 2020   = "erred"..    
-000176e0: 2020 2020 666f 7220 6474 7320 696e 2074      for dts in t
-000176f0: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
-00017700: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-00017710: 7473 2e77 6169 7465 7273 3a0a 2020 2020  ts.waiters:.    
-00017720: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
-00017730: 7761 6974 6572 732e 6469 7363 6172 6428  waiters.discard(
-00017740: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-00017750: 6966 206e 6f74 2064 7473 2e77 6169 7465  if not dts.waite
-00017760: 7273 2061 6e64 206e 6f74 2064 7473 2e77  rs and not dts.w
-00017770: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
-00017780: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-00017790: 656e 6461 7469 6f6e 735b 6474 732e 6b65  endations[dts.ke
-000177a0: 795d 203d 2022 7265 6c65 6173 6564 220a  y] = "released".
-000177b0: 0a20 2020 2020 2020 2074 732e 7761 6974  .        ts.wait
-000177c0: 6572 7320 3d20 4e6f 6e65 0a0a 2020 2020  ers = None..    
-000177d0: 2020 2020 7473 2e73 7461 7465 203d 2022      ts.state = "
-000177e0: 6572 7265 6422 0a0a 2020 2020 2020 2020  erred"..        
-000177f0: 7265 706f 7274 5f6d 7367 203d 207b 0a20  report_msg = {. 
-00017800: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
-00017810: 2022 7461 736b 2d65 7272 6564 222c 0a20   "task-erred",. 
-00017820: 2020 2020 2020 2020 2020 2022 6b65 7922             "key"
-00017830: 3a20 6b65 792c 0a20 2020 2020 2020 2020  : key,.         
-00017840: 2020 2022 6578 6365 7074 696f 6e22 3a20     "exception": 
-00017850: 6661 696c 696e 675f 7473 2e65 7863 6570  failing_ts.excep
-00017860: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
-00017870: 2020 2274 7261 6365 6261 636b 223a 2066    "traceback": f
-00017880: 6169 6c69 6e67 5f74 732e 7472 6163 6562  ailing_ts.traceb
-00017890: 6163 6b2c 0a20 2020 2020 2020 207d 0a20  ack,.        }. 
-000178a0: 2020 2020 2020 2066 6f72 2063 7320 696e         for cs in
-000178b0: 2074 732e 7768 6f5f 7761 6e74 7320 6f72   ts.who_wants or
-000178c0: 2028 293a 0a20 2020 2020 2020 2020 2020   ():.           
-000178d0: 2063 6c69 656e 745f 6d73 6773 5b63 732e   client_msgs[cs.
-000178e0: 636c 6965 6e74 5f6b 6579 5d20 3d20 5b72  client_key] = [r
-000178f0: 6570 6f72 745f 6d73 675d 0a0a 2020 2020  eport_msg]..    
-00017900: 2020 2020 6373 203d 2073 656c 662e 636c      cs = self.cl
-00017910: 6965 6e74 735b 2266 6972 652d 616e 642d  ients["fire-and-
-00017920: 666f 7267 6574 225d 0a20 2020 2020 2020  forget"].       
-00017930: 2069 6620 7473 2069 6e20 6373 2e77 616e   if ts in cs.wan
-00017940: 7473 5f77 6861 743a 0a20 2020 2020 2020  ts_what:.       
-00017950: 2020 2020 2073 656c 662e 5f63 6c69 656e       self._clien
-00017960: 745f 7265 6c65 6173 6573 5f6b 6579 7328  t_releases_keys(
-00017970: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017980: 2063 733d 6373 2c0a 2020 2020 2020 2020   cs=cs,.        
-00017990: 2020 2020 2020 2020 6b65 7973 3d5b 6b65          keys=[ke
-000179a0: 795d 2c0a 2020 2020 2020 2020 2020 2020  y],.            
-000179b0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-000179c0: 6f6e 733d 7265 636f 6d6d 656e 6461 7469  ons=recommendati
-000179d0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-000179e0: 2029 0a0a 2020 2020 2020 2020 6966 2073   )..        if s
-000179f0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
-00017a00: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00017a10: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
-00017a20: 6e67 5f6f 6e0a 0a20 2020 2020 2020 2072  ng_on..        r
-00017a30: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
-00017a40: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
-00017a50: 6773 2c20 7b7d 0a0a 2020 2020 6465 6620  gs, {}..    def 
-00017a60: 5f74 7261 6e73 6974 696f 6e5f 6e6f 5f77  _transition_no_w
-00017a70: 6f72 6b65 725f 7265 6c65 6173 6564 2873  orker_released(s
-00017a80: 656c 662c 206b 6579 3a20 4b65 792c 2073  elf, key: Key, s
-00017a90: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
-00017aa0: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
-00017ab0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-00017ac0: 7461 736b 735b 6b65 795d 0a0a 2020 2020  tasks[key]..    
-00017ad0: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
-00017ae0: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
-00017af0: 2020 6173 7365 7274 2073 656c 662e 7461    assert self.ta
-00017b00: 736b 735b 6b65 795d 2e73 7461 7465 203d  sks[key].state =
-00017b10: 3d20 226e 6f2d 776f 726b 6572 220a 2020  = "no-worker".  
-00017b20: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00017b30: 206e 6f74 2074 732e 7768 6f5f 6861 730a   not ts.who_has.
-00017b40: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00017b50: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
-00017b60: 675f 6f6e 0a0a 2020 2020 2020 2020 7365  g_on..        se
-00017b70: 6c66 2e75 6e72 756e 6e61 626c 652e 7265  lf.unrunnable.re
-00017b80: 6d6f 7665 2874 7329 0a0a 2020 2020 2020  move(ts)..      
-00017b90: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00017ba0: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
-00017bb0: 2020 2020 2073 656c 662e 5f70 726f 7061       self._propa
-00017bc0: 6761 7465 5f72 656c 6561 7365 6428 7473  gate_released(ts
-00017bd0: 2c20 7265 636f 6d6d 656e 6461 7469 6f6e  , recommendation
-00017be0: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-00017bf0: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
-00017c00: 732c 207b 7d2c 207b 7d0a 0a20 2020 2064  s, {}, {}..    d
-00017c10: 6566 205f 7472 616e 7369 7469 6f6e 5f77  ef _transition_w
-00017c20: 6169 7469 6e67 5f71 7565 7565 6428 7365  aiting_queued(se
-00017c30: 6c66 2c20 6b65 793a 204b 6579 2c20 7374  lf, key: Key, st
-00017c40: 696d 756c 7573 5f69 643a 2073 7472 2920  imulus_id: str) 
-00017c50: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
-00017c60: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00017c70: 6173 6b73 5b6b 6579 5d0a 0a20 2020 2020  asks[key]..     
-00017c80: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-00017c90: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-00017ca0: 2061 7373 6572 7420 6e6f 7420 7365 6c66   assert not self
-00017cb0: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
-00017cc0: 2c20 2874 732c 2073 656c 662e 6964 6c65  , (ts, self.idle
-00017cd0: 5f74 6173 6b5f 636f 756e 7429 0a20 2020  _task_count).   
-00017ce0: 2020 2020 2020 2020 2073 656c 662e 5f76           self._v
-00017cf0: 616c 6964 6174 655f 7265 6164 7928 7473  alidate_ready(ts
-00017d00: 290a 0a20 2020 2020 2020 2074 732e 7374  )..        ts.st
-00017d10: 6174 6520 3d20 2271 7565 7565 6422 0a20  ate = "queued". 
-00017d20: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
-00017d30: 6564 2e61 6464 2874 7329 0a0a 2020 2020  ed.add(ts)..    
-00017d40: 2020 2020 7265 7475 726e 207b 7d2c 207b      return {}, {
-00017d50: 7d2c 207b 7d0a 0a20 2020 2064 6566 205f  }, {}..    def _
-00017d60: 7472 616e 7369 7469 6f6e 5f77 6169 7469  transition_waiti
-00017d70: 6e67 5f6e 6f5f 776f 726b 6572 2873 656c  ng_no_worker(sel
-00017d80: 662c 206b 6579 3a20 4b65 792c 2073 7469  f, key: Key, sti
-00017d90: 6d75 6c75 735f 6964 3a20 7374 7229 202d  mulus_id: str) -
-00017da0: 3e20 5265 6373 4d73 6773 3a0a 2020 2020  > RecsMsgs:.    
-00017db0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00017dc0: 736b 735b 6b65 795d 0a0a 2020 2020 2020  sks[key]..      
-00017dd0: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
-00017de0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
-00017df0: 7365 6c66 2e5f 7661 6c69 6461 7465 5f72  self._validate_r
-00017e00: 6561 6479 2874 7329 0a0a 2020 2020 2020  eady(ts)..      
-00017e10: 2020 7473 2e73 7461 7465 203d 2022 6e6f    ts.state = "no
-00017e20: 2d77 6f72 6b65 7222 0a20 2020 2020 2020  -worker".       
-00017e30: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
-00017e40: 2e61 6464 2874 7329 0a0a 2020 2020 2020  .add(ts)..      
-00017e50: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
-00017e60: 207b 7d0a 0a20 2020 2064 6566 205f 7472   {}..    def _tr
-00017e70: 616e 7369 7469 6f6e 5f71 7565 7565 645f  ansition_queued_
-00017e80: 7265 6c65 6173 6564 2873 656c 662c 206b  released(self, k
-00017e90: 6579 3a20 4b65 792c 2073 7469 6d75 6c75  ey: Key, stimulu
-00017ea0: 735f 6964 3a20 7374 7229 202d 3e20 5265  s_id: str) -> Re
-00017eb0: 6373 4d73 6773 3a0a 2020 2020 2020 2020  csMsgs:.        
-00017ec0: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
-00017ed0: 6b65 795d 0a0a 2020 2020 2020 2020 6966  key]..        if
-00017ee0: 2073 656c 662e 7661 6c69 6461 7465 3a0a   self.validate:.
-00017ef0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00017f00: 7274 2074 7320 696e 2073 656c 662e 7175  rt ts in self.qu
-00017f10: 6575 6564 0a20 2020 2020 2020 2020 2020  eued.           
-00017f20: 2061 7373 6572 7420 6e6f 7420 7473 2e70   assert not ts.p
-00017f30: 726f 6365 7373 696e 675f 6f6e 0a0a 2020  rocessing_on..  
-00017f40: 2020 2020 2020 7365 6c66 2e71 7565 7565        self.queue
-00017f50: 642e 7265 6d6f 7665 2874 7329 0a0a 2020  d.remove(ts)..  
-00017f60: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00017f70: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
-00017f80: 0a20 2020 2020 2020 2073 656c 662e 5f70  .        self._p
-00017f90: 726f 7061 6761 7465 5f72 656c 6561 7365  ropagate_release
-00017fa0: 6428 7473 2c20 7265 636f 6d6d 656e 6461  d(ts, recommenda
-00017fb0: 7469 6f6e 7329 0a20 2020 2020 2020 2072  tions).        r
-00017fc0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
-00017fd0: 7469 6f6e 732c 207b 7d2c 207b 7d0a 0a20  tions, {}, {}.. 
-00017fe0: 2020 2064 6566 205f 7472 616e 7369 7469     def _transiti
-00017ff0: 6f6e 5f71 7565 7565 645f 7072 6f63 6573  on_queued_proces
-00018000: 7369 6e67 2873 656c 662c 206b 6579 3a20  sing(self, key: 
-00018010: 4b65 792c 2073 7469 6d75 6c75 735f 6964  Key, stimulus_id
-00018020: 3a20 7374 7229 202d 3e20 5265 6373 4d73  : str) -> RecsMs
-00018030: 6773 3a0a 2020 2020 2020 2020 7473 203d  gs:.        ts =
-00018040: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-00018050: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00018060: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
-00018070: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00018080: 6f74 2074 732e 6163 746f 722c 2066 2241  ot ts.actor, f"A
-00018090: 6374 6f72 7320 6361 6e27 7420 6265 2071  ctors can't be q
-000180a0: 7565 7565 643a 207b 7473 7d22 0a20 2020  ueued: {ts}".   
-000180b0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000180c0: 7473 2069 6e20 7365 6c66 2e71 7565 7565  ts in self.queue
-000180d0: 640a 0a20 2020 2020 2020 2069 6620 7773  d..        if ws
-000180e0: 203a 3d20 7365 6c66 2e64 6563 6964 655f   := self.decide_
-000180f0: 776f 726b 6572 5f72 6f6f 7469 7368 5f71  worker_rootish_q
-00018100: 7565 7569 6e67 5f65 6e61 626c 6564 2829  ueuing_enabled()
-00018110: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00018120: 6c66 2e71 7565 7565 642e 6469 7363 6172  lf.queued.discar
-00018130: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
-00018140: 2020 7265 7475 726e 2073 656c 662e 5f61    return self._a
-00018150: 6464 5f74 6f5f 7072 6f63 6573 7369 6e67  dd_to_processing
-00018160: 2874 732c 2077 732c 2073 7469 6d75 6c75  (ts, ws, stimulu
-00018170: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
-00018180: 290a 2020 2020 2020 2020 2320 4966 206e  ).        # If n
-00018190: 6f20 776f 726b 6572 2c20 7461 736b 206a  o worker, task j
-000181a0: 7573 7420 7374 6179 7320 6071 7565 7565  ust stays `queue
-000181b0: 6460 0a20 2020 2020 2020 2072 6574 7572  d`.        retur
-000181c0: 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a0a 2020  n {}, {}, {}..  
-000181d0: 2020 6465 6620 5f72 656d 6f76 655f 6b65    def _remove_ke
-000181e0: 7928 7365 6c66 2c20 6b65 793a 204b 6579  y(self, key: Key
-000181f0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00018200: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-00018210: 6b73 2e70 6f70 286b 6579 290a 2020 2020  ks.pop(key).    
-00018220: 2020 2020 6173 7365 7274 2074 732e 7374      assert ts.st
-00018230: 6174 6520 3d3d 2022 666f 7267 6f74 7465  ate == "forgotte
-00018240: 6e22 0a20 2020 2020 2020 2073 656c 662e  n".        self.
-00018250: 756e 7275 6e6e 6162 6c65 2e64 6973 6361  unrunnable.disca
-00018260: 7264 2874 7329 0a20 2020 2020 2020 2066  rd(ts).        f
-00018270: 6f72 2063 7320 696e 2074 732e 7768 6f5f  or cs in ts.who_
-00018280: 7761 6e74 7320 6f72 2028 293a 0a20 2020  wants or ():.   
-00018290: 2020 2020 2020 2020 2063 732e 7761 6e74           cs.want
-000182a0: 735f 7768 6174 2e72 656d 6f76 6528 7473  s_what.remove(ts
-000182b0: 290a 2020 2020 2020 2020 7473 2e77 686f  ).        ts.who
-000182c0: 5f77 616e 7473 203d 204e 6f6e 650a 2020  _wants = None.  
-000182d0: 2020 2020 2020 7473 2e70 726f 6365 7373        ts.process
-000182e0: 696e 675f 6f6e 203d 204e 6f6e 650a 2020  ing_on = None.  
-000182f0: 2020 2020 2020 7473 2e65 7863 6570 7469        ts.excepti
-00018300: 6f6e 5f62 6c61 6d65 203d 2074 732e 6578  on_blame = ts.ex
-00018310: 6365 7074 696f 6e20 3d20 7473 2e74 7261  ception = ts.tra
-00018320: 6365 6261 636b 203d 204e 6f6e 650a 2020  ceback = None.  
-00018330: 2020 2020 2020 7365 6c66 2e74 6173 6b5f        self.task_
-00018340: 6d65 7461 6461 7461 2e70 6f70 286b 6579  metadata.pop(key
-00018350: 2c20 4e6f 6e65 290a 0a20 2020 2064 6566  , None)..    def
-00018360: 205f 7472 616e 7369 7469 6f6e 5f6d 656d   _transition_mem
-00018370: 6f72 795f 666f 7267 6f74 7465 6e28 7365  ory_forgotten(se
-00018380: 6c66 2c20 6b65 793a 204b 6579 2c20 7374  lf, key: Key, st
-00018390: 696d 756c 7573 5f69 643a 2073 7472 2920  imulus_id: str) 
-000183a0: 2d3e 2052 6563 734d 7367 733a 0a20 2020  -> RecsMsgs:.   
-000183b0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-000183c0: 6173 6b73 5b6b 6579 5d0a 0a20 2020 2020  asks[key]..     
-000183d0: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-000183e0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-000183f0: 2061 7373 6572 7420 7473 2e73 7461 7465   assert ts.state
-00018400: 203d 3d20 226d 656d 6f72 7922 0a20 2020   == "memory".   
-00018410: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00018420: 6e6f 7420 7473 2e70 726f 6365 7373 696e  not ts.processin
-00018430: 675f 6f6e 0a20 2020 2020 2020 2020 2020  g_on.           
-00018440: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
-00018450: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
-00018460: 2020 2020 2020 6966 206e 6f74 2074 732e        if not ts.
-00018470: 7275 6e5f 7370 6563 3a0a 2020 2020 2020  run_spec:.      
-00018480: 2020 2020 2020 2020 2020 2320 4974 2773            # It's
-00018490: 206f 6b20 746f 2066 6f72 6765 7420 6120   ok to forget a 
-000184a0: 7075 7265 2064 6174 6120 7461 736b 0a20  pure data task. 
-000184b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000184c0: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
-000184d0: 656c 6966 2074 732e 6861 735f 6c6f 7374  elif ts.has_lost
-000184e0: 5f64 6570 656e 6465 6e63 6965 733a 0a20  _dependencies:. 
-000184f0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00018500: 2049 7427 7320 6f6b 2074 6f20 666f 7267   It's ok to forg
-00018510: 6574 2061 2074 6173 6b20 7769 7468 2066  et a task with f
-00018520: 6f72 676f 7474 656e 2064 6570 656e 6465  orgotten depende
-00018530: 6e63 6965 730a 2020 2020 2020 2020 2020  ncies.          
-00018540: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-00018550: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
-00018560: 7473 2e77 686f 5f77 616e 7473 2061 6e64  ts.who_wants and
-00018570: 206e 6f74 2074 732e 7761 6974 6572 7320   not ts.waiters 
-00018580: 616e 6420 6e6f 7420 7473 2e64 6570 656e  and not ts.depen
-00018590: 6465 6e74 733a 0a20 2020 2020 2020 2020  dents:.         
-000185a0: 2020 2020 2020 2023 2049 7427 7320 6f6b         # It's ok
-000185b0: 2074 6f20 666f 7267 6574 2061 2074 6173   to forget a tas
-000185c0: 6b20 7468 6174 206e 6f62 6f64 7920 6e65  k that nobody ne
-000185d0: 6564 730a 2020 2020 2020 2020 2020 2020  eds.            
-000185e0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-000185f0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00018600: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00018610: 2041 7373 6572 7469 6f6e 4572 726f 7228   AssertionError(
-00018620: 2255 6e72 6561 6368 6162 6c65 222c 2073  "Unreachable", s
-00018630: 7472 2874 7329 2920 2023 2070 7261 676d  tr(ts))  # pragm
-00018640: 613a 206e 6f63 6f76 6572 0a0a 2020 2020  a: nocover..    
-00018650: 2020 2020 6966 2074 732e 6163 746f 723a      if ts.actor:
-00018660: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00018670: 2077 7320 696e 2074 732e 7768 6f5f 6861   ws in ts.who_ha
-00018680: 7320 6f72 2028 293a 0a20 2020 2020 2020  s or ():.       
-00018690: 2020 2020 2020 2020 2077 732e 6163 746f           ws.acto
-000186a0: 7273 2e64 6973 6361 7264 2874 7329 0a0a  rs.discard(ts)..
-000186b0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-000186c0: 6461 7469 6f6e 733a 2052 6563 7320 3d20  dations: Recs = 
-000186d0: 7b7d 0a20 2020 2020 2020 2077 6f72 6b65  {}.        worke
-000186e0: 725f 6d73 6773 3a20 4d73 6773 203d 207b  r_msgs: Msgs = {
-000186f0: 7d0a 2020 2020 2020 2020 7365 6c66 2e5f  }.        self._
-00018700: 7072 6f70 6167 6174 655f 666f 7267 6f74  propagate_forgot
-00018710: 7465 6e28 7473 2c20 7265 636f 6d6d 656e  ten(ts, recommen
-00018720: 6461 7469 6f6e 732c 2077 6f72 6b65 725f  dations, worker_
-00018730: 6d73 6773 2c20 7374 696d 756c 7573 5f69  msgs, stimulus_i
-00018740: 6429 0a0a 2020 2020 2020 2020 636c 6965  d)..        clie
-00018750: 6e74 5f6d 7367 7320 3d20 5f74 6173 6b5f  nt_msgs = _task_
-00018760: 746f 5f63 6c69 656e 745f 6d73 6773 2874  to_client_msgs(t
-00018770: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
-00018780: 5f72 656d 6f76 655f 6b65 7928 6b65 7929  _remove_key(key)
-00018790: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-000187a0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-000187b0: 2c20 636c 6965 6e74 5f6d 7367 732c 2077  , client_msgs, w
-000187c0: 6f72 6b65 725f 6d73 6773 0a0a 2020 2020  orker_msgs..    
-000187d0: 6465 6620 5f74 7261 6e73 6974 696f 6e5f  def _transition_
-000187e0: 7265 6c65 6173 6564 5f66 6f72 676f 7474  released_forgott
-000187f0: 656e 2873 656c 662c 206b 6579 3a20 4b65  en(self, key: Ke
-00018800: 792c 2073 7469 6d75 6c75 735f 6964 3a20  y, stimulus_id: 
-00018810: 7374 7229 202d 3e20 5265 6373 4d73 6773  str) -> RecsMsgs
-00018820: 3a0a 2020 2020 2020 2020 7473 203d 2073  :.        ts = s
-00018830: 656c 662e 7461 736b 735b 6b65 795d 0a0a  elf.tasks[key]..
-00018840: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00018850: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-00018860: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00018870: 7374 6174 6520 696e 2028 2272 656c 6561  state in ("relea
-00018880: 7365 6422 2c20 2265 7272 6564 2229 0a20  sed", "erred"). 
-00018890: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-000188a0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
-000188b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000188c0: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
-000188d0: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
-000188e0: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
-000188f0: 6f74 2069 6e20 7365 6c66 2e71 7565 7565  ot in self.queue
-00018900: 640a 2020 2020 2020 2020 2020 2020 6173  d.            as
-00018910: 7365 7274 206e 6f74 2074 732e 7761 6974  sert not ts.wait
-00018920: 696e 675f 6f6e 2c20 2874 732c 2074 732e  ing_on, (ts, ts.
-00018930: 7761 6974 696e 675f 6f6e 290a 2020 2020  waiting_on).    
-00018940: 2020 2020 2020 2020 6966 206e 6f74 2074          if not t
-00018950: 732e 7275 6e5f 7370 6563 3a0a 2020 2020  s.run_spec:.    
-00018960: 2020 2020 2020 2020 2020 2020 2320 4974              # It
-00018970: 2773 206f 6b20 746f 2066 6f72 6765 7420  's ok to forget 
-00018980: 6120 7075 7265 2064 6174 6120 7461 736b  a pure data task
-00018990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000189a0: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
-000189b0: 2020 656c 6966 2074 732e 6861 735f 6c6f    elif ts.has_lo
-000189c0: 7374 5f64 6570 656e 6465 6e63 6965 733a  st_dependencies:
-000189d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000189e0: 2023 2049 7427 7320 6f6b 2074 6f20 666f   # It's ok to fo
-000189f0: 7267 6574 2061 2074 6173 6b20 7769 7468  rget a task with
-00018a00: 2066 6f72 676f 7474 656e 2064 6570 656e   forgotten depen
-00018a10: 6465 6e63 6965 730a 2020 2020 2020 2020  dencies.        
-00018a20: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-00018a30: 2020 2020 2020 2020 2065 6c69 6620 6e6f           elif no
-00018a40: 7420 7473 2e77 686f 5f77 616e 7473 2061  t ts.who_wants a
-00018a50: 6e64 206e 6f74 2074 732e 7761 6974 6572  nd not ts.waiter
-00018a60: 7320 616e 6420 6e6f 7420 7473 2e64 6570  s and not ts.dep
-00018a70: 656e 6465 6e74 733a 0a20 2020 2020 2020  endents:.       
-00018a80: 2020 2020 2020 2020 2023 2049 7427 7320           # It's 
-00018a90: 6f6b 2074 6f20 666f 7267 6574 2061 2074  ok to forget a t
-00018aa0: 6173 6b20 7468 6174 206e 6f62 6f64 7920  ask that nobody 
-00018ab0: 6e65 6564 730a 2020 2020 2020 2020 2020  needs.          
-00018ac0: 2020 2020 2020 7061 7373 0a20 2020 2020        pass.     
-00018ad0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00018ae0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00018af0: 7365 2041 7373 6572 7469 6f6e 4572 726f  se AssertionErro
-00018b00: 7228 2255 6e72 6561 6368 6162 6c65 222c  r("Unreachable",
-00018b10: 2073 7472 2874 7329 2920 2023 2070 7261   str(ts))  # pra
-00018b20: 676d 613a 206e 6f63 6f76 6572 0a0a 2020  gma: nocover..  
-00018b30: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-00018b40: 7469 6f6e 733a 2052 6563 7320 3d20 7b7d  tions: Recs = {}
-00018b50: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00018b60: 6d73 6773 3a20 4d73 6773 203d 207b 7d0a  msgs: Msgs = {}.
-00018b70: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
-00018b80: 6f70 6167 6174 655f 666f 7267 6f74 7465  opagate_forgotte
-00018b90: 6e28 7473 2c20 7265 636f 6d6d 656e 6461  n(ts, recommenda
-00018ba0: 7469 6f6e 732c 2077 6f72 6b65 725f 6d73  tions, worker_ms
-00018bb0: 6773 2c20 7374 696d 756c 7573 5f69 6429  gs, stimulus_id)
-00018bc0: 0a0a 2020 2020 2020 2020 636c 6965 6e74  ..        client
-00018bd0: 5f6d 7367 7320 3d20 5f74 6173 6b5f 746f  _msgs = _task_to
-00018be0: 5f63 6c69 656e 745f 6d73 6773 2874 7329  _client_msgs(ts)
-00018bf0: 0a20 2020 2020 2020 2073 656c 662e 5f72  .        self._r
-00018c00: 656d 6f76 655f 6b65 7928 6b65 7929 0a0a  emove_key(key)..
-00018c10: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00018c20: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-00018c30: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-00018c40: 6b65 725f 6d73 6773 0a0a 2020 2020 2320  ker_msgs..    # 
-00018c50: 7b0a 2020 2020 2320 2020 2020 2873 7461  {.    #     (sta
-00018c60: 7274 2c20 6669 6e69 7368 293a 0a20 2020  rt, finish):.   
-00018c70: 2023 2020 2020 2074 7261 6e73 6974 696f   #     transitio
-00018c80: 6e5f 3c73 7461 7274 3e5f 3c66 696e 6973  n_<start>_<finis
-00018c90: 683e 280a 2020 2020 2320 2020 2020 2020  h>(.    #       
-00018ca0: 2020 7365 6c66 2c20 6b65 793a 204b 6579    self, key: Key
-00018cb0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-00018cc0: 7472 2c20 2a2a 6b77 6172 6773 0a20 2020  tr, **kwargs.   
-00018cd0: 2023 2020 2020 2029 202d 3e20 2872 6563   #     ) -> (rec
-00018ce0: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
-00018cf0: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
-00018d00: 725f 6d73 6773 290a 2020 2020 2320 7d0a  r_msgs).    # }.
-00018d10: 2020 2020 5f54 5241 4e53 4954 494f 4e53      _TRANSITIONS
-00018d20: 5f54 4142 4c45 3a20 436c 6173 7356 6172  _TABLE: ClassVar
-00018d30: 5b0a 2020 2020 2020 2020 4d61 7070 696e  [.        Mappin
-00018d40: 675b 0a20 2020 2020 2020 2020 2020 2074  g[.            t
-00018d50: 7570 6c65 5b54 6173 6b53 7461 7465 5374  uple[TaskStateSt
-00018d60: 6174 652c 2054 6173 6b53 7461 7465 5374  ate, TaskStateSt
-00018d70: 6174 655d 2c0a 2020 2020 2020 2020 2020  ate],.          
-00018d80: 2020 4361 6c6c 6162 6c65 5b2e 2e2e 2c20    Callable[..., 
-00018d90: 5265 6373 4d73 6773 5d2c 0a20 2020 2020  RecsMsgs],.     
-00018da0: 2020 205d 0a20 2020 205d 203d 207b 0a20     ].    ] = {. 
-00018db0: 2020 2020 2020 2028 2272 656c 6561 7365         ("release
-00018dc0: 6422 2c20 2277 6169 7469 6e67 2229 3a20  d", "waiting"): 
-00018dd0: 5f74 7261 6e73 6974 696f 6e5f 7265 6c65  _transition_rele
-00018de0: 6173 6564 5f77 6169 7469 6e67 2c0a 2020  ased_waiting,.  
-00018df0: 2020 2020 2020 2822 7761 6974 696e 6722        ("waiting"
-00018e00: 2c20 2272 656c 6561 7365 6422 293a 205f  , "released"): _
-00018e10: 7472 616e 7369 7469 6f6e 5f77 6169 7469  transition_waiti
-00018e20: 6e67 5f72 656c 6561 7365 642c 0a20 2020  ng_released,.   
-00018e30: 2020 2020 2028 2277 6169 7469 6e67 222c       ("waiting",
-00018e40: 2022 7072 6f63 6573 7369 6e67 2229 3a20   "processing"): 
-00018e50: 5f74 7261 6e73 6974 696f 6e5f 7761 6974  _transition_wait
-00018e60: 696e 675f 7072 6f63 6573 7369 6e67 2c0a  ing_processing,.
-00018e70: 2020 2020 2020 2020 2822 7761 6974 696e          ("waitin
-00018e80: 6722 2c20 226e 6f2d 776f 726b 6572 2229  g", "no-worker")
-00018e90: 3a20 5f74 7261 6e73 6974 696f 6e5f 7761  : _transition_wa
-00018ea0: 6974 696e 675f 6e6f 5f77 6f72 6b65 722c  iting_no_worker,
-00018eb0: 0a20 2020 2020 2020 2028 2277 6169 7469  .        ("waiti
-00018ec0: 6e67 222c 2022 7175 6575 6564 2229 3a20  ng", "queued"): 
-00018ed0: 5f74 7261 6e73 6974 696f 6e5f 7761 6974  _transition_wait
-00018ee0: 696e 675f 7175 6575 6564 2c0a 2020 2020  ing_queued,.    
-00018ef0: 2020 2020 2822 7761 6974 696e 6722 2c20      ("waiting", 
-00018f00: 226d 656d 6f72 7922 293a 205f 7472 616e  "memory"): _tran
-00018f10: 7369 7469 6f6e 5f77 6169 7469 6e67 5f6d  sition_waiting_m
-00018f20: 656d 6f72 792c 0a20 2020 2020 2020 2028  emory,.        (
-00018f30: 2271 7565 7565 6422 2c20 2272 656c 6561  "queued", "relea
-00018f40: 7365 6422 293a 205f 7472 616e 7369 7469  sed"): _transiti
-00018f50: 6f6e 5f71 7565 7565 645f 7265 6c65 6173  on_queued_releas
-00018f60: 6564 2c0a 2020 2020 2020 2020 2822 7175  ed,.        ("qu
-00018f70: 6575 6564 222c 2022 7072 6f63 6573 7369  eued", "processi
-00018f80: 6e67 2229 3a20 5f74 7261 6e73 6974 696f  ng"): _transitio
-00018f90: 6e5f 7175 6575 6564 5f70 726f 6365 7373  n_queued_process
-00018fa0: 696e 672c 0a20 2020 2020 2020 2028 2270  ing,.        ("p
-00018fb0: 726f 6365 7373 696e 6722 2c20 2272 656c  rocessing", "rel
-00018fc0: 6561 7365 6422 293a 205f 7472 616e 7369  eased"): _transi
-00018fd0: 7469 6f6e 5f70 726f 6365 7373 696e 675f  tion_processing_
-00018fe0: 7265 6c65 6173 6564 2c0a 2020 2020 2020  released,.      
-00018ff0: 2020 2822 7072 6f63 6573 7369 6e67 222c    ("processing",
-00019000: 2022 6d65 6d6f 7279 2229 3a20 5f74 7261   "memory"): _tra
-00019010: 6e73 6974 696f 6e5f 7072 6f63 6573 7369  nsition_processi
-00019020: 6e67 5f6d 656d 6f72 792c 0a20 2020 2020  ng_memory,.     
-00019030: 2020 2028 2270 726f 6365 7373 696e 6722     ("processing"
-00019040: 2c20 2265 7272 6564 2229 3a20 5f74 7261  , "erred"): _tra
-00019050: 6e73 6974 696f 6e5f 7072 6f63 6573 7369  nsition_processi
-00019060: 6e67 5f65 7272 6564 2c0a 2020 2020 2020  ng_erred,.      
-00019070: 2020 2822 6e6f 2d77 6f72 6b65 7222 2c20    ("no-worker", 
-00019080: 2272 656c 6561 7365 6422 293a 205f 7472  "released"): _tr
-00019090: 616e 7369 7469 6f6e 5f6e 6f5f 776f 726b  ansition_no_work
-000190a0: 6572 5f72 656c 6561 7365 642c 0a20 2020  er_released,.   
-000190b0: 2020 2020 2028 226e 6f2d 776f 726b 6572       ("no-worker
-000190c0: 222c 2022 7072 6f63 6573 7369 6e67 2229  ", "processing")
-000190d0: 3a20 5f74 7261 6e73 6974 696f 6e5f 6e6f  : _transition_no
-000190e0: 5f77 6f72 6b65 725f 7072 6f63 6573 7369  _worker_processi
-000190f0: 6e67 2c0a 2020 2020 2020 2020 2822 7265  ng,.        ("re
-00019100: 6c65 6173 6564 222c 2022 666f 7267 6f74  leased", "forgot
-00019110: 7465 6e22 293a 205f 7472 616e 7369 7469  ten"): _transiti
-00019120: 6f6e 5f72 656c 6561 7365 645f 666f 7267  on_released_forg
-00019130: 6f74 7465 6e2c 0a20 2020 2020 2020 2028  otten,.        (
-00019140: 226d 656d 6f72 7922 2c20 2266 6f72 676f  "memory", "forgo
-00019150: 7474 656e 2229 3a20 5f74 7261 6e73 6974  tten"): _transit
-00019160: 696f 6e5f 6d65 6d6f 7279 5f66 6f72 676f  ion_memory_forgo
-00019170: 7474 656e 2c0a 2020 2020 2020 2020 2822  tten,.        ("
-00019180: 6572 7265 6422 2c20 2272 656c 6561 7365  erred", "release
-00019190: 6422 293a 205f 7472 616e 7369 7469 6f6e  d"): _transition
-000191a0: 5f65 7272 6564 5f72 656c 6561 7365 642c  _erred_released,
-000191b0: 0a20 2020 2020 2020 2028 226d 656d 6f72  .        ("memor
-000191c0: 7922 2c20 2272 656c 6561 7365 6422 293a  y", "released"):
-000191d0: 205f 7472 616e 7369 7469 6f6e 5f6d 656d   _transition_mem
-000191e0: 6f72 795f 7265 6c65 6173 6564 2c0a 2020  ory_released,.  
-000191f0: 2020 2020 2020 2822 7265 6c65 6173 6564        ("released
-00019200: 222c 2022 6572 7265 6422 293a 205f 7472  ", "erred"): _tr
-00019210: 616e 7369 7469 6f6e 5f72 656c 6561 7365  ansition_release
-00019220: 645f 6572 7265 642c 0a20 2020 207d 0a0a  d_erred,.    }..
-00019230: 2020 2020 6465 6620 7374 6f72 7928 0a20      def story(. 
-00019240: 2020 2020 2020 2073 656c 662c 202a 6b65         self, *ke
-00019250: 7973 5f6f 725f 7461 736b 735f 6f72 5f73  ys_or_tasks_or_s
-00019260: 7469 6d75 6c69 3a20 4b65 7920 7c20 5461  timuli: Key | Ta
-00019270: 736b 5374 6174 6520 7c20 7374 720a 2020  skState | str.  
-00019280: 2020 2920 2d3e 206c 6973 745b 5472 616e    ) -> list[Tran
-00019290: 7369 7469 6f6e 5d3a 0a20 2020 2020 2020  sition]:.       
-000192a0: 2022 2222 4765 7420 616c 6c20 7472 616e   """Get all tran
-000192b0: 7369 7469 6f6e 7320 7468 6174 2074 6f75  sitions that tou
-000192c0: 6368 206f 6e65 206f 6620 7468 6520 696e  ch one of the in
-000192d0: 7075 7420 6b65 7973 206f 7220 7374 696d  put keys or stim
-000192e0: 756c 7573 5f69 6427 7322 2222 0a20 2020  ulus_id's""".   
-000192f0: 2020 2020 206b 6579 735f 6f72 5f73 7469       keys_or_sti
-00019300: 6d75 6c69 203d 207b 0a20 2020 2020 2020  muli = {.       
-00019310: 2020 2020 206b 6579 2e6b 6579 2069 6620       key.key if 
-00019320: 6973 696e 7374 616e 6365 286b 6579 2c20  isinstance(key, 
-00019330: 5461 736b 5374 6174 6529 2065 6c73 6520  TaskState) else 
-00019340: 6b65 790a 2020 2020 2020 2020 2020 2020  key.            
-00019350: 666f 7220 6b65 7920 696e 206b 6579 735f  for key in keys_
-00019360: 6f72 5f74 6173 6b73 5f6f 725f 7374 696d  or_tasks_or_stim
-00019370: 756c 690a 2020 2020 2020 2020 7d0a 2020  uli.        }.  
-00019380: 2020 2020 2020 7265 7475 726e 2073 6368        return sch
-00019390: 6564 756c 6572 5f73 746f 7279 286b 6579  eduler_story(key
-000193a0: 735f 6f72 5f73 7469 6d75 6c69 2c20 7365  s_or_stimuli, se
-000193b0: 6c66 2e74 7261 6e73 6974 696f 6e5f 6c6f  lf.transition_lo
-000193c0: 6729 0a0a 2020 2020 2323 2323 2323 2323  g)..    ########
+00016c00: 2020 2020 226f 7022 3a20 2266 7265 652d      "op": "free-
+00016c10: 6b65 7973 222c 0a20 2020 2020 2020 2020  keys",.         
+00016c20: 2020 2020 2020 2020 2020 2022 6b65 7973             "keys
+00016c30: 223a 205b 6b65 795d 2c0a 2020 2020 2020  ": [key],.      
+00016c40: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00016c50: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
+00016c60: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+00016c70: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00016c80: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
+00016c90: 2020 2073 656c 662e 5f70 726f 7061 6761     self._propaga
+00016ca0: 7465 5f72 656c 6561 7365 6428 7473 2c20  te_released(ts, 
+00016cb0: 7265 636f 6d6d 656e 6461 7469 6f6e 7329  recommendations)
+00016cc0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00016cd0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00016ce0: 207b 7d2c 2077 6f72 6b65 725f 6d73 6773   {}, worker_msgs
+00016cf0: 0a0a 2020 2020 6465 6620 5f74 7261 6e73  ..    def _trans
+00016d00: 6974 696f 6e5f 7072 6f63 6573 7369 6e67  ition_processing
+00016d10: 5f65 7272 6564 280a 2020 2020 2020 2020  _erred(.        
+00016d20: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
+00016d30: 793a 204b 6579 2c0a 2020 2020 2020 2020  y: Key,.        
+00016d40: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00016d50: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
+00016d60: 3a20 7374 722c 0a20 2020 2020 2020 202a  : str,.        *
+00016d70: 2c0a 2020 2020 2020 2020 6361 7573 653a  ,.        cause:
+00016d80: 204b 6579 207c 204e 6f6e 6520 3d20 4e6f   Key | None = No
+00016d90: 6e65 2c0a 2020 2020 2020 2020 6578 6365  ne,.        exce
+00016da0: 7074 696f 6e3a 2053 6572 6961 6c69 7a65  ption: Serialize
+00016db0: 6420 7c20 4e6f 6e65 203d 204e 6f6e 652c  d | None = None,
+00016dc0: 0a20 2020 2020 2020 2074 7261 6365 6261  .        traceba
+00016dd0: 636b 3a20 5365 7269 616c 697a 6564 207c  ck: Serialized |
+00016de0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00016df0: 2020 2020 2020 6578 6365 7074 696f 6e5f        exception_
+00016e00: 7465 7874 3a20 7374 7220 7c20 4e6f 6e65  text: str | None
+00016e10: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00016e20: 2074 7261 6365 6261 636b 5f74 6578 743a   traceback_text:
+00016e30: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+00016e40: 6e65 2c0a 2020 2020 2020 2020 2a2a 6b77  ne,.        **kw
+00016e50: 6172 6773 3a20 416e 792c 0a20 2020 2029  args: Any,.    )
+00016e60: 202d 3e20 5265 6373 4d73 6773 3a0a 2020   -> RecsMsgs:.  
+00016e70: 2020 2020 2020 2222 2250 726f 6365 7373        """Process
+00016e80: 6564 2061 2072 6563 6f6d 6d65 6e64 6564  ed a recommended
+00016e90: 2074 7261 6e73 6974 696f 6e20 7072 6f63   transition proc
+00016ea0: 6573 7369 6e67 202d 3e20 6572 7265 642e  essing -> erred.
+00016eb0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
+00016ec0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
+00016ed0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00016ee0: 6b65 790a 2020 2020 2020 2020 2020 204b  key.           K
+00016ef0: 6579 206f 6620 7468 6520 7461 736b 2074  ey of the task t
+00016f00: 6f20 7472 616e 7369 7469 6f6e 0a20 2020  o transition.   
+00016f10: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00016f20: 0a20 2020 2020 2020 2020 2020 2049 4420  .            ID 
+00016f30: 6f66 2074 6865 2073 7469 6d75 6c75 7320  of the stimulus 
+00016f40: 6361 7573 696e 6720 7468 6520 7472 616e  causing the tran
+00016f50: 7369 7469 6f6e 0a20 2020 2020 2020 2077  sition.        w
+00016f60: 6f72 6b65 720a 2020 2020 2020 2020 2020  orker.          
+00016f70: 2020 4164 6472 6573 7320 6f66 2074 6865    Address of the
+00016f80: 2077 6f72 6b65 7220 7768 6572 6520 7468   worker where th
+00016f90: 6520 7461 736b 2065 7272 6564 2e0a 2020  e task erred..  
+00016fa0: 2020 2020 2020 2020 2020 4e6f 7420 6e65            Not ne
+00016fb0: 6365 7373 6172 696c 7920 6060 7473 2e70  cessarily ``ts.p
+00016fc0: 726f 6365 7373 696e 675f 6f6e 6060 2e0a  rocessing_on``..
+00016fd0: 2020 2020 2020 2020 6361 7573 650a 2020          cause.  
+00016fe0: 2020 2020 2020 2020 2020 4164 6472 6573            Addres
+00016ff0: 7320 6f66 2074 6865 2074 6173 6b20 7468  s of the task th
+00017000: 6174 2063 6175 7365 6420 7468 6973 2074  at caused this t
+00017010: 6173 6b20 746f 2062 6520 7472 616e 7369  ask to be transi
+00017020: 7469 6f6e 6564 2074 6f20 6572 7265 640a  tioned to erred.
+00017030: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+00017040: 6e0a 2020 2020 2020 2020 2020 2020 4578  n.            Ex
+00017050: 6365 7074 696f 6e20 6361 7573 6564 2062  ception caused b
+00017060: 7920 7468 6520 7461 736b 0a20 2020 2020  y the task.     
+00017070: 2020 2074 7261 6365 6261 636b 0a20 2020     traceback.   
+00017080: 2020 2020 2020 2020 2054 7261 6365 6261           Traceba
+00017090: 636b 2063 6175 7365 6420 6279 2074 6865  ck caused by the
+000170a0: 2074 6173 6b0a 2020 2020 2020 2020 6578   task.        ex
+000170b0: 6365 7074 696f 6e5f 7465 7874 0a20 2020  ception_text.   
+000170c0: 2020 2020 2020 2020 2053 7472 696e 6720           String 
+000170d0: 7265 7072 6573 656e 7461 7469 6f6e 206f  representation o
+000170e0: 6620 7468 6520 6578 6365 7074 696f 6e0a  f the exception.
+000170f0: 2020 2020 2020 2020 7472 6163 6562 6163          tracebac
+00017100: 6b5f 7465 7874 0a20 2020 2020 2020 2020  k_text.         
+00017110: 2020 2053 7472 696e 6720 7265 7072 6573     String repres
+00017120: 656e 7461 7469 6f6e 206f 6620 7468 6520  entation of the 
+00017130: 7472 6163 6562 6163 6b0a 0a20 2020 2020  traceback..     
+00017140: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
+00017150: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+00017160: 2020 2052 6563 6f6d 6d65 6e64 6174 696f     Recommendatio
+00017170: 6e73 2c20 636c 6965 6e74 206d 6573 7361  ns, client messa
+00017180: 6765 7320 616e 6420 776f 726b 6572 206d  ges and worker m
+00017190: 6573 7361 6765 7320 746f 2070 726f 6365  essages to proce
+000171a0: 7373 0a20 2020 2020 2020 2022 2222 0a20  ss.        """. 
+000171b0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+000171c0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+000171d0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+000171e0: 6f6e 733a 2052 6563 7320 3d20 7b7d 0a20  ons: Recs = {}. 
+000171f0: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+00017200: 6773 3a20 4d73 6773 203d 207b 7d0a 0a20  gs: Msgs = {}.. 
+00017210: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00017220: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00017230: 2020 2020 2061 7373 6572 7420 6361 7573       assert caus
+00017240: 6520 6f72 2074 732e 6578 6365 7074 696f  e or ts.exceptio
+00017250: 6e5f 626c 616d 650a 2020 2020 2020 2020  n_blame.        
+00017260: 2020 2020 6173 7365 7274 2074 732e 7072      assert ts.pr
+00017270: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+00017280: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00017290: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
+000172a0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+000172b0: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+000172c0: 6f6e 0a0a 2020 2020 2020 2020 6966 2074  on..        if t
+000172d0: 732e 6163 746f 723a 0a20 2020 2020 2020  s.actor:.       
+000172e0: 2020 2020 2077 7320 3d20 7473 2e70 726f       ws = ts.pro
+000172f0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+00017300: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+00017310: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
+00017320: 6163 746f 7273 2e72 656d 6f76 6528 7473  actors.remove(ts
+00017330: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+00017340: 5f65 7869 745f 7072 6f63 6573 7369 6e67  _exit_processing
+00017350: 5f63 6f6d 6d6f 6e28 7473 290a 0a20 2020  _common(ts)..   
+00017360: 2020 2020 2069 6620 6e6f 7420 7473 2e65       if not ts.e
+00017370: 7272 6564 5f6f 6e3a 0a20 2020 2020 2020  rred_on:.       
+00017380: 2020 2020 2074 732e 6572 7265 645f 6f6e       ts.erred_on
+00017390: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+000173a0: 2074 732e 6572 7265 645f 6f6e 2e61 6464   ts.erred_on.add
+000173b0: 2877 6f72 6b65 7229 0a20 2020 2020 2020  (worker).       
+000173c0: 2069 6620 6578 6365 7074 696f 6e20 6973   if exception is
+000173d0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+000173e0: 2020 2020 2020 2074 732e 6578 6365 7074         ts.except
+000173f0: 696f 6e20 3d20 6578 6365 7074 696f 6e0a  ion = exception.
+00017400: 2020 2020 2020 2020 2020 2020 7473 2e65              ts.e
+00017410: 7863 6570 7469 6f6e 5f74 6578 7420 3d20  xception_text = 
+00017420: 6578 6365 7074 696f 6e5f 7465 7874 0a20  exception_text. 
+00017430: 2020 2020 2020 2069 6620 7472 6163 6562         if traceb
+00017440: 6163 6b20 6973 206e 6f74 204e 6f6e 653a  ack is not None:
+00017450: 0a20 2020 2020 2020 2020 2020 2074 732e  .            ts.
+00017460: 7472 6163 6562 6163 6b20 3d20 7472 6163  traceback = trac
+00017470: 6562 6163 6b0a 2020 2020 2020 2020 2020  eback.          
+00017480: 2020 7473 2e74 7261 6365 6261 636b 5f74    ts.traceback_t
+00017490: 6578 7420 3d20 7472 6163 6562 6163 6b5f  ext = traceback_
+000174a0: 7465 7874 0a20 2020 2020 2020 2069 6620  text.        if 
+000174b0: 6361 7573 6520 6973 206e 6f74 204e 6f6e  cause is not Non
+000174c0: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
+000174d0: 6169 6c69 6e67 5f74 7320 3d20 7365 6c66  ailing_ts = self
+000174e0: 2e74 6173 6b73 5b63 6175 7365 5d0a 2020  .tasks[cause].  
+000174f0: 2020 2020 2020 2020 2020 7473 2e65 7863            ts.exc
+00017500: 6570 7469 6f6e 5f62 6c61 6d65 203d 2066  eption_blame = f
+00017510: 6169 6c69 6e67 5f74 730a 2020 2020 2020  ailing_ts.      
+00017520: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00017530: 2020 2020 6661 696c 696e 675f 7473 203d      failing_ts =
+00017540: 2074 732e 6578 6365 7074 696f 6e5f 626c   ts.exception_bl
+00017550: 616d 6520 2023 2074 7970 653a 2069 676e  ame  # type: ign
+00017560: 6f72 650a 0a20 2020 2020 2020 2073 656c  ore..        sel
+00017570: 662e 6572 7265 645f 7461 736b 732e 6170  f.erred_tasks.ap
+00017580: 7065 6e64 6c65 6674 280a 2020 2020 2020  pendleft(.      
+00017590: 2020 2020 2020 4572 7265 6454 6173 6b28        ErredTask(
+000175a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000175b0: 2074 732e 6b65 792c 0a20 2020 2020 2020   ts.key,.       
+000175c0: 2020 2020 2020 2020 2074 696d 6528 292c           time(),
+000175d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000175e0: 2074 732e 6572 7265 645f 6f6e 2e63 6f70   ts.erred_on.cop
+000175f0: 7928 292c 0a20 2020 2020 2020 2020 2020  y(),.           
+00017600: 2020 2020 2065 7863 6570 7469 6f6e 5f74       exception_t
+00017610: 6578 7420 6f72 2022 222c 0a20 2020 2020  ext or "",.     
+00017620: 2020 2020 2020 2020 2020 2074 7261 6365             trace
+00017630: 6261 636b 5f74 6578 7420 6f72 2022 222c  back_text or "",
+00017640: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+00017650: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00017660: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
+00017670: 7761 6974 6572 7320 6f72 2073 6574 2829  waiters or set()
+00017680: 3a0a 2020 2020 2020 2020 2020 2020 6474  :.            dt
+00017690: 732e 6578 6365 7074 696f 6e5f 626c 616d  s.exception_blam
+000176a0: 6520 3d20 6661 696c 696e 675f 7473 0a20  e = failing_ts. 
+000176b0: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
+000176c0: 6d65 6e64 6174 696f 6e73 5b64 7473 2e6b  mendations[dts.k
+000176d0: 6579 5d20 3d20 2265 7272 6564 220a 0a20  ey] = "erred".. 
+000176e0: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
+000176f0: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
+00017700: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+00017710: 6620 6474 732e 7761 6974 6572 733a 0a20  f dts.waiters:. 
+00017720: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00017730: 7473 2e77 6169 7465 7273 2e64 6973 6361  ts.waiters.disca
+00017740: 7264 2874 7329 0a20 2020 2020 2020 2020  rd(ts).         
+00017750: 2020 2069 6620 6e6f 7420 6474 732e 7761     if not dts.wa
+00017760: 6974 6572 7320 616e 6420 6e6f 7420 6474  iters and not dt
+00017770: 732e 7768 6f5f 7761 6e74 733a 0a20 2020  s.who_wants:.   
+00017780: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+00017790: 6f6d 6d65 6e64 6174 696f 6e73 5b64 7473  ommendations[dts
+000177a0: 2e6b 6579 5d20 3d20 2272 656c 6561 7365  .key] = "release
+000177b0: 6422 0a0a 2020 2020 2020 2020 7473 2e77  d"..        ts.w
+000177c0: 6169 7465 7273 203d 204e 6f6e 650a 0a20  aiters = None.. 
+000177d0: 2020 2020 2020 2074 732e 7374 6174 6520         ts.state 
+000177e0: 3d20 2265 7272 6564 220a 0a20 2020 2020  = "erred"..     
+000177f0: 2020 2072 6570 6f72 745f 6d73 6720 3d20     report_msg = 
+00017800: 7b0a 2020 2020 2020 2020 2020 2020 226f  {.            "o
+00017810: 7022 3a20 2274 6173 6b2d 6572 7265 6422  p": "task-erred"
+00017820: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
+00017830: 6579 223a 206b 6579 2c0a 2020 2020 2020  ey": key,.      
+00017840: 2020 2020 2020 2265 7863 6570 7469 6f6e        "exception
+00017850: 223a 2066 6169 6c69 6e67 5f74 732e 6578  ": failing_ts.ex
+00017860: 6365 7074 696f 6e2c 0a20 2020 2020 2020  ception,.       
+00017870: 2020 2020 2022 7472 6163 6562 6163 6b22       "traceback"
+00017880: 3a20 6661 696c 696e 675f 7473 2e74 7261  : failing_ts.tra
+00017890: 6365 6261 636b 2c0a 2020 2020 2020 2020  ceback,.        
+000178a0: 7d0a 2020 2020 2020 2020 666f 7220 6373  }.        for cs
+000178b0: 2069 6e20 7473 2e77 686f 5f77 616e 7473   in ts.who_wants
+000178c0: 206f 7220 2829 3a0a 2020 2020 2020 2020   or ():.        
+000178d0: 2020 2020 636c 6965 6e74 5f6d 7367 735b      client_msgs[
+000178e0: 6373 2e63 6c69 656e 745f 6b65 795d 203d  cs.client_key] =
+000178f0: 205b 7265 706f 7274 5f6d 7367 5d0a 0a20   [report_msg].. 
+00017900: 2020 2020 2020 2063 7320 3d20 7365 6c66         cs = self
+00017910: 2e63 6c69 656e 7473 5b22 6669 7265 2d61  .clients["fire-a
+00017920: 6e64 2d66 6f72 6765 7422 5d0a 2020 2020  nd-forget"].    
+00017930: 2020 2020 6966 2074 7320 696e 2063 732e      if ts in cs.
+00017940: 7761 6e74 735f 7768 6174 3a0a 2020 2020  wants_what:.    
+00017950: 2020 2020 2020 2020 7365 6c66 2e5f 636c          self._cl
+00017960: 6965 6e74 5f72 656c 6561 7365 735f 6b65  ient_releases_ke
+00017970: 7973 280a 2020 2020 2020 2020 2020 2020  ys(.            
+00017980: 2020 2020 6373 3d63 732c 0a20 2020 2020      cs=cs,.     
+00017990: 2020 2020 2020 2020 2020 206b 6579 733d             keys=
+000179a0: 5b6b 6579 5d2c 0a20 2020 2020 2020 2020  [key],.         
+000179b0: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+000179c0: 6174 696f 6e73 3d72 6563 6f6d 6d65 6e64  ations=recommend
+000179d0: 6174 696f 6e73 2c0a 2020 2020 2020 2020  ations,.        
+000179e0: 2020 2020 290a 0a20 2020 2020 2020 2069      )..        i
+000179f0: 6620 7365 6c66 2e76 616c 6964 6174 653a  f self.validate:
+00017a00: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00017a10: 6572 7420 6e6f 7420 7473 2e70 726f 6365  ert not ts.proce
+00017a20: 7373 696e 675f 6f6e 0a0a 2020 2020 2020  ssing_on..      
+00017a30: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
+00017a40: 6e64 6174 696f 6e73 2c20 636c 6965 6e74  ndations, client
+00017a50: 5f6d 7367 732c 207b 7d0a 0a20 2020 2064  _msgs, {}..    d
+00017a60: 6566 205f 7472 616e 7369 7469 6f6e 5f6e  ef _transition_n
+00017a70: 6f5f 776f 726b 6572 5f72 656c 6561 7365  o_worker_release
+00017a80: 6428 7365 6c66 2c20 6b65 793a 204b 6579  d(self, key: Key
+00017a90: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+00017aa0: 7472 2920 2d3e 2052 6563 734d 7367 733a  tr) -> RecsMsgs:
+00017ab0: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
+00017ac0: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 0a20  lf.tasks[key].. 
+00017ad0: 2020 2020 2020 2069 6620 7365 6c66 2e76         if self.v
+00017ae0: 616c 6964 6174 653a 0a20 2020 2020 2020  alidate:.       
+00017af0: 2020 2020 2061 7373 6572 7420 7365 6c66       assert self
+00017b00: 2e74 6173 6b73 5b6b 6579 5d2e 7374 6174  .tasks[key].stat
+00017b10: 6520 3d3d 2022 6e6f 2d77 6f72 6b65 7222  e == "no-worker"
+00017b20: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00017b30: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
+00017b40: 6173 0a20 2020 2020 2020 2020 2020 2061  as.            a
+00017b50: 7373 6572 7420 6e6f 7420 7473 2e77 6169  ssert not ts.wai
+00017b60: 7469 6e67 5f6f 6e0a 0a20 2020 2020 2020  ting_on..       
+00017b70: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
+00017b80: 2e72 656d 6f76 6528 7473 290a 0a20 2020  .remove(ts)..   
+00017b90: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+00017ba0: 696f 6e73 3a20 5265 6373 203d 207b 7d0a  ions: Recs = {}.
+00017bb0: 2020 2020 2020 2020 7365 6c66 2e5f 7072          self._pr
+00017bc0: 6f70 6167 6174 655f 7265 6c65 6173 6564  opagate_released
+00017bd0: 2874 732c 2072 6563 6f6d 6d65 6e64 6174  (ts, recommendat
+00017be0: 696f 6e73 290a 2020 2020 2020 2020 7265  ions).        re
+00017bf0: 7475 726e 2072 6563 6f6d 6d65 6e64 6174  turn recommendat
+00017c00: 696f 6e73 2c20 7b7d 2c20 7b7d 0a0a 2020  ions, {}, {}..  
+00017c10: 2020 6465 6620 5f74 7261 6e73 6974 696f    def _transitio
+00017c20: 6e5f 7761 6974 696e 675f 7175 6575 6564  n_waiting_queued
+00017c30: 2873 656c 662c 206b 6579 3a20 4b65 792c  (self, key: Key,
+00017c40: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+00017c50: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
+00017c60: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+00017c70: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
+00017c80: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+00017c90: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+00017ca0: 2020 2020 6173 7365 7274 206e 6f74 2073      assert not s
+00017cb0: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
+00017cc0: 756e 742c 2028 7473 2c20 7365 6c66 2e69  unt, (ts, self.i
+00017cd0: 646c 655f 7461 736b 5f63 6f75 6e74 290a  dle_task_count).
+00017ce0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00017cf0: 2e5f 7661 6c69 6461 7465 5f72 6561 6479  ._validate_ready
+00017d00: 2874 7329 0a0a 2020 2020 2020 2020 7473  (ts)..        ts
+00017d10: 2e73 7461 7465 203d 2022 7175 6575 6564  .state = "queued
+00017d20: 220a 2020 2020 2020 2020 7365 6c66 2e71  ".        self.q
+00017d30: 7565 7565 642e 6164 6428 7473 290a 0a20  ueued.add(ts).. 
+00017d40: 2020 2020 2020 2072 6574 7572 6e20 7b7d         return {}
+00017d50: 2c20 7b7d 2c20 7b7d 0a0a 2020 2020 6465  , {}, {}..    de
+00017d60: 6620 5f74 7261 6e73 6974 696f 6e5f 7761  f _transition_wa
+00017d70: 6974 696e 675f 6e6f 5f77 6f72 6b65 7228  iting_no_worker(
+00017d80: 7365 6c66 2c20 6b65 793a 204b 6579 2c20  self, key: Key, 
+00017d90: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00017da0: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
+00017db0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00017dc0: 2e74 6173 6b73 5b6b 6579 5d0a 0a20 2020  .tasks[key]..   
+00017dd0: 2020 2020 2069 6620 7365 6c66 2e76 616c       if self.val
+00017de0: 6964 6174 653a 0a20 2020 2020 2020 2020  idate:.         
+00017df0: 2020 2073 656c 662e 5f76 616c 6964 6174     self._validat
+00017e00: 655f 7265 6164 7928 7473 290a 0a20 2020  e_ready(ts)..   
+00017e10: 2020 2020 2074 732e 7374 6174 6520 3d20       ts.state = 
+00017e20: 226e 6f2d 776f 726b 6572 220a 2020 2020  "no-worker".    
+00017e30: 2020 2020 7365 6c66 2e75 6e72 756e 6e61      self.unrunna
+00017e40: 626c 652e 6164 6428 7473 290a 0a20 2020  ble.add(ts)..   
+00017e50: 2020 2020 2072 6574 7572 6e20 7b7d 2c20       return {}, 
+00017e60: 7b7d 2c20 7b7d 0a0a 2020 2020 6465 6620  {}, {}..    def 
+00017e70: 5f74 7261 6e73 6974 696f 6e5f 7175 6575  _transition_queu
+00017e80: 6564 5f72 656c 6561 7365 6428 7365 6c66  ed_released(self
+00017e90: 2c20 6b65 793a 204b 6579 2c20 7374 696d  , key: Key, stim
+00017ea0: 756c 7573 5f69 643a 2073 7472 2920 2d3e  ulus_id: str) ->
+00017eb0: 2052 6563 734d 7367 733a 0a20 2020 2020   RecsMsgs:.     
+00017ec0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00017ed0: 6b73 5b6b 6579 5d0a 0a20 2020 2020 2020  ks[key]..       
+00017ee0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
+00017ef0: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00017f00: 7373 6572 7420 7473 2069 6e20 7365 6c66  ssert ts in self
+00017f10: 2e71 7565 7565 640a 2020 2020 2020 2020  .queued.        
+00017f20: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00017f30: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
+00017f40: 0a20 2020 2020 2020 2073 656c 662e 7175  .        self.qu
+00017f50: 6575 6564 2e72 656d 6f76 6528 7473 290a  eued.remove(ts).
+00017f60: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+00017f70: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+00017f80: 207b 7d0a 2020 2020 2020 2020 7365 6c66   {}.        self
+00017f90: 2e5f 7072 6f70 6167 6174 655f 7265 6c65  ._propagate_rele
+00017fa0: 6173 6564 2874 732c 2072 6563 6f6d 6d65  ased(ts, recomme
+00017fb0: 6e64 6174 696f 6e73 290a 2020 2020 2020  ndations).      
+00017fc0: 2020 7265 7475 726e 2072 6563 6f6d 6d65    return recomme
+00017fd0: 6e64 6174 696f 6e73 2c20 7b7d 2c20 7b7d  ndations, {}, {}
+00017fe0: 0a0a 2020 2020 6465 6620 5f74 7261 6e73  ..    def _trans
+00017ff0: 6974 696f 6e5f 7175 6575 6564 5f70 726f  ition_queued_pro
+00018000: 6365 7373 696e 6728 7365 6c66 2c20 6b65  cessing(self, ke
+00018010: 793a 204b 6579 2c20 7374 696d 756c 7573  y: Key, stimulus
+00018020: 5f69 643a 2073 7472 2920 2d3e 2052 6563  _id: str) -> Rec
+00018030: 734d 7367 733a 0a20 2020 2020 2020 2074  sMsgs:.        t
+00018040: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00018050: 6579 5d0a 0a20 2020 2020 2020 2069 6620  ey]..        if 
+00018060: 7365 6c66 2e76 616c 6964 6174 653a 0a20  self.validate:. 
+00018070: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00018080: 7420 6e6f 7420 7473 2e61 6374 6f72 2c20  t not ts.actor, 
+00018090: 6622 4163 746f 7273 2063 616e 2774 2062  f"Actors can't b
+000180a0: 6520 7175 6575 6564 3a20 7b74 737d 220a  e queued: {ts}".
+000180b0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000180c0: 7274 2074 7320 696e 2073 656c 662e 7175  rt ts in self.qu
+000180d0: 6575 6564 0a0a 2020 2020 2020 2020 6966  eued..        if
+000180e0: 2077 7320 3a3d 2073 656c 662e 6465 6369   ws := self.deci
+000180f0: 6465 5f77 6f72 6b65 725f 726f 6f74 6973  de_worker_rootis
+00018100: 685f 7175 6575 696e 675f 656e 6162 6c65  h_queuing_enable
+00018110: 6428 293a 0a20 2020 2020 2020 2020 2020  d():.           
+00018120: 2073 656c 662e 7175 6575 6564 2e64 6973   self.queued.dis
+00018130: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+00018140: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00018150: 2e5f 6164 645f 746f 5f70 726f 6365 7373  ._add_to_process
+00018160: 696e 6728 7473 2c20 7773 2c20 7374 696d  ing(ts, ws, stim
+00018170: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+00018180: 5f69 6429 0a20 2020 2020 2020 2023 2049  _id).        # I
+00018190: 6620 6e6f 2077 6f72 6b65 722c 2074 6173  f no worker, tas
+000181a0: 6b20 6a75 7374 2073 7461 7973 2060 7175  k just stays `qu
+000181b0: 6575 6564 600a 2020 2020 2020 2020 7265  eued`.        re
+000181c0: 7475 726e 207b 7d2c 207b 7d2c 207b 7d0a  turn {}, {}, {}.
+000181d0: 0a20 2020 2064 6566 205f 7265 6d6f 7665  .    def _remove
+000181e0: 5f6b 6579 2873 656c 662c 206b 6579 3a20  _key(self, key: 
+000181f0: 4b65 7929 202d 3e20 4e6f 6e65 3a0a 2020  Key) -> None:.  
+00018200: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00018210: 7461 736b 732e 706f 7028 6b65 7929 0a20  tasks.pop(key). 
+00018220: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+00018230: 2e73 7461 7465 203d 3d20 2266 6f72 676f  .state == "forgo
+00018240: 7474 656e 220a 2020 2020 2020 2020 7365  tten".        se
+00018250: 6c66 2e75 6e72 756e 6e61 626c 652e 6469  lf.unrunnable.di
+00018260: 7363 6172 6428 7473 290a 2020 2020 2020  scard(ts).      
+00018270: 2020 666f 7220 6373 2069 6e20 7473 2e77    for cs in ts.w
+00018280: 686f 5f77 616e 7473 206f 7220 2829 3a0a  ho_wants or ():.
+00018290: 2020 2020 2020 2020 2020 2020 6373 2e77              cs.w
+000182a0: 616e 7473 5f77 6861 742e 7265 6d6f 7665  ants_what.remove
+000182b0: 2874 7329 0a20 2020 2020 2020 2074 732e  (ts).        ts.
+000182c0: 7768 6f5f 7761 6e74 7320 3d20 4e6f 6e65  who_wants = None
+000182d0: 0a20 2020 2020 2020 2074 732e 7072 6f63  .        ts.proc
+000182e0: 6573 7369 6e67 5f6f 6e20 3d20 4e6f 6e65  essing_on = None
+000182f0: 0a20 2020 2020 2020 2074 732e 6578 6365  .        ts.exce
+00018300: 7074 696f 6e5f 626c 616d 6520 3d20 7473  ption_blame = ts
+00018310: 2e65 7863 6570 7469 6f6e 203d 2074 732e  .exception = ts.
+00018320: 7472 6163 6562 6163 6b20 3d20 4e6f 6e65  traceback = None
+00018330: 0a20 2020 2020 2020 2073 656c 662e 7461  .        self.ta
+00018340: 736b 5f6d 6574 6164 6174 612e 706f 7028  sk_metadata.pop(
+00018350: 6b65 792c 204e 6f6e 6529 0a0a 2020 2020  key, None)..    
+00018360: 6465 6620 5f74 7261 6e73 6974 696f 6e5f  def _transition_
+00018370: 6d65 6d6f 7279 5f66 6f72 676f 7474 656e  memory_forgotten
+00018380: 2873 656c 662c 206b 6579 3a20 4b65 792c  (self, key: Key,
+00018390: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+000183a0: 7229 202d 3e20 5265 6373 4d73 6773 3a0a  r) -> RecsMsgs:.
+000183b0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+000183c0: 662e 7461 736b 735b 6b65 795d 0a0a 2020  f.tasks[key]..  
+000183d0: 2020 2020 2020 6966 2073 656c 662e 7661        if self.va
+000183e0: 6c69 6461 7465 3a0a 2020 2020 2020 2020  lidate:.        
+000183f0: 2020 2020 6173 7365 7274 2074 732e 7374      assert ts.st
+00018400: 6174 6520 3d3d 2022 6d65 6d6f 7279 220a  ate == "memory".
+00018410: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00018420: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
+00018430: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+00018440: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00018450: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+00018460: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00018470: 7473 2e72 756e 5f73 7065 633a 0a20 2020  ts.run_spec:.   
+00018480: 2020 2020 2020 2020 2020 2020 2023 2049               # I
+00018490: 7427 7320 6f6b 2074 6f20 666f 7267 6574  t's ok to forget
+000184a0: 2061 2070 7572 6520 6461 7461 2074 6173   a pure data tas
+000184b0: 6b0a 2020 2020 2020 2020 2020 2020 2020  k.              
+000184c0: 2020 7061 7373 0a20 2020 2020 2020 2020    pass.         
+000184d0: 2020 2065 6c69 6620 7473 2e68 6173 5f6c     elif ts.has_l
+000184e0: 6f73 745f 6465 7065 6e64 656e 6369 6573  ost_dependencies
+000184f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00018500: 2020 2320 4974 2773 206f 6b20 746f 2066    # It's ok to f
+00018510: 6f72 6765 7420 6120 7461 736b 2077 6974  orget a task wit
+00018520: 6820 666f 7267 6f74 7465 6e20 6465 7065  h forgotten depe
+00018530: 6e64 656e 6369 6573 0a20 2020 2020 2020  ndencies.       
+00018540: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+00018550: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
+00018560: 6f74 2074 732e 7768 6f5f 7761 6e74 7320  ot ts.who_wants 
+00018570: 616e 6420 6e6f 7420 7473 2e77 6169 7465  and not ts.waite
+00018580: 7273 2061 6e64 206e 6f74 2074 732e 6465  rs and not ts.de
+00018590: 7065 6e64 656e 7473 3a0a 2020 2020 2020  pendents:.      
+000185a0: 2020 2020 2020 2020 2020 2320 4974 2773            # It's
+000185b0: 206f 6b20 746f 2066 6f72 6765 7420 6120   ok to forget a 
+000185c0: 7461 736b 2074 6861 7420 6e6f 626f 6479  task that nobody
+000185d0: 206e 6565 6473 0a20 2020 2020 2020 2020   needs.         
+000185e0: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
+000185f0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00018600: 2020 2020 2020 2020 2020 2020 2020 7261                ra
+00018610: 6973 6520 4173 7365 7274 696f 6e45 7272  ise AssertionErr
+00018620: 6f72 2822 556e 7265 6163 6861 626c 6522  or("Unreachable"
+00018630: 2c20 7374 7228 7473 2929 2020 2320 7072  , str(ts))  # pr
+00018640: 6167 6d61 3a20 6e6f 636f 7665 720a 0a20  agma: nocover.. 
+00018650: 2020 2020 2020 2069 6620 7473 2e61 6374         if ts.act
+00018660: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00018670: 666f 7220 7773 2069 6e20 7473 2e77 686f  for ws in ts.who
+00018680: 5f68 6173 206f 7220 2829 3a0a 2020 2020  _has or ():.    
+00018690: 2020 2020 2020 2020 2020 2020 7773 2e61              ws.a
+000186a0: 6374 6f72 732e 6469 7363 6172 6428 7473  ctors.discard(ts
+000186b0: 290a 0a20 2020 2020 2020 2072 6563 6f6d  )..        recom
+000186c0: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+000186d0: 203d 207b 7d0a 2020 2020 2020 2020 776f   = {}.        wo
+000186e0: 726b 6572 5f6d 7367 733a 204d 7367 7320  rker_msgs: Msgs 
+000186f0: 3d20 7b7d 0a20 2020 2020 2020 2073 656c  = {}.        sel
+00018700: 662e 5f70 726f 7061 6761 7465 5f66 6f72  f._propagate_for
+00018710: 676f 7474 656e 2874 732c 2072 6563 6f6d  gotten(ts, recom
+00018720: 6d65 6e64 6174 696f 6e73 2c20 776f 726b  mendations, work
+00018730: 6572 5f6d 7367 732c 2073 7469 6d75 6c75  er_msgs, stimulu
+00018740: 735f 6964 290a 0a20 2020 2020 2020 2063  s_id)..        c
+00018750: 6c69 656e 745f 6d73 6773 203d 205f 7461  lient_msgs = _ta
+00018760: 736b 5f74 6f5f 636c 6965 6e74 5f6d 7367  sk_to_client_msg
+00018770: 7328 7473 290a 2020 2020 2020 2020 7365  s(ts).        se
+00018780: 6c66 2e5f 7265 6d6f 7665 5f6b 6579 286b  lf._remove_key(k
+00018790: 6579 290a 0a20 2020 2020 2020 2072 6574  ey)..        ret
+000187a0: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
+000187b0: 6f6e 732c 2063 6c69 656e 745f 6d73 6773  ons, client_msgs
+000187c0: 2c20 776f 726b 6572 5f6d 7367 730a 0a20  , worker_msgs.. 
+000187d0: 2020 2064 6566 205f 7472 616e 7369 7469     def _transiti
+000187e0: 6f6e 5f72 656c 6561 7365 645f 666f 7267  on_released_forg
+000187f0: 6f74 7465 6e28 7365 6c66 2c20 6b65 793a  otten(self, key:
+00018800: 204b 6579 2c20 7374 696d 756c 7573 5f69   Key, stimulus_i
+00018810: 643a 2073 7472 2920 2d3e 2052 6563 734d  d: str) -> RecsM
+00018820: 7367 733a 0a20 2020 2020 2020 2074 7320  sgs:.        ts 
+00018830: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00018840: 5d0a 0a20 2020 2020 2020 2069 6620 7365  ]..        if se
+00018850: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
+00018860: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00018870: 7473 2e73 7461 7465 2069 6e20 2822 7265  ts.state in ("re
+00018880: 6c65 6173 6564 222c 2022 6572 7265 6422  leased", "erred"
+00018890: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+000188a0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+000188b0: 6861 730a 2020 2020 2020 2020 2020 2020  has.            
+000188c0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
+000188d0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+000188e0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+000188f0: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
+00018900: 6575 6564 0a20 2020 2020 2020 2020 2020  eued.           
+00018910: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+00018920: 6169 7469 6e67 5f6f 6e2c 2028 7473 2c20  aiting_on, (ts, 
+00018930: 7473 2e77 6169 7469 6e67 5f6f 6e29 0a20  ts.waiting_on). 
+00018940: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00018950: 7420 7473 2e72 756e 5f73 7065 633a 0a20  t ts.run_spec:. 
+00018960: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00018970: 2049 7427 7320 6f6b 2074 6f20 666f 7267   It's ok to forg
+00018980: 6574 2061 2070 7572 6520 6461 7461 2074  et a pure data t
+00018990: 6173 6b0a 2020 2020 2020 2020 2020 2020  ask.            
+000189a0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+000189b0: 2020 2020 2065 6c69 6620 7473 2e68 6173       elif ts.has
+000189c0: 5f6c 6f73 745f 6465 7065 6e64 656e 6369  _lost_dependenci
+000189d0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000189e0: 2020 2020 2320 4974 2773 206f 6b20 746f      # It's ok to
+000189f0: 2066 6f72 6765 7420 6120 7461 736b 2077   forget a task w
+00018a00: 6974 6820 666f 7267 6f74 7465 6e20 6465  ith forgotten de
+00018a10: 7065 6e64 656e 6369 6573 0a20 2020 2020  pendencies.     
+00018a20: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00018a30: 2020 2020 2020 2020 2020 2020 656c 6966              elif
+00018a40: 206e 6f74 2074 732e 7768 6f5f 7761 6e74   not ts.who_want
+00018a50: 7320 616e 6420 6e6f 7420 7473 2e77 6169  s and not ts.wai
+00018a60: 7465 7273 2061 6e64 206e 6f74 2074 732e  ters and not ts.
+00018a70: 6465 7065 6e64 656e 7473 3a0a 2020 2020  dependents:.    
+00018a80: 2020 2020 2020 2020 2020 2020 2320 4974              # It
+00018a90: 2773 206f 6b20 746f 2066 6f72 6765 7420  's ok to forget 
+00018aa0: 6120 7461 736b 2074 6861 7420 6e6f 626f  a task that nobo
+00018ab0: 6479 206e 6565 6473 0a20 2020 2020 2020  dy needs.       
+00018ac0: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+00018ad0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00018ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018af0: 7261 6973 6520 4173 7365 7274 696f 6e45  raise AssertionE
+00018b00: 7272 6f72 2822 556e 7265 6163 6861 626c  rror("Unreachabl
+00018b10: 6522 2c20 7374 7228 7473 2929 2020 2320  e", str(ts))  # 
+00018b20: 7072 6167 6d61 3a20 6e6f 636f 7665 720a  pragma: nocover.
+00018b30: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+00018b40: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+00018b50: 207b 7d0a 2020 2020 2020 2020 776f 726b   {}.        work
+00018b60: 6572 5f6d 7367 733a 204d 7367 7320 3d20  er_msgs: Msgs = 
+00018b70: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+00018b80: 5f70 726f 7061 6761 7465 5f66 6f72 676f  _propagate_forgo
+00018b90: 7474 656e 2874 732c 2072 6563 6f6d 6d65  tten(ts, recomme
+00018ba0: 6e64 6174 696f 6e73 2c20 776f 726b 6572  ndations, worker
+00018bb0: 5f6d 7367 732c 2073 7469 6d75 6c75 735f  _msgs, stimulus_
+00018bc0: 6964 290a 0a20 2020 2020 2020 2063 6c69  id)..        cli
+00018bd0: 656e 745f 6d73 6773 203d 205f 7461 736b  ent_msgs = _task
+00018be0: 5f74 6f5f 636c 6965 6e74 5f6d 7367 7328  _to_client_msgs(
+00018bf0: 7473 290a 2020 2020 2020 2020 7365 6c66  ts).        self
+00018c00: 2e5f 7265 6d6f 7665 5f6b 6579 286b 6579  ._remove_key(key
+00018c10: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00018c20: 6e20 7265 636f 6d6d 656e 6461 7469 6f6e  n recommendation
+00018c30: 732c 2063 6c69 656e 745f 6d73 6773 2c20  s, client_msgs, 
+00018c40: 776f 726b 6572 5f6d 7367 730a 0a20 2020  worker_msgs..   
+00018c50: 2023 207b 0a20 2020 2023 2020 2020 2028   # {.    #     (
+00018c60: 7374 6172 742c 2066 696e 6973 6829 3a0a  start, finish):.
+00018c70: 2020 2020 2320 2020 2020 7472 616e 7369      #     transi
+00018c80: 7469 6f6e 5f3c 7374 6172 743e 5f3c 6669  tion_<start>_<fi
+00018c90: 6e69 7368 3e28 0a20 2020 2023 2020 2020  nish>(.    #    
+00018ca0: 2020 2020 2073 656c 662c 206b 6579 3a20       self, key: 
+00018cb0: 4b65 792c 2073 7469 6d75 6c75 735f 6964  Key, stimulus_id
+00018cc0: 3a20 7374 722c 202a 2a6b 7761 7267 730a  : str, **kwargs.
+00018cd0: 2020 2020 2320 2020 2020 2920 2d3e 2028      #     ) -> (
+00018ce0: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00018cf0: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
+00018d00: 726b 6572 5f6d 7367 7329 0a20 2020 2023  rker_msgs).    #
+00018d10: 207d 0a20 2020 205f 5452 414e 5349 5449   }.    _TRANSITI
+00018d20: 4f4e 535f 5441 424c 453a 2043 6c61 7373  ONS_TABLE: Class
+00018d30: 5661 725b 0a20 2020 2020 2020 204d 6170  Var[.        Map
+00018d40: 7069 6e67 5b0a 2020 2020 2020 2020 2020  ping[.          
+00018d50: 2020 7475 706c 655b 5461 736b 5374 6174    tuple[TaskStat
+00018d60: 6553 7461 7465 2c20 5461 736b 5374 6174  eState, TaskStat
+00018d70: 6553 7461 7465 5d2c 0a20 2020 2020 2020  eState],.       
+00018d80: 2020 2020 2043 616c 6c61 626c 655b 2e2e       Callable[..
+00018d90: 2e2c 2052 6563 734d 7367 735d 2c0a 2020  ., RecsMsgs],.  
+00018da0: 2020 2020 2020 5d0a 2020 2020 5d20 3d20        ].    ] = 
+00018db0: 7b0a 2020 2020 2020 2020 2822 7265 6c65  {.        ("rele
+00018dc0: 6173 6564 222c 2022 7761 6974 696e 6722  ased", "waiting"
+00018dd0: 293a 205f 7472 616e 7369 7469 6f6e 5f72  ): _transition_r
+00018de0: 656c 6561 7365 645f 7761 6974 696e 672c  eleased_waiting,
+00018df0: 0a20 2020 2020 2020 2028 2277 6169 7469  .        ("waiti
+00018e00: 6e67 222c 2022 7265 6c65 6173 6564 2229  ng", "released")
+00018e10: 3a20 5f74 7261 6e73 6974 696f 6e5f 7761  : _transition_wa
+00018e20: 6974 696e 675f 7265 6c65 6173 6564 2c0a  iting_released,.
+00018e30: 2020 2020 2020 2020 2822 7761 6974 696e          ("waitin
+00018e40: 6722 2c20 2270 726f 6365 7373 696e 6722  g", "processing"
+00018e50: 293a 205f 7472 616e 7369 7469 6f6e 5f77  ): _transition_w
+00018e60: 6169 7469 6e67 5f70 726f 6365 7373 696e  aiting_processin
+00018e70: 672c 0a20 2020 2020 2020 2028 2277 6169  g,.        ("wai
+00018e80: 7469 6e67 222c 2022 6e6f 2d77 6f72 6b65  ting", "no-worke
+00018e90: 7222 293a 205f 7472 616e 7369 7469 6f6e  r"): _transition
+00018ea0: 5f77 6169 7469 6e67 5f6e 6f5f 776f 726b  _waiting_no_work
+00018eb0: 6572 2c0a 2020 2020 2020 2020 2822 7761  er,.        ("wa
+00018ec0: 6974 696e 6722 2c20 2271 7565 7565 6422  iting", "queued"
+00018ed0: 293a 205f 7472 616e 7369 7469 6f6e 5f77  ): _transition_w
+00018ee0: 6169 7469 6e67 5f71 7565 7565 642c 0a20  aiting_queued,. 
+00018ef0: 2020 2020 2020 2028 2277 6169 7469 6e67         ("waiting
+00018f00: 222c 2022 6d65 6d6f 7279 2229 3a20 5f74  ", "memory"): _t
+00018f10: 7261 6e73 6974 696f 6e5f 7761 6974 696e  ransition_waitin
+00018f20: 675f 6d65 6d6f 7279 2c0a 2020 2020 2020  g_memory,.      
+00018f30: 2020 2822 7175 6575 6564 222c 2022 7265    ("queued", "re
+00018f40: 6c65 6173 6564 2229 3a20 5f74 7261 6e73  leased"): _trans
+00018f50: 6974 696f 6e5f 7175 6575 6564 5f72 656c  ition_queued_rel
+00018f60: 6561 7365 642c 0a20 2020 2020 2020 2028  eased,.        (
+00018f70: 2271 7565 7565 6422 2c20 2270 726f 6365  "queued", "proce
+00018f80: 7373 696e 6722 293a 205f 7472 616e 7369  ssing"): _transi
+00018f90: 7469 6f6e 5f71 7565 7565 645f 7072 6f63  tion_queued_proc
+00018fa0: 6573 7369 6e67 2c0a 2020 2020 2020 2020  essing,.        
+00018fb0: 2822 7072 6f63 6573 7369 6e67 222c 2022  ("processing", "
+00018fc0: 7265 6c65 6173 6564 2229 3a20 5f74 7261  released"): _tra
+00018fd0: 6e73 6974 696f 6e5f 7072 6f63 6573 7369  nsition_processi
+00018fe0: 6e67 5f72 656c 6561 7365 642c 0a20 2020  ng_released,.   
+00018ff0: 2020 2020 2028 2270 726f 6365 7373 696e       ("processin
+00019000: 6722 2c20 226d 656d 6f72 7922 293a 205f  g", "memory"): _
+00019010: 7472 616e 7369 7469 6f6e 5f70 726f 6365  transition_proce
+00019020: 7373 696e 675f 6d65 6d6f 7279 2c0a 2020  ssing_memory,.  
+00019030: 2020 2020 2020 2822 7072 6f63 6573 7369        ("processi
+00019040: 6e67 222c 2022 6572 7265 6422 293a 205f  ng", "erred"): _
+00019050: 7472 616e 7369 7469 6f6e 5f70 726f 6365  transition_proce
+00019060: 7373 696e 675f 6572 7265 642c 0a20 2020  ssing_erred,.   
+00019070: 2020 2020 2028 226e 6f2d 776f 726b 6572       ("no-worker
+00019080: 222c 2022 7265 6c65 6173 6564 2229 3a20  ", "released"): 
+00019090: 5f74 7261 6e73 6974 696f 6e5f 6e6f 5f77  _transition_no_w
+000190a0: 6f72 6b65 725f 7265 6c65 6173 6564 2c0a  orker_released,.
+000190b0: 2020 2020 2020 2020 2822 6e6f 2d77 6f72          ("no-wor
+000190c0: 6b65 7222 2c20 2270 726f 6365 7373 696e  ker", "processin
+000190d0: 6722 293a 205f 7472 616e 7369 7469 6f6e  g"): _transition
+000190e0: 5f6e 6f5f 776f 726b 6572 5f70 726f 6365  _no_worker_proce
+000190f0: 7373 696e 672c 0a20 2020 2020 2020 2028  ssing,.        (
+00019100: 2272 656c 6561 7365 6422 2c20 2266 6f72  "released", "for
+00019110: 676f 7474 656e 2229 3a20 5f74 7261 6e73  gotten"): _trans
+00019120: 6974 696f 6e5f 7265 6c65 6173 6564 5f66  ition_released_f
+00019130: 6f72 676f 7474 656e 2c0a 2020 2020 2020  orgotten,.      
+00019140: 2020 2822 6d65 6d6f 7279 222c 2022 666f    ("memory", "fo
+00019150: 7267 6f74 7465 6e22 293a 205f 7472 616e  rgotten"): _tran
+00019160: 7369 7469 6f6e 5f6d 656d 6f72 795f 666f  sition_memory_fo
+00019170: 7267 6f74 7465 6e2c 0a20 2020 2020 2020  rgotten,.       
+00019180: 2028 2265 7272 6564 222c 2022 7265 6c65   ("erred", "rele
+00019190: 6173 6564 2229 3a20 5f74 7261 6e73 6974  ased"): _transit
+000191a0: 696f 6e5f 6572 7265 645f 7265 6c65 6173  ion_erred_releas
+000191b0: 6564 2c0a 2020 2020 2020 2020 2822 6d65  ed,.        ("me
+000191c0: 6d6f 7279 222c 2022 7265 6c65 6173 6564  mory", "released
+000191d0: 2229 3a20 5f74 7261 6e73 6974 696f 6e5f  "): _transition_
+000191e0: 6d65 6d6f 7279 5f72 656c 6561 7365 642c  memory_released,
+000191f0: 0a20 2020 2020 2020 2028 2272 656c 6561  .        ("relea
+00019200: 7365 6422 2c20 2265 7272 6564 2229 3a20  sed", "erred"): 
+00019210: 5f74 7261 6e73 6974 696f 6e5f 7265 6c65  _transition_rele
+00019220: 6173 6564 5f65 7272 6564 2c0a 2020 2020  ased_erred,.    
+00019230: 7d0a 0a20 2020 2064 6566 2073 746f 7279  }..    def story
+00019240: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00019250: 2a6b 6579 735f 6f72 5f74 6173 6b73 5f6f  *keys_or_tasks_o
+00019260: 725f 7374 696d 756c 693a 204b 6579 207c  r_stimuli: Key |
+00019270: 2054 6173 6b53 7461 7465 207c 2073 7472   TaskState | str
+00019280: 0a20 2020 2029 202d 3e20 6c69 7374 5b54  .    ) -> list[T
+00019290: 7261 6e73 6974 696f 6e5d 3a0a 2020 2020  ransition]:.    
+000192a0: 2020 2020 2222 2247 6574 2061 6c6c 2074      """Get all t
+000192b0: 7261 6e73 6974 696f 6e73 2074 6861 7420  ransitions that 
+000192c0: 746f 7563 6820 6f6e 6520 6f66 2074 6865  touch one of the
+000192d0: 2069 6e70 7574 206b 6579 7320 6f72 2073   input keys or s
+000192e0: 7469 6d75 6c75 735f 6964 2773 2222 220a  timulus_id's""".
+000192f0: 2020 2020 2020 2020 6b65 7973 5f6f 725f          keys_or_
+00019300: 7374 696d 756c 6920 3d20 7b0a 2020 2020  stimuli = {.    
+00019310: 2020 2020 2020 2020 6b65 792e 6b65 7920          key.key 
+00019320: 6966 2069 7369 6e73 7461 6e63 6528 6b65  if isinstance(ke
+00019330: 792c 2054 6173 6b53 7461 7465 2920 656c  y, TaskState) el
+00019340: 7365 206b 6579 0a20 2020 2020 2020 2020  se key.         
+00019350: 2020 2066 6f72 206b 6579 2069 6e20 6b65     for key in ke
+00019360: 7973 5f6f 725f 7461 736b 735f 6f72 5f73  ys_or_tasks_or_s
+00019370: 7469 6d75 6c69 0a20 2020 2020 2020 207d  timuli.        }
+00019380: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00019390: 7363 6865 6475 6c65 725f 7374 6f72 7928  scheduler_story(
+000193a0: 6b65 7973 5f6f 725f 7374 696d 756c 692c  keys_or_stimuli,
+000193b0: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+000193c0: 5f6c 6f67 290a 0a20 2020 2023 2323 2323  _log)..    #####
 000193d0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000193e0: 2323 2323 2323 0a20 2020 2023 2041 7373  ######.    # Ass
-000193f0: 6967 6e69 6e67 2054 6173 6b73 2074 6f20  igning Tasks to 
-00019400: 576f 726b 6572 7320 230a 2020 2020 2323  Workers #.    ##
-00019410: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00019420: 2323 2323 2323 2323 2323 2323 0a0a 2020  ############..  
-00019430: 2020 6465 6620 6973 5f72 6f6f 7469 7368    def is_rootish
-00019440: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-00019450: 7461 7465 2920 2d3e 2062 6f6f 6c3a 0a20  tate) -> bool:. 
-00019460: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00019470: 2020 2057 6865 7468 6572 2060 6074 7360     Whether ``ts`
-00019480: 6020 6973 2061 2072 6f6f 7420 6f72 2072  ` is a root or r
-00019490: 6f6f 742d 6c69 6b65 2074 6173 6b2e 0a0a  oot-like task...
-000194a0: 2020 2020 2020 2020 526f 6f74 2d69 7368          Root-ish
-000194b0: 2074 6173 6b73 2061 7265 2070 6172 7420   tasks are part 
-000194c0: 6f66 2061 2067 726f 7570 2074 6861 7427  of a group that'
-000194d0: 7320 6d75 6368 206c 6172 6765 7220 7468  s much larger th
-000194e0: 616e 2074 6865 2063 6c75 7374 6572 2c0a  an the cluster,.
-000194f0: 2020 2020 2020 2020 616e 6420 6861 7665          and have
-00019500: 2066 6577 206f 7220 6e6f 2064 6570 656e   few or no depen
-00019510: 6465 6e63 6965 732e 2054 6173 6b73 206d  dencies. Tasks m
-00019520: 6179 2061 6c73 6f20 6265 2065 7870 6c69  ay also be expli
-00019530: 6369 746c 7920 6d61 726b 6564 2061 7320  citly marked as 
-00019540: 726f 6f74 6973 680a 2020 2020 2020 2020  rootish.        
-00019550: 746f 206f 7665 7272 6964 6520 7468 6973  to override this
-00019560: 2068 6575 7269 7374 6963 2e0a 2020 2020   heuristic..    
-00019570: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00019580: 6966 2074 732e 5f72 6f6f 7469 7368 2069  if ts._rootish i
-00019590: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-000195a0: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-000195b0: 732e 5f72 6f6f 7469 7368 0a20 2020 2020  s._rootish.     
-000195c0: 2020 2069 6620 7473 2e72 6573 6f75 7263     if ts.resourc
-000195d0: 655f 7265 7374 7269 6374 696f 6e73 206f  e_restrictions o
-000195e0: 7220 7473 2e77 6f72 6b65 725f 7265 7374  r ts.worker_rest
-000195f0: 7269 6374 696f 6e73 206f 7220 7473 2e68  rictions or ts.h
-00019600: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
-00019610: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00019620: 7475 726e 2046 616c 7365 0a20 2020 2020  turn False.     
-00019630: 2020 2074 6720 3d20 7473 2e67 726f 7570     tg = ts.group
-00019640: 0a20 2020 2020 2020 2023 2054 4f44 4f20  .        # TODO 
-00019650: 7368 6f72 742d 6369 7263 7569 7420 746f  short-circuit to
-00019660: 2054 7275 6520 6966 2060 6e6f 7420 7473   True if `not ts
-00019670: 2e64 6570 656e 6465 6e63 6965 7360 3f0a  .dependencies`?.
-00019680: 2020 2020 2020 2020 7265 7475 726e 2028          return (
-00019690: 0a20 2020 2020 2020 2020 2020 206c 656e  .            len
-000196a0: 2874 6729 203e 2073 656c 662e 746f 7461  (tg) > self.tota
-000196b0: 6c5f 6e74 6872 6561 6473 202a 2032 0a20  l_nthreads * 2. 
-000196c0: 2020 2020 2020 2020 2020 2061 6e64 206c             and l
-000196d0: 656e 2874 672e 6465 7065 6e64 656e 6369  en(tg.dependenci
-000196e0: 6573 2920 3c20 350a 2020 2020 2020 2020  es) < 5.        
-000196f0: 2020 2020 616e 6420 7375 6d28 6d61 7028      and sum(map(
-00019700: 6c65 6e2c 2074 672e 6465 7065 6e64 656e  len, tg.dependen
-00019710: 6369 6573 2929 203c 2035 0a20 2020 2020  cies)) < 5.     
-00019720: 2020 2029 0a0a 2020 2020 6465 6620 6368     )..    def ch
-00019730: 6563 6b5f 6964 6c65 5f73 6174 7572 6174  eck_idle_saturat
-00019740: 6564 2873 656c 662c 2077 733a 2057 6f72  ed(self, ws: Wor
-00019750: 6b65 7253 7461 7465 2c20 6f63 633a 2066  kerState, occ: f
-00019760: 6c6f 6174 203d 202d 312e 3029 202d 3e20  loat = -1.0) -> 
-00019770: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-00019780: 2255 7064 6174 6520 7468 6520 7374 6174  "Update the stat
-00019790: 7573 206f 6620 7468 6520 6964 6c65 2061  us of the idle a
-000197a0: 6e64 2073 6174 7572 6174 6564 2073 7461  nd saturated sta
-000197b0: 7465 0a0a 2020 2020 2020 2020 5468 6520  te..        The 
-000197c0: 7363 6865 6475 6c65 7220 6b65 6570 7320  scheduler keeps 
-000197d0: 7472 6163 6b20 6f66 2077 6f72 6b65 7273  track of workers
-000197e0: 2074 6861 7420 6172 6520 2e2e 0a0a 2020   that are ....  
-000197f0: 2020 2020 2020 2d20 2053 6174 7572 6174        -  Saturat
-00019800: 6564 3a20 6861 7665 2065 6e6f 7567 6820  ed: have enough 
-00019810: 776f 726b 2074 6f20 7374 6179 2062 7573  work to stay bus
-00019820: 790a 2020 2020 2020 2020 2d20 2049 646c  y.        -  Idl
-00019830: 653a 2064 6f20 6e6f 7420 6861 7665 2065  e: do not have e
-00019840: 6e6f 7567 6820 776f 726b 2074 6f20 7374  nough work to st
-00019850: 6179 2062 7573 790a 0a20 2020 2020 2020  ay busy..       
-00019860: 2054 6865 7920 6172 6520 636f 6e73 6964   They are consid
-00019870: 6572 6564 2073 6174 7572 6174 6564 2069  ered saturated i
-00019880: 6620 7468 6579 2062 6f74 6820 6861 7665  f they both have
-00019890: 2065 6e6f 7567 6820 7461 736b 7320 746f   enough tasks to
-000198a0: 206f 6363 7570 790a 2020 2020 2020 2020   occupy.        
-000198b0: 616c 6c20 6f66 2074 6865 6972 2074 6872  all of their thr
-000198c0: 6561 6473 2c20 616e 6420 6966 2074 6865  eads, and if the
-000198d0: 2065 7870 6563 7465 6420 7275 6e74 696d   expected runtim
-000198e0: 6520 6f66 2074 686f 7365 2074 6173 6b73  e of those tasks
-000198f0: 2069 730a 2020 2020 2020 2020 6c61 7267   is.        larg
-00019900: 6520 656e 6f75 6768 2e0a 0a20 2020 2020  e enough...     
-00019910: 2020 2049 6620 6060 6469 7374 7269 6275     If ``distribu
-00019920: 7465 642e 7363 6865 6475 6c65 722e 776f  ted.scheduler.wo
-00019930: 726b 6572 2d73 6174 7572 6174 696f 6e60  rker-saturation`
-00019940: 6020 6973 206e 6f74 2060 6069 6e66 6060  ` is not ``inf``
-00019950: 0a20 2020 2020 2020 2028 7363 6865 6475  .        (schedu
-00019960: 6c65 722d 7369 6465 2071 7565 7569 6e67  ler-side queuing
-00019970: 2069 7320 656e 6162 6c65 6429 2c20 7468   is enabled), th
-00019980: 6579 2061 7265 2063 6f6e 7369 6465 7265  ey are considere
-00019990: 6420 6964 6c65 0a20 2020 2020 2020 2069  d idle.        i
-000199a0: 6620 7468 6579 2068 6176 6520 6665 7765  f they have fewe
-000199b0: 7220 7461 736b 7320 7072 6f63 6573 7369  r tasks processi
-000199c0: 6e67 2074 6861 6e20 7468 6520 6060 776f  ng than the ``wo
-000199d0: 726b 6572 2d73 6174 7572 6174 696f 6e60  rker-saturation`
-000199e0: 600a 2020 2020 2020 2020 7468 7265 7368  `.        thresh
-000199f0: 6f6c 6420 6469 6374 6174 6573 2e0a 0a20  old dictates... 
-00019a00: 2020 2020 2020 204f 7468 6572 7769 7365         Otherwise
-00019a10: 2c20 7468 6579 2061 7265 2063 6f6e 7369  , they are consi
-00019a20: 6465 7265 6420 6964 6c65 2069 6620 7468  dered idle if th
-00019a30: 6579 2068 6176 6520 6665 7765 7220 7461  ey have fewer ta
-00019a40: 736b 7320 7072 6f63 6573 7369 6e67 0a20  sks processing. 
-00019a50: 2020 2020 2020 2074 6861 6e20 7468 7265         than thre
-00019a60: 6164 732c 206f 7220 6966 2074 6865 6972  ads, or if their
-00019a70: 2074 6173 6b73 2720 746f 7461 6c20 6578   tasks' total ex
-00019a80: 7065 6374 6564 2072 756e 7469 6d65 2069  pected runtime i
-00019a90: 7320 6c65 7373 2074 6861 6e20 6861 6c66  s less than half
-00019aa0: 0a20 2020 2020 2020 2074 6865 2065 7870  .        the exp
-00019ab0: 6563 7465 6420 7275 6e74 696d 6520 6f66  ected runtime of
-00019ac0: 2074 6865 2073 616d 6520 6e75 6d62 6572   the same number
-00019ad0: 206f 6620 6176 6572 6167 6520 7461 736b   of average task
-00019ae0: 732e 0a0a 2020 2020 2020 2020 5468 6973  s...        This
-00019af0: 2069 7320 7573 6566 756c 2066 6f72 206c   is useful for l
-00019b00: 6f61 6420 6261 6c61 6e63 696e 6720 616e  oad balancing an
-00019b10: 6420 6164 6170 7469 7669 7479 2e0a 2020  d adaptivity..  
-00019b20: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00019b30: 2020 6966 2073 656c 662e 746f 7461 6c5f    if self.total_
-00019b40: 6e74 6872 6561 6473 203d 3d20 3020 6f72  nthreads == 0 or
-00019b50: 2077 732e 7374 6174 7573 203d 3d20 5374   ws.status == St
-00019b60: 6174 7573 2e63 6c6f 7365 643a 0a20 2020  atus.closed:.   
-00019b70: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00019b80: 2020 2020 2020 2020 6966 206f 6363 203c          if occ <
-00019b90: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00019ba0: 6f63 6320 3d20 7773 2e6f 6363 7570 616e  occ = ws.occupan
-00019bb0: 6379 0a0a 2020 2020 2020 2020 7020 3d20  cy..        p = 
-00019bc0: 6c65 6e28 7773 2e70 726f 6365 7373 696e  len(ws.processin
-00019bd0: 6729 0a0a 2020 2020 2020 2020 7365 6c66  g)..        self
-00019be0: 2e73 6174 7572 6174 6564 2e64 6973 6361  .saturated.disca
-00019bf0: 7264 2877 7329 0a20 2020 2020 2020 2069  rd(ws).        i
-00019c00: 6620 7773 2e73 7461 7475 7320 213d 2053  f ws.status != S
-00019c10: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-00019c20: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00019c30: 6964 6c65 2e70 6f70 2877 732e 6164 6472  idle.pop(ws.addr
-00019c40: 6573 732c 204e 6f6e 6529 0a20 2020 2020  ess, None).     
-00019c50: 2020 2065 6c69 6620 7365 6c66 2e69 735f     elif self.is_
-00019c60: 756e 6f63 6375 7069 6564 2877 732c 206f  unoccupied(ws, o
-00019c70: 6363 2c20 7029 3a0a 2020 2020 2020 2020  cc, p):.        
-00019c80: 2020 2020 7365 6c66 2e69 646c 655b 7773      self.idle[ws
-00019c90: 2e61 6464 7265 7373 5d20 3d20 7773 0a20  .address] = ws. 
-00019ca0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00019cb0: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
-00019cc0: 6c65 2e70 6f70 2877 732e 6164 6472 6573  le.pop(ws.addres
-00019cd0: 732c 204e 6f6e 6529 0a20 2020 2020 2020  s, None).       
-00019ce0: 2020 2020 206e 6320 3d20 7773 2e6e 7468       nc = ws.nth
-00019cf0: 7265 6164 730a 2020 2020 2020 2020 2020  reads.          
-00019d00: 2020 6966 2070 203e 206e 633a 0a20 2020    if p > nc:.   
-00019d10: 2020 2020 2020 2020 2020 2020 2070 656e               pen
-00019d20: 6469 6e67 203d 206f 6363 202a 2028 7020  ding = occ * (p 
-00019d30: 2d20 6e63 2920 2f20 2870 202a 206e 6329  - nc) / (p * nc)
-00019d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019d50: 2069 6620 302e 3420 3c20 7065 6e64 696e   if 0.4 < pendin
-00019d60: 6720 3e20 312e 3920 2a20 2873 656c 662e  g > 1.9 * (self.
-00019d70: 746f 7461 6c5f 6f63 6375 7061 6e63 7920  total_occupancy 
-00019d80: 2f20 7365 6c66 2e74 6f74 616c 5f6e 7468  / self.total_nth
-00019d90: 7265 6164 7329 3a0a 2020 2020 2020 2020  reads):.        
-00019da0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00019db0: 2e73 6174 7572 6174 6564 2e61 6464 2877  .saturated.add(w
-00019dc0: 7329 0a0a 2020 2020 2020 2020 6966 206e  s)..        if n
-00019dd0: 6f74 205f 776f 726b 6572 5f66 756c 6c28  ot _worker_full(
-00019de0: 7773 2c20 7365 6c66 2e57 4f52 4b45 525f  ws, self.WORKER_
-00019df0: 5341 5455 5241 5449 4f4e 2920 616e 6420  SATURATION) and 
-00019e00: 7773 2e73 7461 7475 7320 3d3d 2053 7461  ws.status == Sta
-00019e10: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
-00019e20: 2020 2020 2020 2020 2073 656c 662e 6964           self.id
-00019e30: 6c65 5f74 6173 6b5f 636f 756e 742e 6164  le_task_count.ad
-00019e40: 6428 7773 290a 2020 2020 2020 2020 656c  d(ws).        el
-00019e50: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00019e60: 7365 6c66 2e69 646c 655f 7461 736b 5f63  self.idle_task_c
-00019e70: 6f75 6e74 2e64 6973 6361 7264 2877 7329  ount.discard(ws)
-00019e80: 0a0a 2020 2020 6465 6620 6973 5f75 6e6f  ..    def is_uno
-00019e90: 6363 7570 6965 6428 0a20 2020 2020 2020  ccupied(.       
-00019ea0: 2073 656c 662c 2077 733a 2057 6f72 6b65   self, ws: Worke
-00019eb0: 7253 7461 7465 2c20 6f63 6375 7061 6e63  rState, occupanc
-00019ec0: 793a 2066 6c6f 6174 2c20 6e70 726f 6365  y: float, nproce
-00019ed0: 7373 696e 673a 2069 6e74 0a20 2020 2029  ssing: int.    )
-00019ee0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-00019ef0: 2020 6e74 6872 6561 6473 203d 2077 732e    nthreads = ws.
-00019f00: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
-00019f10: 2072 6574 7572 6e20 280a 2020 2020 2020   return (.      
-00019f20: 2020 2020 2020 6e70 726f 6365 7373 696e        nprocessin
-00019f30: 6720 3c20 6e74 6872 6561 6473 0a20 2020  g < nthreads.   
-00019f40: 2020 2020 2020 2020 206f 7220 6f63 6375           or occu
-00019f50: 7061 6e63 7920 3c20 6e74 6872 6561 6473  pancy < nthreads
-00019f60: 202a 2028 7365 6c66 2e74 6f74 616c 5f6f   * (self.total_o
-00019f70: 6363 7570 616e 6379 202f 2073 656c 662e  ccupancy / self.
-00019f80: 746f 7461 6c5f 6e74 6872 6561 6473 2920  total_nthreads) 
-00019f90: 2f20 320a 2020 2020 2020 2020 290a 0a20  / 2.        ).. 
-00019fa0: 2020 2064 6566 2067 6574 5f63 6f6d 6d5f     def get_comm_
-00019fb0: 636f 7374 2873 656c 662c 2074 733a 2054  cost(self, ts: T
-00019fc0: 6173 6b53 7461 7465 2c20 7773 3a20 576f  askState, ws: Wo
-00019fd0: 726b 6572 5374 6174 6529 202d 3e20 666c  rkerState) -> fl
-00019fe0: 6f61 743a 0a20 2020 2020 2020 2022 2222  oat:.        """
-00019ff0: 0a20 2020 2020 2020 2047 6574 2074 6865  .        Get the
-0001a000: 2065 7374 696d 6174 6564 2063 6f6d 6d75   estimated commu
-0001a010: 6e69 6361 7469 6f6e 2063 6f73 7420 2869  nication cost (i
-0001a020: 6e20 732e 2920 746f 2063 6f6d 7075 7465  n s.) to compute
-0001a030: 2074 6865 2074 6173 6b0a 2020 2020 2020   the task.      
-0001a040: 2020 6f6e 2074 6865 2067 6976 656e 2077    on the given w
-0001a050: 6f72 6b65 722e 0a20 2020 2020 2020 2022  orker..        "
-0001a060: 2222 0a20 2020 2020 2020 2069 6620 3130  "".        if 10
-0001a070: 202a 206c 656e 2874 732e 6465 7065 6e64   * len(ts.depend
-0001a080: 656e 6369 6573 2920 3c20 6c65 6e28 7773  encies) < len(ws
-0001a090: 2e68 6173 5f77 6861 7429 3a0a 2020 2020  .has_what):.    
-0001a0a0: 2020 2020 2020 2020 2320 496e 2074 6865          # In the
-0001a0b0: 2063 6f6d 6d6f 6e20 6361 7365 2077 6865   common case whe
-0001a0c0: 7265 2074 6865 206e 756d 6265 7220 6f66  re the number of
-0001a0d0: 2064 6570 656e 6465 6e63 6965 7320 6973   dependencies is
-0001a0e0: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
-0001a0f0: 7563 6820 6c65 7373 2074 6861 6e20 7468  uch less than th
-0001a100: 6520 6e75 6d62 6572 206f 6620 7461 736b  e number of task
-0001a110: 7320 7468 6174 2077 6520 6861 7665 2c0a  s that we have,.
-0001a120: 2020 2020 2020 2020 2020 2020 2320 636f              # co
-0001a130: 6e73 7472 7563 7420 7468 6520 7365 7420  nstruct the set 
-0001a140: 6f66 2064 6570 7320 7468 6174 2072 6571  of deps that req
-0001a150: 7569 7265 2063 6f6d 6d75 6e69 6361 7469  uire communicati
-0001a160: 6f6e 2069 6e0a 2020 2020 2020 2020 2020  on in.          
-0001a170: 2020 2320 4f28 6c65 6e28 6465 7065 6e64    # O(len(depend
-0001a180: 656e 6369 6573 2929 2072 6174 6865 7220  encies)) rather 
-0001a190: 7468 616e 204f 286c 656e 2868 6173 5f77  than O(len(has_w
-0001a1a0: 6861 7429 2920 7469 6d65 2e0a 2020 2020  hat)) time..    
-0001a1b0: 2020 2020 2020 2020 2320 4661 6374 6f72          # Factor
-0001a1c0: 206f 6620 3130 2069 7320 6120 6775 6573   of 10 is a gues
-0001a1d0: 7320 6174 2074 6865 206f 7665 7268 6561  s at the overhea
-0001a1e0: 6420 6f66 2065 7870 6c69 6369 740a 2020  d of explicit.  
-0001a1f0: 2020 2020 2020 2020 2020 2320 6974 6572            # iter
-0001a200: 6174 696f 6e20 6173 206f 7070 6f73 6564  ation as opposed
-0001a210: 2074 6f20 6a75 7374 2063 616c 6c69 6e67   to just calling
-0001a220: 2073 6574 2e64 6966 6665 7265 6e63 650a   set.difference.
-0001a230: 2020 2020 2020 2020 2020 2020 6465 7073              deps
-0001a240: 203d 207b 6465 7020 666f 7220 6465 7020   = {dep for dep 
-0001a250: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
-0001a260: 6573 2069 6620 6465 7020 6e6f 7420 696e  es if dep not in
-0001a270: 2077 732e 6861 735f 7768 6174 7d0a 2020   ws.has_what}.  
-0001a280: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001a290: 2020 2020 2020 2020 6465 7073 203d 2028          deps = (
-0001a2a0: 7473 2e64 6570 656e 6465 6e63 6965 7320  ts.dependencies 
-0001a2b0: 6f72 2073 6574 2829 292e 6469 6666 6572  or set()).differ
-0001a2c0: 656e 6365 2877 732e 6861 735f 7768 6174  ence(ws.has_what
-0001a2d0: 290a 2020 2020 2020 2020 6e62 7974 6573  ).        nbytes
-0001a2e0: 203d 2073 756d 2864 7473 2e6e 6279 7465   = sum(dts.nbyte
-0001a2f0: 7320 666f 7220 6474 7320 696e 2064 6570  s for dts in dep
-0001a300: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
-0001a310: 6e20 6e62 7974 6573 202f 2073 656c 662e  n nbytes / self.
-0001a320: 6261 6e64 7769 6474 680a 0a20 2020 2064  bandwidth..    d
-0001a330: 6566 2067 6574 5f74 6173 6b5f 6475 7261  ef get_task_dura
-0001a340: 7469 6f6e 2873 656c 662c 2074 733a 2054  tion(self, ts: T
-0001a350: 6173 6b53 7461 7465 2920 2d3e 2066 6c6f  askState) -> flo
-0001a360: 6174 3a0a 2020 2020 2020 2020 2222 2247  at:.        """G
-0001a370: 6574 2074 6865 2065 7374 696d 6174 6564  et the estimated
-0001a380: 2063 6f6d 7075 7461 7469 6f6e 2063 6f73   computation cos
-0001a390: 7420 6f66 2074 6865 2067 6976 656e 2074  t of the given t
-0001a3a0: 6173 6b20 286e 6f74 2069 6e63 6c75 6469  ask (not includi
-0001a3b0: 6e67 0a20 2020 2020 2020 2061 6e79 2063  ng.        any c
-0001a3c0: 6f6d 6d75 6e69 6361 7469 6f6e 2063 6f73  ommunication cos
-0001a3d0: 7429 2e0a 0a20 2020 2020 2020 2049 6620  t)...        If 
-0001a3e0: 6e6f 2064 6174 6120 6861 7320 6265 656e  no data has been
-0001a3f0: 206f 6273 6572 7665 642c 2076 616c 7565   observed, value
-0001a400: 206f 660a 2020 2020 2020 2020 6064 6973   of.        `dis
-0001a410: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-0001a420: 6572 2e64 6566 6175 6c74 2d74 6173 6b2d  er.default-task-
-0001a430: 6475 7261 7469 6f6e 7360 2061 7265 2075  durations` are u
-0001a440: 7365 642e 2049 6620 6e6f 6e65 2069 7320  sed. If none is 
-0001a450: 7365 740a 2020 2020 2020 2020 666f 7220  set.        for 
-0001a460: 7468 6973 2074 6173 6b2c 2060 6469 7374  this task, `dist
-0001a470: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-0001a480: 722e 756e 6b6e 6f77 6e2d 7461 736b 2d64  r.unknown-task-d
-0001a490: 7572 6174 696f 6e60 2069 7320 7573 6564  uration` is used
-0001a4a0: 0a20 2020 2020 2020 2069 6e73 7465 6164  .        instead
-0001a4b0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0001a4c0: 2020 2020 2020 6475 7261 7469 6f6e 3a20        duration: 
-0001a4d0: 666c 6f61 7420 3d20 7473 2e70 7265 6669  float = ts.prefi
-0001a4e0: 782e 6475 7261 7469 6f6e 5f61 7665 7261  x.duration_avera
-0001a4f0: 6765 0a20 2020 2020 2020 2069 6620 6475  ge.        if du
-0001a500: 7261 7469 6f6e 203e 3d20 303a 0a20 2020  ration >= 0:.   
-0001a510: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001a520: 6475 7261 7469 6f6e 0a0a 2020 2020 2020  duration..      
-0001a530: 2020 7320 3d20 7365 6c66 2e75 6e6b 6e6f    s = self.unkno
-0001a540: 776e 5f64 7572 6174 696f 6e73 2e67 6574  wn_durations.get
-0001a550: 2874 732e 7072 6566 6978 2e6e 616d 6529  (ts.prefix.name)
-0001a560: 0a20 2020 2020 2020 2069 6620 7320 6973  .        if s is
-0001a570: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001a580: 2020 2073 656c 662e 756e 6b6e 6f77 6e5f     self.unknown_
-0001a590: 6475 7261 7469 6f6e 735b 7473 2e70 7265  durations[ts.pre
-0001a5a0: 6669 782e 6e61 6d65 5d20 3d20 7320 3d20  fix.name] = s = 
-0001a5b0: 7365 7428 290a 2020 2020 2020 2020 732e  set().        s.
-0001a5c0: 6164 6428 7473 290a 2020 2020 2020 2020  add(ts).        
-0001a5d0: 7265 7475 726e 2073 656c 662e 554e 4b4e  return self.UNKN
-0001a5e0: 4f57 4e5f 5441 534b 5f44 5552 4154 494f  OWN_TASK_DURATIO
-0001a5f0: 4e0a 0a20 2020 2064 6566 2076 616c 6964  N..    def valid
-0001a600: 5f77 6f72 6b65 7273 2873 656c 662c 2074  _workers(self, t
-0001a610: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
-0001a620: 2073 6574 5b57 6f72 6b65 7253 7461 7465   set[WorkerState
-0001a630: 5d20 7c20 4e6f 6e65 3a0a 2020 2020 2020  ] | None:.      
-0001a640: 2020 2222 2252 6574 7572 6e20 7365 7420    """Return set 
-0001a650: 6f66 2063 7572 7265 6e74 6c79 2076 616c  of currently val
-0001a660: 6964 2077 6f72 6b65 7273 2066 6f72 206b  id workers for k
-0001a670: 6579 0a0a 2020 2020 2020 2020 4966 2061  ey..        If a
-0001a680: 6c6c 2077 6f72 6b65 7273 2061 7265 2076  ll workers are v
-0001a690: 616c 6964 2074 6865 6e20 7468 6973 2072  alid then this r
-0001a6a0: 6574 7572 6e73 2060 604e 6f6e 6560 602c  eturns ``None``,
-0001a6b0: 2069 6e20 7768 6963 6820 6361 7365 0a20   in which case. 
-0001a6c0: 2020 2020 2020 2061 6e79 202a 7275 6e6e         any *runn
-0001a6d0: 696e 672a 2077 6f72 6b65 7220 6361 6e20  ing* worker can 
-0001a6e0: 6265 2075 7365 642e 0a20 2020 2020 2020  be used..       
-0001a6f0: 204f 7468 6572 7769 7365 2c20 7468 6520   Otherwise, the 
-0001a700: 7375 6273 6574 206f 6620 7275 6e6e 696e  subset of runnin
-0001a710: 6720 776f 726b 6572 7320 7661 6c69 6420  g workers valid 
-0001a720: 666f 7220 7468 6973 2074 6173 6b0a 2020  for this task.  
-0001a730: 2020 2020 2020 6973 2072 6574 7572 6e65        is returne
-0001a740: 642e 0a20 2020 2020 2020 2054 6869 7320  d..        This 
-0001a750: 6368 6563 6b73 2074 7261 636b 7320 7468  checks tracks th
-0001a760: 6520 666f 6c6c 6f77 696e 6720 7374 6174  e following stat
-0001a770: 653a 0a0a 2020 2020 2020 2020 2a20 2077  e:..        *  w
-0001a780: 6f72 6b65 725f 7265 7374 7269 6374 696f  orker_restrictio
-0001a790: 6e73 0a20 2020 2020 2020 202a 2020 686f  ns.        *  ho
-0001a7a0: 7374 5f72 6573 7472 6963 7469 6f6e 730a  st_restrictions.
-0001a7b0: 2020 2020 2020 2020 2a20 2072 6573 6f75          *  resou
-0001a7c0: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
-0001a7d0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0001a7e0: 2020 2020 2073 3a20 7365 745b 7374 725d       s: set[str]
-0001a7f0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 0a0a   | None = None..
-0001a800: 2020 2020 2020 2020 6966 2074 732e 776f          if ts.wo
-0001a810: 726b 6572 5f72 6573 7472 6963 7469 6f6e  rker_restriction
-0001a820: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
-0001a830: 203d 207b 6164 6472 2066 6f72 2061 6464   = {addr for add
-0001a840: 7220 696e 2074 732e 776f 726b 6572 5f72  r in ts.worker_r
-0001a850: 6573 7472 6963 7469 6f6e 7320 6966 2061  estrictions if a
-0001a860: 6464 7220 696e 2073 656c 662e 776f 726b  ddr in self.work
-0001a870: 6572 737d 0a0a 2020 2020 2020 2020 6966  ers}..        if
-0001a880: 2074 732e 686f 7374 5f72 6573 7472 6963   ts.host_restric
-0001a890: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-0001a8a0: 2020 2023 2052 6573 6f6c 7665 2074 6865     # Resolve the
-0001a8b0: 2061 6c69 6173 2068 6572 6520 7261 7468   alias here rath
-0001a8c0: 6572 2074 6861 6e20 6561 726c 792c 2066  er than early, f
-0001a8d0: 6f72 2074 6865 2077 6f72 6b65 720a 2020  or the worker.  
-0001a8e0: 2020 2020 2020 2020 2020 2320 6d61 7920            # may 
-0001a8f0: 6e6f 7420 6265 2063 6f6e 6e65 6374 6564  not be connected
-0001a900: 2077 6865 6e20 686f 7374 5f72 6573 7472   when host_restr
-0001a910: 6963 7469 6f6e 7320 6973 2070 6f70 756c  ictions is popul
-0001a920: 6174 6564 0a20 2020 2020 2020 2020 2020  ated.           
-0001a930: 2068 7220 3d20 5b73 656c 662e 636f 6572   hr = [self.coer
-0001a940: 6365 5f68 6f73 746e 616d 6528 6829 2066  ce_hostname(h) f
-0001a950: 6f72 2068 2069 6e20 7473 2e68 6f73 745f  or h in ts.host_
-0001a960: 7265 7374 7269 6374 696f 6e73 5d0a 2020  restrictions].  
-0001a970: 2020 2020 2020 2020 2020 2320 5858 5820            # XXX 
-0001a980: 6e65 6564 2048 6f73 7453 7461 7465 3f0a  need HostState?.
-0001a990: 2020 2020 2020 2020 2020 2020 736c 203d              sl =
-0001a9a0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-0001a9b0: 666f 7220 6820 696e 2068 723a 0a20 2020  for h in hr:.   
-0001a9c0: 2020 2020 2020 2020 2020 2020 2064 6820               dh 
-0001a9d0: 3d20 7365 6c66 2e68 6f73 745f 696e 666f  = self.host_info
-0001a9e0: 2e67 6574 2868 290a 2020 2020 2020 2020  .get(h).        
-0001a9f0: 2020 2020 2020 2020 6966 2064 6820 6973          if dh is
-0001aa00: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0001aa10: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001aa20: 6c2e 6170 7065 6e64 2864 685b 2261 6464  l.append(dh["add
-0001aa30: 7265 7373 6573 225d 290a 0a20 2020 2020  resses"])..     
-0001aa40: 2020 2020 2020 2073 7320 3d20 7365 742e         ss = set.
-0001aa50: 756e 696f 6e28 2a73 6c29 2069 6620 736c  union(*sl) if sl
-0001aa60: 2065 6c73 6520 7365 7428 290a 2020 2020   else set().    
-0001aa70: 2020 2020 2020 2020 6966 2073 2069 7320          if s is 
-0001aa80: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001aa90: 2020 2020 2020 7320 3d20 7373 0a20 2020        s = ss.   
-0001aaa0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001aab0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001aac0: 207c 3d20 7373 0a0a 2020 2020 2020 2020   |= ss..        
-0001aad0: 6966 2074 732e 7265 736f 7572 6365 5f72  if ts.resource_r
-0001aae0: 6573 7472 6963 7469 6f6e 733a 0a20 2020  estrictions:.   
-0001aaf0: 2020 2020 2020 2020 2064 7720 3d20 7b7d           dw = {}
-0001ab00: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-0001ab10: 2072 6573 6f75 7263 652c 2072 6571 7569   resource, requi
-0001ab20: 7265 6420 696e 2074 732e 7265 736f 7572  red in ts.resour
-0001ab30: 6365 5f72 6573 7472 6963 7469 6f6e 732e  ce_restrictions.
-0001ab40: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-0001ab50: 2020 2020 2020 2020 2064 7220 3d20 7365           dr = se
-0001ab60: 6c66 2e72 6573 6f75 7263 6573 2e67 6574  lf.resources.get
-0001ab70: 2872 6573 6f75 7263 6529 0a20 2020 2020  (resource).     
-0001ab80: 2020 2020 2020 2020 2020 2069 6620 6472             if dr
-0001ab90: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-0001aba0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0001abb0: 6c66 2e72 6573 6f75 7263 6573 5b72 6573  lf.resources[res
-0001abc0: 6f75 7263 655d 203d 2064 7220 3d20 7b7d  ource] = dr = {}
-0001abd0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001abe0: 2020 7377 203d 2073 6574 2829 0a20 2020    sw = set().   
-0001abf0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0001ac00: 2061 6464 722c 2073 7570 706c 6965 6420   addr, supplied 
-0001ac10: 696e 2064 722e 6974 656d 7328 293a 0a20  in dr.items():. 
-0001ac20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac30: 2020 2069 6620 7375 7070 6c69 6564 203e     if supplied >
-0001ac40: 3d20 7265 7175 6972 6564 3a0a 2020 2020  = required:.    
+000193e0: 2323 2323 2323 2323 230a 2020 2020 2320  #########.    # 
+000193f0: 4173 7369 676e 696e 6720 5461 736b 7320  Assigning Tasks 
+00019400: 746f 2057 6f72 6b65 7273 2023 0a20 2020  to Workers #.   
+00019410: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00019420: 2323 2323 2323 2323 2323 2323 2323 230a  ###############.
+00019430: 0a20 2020 2064 6566 2069 735f 726f 6f74  .    def is_root
+00019440: 6973 6828 7365 6c66 2c20 7473 3a20 5461  ish(self, ts: Ta
+00019450: 736b 5374 6174 6529 202d 3e20 626f 6f6c  skState) -> bool
+00019460: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00019470: 2020 2020 2020 5768 6574 6865 7220 6060        Whether ``
+00019480: 7473 6060 2069 7320 6120 726f 6f74 206f  ts`` is a root o
+00019490: 7220 726f 6f74 2d6c 696b 6520 7461 736b  r root-like task
+000194a0: 2e0a 0a20 2020 2020 2020 2052 6f6f 742d  ...        Root-
+000194b0: 6973 6820 7461 736b 7320 6172 6520 7061  ish tasks are pa
+000194c0: 7274 206f 6620 6120 6772 6f75 7020 7468  rt of a group th
+000194d0: 6174 2773 206d 7563 6820 6c61 7267 6572  at's much larger
+000194e0: 2074 6861 6e20 7468 6520 636c 7573 7465   than the cluste
+000194f0: 722c 0a20 2020 2020 2020 2061 6e64 2068  r,.        and h
+00019500: 6176 6520 6665 7720 6f72 206e 6f20 6465  ave few or no de
+00019510: 7065 6e64 656e 6369 6573 2e20 5461 736b  pendencies. Task
+00019520: 7320 6d61 7920 616c 736f 2062 6520 6578  s may also be ex
+00019530: 706c 6963 6974 6c79 206d 6172 6b65 6420  plicitly marked 
+00019540: 6173 2072 6f6f 7469 7368 0a20 2020 2020  as rootish.     
+00019550: 2020 2074 6f20 6f76 6572 7269 6465 2074     to override t
+00019560: 6869 7320 6865 7572 6973 7469 632e 0a20  his heuristic.. 
+00019570: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00019580: 2020 2069 6620 7473 2e5f 726f 6f74 6973     if ts._rootis
+00019590: 6820 6973 206e 6f74 204e 6f6e 653a 0a20  h is not None:. 
+000195a0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+000195b0: 6e20 7473 2e5f 726f 6f74 6973 680a 2020  n ts._rootish.  
+000195c0: 2020 2020 2020 6966 2074 732e 7265 736f        if ts.reso
+000195d0: 7572 6365 5f72 6573 7472 6963 7469 6f6e  urce_restriction
+000195e0: 7320 6f72 2074 732e 776f 726b 6572 5f72  s or ts.worker_r
+000195f0: 6573 7472 6963 7469 6f6e 7320 6f72 2074  estrictions or t
+00019600: 732e 686f 7374 5f72 6573 7472 6963 7469  s.host_restricti
+00019610: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
+00019620: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
+00019630: 2020 2020 2020 7467 203d 2074 732e 6772        tg = ts.gr
+00019640: 6f75 700a 2020 2020 2020 2020 2320 544f  oup.        # TO
+00019650: 444f 2073 686f 7274 2d63 6972 6375 6974  DO short-circuit
+00019660: 2074 6f20 5472 7565 2069 6620 606e 6f74   to True if `not
+00019670: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+00019680: 603f 0a20 2020 2020 2020 2072 6574 7572  `?.        retur
+00019690: 6e20 280a 2020 2020 2020 2020 2020 2020  n (.            
+000196a0: 6c65 6e28 7467 2920 3e20 7365 6c66 2e74  len(tg) > self.t
+000196b0: 6f74 616c 5f6e 7468 7265 6164 7320 2a20  otal_nthreads * 
+000196c0: 320a 2020 2020 2020 2020 2020 2020 616e  2.            an
+000196d0: 6420 6c65 6e28 7467 2e64 6570 656e 6465  d len(tg.depende
+000196e0: 6e63 6965 7329 203c 2035 0a20 2020 2020  ncies) < 5.     
+000196f0: 2020 2020 2020 2061 6e64 2073 756d 286d         and sum(m
+00019700: 6170 286c 656e 2c20 7467 2e64 6570 656e  ap(len, tg.depen
+00019710: 6465 6e63 6965 7329 2920 3c20 350a 2020  dencies)) < 5.  
+00019720: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
+00019730: 2063 6865 636b 5f69 646c 655f 7361 7475   check_idle_satu
+00019740: 7261 7465 6428 7365 6c66 2c20 7773 3a20  rated(self, ws: 
+00019750: 576f 726b 6572 5374 6174 652c 206f 6363  WorkerState, occ
+00019760: 3a20 666c 6f61 7420 3d20 2d31 2e30 2920  : float = -1.0) 
+00019770: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00019780: 2022 2222 5570 6461 7465 2074 6865 2073   """Update the s
+00019790: 7461 7475 7320 6f66 2074 6865 2069 646c  tatus of the idl
+000197a0: 6520 616e 6420 7361 7475 7261 7465 6420  e and saturated 
+000197b0: 7374 6174 650a 0a20 2020 2020 2020 2054  state..        T
+000197c0: 6865 2073 6368 6564 756c 6572 206b 6565  he scheduler kee
+000197d0: 7073 2074 7261 636b 206f 6620 776f 726b  ps track of work
+000197e0: 6572 7320 7468 6174 2061 7265 202e 2e0a  ers that are ...
+000197f0: 0a20 2020 2020 2020 202d 2020 5361 7475  .        -  Satu
+00019800: 7261 7465 643a 2068 6176 6520 656e 6f75  rated: have enou
+00019810: 6768 2077 6f72 6b20 746f 2073 7461 7920  gh work to stay 
+00019820: 6275 7379 0a20 2020 2020 2020 202d 2020  busy.        -  
+00019830: 4964 6c65 3a20 646f 206e 6f74 2068 6176  Idle: do not hav
+00019840: 6520 656e 6f75 6768 2077 6f72 6b20 746f  e enough work to
+00019850: 2073 7461 7920 6275 7379 0a0a 2020 2020   stay busy..    
+00019860: 2020 2020 5468 6579 2061 7265 2063 6f6e      They are con
+00019870: 7369 6465 7265 6420 7361 7475 7261 7465  sidered saturate
+00019880: 6420 6966 2074 6865 7920 626f 7468 2068  d if they both h
+00019890: 6176 6520 656e 6f75 6768 2074 6173 6b73  ave enough tasks
+000198a0: 2074 6f20 6f63 6375 7079 0a20 2020 2020   to occupy.     
+000198b0: 2020 2061 6c6c 206f 6620 7468 6569 7220     all of their 
+000198c0: 7468 7265 6164 732c 2061 6e64 2069 6620  threads, and if 
+000198d0: 7468 6520 6578 7065 6374 6564 2072 756e  the expected run
+000198e0: 7469 6d65 206f 6620 7468 6f73 6520 7461  time of those ta
+000198f0: 736b 7320 6973 0a20 2020 2020 2020 206c  sks is.        l
+00019900: 6172 6765 2065 6e6f 7567 682e 0a0a 2020  arge enough...  
+00019910: 2020 2020 2020 4966 2060 6064 6973 7472        If ``distr
+00019920: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+00019930: 2e77 6f72 6b65 722d 7361 7475 7261 7469  .worker-saturati
+00019940: 6f6e 6060 2069 7320 6e6f 7420 6060 696e  on`` is not ``in
+00019950: 6660 600a 2020 2020 2020 2020 2873 6368  f``.        (sch
+00019960: 6564 756c 6572 2d73 6964 6520 7175 6575  eduler-side queu
+00019970: 696e 6720 6973 2065 6e61 626c 6564 292c  ing is enabled),
+00019980: 2074 6865 7920 6172 6520 636f 6e73 6964   they are consid
+00019990: 6572 6564 2069 646c 650a 2020 2020 2020  ered idle.      
+000199a0: 2020 6966 2074 6865 7920 6861 7665 2066    if they have f
+000199b0: 6577 6572 2074 6173 6b73 2070 726f 6365  ewer tasks proce
+000199c0: 7373 696e 6720 7468 616e 2074 6865 2060  ssing than the `
+000199d0: 6077 6f72 6b65 722d 7361 7475 7261 7469  `worker-saturati
+000199e0: 6f6e 6060 0a20 2020 2020 2020 2074 6872  on``.        thr
+000199f0: 6573 686f 6c64 2064 6963 7461 7465 732e  eshold dictates.
+00019a00: 0a0a 2020 2020 2020 2020 4f74 6865 7277  ..        Otherw
+00019a10: 6973 652c 2074 6865 7920 6172 6520 636f  ise, they are co
+00019a20: 6e73 6964 6572 6564 2069 646c 6520 6966  nsidered idle if
+00019a30: 2074 6865 7920 6861 7665 2066 6577 6572   they have fewer
+00019a40: 2074 6173 6b73 2070 726f 6365 7373 696e   tasks processin
+00019a50: 670a 2020 2020 2020 2020 7468 616e 2074  g.        than t
+00019a60: 6872 6561 6473 2c20 6f72 2069 6620 7468  hreads, or if th
+00019a70: 6569 7220 7461 736b 7327 2074 6f74 616c  eir tasks' total
+00019a80: 2065 7870 6563 7465 6420 7275 6e74 696d   expected runtim
+00019a90: 6520 6973 206c 6573 7320 7468 616e 2068  e is less than h
+00019aa0: 616c 660a 2020 2020 2020 2020 7468 6520  alf.        the 
+00019ab0: 6578 7065 6374 6564 2072 756e 7469 6d65  expected runtime
+00019ac0: 206f 6620 7468 6520 7361 6d65 206e 756d   of the same num
+00019ad0: 6265 7220 6f66 2061 7665 7261 6765 2074  ber of average t
+00019ae0: 6173 6b73 2e0a 0a20 2020 2020 2020 2054  asks...        T
+00019af0: 6869 7320 6973 2075 7365 6675 6c20 666f  his is useful fo
+00019b00: 7220 6c6f 6164 2062 616c 616e 6369 6e67  r load balancing
+00019b10: 2061 6e64 2061 6461 7074 6976 6974 792e   and adaptivity.
+00019b20: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00019b30: 2020 2020 2069 6620 7365 6c66 2e74 6f74       if self.tot
+00019b40: 616c 5f6e 7468 7265 6164 7320 3d3d 2030  al_nthreads == 0
+00019b50: 206f 7220 7773 2e73 7461 7475 7320 3d3d   or ws.status ==
+00019b60: 2053 7461 7475 732e 636c 6f73 6564 3a0a   Status.closed:.
+00019b70: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00019b80: 726e 0a20 2020 2020 2020 2069 6620 6f63  rn.        if oc
+00019b90: 6320 3c20 303a 0a20 2020 2020 2020 2020  c < 0:.         
+00019ba0: 2020 206f 6363 203d 2077 732e 6f63 6375     occ = ws.occu
+00019bb0: 7061 6e63 790a 0a20 2020 2020 2020 2070  pancy..        p
+00019bc0: 203d 206c 656e 2877 732e 7072 6f63 6573   = len(ws.proces
+00019bd0: 7369 6e67 290a 0a20 2020 2020 2020 2073  sing)..        s
+00019be0: 656c 662e 7361 7475 7261 7465 642e 6469  elf.saturated.di
+00019bf0: 7363 6172 6428 7773 290a 2020 2020 2020  scard(ws).      
+00019c00: 2020 6966 2077 732e 7374 6174 7573 2021    if ws.status !
+00019c10: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
+00019c20: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00019c30: 6c66 2e69 646c 652e 706f 7028 7773 2e61  lf.idle.pop(ws.a
+00019c40: 6464 7265 7373 2c20 4e6f 6e65 290a 2020  ddress, None).  
+00019c50: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
+00019c60: 6973 5f75 6e6f 6363 7570 6965 6428 7773  is_unoccupied(ws
+00019c70: 2c20 6f63 632c 2070 293a 0a20 2020 2020  , occ, p):.     
+00019c80: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+00019c90: 5b77 732e 6164 6472 6573 735d 203d 2077  [ws.address] = w
+00019ca0: 730a 2020 2020 2020 2020 656c 7365 3a0a  s.        else:.
+00019cb0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019cc0: 2e69 646c 652e 706f 7028 7773 2e61 6464  .idle.pop(ws.add
+00019cd0: 7265 7373 2c20 4e6f 6e65 290a 2020 2020  ress, None).    
+00019ce0: 2020 2020 2020 2020 6e63 203d 2077 732e          nc = ws.
+00019cf0: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
+00019d00: 2020 2020 2069 6620 7020 3e20 6e63 3a0a       if p > nc:.
+00019d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d20: 7065 6e64 696e 6720 3d20 6f63 6320 2a20  pending = occ * 
+00019d30: 2870 202d 206e 6329 202f 2028 7020 2a20  (p - nc) / (p * 
+00019d40: 6e63 290a 2020 2020 2020 2020 2020 2020  nc).            
+00019d50: 2020 2020 6966 2030 2e34 203c 2070 656e      if 0.4 < pen
+00019d60: 6469 6e67 203e 2031 2e39 202a 2028 7365  ding > 1.9 * (se
+00019d70: 6c66 2e74 6f74 616c 5f6f 6363 7570 616e  lf.total_occupan
+00019d80: 6379 202f 2073 656c 662e 746f 7461 6c5f  cy / self.total_
+00019d90: 6e74 6872 6561 6473 293a 0a20 2020 2020  nthreads):.     
+00019da0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00019db0: 656c 662e 7361 7475 7261 7465 642e 6164  elf.saturated.ad
+00019dc0: 6428 7773 290a 0a20 2020 2020 2020 2069  d(ws)..        i
+00019dd0: 6620 6e6f 7420 5f77 6f72 6b65 725f 6675  f not _worker_fu
+00019de0: 6c6c 2877 732c 2073 656c 662e 574f 524b  ll(ws, self.WORK
+00019df0: 4552 5f53 4154 5552 4154 494f 4e29 2061  ER_SATURATION) a
+00019e00: 6e64 2077 732e 7374 6174 7573 203d 3d20  nd ws.status == 
+00019e10: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
+00019e20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00019e30: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
+00019e40: 2e61 6464 2877 7329 0a20 2020 2020 2020  .add(ws).       
+00019e50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00019e60: 2020 2073 656c 662e 6964 6c65 5f74 6173     self.idle_tas
+00019e70: 6b5f 636f 756e 742e 6469 7363 6172 6428  k_count.discard(
+00019e80: 7773 290a 0a20 2020 2064 6566 2069 735f  ws)..    def is_
+00019e90: 756e 6f63 6375 7069 6564 280a 2020 2020  unoccupied(.    
+00019ea0: 2020 2020 7365 6c66 2c20 7773 3a20 576f      self, ws: Wo
+00019eb0: 726b 6572 5374 6174 652c 206f 6363 7570  rkerState, occup
+00019ec0: 616e 6379 3a20 666c 6f61 742c 206e 7072  ancy: float, npr
+00019ed0: 6f63 6573 7369 6e67 3a20 696e 740a 2020  ocessing: int.  
+00019ee0: 2020 2920 2d3e 2062 6f6f 6c3a 0a20 2020    ) -> bool:.   
+00019ef0: 2020 2020 206e 7468 7265 6164 7320 3d20       nthreads = 
+00019f00: 7773 2e6e 7468 7265 6164 730a 2020 2020  ws.nthreads.    
+00019f10: 2020 2020 7265 7475 726e 2028 0a20 2020      return (.   
+00019f20: 2020 2020 2020 2020 206e 7072 6f63 6573           nproces
+00019f30: 7369 6e67 203c 206e 7468 7265 6164 730a  sing < nthreads.
+00019f40: 2020 2020 2020 2020 2020 2020 6f72 206f              or o
+00019f50: 6363 7570 616e 6379 203c 206e 7468 7265  ccupancy < nthre
+00019f60: 6164 7320 2a20 2873 656c 662e 746f 7461  ads * (self.tota
+00019f70: 6c5f 6f63 6375 7061 6e63 7920 2f20 7365  l_occupancy / se
+00019f80: 6c66 2e74 6f74 616c 5f6e 7468 7265 6164  lf.total_nthread
+00019f90: 7329 202f 2032 0a20 2020 2020 2020 2029  s) / 2.        )
+00019fa0: 0a0a 2020 2020 6465 6620 6765 745f 636f  ..    def get_co
+00019fb0: 6d6d 5f63 6f73 7428 7365 6c66 2c20 7473  mm_cost(self, ts
+00019fc0: 3a20 5461 736b 5374 6174 652c 2077 733a  : TaskState, ws:
+00019fd0: 2057 6f72 6b65 7253 7461 7465 2920 2d3e   WorkerState) ->
+00019fe0: 2066 6c6f 6174 3a0a 2020 2020 2020 2020   float:.        
+00019ff0: 2222 220a 2020 2020 2020 2020 4765 7420  """.        Get 
+0001a000: 7468 6520 6573 7469 6d61 7465 6420 636f  the estimated co
+0001a010: 6d6d 756e 6963 6174 696f 6e20 636f 7374  mmunication cost
+0001a020: 2028 696e 2073 2e29 2074 6f20 636f 6d70   (in s.) to comp
+0001a030: 7574 6520 7468 6520 7461 736b 0a20 2020  ute the task.   
+0001a040: 2020 2020 206f 6e20 7468 6520 6769 7665       on the give
+0001a050: 6e20 776f 726b 6572 2e0a 2020 2020 2020  n worker..      
+0001a060: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+0001a070: 2031 3020 2a20 6c65 6e28 7473 2e64 6570   10 * len(ts.dep
+0001a080: 656e 6465 6e63 6965 7329 203c 206c 656e  endencies) < len
+0001a090: 2877 732e 6861 735f 7768 6174 293a 0a20  (ws.has_what):. 
+0001a0a0: 2020 2020 2020 2020 2020 2023 2049 6e20             # In 
+0001a0b0: 7468 6520 636f 6d6d 6f6e 2063 6173 6520  the common case 
+0001a0c0: 7768 6572 6520 7468 6520 6e75 6d62 6572  where the number
+0001a0d0: 206f 6620 6465 7065 6e64 656e 6369 6573   of dependencies
+0001a0e0: 2069 730a 2020 2020 2020 2020 2020 2020   is.            
+0001a0f0: 2320 6d75 6368 206c 6573 7320 7468 616e  # much less than
+0001a100: 2074 6865 206e 756d 6265 7220 6f66 2074   the number of t
+0001a110: 6173 6b73 2074 6861 7420 7765 2068 6176  asks that we hav
+0001a120: 652c 0a20 2020 2020 2020 2020 2020 2023  e,.            #
+0001a130: 2063 6f6e 7374 7275 6374 2074 6865 2073   construct the s
+0001a140: 6574 206f 6620 6465 7073 2074 6861 7420  et of deps that 
+0001a150: 7265 7175 6972 6520 636f 6d6d 756e 6963  require communic
+0001a160: 6174 696f 6e20 696e 0a20 2020 2020 2020  ation in.       
+0001a170: 2020 2020 2023 204f 286c 656e 2864 6570       # O(len(dep
+0001a180: 656e 6465 6e63 6965 7329 2920 7261 7468  endencies)) rath
+0001a190: 6572 2074 6861 6e20 4f28 6c65 6e28 6861  er than O(len(ha
+0001a1a0: 735f 7768 6174 2929 2074 696d 652e 0a20  s_what)) time.. 
+0001a1b0: 2020 2020 2020 2020 2020 2023 2046 6163             # Fac
+0001a1c0: 746f 7220 6f66 2031 3020 6973 2061 2067  tor of 10 is a g
+0001a1d0: 7565 7373 2061 7420 7468 6520 6f76 6572  uess at the over
+0001a1e0: 6865 6164 206f 6620 6578 706c 6963 6974  head of explicit
+0001a1f0: 0a20 2020 2020 2020 2020 2020 2023 2069  .            # i
+0001a200: 7465 7261 7469 6f6e 2061 7320 6f70 706f  teration as oppo
+0001a210: 7365 6420 746f 206a 7573 7420 6361 6c6c  sed to just call
+0001a220: 696e 6720 7365 742e 6469 6666 6572 656e  ing set.differen
+0001a230: 6365 0a20 2020 2020 2020 2020 2020 2064  ce.            d
+0001a240: 6570 7320 3d20 7b64 6570 2066 6f72 2064  eps = {dep for d
+0001a250: 6570 2069 6e20 7473 2e64 6570 656e 6465  ep in ts.depende
+0001a260: 6e63 6965 7320 6966 2064 6570 206e 6f74  ncies if dep not
+0001a270: 2069 6e20 7773 2e68 6173 5f77 6861 747d   in ws.has_what}
+0001a280: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001a290: 2020 2020 2020 2020 2020 2064 6570 7320             deps 
+0001a2a0: 3d20 2874 732e 6465 7065 6e64 656e 6369  = (ts.dependenci
+0001a2b0: 6573 206f 7220 7365 7428 2929 2e64 6966  es or set()).dif
+0001a2c0: 6665 7265 6e63 6528 7773 2e68 6173 5f77  ference(ws.has_w
+0001a2d0: 6861 7429 0a20 2020 2020 2020 206e 6279  hat).        nby
+0001a2e0: 7465 7320 3d20 7375 6d28 6474 732e 6e62  tes = sum(dts.nb
+0001a2f0: 7974 6573 2066 6f72 2064 7473 2069 6e20  ytes for dts in 
+0001a300: 6465 7073 290a 2020 2020 2020 2020 7265  deps).        re
+0001a310: 7475 726e 206e 6279 7465 7320 2f20 7365  turn nbytes / se
+0001a320: 6c66 2e62 616e 6477 6964 7468 0a0a 2020  lf.bandwidth..  
+0001a330: 2020 6465 6620 6765 745f 7461 736b 5f64    def get_task_d
+0001a340: 7572 6174 696f 6e28 7365 6c66 2c20 7473  uration(self, ts
+0001a350: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
+0001a360: 666c 6f61 743a 0a20 2020 2020 2020 2022  float:.        "
+0001a370: 2222 4765 7420 7468 6520 6573 7469 6d61  ""Get the estima
+0001a380: 7465 6420 636f 6d70 7574 6174 696f 6e20  ted computation 
+0001a390: 636f 7374 206f 6620 7468 6520 6769 7665  cost of the give
+0001a3a0: 6e20 7461 736b 2028 6e6f 7420 696e 636c  n task (not incl
+0001a3b0: 7564 696e 670a 2020 2020 2020 2020 616e  uding.        an
+0001a3c0: 7920 636f 6d6d 756e 6963 6174 696f 6e20  y communication 
+0001a3d0: 636f 7374 292e 0a0a 2020 2020 2020 2020  cost)...        
+0001a3e0: 4966 206e 6f20 6461 7461 2068 6173 2062  If no data has b
+0001a3f0: 6565 6e20 6f62 7365 7276 6564 2c20 7661  een observed, va
+0001a400: 6c75 6520 6f66 0a20 2020 2020 2020 2060  lue of.        `
+0001a410: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+0001a420: 6475 6c65 722e 6465 6661 756c 742d 7461  duler.default-ta
+0001a430: 736b 2d64 7572 6174 696f 6e73 6020 6172  sk-durations` ar
+0001a440: 6520 7573 6564 2e20 4966 206e 6f6e 6520  e used. If none 
+0001a450: 6973 2073 6574 0a20 2020 2020 2020 2066  is set.        f
+0001a460: 6f72 2074 6869 7320 7461 736b 2c20 6064  or this task, `d
+0001a470: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0001a480: 756c 6572 2e75 6e6b 6e6f 776e 2d74 6173  uler.unknown-tas
+0001a490: 6b2d 6475 7261 7469 6f6e 6020 6973 2075  k-duration` is u
+0001a4a0: 7365 640a 2020 2020 2020 2020 696e 7374  sed.        inst
+0001a4b0: 6561 642e 0a20 2020 2020 2020 2022 2222  ead..        """
+0001a4c0: 0a20 2020 2020 2020 2064 7572 6174 696f  .        duratio
+0001a4d0: 6e3a 2066 6c6f 6174 203d 2074 732e 7072  n: float = ts.pr
+0001a4e0: 6566 6978 2e64 7572 6174 696f 6e5f 6176  efix.duration_av
+0001a4f0: 6572 6167 650a 2020 2020 2020 2020 6966  erage.        if
+0001a500: 2064 7572 6174 696f 6e20 3e3d 2030 3a0a   duration >= 0:.
+0001a510: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001a520: 726e 2064 7572 6174 696f 6e0a 0a20 2020  rn duration..   
+0001a530: 2020 2020 2073 203d 2073 656c 662e 756e       s = self.un
+0001a540: 6b6e 6f77 6e5f 6475 7261 7469 6f6e 732e  known_durations.
+0001a550: 6765 7428 7473 2e70 7265 6669 782e 6e61  get(ts.prefix.na
+0001a560: 6d65 290a 2020 2020 2020 2020 6966 2073  me).        if s
+0001a570: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001a580: 2020 2020 2020 7365 6c66 2e75 6e6b 6e6f        self.unkno
+0001a590: 776e 5f64 7572 6174 696f 6e73 5b74 732e  wn_durations[ts.
+0001a5a0: 7072 6566 6978 2e6e 616d 655d 203d 2073  prefix.name] = s
+0001a5b0: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+0001a5c0: 2073 2e61 6464 2874 7329 0a20 2020 2020   s.add(ts).     
+0001a5d0: 2020 2072 6574 7572 6e20 7365 6c66 2e55     return self.U
+0001a5e0: 4e4b 4e4f 574e 5f54 4153 4b5f 4455 5241  NKNOWN_TASK_DURA
+0001a5f0: 5449 4f4e 0a0a 2020 2020 6465 6620 7661  TION..    def va
+0001a600: 6c69 645f 776f 726b 6572 7328 7365 6c66  lid_workers(self
+0001a610: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
+0001a620: 202d 3e20 7365 745b 576f 726b 6572 5374   -> set[WorkerSt
+0001a630: 6174 655d 207c 204e 6f6e 653a 0a20 2020  ate] | None:.   
+0001a640: 2020 2020 2022 2222 5265 7475 726e 2073       """Return s
+0001a650: 6574 206f 6620 6375 7272 656e 746c 7920  et of currently 
+0001a660: 7661 6c69 6420 776f 726b 6572 7320 666f  valid workers fo
+0001a670: 7220 6b65 790a 0a20 2020 2020 2020 2049  r key..        I
+0001a680: 6620 616c 6c20 776f 726b 6572 7320 6172  f all workers ar
+0001a690: 6520 7661 6c69 6420 7468 656e 2074 6869  e valid then thi
+0001a6a0: 7320 7265 7475 726e 7320 6060 4e6f 6e65  s returns ``None
+0001a6b0: 6060 2c20 696e 2077 6869 6368 2063 6173  ``, in which cas
+0001a6c0: 650a 2020 2020 2020 2020 616e 7920 2a72  e.        any *r
+0001a6d0: 756e 6e69 6e67 2a20 776f 726b 6572 2063  unning* worker c
+0001a6e0: 616e 2062 6520 7573 6564 2e0a 2020 2020  an be used..    
+0001a6f0: 2020 2020 4f74 6865 7277 6973 652c 2074      Otherwise, t
+0001a700: 6865 2073 7562 7365 7420 6f66 2072 756e  he subset of run
+0001a710: 6e69 6e67 2077 6f72 6b65 7273 2076 616c  ning workers val
+0001a720: 6964 2066 6f72 2074 6869 7320 7461 736b  id for this task
+0001a730: 0a20 2020 2020 2020 2069 7320 7265 7475  .        is retu
+0001a740: 726e 6564 2e0a 2020 2020 2020 2020 5468  rned..        Th
+0001a750: 6973 2063 6865 636b 7320 7472 6163 6b73  is checks tracks
+0001a760: 2074 6865 2066 6f6c 6c6f 7769 6e67 2073   the following s
+0001a770: 7461 7465 3a0a 0a20 2020 2020 2020 202a  tate:..        *
+0001a780: 2020 776f 726b 6572 5f72 6573 7472 6963    worker_restric
+0001a790: 7469 6f6e 730a 2020 2020 2020 2020 2a20  tions.        * 
+0001a7a0: 2068 6f73 745f 7265 7374 7269 6374 696f   host_restrictio
+0001a7b0: 6e73 0a20 2020 2020 2020 202a 2020 7265  ns.        *  re
+0001a7c0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
+0001a7d0: 6f6e 730a 2020 2020 2020 2020 2222 220a  ons.        """.
+0001a7e0: 2020 2020 2020 2020 733a 2073 6574 5b73          s: set[s
+0001a7f0: 7472 5d20 7c20 4e6f 6e65 203d 204e 6f6e  tr] | None = Non
+0001a800: 650a 0a20 2020 2020 2020 2069 6620 7473  e..        if ts
+0001a810: 2e77 6f72 6b65 725f 7265 7374 7269 6374  .worker_restrict
+0001a820: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
+0001a830: 2020 7320 3d20 7b61 6464 7220 666f 7220    s = {addr for 
+0001a840: 6164 6472 2069 6e20 7473 2e77 6f72 6b65  addr in ts.worke
+0001a850: 725f 7265 7374 7269 6374 696f 6e73 2069  r_restrictions i
+0001a860: 6620 6164 6472 2069 6e20 7365 6c66 2e77  f addr in self.w
+0001a870: 6f72 6b65 7273 7d0a 0a20 2020 2020 2020  orkers}..       
+0001a880: 2069 6620 7473 2e68 6f73 745f 7265 7374   if ts.host_rest
+0001a890: 7269 6374 696f 6e73 3a0a 2020 2020 2020  rictions:.      
+0001a8a0: 2020 2020 2020 2320 5265 736f 6c76 6520        # Resolve 
+0001a8b0: 7468 6520 616c 6961 7320 6865 7265 2072  the alias here r
+0001a8c0: 6174 6865 7220 7468 616e 2065 6172 6c79  ather than early
+0001a8d0: 2c20 666f 7220 7468 6520 776f 726b 6572  , for the worker
+0001a8e0: 0a20 2020 2020 2020 2020 2020 2023 206d  .            # m
+0001a8f0: 6179 206e 6f74 2062 6520 636f 6e6e 6563  ay not be connec
+0001a900: 7465 6420 7768 656e 2068 6f73 745f 7265  ted when host_re
+0001a910: 7374 7269 6374 696f 6e73 2069 7320 706f  strictions is po
+0001a920: 7075 6c61 7465 640a 2020 2020 2020 2020  pulated.        
+0001a930: 2020 2020 6872 203d 205b 7365 6c66 2e63      hr = [self.c
+0001a940: 6f65 7263 655f 686f 7374 6e61 6d65 2868  oerce_hostname(h
+0001a950: 2920 666f 7220 6820 696e 2074 732e 686f  ) for h in ts.ho
+0001a960: 7374 5f72 6573 7472 6963 7469 6f6e 735d  st_restrictions]
+0001a970: 0a20 2020 2020 2020 2020 2020 2023 2058  .            # X
+0001a980: 5858 206e 6565 6420 486f 7374 5374 6174  XX need HostStat
+0001a990: 653f 0a20 2020 2020 2020 2020 2020 2073  e?.            s
+0001a9a0: 6c20 3d20 5b5d 0a20 2020 2020 2020 2020  l = [].         
+0001a9b0: 2020 2066 6f72 2068 2069 6e20 6872 3a0a     for h in hr:.
+0001a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a9d0: 6468 203d 2073 656c 662e 686f 7374 5f69  dh = self.host_i
+0001a9e0: 6e66 6f2e 6765 7428 6829 0a20 2020 2020  nfo.get(h).     
+0001a9f0: 2020 2020 2020 2020 2020 2069 6620 6468             if dh
+0001aa00: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0001aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa20: 2020 736c 2e61 7070 656e 6428 6468 5b22    sl.append(dh["
+0001aa30: 6164 6472 6573 7365 7322 5d29 0a0a 2020  addresses"])..  
+0001aa40: 2020 2020 2020 2020 2020 7373 203d 2073            ss = s
+0001aa50: 6574 2e75 6e69 6f6e 282a 736c 2920 6966  et.union(*sl) if
+0001aa60: 2073 6c20 656c 7365 2073 6574 2829 0a20   sl else set(). 
+0001aa70: 2020 2020 2020 2020 2020 2069 6620 7320             if s 
+0001aa80: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001aa90: 2020 2020 2020 2020 2073 203d 2073 730a           s = ss.
+0001aaa0: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0001aab0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001aac0: 2020 7320 7c3d 2073 730a 0a20 2020 2020    s |= ss..     
+0001aad0: 2020 2069 6620 7473 2e72 6573 6f75 7263     if ts.resourc
+0001aae0: 655f 7265 7374 7269 6374 696f 6e73 3a0a  e_restrictions:.
+0001aaf0: 2020 2020 2020 2020 2020 2020 6477 203d              dw =
+0001ab00: 207b 7d0a 2020 2020 2020 2020 2020 2020   {}.            
+0001ab10: 666f 7220 7265 736f 7572 6365 2c20 7265  for resource, re
+0001ab20: 7175 6972 6564 2069 6e20 7473 2e72 6573  quired in ts.res
+0001ab30: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
+0001ab40: 6e73 2e69 7465 6d73 2829 3a0a 2020 2020  ns.items():.    
+0001ab50: 2020 2020 2020 2020 2020 2020 6472 203d              dr =
+0001ab60: 2073 656c 662e 7265 736f 7572 6365 732e   self.resources.
+0001ab70: 6765 7428 7265 736f 7572 6365 290a 2020  get(resource).  
+0001ab80: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001ab90: 2064 7220 6973 204e 6f6e 653a 0a20 2020   dr is None:.   
+0001aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abb0: 2073 656c 662e 7265 736f 7572 6365 735b   self.resources[
+0001abc0: 7265 736f 7572 6365 5d20 3d20 6472 203d  resource] = dr =
+0001abd0: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
+0001abe0: 2020 2020 2073 7720 3d20 7365 7428 290a       sw = set().
+0001abf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac00: 666f 7220 6164 6472 2c20 7375 7070 6c69  for addr, suppli
+0001ac10: 6564 2069 6e20 6472 2e69 7465 6d73 2829  ed in dr.items()
+0001ac20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ac30: 2020 2020 2020 6966 2073 7570 706c 6965        if supplie
+0001ac40: 6420 3e3d 2072 6571 7569 7265 643a 0a20  d >= required:. 
 0001ac50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ac60: 2020 2020 7377 2e61 6464 2861 6464 7229      sw.add(addr)
-0001ac70: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001ac80: 2020 6477 5b72 6573 6f75 7263 655d 203d    dw[resource] =
-0001ac90: 2073 770a 0a20 2020 2020 2020 2020 2020   sw..           
-0001aca0: 2077 7720 3d20 7365 742e 696e 7465 7273   ww = set.inters
-0001acb0: 6563 7469 6f6e 282a 6477 2e76 616c 7565  ection(*dw.value
-0001acc0: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
-0001acd0: 2069 6620 7320 6973 204e 6f6e 653a 0a20   if s is None:. 
-0001ace0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001acf0: 203d 2077 770a 2020 2020 2020 2020 2020   = ww.          
-0001ad00: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001ad10: 2020 2020 2020 2020 7320 263d 2077 770a          s &= ww.
-0001ad20: 0a20 2020 2020 2020 2069 6620 7320 6973  .        if s is
-0001ad30: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-0001ad40: 2020 2072 6574 7572 6e20 4e6f 6e65 2020     return None  
-0001ad50: 2320 416c 6c20 776f 726b 6572 7320 6172  # All workers ar
-0001ad60: 6520 7661 6c69 640a 2020 2020 2020 2020  e valid.        
-0001ad70: 6966 206e 6f74 2073 3a0a 2020 2020 2020  if not s:.      
-0001ad80: 2020 2020 2020 7265 7475 726e 2073 6574        return set
-0001ad90: 2829 2020 2320 4e6f 2077 6f72 6b65 7273  ()  # No workers
-0001ada0: 2061 7265 2076 616c 6964 0a0a 2020 2020   are valid..    
-0001adb0: 2020 2020 2320 536f 6d65 2077 6f72 6b65      # Some worke
-0001adc0: 7273 2061 7265 2076 616c 6964 0a20 2020  rs are valid.   
-0001add0: 2020 2020 2073 5f77 7320 3d20 7b73 656c       s_ws = {sel
-0001ade0: 662e 776f 726b 6572 735b 6164 6472 5d20  f.workers[addr] 
-0001adf0: 666f 7220 6164 6472 2069 6e20 737d 0a20  for addr in s}. 
-0001ae00: 2020 2020 2020 2069 6620 6c65 6e28 7365         if len(se
-0001ae10: 6c66 2e72 756e 6e69 6e67 2920 3c20 6c65  lf.running) < le
-0001ae20: 6e28 7365 6c66 2e77 6f72 6b65 7273 293a  n(self.workers):
-0001ae30: 0a20 2020 2020 2020 2020 2020 2073 5f77  .            s_w
-0001ae40: 7320 263d 2073 656c 662e 7275 6e6e 696e  s &= self.runnin
-0001ae50: 670a 2020 2020 2020 2020 7265 7475 726e  g.        return
-0001ae60: 2073 5f77 730a 0a20 2020 2064 6566 2061   s_ws..    def a
-0001ae70: 6371 7569 7265 5f72 6573 6f75 7263 6573  cquire_resources
-0001ae80: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
-0001ae90: 7461 7465 2c20 7773 3a20 576f 726b 6572  tate, ws: Worker
-0001aea0: 5374 6174 6529 202d 3e20 4e6f 6e65 3a0a  State) -> None:.
-0001aeb0: 2020 2020 2020 2020 6966 2074 732e 7265          if ts.re
-0001aec0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
-0001aed0: 6f6e 733a 0a20 2020 2020 2020 2020 2020  ons:.           
-0001aee0: 2066 6f72 2072 2c20 7265 7175 6972 6564   for r, required
-0001aef0: 2069 6e20 7473 2e72 6573 6f75 7263 655f   in ts.resource_
-0001af00: 7265 7374 7269 6374 696f 6e73 2e69 7465  restrictions.ite
-0001af10: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-0001af20: 2020 2020 2020 7773 2e75 7365 645f 7265        ws.used_re
-0001af30: 736f 7572 6365 735b 725d 202b 3d20 7265  sources[r] += re
-0001af40: 7175 6972 6564 0a0a 2020 2020 6465 6620  quired..    def 
-0001af50: 7265 6c65 6173 655f 7265 736f 7572 6365  release_resource
-0001af60: 7328 7365 6c66 2c20 7473 3a20 5461 736b  s(self, ts: Task
-0001af70: 5374 6174 652c 2077 733a 2057 6f72 6b65  State, ws: Worke
-0001af80: 7253 7461 7465 2920 2d3e 204e 6f6e 653a  rState) -> None:
-0001af90: 0a20 2020 2020 2020 2069 6620 7473 2e72  .        if ts.r
-0001afa0: 6573 6f75 7263 655f 7265 7374 7269 6374  esource_restrict
-0001afb0: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-0001afc0: 2020 666f 7220 722c 2072 6571 7569 7265    for r, require
-0001afd0: 6420 696e 2074 732e 7265 736f 7572 6365  d in ts.resource
-0001afe0: 5f72 6573 7472 6963 7469 6f6e 732e 6974  _restrictions.it
-0001aff0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-0001b000: 2020 2020 2020 2077 732e 7573 6564 5f72         ws.used_r
-0001b010: 6573 6f75 7263 6573 5b72 5d20 2d3d 2072  esources[r] -= r
-0001b020: 6571 7569 7265 640a 0a20 2020 2064 6566  equired..    def
-0001b030: 2063 6f65 7263 655f 686f 7374 6e61 6d65   coerce_hostname
-0001b040: 2873 656c 662c 2068 6f73 743a 2048 6173  (self, host: Has
-0001b050: 6861 626c 6529 202d 3e20 7374 723a 0a20  hable) -> str:. 
-0001b060: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001b070: 2020 2043 6f65 7263 6520 7468 6520 686f     Coerce the ho
-0001b080: 7374 6e61 6d65 206f 6620 6120 776f 726b  stname of a work
-0001b090: 6572 2e0a 2020 2020 2020 2020 2222 220a  er..        """.
-0001b0a0: 2020 2020 2020 2020 616c 6961 7320 3d20          alias = 
-0001b0b0: 7365 6c66 2e61 6c69 6173 6573 2e67 6574  self.aliases.get
-0001b0c0: 2868 6f73 7429 0a20 2020 2020 2020 2069  (host).        i
-0001b0d0: 6620 616c 6961 7320 6973 206e 6f74 204e  f alias is not N
-0001b0e0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001b0f0: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
-0001b100: 7273 5b61 6c69 6173 5d0a 2020 2020 2020  rs[alias].      
-0001b110: 2020 2020 2020 7265 7475 726e 2077 732e        return ws.
-0001b120: 686f 7374 0a20 2020 2020 2020 2065 6c73  host.        els
-0001b130: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
-0001b140: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-0001b150: 2868 6f73 742c 2073 7472 290a 2020 2020  (host, str).    
-0001b160: 2020 2020 2020 2020 7265 7475 726e 2068          return h
-0001b170: 6f73 740a 0a20 2020 2064 6566 2077 6f72  ost..    def wor
-0001b180: 6b65 725f 6f62 6a65 6374 6976 6528 7365  ker_objective(se
-0001b190: 6c66 2c20 7473 3a20 5461 736b 5374 6174  lf, ts: TaskStat
-0001b1a0: 652c 2077 733a 2057 6f72 6b65 7253 7461  e, ws: WorkerSta
-0001b1b0: 7465 2920 2d3e 2074 7570 6c65 3a0a 2020  te) -> tuple:.  
-0001b1c0: 2020 2020 2020 2222 224f 626a 6563 7469        """Objecti
-0001b1d0: 7665 2066 756e 6374 696f 6e20 746f 2064  ve function to d
-0001b1e0: 6574 6572 6d69 6e65 2077 6869 6368 2077  etermine which w
-0001b1f0: 6f72 6b65 7220 7368 6f75 6c64 2067 6574  orker should get
-0001b200: 2074 6865 2074 6173 6b0a 0a20 2020 2020   the task..     
-0001b210: 2020 204d 696e 696d 697a 6520 6578 7065     Minimize expe
-0001b220: 6374 6564 2073 7461 7274 2074 696d 652e  cted start time.
-0001b230: 2020 4966 2061 2074 6965 2074 6865 6e20    If a tie then 
-0001b240: 6272 6561 6b20 7769 7468 2064 6174 6120  break with data 
-0001b250: 7374 6f72 6167 652e 0a20 2020 2020 2020  storage..       
-0001b260: 2022 2222 0a20 2020 2020 2020 2063 6f6d   """.        com
-0001b270: 6d5f 6279 7465 7320 3d20 7375 6d28 0a20  m_bytes = sum(. 
-0001b280: 2020 2020 2020 2020 2020 2064 7473 2e67             dts.g
-0001b290: 6574 5f6e 6279 7465 7328 2920 666f 7220  et_nbytes() for 
-0001b2a0: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-0001b2b0: 656e 6369 6573 2069 6620 7773 206e 6f74  encies if ws not
-0001b2c0: 2069 6e20 2864 7473 2e77 686f 5f68 6173   in (dts.who_has
-0001b2d0: 206f 7220 2829 290a 2020 2020 2020 2020   or ()).        
-0001b2e0: 290a 0a20 2020 2020 2020 2073 7461 636b  )..        stack
-0001b2f0: 5f74 696d 6520 3d20 7773 2e6f 6363 7570  _time = ws.occup
-0001b300: 616e 6379 202f 2077 732e 6e74 6872 6561  ancy / ws.nthrea
-0001b310: 6473 0a20 2020 2020 2020 2073 7461 7274  ds.        start
-0001b320: 5f74 696d 6520 3d20 7374 6163 6b5f 7469  _time = stack_ti
-0001b330: 6d65 202b 2063 6f6d 6d5f 6279 7465 7320  me + comm_bytes 
-0001b340: 2f20 7365 6c66 2e62 616e 6477 6964 7468  / self.bandwidth
-0001b350: 0a0a 2020 2020 2020 2020 6966 2074 732e  ..        if ts.
-0001b360: 6163 746f 723a 0a20 2020 2020 2020 2020  actor:.         
-0001b370: 2020 2072 6574 7572 6e20 286c 656e 2877     return (len(w
-0001b380: 732e 6163 746f 7273 292c 2073 7461 7274  s.actors), start
-0001b390: 5f74 696d 652c 2077 732e 6e62 7974 6573  _time, ws.nbytes
-0001b3a0: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0001b3b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001b3c0: 726e 2028 7374 6172 745f 7469 6d65 2c20  rn (start_time, 
-0001b3d0: 7773 2e6e 6279 7465 7329 0a0a 2020 2020  ws.nbytes)..    
-0001b3e0: 6465 6620 6164 645f 7265 706c 6963 6128  def add_replica(
-0001b3f0: 7365 6c66 2c20 7473 3a20 5461 736b 5374  self, ts: TaskSt
-0001b400: 6174 652c 2077 733a 2057 6f72 6b65 7253  ate, ws: WorkerS
-0001b410: 7461 7465 2920 2d3e 204e 6f6e 653a 0a20  tate) -> None:. 
-0001b420: 2020 2020 2020 2022 2222 4e6f 7465 2074         """Note t
-0001b430: 6861 7420 6120 776f 726b 6572 2068 6f6c  hat a worker hol
-0001b440: 6473 2061 2072 6570 6c69 6361 206f 6620  ds a replica of 
-0001b450: 6120 7461 736b 2077 6974 6820 7374 6174  a task with stat
-0001b460: 653d 276d 656d 6f72 7927 2222 220a 2020  e='memory'""".  
-0001b470: 2020 2020 2020 7773 2e61 6464 5f72 6570        ws.add_rep
-0001b480: 6c69 6361 2874 7329 0a20 2020 2020 2020  lica(ts).       
-0001b490: 2061 7373 6572 7420 7473 2e77 686f 5f68   assert ts.who_h
-0001b4a0: 6173 0a20 2020 2020 2020 2069 6620 6c65  as.        if le
-0001b4b0: 6e28 7473 2e77 686f 5f68 6173 2920 3d3d  n(ts.who_has) ==
-0001b4c0: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
-0001b4d0: 7365 6c66 2e72 6570 6c69 6361 7465 645f  self.replicated_
-0001b4e0: 7461 736b 732e 6164 6428 7473 290a 0a20  tasks.add(ts).. 
-0001b4f0: 2020 2064 6566 2072 656d 6f76 655f 7265     def remove_re
-0001b500: 706c 6963 6128 7365 6c66 2c20 7473 3a20  plica(self, ts: 
-0001b510: 5461 736b 5374 6174 652c 2077 733a 2057  TaskState, ws: W
-0001b520: 6f72 6b65 7253 7461 7465 2920 2d3e 204e  orkerState) -> N
-0001b530: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-0001b540: 4e6f 7465 2074 6861 7420 6120 776f 726b  Note that a work
-0001b550: 6572 206e 6f20 6c6f 6e67 6572 2068 6f6c  er no longer hol
-0001b560: 6473 2061 2072 6570 6c69 6361 206f 6620  ds a replica of 
-0001b570: 6120 7461 736b 2222 220a 2020 2020 2020  a task""".      
-0001b580: 2020 7773 2e72 656d 6f76 655f 7265 706c    ws.remove_repl
-0001b590: 6963 6128 7473 290a 2020 2020 2020 2020  ica(ts).        
-0001b5a0: 6966 206c 656e 2874 732e 7768 6f5f 6861  if len(ts.who_ha
-0001b5b0: 7320 6f72 2028 2929 203d 3d20 313a 0a20  s or ()) == 1:. 
-0001b5c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001b5d0: 7265 706c 6963 6174 6564 5f74 6173 6b73  replicated_tasks
-0001b5e0: 2e72 656d 6f76 6528 7473 290a 0a20 2020  .remove(ts)..   
-0001b5f0: 2064 6566 2072 656d 6f76 655f 616c 6c5f   def remove_all_
-0001b600: 7265 706c 6963 6173 2873 656c 662c 2074  replicas(self, t
-0001b610: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
-0001b620: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0001b630: 2222 5265 6d6f 7665 2061 6c6c 2072 6570  ""Remove all rep
-0001b640: 6c69 6361 7320 6f66 2061 2074 6173 6b20  licas of a task 
-0001b650: 6672 6f6d 2061 6c6c 2077 6f72 6b65 7273  from all workers
-0001b660: 2222 220a 2020 2020 2020 2020 6e62 7974  """.        nbyt
-0001b670: 6573 203d 2074 732e 6765 745f 6e62 7974  es = ts.get_nbyt
-0001b680: 6573 2829 0a20 2020 2020 2020 2069 6620  es().        if 
-0001b690: 6e6f 7420 7473 2e77 686f 5f68 6173 3a0a  not ts.who_has:.
-0001b6a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001b6b0: 726e 0a20 2020 2020 2020 2066 6f72 2077  rn.        for w
-0001b6c0: 7320 696e 2074 732e 7768 6f5f 6861 733a  s in ts.who_has:
-0001b6d0: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
-0001b6e0: 6e62 7974 6573 202d 3d20 6e62 7974 6573  nbytes -= nbytes
-0001b6f0: 0a20 2020 2020 2020 2020 2020 2064 656c  .            del
-0001b700: 2077 732e 5f68 6173 5f77 6861 745b 7473   ws._has_what[ts
-0001b710: 5d0a 2020 2020 2020 2020 6966 206c 656e  ].        if len
-0001b720: 2874 732e 7768 6f5f 6861 7329 203e 2031  (ts.who_has) > 1
-0001b730: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001b740: 6c66 2e72 6570 6c69 6361 7465 645f 7461  lf.replicated_ta
-0001b750: 736b 732e 7265 6d6f 7665 2874 7329 0a20  sks.remove(ts). 
-0001b760: 2020 2020 2020 2074 732e 7768 6f5f 6861         ts.who_ha
-0001b770: 7320 3d20 4e6f 6e65 0a0a 2020 2020 6465  s = None..    de
-0001b780: 6620 6275 6c6b 5f73 6368 6564 756c 655f  f bulk_schedule_
-0001b790: 756e 7275 6e6e 6162 6c65 5f61 6674 6572  unrunnable_after
-0001b7a0: 5f61 6464 696e 675f 776f 726b 6572 2873  _adding_worker(s
-0001b7b0: 656c 662c 2077 733a 2057 6f72 6b65 7253  elf, ws: WorkerS
-0001b7c0: 7461 7465 2920 2d3e 2052 6563 733a 0a20  tate) -> Recs:. 
-0001b7d0: 2020 2020 2020 2022 2222 5365 6e64 2060         """Send `
-0001b7e0: 606e 6f2d 776f 726b 6572 6060 2074 6173  `no-worker`` tas
-0001b7f0: 6b73 2074 6f20 6060 7072 6f63 6573 7369  ks to ``processi
-0001b800: 6e67 6060 2074 6861 7420 7468 6973 2077  ng`` that this w
-0001b810: 6f72 6b65 7220 6361 6e20 6861 6e64 6c65  orker can handle
-0001b820: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
-0001b830: 6e73 2070 7269 6f72 6974 792d 6f72 6465  ns priority-orde
-0001b840: 7265 6420 7265 636f 6d6d 656e 6461 7469  red recommendati
-0001b850: 6f6e 732e 0a20 2020 2020 2020 2022 2222  ons..        """
-0001b860: 0a20 2020 2020 2020 2072 756e 6e61 626c  .        runnabl
-0001b870: 653a 206c 6973 745b 5461 736b 5374 6174  e: list[TaskStat
-0001b880: 655d 203d 205b 5d0a 2020 2020 2020 2020  e] = [].        
-0001b890: 666f 7220 7473 2069 6e20 7365 6c66 2e75  for ts in self.u
-0001b8a0: 6e72 756e 6e61 626c 653a 0a20 2020 2020  nrunnable:.     
-0001b8b0: 2020 2020 2020 2076 616c 6964 203d 2073         valid = s
-0001b8c0: 656c 662e 7661 6c69 645f 776f 726b 6572  elf.valid_worker
-0001b8d0: 7328 7473 290a 2020 2020 2020 2020 2020  s(ts).          
-0001b8e0: 2020 6966 2076 616c 6964 2069 7320 4e6f    if valid is No
-0001b8f0: 6e65 206f 7220 7773 2069 6e20 7661 6c69  ne or ws in vali
-0001b900: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
-0001b910: 2020 2072 756e 6e61 626c 652e 6170 7065     runnable.appe
-0001b920: 6e64 2874 7329 0a0a 2020 2020 2020 2020  nd(ts)..        
-0001b930: 2320 5265 636f 6d6d 656e 6461 7469 6f6e  # Recommendation
-0001b940: 7320 6172 6520 7072 6f63 6573 7365 6420  s are processed 
-0001b950: 4c49 464f 2c20 6865 6e63 6520 7468 6520  LIFO, hence the 
-0001b960: 7265 7665 7273 6564 206f 7264 6572 0a20  reversed order. 
-0001b970: 2020 2020 2020 2072 756e 6e61 626c 652e         runnable.
-0001b980: 736f 7274 286b 6579 3d6f 7065 7261 746f  sort(key=operato
-0001b990: 722e 6174 7472 6765 7474 6572 2822 7072  r.attrgetter("pr
-0001b9a0: 696f 7269 7479 2229 2c20 7265 7665 7273  iority"), revers
-0001b9b0: 653d 5472 7565 290a 2020 2020 2020 2020  e=True).        
-0001b9c0: 7265 7475 726e 207b 7473 2e6b 6579 3a20  return {ts.key: 
-0001b9d0: 2270 726f 6365 7373 696e 6722 2066 6f72  "processing" for
-0001b9e0: 2074 7320 696e 2072 756e 6e61 626c 657d   ts in runnable}
-0001b9f0: 0a0a 2020 2020 6465 6620 5f76 616c 6964  ..    def _valid
-0001ba00: 6174 655f 7265 6164 7928 7365 6c66 2c20  ate_ready(self, 
-0001ba10: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
-0001ba20: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0001ba30: 2222 2256 616c 6964 6174 696f 6e20 666f  """Validation fo
-0001ba40: 7220 7265 6164 7920 7374 6174 6573 2028  r ready states (
-0001ba50: 7072 6f63 6573 7369 6e67 2c20 7175 6575  processing, queu
-0001ba60: 6564 2c20 6e6f 2d77 6f72 6b65 7229 2222  ed, no-worker)""
-0001ba70: 220a 2020 2020 2020 2020 6173 7365 7274  ".        assert
-0001ba80: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
-0001ba90: 6f6e 0a20 2020 2020 2020 2061 7373 6572  on.        asser
-0001baa0: 7420 6e6f 7420 7473 2e77 686f 5f68 6173  t not ts.who_has
-0001bab0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001bac0: 6e6f 7420 7473 2e65 7863 6570 7469 6f6e  not ts.exception
-0001bad0: 5f62 6c61 6d65 0a20 2020 2020 2020 2061  _blame.        a
-0001bae0: 7373 6572 7420 6e6f 7420 7473 2e70 726f  ssert not ts.pro
-0001baf0: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
-0001bb00: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
-0001bb10: 2e68 6173 5f6c 6f73 745f 6465 7065 6e64  .has_lost_depend
-0001bb20: 656e 6369 6573 0a20 2020 2020 2020 2061  encies.        a
-0001bb30: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
-0001bb40: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
-0001bb50: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0001bb60: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
-0001bb70: 6575 6564 0a20 2020 2020 2020 2061 7373  eued.        ass
-0001bb80: 6572 7420 616c 6c28 6474 732e 7768 6f5f  ert all(dts.who_
-0001bb90: 6861 7320 666f 7220 6474 7320 696e 2074  has for dts in t
-0001bba0: 732e 6465 7065 6e64 656e 6369 6573 290a  s.dependencies).
-0001bbb0: 0a20 2020 2064 6566 205f 6164 645f 746f  .    def _add_to
-0001bbc0: 5f70 726f 6365 7373 696e 6728 0a20 2020  _processing(.   
-0001bbd0: 2020 2020 2073 656c 662c 2074 733a 2054       self, ts: T
-0001bbe0: 6173 6b53 7461 7465 2c20 7773 3a20 576f  askState, ws: Wo
-0001bbf0: 726b 6572 5374 6174 652c 2073 7469 6d75  rkerState, stimu
-0001bc00: 6c75 735f 6964 3a20 7374 720a 2020 2020  lus_id: str.    
-0001bc10: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
-0001bc20: 2020 2020 2020 2022 2222 5365 7420 6120         """Set a 
-0001bc30: 7461 736b 2061 7320 7072 6f63 6573 7369  task as processi
-0001bc40: 6e67 206f 6e20 6120 776f 726b 6572 2061  ng on a worker a
-0001bc50: 6e64 2072 6574 7572 6e20 7468 6520 776f  nd return the wo
-0001bc60: 726b 6572 206d 6573 7361 6765 7320 746f  rker messages to
-0001bc70: 2073 656e 6422 2222 0a20 2020 2020 2020   send""".       
-0001bc80: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-0001bc90: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-0001bca0: 656c 662e 5f76 616c 6964 6174 655f 7265  elf._validate_re
-0001bcb0: 6164 7928 7473 290a 2020 2020 2020 2020  ady(ts).        
-0001bcc0: 2020 2020 6173 7365 7274 2077 7320 696e      assert ws in
-0001bcd0: 2073 656c 662e 7275 6e6e 696e 672c 2073   self.running, s
-0001bce0: 656c 662e 7275 6e6e 696e 670a 2020 2020  elf.running.    
-0001bcf0: 2020 2020 2020 2020 6173 7365 7274 2028          assert (
-0001bd00: 6f20 3a3d 2073 656c 662e 776f 726b 6572  o := self.worker
-0001bd10: 732e 6765 7428 7773 2e61 6464 7265 7373  s.get(ws.address
-0001bd20: 2929 2069 7320 7773 2c20 2877 732c 206f  )) is ws, (ws, o
-0001bd30: 290a 0a20 2020 2020 2020 2077 732e 6164  )..        ws.ad
-0001bd40: 645f 746f 5f70 726f 6365 7373 696e 6728  d_to_processing(
-0001bd50: 7473 290a 2020 2020 2020 2020 7473 2e70  ts).        ts.p
-0001bd60: 726f 6365 7373 696e 675f 6f6e 203d 2077  rocessing_on = w
-0001bd70: 730a 2020 2020 2020 2020 7473 2e73 7461  s.        ts.sta
-0001bd80: 7465 203d 2022 7072 6f63 6573 7369 6e67  te = "processing
-0001bd90: 220a 2020 2020 2020 2020 7365 6c66 2e61  ".        self.a
-0001bda0: 6371 7569 7265 5f72 6573 6f75 7263 6573  cquire_resources
-0001bdb0: 2874 732c 2077 7329 0a20 2020 2020 2020  (ts, ws).       
-0001bdc0: 2073 656c 662e 6368 6563 6b5f 6964 6c65   self.check_idle
-0001bdd0: 5f73 6174 7572 6174 6564 2877 7329 0a20  _saturated(ws). 
-0001bde0: 2020 2020 2020 2073 656c 662e 6e5f 7461         self.n_ta
-0001bdf0: 736b 7320 2b3d 2031 0a0a 2020 2020 2020  sks += 1..      
-0001be00: 2020 6966 2074 732e 6163 746f 723a 0a20    if ts.actor:. 
-0001be10: 2020 2020 2020 2020 2020 2077 732e 6163             ws.ac
-0001be20: 746f 7273 2e61 6464 2874 7329 0a0a 2020  tors.add(ts)..  
-0001be30: 2020 2020 2020 6e64 6570 5f62 7974 6573        ndep_bytes
-0001be40: 203d 2073 756d 2864 7473 2e6e 6279 7465   = sum(dts.nbyte
-0001be50: 7320 666f 7220 6474 7320 696e 2074 732e  s for dts in ts.
-0001be60: 6465 7065 6e64 656e 6369 6573 290a 2020  dependencies).  
-0001be70: 2020 2020 2020 6966 2028 0a20 2020 2020        if (.     
-0001be80: 2020 2020 2020 2077 732e 6d65 6d6f 7279         ws.memory
-0001be90: 5f6c 696d 6974 0a20 2020 2020 2020 2020  _limit.         
-0001bea0: 2020 2061 6e64 206e 6465 705f 6279 7465     and ndep_byte
-0001beb0: 7320 3e20 7773 2e6d 656d 6f72 795f 6c69  s > ws.memory_li
-0001bec0: 6d69 740a 2020 2020 2020 2020 2020 2020  mit.            
-0001bed0: 616e 6420 6461 736b 2e63 6f6e 6669 672e  and dask.config.
-0001bee0: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-0001bef0: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e74  .worker.memory.t
-0001bf00: 6572 6d69 6e61 7465 2229 0a20 2020 2020  erminate").     
-0001bf10: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
-0001bf20: 2020 2320 4e6f 7465 0a20 2020 2020 2020    # Note.       
-0001bf30: 2020 2020 2023 202d 2d2d 2d0a 2020 2020       # ----.    
-0001bf40: 2020 2020 2020 2020 2320 5468 6973 2069          # This i
-0001bf50: 7320 6120 6372 7564 6520 7361 6665 7479  s a crude safety
-0001bf60: 2073 7973 7465 6d2c 206f 6e6c 7920 6d65   system, only me
-0001bf70: 616e 7420 746f 2070 7265 7665 6e74 206f  ant to prevent o
-0001bf80: 7264 6572 2d6f 662d 6d61 676e 6974 7564  rder-of-magnitud
-0001bf90: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-0001bfa0: 6661 742d 6669 6e67 6572 2065 7272 6f72  fat-finger error
-0001bfb0: 732e 0a20 2020 2020 2020 2020 2020 2023  s..            #
-0001bfc0: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
-0001bfd0: 6f72 2063 6f6c 6c65 6374 696f 6e20 6669  or collection fi
-0001bfe0: 6e61 6c69 7a65 7273 2061 6e64 2069 6e20  nalizers and in 
-0001bff0: 6765 6e65 7261 6c20 6d6f 7374 2063 6f6e  general most con
-0001c000: 6361 7420 6f70 6572 6174 696f 6e73 2c20  cat operations, 
-0001c010: 6974 2074 616b 6573 0a20 2020 2020 2020  it takes.       
-0001c020: 2020 2020 2023 2061 206c 6f74 206c 6573       # a lot les
-0001c030: 7320 746f 206b 696c 6c20 6f66 6620 7468  s to kill off th
-0001c040: 6520 776f 726b 6572 3b20 796f 7527 6c6c  e worker; you'll
-0001c050: 206a 7573 7420 6e65 6564 0a20 2020 2020   just need.     
-0001c060: 2020 2020 2020 2023 206e 6465 705f 6279         # ndep_by
-0001c070: 7465 7320 2a20 3220 3e20 7773 2e6d 656d  tes * 2 > ws.mem
-0001c080: 6f72 795f 6c69 6d69 7420 2a20 7465 726d  ory_limit * term
-0001c090: 696e 6174 6520 7468 7265 7368 6f6c 642e  inate threshold.
-0001c0a0: 0a20 2020 2020 2020 2020 2020 2023 0a20  .            #. 
-0001c0b0: 2020 2020 2020 2020 2020 2023 2049 6e20             # In 
-0001c0c0: 6865 7465 726f 6765 6e65 6f75 7320 636c  heterogeneous cl
-0001c0d0: 7573 7465 7273 2077 6974 6820 776f 726b  usters with work
-0001c0e0: 6572 7320 6d6f 756e 7469 6e67 2064 6966  ers mounting dif
-0001c0f0: 6665 7265 6e74 2061 6d6f 756e 7473 206f  ferent amounts o
-0001c100: 660a 2020 2020 2020 2020 2020 2020 2320  f.            # 
-0001c110: 6d65 6d6f 7279 2c20 7468 6520 7573 6572  memory, the user
-0001c120: 2069 7320 6578 7065 6374 6564 2074 6f20   is expected to 
-0001c130: 6d61 6e75 616c 6c79 2073 6574 2068 6f73  manually set hos
-0001c140: 742f 776f 726b 6572 2f72 6573 6f75 7263  t/worker/resourc
-0001c150: 650a 2020 2020 2020 2020 2020 2020 2320  e.            # 
-0001c160: 7265 7374 7269 6374 696f 6e73 2e0a 2020  restrictions..  
-0001c170: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-0001c180: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001c190: 2020 6622 5461 736b 207b 7473 2e6b 6579    f"Task {ts.key
-0001c1a0: 2172 7d20 6861 7320 7b66 6f72 6d61 745f  !r} has {format_
-0001c1b0: 6279 7465 7328 6e64 6570 5f62 7974 6573  bytes(ndep_bytes
-0001c1c0: 297d 2077 6f72 7468 206f 6620 696e 7075  )} worth of inpu
-0001c1d0: 7420 220a 2020 2020 2020 2020 2020 2020  t ".            
-0001c1e0: 2020 2020 6622 6465 7065 6e64 656e 6369      f"dependenci
-0001c1f0: 6573 2c20 6275 7420 776f 726b 6572 207b  es, but worker {
-0001c200: 7773 2e61 6464 7265 7373 7d20 6861 7320  ws.address} has 
-0001c210: 6d65 6d6f 7279 5f6c 696d 6974 2073 6574  memory_limit set
-0001c220: 2074 6f20 220a 2020 2020 2020 2020 2020   to ".          
-0001c230: 2020 2020 2020 6622 7b66 6f72 6d61 745f        f"{format_
-0001c240: 6279 7465 7328 7773 2e6d 656d 6f72 795f  bytes(ws.memory_
-0001c250: 6c69 6d69 7429 7d2e 220a 2020 2020 2020  limit)}.".      
-0001c260: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001c270: 2020 2020 6966 2074 732e 7072 6566 6978      if ts.prefix
-0001c280: 2e6e 616d 6520 3d3d 2022 6669 6e61 6c69  .name == "finali
-0001c290: 7a65 223a 0a20 2020 2020 2020 2020 2020  ze":.           
-0001c2a0: 2020 2020 206d 7367 202b 3d20 280a 2020       msg += (.  
-0001c2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c2c0: 2020 2220 4974 2073 6565 6d73 206c 696b    " It seems lik
-0001c2d0: 6520 796f 7520 6361 6c6c 6564 2063 6c69  e you called cli
-0001c2e0: 656e 742e 636f 6d70 7574 6528 2920 6f6e  ent.compute() on
-0001c2f0: 2061 2068 7567 6520 636f 6c6c 6563 7469   a huge collecti
-0001c300: 6f6e 2e20 220a 2020 2020 2020 2020 2020  on. ".          
-0001c310: 2020 2020 2020 2020 2020 2243 6f6e 7369            "Consi
-0001c320: 6465 7220 7772 6974 696e 6720 746f 2064  der writing to d
-0001c330: 6973 7472 6962 7574 6564 2073 746f 7261  istributed stora
-0001c340: 6765 206f 7220 736c 6963 696e 672f 7265  ge or slicing/re
-0001c350: 6475 6369 6e67 2066 6972 7374 2e22 0a20  ducing first.". 
-0001c360: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001c370: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0001c380: 6765 722e 6572 726f 7228 6d73 6729 0a20  ger.error(msg). 
-0001c390: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0001c3a0: 6e20 7365 6c66 2e5f 7472 616e 7369 7469  n self._transiti
-0001c3b0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-0001c3c0: 2020 2020 7473 2e6b 6579 2c0a 2020 2020      ts.key,.    
-0001c3d0: 2020 2020 2020 2020 2020 2020 2265 7272              "err
-0001c3e0: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
-0001c3f0: 2020 2020 2065 7863 6570 7469 6f6e 3d70       exception=p
-0001c400: 6963 6b6c 652e 6475 6d70 7328 4d65 6d6f  ickle.dumps(Memo
-0001c410: 7279 4572 726f 7228 6d73 6729 292c 0a20  ryError(msg)),. 
-0001c420: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001c430: 6175 7365 3d74 732e 6b65 792c 0a20 2020  ause=ts.key,.   
-0001c440: 2020 2020 2020 2020 2020 2020 2073 7469               sti
-0001c450: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-0001c460: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
-0001c470: 2020 2020 2020 776f 726b 6572 3d77 732e        worker=ws.
-0001c480: 6164 6472 6573 732c 0a20 2020 2020 2020  address,.       
-0001c490: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-0001c4a0: 7265 7475 726e 207b 7d2c 207b 7d2c 207b  return {}, {}, {
-0001c4b0: 7773 2e61 6464 7265 7373 3a20 5b73 656c  ws.address: [sel
-0001c4c0: 662e 5f74 6173 6b5f 746f 5f6d 7367 2874  f._task_to_msg(t
-0001c4d0: 7329 5d7d 0a0a 2020 2020 6465 6620 5f65  s)]}..    def _e
-0001c4e0: 7869 745f 7072 6f63 6573 7369 6e67 5f63  xit_processing_c
-0001c4f0: 6f6d 6d6f 6e28 7365 6c66 2c20 7473 3a20  ommon(self, ts: 
-0001c500: 5461 736b 5374 6174 6529 202d 3e20 576f  TaskState) -> Wo
-0001c510: 726b 6572 5374 6174 6520 7c20 4e6f 6e65  rkerState | None
-0001c520: 3a0a 2020 2020 2020 2020 2222 2252 656d  :.        """Rem
-0001c530: 6f76 6520 2a74 732a 2066 726f 6d20 7468  ove *ts* from th
-0001c540: 6520 7365 7420 6f66 2070 726f 6365 7373  e set of process
-0001c550: 696e 6720 7461 736b 732e 0a0a 2020 2020  ing tasks...    
-0001c560: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-0001c570: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-0001c580: 2020 2020 576f 726b 6572 2073 7461 7465      Worker state
-0001c590: 206f 6620 7468 6520 776f 726b 6572 2074   of the worker t
-0001c5a0: 6861 7420 7072 6f63 6573 7365 6420 2a74  hat processed *t
-0001c5b0: 732a 2069 6620 7468 6520 776f 726b 6572  s* if the worker
-0001c5c0: 2069 7320 6375 7272 656e 742c 0a20 2020   is current,.   
-0001c5d0: 2020 2020 204e 6f6e 6520 6966 2074 6865       None if the
-0001c5e0: 2077 6f72 6b65 7220 6973 2073 7461 6c65   worker is stale
-0001c5f0: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
-0001c600: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-0001c610: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
-0001c620: 6564 756c 6572 2e5f 7365 745f 6475 7261  eduler._set_dura
-0001c630: 7469 6f6e 5f65 7374 696d 6174 650a 2020  tion_estimate.  
-0001c640: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001c650: 2020 7773 203d 2074 732e 7072 6f63 6573    ws = ts.proces
-0001c660: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
-0001c670: 6173 7365 7274 2077 730a 2020 2020 2020  assert ws.      
-0001c680: 2020 7473 2e70 726f 6365 7373 696e 675f    ts.processing_
-0001c690: 6f6e 203d 204e 6f6e 650a 0a20 2020 2020  on = None..     
-0001c6a0: 2020 2077 732e 7265 6d6f 7665 5f66 726f     ws.remove_fro
-0001c6b0: 6d5f 7072 6f63 6573 7369 6e67 2874 7329  m_processing(ts)
-0001c6c0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001c6d0: 2e77 6f72 6b65 7273 2e67 6574 2877 732e  .workers.get(ws.
-0001c6e0: 6164 6472 6573 7329 2069 7320 6e6f 7420  address) is not 
-0001c6f0: 7773 3a20 2023 206d 6179 2068 6176 6520  ws:  # may have 
-0001c700: 6265 656e 2072 656d 6f76 6564 0a20 2020  been removed.   
-0001c710: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001c720: 4e6f 6e65 0a0a 2020 2020 2020 2020 7365  None..        se
-0001c730: 6c66 2e63 6865 636b 5f69 646c 655f 7361  lf.check_idle_sa
-0001c740: 7475 7261 7465 6428 7773 290a 2020 2020  turated(ws).    
-0001c750: 2020 2020 7365 6c66 2e72 656c 6561 7365      self.release
-0001c760: 5f72 6573 6f75 7263 6573 2874 732c 2077  _resources(ts, w
-0001c770: 7329 0a0a 2020 2020 2020 2020 7265 7475  s)..        retu
-0001c780: 726e 2077 730a 0a20 2020 2064 6566 205f  rn ws..    def _
-0001c790: 6164 645f 746f 5f6d 656d 6f72 7928 0a20  add_to_memory(. 
-0001c7a0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-0001c7b0: 2020 2020 2074 733a 2054 6173 6b53 7461       ts: TaskSta
-0001c7c0: 7465 2c0a 2020 2020 2020 2020 7773 3a20  te,.        ws: 
-0001c7d0: 576f 726b 6572 5374 6174 652c 0a20 2020  WorkerState,.   
-0001c7e0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0001c7f0: 696f 6e73 3a20 5265 6373 2c0a 2020 2020  ions: Recs,.    
-0001c800: 2020 2020 636c 6965 6e74 5f6d 7367 733a      client_msgs:
-0001c810: 204d 7367 732c 0a20 2020 2020 2020 2074   Msgs,.        t
-0001c820: 7970 653a 2062 7974 6573 207c 204e 6f6e  ype: bytes | Non
-0001c830: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-0001c840: 2020 7479 7065 6e61 6d65 3a20 7374 7220    typename: str 
-0001c850: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-0001c860: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-0001c870: 2020 2020 2020 2222 2241 6464 2074 7320        """Add ts 
-0001c880: 746f 2074 6865 2073 6574 206f 6620 696e  to the set of in
-0001c890: 2d6d 656d 6f72 7920 7461 736b 7322 2222  -memory tasks"""
-0001c8a0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001c8b0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-0001c8c0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0001c8d0: 206e 6f74 2069 6e20 7773 2e68 6173 5f77   not in ws.has_w
-0001c8e0: 6861 740a 0a20 2020 2020 2020 2073 656c  hat..        sel
-0001c8f0: 662e 6164 645f 7265 706c 6963 6128 7473  f.add_replica(ts
-0001c900: 2c20 7773 290a 0a20 2020 2020 2020 2064  , ws)..        d
-0001c910: 6570 7320 3d20 6c69 7374 2874 732e 6465  eps = list(ts.de
-0001c920: 7065 6e64 656e 7473 290a 2020 2020 2020  pendents).      
-0001c930: 2020 6966 206c 656e 2864 6570 7329 203e    if len(deps) >
-0001c940: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-0001c950: 6465 7073 2e73 6f72 7428 6b65 793d 6f70  deps.sort(key=op
-0001c960: 6572 6174 6f72 2e61 7474 7267 6574 7465  erator.attrgette
-0001c970: 7228 2270 7269 6f72 6974 7922 292c 2072  r("priority"), r
-0001c980: 6576 6572 7365 3d54 7275 6529 0a0a 2020  everse=True)..  
-0001c990: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
-0001c9a0: 2064 6570 733a 0a20 2020 2020 2020 2020   deps:.         
-0001c9b0: 2020 2073 203d 2064 7473 2e77 6169 7469     s = dts.waiti
-0001c9c0: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
-0001c9d0: 2020 6966 2073 2061 6e64 2074 7320 696e    if s and ts in
-0001c9e0: 2073 3a0a 2020 2020 2020 2020 2020 2020   s:.            
-0001c9f0: 2020 2020 732e 6469 7363 6172 6428 7473      s.discard(ts
-0001ca00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001ca10: 2020 6966 206e 6f74 2073 3a20 2023 206e    if not s:  # n
-0001ca20: 6577 2074 6173 6b20 7265 6164 7920 746f  ew task ready to
-0001ca30: 2072 756e 0a20 2020 2020 2020 2020 2020   run.           
-0001ca40: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
-0001ca50: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
-0001ca60: 5d20 3d20 2270 726f 6365 7373 696e 6722  ] = "processing"
-0001ca70: 0a0a 2020 2020 2020 2020 666f 7220 6474  ..        for dt
-0001ca80: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0001ca90: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-0001caa0: 2020 7320 3d20 6474 732e 7761 6974 6572    s = dts.waiter
-0001cab0: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
-0001cac0: 2073 3a0a 2020 2020 2020 2020 2020 2020   s:.            
-0001cad0: 2020 2020 732e 6469 7363 6172 6428 7473      s.discard(ts
-0001cae0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0001caf0: 206e 6f74 2073 2061 6e64 206e 6f74 2064   not s and not d
-0001cb00: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
-0001cb10: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001cb20: 636f 6d6d 656e 6461 7469 6f6e 735b 6474  commendations[dt
-0001cb30: 732e 6b65 795d 203d 2022 7265 6c65 6173  s.key] = "releas
-0001cb40: 6564 220a 0a20 2020 2020 2020 2069 6620  ed"..        if 
-0001cb50: 6e6f 7420 7473 2e77 6169 7465 7273 2061  not ts.waiters a
-0001cb60: 6e64 206e 6f74 2074 732e 7768 6f5f 7761  nd not ts.who_wa
-0001cb70: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0001cb80: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001cb90: 5b74 732e 6b65 795d 203d 2022 7265 6c65  [ts.key] = "rele
-0001cba0: 6173 6564 220a 2020 2020 2020 2020 656c  ased".        el
-0001cbb0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001cbc0: 7265 706f 7274 5f6d 7367 3a20 6469 6374  report_msg: dict
-0001cbd0: 5b73 7472 2c20 416e 795d 203d 207b 226f  [str, Any] = {"o
-0001cbe0: 7022 3a20 226b 6579 2d69 6e2d 6d65 6d6f  p": "key-in-memo
-0001cbf0: 7279 222c 2022 6b65 7922 3a20 7473 2e6b  ry", "key": ts.k
-0001cc00: 6579 7d0a 2020 2020 2020 2020 2020 2020  ey}.            
-0001cc10: 6966 2074 7970 6520 6973 206e 6f74 204e  if type is not N
-0001cc20: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001cc30: 2020 2020 2072 6570 6f72 745f 6d73 675b       report_msg[
-0001cc40: 2274 7970 6522 5d20 3d20 7479 7065 0a20  "type"] = type. 
-0001cc50: 2020 2020 2020 2020 2020 2066 6f72 2063             for c
-0001cc60: 7320 696e 2074 732e 7768 6f5f 7761 6e74  s in ts.who_want
-0001cc70: 7320 6f72 2028 293a 0a20 2020 2020 2020  s or ():.       
-0001cc80: 2020 2020 2020 2020 2063 6c69 656e 745f           client_
-0001cc90: 6d73 6773 5b63 732e 636c 6965 6e74 5f6b  msgs[cs.client_k
-0001cca0: 6579 5d20 3d20 5b72 6570 6f72 745f 6d73  ey] = [report_ms
-0001ccb0: 675d 0a0a 2020 2020 2020 2020 7473 2e73  g]..        ts.s
-0001ccc0: 7461 7465 203d 2022 6d65 6d6f 7279 220a  tate = "memory".
-0001ccd0: 2020 2020 2020 2020 7473 2e74 7970 6520          ts.type 
-0001cce0: 3d20 7479 7065 6e61 6d65 2020 2320 7479  = typename  # ty
-0001ccf0: 7065 3a20 6967 6e6f 7265 0a20 2020 2020  pe: ignore.     
-0001cd00: 2020 2074 732e 6772 6f75 702e 7479 7065     ts.group.type
-0001cd10: 732e 6164 6428 7479 7065 6e61 6d65 2920  s.add(typename) 
-0001cd20: 2023 2074 7970 653a 2069 676e 6f72 650a   # type: ignore.
-0001cd30: 0a20 2020 2020 2020 2063 7320 3d20 7365  .        cs = se
-0001cd40: 6c66 2e63 6c69 656e 7473 5b22 6669 7265  lf.clients["fire
-0001cd50: 2d61 6e64 2d66 6f72 6765 7422 5d0a 2020  -and-forget"].  
-0001cd60: 2020 2020 2020 6966 2074 7320 696e 2063        if ts in c
-0001cd70: 732e 7761 6e74 735f 7768 6174 3a0a 2020  s.wants_what:.  
-0001cd80: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0001cd90: 636c 6965 6e74 5f72 656c 6561 7365 735f  client_releases_
-0001cda0: 6b65 7973 280a 2020 2020 2020 2020 2020  keys(.          
-0001cdb0: 2020 2020 2020 6373 3d63 732c 0a20 2020        cs=cs,.   
-0001cdc0: 2020 2020 2020 2020 2020 2020 206b 6579               key
-0001cdd0: 733d 5b74 732e 6b65 795d 2c0a 2020 2020  s=[ts.key],.    
-0001cde0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-0001cdf0: 6d6d 656e 6461 7469 6f6e 733d 7265 636f  mmendations=reco
-0001ce00: 6d6d 656e 6461 7469 6f6e 732c 0a20 2020  mmendations,.   
-0001ce10: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0001ce20: 6465 6620 5f70 726f 7061 6761 7465 5f72  def _propagate_r
-0001ce30: 656c 6561 7365 6428 7365 6c66 2c20 7473  eleased(self, ts
-0001ce40: 3a20 5461 736b 5374 6174 652c 2072 6563  : TaskState, rec
-0001ce50: 6f6d 6d65 6e64 6174 696f 6e73 3a20 5265  ommendations: Re
-0001ce60: 6373 2920 2d3e 204e 6f6e 653a 0a20 2020  cs) -> None:.   
-0001ce70: 2020 2020 2074 732e 7374 6174 6520 3d20       ts.state = 
-0001ce80: 2272 656c 6561 7365 6422 0a20 2020 2020  "released".     
-0001ce90: 2020 206b 6579 203d 2074 732e 6b65 790a     key = ts.key.
-0001cea0: 0a20 2020 2020 2020 2069 6620 7473 2e68  .        if ts.h
-0001ceb0: 6173 5f6c 6f73 745f 6465 7065 6e64 656e  as_lost_dependen
-0001cec0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-0001ced0: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0001cee0: 735b 6b65 795d 203d 2022 666f 7267 6f74  s[key] = "forgot
-0001cef0: 7465 6e22 0a20 2020 2020 2020 2065 6c69  ten".        eli
-0001cf00: 6620 7473 2e77 6169 7465 7273 206f 7220  f ts.waiters or 
-0001cf10: 7473 2e77 686f 5f77 616e 7473 3a0a 2020  ts.who_wants:.  
-0001cf20: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
-0001cf30: 656e 6461 7469 6f6e 735b 6b65 795d 203d  endations[key] =
-0001cf40: 2022 7761 6974 696e 6722 0a0a 2020 2020   "waiting"..    
-0001cf50: 2020 2020 6966 2072 6563 6f6d 6d65 6e64      if recommend
-0001cf60: 6174 696f 6e73 2e67 6574 286b 6579 2920  ations.get(key) 
-0001cf70: 213d 2022 7761 6974 696e 6722 3a0a 2020  != "waiting":.  
-0001cf80: 2020 2020 2020 2020 2020 666f 7220 6474            for dt
-0001cf90: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0001cfa0: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
-0001cfb0: 2020 2020 2020 6966 2064 7473 2e73 7461        if dts.sta
-0001cfc0: 7465 2021 3d20 2272 656c 6561 7365 6422  te != "released"
-0001cfd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001cfe0: 2020 2020 2020 6966 2064 7473 2e77 6169        if dts.wai
-0001cff0: 7465 7273 3a0a 2020 2020 2020 2020 2020  ters:.          
-0001d000: 2020 2020 2020 2020 2020 2020 2020 6474                dt
-0001d010: 732e 7761 6974 6572 732e 6469 7363 6172  s.waiters.discar
-0001d020: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
-0001d030: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0001d040: 2064 7473 2e77 6169 7465 7273 2061 6e64   dts.waiters and
-0001d050: 206e 6f74 2064 7473 2e77 686f 5f77 616e   not dts.who_wan
-0001d060: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0001d070: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-0001d080: 6d6d 656e 6461 7469 6f6e 735b 6474 732e  mmendations[dts.
-0001d090: 6b65 795d 203d 2022 7265 6c65 6173 6564  key] = "released
-0001d0a0: 220a 2020 2020 2020 2020 2020 2020 7473  ".            ts
-0001d0b0: 2e77 6169 7465 7273 203d 204e 6f6e 650a  .waiters = None.
-0001d0c0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-0001d0d0: 2e76 616c 6964 6174 653a 0a20 2020 2020  .validate:.     
-0001d0e0: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0001d0f0: 7420 7473 2e70 726f 6365 7373 696e 675f  t ts.processing_
-0001d100: 6f6e 0a20 2020 2020 2020 2020 2020 2061  on.            a
-0001d110: 7373 6572 7420 7473 206e 6f74 2069 6e20  ssert ts not in 
-0001d120: 7365 6c66 2e71 7565 7565 640a 0a20 2020  self.queued..   
-0001d130: 2064 6566 205f 7072 6f70 6167 6174 655f   def _propagate_
-0001d140: 666f 7267 6f74 7465 6e28 0a20 2020 2020  forgotten(.     
-0001d150: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001d160: 2074 733a 2054 6173 6b53 7461 7465 2c0a   ts: TaskState,.
-0001d170: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
-0001d180: 6461 7469 6f6e 733a 2052 6563 732c 0a20  dations: Recs,. 
-0001d190: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
-0001d1a0: 6773 3a20 4d73 6773 2c0a 2020 2020 2020  gs: Msgs,.      
-0001d1b0: 2020 7374 696d 756c 7573 5f69 643a 2073    stimulus_id: s
-0001d1c0: 7472 2c0a 2020 2020 2920 2d3e 204e 6f6e  tr,.    ) -> Non
-0001d1d0: 653a 0a20 2020 2020 2020 2074 732e 7374  e:.        ts.st
-0001d1e0: 6174 6520 3d20 2266 6f72 676f 7474 656e  ate = "forgotten
-0001d1f0: 220a 2020 2020 2020 2020 666f 7220 6474  ".        for dt
-0001d200: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0001d210: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0001d220: 6474 732e 6861 735f 6c6f 7374 5f64 6570  dts.has_lost_dep
-0001d230: 656e 6465 6e63 6965 7320 3d20 5472 7565  endencies = True
-0001d240: 0a20 2020 2020 2020 2020 2020 2064 7473  .            dts
-0001d250: 2e64 6570 656e 6465 6e63 6965 732e 7265  .dependencies.re
-0001d260: 6d6f 7665 2874 7329 0a20 2020 2020 2020  move(ts).       
-0001d270: 2020 2020 2069 6620 6474 732e 7761 6974       if dts.wait
-0001d280: 696e 675f 6f6e 3a0a 2020 2020 2020 2020  ing_on:.        
-0001d290: 2020 2020 2020 2020 6474 732e 7761 6974          dts.wait
-0001d2a0: 696e 675f 6f6e 2e64 6973 6361 7264 2874  ing_on.discard(t
-0001d2b0: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-0001d2c0: 6620 6474 732e 7374 6174 6520 6e6f 7420  f dts.state not 
-0001d2d0: 696e 2028 226d 656d 6f72 7922 2c20 2265  in ("memory", "e
-0001d2e0: 7272 6564 2229 3a0a 2020 2020 2020 2020  rred"):.        
-0001d2f0: 2020 2020 2020 2020 2320 4361 6e6e 6f74          # Cannot
-0001d300: 2063 6f6d 7075 7465 2074 6173 6b20 616e   compute task an
-0001d310: 796d 6f72 650a 2020 2020 2020 2020 2020  ymore.          
-0001d320: 2020 2020 2020 7265 636f 6d6d 656e 6461        recommenda
-0001d330: 7469 6f6e 735b 6474 732e 6b65 795d 203d  tions[dts.key] =
-0001d340: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
-0001d350: 2020 2020 2074 732e 6465 7065 6e64 656e       ts.dependen
-0001d360: 7473 2e63 6c65 6172 2829 0a20 2020 2020  ts.clear().     
-0001d370: 2020 2074 732e 7761 6974 6572 7320 3d20     ts.waiters = 
-0001d380: 4e6f 6e65 0a0a 2020 2020 2020 2020 666f  None..        fo
-0001d390: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-0001d3a0: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
-0001d3b0: 2020 2020 2020 6474 732e 6465 7065 6e64        dts.depend
-0001d3c0: 656e 7473 2e72 656d 6f76 6528 7473 290a  ents.remove(ts).
-0001d3d0: 2020 2020 2020 2020 2020 2020 6966 2064              if d
-0001d3e0: 7473 2e77 6169 7465 7273 3a0a 2020 2020  ts.waiters:.    
-0001d3f0: 2020 2020 2020 2020 2020 2020 6474 732e              dts.
-0001d400: 7761 6974 6572 732e 6469 7363 6172 6428  waiters.discard(
-0001d410: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
-0001d420: 6966 206e 6f74 2064 7473 2e64 6570 656e  if not dts.depen
-0001d430: 6465 6e74 7320 616e 6420 6e6f 7420 6474  dents and not dt
-0001d440: 732e 7768 6f5f 7761 6e74 733a 0a20 2020  s.who_wants:.   
-0001d450: 2020 2020 2020 2020 2020 2020 2023 2054               # T
-0001d460: 6173 6b20 6e6f 7420 6e65 6564 6564 2061  ask not needed a
-0001d470: 6e79 6d6f 7265 0a20 2020 2020 2020 2020  nymore.         
-0001d480: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
-0001d490: 7320 6973 206e 6f74 2074 730a 2020 2020  s is not ts.    
-0001d4a0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
-0001d4b0: 6d6d 656e 6461 7469 6f6e 735b 6474 732e  mmendations[dts.
-0001d4c0: 6b65 795d 203d 2022 666f 7267 6f74 7465  key] = "forgotte
-0001d4d0: 6e22 0a20 2020 2020 2020 2074 732e 6465  n".        ts.de
-0001d4e0: 7065 6e64 656e 6369 6573 2e63 6c65 6172  pendencies.clear
-0001d4f0: 2829 0a20 2020 2020 2020 2074 732e 7761  ().        ts.wa
-0001d500: 6974 696e 675f 6f6e 203d 204e 6f6e 650a  iting_on = None.
-0001d510: 0a20 2020 2020 2020 2066 6f72 2077 7320  .        for ws 
-0001d520: 696e 2074 732e 7768 6f5f 6861 7320 6f72  in ts.who_has or
-0001d530: 2028 293a 0a20 2020 2020 2020 2020 2020   ():.           
-0001d540: 2069 6620 7773 2e61 6464 7265 7373 2069   if ws.address i
-0001d550: 6e20 7365 6c66 2e77 6f72 6b65 7273 3a20  n self.workers: 
-0001d560: 2023 2069 6e20 6361 7365 2077 6f72 6b65   # in case worke
-0001d570: 7220 6861 7320 6469 6564 0a20 2020 2020  r has died.     
-0001d580: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
-0001d590: 725f 6d73 6773 5b77 732e 6164 6472 6573  r_msgs[ws.addres
-0001d5a0: 735d 203d 205b 0a20 2020 2020 2020 2020  s] = [.         
-0001d5b0: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+0001ac60: 2020 2020 2020 2073 772e 6164 6428 6164         sw.add(ad
+0001ac70: 6472 290a 0a20 2020 2020 2020 2020 2020  dr)..           
+0001ac80: 2020 2020 2064 775b 7265 736f 7572 6365       dw[resource
+0001ac90: 5d20 3d20 7377 0a0a 2020 2020 2020 2020  ] = sw..        
+0001aca0: 2020 2020 7777 203d 2073 6574 2e69 6e74      ww = set.int
+0001acb0: 6572 7365 6374 696f 6e28 2a64 772e 7661  ersection(*dw.va
+0001acc0: 6c75 6573 2829 290a 2020 2020 2020 2020  lues()).        
+0001acd0: 2020 2020 6966 2073 2069 7320 4e6f 6e65      if s is None
+0001ace0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001acf0: 2020 7320 3d20 7777 0a20 2020 2020 2020    s = ww.       
+0001ad00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001ad10: 2020 2020 2020 2020 2020 2073 2026 3d20             s &= 
+0001ad20: 7777 0a0a 2020 2020 2020 2020 6966 2073  ww..        if s
+0001ad30: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0001ad40: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0001ad50: 6520 2023 2041 6c6c 2077 6f72 6b65 7273  e  # All workers
+0001ad60: 2061 7265 2076 616c 6964 0a20 2020 2020   are valid.     
+0001ad70: 2020 2069 6620 6e6f 7420 733a 0a20 2020     if not s:.   
+0001ad80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001ad90: 7365 7428 2920 2023 204e 6f20 776f 726b  set()  # No work
+0001ada0: 6572 7320 6172 6520 7661 6c69 640a 0a20  ers are valid.. 
+0001adb0: 2020 2020 2020 2023 2053 6f6d 6520 776f         # Some wo
+0001adc0: 726b 6572 7320 6172 6520 7661 6c69 640a  rkers are valid.
+0001add0: 2020 2020 2020 2020 735f 7773 203d 207b          s_ws = {
+0001ade0: 7365 6c66 2e77 6f72 6b65 7273 5b61 6464  self.workers[add
+0001adf0: 725d 2066 6f72 2061 6464 7220 696e 2073  r] for addr in s
+0001ae00: 7d0a 2020 2020 2020 2020 6966 206c 656e  }.        if len
+0001ae10: 2873 656c 662e 7275 6e6e 696e 6729 203c  (self.running) <
+0001ae20: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
+0001ae30: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0001ae40: 735f 7773 2026 3d20 7365 6c66 2e72 756e  s_ws &= self.run
+0001ae50: 6e69 6e67 0a20 2020 2020 2020 2072 6574  ning.        ret
+0001ae60: 7572 6e20 735f 7773 0a0a 2020 2020 6465  urn s_ws..    de
+0001ae70: 6620 6163 7175 6972 655f 7265 736f 7572  f acquire_resour
+0001ae80: 6365 7328 7365 6c66 2c20 7473 3a20 5461  ces(self, ts: Ta
+0001ae90: 736b 5374 6174 652c 2077 733a 2057 6f72  skState, ws: Wor
+0001aea0: 6b65 7253 7461 7465 2920 2d3e 204e 6f6e  kerState) -> Non
+0001aeb0: 653a 0a20 2020 2020 2020 2069 6620 7473  e:.        if ts
+0001aec0: 2e72 6573 6f75 7263 655f 7265 7374 7269  .resource_restri
+0001aed0: 6374 696f 6e73 3a0a 2020 2020 2020 2020  ctions:.        
+0001aee0: 2020 2020 666f 7220 722c 2072 6571 7569      for r, requi
+0001aef0: 7265 6420 696e 2074 732e 7265 736f 7572  red in ts.resour
+0001af00: 6365 5f72 6573 7472 6963 7469 6f6e 732e  ce_restrictions.
+0001af10: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+0001af20: 2020 2020 2020 2020 2077 732e 7573 6564           ws.used
+0001af30: 5f72 6573 6f75 7263 6573 5b72 5d20 2b3d  _resources[r] +=
+0001af40: 2072 6571 7569 7265 640a 0a20 2020 2064   required..    d
+0001af50: 6566 2072 656c 6561 7365 5f72 6573 6f75  ef release_resou
+0001af60: 7263 6573 2873 656c 662c 2074 733a 2054  rces(self, ts: T
+0001af70: 6173 6b53 7461 7465 2c20 7773 3a20 576f  askState, ws: Wo
+0001af80: 726b 6572 5374 6174 6529 202d 3e20 4e6f  rkerState) -> No
+0001af90: 6e65 3a0a 2020 2020 2020 2020 6966 2074  ne:.        if t
+0001afa0: 732e 7265 736f 7572 6365 5f72 6573 7472  s.resource_restr
+0001afb0: 6963 7469 6f6e 733a 0a20 2020 2020 2020  ictions:.       
+0001afc0: 2020 2020 2066 6f72 2072 2c20 7265 7175       for r, requ
+0001afd0: 6972 6564 2069 6e20 7473 2e72 6573 6f75  ired in ts.resou
+0001afe0: 7263 655f 7265 7374 7269 6374 696f 6e73  rce_restrictions
+0001aff0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
+0001b000: 2020 2020 2020 2020 2020 7773 2e75 7365            ws.use
+0001b010: 645f 7265 736f 7572 6365 735b 725d 202d  d_resources[r] -
+0001b020: 3d20 7265 7175 6972 6564 0a0a 2020 2020  = required..    
+0001b030: 6465 6620 636f 6572 6365 5f68 6f73 746e  def coerce_hostn
+0001b040: 616d 6528 7365 6c66 2c20 686f 7374 3a20  ame(self, host: 
+0001b050: 4861 7368 6162 6c65 2920 2d3e 2073 7472  Hashable) -> str
+0001b060: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0001b070: 2020 2020 2020 436f 6572 6365 2074 6865        Coerce the
+0001b080: 2068 6f73 746e 616d 6520 6f66 2061 2077   hostname of a w
+0001b090: 6f72 6b65 722e 0a20 2020 2020 2020 2022  orker..        "
+0001b0a0: 2222 0a20 2020 2020 2020 2061 6c69 6173  "".        alias
+0001b0b0: 203d 2073 656c 662e 616c 6961 7365 732e   = self.aliases.
+0001b0c0: 6765 7428 686f 7374 290a 2020 2020 2020  get(host).      
+0001b0d0: 2020 6966 2061 6c69 6173 2069 7320 6e6f    if alias is no
+0001b0e0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0001b0f0: 2020 2020 7773 203d 2073 656c 662e 776f      ws = self.wo
+0001b100: 726b 6572 735b 616c 6961 735d 0a20 2020  rkers[alias].   
+0001b110: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001b120: 7773 2e68 6f73 740a 2020 2020 2020 2020  ws.host.        
+0001b130: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001b140: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+0001b150: 6e63 6528 686f 7374 2c20 7374 7229 0a20  nce(host, str). 
+0001b160: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001b170: 6e20 686f 7374 0a0a 2020 2020 6465 6620  n host..    def 
+0001b180: 776f 726b 6572 5f6f 626a 6563 7469 7665  worker_objective
+0001b190: 2873 656c 662c 2074 733a 2054 6173 6b53  (self, ts: TaskS
+0001b1a0: 7461 7465 2c20 7773 3a20 576f 726b 6572  tate, ws: Worker
+0001b1b0: 5374 6174 6529 202d 3e20 7475 706c 653a  State) -> tuple:
+0001b1c0: 0a20 2020 2020 2020 2022 2222 4f62 6a65  .        """Obje
+0001b1d0: 6374 6976 6520 6675 6e63 7469 6f6e 2074  ctive function t
+0001b1e0: 6f20 6465 7465 726d 696e 6520 7768 6963  o determine whic
+0001b1f0: 6820 776f 726b 6572 2073 686f 756c 6420  h worker should 
+0001b200: 6765 7420 7468 6520 7461 736b 0a0a 2020  get the task..  
+0001b210: 2020 2020 2020 4d69 6e69 6d69 7a65 2065        Minimize e
+0001b220: 7870 6563 7465 6420 7374 6172 7420 7469  xpected start ti
+0001b230: 6d65 2e20 2049 6620 6120 7469 6520 7468  me.  If a tie th
+0001b240: 656e 2062 7265 616b 2077 6974 6820 6461  en break with da
+0001b250: 7461 2073 746f 7261 6765 2e0a 2020 2020  ta storage..    
+0001b260: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001b270: 636f 6d6d 5f62 7974 6573 203d 2073 756d  comm_bytes = sum
+0001b280: 280a 2020 2020 2020 2020 2020 2020 6474  (.            dt
+0001b290: 732e 6765 745f 6e62 7974 6573 2829 2066  s.get_nbytes() f
+0001b2a0: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
+0001b2b0: 656e 6465 6e63 6965 7320 6966 2077 7320  endencies if ws 
+0001b2c0: 6e6f 7420 696e 2028 6474 732e 7768 6f5f  not in (dts.who_
+0001b2d0: 6861 7320 6f72 2028 2929 0a20 2020 2020  has or ()).     
+0001b2e0: 2020 2029 0a0a 2020 2020 2020 2020 7374     )..        st
+0001b2f0: 6163 6b5f 7469 6d65 203d 2077 732e 6f63  ack_time = ws.oc
+0001b300: 6375 7061 6e63 7920 2f20 7773 2e6e 7468  cupancy / ws.nth
+0001b310: 7265 6164 730a 2020 2020 2020 2020 7374  reads.        st
+0001b320: 6172 745f 7469 6d65 203d 2073 7461 636b  art_time = stack
+0001b330: 5f74 696d 6520 2b20 636f 6d6d 5f62 7974  _time + comm_byt
+0001b340: 6573 202f 2073 656c 662e 6261 6e64 7769  es / self.bandwi
+0001b350: 6474 680a 0a20 2020 2020 2020 2069 6620  dth..        if 
+0001b360: 7473 2e61 6374 6f72 3a0a 2020 2020 2020  ts.actor:.      
+0001b370: 2020 2020 2020 7265 7475 726e 2028 6c65        return (le
+0001b380: 6e28 7773 2e61 6374 6f72 7329 2c20 7374  n(ws.actors), st
+0001b390: 6172 745f 7469 6d65 2c20 7773 2e6e 6279  art_time, ws.nby
+0001b3a0: 7465 7329 0a20 2020 2020 2020 2065 6c73  tes).        els
+0001b3b0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001b3c0: 6574 7572 6e20 2873 7461 7274 5f74 696d  eturn (start_tim
+0001b3d0: 652c 2077 732e 6e62 7974 6573 290a 0a20  e, ws.nbytes).. 
+0001b3e0: 2020 2064 6566 2061 6464 5f72 6570 6c69     def add_repli
+0001b3f0: 6361 2873 656c 662c 2074 733a 2054 6173  ca(self, ts: Tas
+0001b400: 6b53 7461 7465 2c20 7773 3a20 576f 726b  kState, ws: Work
+0001b410: 6572 5374 6174 6529 202d 3e20 4e6f 6e65  erState) -> None
+0001b420: 3a0a 2020 2020 2020 2020 2222 224e 6f74  :.        """Not
+0001b430: 6520 7468 6174 2061 2077 6f72 6b65 7220  e that a worker 
+0001b440: 686f 6c64 7320 6120 7265 706c 6963 6120  holds a replica 
+0001b450: 6f66 2061 2074 6173 6b20 7769 7468 2073  of a task with s
+0001b460: 7461 7465 3d27 6d65 6d6f 7279 2722 2222  tate='memory'"""
+0001b470: 0a20 2020 2020 2020 2077 732e 6164 645f  .        ws.add_
+0001b480: 7265 706c 6963 6128 7473 290a 2020 2020  replica(ts).    
+0001b490: 2020 2020 6173 7365 7274 2074 732e 7768      assert ts.wh
+0001b4a0: 6f5f 6861 730a 2020 2020 2020 2020 6966  o_has.        if
+0001b4b0: 206c 656e 2874 732e 7768 6f5f 6861 7329   len(ts.who_has)
+0001b4c0: 203d 3d20 323a 0a20 2020 2020 2020 2020   == 2:.         
+0001b4d0: 2020 2073 656c 662e 7265 706c 6963 6174     self.replicat
+0001b4e0: 6564 5f74 6173 6b73 2e61 6464 2874 7329  ed_tasks.add(ts)
+0001b4f0: 0a0a 2020 2020 6465 6620 7265 6d6f 7665  ..    def remove
+0001b500: 5f72 6570 6c69 6361 2873 656c 662c 2074  _replica(self, t
+0001b510: 733a 2054 6173 6b53 7461 7465 2c20 7773  s: TaskState, ws
+0001b520: 3a20 576f 726b 6572 5374 6174 6529 202d  : WorkerState) -
+0001b530: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0001b540: 2222 224e 6f74 6520 7468 6174 2061 2077  """Note that a w
+0001b550: 6f72 6b65 7220 6e6f 206c 6f6e 6765 7220  orker no longer 
+0001b560: 686f 6c64 7320 6120 7265 706c 6963 6120  holds a replica 
+0001b570: 6f66 2061 2074 6173 6b22 2222 0a20 2020  of a task""".   
+0001b580: 2020 2020 2077 732e 7265 6d6f 7665 5f72       ws.remove_r
+0001b590: 6570 6c69 6361 2874 7329 0a20 2020 2020  eplica(ts).     
+0001b5a0: 2020 2069 6620 6c65 6e28 7473 2e77 686f     if len(ts.who
+0001b5b0: 5f68 6173 206f 7220 2829 2920 3d3d 2031  _has or ()) == 1
+0001b5c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001b5d0: 6c66 2e72 6570 6c69 6361 7465 645f 7461  lf.replicated_ta
+0001b5e0: 736b 732e 7265 6d6f 7665 2874 7329 0a0a  sks.remove(ts)..
+0001b5f0: 2020 2020 6465 6620 7265 6d6f 7665 5f61      def remove_a
+0001b600: 6c6c 5f72 6570 6c69 6361 7328 7365 6c66  ll_replicas(self
+0001b610: 2c20 7473 3a20 5461 736b 5374 6174 6529  , ts: TaskState)
+0001b620: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001b630: 2020 2222 2252 656d 6f76 6520 616c 6c20    """Remove all 
+0001b640: 7265 706c 6963 6173 206f 6620 6120 7461  replicas of a ta
+0001b650: 736b 2066 726f 6d20 616c 6c20 776f 726b  sk from all work
+0001b660: 6572 7322 2222 0a20 2020 2020 2020 206e  ers""".        n
+0001b670: 6279 7465 7320 3d20 7473 2e67 6574 5f6e  bytes = ts.get_n
+0001b680: 6279 7465 7328 290a 2020 2020 2020 2020  bytes().        
+0001b690: 6966 206e 6f74 2074 732e 7768 6f5f 6861  if not ts.who_ha
+0001b6a0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+0001b6b0: 6574 7572 6e0a 2020 2020 2020 2020 666f  eturn.        fo
+0001b6c0: 7220 7773 2069 6e20 7473 2e77 686f 5f68  r ws in ts.who_h
+0001b6d0: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
+0001b6e0: 7773 2e6e 6279 7465 7320 2d3d 206e 6279  ws.nbytes -= nby
+0001b6f0: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+0001b700: 6465 6c20 7773 2e5f 6861 735f 7768 6174  del ws._has_what
+0001b710: 5b74 735d 0a20 2020 2020 2020 2069 6620  [ts].        if 
+0001b720: 6c65 6e28 7473 2e77 686f 5f68 6173 2920  len(ts.who_has) 
+0001b730: 3e20 313a 0a20 2020 2020 2020 2020 2020  > 1:.           
+0001b740: 2073 656c 662e 7265 706c 6963 6174 6564   self.replicated
+0001b750: 5f74 6173 6b73 2e72 656d 6f76 6528 7473  _tasks.remove(ts
+0001b760: 290a 2020 2020 2020 2020 7473 2e77 686f  ).        ts.who
+0001b770: 5f68 6173 203d 204e 6f6e 650a 0a20 2020  _has = None..   
+0001b780: 2064 6566 2062 756c 6b5f 7363 6865 6475   def bulk_schedu
+0001b790: 6c65 5f75 6e72 756e 6e61 626c 655f 6166  le_unrunnable_af
+0001b7a0: 7465 725f 6164 6469 6e67 5f77 6f72 6b65  ter_adding_worke
+0001b7b0: 7228 7365 6c66 2c20 7773 3a20 576f 726b  r(self, ws: Work
+0001b7c0: 6572 5374 6174 6529 202d 3e20 5265 6373  erState) -> Recs
+0001b7d0: 3a0a 2020 2020 2020 2020 2222 2253 656e  :.        """Sen
+0001b7e0: 6420 6060 6e6f 2d77 6f72 6b65 7260 6020  d ``no-worker`` 
+0001b7f0: 7461 736b 7320 746f 2060 6070 726f 6365  tasks to ``proce
+0001b800: 7373 696e 6760 6020 7468 6174 2074 6869  ssing`` that thi
+0001b810: 7320 776f 726b 6572 2063 616e 2068 616e  s worker can han
+0001b820: 646c 652e 0a0a 2020 2020 2020 2020 5265  dle...        Re
+0001b830: 7475 726e 7320 7072 696f 7269 7479 2d6f  turns priority-o
+0001b840: 7264 6572 6564 2072 6563 6f6d 6d65 6e64  rdered recommend
+0001b850: 6174 696f 6e73 2e0a 2020 2020 2020 2020  ations..        
+0001b860: 2222 220a 2020 2020 2020 2020 7275 6e6e  """.        runn
+0001b870: 6162 6c65 3a20 6c69 7374 5b54 6173 6b53  able: list[TaskS
+0001b880: 7461 7465 5d20 3d20 5b5d 0a20 2020 2020  tate] = [].     
+0001b890: 2020 2066 6f72 2074 7320 696e 2073 656c     for ts in sel
+0001b8a0: 662e 756e 7275 6e6e 6162 6c65 3a0a 2020  f.unrunnable:.  
+0001b8b0: 2020 2020 2020 2020 2020 7661 6c69 6420            valid 
+0001b8c0: 3d20 7365 6c66 2e76 616c 6964 5f77 6f72  = self.valid_wor
+0001b8d0: 6b65 7273 2874 7329 0a20 2020 2020 2020  kers(ts).       
+0001b8e0: 2020 2020 2069 6620 7661 6c69 6420 6973       if valid is
+0001b8f0: 204e 6f6e 6520 6f72 2077 7320 696e 2076   None or ws in v
+0001b900: 616c 6964 3a0a 2020 2020 2020 2020 2020  alid:.          
+0001b910: 2020 2020 2020 7275 6e6e 6162 6c65 2e61        runnable.a
+0001b920: 7070 656e 6428 7473 290a 0a20 2020 2020  ppend(ts)..     
+0001b930: 2020 2023 2052 6563 6f6d 6d65 6e64 6174     # Recommendat
+0001b940: 696f 6e73 2061 7265 2070 726f 6365 7373  ions are process
+0001b950: 6564 204c 4946 4f2c 2068 656e 6365 2074  ed LIFO, hence t
+0001b960: 6865 2072 6576 6572 7365 6420 6f72 6465  he reversed orde
+0001b970: 720a 2020 2020 2020 2020 7275 6e6e 6162  r.        runnab
+0001b980: 6c65 2e73 6f72 7428 6b65 793d 6f70 6572  le.sort(key=oper
+0001b990: 6174 6f72 2e61 7474 7267 6574 7465 7228  ator.attrgetter(
+0001b9a0: 2270 7269 6f72 6974 7922 292c 2072 6576  "priority"), rev
+0001b9b0: 6572 7365 3d54 7275 6529 0a20 2020 2020  erse=True).     
+0001b9c0: 2020 2072 6574 7572 6e20 7b74 732e 6b65     return {ts.ke
+0001b9d0: 793a 2022 7072 6f63 6573 7369 6e67 2220  y: "processing" 
+0001b9e0: 666f 7220 7473 2069 6e20 7275 6e6e 6162  for ts in runnab
+0001b9f0: 6c65 7d0a 0a20 2020 2064 6566 205f 7661  le}..    def _va
+0001ba00: 6c69 6461 7465 5f72 6561 6479 2873 656c  lidate_ready(sel
+0001ba10: 662c 2074 733a 2054 6173 6b53 7461 7465  f, ts: TaskState
+0001ba20: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0001ba30: 2020 2022 2222 5661 6c69 6461 7469 6f6e     """Validation
+0001ba40: 2066 6f72 2072 6561 6479 2073 7461 7465   for ready state
+0001ba50: 7320 2870 726f 6365 7373 696e 672c 2071  s (processing, q
+0001ba60: 7565 7565 642c 206e 6f2d 776f 726b 6572  ueued, no-worker
+0001ba70: 2922 2222 0a20 2020 2020 2020 2061 7373  )""".        ass
+0001ba80: 6572 7420 6e6f 7420 7473 2e77 6169 7469  ert not ts.waiti
+0001ba90: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
+0001baa0: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+0001bab0: 6861 730a 2020 2020 2020 2020 6173 7365  has.        asse
+0001bac0: 7274 206e 6f74 2074 732e 6578 6365 7074  rt not ts.except
+0001bad0: 696f 6e5f 626c 616d 650a 2020 2020 2020  ion_blame.      
+0001bae0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+0001baf0: 7072 6f63 6573 7369 6e67 5f6f 6e0a 2020  processing_on.  
+0001bb00: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+0001bb10: 2074 732e 6861 735f 6c6f 7374 5f64 6570   ts.has_lost_dep
+0001bb20: 656e 6465 6e63 6965 730a 2020 2020 2020  endencies.      
+0001bb30: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
+0001bb40: 696e 2073 656c 662e 756e 7275 6e6e 6162  in self.unrunnab
+0001bb50: 6c65 0a20 2020 2020 2020 2061 7373 6572  le.        asser
+0001bb60: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
+0001bb70: 2e71 7565 7565 640a 2020 2020 2020 2020  .queued.        
+0001bb80: 6173 7365 7274 2061 6c6c 2864 7473 2e77  assert all(dts.w
+0001bb90: 686f 5f68 6173 2066 6f72 2064 7473 2069  ho_has for dts i
+0001bba0: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
+0001bbb0: 7329 0a0a 2020 2020 6465 6620 5f61 6464  s)..    def _add
+0001bbc0: 5f74 6f5f 7072 6f63 6573 7369 6e67 280a  _to_processing(.
+0001bbd0: 2020 2020 2020 2020 7365 6c66 2c20 7473          self, ts
+0001bbe0: 3a20 5461 736b 5374 6174 652c 2077 733a  : TaskState, ws:
+0001bbf0: 2057 6f72 6b65 7253 7461 7465 2c20 7374   WorkerState, st
+0001bc00: 696d 756c 7573 5f69 643a 2073 7472 0a20  imulus_id: str. 
+0001bc10: 2020 2029 202d 3e20 5265 6373 4d73 6773     ) -> RecsMsgs
+0001bc20: 3a0a 2020 2020 2020 2020 2222 2253 6574  :.        """Set
+0001bc30: 2061 2074 6173 6b20 6173 2070 726f 6365   a task as proce
+0001bc40: 7373 696e 6720 6f6e 2061 2077 6f72 6b65  ssing on a worke
+0001bc50: 7220 616e 6420 7265 7475 726e 2074 6865  r and return the
+0001bc60: 2077 6f72 6b65 7220 6d65 7373 6167 6573   worker messages
+0001bc70: 2074 6f20 7365 6e64 2222 220a 2020 2020   to send""".    
+0001bc80: 2020 2020 6966 2073 656c 662e 7661 6c69      if self.vali
+0001bc90: 6461 7465 3a0a 2020 2020 2020 2020 2020  date:.          
+0001bca0: 2020 7365 6c66 2e5f 7661 6c69 6461 7465    self._validate
+0001bcb0: 5f72 6561 6479 2874 7329 0a20 2020 2020  _ready(ts).     
+0001bcc0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+0001bcd0: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
+0001bce0: 2c20 7365 6c66 2e72 756e 6e69 6e67 0a20  , self.running. 
+0001bcf0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0001bd00: 7420 286f 203a 3d20 7365 6c66 2e77 6f72  t (o := self.wor
+0001bd10: 6b65 7273 2e67 6574 2877 732e 6164 6472  kers.get(ws.addr
+0001bd20: 6573 7329 2920 6973 2077 732c 2028 7773  ess)) is ws, (ws
+0001bd30: 2c20 6f29 0a0a 2020 2020 2020 2020 7773  , o)..        ws
+0001bd40: 2e61 6464 5f74 6f5f 7072 6f63 6573 7369  .add_to_processi
+0001bd50: 6e67 2874 7329 0a20 2020 2020 2020 2074  ng(ts).        t
+0001bd60: 732e 7072 6f63 6573 7369 6e67 5f6f 6e20  s.processing_on 
+0001bd70: 3d20 7773 0a20 2020 2020 2020 2074 732e  = ws.        ts.
+0001bd80: 7374 6174 6520 3d20 2270 726f 6365 7373  state = "process
+0001bd90: 696e 6722 0a20 2020 2020 2020 2073 656c  ing".        sel
+0001bda0: 662e 6163 7175 6972 655f 7265 736f 7572  f.acquire_resour
+0001bdb0: 6365 7328 7473 2c20 7773 290a 2020 2020  ces(ts, ws).    
+0001bdc0: 2020 2020 7365 6c66 2e63 6865 636b 5f69      self.check_i
+0001bdd0: 646c 655f 7361 7475 7261 7465 6428 7773  dle_saturated(ws
+0001bde0: 290a 2020 2020 2020 2020 7365 6c66 2e6e  ).        self.n
+0001bdf0: 5f74 6173 6b73 202b 3d20 310a 0a20 2020  _tasks += 1..   
+0001be00: 2020 2020 2069 6620 7473 2e61 6374 6f72       if ts.actor
+0001be10: 3a0a 2020 2020 2020 2020 2020 2020 7773  :.            ws
+0001be20: 2e61 6374 6f72 732e 6164 6428 7473 290a  .actors.add(ts).
+0001be30: 0a20 2020 2020 2020 206e 6465 705f 6279  .        ndep_by
+0001be40: 7465 7320 3d20 7375 6d28 6474 732e 6e62  tes = sum(dts.nb
+0001be50: 7974 6573 2066 6f72 2064 7473 2069 6e20  ytes for dts in 
+0001be60: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
+0001be70: 0a20 2020 2020 2020 2069 6620 280a 2020  .        if (.  
+0001be80: 2020 2020 2020 2020 2020 7773 2e6d 656d            ws.mem
+0001be90: 6f72 795f 6c69 6d69 740a 2020 2020 2020  ory_limit.      
+0001bea0: 2020 2020 2020 616e 6420 6e64 6570 5f62        and ndep_b
+0001beb0: 7974 6573 203e 2077 732e 6d65 6d6f 7279  ytes > ws.memory
+0001bec0: 5f6c 696d 6974 0a20 2020 2020 2020 2020  _limit.         
+0001bed0: 2020 2061 6e64 2064 6173 6b2e 636f 6e66     and dask.conf
+0001bee0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+0001bef0: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
+0001bf00: 792e 7465 726d 696e 6174 6522 290a 2020  y.terminate").  
+0001bf10: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+0001bf20: 2020 2020 2023 204e 6f74 650a 2020 2020       # Note.    
+0001bf30: 2020 2020 2020 2020 2320 2d2d 2d2d 0a20          # ----. 
+0001bf40: 2020 2020 2020 2020 2020 2023 2054 6869             # Thi
+0001bf50: 7320 6973 2061 2063 7275 6465 2073 6166  s is a crude saf
+0001bf60: 6574 7920 7379 7374 656d 2c20 6f6e 6c79  ety system, only
+0001bf70: 206d 6561 6e74 2074 6f20 7072 6576 656e   meant to preven
+0001bf80: 7420 6f72 6465 722d 6f66 2d6d 6167 6e69  t order-of-magni
+0001bf90: 7475 6465 0a20 2020 2020 2020 2020 2020  tude.           
+0001bfa0: 2023 2066 6174 2d66 696e 6765 7220 6572   # fat-finger er
+0001bfb0: 726f 7273 2e0a 2020 2020 2020 2020 2020  rors..          
+0001bfc0: 2020 230a 2020 2020 2020 2020 2020 2020    #.            
+0001bfd0: 2320 466f 7220 636f 6c6c 6563 7469 6f6e  # For collection
+0001bfe0: 2066 696e 616c 697a 6572 7320 616e 6420   finalizers and 
+0001bff0: 696e 2067 656e 6572 616c 206d 6f73 7420  in general most 
+0001c000: 636f 6e63 6174 206f 7065 7261 7469 6f6e  concat operation
+0001c010: 732c 2069 7420 7461 6b65 730a 2020 2020  s, it takes.    
+0001c020: 2020 2020 2020 2020 2320 6120 6c6f 7420          # a lot 
+0001c030: 6c65 7373 2074 6f20 6b69 6c6c 206f 6666  less to kill off
+0001c040: 2074 6865 2077 6f72 6b65 723b 2079 6f75   the worker; you
+0001c050: 276c 6c20 6a75 7374 206e 6565 640a 2020  'll just need.  
+0001c060: 2020 2020 2020 2020 2020 2320 6e64 6570            # ndep
+0001c070: 5f62 7974 6573 202a 2032 203e 2077 732e  _bytes * 2 > ws.
+0001c080: 6d65 6d6f 7279 5f6c 696d 6974 202a 2074  memory_limit * t
+0001c090: 6572 6d69 6e61 7465 2074 6872 6573 686f  erminate thresho
+0001c0a0: 6c64 2e0a 2020 2020 2020 2020 2020 2020  ld..            
+0001c0b0: 230a 2020 2020 2020 2020 2020 2020 2320  #.            # 
+0001c0c0: 496e 2068 6574 6572 6f67 656e 656f 7573  In heterogeneous
+0001c0d0: 2063 6c75 7374 6572 7320 7769 7468 2077   clusters with w
+0001c0e0: 6f72 6b65 7273 206d 6f75 6e74 696e 6720  orkers mounting 
+0001c0f0: 6469 6666 6572 656e 7420 616d 6f75 6e74  different amount
+0001c100: 7320 6f66 0a20 2020 2020 2020 2020 2020  s of.           
+0001c110: 2023 206d 656d 6f72 792c 2074 6865 2075   # memory, the u
+0001c120: 7365 7220 6973 2065 7870 6563 7465 6420  ser is expected 
+0001c130: 746f 206d 616e 7561 6c6c 7920 7365 7420  to manually set 
+0001c140: 686f 7374 2f77 6f72 6b65 722f 7265 736f  host/worker/reso
+0001c150: 7572 6365 0a20 2020 2020 2020 2020 2020  urce.           
+0001c160: 2023 2072 6573 7472 6963 7469 6f6e 732e   # restrictions.
+0001c170: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
+0001c180: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
+0001c190: 2020 2020 2066 2254 6173 6b20 7b74 732e       f"Task {ts.
+0001c1a0: 6b65 7921 727d 2068 6173 207b 666f 726d  key!r} has {form
+0001c1b0: 6174 5f62 7974 6573 286e 6465 705f 6279  at_bytes(ndep_by
+0001c1c0: 7465 7329 7d20 776f 7274 6820 6f66 2069  tes)} worth of i
+0001c1d0: 6e70 7574 2022 0a20 2020 2020 2020 2020  nput ".         
+0001c1e0: 2020 2020 2020 2066 2264 6570 656e 6465         f"depende
+0001c1f0: 6e63 6965 732c 2062 7574 2077 6f72 6b65  ncies, but worke
+0001c200: 7220 7b77 732e 6164 6472 6573 737d 2068  r {ws.address} h
+0001c210: 6173 206d 656d 6f72 795f 6c69 6d69 7420  as memory_limit 
+0001c220: 7365 7420 746f 2022 0a20 2020 2020 2020  set to ".       
+0001c230: 2020 2020 2020 2020 2066 227b 666f 726d           f"{form
+0001c240: 6174 5f62 7974 6573 2877 732e 6d65 6d6f  at_bytes(ws.memo
+0001c250: 7279 5f6c 696d 6974 297d 2e22 0a20 2020  ry_limit)}.".   
+0001c260: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0001c270: 2020 2020 2020 2069 6620 7473 2e70 7265         if ts.pre
+0001c280: 6669 782e 6e61 6d65 203d 3d20 2266 696e  fix.name == "fin
+0001c290: 616c 697a 6522 3a0a 2020 2020 2020 2020  alize":.        
+0001c2a0: 2020 2020 2020 2020 6d73 6720 2b3d 2028          msg += (
+0001c2b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001c2c0: 2020 2020 2022 2049 7420 7365 656d 7320       " It seems 
+0001c2d0: 6c69 6b65 2079 6f75 2063 616c 6c65 6420  like you called 
+0001c2e0: 636c 6965 6e74 2e63 6f6d 7075 7465 2829  client.compute()
+0001c2f0: 206f 6e20 6120 6875 6765 2063 6f6c 6c65   on a huge colle
+0001c300: 6374 696f 6e2e 2022 0a20 2020 2020 2020  ction. ".       
+0001c310: 2020 2020 2020 2020 2020 2020 2022 436f               "Co
+0001c320: 6e73 6964 6572 2077 7269 7469 6e67 2074  nsider writing t
+0001c330: 6f20 6469 7374 7269 6275 7465 6420 7374  o distributed st
+0001c340: 6f72 6167 6520 6f72 2073 6c69 6369 6e67  orage or slicing
+0001c350: 2f72 6564 7563 696e 6720 6669 7273 742e  /reducing first.
+0001c360: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0001c370: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0001c380: 6c6f 6767 6572 2e65 7272 6f72 286d 7367  logger.error(msg
+0001c390: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0001c3a0: 7475 726e 2073 656c 662e 5f74 7261 6e73  turn self._trans
+0001c3b0: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
+0001c3c0: 2020 2020 2020 2074 732e 6b65 792c 0a20         ts.key,. 
+0001c3d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0001c3e0: 6572 7265 6422 2c0a 2020 2020 2020 2020  erred",.        
+0001c3f0: 2020 2020 2020 2020 6578 6365 7074 696f          exceptio
+0001c400: 6e3d 7069 636b 6c65 2e64 756d 7073 284d  n=pickle.dumps(M
+0001c410: 656d 6f72 7945 7272 6f72 286d 7367 2929  emoryError(msg))
+0001c420: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001c430: 2020 6361 7573 653d 7473 2e6b 6579 2c0a    cause=ts.key,.
+0001c440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c450: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
+0001c460: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
+0001c470: 2020 2020 2020 2020 2077 6f72 6b65 723d           worker=
+0001c480: 7773 2e61 6464 7265 7373 2c0a 2020 2020  ws.address,.    
+0001c490: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0001c4a0: 2020 2072 6574 7572 6e20 7b7d 2c20 7b7d     return {}, {}
+0001c4b0: 2c20 7b77 732e 6164 6472 6573 733a 205b  , {ws.address: [
+0001c4c0: 7365 6c66 2e5f 7461 736b 5f74 6f5f 6d73  self._task_to_ms
+0001c4d0: 6728 7473 295d 7d0a 0a20 2020 2064 6566  g(ts)]}..    def
+0001c4e0: 205f 6578 6974 5f70 726f 6365 7373 696e   _exit_processin
+0001c4f0: 675f 636f 6d6d 6f6e 2873 656c 662c 2074  g_common(self, t
+0001c500: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
+0001c510: 2057 6f72 6b65 7253 7461 7465 207c 204e   WorkerState | N
+0001c520: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0001c530: 5265 6d6f 7665 202a 7473 2a20 6672 6f6d  Remove *ts* from
+0001c540: 2074 6865 2073 6574 206f 6620 7072 6f63   the set of proc
+0001c550: 6573 7369 6e67 2074 6173 6b73 2e0a 0a20  essing tasks... 
+0001c560: 2020 2020 2020 2052 6574 7572 6e73 0a20         Returns. 
+0001c570: 2020 2020 2020 202d 2d2d 2d2d 2d2d 0a20         -------. 
+0001c580: 2020 2020 2020 2057 6f72 6b65 7220 7374         Worker st
+0001c590: 6174 6520 6f66 2074 6865 2077 6f72 6b65  ate of the worke
+0001c5a0: 7220 7468 6174 2070 726f 6365 7373 6564  r that processed
+0001c5b0: 202a 7473 2a20 6966 2074 6865 2077 6f72   *ts* if the wor
+0001c5c0: 6b65 7220 6973 2063 7572 7265 6e74 2c0a  ker is current,.
+0001c5d0: 2020 2020 2020 2020 4e6f 6e65 2069 6620          None if 
+0001c5e0: 7468 6520 776f 726b 6572 2069 7320 7374  the worker is st
+0001c5f0: 616c 652e 0a0a 2020 2020 2020 2020 5365  ale...        Se
+0001c600: 6520 616c 736f 0a20 2020 2020 2020 202d  e also.        -
+0001c610: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+0001c620: 5363 6865 6475 6c65 722e 5f73 6574 5f64  Scheduler._set_d
+0001c630: 7572 6174 696f 6e5f 6573 7469 6d61 7465  uration_estimate
+0001c640: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001c650: 2020 2020 2077 7320 3d20 7473 2e70 726f       ws = ts.pro
+0001c660: 6365 7373 696e 675f 6f6e 0a20 2020 2020  cessing_on.     
+0001c670: 2020 2061 7373 6572 7420 7773 0a20 2020     assert ws.   
+0001c680: 2020 2020 2074 732e 7072 6f63 6573 7369       ts.processi
+0001c690: 6e67 5f6f 6e20 3d20 4e6f 6e65 0a0a 2020  ng_on = None..  
+0001c6a0: 2020 2020 2020 7773 2e72 656d 6f76 655f        ws.remove_
+0001c6b0: 6672 6f6d 5f70 726f 6365 7373 696e 6728  from_processing(
+0001c6c0: 7473 290a 2020 2020 2020 2020 6966 2073  ts).        if s
+0001c6d0: 656c 662e 776f 726b 6572 732e 6765 7428  elf.workers.get(
+0001c6e0: 7773 2e61 6464 7265 7373 2920 6973 206e  ws.address) is n
+0001c6f0: 6f74 2077 733a 2020 2320 6d61 7920 6861  ot ws:  # may ha
+0001c700: 7665 2062 6565 6e20 7265 6d6f 7665 640a  ve been removed.
+0001c710: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001c720: 726e 204e 6f6e 650a 0a20 2020 2020 2020  rn None..       
+0001c730: 2073 656c 662e 6368 6563 6b5f 6964 6c65   self.check_idle
+0001c740: 5f73 6174 7572 6174 6564 2877 7329 0a20  _saturated(ws). 
+0001c750: 2020 2020 2020 2073 656c 662e 7265 6c65         self.rele
+0001c760: 6173 655f 7265 736f 7572 6365 7328 7473  ase_resources(ts
+0001c770: 2c20 7773 290a 0a20 2020 2020 2020 2072  , ws)..        r
+0001c780: 6574 7572 6e20 7773 0a0a 2020 2020 6465  eturn ws..    de
+0001c790: 6620 5f61 6464 5f74 6f5f 6d65 6d6f 7279  f _add_to_memory
+0001c7a0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0001c7b0: 2020 2020 2020 2020 7473 3a20 5461 736b          ts: Task
+0001c7c0: 5374 6174 652c 0a20 2020 2020 2020 2077  State,.        w
+0001c7d0: 733a 2057 6f72 6b65 7253 7461 7465 2c0a  s: WorkerState,.
+0001c7e0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0001c7f0: 6461 7469 6f6e 733a 2052 6563 732c 0a20  dations: Recs,. 
+0001c800: 2020 2020 2020 2063 6c69 656e 745f 6d73         client_ms
+0001c810: 6773 3a20 4d73 6773 2c0a 2020 2020 2020  gs: Msgs,.      
+0001c820: 2020 7479 7065 3a20 6279 7465 7320 7c20    type: bytes | 
+0001c830: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+0001c840: 2020 2020 2074 7970 656e 616d 653a 2073       typename: s
+0001c850: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+0001c860: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
+0001c870: 0a20 2020 2020 2020 2022 2222 4164 6420  .        """Add 
+0001c880: 7473 2074 6f20 7468 6520 7365 7420 6f66  ts to the set of
+0001c890: 2069 6e2d 6d65 6d6f 7279 2074 6173 6b73   in-memory tasks
+0001c8a0: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
+0001c8b0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+0001c8c0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001c8d0: 2074 7320 6e6f 7420 696e 2077 732e 6861   ts not in ws.ha
+0001c8e0: 735f 7768 6174 0a0a 2020 2020 2020 2020  s_what..        
+0001c8f0: 7365 6c66 2e61 6464 5f72 6570 6c69 6361  self.add_replica
+0001c900: 2874 732c 2077 7329 0a0a 2020 2020 2020  (ts, ws)..      
+0001c910: 2020 6465 7073 203d 206c 6973 7428 7473    deps = list(ts
+0001c920: 2e64 6570 656e 6465 6e74 7329 0a20 2020  .dependents).   
+0001c930: 2020 2020 2069 6620 6c65 6e28 6465 7073       if len(deps
+0001c940: 2920 3e20 313a 0a20 2020 2020 2020 2020  ) > 1:.         
+0001c950: 2020 2064 6570 732e 736f 7274 286b 6579     deps.sort(key
+0001c960: 3d6f 7065 7261 746f 722e 6174 7472 6765  =operator.attrge
+0001c970: 7474 6572 2822 7072 696f 7269 7479 2229  tter("priority")
+0001c980: 2c20 7265 7665 7273 653d 5472 7565 290a  , reverse=True).
+0001c990: 0a20 2020 2020 2020 2066 6f72 2064 7473  .        for dts
+0001c9a0: 2069 6e20 6465 7073 3a0a 2020 2020 2020   in deps:.      
+0001c9b0: 2020 2020 2020 7320 3d20 6474 732e 7761        s = dts.wa
+0001c9c0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+0001c9d0: 2020 2020 2069 6620 7320 616e 6420 7473       if s and ts
+0001c9e0: 2069 6e20 733a 0a20 2020 2020 2020 2020   in s:.         
+0001c9f0: 2020 2020 2020 2073 2e64 6973 6361 7264         s.discard
+0001ca00: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
+0001ca10: 2020 2020 2069 6620 6e6f 7420 733a 2020       if not s:  
+0001ca20: 2320 6e65 7720 7461 736b 2072 6561 6479  # new task ready
+0001ca30: 2074 6f20 7275 6e0a 2020 2020 2020 2020   to run.        
+0001ca40: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+0001ca50: 6d6d 656e 6461 7469 6f6e 735b 6474 732e  mmendations[dts.
+0001ca60: 6b65 795d 203d 2022 7072 6f63 6573 7369  key] = "processi
+0001ca70: 6e67 220a 0a20 2020 2020 2020 2066 6f72  ng"..        for
+0001ca80: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0001ca90: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+0001caa0: 2020 2020 2073 203d 2064 7473 2e77 6169       s = dts.wai
+0001cab0: 7465 7273 0a20 2020 2020 2020 2020 2020  ters.           
+0001cac0: 2069 6620 733a 0a20 2020 2020 2020 2020   if s:.         
+0001cad0: 2020 2020 2020 2073 2e64 6973 6361 7264         s.discard
+0001cae0: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
+0001caf0: 2069 6620 6e6f 7420 7320 616e 6420 6e6f   if not s and no
+0001cb00: 7420 6474 732e 7768 6f5f 7761 6e74 733a  t dts.who_wants:
+0001cb10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cb20: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0001cb30: 5b64 7473 2e6b 6579 5d20 3d20 2272 656c  [dts.key] = "rel
+0001cb40: 6561 7365 6422 0a0a 2020 2020 2020 2020  eased"..        
+0001cb50: 6966 206e 6f74 2074 732e 7761 6974 6572  if not ts.waiter
+0001cb60: 7320 616e 6420 6e6f 7420 7473 2e77 686f  s and not ts.who
+0001cb70: 5f77 616e 7473 3a0a 2020 2020 2020 2020  _wants:.        
+0001cb80: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0001cb90: 6f6e 735b 7473 2e6b 6579 5d20 3d20 2272  ons[ts.key] = "r
+0001cba0: 656c 6561 7365 6422 0a20 2020 2020 2020  eleased".       
+0001cbb0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001cbc0: 2020 2072 6570 6f72 745f 6d73 673a 2064     report_msg: d
+0001cbd0: 6963 745b 7374 722c 2041 6e79 5d20 3d20  ict[str, Any] = 
+0001cbe0: 7b22 6f70 223a 2022 6b65 792d 696e 2d6d  {"op": "key-in-m
+0001cbf0: 656d 6f72 7922 2c20 226b 6579 223a 2074  emory", "key": t
+0001cc00: 732e 6b65 797d 0a20 2020 2020 2020 2020  s.key}.         
+0001cc10: 2020 2069 6620 7479 7065 2069 7320 6e6f     if type is no
+0001cc20: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+0001cc30: 2020 2020 2020 2020 7265 706f 7274 5f6d          report_m
+0001cc40: 7367 5b22 7479 7065 225d 203d 2074 7970  sg["type"] = typ
+0001cc50: 650a 2020 2020 2020 2020 2020 2020 666f  e.            fo
+0001cc60: 7220 6373 2069 6e20 7473 2e77 686f 5f77  r cs in ts.who_w
+0001cc70: 616e 7473 206f 7220 2829 3a0a 2020 2020  ants or ():.    
+0001cc80: 2020 2020 2020 2020 2020 2020 636c 6965              clie
+0001cc90: 6e74 5f6d 7367 735b 6373 2e63 6c69 656e  nt_msgs[cs.clien
+0001cca0: 745f 6b65 795d 203d 205b 7265 706f 7274  t_key] = [report
+0001ccb0: 5f6d 7367 5d0a 0a20 2020 2020 2020 2074  _msg]..        t
+0001ccc0: 732e 7374 6174 6520 3d20 226d 656d 6f72  s.state = "memor
+0001ccd0: 7922 0a20 2020 2020 2020 2074 732e 7479  y".        ts.ty
+0001cce0: 7065 203d 2074 7970 656e 616d 6520 2023  pe = typename  #
+0001ccf0: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
+0001cd00: 2020 2020 2020 7473 2e67 726f 7570 2e74        ts.group.t
+0001cd10: 7970 6573 2e61 6464 2874 7970 656e 616d  ypes.add(typenam
+0001cd20: 6529 2020 2320 7479 7065 3a20 6967 6e6f  e)  # type: igno
+0001cd30: 7265 0a0a 2020 2020 2020 2020 6373 203d  re..        cs =
+0001cd40: 2073 656c 662e 636c 6965 6e74 735b 2266   self.clients["f
+0001cd50: 6972 652d 616e 642d 666f 7267 6574 225d  ire-and-forget"]
+0001cd60: 0a20 2020 2020 2020 2069 6620 7473 2069  .        if ts i
+0001cd70: 6e20 6373 2e77 616e 7473 5f77 6861 743a  n cs.wants_what:
+0001cd80: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001cd90: 662e 5f63 6c69 656e 745f 7265 6c65 6173  f._client_releas
+0001cda0: 6573 5f6b 6579 7328 0a20 2020 2020 2020  es_keys(.       
+0001cdb0: 2020 2020 2020 2020 2063 733d 6373 2c0a           cs=cs,.
+0001cdc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cdd0: 6b65 7973 3d5b 7473 2e6b 6579 5d2c 0a20  keys=[ts.key],. 
+0001cde0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001cdf0: 6563 6f6d 6d65 6e64 6174 696f 6e73 3d72  ecommendations=r
+0001ce00: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c0a  ecommendations,.
+0001ce10: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+0001ce20: 2020 2064 6566 205f 7072 6f70 6167 6174     def _propagat
+0001ce30: 655f 7265 6c65 6173 6564 2873 656c 662c  e_released(self,
+0001ce40: 2074 733a 2054 6173 6b53 7461 7465 2c20   ts: TaskState, 
+0001ce50: 7265 636f 6d6d 656e 6461 7469 6f6e 733a  recommendations:
+0001ce60: 2052 6563 7329 202d 3e20 4e6f 6e65 3a0a   Recs) -> None:.
+0001ce70: 2020 2020 2020 2020 7473 2e73 7461 7465          ts.state
+0001ce80: 203d 2022 7265 6c65 6173 6564 220a 2020   = "released".  
+0001ce90: 2020 2020 2020 6b65 7920 3d20 7473 2e6b        key = ts.k
+0001cea0: 6579 0a0a 2020 2020 2020 2020 6966 2074  ey..        if t
+0001ceb0: 732e 6861 735f 6c6f 7374 5f64 6570 656e  s.has_lost_depen
+0001cec0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+0001ced0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+0001cee0: 696f 6e73 5b6b 6579 5d20 3d20 2266 6f72  ions[key] = "for
+0001cef0: 676f 7474 656e 220a 2020 2020 2020 2020  gotten".        
+0001cf00: 656c 6966 2074 732e 7761 6974 6572 7320  elif ts.waiters 
+0001cf10: 6f72 2074 732e 7768 6f5f 7761 6e74 733a  or ts.who_wants:
+0001cf20: 0a20 2020 2020 2020 2020 2020 2072 6563  .            rec
+0001cf30: 6f6d 6d65 6e64 6174 696f 6e73 5b6b 6579  ommendations[key
+0001cf40: 5d20 3d20 2277 6169 7469 6e67 220a 0a20  ] = "waiting".. 
+0001cf50: 2020 2020 2020 2069 6620 7265 636f 6d6d         if recomm
+0001cf60: 656e 6461 7469 6f6e 732e 6765 7428 6b65  endations.get(ke
+0001cf70: 7929 2021 3d20 2277 6169 7469 6e67 223a  y) != "waiting":
+0001cf80: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001cf90: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0001cfa0: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+0001cfb0: 2020 2020 2020 2020 2069 6620 6474 732e           if dts.
+0001cfc0: 7374 6174 6520 213d 2022 7265 6c65 6173  state != "releas
+0001cfd0: 6564 223a 0a20 2020 2020 2020 2020 2020  ed":.           
+0001cfe0: 2020 2020 2020 2020 2069 6620 6474 732e           if dts.
+0001cff0: 7761 6974 6572 733a 0a20 2020 2020 2020  waiters:.       
+0001d000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d010: 2064 7473 2e77 6169 7465 7273 2e64 6973   dts.waiters.dis
+0001d020: 6361 7264 2874 7329 0a20 2020 2020 2020  card(ts).       
+0001d030: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001d040: 6e6f 7420 6474 732e 7761 6974 6572 7320  not dts.waiters 
+0001d050: 616e 6420 6e6f 7420 6474 732e 7768 6f5f  and not dts.who_
+0001d060: 7761 6e74 733a 0a20 2020 2020 2020 2020  wants:.         
+0001d070: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001d080: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+0001d090: 7473 2e6b 6579 5d20 3d20 2272 656c 6561  ts.key] = "relea
+0001d0a0: 7365 6422 0a20 2020 2020 2020 2020 2020  sed".           
+0001d0b0: 2074 732e 7761 6974 6572 7320 3d20 4e6f   ts.waiters = No
+0001d0c0: 6e65 0a0a 2020 2020 2020 2020 6966 2073  ne..        if s
+0001d0d0: 656c 662e 7661 6c69 6461 7465 3a0a 2020  elf.validate:.  
+0001d0e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001d0f0: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
+0001d100: 6e67 5f6f 6e0a 2020 2020 2020 2020 2020  ng_on.          
+0001d110: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
+0001d120: 696e 2073 656c 662e 7175 6575 6564 0a0a  in self.queued..
+0001d130: 2020 2020 6465 6620 5f70 726f 7061 6761      def _propaga
+0001d140: 7465 5f66 6f72 676f 7474 656e 280a 2020  te_forgotten(.  
+0001d150: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0001d160: 2020 2020 7473 3a20 5461 736b 5374 6174      ts: TaskStat
+0001d170: 652c 0a20 2020 2020 2020 2072 6563 6f6d  e,.        recom
+0001d180: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
+0001d190: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
+0001d1a0: 5f6d 7367 733a 204d 7367 732c 0a20 2020  _msgs: Msgs,.   
+0001d1b0: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+0001d1c0: 3a20 7374 722c 0a20 2020 2029 202d 3e20  : str,.    ) -> 
+0001d1d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
+0001d1e0: 2e73 7461 7465 203d 2022 666f 7267 6f74  .state = "forgot
+0001d1f0: 7465 6e22 0a20 2020 2020 2020 2066 6f72  ten".        for
+0001d200: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0001d210: 6465 6e74 733a 0a20 2020 2020 2020 2020  dents:.         
+0001d220: 2020 2064 7473 2e68 6173 5f6c 6f73 745f     dts.has_lost_
+0001d230: 6465 7065 6e64 656e 6369 6573 203d 2054  dependencies = T
+0001d240: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
+0001d250: 6474 732e 6465 7065 6e64 656e 6369 6573  dts.dependencies
+0001d260: 2e72 656d 6f76 6528 7473 290a 2020 2020  .remove(ts).    
+0001d270: 2020 2020 2020 2020 6966 2064 7473 2e77          if dts.w
+0001d280: 6169 7469 6e67 5f6f 6e3a 0a20 2020 2020  aiting_on:.     
+0001d290: 2020 2020 2020 2020 2020 2064 7473 2e77             dts.w
+0001d2a0: 6169 7469 6e67 5f6f 6e2e 6469 7363 6172  aiting_on.discar
+0001d2b0: 6428 7473 290a 2020 2020 2020 2020 2020  d(ts).          
+0001d2c0: 2020 6966 2064 7473 2e73 7461 7465 206e    if dts.state n
+0001d2d0: 6f74 2069 6e20 2822 6d65 6d6f 7279 222c  ot in ("memory",
+0001d2e0: 2022 6572 7265 6422 293a 0a20 2020 2020   "erred"):.     
+0001d2f0: 2020 2020 2020 2020 2020 2023 2043 616e             # Can
+0001d300: 6e6f 7420 636f 6d70 7574 6520 7461 736b  not compute task
+0001d310: 2061 6e79 6d6f 7265 0a20 2020 2020 2020   anymore.       
+0001d320: 2020 2020 2020 2020 2072 6563 6f6d 6d65           recomme
+0001d330: 6e64 6174 696f 6e73 5b64 7473 2e6b 6579  ndations[dts.key
+0001d340: 5d20 3d20 2266 6f72 676f 7474 656e 220a  ] = "forgotten".
+0001d350: 2020 2020 2020 2020 7473 2e64 6570 656e          ts.depen
+0001d360: 6465 6e74 732e 636c 6561 7228 290a 2020  dents.clear().  
+0001d370: 2020 2020 2020 7473 2e77 6169 7465 7273        ts.waiters
+0001d380: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+0001d390: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
+0001d3a0: 6570 656e 6465 6e63 6965 733a 0a20 2020  ependencies:.   
+0001d3b0: 2020 2020 2020 2020 2064 7473 2e64 6570           dts.dep
+0001d3c0: 656e 6465 6e74 732e 7265 6d6f 7665 2874  endents.remove(t
+0001d3d0: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
+0001d3e0: 6620 6474 732e 7761 6974 6572 733a 0a20  f dts.waiters:. 
+0001d3f0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0001d400: 7473 2e77 6169 7465 7273 2e64 6973 6361  ts.waiters.disca
+0001d410: 7264 2874 7329 0a20 2020 2020 2020 2020  rd(ts).         
+0001d420: 2020 2069 6620 6e6f 7420 6474 732e 6465     if not dts.de
+0001d430: 7065 6e64 656e 7473 2061 6e64 206e 6f74  pendents and not
+0001d440: 2064 7473 2e77 686f 5f77 616e 7473 3a0a   dts.who_wants:.
+0001d450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d460: 2320 5461 736b 206e 6f74 206e 6565 6465  # Task not neede
+0001d470: 6420 616e 796d 6f72 650a 2020 2020 2020  d anymore.      
+0001d480: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0001d490: 2064 7473 2069 7320 6e6f 7420 7473 0a20   dts is not ts. 
+0001d4a0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001d4b0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b64  ecommendations[d
+0001d4c0: 7473 2e6b 6579 5d20 3d20 2266 6f72 676f  ts.key] = "forgo
+0001d4d0: 7474 656e 220a 2020 2020 2020 2020 7473  tten".        ts
+0001d4e0: 2e64 6570 656e 6465 6e63 6965 732e 636c  .dependencies.cl
+0001d4f0: 6561 7228 290a 2020 2020 2020 2020 7473  ear().        ts
+0001d500: 2e77 6169 7469 6e67 5f6f 6e20 3d20 4e6f  .waiting_on = No
+0001d510: 6e65 0a0a 2020 2020 2020 2020 666f 7220  ne..        for 
+0001d520: 7773 2069 6e20 7473 2e77 686f 5f68 6173  ws in ts.who_has
+0001d530: 206f 7220 2829 3a0a 2020 2020 2020 2020   or ():.        
+0001d540: 2020 2020 6966 2077 732e 6164 6472 6573      if ws.addres
+0001d550: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
+0001d560: 733a 2020 2320 696e 2063 6173 6520 776f  s:  # in case wo
+0001d570: 726b 6572 2068 6173 2064 6965 640a 2020  rker has died.  
+0001d580: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+0001d590: 726b 6572 5f6d 7367 735b 7773 2e61 6464  rker_msgs[ws.add
+0001d5a0: 7265 7373 5d20 3d20 5b0a 2020 2020 2020  ress] = [.      
+0001d5b0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
 0001d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d5d0: 2020 2020 2022 6f70 223a 2022 6672 6565       "op": "free
-0001d5e0: 2d6b 6579 7322 2c0a 2020 2020 2020 2020  -keys",.        
+0001d5d0: 2020 2020 2020 2020 226f 7022 3a20 2266          "op": "f
+0001d5e0: 7265 652d 6b65 7973 222c 0a20 2020 2020  ree-keys",.     
 0001d5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d600: 226b 6579 7322 3a20 5b74 732e 6b65 795d  "keys": [ts.key]
-0001d610: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0001d620: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
-0001d630: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
-0001d640: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
-0001d650: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0001d660: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-0001d670: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
-0001d680: 655f 616c 6c5f 7265 706c 6963 6173 2874  e_all_replicas(t
-0001d690: 7329 0a0a 2020 2020 6465 6620 5f63 6c69  s)..    def _cli
-0001d6a0: 656e 745f 7265 6c65 6173 6573 5f6b 6579  ent_releases_key
-0001d6b0: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
-0001d6c0: 0a20 2020 2020 2020 206b 6579 733a 2043  .        keys: C
-0001d6d0: 6f6c 6c65 6374 696f 6e5b 4b65 795d 2c0a  ollection[Key],.
-0001d6e0: 2020 2020 2020 2020 6373 3a20 436c 6965          cs: Clie
-0001d6f0: 6e74 5374 6174 652c 0a20 2020 2020 2020  ntState,.       
-0001d700: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0001d710: 3a20 5265 6373 2c0a 2020 2020 2920 2d3e  : Recs,.    ) ->
-0001d720: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0001d730: 2222 5265 6d6f 7665 206b 6579 7320 6672  ""Remove keys fr
-0001d740: 6f6d 2063 6c69 656e 7420 6465 7369 7265  om client desire
-0001d750: 6420 6c69 7374 2222 220a 2020 2020 2020  d list""".      
-0001d760: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-0001d770: 436c 6965 6e74 2025 7320 7265 6c65 6173  Client %s releas
-0001d780: 6573 206b 6579 733a 2025 7322 2c20 6373  es keys: %s", cs
-0001d790: 2e63 6c69 656e 745f 6b65 792c 206b 6579  .client_key, key
-0001d7a0: 7329 0a20 2020 2020 2020 2066 6f72 206b  s).        for k
-0001d7b0: 6579 2069 6e20 6b65 7973 3a0a 2020 2020  ey in keys:.    
-0001d7c0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-0001d7d0: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
-0001d7e0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001d7f0: 7473 2069 7320 6e6f 7420 4e6f 6e65 2061  ts is not None a
-0001d800: 6e64 2074 7320 696e 2063 732e 7761 6e74  nd ts in cs.want
-0001d810: 735f 7768 6174 3a0a 2020 2020 2020 2020  s_what:.        
-0001d820: 2020 2020 2020 2020 6373 2e77 616e 7473          cs.wants
-0001d830: 5f77 6861 742e 7265 6d6f 7665 2874 7329  _what.remove(ts)
-0001d840: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001d850: 2069 6620 7473 2e77 686f 5f77 616e 7473   if ts.who_wants
-0001d860: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001d870: 2020 2020 2020 7473 2e77 686f 5f77 616e        ts.who_wan
-0001d880: 7473 2e72 656d 6f76 6528 6373 290a 2020  ts.remove(cs).  
-0001d890: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0001d8a0: 206e 6f74 2074 732e 7768 6f5f 7761 6e74   not ts.who_want
-0001d8b0: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0001d8c0: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
-0001d8d0: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
+0001d600: 2020 2022 6b65 7973 223a 205b 7473 2e6b     "keys": [ts.k
+0001d610: 6579 5d2c 0a20 2020 2020 2020 2020 2020  ey],.           
+0001d620: 2020 2020 2020 2020 2020 2020 2022 7374               "st
+0001d630: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
+0001d640: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
+0001d650: 2020 2020 2020 2020 2020 2020 207d 0a20               }. 
+0001d660: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+0001d670: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+0001d680: 6d6f 7665 5f61 6c6c 5f72 6570 6c69 6361  move_all_replica
+0001d690: 7328 7473 290a 0a20 2020 2064 6566 205f  s(ts)..    def _
+0001d6a0: 636c 6965 6e74 5f72 656c 6561 7365 735f  client_releases_
+0001d6b0: 6b65 7973 280a 2020 2020 2020 2020 7365  keys(.        se
+0001d6c0: 6c66 2c0a 2020 2020 2020 2020 6b65 7973  lf,.        keys
+0001d6d0: 3a20 436f 6c6c 6563 7469 6f6e 5b4b 6579  : Collection[Key
+0001d6e0: 5d2c 0a20 2020 2020 2020 2063 733a 2043  ],.        cs: C
+0001d6f0: 6c69 656e 7453 7461 7465 2c0a 2020 2020  lientState,.    
+0001d700: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
+0001d710: 6f6e 733a 2052 6563 732c 0a20 2020 2029  ons: Recs,.    )
+0001d720: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001d730: 2020 2222 2252 656d 6f76 6520 6b65 7973    """Remove keys
+0001d740: 2066 726f 6d20 636c 6965 6e74 2064 6573   from client des
+0001d750: 6972 6564 206c 6973 7422 2222 0a20 2020  ired list""".   
+0001d760: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+0001d770: 6728 2243 6c69 656e 7420 2573 2072 656c  g("Client %s rel
+0001d780: 6561 7365 7320 6b65 7973 3a20 2573 222c  eases keys: %s",
+0001d790: 2063 732e 636c 6965 6e74 5f6b 6579 2c20   cs.client_key, 
+0001d7a0: 6b65 7973 290a 2020 2020 2020 2020 666f  keys).        fo
+0001d7b0: 7220 6b65 7920 696e 206b 6579 733a 0a20  r key in keys:. 
+0001d7c0: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+0001d7d0: 7365 6c66 2e74 6173 6b73 2e67 6574 286b  self.tasks.get(k
+0001d7e0: 6579 290a 2020 2020 2020 2020 2020 2020  ey).            
+0001d7f0: 6966 2074 7320 6973 206e 6f74 204e 6f6e  if ts is not Non
+0001d800: 6520 616e 6420 7473 2069 6e20 6373 2e77  e and ts in cs.w
+0001d810: 616e 7473 5f77 6861 743a 0a20 2020 2020  ants_what:.     
+0001d820: 2020 2020 2020 2020 2020 2063 732e 7761             cs.wa
+0001d830: 6e74 735f 7768 6174 2e72 656d 6f76 6528  nts_what.remove(
+0001d840: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+0001d850: 2020 2020 6966 2074 732e 7768 6f5f 7761      if ts.who_wa
+0001d860: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+0001d870: 2020 2020 2020 2020 2074 732e 7768 6f5f           ts.who_
+0001d880: 7761 6e74 732e 7265 6d6f 7665 2863 7329  wants.remove(cs)
+0001d890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d8a0: 2069 6620 6e6f 7420 7473 2e77 686f 5f77   if not ts.who_w
+0001d8b0: 616e 7473 3a0a 2020 2020 2020 2020 2020  ants:.          
+0001d8c0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0001d8d0: 2074 732e 6465 7065 6e64 656e 7473 3a0a   ts.dependents:.
 0001d8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d8f0: 2020 2020 2023 204e 6f20 6c69 7665 2064       # No live d
-0001d900: 6570 656e 6465 6e74 732c 2063 616e 2066  ependents, can f
-0001d910: 6f72 6765 740a 2020 2020 2020 2020 2020  orget.          
-0001d920: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001d930: 636f 6d6d 656e 6461 7469 6f6e 735b 7473  commendations[ts
-0001d940: 2e6b 6579 5d20 3d20 2266 6f72 676f 7474  .key] = "forgott
-0001d950: 656e 220a 2020 2020 2020 2020 2020 2020  en".            
-0001d960: 2020 2020 2020 2020 656c 6966 2074 732e          elif ts.
-0001d970: 7374 6174 6520 213d 2022 6572 7265 6422  state != "erred"
-0001d980: 2061 6e64 206e 6f74 2074 732e 7761 6974   and not ts.wait
-0001d990: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-0001d9a0: 2020 2020 2020 2020 2020 2020 2072 6563               rec
-0001d9b0: 6f6d 6d65 6e64 6174 696f 6e73 5b74 732e  ommendations[ts.
-0001d9c0: 6b65 795d 203d 2022 7265 6c65 6173 6564  key] = "released
-0001d9d0: 220a 0a20 2020 2064 6566 205f 7461 736b  "..    def _task
-0001d9e0: 5f74 6f5f 6d73 6728 7365 6c66 2c20 7473  _to_msg(self, ts
-0001d9f0: 3a20 5461 736b 5374 6174 652c 2064 7572  : TaskState, dur
-0001da00: 6174 696f 6e3a 2066 6c6f 6174 203d 202d  ation: float = -
-0001da10: 3129 202d 3e20 6469 6374 5b73 7472 2c20  1) -> dict[str, 
-0001da20: 416e 795d 3a0a 2020 2020 2020 2020 2222  Any]:.        ""
-0001da30: 2243 6f6e 7665 7274 2061 2073 696e 676c  "Convert a singl
-0001da40: 6520 636f 6d70 7574 6174 696f 6e61 6c20  e computational 
-0001da50: 7461 736b 2074 6f20 6120 6d65 7373 6167  task to a messag
-0001da60: 6522 2222 0a20 2020 2020 2020 2023 2046  e""".        # F
-0001da70: 4958 4d45 3a20 5468 6520 6475 7261 7469  IXME: The durati
-0001da80: 6f6e 2061 7474 7269 6275 7465 2069 7320  on attribute is 
-0001da90: 6e6f 7420 7573 6564 206f 6e20 776f 726b  not used on work
-0001daa0: 6572 2e20 5765 2063 6f75 6c64 2073 6176  er. We could sav
-0001dab0: 6520 6f75 7273 656c 7665 7320 7468 650a  e ourselves the.
-0001dac0: 2020 2020 2020 2020 2320 2020 2020 2020          #       
-0001dad0: 2074 696d 6520 746f 2063 6f6d 7075 7465   time to compute
-0001dae0: 2061 6e64 2073 7562 6d69 7420 7468 6973   and submit this
-0001daf0: 0a20 2020 2020 2020 2069 6620 6475 7261  .        if dura
-0001db00: 7469 6f6e 203c 2030 3a0a 2020 2020 2020  tion < 0:.      
-0001db10: 2020 2020 2020 6475 7261 7469 6f6e 203d        duration =
-0001db20: 2073 656c 662e 6765 745f 7461 736b 5f64   self.get_task_d
-0001db30: 7572 6174 696f 6e28 7473 290a 2020 2020  uration(ts).    
-0001db40: 2020 2020 7473 2e72 756e 5f69 6420 3d20      ts.run_id = 
-0001db50: 6e65 7874 2854 6173 6b53 7461 7465 2e5f  next(TaskState._
-0001db60: 7275 6e5f 6964 5f69 7465 7261 746f 7229  run_id_iterator)
-0001db70: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0001db80: 7473 2e70 7269 6f72 6974 792c 2074 730a  ts.priority, ts.
-0001db90: 2020 2020 2020 2020 6d73 673a 2064 6963          msg: dic
-0001dba0: 745b 7374 722c 2041 6e79 5d20 3d20 7b0a  t[str, Any] = {.
-0001dbb0: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
-0001dbc0: 3a20 2263 6f6d 7075 7465 2d74 6173 6b22  : "compute-task"
-0001dbd0: 2c0a 2020 2020 2020 2020 2020 2020 226b  ,.            "k
-0001dbe0: 6579 223a 2074 732e 6b65 792c 0a20 2020  ey": ts.key,.   
-0001dbf0: 2020 2020 2020 2020 2022 7275 6e5f 6964           "run_id
-0001dc00: 223a 2074 732e 7275 6e5f 6964 2c0a 2020  ": ts.run_id,.  
-0001dc10: 2020 2020 2020 2020 2020 2270 7269 6f72            "prior
-0001dc20: 6974 7922 3a20 7473 2e70 7269 6f72 6974  ity": ts.priorit
-0001dc30: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
-0001dc40: 6475 7261 7469 6f6e 223a 2064 7572 6174  duration": durat
-0001dc50: 696f 6e2c 0a20 2020 2020 2020 2020 2020  ion,.           
-0001dc60: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
-0001dc70: 6622 636f 6d70 7574 652d 7461 736b 2d7b  f"compute-task-{
-0001dc80: 7469 6d65 2829 7d22 2c0a 2020 2020 2020  time()}",.      
-0001dc90: 2020 2020 2020 2277 686f 5f68 6173 223a        "who_has":
-0001dca0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0001dcb0: 2020 2064 7473 2e6b 6579 3a20 5b77 732e     dts.key: [ws.
-0001dcc0: 6164 6472 6573 7320 666f 7220 7773 2069  address for ws i
-0001dcd0: 6e20 6474 732e 7768 6f5f 6861 7320 6f72  n dts.who_has or
-0001dce0: 2028 295d 0a20 2020 2020 2020 2020 2020   ()].           
-0001dcf0: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
-0001dd00: 7473 2e64 6570 656e 6465 6e63 6965 730a  ts.dependencies.
-0001dd10: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
-0001dd20: 2020 2020 2020 2020 2020 2022 6e62 7974             "nbyt
-0001dd30: 6573 223a 207b 6474 732e 6b65 793a 2064  es": {dts.key: d
-0001dd40: 7473 2e6e 6279 7465 7320 666f 7220 6474  ts.nbytes for dt
-0001dd50: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0001dd60: 6369 6573 7d2c 0a20 2020 2020 2020 2020  cies},.         
-0001dd70: 2020 2022 7275 6e5f 7370 6563 223a 2054     "run_spec": T
-0001dd80: 6f50 6963 6b6c 6528 7473 2e72 756e 5f73  oPickle(ts.run_s
-0001dd90: 7065 6329 2c0a 2020 2020 2020 2020 2020  pec),.          
-0001dda0: 2020 2272 6573 6f75 7263 655f 7265 7374    "resource_rest
-0001ddb0: 7269 6374 696f 6e73 223a 2074 732e 7265  rictions": ts.re
-0001ddc0: 736f 7572 6365 5f72 6573 7472 6963 7469  source_restricti
-0001ddd0: 6f6e 732c 0a20 2020 2020 2020 2020 2020  ons,.           
-0001dde0: 2022 6163 746f 7222 3a20 7473 2e61 6374   "actor": ts.act
-0001ddf0: 6f72 2c0a 2020 2020 2020 2020 2020 2020  or,.            
-0001de00: 2261 6e6e 6f74 6174 696f 6e73 223a 2074  "annotations": t
-0001de10: 732e 616e 6e6f 7461 7469 6f6e 7320 6f72  s.annotations or
-0001de20: 207b 7d2c 0a20 2020 2020 2020 2020 2020   {},.           
-0001de30: 2022 7370 616e 5f69 6422 3a20 7473 2e67   "span_id": ts.g
-0001de40: 726f 7570 2e73 7061 6e5f 6964 2c0a 2020  roup.span_id,.  
-0001de50: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
-0001de60: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
-0001de70: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-0001de80: 7365 7274 2061 6c6c 286d 7367 5b22 7768  sert all(msg["wh
-0001de90: 6f5f 6861 7322 5d2e 7661 6c75 6573 2829  o_has"].values()
-0001dea0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-0001deb0: 6e20 6d73 670a 0a0a 636c 6173 7320 5363  n msg...class Sc
-0001dec0: 6865 6475 6c65 7228 5363 6865 6475 6c65  heduler(Schedule
-0001ded0: 7253 7461 7465 2c20 5365 7276 6572 4e6f  rState, ServerNo
-0001dee0: 6465 293a 0a20 2020 2022 2222 4479 6e61  de):.    """Dyna
-0001def0: 6d69 6320 6469 7374 7269 6275 7465 6420  mic distributed 
-0001df00: 7461 736b 2073 6368 6564 756c 6572 0a0a  task scheduler..
-0001df10: 2020 2020 5468 6520 7363 6865 6475 6c65      The schedule
-0001df20: 7220 7472 6163 6b73 2074 6865 2063 7572  r tracks the cur
-0001df30: 7265 6e74 2073 7461 7465 206f 6620 776f  rent state of wo
-0001df40: 726b 6572 732c 2064 6174 612c 2061 6e64  rkers, data, and
-0001df50: 2063 6f6d 7075 7461 7469 6f6e 732e 0a20   computations.. 
-0001df60: 2020 2054 6865 2073 6368 6564 756c 6572     The scheduler
-0001df70: 206c 6973 7465 6e73 2066 6f72 2065 7665   listens for eve
-0001df80: 6e74 7320 616e 6420 7265 7370 6f6e 6473  nts and responds
-0001df90: 2062 7920 636f 6e74 726f 6c6c 696e 6720   by controlling 
-0001dfa0: 776f 726b 6572 730a 2020 2020 6170 7072  workers.    appr
-0001dfb0: 6f70 7269 6174 656c 792e 2020 4974 2063  opriately.  It c
-0001dfc0: 6f6e 7469 6e75 6f75 736c 7920 7472 6965  ontinuously trie
-0001dfd0: 7320 746f 2075 7365 2074 6865 2077 6f72  s to use the wor
-0001dfe0: 6b65 7273 2074 6f20 6578 6563 7574 6520  kers to execute 
-0001dff0: 616e 2065 7665 720a 2020 2020 6772 6f77  an ever.    grow
-0001e000: 696e 6720 6461 736b 2067 7261 7068 2e0a  ing dask graph..
-0001e010: 0a20 2020 2041 6c6c 2065 7665 6e74 7320  .    All events 
-0001e020: 6172 6520 6861 6e64 6c65 6420 7175 6963  are handled quic
-0001e030: 6b6c 792c 2069 6e20 6c69 6e65 6172 2074  kly, in linear t
-0001e040: 696d 6520 7769 7468 2072 6573 7065 6374  ime with respect
-0001e050: 2074 6f20 7468 6569 7220 696e 7075 740a   to their input.
-0001e060: 2020 2020 2877 6869 6368 2069 7320 6f66      (which is of
-0001e070: 7465 6e20 6f66 2063 6f6e 7374 616e 7420  ten of constant 
-0001e080: 7369 7a65 2920 616e 6420 6765 6e65 7261  size) and genera
-0001e090: 6c6c 7920 7769 7468 696e 2061 206d 696c  lly within a mil
-0001e0a0: 6c69 7365 636f 6e64 2e20 2054 6f0a 2020  lisecond.  To.  
-0001e0b0: 2020 6163 636f 6d70 6c69 7368 2074 6869    accomplish thi
-0001e0c0: 7320 7468 6520 7363 6865 6475 6c65 7220  s the scheduler 
-0001e0d0: 7472 6163 6b73 2061 206c 6f74 206f 6620  tracks a lot of 
-0001e0e0: 7374 6174 652e 2020 4576 6572 7920 6f70  state.  Every op
-0001e0f0: 6572 6174 696f 6e0a 2020 2020 6d61 696e  eration.    main
-0001e100: 7461 696e 7320 7468 6520 636f 6e73 6973  tains the consis
-0001e110: 7465 6e63 7920 6f66 2074 6869 7320 7374  tency of this st
-0001e120: 6174 652e 0a0a 2020 2020 5468 6520 7363  ate...    The sc
-0001e130: 6865 6475 6c65 7220 636f 6d6d 756e 6963  heduler communic
-0001e140: 6174 6573 2077 6974 6820 7468 6520 6f75  ates with the ou
-0001e150: 7473 6964 6520 776f 726c 6420 7468 726f  tside world thro
-0001e160: 7567 6820 436f 6d6d 206f 626a 6563 7473  ugh Comm objects
-0001e170: 2e0a 2020 2020 4974 206d 6169 6e74 6169  ..    It maintai
-0001e180: 6e73 2061 2063 6f6e 7369 7374 656e 7420  ns a consistent 
-0001e190: 616e 6420 7661 6c69 6420 7669 6577 206f  and valid view o
-0001e1a0: 6620 7468 6520 776f 726c 6420 6576 656e  f the world even
-0001e1b0: 2077 6865 6e20 6c69 7374 656e 696e 670a   when listening.
-0001e1c0: 2020 2020 746f 2073 6576 6572 616c 2063      to several c
-0001e1d0: 6c69 656e 7473 2061 7420 6f6e 6365 2e0a  lients at once..
-0001e1e0: 0a20 2020 2041 2053 6368 6564 756c 6572  .    A Scheduler
-0001e1f0: 2069 7320 7479 7069 6361 6c6c 7920 7374   is typically st
-0001e200: 6172 7465 6420 6569 7468 6572 2077 6974  arted either wit
-0001e210: 6820 7468 6520 6060 6461 736b 2073 6368  h the ``dask sch
-0001e220: 6564 756c 6572 6060 0a20 2020 2065 7865  eduler``.    exe
-0001e230: 6375 7461 626c 653a 3a0a 0a20 2020 2020  cutable::..     
-0001e240: 2020 2020 2420 6461 736b 2073 6368 6564      $ dask sched
-0001e250: 756c 6572 0a20 2020 2020 2020 2020 5363  uler.         Sc
-0001e260: 6865 6475 6c65 7220 7374 6172 7465 6420  heduler started 
-0001e270: 6174 2031 3237 2e30 2e30 2e31 3a38 3738  at 127.0.0.1:878
-0001e280: 360a 0a20 2020 204f 7220 7769 7468 696e  6..    Or within
-0001e290: 2061 204c 6f63 616c 436c 7573 7465 7220   a LocalCluster 
-0001e2a0: 6120 436c 6965 6e74 2073 7461 7274 7320  a Client starts 
-0001e2b0: 7570 2077 6974 686f 7574 2063 6f6e 6e65  up without conne
-0001e2c0: 6374 696f 6e0a 2020 2020 696e 666f 726d  ction.    inform
-0001e2d0: 6174 696f 6e3a 3a0a 0a20 2020 2020 2020  ation::..       
-0001e2e0: 203e 3e3e 2063 203d 2043 6c69 656e 7428   >>> c = Client(
-0001e2f0: 2920 2023 2064 6f63 7465 7374 3a20 2b53  )  # doctest: +S
-0001e300: 4b49 500a 2020 2020 2020 2020 3e3e 3e20  KIP.        >>> 
-0001e310: 632e 636c 7573 7465 722e 7363 6865 6475  c.cluster.schedu
-0001e320: 6c65 7220 2023 2064 6f63 7465 7374 3a20  ler  # doctest: 
-0001e330: 2b53 4b49 500a 2020 2020 2020 2020 5363  +SKIP.        Sc
-0001e340: 6865 6475 6c65 7228 2e2e 2e29 0a0a 2020  heduler(...)..  
-0001e350: 2020 5573 6572 7320 7479 7069 6361 6c6c    Users typicall
-0001e360: 7920 646f 206e 6f74 2069 6e74 6572 6163  y do not interac
-0001e370: 7420 7769 7468 2074 6865 2073 6368 6564  t with the sched
-0001e380: 756c 6572 2064 6972 6563 746c 7920 6275  uler directly bu
-0001e390: 7420 7261 7468 6572 2077 6974 680a 2020  t rather with.  
-0001e3a0: 2020 7468 6520 636c 6965 6e74 206f 626a    the client obj
-0001e3b0: 6563 7420 6060 436c 6965 6e74 6060 2e0a  ect ``Client``..
-0001e3c0: 0a20 2020 2054 6865 2060 6063 6f6e 7461  .    The ``conta
-0001e3d0: 6374 5f61 6464 7265 7373 6060 2070 6172  ct_address`` par
-0001e3e0: 616d 6574 6572 2061 6c6c 6f77 7320 746f  ameter allows to
-0001e3f0: 2061 6476 6572 7469 7365 2061 2073 7065   advertise a spe
-0001e400: 6369 6669 6320 6164 6472 6573 7320 746f  cific address to
-0001e410: 0a20 2020 2074 6865 2077 6f72 6b65 7273  .    the workers
-0001e420: 2066 6f72 2063 6f6d 6d75 6e69 6361 7469   for communicati
-0001e430: 6f6e 2077 6974 6820 7468 6520 7363 6865  on with the sche
-0001e440: 6475 6c65 722c 2077 6869 6368 2069 7320  duler, which is 
-0001e450: 6469 6666 6572 656e 7420 7468 616e 0a20  different than. 
-0001e460: 2020 2074 6865 2061 6464 7265 7373 2074     the address t
-0001e470: 6865 2073 6368 6564 756c 6572 2062 696e  he scheduler bin
-0001e480: 6473 2074 6f2e 2054 6869 7320 6973 2075  ds to. This is u
-0001e490: 7365 6675 6c20 7768 656e 2074 6865 2073  seful when the s
-0001e4a0: 6368 6564 756c 6572 0a20 2020 206c 6973  cheduler.    lis
-0001e4b0: 7465 6e73 206f 6e20 6120 7072 6976 6174  tens on a privat
-0001e4c0: 6520 6164 6472 6573 732c 2077 6869 6368  e address, which
-0001e4d0: 2074 6865 7265 666f 7265 2063 616e 6e6f   therefore canno
-0001e4e0: 7420 6265 2075 7365 6420 6279 2074 6865  t be used by the
-0001e4f0: 2077 6f72 6b65 7273 0a20 2020 2074 6f20   workers.    to 
-0001e500: 636f 6e74 6163 7420 6974 2e0a 0a20 2020  contact it...   
-0001e510: 202a 2a53 7461 7465 2a2a 0a0a 2020 2020   **State**..    
-0001e520: 5468 6520 7363 6865 6475 6c65 7220 636f  The scheduler co
-0001e530: 6e74 6169 6e73 2074 6865 2066 6f6c 6c6f  ntains the follo
-0001e540: 7769 6e67 2073 7461 7465 2076 6172 6961  wing state varia
-0001e550: 626c 6573 2e20 2045 6163 6820 7661 7269  bles.  Each vari
-0001e560: 6162 6c65 2069 730a 2020 2020 6c69 7374  able is.    list
-0001e570: 6564 2061 6c6f 6e67 2077 6974 6820 7768  ed along with wh
-0001e580: 6174 2069 7420 7374 6f72 6573 2061 6e64  at it stores and
-0001e590: 2061 2062 7269 6566 2064 6573 6372 6970   a brief descrip
-0001e5a0: 7469 6f6e 2e0a 0a20 2020 202a 202a 2a74  tion...    * **t
-0001e5b0: 6173 6b73 3a2a 2a20 6060 7b74 6173 6b20  asks:** ``{task 
-0001e5c0: 6b65 793a 2054 6173 6b53 7461 7465 7d60  key: TaskState}`
-0001e5d0: 600a 2020 2020 2020 2020 5461 736b 7320  `.        Tasks 
-0001e5e0: 6375 7272 656e 746c 7920 6b6e 6f77 6e20  currently known 
-0001e5f0: 746f 2074 6865 2073 6368 6564 756c 6572  to the scheduler
-0001e600: 0a20 2020 202a 202a 2a75 6e72 756e 6e61  .    * **unrunna
-0001e610: 626c 653a 2a2a 2060 607b 5461 736b 5374  ble:** ``{TaskSt
-0001e620: 6174 657d 6060 0a20 2020 2020 2020 2054  ate}``.        T
-0001e630: 6173 6b73 2069 6e20 7468 6520 226e 6f2d  asks in the "no-
-0001e640: 776f 726b 6572 2220 7374 6174 650a 0a20  worker" state.. 
-0001e650: 2020 202a 202a 2a77 6f72 6b65 7273 3a2a     * **workers:*
-0001e660: 2a20 6060 7b77 6f72 6b65 7220 6b65 793a  * ``{worker key:
-0001e670: 2057 6f72 6b65 7253 7461 7465 7d60 600a   WorkerState}``.
-0001e680: 2020 2020 2020 2020 576f 726b 6572 7320          Workers 
-0001e690: 6375 7272 656e 746c 7920 636f 6e6e 6563  currently connec
-0001e6a0: 7465 6420 746f 2074 6865 2073 6368 6564  ted to the sched
-0001e6b0: 756c 6572 0a20 2020 202a 202a 2a69 646c  uler.    * **idl
-0001e6c0: 653a 2a2a 2060 607b 576f 726b 6572 5374  e:** ``{WorkerSt
-0001e6d0: 6174 657d 6060 3a0a 2020 2020 2020 2020  ate}``:.        
-0001e6e0: 5365 7420 6f66 2077 6f72 6b65 7273 2074  Set of workers t
-0001e6f0: 6861 7420 6172 6520 6e6f 7420 6675 6c6c  hat are not full
-0001e700: 7920 7574 696c 697a 6564 0a20 2020 202a  y utilized.    *
-0001e710: 202a 2a73 6174 7572 6174 6564 3a2a 2a20   **saturated:** 
-0001e720: 6060 7b57 6f72 6b65 7253 7461 7465 7d60  ``{WorkerState}`
-0001e730: 603a 0a20 2020 2020 2020 2053 6574 206f  `:.        Set o
-0001e740: 6620 776f 726b 6572 7320 7468 6174 2061  f workers that a
-0001e750: 7265 206e 6f74 206f 7665 722d 7574 696c  re not over-util
-0001e760: 697a 6564 0a0a 2020 2020 2a20 2a2a 686f  ized..    * **ho
-0001e770: 7374 5f69 6e66 6f3a 2a2a 2060 607b 686f  st_info:** ``{ho
-0001e780: 7374 6e61 6d65 3a20 6469 6374 7d60 603a  stname: dict}``:
-0001e790: 0a20 2020 2020 2020 2049 6e66 6f72 6d61  .        Informa
-0001e7a0: 7469 6f6e 2061 626f 7574 2065 6163 6820  tion about each 
-0001e7b0: 776f 726b 6572 2068 6f73 740a 0a20 2020  worker host..   
-0001e7c0: 202a 202a 2a63 6c69 656e 7473 3a2a 2a20   * **clients:** 
-0001e7d0: 6060 7b63 6c69 656e 7420 6b65 793a 2043  ``{client key: C
-0001e7e0: 6c69 656e 7453 7461 7465 7d60 600a 2020  lientState}``.  
-0001e7f0: 2020 2020 2020 436c 6965 6e74 7320 6375        Clients cu
-0001e800: 7272 656e 746c 7920 636f 6e6e 6563 7465  rrently connecte
-0001e810: 6420 746f 2074 6865 2073 6368 6564 756c  d to the schedul
-0001e820: 6572 0a0a 2020 2020 2a20 2a2a 7365 7276  er..    * **serv
-0001e830: 6963 6573 3a2a 2a20 6060 7b73 7472 3a20  ices:** ``{str: 
-0001e840: 706f 7274 7d60 603a 0a20 2020 2020 2020  port}``:.       
-0001e850: 204f 7468 6572 2073 6572 7669 6365 7320   Other services 
-0001e860: 7275 6e6e 696e 6720 6f6e 2074 6869 7320  running on this 
-0001e870: 7363 6865 6475 6c65 722c 206c 696b 6520  scheduler, like 
-0001e880: 426f 6b65 680a 2020 2020 2a20 2a2a 6c6f  Bokeh.    * **lo
-0001e890: 6f70 3a2a 2a20 6060 494f 4c6f 6f70 6060  op:** ``IOLoop``
-0001e8a0: 3a0a 2020 2020 2020 2020 5468 6520 7275  :.        The ru
-0001e8b0: 6e6e 696e 6720 546f 726e 6164 6f20 494f  nning Tornado IO
-0001e8c0: 4c6f 6f70 0a20 2020 202a 202a 2a63 6c69  Loop.    * **cli
-0001e8d0: 656e 745f 636f 6d6d 733a 2a2a 2060 607b  ent_comms:** ``{
-0001e8e0: 636c 6965 6e74 206b 6579 3a20 436f 6d6d  client key: Comm
-0001e8f0: 7d60 600a 2020 2020 2020 2020 466f 7220  }``.        For 
-0001e900: 6561 6368 2063 6c69 656e 742c 2061 2043  each client, a C
-0001e910: 6f6d 6d20 6f62 6a65 6374 2075 7365 6420  omm object used 
-0001e920: 746f 2072 6563 6569 7665 2074 6173 6b20  to receive task 
-0001e930: 7265 7175 6573 7473 2061 6e64 0a20 2020  requests and.   
-0001e940: 2020 2020 2072 6570 6f72 7420 7461 736b       report task
-0001e950: 2073 7461 7475 7320 7570 6461 7465 732e   status updates.
-0001e960: 0a20 2020 202a 202a 2a73 7472 6561 6d5f  .    * **stream_
-0001e970: 636f 6d6d 733a 2a2a 2060 607b 776f 726b  comms:** ``{work
-0001e980: 6572 206b 6579 3a20 436f 6d6d 7d60 600a  er key: Comm}``.
-0001e990: 2020 2020 2020 2020 466f 7220 6561 6368          For each
-0001e9a0: 2077 6f72 6b65 722c 2061 2043 6f6d 6d20   worker, a Comm 
-0001e9b0: 6f62 6a65 6374 2066 726f 6d20 7768 6963  object from whic
-0001e9c0: 6820 7765 2062 6f74 6820 6163 6365 7074  h we both accept
-0001e9d0: 2073 7469 6d75 6c69 2061 6e64 0a20 2020   stimuli and.   
-0001e9e0: 2020 2020 2072 6570 6f72 7420 7265 7375       report resu
-0001e9f0: 6c74 730a 2020 2020 2a20 2a2a 7461 736b  lts.    * **task
-0001ea00: 5f64 7572 6174 696f 6e3a 2a2a 2060 607b  _duration:** ``{
-0001ea10: 6b65 792d 7072 6566 6978 3a20 7469 6d65  key-prefix: time
-0001ea20: 7d60 600a 2020 2020 2020 2020 5469 6d65  }``.        Time
-0001ea30: 2077 6520 6578 7065 6374 2063 6572 7461   we expect certa
-0001ea40: 696e 2066 756e 6374 696f 6e73 2074 6f20  in functions to 
-0001ea50: 7461 6b65 2c20 652e 672e 2060 607b 2773  take, e.g. ``{'s
-0001ea60: 756d 273a 2030 2e32 357d 6060 0a20 2020  um': 0.25}``.   
-0001ea70: 2022 2222 0a0a 2020 2020 6465 6661 756c   """..    defaul
-0001ea80: 745f 706f 7274 203d 2038 3738 360a 2020  t_port = 8786.  
-0001ea90: 2020 5f69 6e73 7461 6e63 6573 3a20 436c    _instances: Cl
-0001eaa0: 6173 7356 6172 5b77 6561 6b72 6566 2e57  assVar[weakref.W
-0001eab0: 6561 6b53 6574 5b53 6368 6564 756c 6572  eakSet[Scheduler
-0001eac0: 5d5d 203d 2077 6561 6b72 6566 2e57 6561  ]] = weakref.Wea
-0001ead0: 6b53 6574 2829 0a0a 2020 2020 776f 726b  kSet()..    work
-0001eae0: 6572 5f74 746c 3a20 666c 6f61 7420 7c20  er_ttl: float | 
-0001eaf0: 4e6f 6e65 0a20 2020 2069 646c 655f 7369  None.    idle_si
-0001eb00: 6e63 653a 2066 6c6f 6174 207c 204e 6f6e  nce: float | Non
-0001eb10: 650a 2020 2020 6964 6c65 5f74 696d 656f  e.    idle_timeo
-0001eb20: 7574 3a20 666c 6f61 7420 7c20 4e6f 6e65  ut: float | None
-0001eb30: 0a20 2020 205f 6e6f 5f77 6f72 6b65 7273  .    _no_workers
-0001eb40: 5f73 696e 6365 3a20 666c 6f61 7420 7c20  _since: float | 
-0001eb50: 4e6f 6e65 2020 2320 4e6f 7465 3a20 6e6f  None  # Note: no
-0001eb60: 7420 4e6f 6e65 2069 6666 2074 6865 7265  t None iff there
-0001eb70: 2061 7265 2070 656e 6469 6e67 2074 6173   are pending tas
-0001eb80: 6b73 0a20 2020 206e 6f5f 776f 726b 6572  ks.    no_worker
-0001eb90: 735f 7469 6d65 6f75 743a 2066 6c6f 6174  s_timeout: float
-0001eba0: 207c 204e 6f6e 650a 0a20 2020 2064 6566   | None..    def
-0001ebb0: 205f 5f69 6e69 745f 5f28 0a20 2020 2020   __init__(.     
-0001ebc0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0001ebd0: 206c 6f6f 703d 4e6f 6e65 2c0a 2020 2020   loop=None,.    
-0001ebe0: 2020 2020 6465 6c65 7465 5f69 6e74 6572      delete_inter
-0001ebf0: 7661 6c3d 2235 3030 6d73 222c 0a20 2020  val="500ms",.   
-0001ec00: 2020 2020 2073 796e 6368 726f 6e69 7a65       synchronize
-0001ec10: 5f77 6f72 6b65 725f 696e 7465 7276 616c  _worker_interval
-0001ec20: 3d22 3630 7322 2c0a 2020 2020 2020 2020  ="60s",.        
-0001ec30: 7365 7276 6963 6573 3d4e 6f6e 652c 0a20  services=None,. 
-0001ec40: 2020 2020 2020 2073 6572 7669 6365 5f6b         service_k
-0001ec50: 7761 7267 733d 4e6f 6e65 2c0a 2020 2020  wargs=None,.    
-0001ec60: 2020 2020 616c 6c6f 7765 645f 6661 696c      allowed_fail
-0001ec70: 7572 6573 3d4e 6f6e 652c 0a20 2020 2020  ures=None,.     
-0001ec80: 2020 2065 7874 656e 7369 6f6e 733d 4e6f     extensions=No
-0001ec90: 6e65 2c0a 2020 2020 2020 2020 7661 6c69  ne,.        vali
-0001eca0: 6461 7465 3d4e 6f6e 652c 0a20 2020 2020  date=None,.     
-0001ecb0: 2020 2073 6368 6564 756c 6572 5f66 696c     scheduler_fil
-0001ecc0: 653d 4e6f 6e65 2c0a 2020 2020 2020 2020  e=None,.        
-0001ecd0: 7365 6375 7269 7479 3d4e 6f6e 652c 0a20  security=None,. 
-0001ece0: 2020 2020 2020 2077 6f72 6b65 725f 7474         worker_tt
-0001ecf0: 6c3d 4e6f 6e65 2c0a 2020 2020 2020 2020  l=None,.        
-0001ed00: 6964 6c65 5f74 696d 656f 7574 3d4e 6f6e  idle_timeout=Non
-0001ed10: 652c 0a20 2020 2020 2020 2069 6e74 6572  e,.        inter
-0001ed20: 6661 6365 3d4e 6f6e 652c 0a20 2020 2020  face=None,.     
-0001ed30: 2020 2068 6f73 743d 4e6f 6e65 2c0a 2020     host=None,.  
-0001ed40: 2020 2020 2020 706f 7274 3d30 2c0a 2020        port=0,.  
-0001ed50: 2020 2020 2020 7072 6f74 6f63 6f6c 3d4e        protocol=N
-0001ed60: 6f6e 652c 0a20 2020 2020 2020 2064 6173  one,.        das
-0001ed70: 6862 6f61 7264 5f61 6464 7265 7373 3d4e  hboard_address=N
-0001ed80: 6f6e 652c 0a20 2020 2020 2020 2064 6173  one,.        das
-0001ed90: 6862 6f61 7264 3d4e 6f6e 652c 0a20 2020  hboard=None,.   
-0001eda0: 2020 2020 2068 7474 705f 7072 6566 6978       http_prefix
-0001edb0: 3d22 2f22 2c0a 2020 2020 2020 2020 7072  ="/",.        pr
-0001edc0: 656c 6f61 643d 4e6f 6e65 2c0a 2020 2020  eload=None,.    
-0001edd0: 2020 2020 7072 656c 6f61 645f 6172 6776      preload_argv
-0001ede0: 3d28 292c 0a20 2020 2020 2020 2070 6c75  =(),.        plu
-0001edf0: 6769 6e73 3d28 292c 0a20 2020 2020 2020  gins=(),.       
-0001ee00: 2063 6f6e 7461 6374 5f61 6464 7265 7373   contact_address
-0001ee10: 3d4e 6f6e 652c 0a20 2020 2020 2020 2074  =None,.        t
-0001ee20: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
-0001ee30: 725f 6d61 783d 4661 6c73 652c 0a20 2020  r_max=False,.   
-0001ee40: 2020 2020 206a 7570 7974 6572 3d46 616c       jupyter=Fal
-0001ee50: 7365 2c0a 2020 2020 2020 2020 2a2a 6b77  se,.        **kw
-0001ee60: 6172 6773 2c0a 2020 2020 293a 0a20 2020  args,.    ):.   
-0001ee70: 2020 2020 2069 6620 6461 736b 2e63 6f6e       if dask.con
-0001ee80: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
-0001ee90: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
-0001eea0: 6963 6b6c 6522 2c20 6465 6661 756c 743d  ickle", default=
-0001eeb0: 5472 7565 2920 6973 2046 616c 7365 3a0a  True) is False:.
-0001eec0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001eed0: 6520 5275 6e74 696d 6545 7272 6f72 280a  e RuntimeError(.
-0001eee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eef0: 2250 6963 6b6c 696e 6720 6361 6e20 6e6f  "Pickling can no
-0001ef00: 206c 6f6e 6765 7220 6265 2064 6973 6162   longer be disab
-0001ef10: 6c65 6420 7769 7468 2074 6865 2060 6469  led with the `di
-0001ef20: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0001ef30: 6c65 722e 7069 636b 6c65 6020 6f70 7469  ler.pickle` opti
-0001ef40: 6f6e 2e20 506c 6561 7365 2072 656d 6f76  on. Please remov
-0001ef50: 6520 7468 6973 2063 6f6e 6669 6775 7261  e this configura
-0001ef60: 7469 6f6e 2074 6f20 7374 6172 7420 7468  tion to start th
-0001ef70: 6520 7363 6865 6475 6c65 722e 220a 2020  e scheduler.".  
-0001ef80: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001ef90: 2020 2020 6966 206c 6f6f 7020 6973 206e      if loop is n
-0001efa0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0001efb0: 2020 2020 2077 6172 6e69 6e67 732e 7761       warnings.wa
-0001efc0: 726e 280a 2020 2020 2020 2020 2020 2020  rn(.            
-0001efd0: 2020 2020 2274 6865 206c 6f6f 7020 6b77      "the loop kw
-0001efe0: 6172 6720 746f 2053 6368 6564 756c 6572  arg to Scheduler
-0001eff0: 2069 7320 6465 7072 6563 6174 6564 222c   is deprecated",
-0001f000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f010: 2044 6570 7265 6361 7469 6f6e 5761 726e   DeprecationWarn
-0001f020: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
-0001f030: 2020 2020 2073 7461 636b 6c65 7665 6c3d       stacklevel=
-0001f040: 322c 0a20 2020 2020 2020 2020 2020 2029  2,.            )
-0001f050: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
-0001f060: 6f6f 7020 3d20 7365 6c66 2e69 6f5f 6c6f  oop = self.io_lo
-0001f070: 6f70 203d 2049 4f4c 6f6f 702e 6375 7272  op = IOLoop.curr
-0001f080: 656e 7428 290a 2020 2020 2020 2020 7365  ent().        se
-0001f090: 6c66 2e5f 7365 7475 705f 6c6f 6767 696e  lf._setup_loggin
-0001f0a0: 6728 6c6f 6767 6572 290a 0a20 2020 2020  g(logger)..     
-0001f0b0: 2020 2023 2041 7474 7269 6275 7465 730a     # Attributes.
-0001f0c0: 2020 2020 2020 2020 6966 2063 6f6e 7461          if conta
-0001f0d0: 6374 5f61 6464 7265 7373 2069 7320 4e6f  ct_address is No
-0001f0e0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0001f0f0: 636f 6e74 6163 745f 6164 6472 6573 7320  contact_address 
-0001f100: 3d20 6461 736b 2e63 6f6e 6669 672e 6765  = dask.config.ge
-0001f110: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-0001f120: 6368 6564 756c 6572 2e63 6f6e 7461 6374  cheduler.contact
-0001f130: 2d61 6464 7265 7373 2229 0a20 2020 2020  -address").     
-0001f140: 2020 2073 656c 662e 636f 6e74 6163 745f     self.contact_
-0001f150: 6164 6472 6573 7320 3d20 636f 6e74 6163  address = contac
-0001f160: 745f 6164 6472 6573 730a 2020 2020 2020  t_address.      
-0001f170: 2020 6966 2061 6c6c 6f77 6564 5f66 6169    if allowed_fai
-0001f180: 6c75 7265 7320 6973 204e 6f6e 653a 0a20  lures is None:. 
-0001f190: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
-0001f1a0: 6564 5f66 6169 6c75 7265 7320 3d20 6461  ed_failures = da
-0001f1b0: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
-0001f1c0: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
-0001f1d0: 756c 6572 2e61 6c6c 6f77 6564 2d66 6169  uler.allowed-fai
-0001f1e0: 6c75 7265 7322 290a 2020 2020 2020 2020  lures").        
-0001f1f0: 7365 6c66 2e61 6c6c 6f77 6564 5f66 6169  self.allowed_fai
-0001f200: 6c75 7265 7320 3d20 616c 6c6f 7765 645f  lures = allowed_
-0001f210: 6661 696c 7572 6573 0a20 2020 2020 2020  failures.       
-0001f220: 2069 6620 7661 6c69 6461 7465 2069 7320   if validate is 
-0001f230: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0001f240: 2020 7661 6c69 6461 7465 203d 2064 6173    validate = das
-0001f250: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
-0001f260: 7374 7269 6275 7465 642e 7363 6865 6475  stributed.schedu
-0001f270: 6c65 722e 7661 6c69 6461 7465 2229 0a20  ler.validate"). 
-0001f280: 2020 2020 2020 2073 656c 662e 7072 6f63         self.proc
-0001f290: 203d 2070 7375 7469 6c2e 5072 6f63 6573   = psutil.Proces
-0001f2a0: 7328 290a 2020 2020 2020 2020 7365 6c66  s().        self
-0001f2b0: 2e64 656c 6574 655f 696e 7465 7276 616c  .delete_interval
-0001f2c0: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
-0001f2d0: 7461 2864 656c 6574 655f 696e 7465 7276  ta(delete_interv
-0001f2e0: 616c 2c20 6465 6661 756c 743d 226d 7322  al, default="ms"
-0001f2f0: 290a 2020 2020 2020 2020 7365 6c66 2e73  ).        self.s
-0001f300: 796e 6368 726f 6e69 7a65 5f77 6f72 6b65  ynchronize_worke
-0001f310: 725f 696e 7465 7276 616c 203d 2070 6172  r_interval = par
-0001f320: 7365 5f74 696d 6564 656c 7461 280a 2020  se_timedelta(.  
-0001f330: 2020 2020 2020 2020 2020 7379 6e63 6872            synchr
-0001f340: 6f6e 697a 655f 776f 726b 6572 5f69 6e74  onize_worker_int
-0001f350: 6572 7661 6c2c 2064 6566 6175 6c74 3d22  erval, default="
-0001f360: 6d73 220a 2020 2020 2020 2020 290a 2020  ms".        ).  
-0001f370: 2020 2020 2020 7365 6c66 2e73 6572 7669        self.servi
-0001f380: 6365 5f73 7065 6373 203d 2073 6572 7669  ce_specs = servi
-0001f390: 6365 7320 6f72 207b 7d0a 2020 2020 2020  ces or {}.      
-0001f3a0: 2020 7365 6c66 2e73 6572 7669 6365 5f6b    self.service_k
-0001f3b0: 7761 7267 7320 3d20 7365 7276 6963 655f  wargs = service_
-0001f3c0: 6b77 6172 6773 206f 7220 7b7d 0a20 2020  kwargs or {}.   
-0001f3d0: 2020 2020 2073 656c 662e 7365 7276 6963       self.servic
-0001f3e0: 6573 203d 207b 7d0a 2020 2020 2020 2020  es = {}.        
-0001f3f0: 7365 6c66 2e73 6368 6564 756c 6572 5f66  self.scheduler_f
-0001f400: 696c 6520 3d20 7363 6865 6475 6c65 725f  ile = scheduler_
-0001f410: 6669 6c65 0a0a 2020 2020 2020 2020 7365  file..        se
-0001f420: 6c66 2e77 6f72 6b65 725f 7474 6c20 3d20  lf.worker_ttl = 
-0001f430: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
-0001f440: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-0001f450: 6b65 725f 7474 6c20 6f72 2064 6173 6b2e  ker_ttl or dask.
-0001f460: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
-0001f470: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
-0001f480: 722e 776f 726b 6572 2d74 746c 2229 0a20  r.worker-ttl"). 
-0001f490: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001f4a0: 2073 656c 662e 6964 6c65 5f74 696d 656f   self.idle_timeo
-0001f4b0: 7574 203d 2070 6172 7365 5f74 696d 6564  ut = parse_timed
-0001f4c0: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
-0001f4d0: 2020 6964 6c65 5f74 696d 656f 7574 206f    idle_timeout o
-0001f4e0: 7220 6461 736b 2e63 6f6e 6669 672e 6765  r dask.config.ge
-0001f4f0: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-0001f500: 6368 6564 756c 6572 2e69 646c 652d 7469  cheduler.idle-ti
-0001f510: 6d65 6f75 7422 290a 2020 2020 2020 2020  meout").        
-0001f520: 290a 2020 2020 2020 2020 7365 6c66 2e69  ).        self.i
-0001f530: 646c 655f 7369 6e63 6520 3d20 7469 6d65  dle_since = time
-0001f540: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0001f550: 6e6f 5f77 6f72 6b65 7273 5f74 696d 656f  no_workers_timeo
-0001f560: 7574 203d 2070 6172 7365 5f74 696d 6564  ut = parse_timed
-0001f570: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
-0001f580: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
-0001f590: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-0001f5a0: 6368 6564 756c 6572 2e6e 6f2d 776f 726b  cheduler.no-work
-0001f5b0: 6572 732d 7469 6d65 6f75 7422 290a 2020  ers-timeout").  
-0001f5c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0001f5d0: 7365 6c66 2e5f 6e6f 5f77 6f72 6b65 7273  self._no_workers
-0001f5e0: 5f73 696e 6365 203d 204e 6f6e 650a 0a20  _since = None.. 
-0001f5f0: 2020 2020 2020 2073 656c 662e 7469 6d65         self.time
-0001f600: 5f73 7461 7274 6564 203d 2073 656c 662e  _started = self.
-0001f610: 6964 6c65 5f73 696e 6365 2020 2320 636f  idle_since  # co
-0001f620: 6d70 6174 6962 696c 6974 7920 666f 7220  mpatibility for 
-0001f630: 6461 736b 2d67 6174 6577 6179 0a20 2020  dask-gateway.   
-0001f640: 2020 2020 2073 656c 662e 5f72 6570 6c69       self._repli
-0001f650: 6361 5f6c 6f63 6b20 3d20 524c 6f63 6b28  ca_lock = RLock(
-0001f660: 290a 2020 2020 2020 2020 7365 6c66 2e62  ).        self.b
-0001f670: 616e 6477 6964 7468 5f77 6f72 6b65 7273  andwidth_workers
-0001f680: 203d 2064 6566 6175 6c74 6469 6374 2866   = defaultdict(f
-0001f690: 6c6f 6174 290a 2020 2020 2020 2020 7365  loat).        se
-0001f6a0: 6c66 2e62 616e 6477 6964 7468 5f74 7970  lf.bandwidth_typ
-0001f6b0: 6573 203d 2064 6566 6175 6c74 6469 6374  es = defaultdict
-0001f6c0: 2866 6c6f 6174 290a 0a20 2020 2020 2020  (float)..       
-0001f6d0: 2023 2044 6f6e 2774 2063 6173 7420 696e   # Don't cast in
-0001f6e0: 7420 6d65 7472 6963 7320 746f 2066 6c6f  t metrics to flo
-0001f6f0: 6174 0a20 2020 2020 2020 2073 656c 662e  at.        self.
-0001f700: 6375 6d75 6c61 7469 7665 5f77 6f72 6b65  cumulative_worke
-0001f710: 725f 6d65 7472 6963 7320 3d20 6465 6661  r_metrics = defa
-0001f720: 756c 7464 6963 7428 696e 7429 0a0a 2020  ultdict(int)..  
-0001f730: 2020 2020 2020 6966 206e 6f74 2070 7265        if not pre
-0001f740: 6c6f 6164 3a0a 2020 2020 2020 2020 2020  load:.          
-0001f750: 2020 7072 656c 6f61 6420 3d20 6461 736b    preload = dask
-0001f760: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-0001f770: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-0001f780: 6572 2e70 7265 6c6f 6164 2229 0a20 2020  er.preload").   
-0001f790: 2020 2020 2069 6620 6e6f 7420 7072 656c       if not prel
-0001f7a0: 6f61 645f 6172 6776 3a0a 2020 2020 2020  oad_argv:.      
-0001f7b0: 2020 2020 2020 7072 656c 6f61 645f 6172        preload_ar
-0001f7c0: 6776 203d 2064 6173 6b2e 636f 6e66 6967  gv = dask.config
-0001f7d0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
-0001f7e0: 642e 7363 6865 6475 6c65 722e 7072 656c  d.scheduler.prel
-0001f7f0: 6f61 642d 6172 6776 2229 0a20 2020 2020  oad-argv").     
-0001f800: 2020 2073 656c 662e 7072 656c 6f61 6473     self.preloads
-0001f810: 203d 2070 7265 6c6f 6164 696e 672e 7072   = preloading.pr
-0001f820: 6f63 6573 735f 7072 656c 6f61 6473 2873  ocess_preloads(s
-0001f830: 656c 662c 2070 7265 6c6f 6164 2c20 7072  elf, preload, pr
-0001f840: 656c 6f61 645f 6172 6776 290a 0a20 2020  eload_argv)..   
-0001f850: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
-0001f860: 6365 2873 6563 7572 6974 792c 2064 6963  ce(security, dic
-0001f870: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-0001f880: 7365 6375 7269 7479 203d 2053 6563 7572  security = Secur
-0001f890: 6974 7928 2a2a 7365 6375 7269 7479 290a  ity(**security).
-0001f8a0: 2020 2020 2020 2020 7365 6c66 2e73 6563          self.sec
-0001f8b0: 7572 6974 7920 3d20 7365 6375 7269 7479  urity = security
-0001f8c0: 206f 7220 5365 6375 7269 7479 2829 0a20   or Security(). 
-0001f8d0: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0001f8e0: 696e 7374 616e 6365 2873 656c 662e 7365  instance(self.se
-0001f8f0: 6375 7269 7479 2c20 5365 6375 7269 7479  curity, Security
-0001f900: 290a 2020 2020 2020 2020 7365 6c66 2e63  ).        self.c
-0001f910: 6f6e 6e65 6374 696f 6e5f 6172 6773 203d  onnection_args =
-0001f920: 2073 656c 662e 7365 6375 7269 7479 2e67   self.security.g
-0001f930: 6574 5f63 6f6e 6e65 6374 696f 6e5f 6172  et_connection_ar
-0001f940: 6773 2822 7363 6865 6475 6c65 7222 290a  gs("scheduler").
-0001f950: 2020 2020 2020 2020 7365 6c66 2e63 6f6e          self.con
-0001f960: 6e65 6374 696f 6e5f 6172 6773 5b22 6861  nection_args["ha
-0001f970: 6e64 7368 616b 655f 6f76 6572 7269 6465  ndshake_override
-0001f980: 7322 5d20 3d20 7b20 2023 2063 6f6d 6d6f  s"] = {  # commo
-0001f990: 6e20 6465 6e6f 6d69 6e61 746f 720a 2020  n denominator.  
-0001f9a0: 2020 2020 2020 2020 2020 2270 6963 6b6c            "pickl
-0001f9b0: 652d 7072 6f74 6f63 6f6c 223a 2034 0a20  e-protocol": 4. 
-0001f9c0: 2020 2020 2020 207d 0a0a 2020 2020 2020         }..      
-0001f9d0: 2020 7365 6c66 2e5f 7374 6172 745f 6164    self._start_ad
-0001f9e0: 6472 6573 7320 3d20 6164 6472 6573 7365  dress = addresse
-0001f9f0: 735f 6672 6f6d 5f75 7365 725f 6172 6773  s_from_user_args
-0001fa00: 280a 2020 2020 2020 2020 2020 2020 686f  (.            ho
-0001fa10: 7374 3d68 6f73 742c 0a20 2020 2020 2020  st=host,.       
-0001fa20: 2020 2020 2070 6f72 743d 706f 7274 2c0a       port=port,.
-0001fa30: 2020 2020 2020 2020 2020 2020 696e 7465              inte
-0001fa40: 7266 6163 653d 696e 7465 7266 6163 652c  rface=interface,
-0001fa50: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-0001fa60: 746f 636f 6c3d 7072 6f74 6f63 6f6c 2c0a  tocol=protocol,.
-0001fa70: 2020 2020 2020 2020 2020 2020 7365 6375              secu
-0001fa80: 7269 7479 3d73 6563 7572 6974 792c 0a20  rity=security,. 
-0001fa90: 2020 2020 2020 2020 2020 2064 6566 6175             defau
-0001faa0: 6c74 5f70 6f72 743d 7365 6c66 2e64 6566  lt_port=self.def
-0001fab0: 6175 6c74 5f70 6f72 742c 0a20 2020 2020  ault_port,.     
-0001fac0: 2020 2029 0a0a 2020 2020 2020 2020 6874     )..        ht
-0001fad0: 7470 5f73 6572 7665 725f 6d6f 6475 6c65  tp_server_module
-0001fae0: 7320 3d20 6461 736b 2e63 6f6e 6669 672e  s = dask.config.
-0001faf0: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
-0001fb00: 2e73 6368 6564 756c 6572 2e68 7474 702e  .scheduler.http.
-0001fb10: 726f 7574 6573 2229 0a20 2020 2020 2020  routes").       
-0001fb20: 2073 686f 775f 6461 7368 626f 6172 6420   show_dashboard 
-0001fb30: 3d20 6461 7368 626f 6172 6420 6f72 2028  = dashboard or (
-0001fb40: 6461 7368 626f 6172 6420 6973 204e 6f6e  dashboard is Non
-0001fb50: 6520 616e 6420 6461 7368 626f 6172 645f  e and dashboard_
-0001fb60: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-0001fb70: 2023 2069 6e73 7461 6c6c 2076 616e 696c   # install vanil
-0001fb80: 6c61 2072 6f75 7465 2069 6620 7368 6f77  la route if show
-0001fb90: 5f64 6173 6862 6f61 7264 2062 7574 2062  _dashboard but b
-0001fba0: 6f6b 6568 2069 7320 6e6f 7420 696e 7374  okeh is not inst
-0001fbb0: 616c 6c65 640a 2020 2020 2020 2020 6966  alled.        if
-0001fbc0: 2073 686f 775f 6461 7368 626f 6172 643a   show_dashboard:
-0001fbd0: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
-0001fbe0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001fbf0: 2020 696d 706f 7274 2064 6973 7472 6962    import distrib
-0001fc00: 7574 6564 2e64 6173 6862 6f61 7264 2e73  uted.dashboard.s
-0001fc10: 6368 6564 756c 6572 0a20 2020 2020 2020  cheduler.       
-0001fc20: 2020 2020 2065 7863 6570 7420 496d 706f       except Impo
-0001fc30: 7274 4572 726f 723a 0a20 2020 2020 2020  rtError:.       
-0001fc40: 2020 2020 2020 2020 2073 686f 775f 6461           show_da
-0001fc50: 7368 626f 6172 6420 3d20 4661 6c73 650a  shboard = False.
-0001fc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc70: 6874 7470 5f73 6572 7665 725f 6d6f 6475  http_server_modu
-0001fc80: 6c65 732e 6170 7065 6e64 2822 6469 7374  les.append("dist
-0001fc90: 7269 6275 7465 642e 6874 7470 2e73 6368  ributed.http.sch
-0001fca0: 6564 756c 6572 2e6d 6973 7369 6e67 5f62  eduler.missing_b
-0001fcb0: 6f6b 6568 2229 0a20 2020 2020 2020 2072  okeh").        r
-0001fcc0: 6f75 7465 7320 3d20 6765 745f 6861 6e64  outes = get_hand
-0001fcd0: 6c65 7273 280a 2020 2020 2020 2020 2020  lers(.          
-0001fce0: 2020 7365 7276 6572 3d73 656c 662c 206d    server=self, m
-0001fcf0: 6f64 756c 6573 3d68 7474 705f 7365 7276  odules=http_serv
-0001fd00: 6572 5f6d 6f64 756c 6573 2c20 7072 6566  er_modules, pref
-0001fd10: 6978 3d68 7474 705f 7072 6566 6978 0a20  ix=http_prefix. 
-0001fd20: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001fd30: 2073 656c 662e 7374 6172 745f 6874 7470   self.start_http
-0001fd40: 5f73 6572 7665 7228 726f 7574 6573 2c20  _server(routes, 
-0001fd50: 6461 7368 626f 6172 645f 6164 6472 6573  dashboard_addres
-0001fd60: 732c 2064 6566 6175 6c74 5f70 6f72 743d  s, default_port=
-0001fd70: 3837 3837 290a 2020 2020 2020 2020 7365  8787).        se
-0001fd80: 6c66 2e6a 7570 7974 6572 203d 206a 7570  lf.jupyter = jup
-0001fd90: 7974 6572 0a20 2020 2020 2020 2069 6620  yter.        if 
-0001fda0: 7368 6f77 5f64 6173 6862 6f61 7264 3a0a  show_dashboard:.
-0001fdb0: 2020 2020 2020 2020 2020 2020 6469 7374              dist
-0001fdc0: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
-0001fdd0: 642e 7363 6865 6475 6c65 722e 636f 6e6e  d.scheduler.conn
-0001fde0: 6563 7428 0a20 2020 2020 2020 2020 2020  ect(.           
-0001fdf0: 2020 2020 2073 656c 662e 6874 7470 5f61       self.http_a
-0001fe00: 7070 6c69 6361 7469 6f6e 2c20 7365 6c66  pplication, self
-0001fe10: 2e68 7474 705f 7365 7276 6572 2c20 7365  .http_server, se
-0001fe20: 6c66 2c20 7072 6566 6978 3d68 7474 705f  lf, prefix=http_
-0001fe30: 7072 6566 6978 0a20 2020 2020 2020 2020  prefix.         
-0001fe40: 2020 2029 0a20 2020 2020 2020 2073 6368     ).        sch
-0001fe50: 6564 756c 6572 203d 2073 656c 660a 2020  eduler = self.  
-0001fe60: 2020 2020 2020 6966 2073 656c 662e 6a75        if self.ju
-0001fe70: 7079 7465 723a 0a20 2020 2020 2020 2020  pyter:.         
-0001fe80: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0001fe90: 2020 2020 2020 2020 6672 6f6d 206a 7570          from jup
-0001fea0: 7974 6572 5f73 6572 7665 722e 7365 7276  yter_server.serv
-0001feb0: 6572 6170 7020 696d 706f 7274 2053 6572  erapp import Ser
-0001fec0: 7665 7241 7070 0a20 2020 2020 2020 2020  verApp.         
-0001fed0: 2020 2065 7863 6570 7420 496d 706f 7274     except Import
-0001fee0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0001fef0: 2020 2020 2020 2072 6169 7365 2049 6d70         raise Imp
-0001ff00: 6f72 7445 7272 6f72 280a 2020 2020 2020  ortError(.      
-0001ff10: 2020 2020 2020 2020 2020 2020 2020 2249                "I
-0001ff20: 6e20 6f72 6465 7220 746f 2075 7365 2074  n order to use t
-0001ff30: 6865 2044 6173 6b20 6a75 7079 7465 7220  he Dask jupyter 
-0001ff40: 6f70 7469 6f6e 2079 6f75 2022 0a20 2020  option you ".   
+0001d8f0: 2020 2020 2020 2020 2320 4e6f 206c 6976          # No liv
+0001d900: 6520 6465 7065 6e64 656e 7473 2c20 6361  e dependents, ca
+0001d910: 6e20 666f 7267 6574 0a20 2020 2020 2020  n forget.       
+0001d920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d930: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+0001d940: 5b74 732e 6b65 795d 203d 2022 666f 7267  [ts.key] = "forg
+0001d950: 6f74 7465 6e22 0a20 2020 2020 2020 2020  otten".         
+0001d960: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0001d970: 7473 2e73 7461 7465 2021 3d20 2265 7272  ts.state != "err
+0001d980: 6564 2220 616e 6420 6e6f 7420 7473 2e77  ed" and not ts.w
+0001d990: 6169 7465 7273 3a0a 2020 2020 2020 2020  aiters:.        
+0001d9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d9b0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
+0001d9c0: 7473 2e6b 6579 5d20 3d20 2272 656c 6561  ts.key] = "relea
+0001d9d0: 7365 6422 0a0a 2020 2020 6465 6620 5f74  sed"..    def _t
+0001d9e0: 6173 6b5f 746f 5f6d 7367 2873 656c 662c  ask_to_msg(self,
+0001d9f0: 2074 733a 2054 6173 6b53 7461 7465 2c20   ts: TaskState, 
+0001da00: 6475 7261 7469 6f6e 3a20 666c 6f61 7420  duration: float 
+0001da10: 3d20 2d31 2920 2d3e 2064 6963 745b 7374  = -1) -> dict[st
+0001da20: 722c 2041 6e79 5d3a 0a20 2020 2020 2020  r, Any]:.       
+0001da30: 2022 2222 436f 6e76 6572 7420 6120 7369   """Convert a si
+0001da40: 6e67 6c65 2063 6f6d 7075 7461 7469 6f6e  ngle computation
+0001da50: 616c 2074 6173 6b20 746f 2061 206d 6573  al task to a mes
+0001da60: 7361 6765 2222 220a 2020 2020 2020 2020  sage""".        
+0001da70: 2320 4649 584d 453a 2054 6865 2064 7572  # FIXME: The dur
+0001da80: 6174 696f 6e20 6174 7472 6962 7574 6520  ation attribute 
+0001da90: 6973 206e 6f74 2075 7365 6420 6f6e 2077  is not used on w
+0001daa0: 6f72 6b65 722e 2057 6520 636f 756c 6420  orker. We could 
+0001dab0: 7361 7665 206f 7572 7365 6c76 6573 2074  save ourselves t
+0001dac0: 6865 0a20 2020 2020 2020 2023 2020 2020  he.        #    
+0001dad0: 2020 2020 7469 6d65 2074 6f20 636f 6d70      time to comp
+0001dae0: 7574 6520 616e 6420 7375 626d 6974 2074  ute and submit t
+0001daf0: 6869 730a 2020 2020 2020 2020 6966 2064  his.        if d
+0001db00: 7572 6174 696f 6e20 3c20 303a 0a20 2020  uration < 0:.   
+0001db10: 2020 2020 2020 2020 2064 7572 6174 696f           duratio
+0001db20: 6e20 3d20 7365 6c66 2e67 6574 5f74 6173  n = self.get_tas
+0001db30: 6b5f 6475 7261 7469 6f6e 2874 7329 0a20  k_duration(ts). 
+0001db40: 2020 2020 2020 2074 732e 7275 6e5f 6964         ts.run_id
+0001db50: 203d 206e 6578 7428 5461 736b 5374 6174   = next(TaskStat
+0001db60: 652e 5f72 756e 5f69 645f 6974 6572 6174  e._run_id_iterat
+0001db70: 6f72 290a 2020 2020 2020 2020 6173 7365  or).        asse
+0001db80: 7274 2074 732e 7072 696f 7269 7479 2c20  rt ts.priority, 
+0001db90: 7473 0a20 2020 2020 2020 206d 7367 3a20  ts.        msg: 
+0001dba0: 6469 6374 5b73 7472 2c20 416e 795d 203d  dict[str, Any] =
+0001dbb0: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+0001dbc0: 6f70 223a 2022 636f 6d70 7574 652d 7461  op": "compute-ta
+0001dbd0: 736b 222c 0a20 2020 2020 2020 2020 2020  sk",.           
+0001dbe0: 2022 6b65 7922 3a20 7473 2e6b 6579 2c0a   "key": ts.key,.
+0001dbf0: 2020 2020 2020 2020 2020 2020 2272 756e              "run
+0001dc00: 5f69 6422 3a20 7473 2e72 756e 5f69 642c  _id": ts.run_id,
+0001dc10: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
+0001dc20: 696f 7269 7479 223a 2074 732e 7072 696f  iority": ts.prio
+0001dc30: 7269 7479 2c0a 2020 2020 2020 2020 2020  rity,.          
+0001dc40: 2020 2264 7572 6174 696f 6e22 3a20 6475    "duration": du
+0001dc50: 7261 7469 6f6e 2c0a 2020 2020 2020 2020  ration,.        
+0001dc60: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
+0001dc70: 223a 2066 2263 6f6d 7075 7465 2d74 6173  ": f"compute-tas
+0001dc80: 6b2d 7b74 696d 6528 297d 222c 0a20 2020  k-{time()}",.   
+0001dc90: 2020 2020 2020 2020 2022 7768 6f5f 6861           "who_ha
+0001dca0: 7322 3a20 7b0a 2020 2020 2020 2020 2020  s": {.          
+0001dcb0: 2020 2020 2020 6474 732e 6b65 793a 205b        dts.key: [
+0001dcc0: 7773 2e61 6464 7265 7373 2066 6f72 2077  ws.address for w
+0001dcd0: 7320 696e 2064 7473 2e77 686f 5f68 6173  s in dts.who_has
+0001dce0: 206f 7220 2829 5d0a 2020 2020 2020 2020   or ()].        
+0001dcf0: 2020 2020 2020 2020 666f 7220 6474 7320          for dts 
+0001dd00: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+0001dd10: 6573 0a20 2020 2020 2020 2020 2020 207d  es.            }
+0001dd20: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
+0001dd30: 6279 7465 7322 3a20 7b64 7473 2e6b 6579  bytes": {dts.key
+0001dd40: 3a20 6474 732e 6e62 7974 6573 2066 6f72  : dts.nbytes for
+0001dd50: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+0001dd60: 6465 6e63 6965 737d 2c0a 2020 2020 2020  dencies},.      
+0001dd70: 2020 2020 2020 2272 756e 5f73 7065 6322        "run_spec"
+0001dd80: 3a20 546f 5069 636b 6c65 2874 732e 7275  : ToPickle(ts.ru
+0001dd90: 6e5f 7370 6563 292c 0a20 2020 2020 2020  n_spec),.       
+0001dda0: 2020 2020 2022 7265 736f 7572 6365 5f72       "resource_r
+0001ddb0: 6573 7472 6963 7469 6f6e 7322 3a20 7473  estrictions": ts
+0001ddc0: 2e72 6573 6f75 7263 655f 7265 7374 7269  .resource_restri
+0001ddd0: 6374 696f 6e73 2c0a 2020 2020 2020 2020  ctions,.        
+0001dde0: 2020 2020 2261 6374 6f72 223a 2074 732e      "actor": ts.
+0001ddf0: 6163 746f 722c 0a20 2020 2020 2020 2020  actor,.         
+0001de00: 2020 2022 616e 6e6f 7461 7469 6f6e 7322     "annotations"
+0001de10: 3a20 7473 2e61 6e6e 6f74 6174 696f 6e73  : ts.annotations
+0001de20: 206f 7220 7b7d 2c0a 2020 2020 2020 2020   or {},.        
+0001de30: 2020 2020 2273 7061 6e5f 6964 223a 2074      "span_id": t
+0001de40: 732e 6772 6f75 702e 7370 616e 5f69 642c  s.group.span_id,
+0001de50: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
+0001de60: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
+0001de70: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
+0001de80: 2061 7373 6572 7420 616c 6c28 6d73 675b   assert all(msg[
+0001de90: 2277 686f 5f68 6173 225d 2e76 616c 7565  "who_has"].value
+0001dea0: 7328 2929 0a0a 2020 2020 2020 2020 7265  s())..        re
+0001deb0: 7475 726e 206d 7367 0a0a 0a63 6c61 7373  turn msg...class
+0001dec0: 2053 6368 6564 756c 6572 2853 6368 6564   Scheduler(Sched
+0001ded0: 756c 6572 5374 6174 652c 2053 6572 7665  ulerState, Serve
+0001dee0: 724e 6f64 6529 3a0a 2020 2020 2222 2244  rNode):.    """D
+0001def0: 796e 616d 6963 2064 6973 7472 6962 7574  ynamic distribut
+0001df00: 6564 2074 6173 6b20 7363 6865 6475 6c65  ed task schedule
+0001df10: 720a 0a20 2020 2054 6865 2073 6368 6564  r..    The sched
+0001df20: 756c 6572 2074 7261 636b 7320 7468 6520  uler tracks the 
+0001df30: 6375 7272 656e 7420 7374 6174 6520 6f66  current state of
+0001df40: 2077 6f72 6b65 7273 2c20 6461 7461 2c20   workers, data, 
+0001df50: 616e 6420 636f 6d70 7574 6174 696f 6e73  and computations
+0001df60: 2e0a 2020 2020 5468 6520 7363 6865 6475  ..    The schedu
+0001df70: 6c65 7220 6c69 7374 656e 7320 666f 7220  ler listens for 
+0001df80: 6576 656e 7473 2061 6e64 2072 6573 706f  events and respo
+0001df90: 6e64 7320 6279 2063 6f6e 7472 6f6c 6c69  nds by controlli
+0001dfa0: 6e67 2077 6f72 6b65 7273 0a20 2020 2061  ng workers.    a
+0001dfb0: 7070 726f 7072 6961 7465 6c79 2e20 2049  ppropriately.  I
+0001dfc0: 7420 636f 6e74 696e 756f 7573 6c79 2074  t continuously t
+0001dfd0: 7269 6573 2074 6f20 7573 6520 7468 6520  ries to use the 
+0001dfe0: 776f 726b 6572 7320 746f 2065 7865 6375  workers to execu
+0001dff0: 7465 2061 6e20 6576 6572 0a20 2020 2067  te an ever.    g
+0001e000: 726f 7769 6e67 2064 6173 6b20 6772 6170  rowing dask grap
+0001e010: 682e 0a0a 2020 2020 416c 6c20 6576 656e  h...    All even
+0001e020: 7473 2061 7265 2068 616e 646c 6564 2071  ts are handled q
+0001e030: 7569 636b 6c79 2c20 696e 206c 696e 6561  uickly, in linea
+0001e040: 7220 7469 6d65 2077 6974 6820 7265 7370  r time with resp
+0001e050: 6563 7420 746f 2074 6865 6972 2069 6e70  ect to their inp
+0001e060: 7574 0a20 2020 2028 7768 6963 6820 6973  ut.    (which is
+0001e070: 206f 6674 656e 206f 6620 636f 6e73 7461   often of consta
+0001e080: 6e74 2073 697a 6529 2061 6e64 2067 656e  nt size) and gen
+0001e090: 6572 616c 6c79 2077 6974 6869 6e20 6120  erally within a 
+0001e0a0: 6d69 6c6c 6973 6563 6f6e 642e 2020 546f  millisecond.  To
+0001e0b0: 0a20 2020 2061 6363 6f6d 706c 6973 6820  .    accomplish 
+0001e0c0: 7468 6973 2074 6865 2073 6368 6564 756c  this the schedul
+0001e0d0: 6572 2074 7261 636b 7320 6120 6c6f 7420  er tracks a lot 
+0001e0e0: 6f66 2073 7461 7465 2e20 2045 7665 7279  of state.  Every
+0001e0f0: 206f 7065 7261 7469 6f6e 0a20 2020 206d   operation.    m
+0001e100: 6169 6e74 6169 6e73 2074 6865 2063 6f6e  aintains the con
+0001e110: 7369 7374 656e 6379 206f 6620 7468 6973  sistency of this
+0001e120: 2073 7461 7465 2e0a 0a20 2020 2054 6865   state...    The
+0001e130: 2073 6368 6564 756c 6572 2063 6f6d 6d75   scheduler commu
+0001e140: 6e69 6361 7465 7320 7769 7468 2074 6865  nicates with the
+0001e150: 206f 7574 7369 6465 2077 6f72 6c64 2074   outside world t
+0001e160: 6872 6f75 6768 2043 6f6d 6d20 6f62 6a65  hrough Comm obje
+0001e170: 6374 732e 0a20 2020 2049 7420 6d61 696e  cts..    It main
+0001e180: 7461 696e 7320 6120 636f 6e73 6973 7465  tains a consiste
+0001e190: 6e74 2061 6e64 2076 616c 6964 2076 6965  nt and valid vie
+0001e1a0: 7720 6f66 2074 6865 2077 6f72 6c64 2065  w of the world e
+0001e1b0: 7665 6e20 7768 656e 206c 6973 7465 6e69  ven when listeni
+0001e1c0: 6e67 0a20 2020 2074 6f20 7365 7665 7261  ng.    to severa
+0001e1d0: 6c20 636c 6965 6e74 7320 6174 206f 6e63  l clients at onc
+0001e1e0: 652e 0a0a 2020 2020 4120 5363 6865 6475  e...    A Schedu
+0001e1f0: 6c65 7220 6973 2074 7970 6963 616c 6c79  ler is typically
+0001e200: 2073 7461 7274 6564 2065 6974 6865 7220   started either 
+0001e210: 7769 7468 2074 6865 2060 6064 6173 6b20  with the ``dask 
+0001e220: 7363 6865 6475 6c65 7260 600a 2020 2020  scheduler``.    
+0001e230: 6578 6563 7574 6162 6c65 3a3a 0a0a 2020  executable::..  
+0001e240: 2020 2020 2020 2024 2064 6173 6b20 7363         $ dask sc
+0001e250: 6865 6475 6c65 720a 2020 2020 2020 2020  heduler.        
+0001e260: 2053 6368 6564 756c 6572 2073 7461 7274   Scheduler start
+0001e270: 6564 2061 7420 3132 372e 302e 302e 313a  ed at 127.0.0.1:
+0001e280: 3837 3836 0a0a 2020 2020 4f72 2077 6974  8786..    Or wit
+0001e290: 6869 6e20 6120 4c6f 6361 6c43 6c75 7374  hin a LocalClust
+0001e2a0: 6572 2061 2043 6c69 656e 7420 7374 6172  er a Client star
+0001e2b0: 7473 2075 7020 7769 7468 6f75 7420 636f  ts up without co
+0001e2c0: 6e6e 6563 7469 6f6e 0a20 2020 2069 6e66  nnection.    inf
+0001e2d0: 6f72 6d61 7469 6f6e 3a3a 0a0a 2020 2020  ormation::..    
+0001e2e0: 2020 2020 3e3e 3e20 6320 3d20 436c 6965      >>> c = Clie
+0001e2f0: 6e74 2829 2020 2320 646f 6374 6573 743a  nt()  # doctest:
+0001e300: 202b 534b 4950 0a20 2020 2020 2020 203e   +SKIP.        >
+0001e310: 3e3e 2063 2e63 6c75 7374 6572 2e73 6368  >> c.cluster.sch
+0001e320: 6564 756c 6572 2020 2320 646f 6374 6573  eduler  # doctes
+0001e330: 743a 202b 534b 4950 0a20 2020 2020 2020  t: +SKIP.       
+0001e340: 2053 6368 6564 756c 6572 282e 2e2e 290a   Scheduler(...).
+0001e350: 0a20 2020 2055 7365 7273 2074 7970 6963  .    Users typic
+0001e360: 616c 6c79 2064 6f20 6e6f 7420 696e 7465  ally do not inte
+0001e370: 7261 6374 2077 6974 6820 7468 6520 7363  ract with the sc
+0001e380: 6865 6475 6c65 7220 6469 7265 6374 6c79  heduler directly
+0001e390: 2062 7574 2072 6174 6865 7220 7769 7468   but rather with
+0001e3a0: 0a20 2020 2074 6865 2063 6c69 656e 7420  .    the client 
+0001e3b0: 6f62 6a65 6374 2060 6043 6c69 656e 7460  object ``Client`
+0001e3c0: 602e 0a0a 2020 2020 5468 6520 6060 636f  `...    The ``co
+0001e3d0: 6e74 6163 745f 6164 6472 6573 7360 6020  ntact_address`` 
+0001e3e0: 7061 7261 6d65 7465 7220 616c 6c6f 7773  parameter allows
+0001e3f0: 2074 6f20 6164 7665 7274 6973 6520 6120   to advertise a 
+0001e400: 7370 6563 6966 6963 2061 6464 7265 7373  specific address
+0001e410: 2074 6f0a 2020 2020 7468 6520 776f 726b   to.    the work
+0001e420: 6572 7320 666f 7220 636f 6d6d 756e 6963  ers for communic
+0001e430: 6174 696f 6e20 7769 7468 2074 6865 2073  ation with the s
+0001e440: 6368 6564 756c 6572 2c20 7768 6963 6820  cheduler, which 
+0001e450: 6973 2064 6966 6665 7265 6e74 2074 6861  is different tha
+0001e460: 6e0a 2020 2020 7468 6520 6164 6472 6573  n.    the addres
+0001e470: 7320 7468 6520 7363 6865 6475 6c65 7220  s the scheduler 
+0001e480: 6269 6e64 7320 746f 2e20 5468 6973 2069  binds to. This i
+0001e490: 7320 7573 6566 756c 2077 6865 6e20 7468  s useful when th
+0001e4a0: 6520 7363 6865 6475 6c65 720a 2020 2020  e scheduler.    
+0001e4b0: 6c69 7374 656e 7320 6f6e 2061 2070 7269  listens on a pri
+0001e4c0: 7661 7465 2061 6464 7265 7373 2c20 7768  vate address, wh
+0001e4d0: 6963 6820 7468 6572 6566 6f72 6520 6361  ich therefore ca
+0001e4e0: 6e6e 6f74 2062 6520 7573 6564 2062 7920  nnot be used by 
+0001e4f0: 7468 6520 776f 726b 6572 730a 2020 2020  the workers.    
+0001e500: 746f 2063 6f6e 7461 6374 2069 742e 0a0a  to contact it...
+0001e510: 2020 2020 2a2a 5374 6174 652a 2a0a 0a20      **State**.. 
+0001e520: 2020 2054 6865 2073 6368 6564 756c 6572     The scheduler
+0001e530: 2063 6f6e 7461 696e 7320 7468 6520 666f   contains the fo
+0001e540: 6c6c 6f77 696e 6720 7374 6174 6520 7661  llowing state va
+0001e550: 7269 6162 6c65 732e 2020 4561 6368 2076  riables.  Each v
+0001e560: 6172 6961 626c 6520 6973 0a20 2020 206c  ariable is.    l
+0001e570: 6973 7465 6420 616c 6f6e 6720 7769 7468  isted along with
+0001e580: 2077 6861 7420 6974 2073 746f 7265 7320   what it stores 
+0001e590: 616e 6420 6120 6272 6965 6620 6465 7363  and a brief desc
+0001e5a0: 7269 7074 696f 6e2e 0a0a 2020 2020 2a20  ription...    * 
+0001e5b0: 2a2a 7461 736b 733a 2a2a 2060 607b 7461  **tasks:** ``{ta
+0001e5c0: 736b 206b 6579 3a20 5461 736b 5374 6174  sk key: TaskStat
+0001e5d0: 657d 6060 0a20 2020 2020 2020 2054 6173  e}``.        Tas
+0001e5e0: 6b73 2063 7572 7265 6e74 6c79 206b 6e6f  ks currently kno
+0001e5f0: 776e 2074 6f20 7468 6520 7363 6865 6475  wn to the schedu
+0001e600: 6c65 720a 2020 2020 2a20 2a2a 756e 7275  ler.    * **unru
+0001e610: 6e6e 6162 6c65 3a2a 2a20 6060 7b54 6173  nnable:** ``{Tas
+0001e620: 6b53 7461 7465 7d60 600a 2020 2020 2020  kState}``.      
+0001e630: 2020 5461 736b 7320 696e 2074 6865 2022    Tasks in the "
+0001e640: 6e6f 2d77 6f72 6b65 7222 2073 7461 7465  no-worker" state
+0001e650: 0a0a 2020 2020 2a20 2a2a 776f 726b 6572  ..    * **worker
+0001e660: 733a 2a2a 2060 607b 776f 726b 6572 206b  s:** ``{worker k
+0001e670: 6579 3a20 576f 726b 6572 5374 6174 657d  ey: WorkerState}
+0001e680: 6060 0a20 2020 2020 2020 2057 6f72 6b65  ``.        Worke
+0001e690: 7273 2063 7572 7265 6e74 6c79 2063 6f6e  rs currently con
+0001e6a0: 6e65 6374 6564 2074 6f20 7468 6520 7363  nected to the sc
+0001e6b0: 6865 6475 6c65 720a 2020 2020 2a20 2a2a  heduler.    * **
+0001e6c0: 6964 6c65 3a2a 2a20 6060 7b57 6f72 6b65  idle:** ``{Worke
+0001e6d0: 7253 7461 7465 7d60 603a 0a20 2020 2020  rState}``:.     
+0001e6e0: 2020 2053 6574 206f 6620 776f 726b 6572     Set of worker
+0001e6f0: 7320 7468 6174 2061 7265 206e 6f74 2066  s that are not f
+0001e700: 756c 6c79 2075 7469 6c69 7a65 640a 2020  ully utilized.  
+0001e710: 2020 2a20 2a2a 7361 7475 7261 7465 643a    * **saturated:
+0001e720: 2a2a 2060 607b 576f 726b 6572 5374 6174  ** ``{WorkerStat
+0001e730: 657d 6060 3a0a 2020 2020 2020 2020 5365  e}``:.        Se
+0001e740: 7420 6f66 2077 6f72 6b65 7273 2074 6861  t of workers tha
+0001e750: 7420 6172 6520 6e6f 7420 6f76 6572 2d75  t are not over-u
+0001e760: 7469 6c69 7a65 640a 0a20 2020 202a 202a  tilized..    * *
+0001e770: 2a68 6f73 745f 696e 666f 3a2a 2a20 6060  *host_info:** ``
+0001e780: 7b68 6f73 746e 616d 653a 2064 6963 747d  {hostname: dict}
+0001e790: 6060 3a0a 2020 2020 2020 2020 496e 666f  ``:.        Info
+0001e7a0: 726d 6174 696f 6e20 6162 6f75 7420 6561  rmation about ea
+0001e7b0: 6368 2077 6f72 6b65 7220 686f 7374 0a0a  ch worker host..
+0001e7c0: 2020 2020 2a20 2a2a 636c 6965 6e74 733a      * **clients:
+0001e7d0: 2a2a 2060 607b 636c 6965 6e74 206b 6579  ** ``{client key
+0001e7e0: 3a20 436c 6965 6e74 5374 6174 657d 6060  : ClientState}``
+0001e7f0: 0a20 2020 2020 2020 2043 6c69 656e 7473  .        Clients
+0001e800: 2063 7572 7265 6e74 6c79 2063 6f6e 6e65   currently conne
+0001e810: 6374 6564 2074 6f20 7468 6520 7363 6865  cted to the sche
+0001e820: 6475 6c65 720a 0a20 2020 202a 202a 2a73  duler..    * **s
+0001e830: 6572 7669 6365 733a 2a2a 2060 607b 7374  ervices:** ``{st
+0001e840: 723a 2070 6f72 747d 6060 3a0a 2020 2020  r: port}``:.    
+0001e850: 2020 2020 4f74 6865 7220 7365 7276 6963      Other servic
+0001e860: 6573 2072 756e 6e69 6e67 206f 6e20 7468  es running on th
+0001e870: 6973 2073 6368 6564 756c 6572 2c20 6c69  is scheduler, li
+0001e880: 6b65 2042 6f6b 6568 0a20 2020 202a 202a  ke Bokeh.    * *
+0001e890: 2a6c 6f6f 703a 2a2a 2060 6049 4f4c 6f6f  *loop:** ``IOLoo
+0001e8a0: 7060 603a 0a20 2020 2020 2020 2054 6865  p``:.        The
+0001e8b0: 2072 756e 6e69 6e67 2054 6f72 6e61 646f   running Tornado
+0001e8c0: 2049 4f4c 6f6f 700a 2020 2020 2a20 2a2a   IOLoop.    * **
+0001e8d0: 636c 6965 6e74 5f63 6f6d 6d73 3a2a 2a20  client_comms:** 
+0001e8e0: 6060 7b63 6c69 656e 7420 6b65 793a 2043  ``{client key: C
+0001e8f0: 6f6d 6d7d 6060 0a20 2020 2020 2020 2046  omm}``.        F
+0001e900: 6f72 2065 6163 6820 636c 6965 6e74 2c20  or each client, 
+0001e910: 6120 436f 6d6d 206f 626a 6563 7420 7573  a Comm object us
+0001e920: 6564 2074 6f20 7265 6365 6976 6520 7461  ed to receive ta
+0001e930: 736b 2072 6571 7565 7374 7320 616e 640a  sk requests and.
+0001e940: 2020 2020 2020 2020 7265 706f 7274 2074          report t
+0001e950: 6173 6b20 7374 6174 7573 2075 7064 6174  ask status updat
+0001e960: 6573 2e0a 2020 2020 2a20 2a2a 7374 7265  es..    * **stre
+0001e970: 616d 5f63 6f6d 6d73 3a2a 2a20 6060 7b77  am_comms:** ``{w
+0001e980: 6f72 6b65 7220 6b65 793a 2043 6f6d 6d7d  orker key: Comm}
+0001e990: 6060 0a20 2020 2020 2020 2046 6f72 2065  ``.        For e
+0001e9a0: 6163 6820 776f 726b 6572 2c20 6120 436f  ach worker, a Co
+0001e9b0: 6d6d 206f 626a 6563 7420 6672 6f6d 2077  mm object from w
+0001e9c0: 6869 6368 2077 6520 626f 7468 2061 6363  hich we both acc
+0001e9d0: 6570 7420 7374 696d 756c 6920 616e 640a  ept stimuli and.
+0001e9e0: 2020 2020 2020 2020 7265 706f 7274 2072          report r
+0001e9f0: 6573 756c 7473 0a20 2020 202a 202a 2a74  esults.    * **t
+0001ea00: 6173 6b5f 6475 7261 7469 6f6e 3a2a 2a20  ask_duration:** 
+0001ea10: 6060 7b6b 6579 2d70 7265 6669 783a 2074  ``{key-prefix: t
+0001ea20: 696d 657d 6060 0a20 2020 2020 2020 2054  ime}``.        T
+0001ea30: 696d 6520 7765 2065 7870 6563 7420 6365  ime we expect ce
+0001ea40: 7274 6169 6e20 6675 6e63 7469 6f6e 7320  rtain functions 
+0001ea50: 746f 2074 616b 652c 2065 2e67 2e20 6060  to take, e.g. ``
+0001ea60: 7b27 7375 6d27 3a20 302e 3235 7d60 600a  {'sum': 0.25}``.
+0001ea70: 2020 2020 2222 220a 0a20 2020 2064 6566      """..    def
+0001ea80: 6175 6c74 5f70 6f72 7420 3d20 3837 3836  ault_port = 8786
+0001ea90: 0a20 2020 205f 696e 7374 616e 6365 733a  .    _instances:
+0001eaa0: 2043 6c61 7373 5661 725b 7765 616b 7265   ClassVar[weakre
+0001eab0: 662e 5765 616b 5365 745b 5363 6865 6475  f.WeakSet[Schedu
+0001eac0: 6c65 725d 5d20 3d20 7765 616b 7265 662e  ler]] = weakref.
+0001ead0: 5765 616b 5365 7428 290a 0a20 2020 2077  WeakSet()..    w
+0001eae0: 6f72 6b65 725f 7474 6c3a 2066 6c6f 6174  orker_ttl: float
+0001eaf0: 207c 204e 6f6e 650a 2020 2020 6964 6c65   | None.    idle
+0001eb00: 5f73 696e 6365 3a20 666c 6f61 7420 7c20  _since: float | 
+0001eb10: 4e6f 6e65 0a20 2020 2069 646c 655f 7469  None.    idle_ti
+0001eb20: 6d65 6f75 743a 2066 6c6f 6174 207c 204e  meout: float | N
+0001eb30: 6f6e 650a 2020 2020 5f6e 6f5f 776f 726b  one.    _no_work
+0001eb40: 6572 735f 7369 6e63 653a 2066 6c6f 6174  ers_since: float
+0001eb50: 207c 204e 6f6e 6520 2023 204e 6f74 653a   | None  # Note:
+0001eb60: 206e 6f74 204e 6f6e 6520 6966 6620 7468   not None iff th
+0001eb70: 6572 6520 6172 6520 7065 6e64 696e 6720  ere are pending 
+0001eb80: 7461 736b 730a 2020 2020 6e6f 5f77 6f72  tasks.    no_wor
+0001eb90: 6b65 7273 5f74 696d 656f 7574 3a20 666c  kers_timeout: fl
+0001eba0: 6f61 7420 7c20 4e6f 6e65 0a0a 2020 2020  oat | None..    
+0001ebb0: 6465 6620 5f5f 696e 6974 5f5f 280a 2020  def __init__(.  
+0001ebc0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+0001ebd0: 2020 2020 6c6f 6f70 3d4e 6f6e 652c 0a20      loop=None,. 
+0001ebe0: 2020 2020 2020 2064 656c 6574 655f 696e         delete_in
+0001ebf0: 7465 7276 616c 3d22 3530 306d 7322 2c0a  terval="500ms",.
+0001ec00: 2020 2020 2020 2020 7379 6e63 6872 6f6e          synchron
+0001ec10: 697a 655f 776f 726b 6572 5f69 6e74 6572  ize_worker_inter
+0001ec20: 7661 6c3d 2236 3073 222c 0a20 2020 2020  val="60s",.     
+0001ec30: 2020 2073 6572 7669 6365 733d 4e6f 6e65     services=None
+0001ec40: 2c0a 2020 2020 2020 2020 7365 7276 6963  ,.        servic
+0001ec50: 655f 6b77 6172 6773 3d4e 6f6e 652c 0a20  e_kwargs=None,. 
+0001ec60: 2020 2020 2020 2061 6c6c 6f77 6564 5f66         allowed_f
+0001ec70: 6169 6c75 7265 733d 4e6f 6e65 2c0a 2020  ailures=None,.  
+0001ec80: 2020 2020 2020 6578 7465 6e73 696f 6e73        extensions
+0001ec90: 3d4e 6f6e 652c 0a20 2020 2020 2020 2076  =None,.        v
+0001eca0: 616c 6964 6174 653d 4e6f 6e65 2c0a 2020  alidate=None,.  
+0001ecb0: 2020 2020 2020 7363 6865 6475 6c65 725f        scheduler_
+0001ecc0: 6669 6c65 3d4e 6f6e 652c 0a20 2020 2020  file=None,.     
+0001ecd0: 2020 2073 6563 7572 6974 793d 4e6f 6e65     security=None
+0001ece0: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
+0001ecf0: 5f74 746c 3d4e 6f6e 652c 0a20 2020 2020  _ttl=None,.     
+0001ed00: 2020 2069 646c 655f 7469 6d65 6f75 743d     idle_timeout=
+0001ed10: 4e6f 6e65 2c0a 2020 2020 2020 2020 696e  None,.        in
+0001ed20: 7465 7266 6163 653d 4e6f 6e65 2c0a 2020  terface=None,.  
+0001ed30: 2020 2020 2020 686f 7374 3d4e 6f6e 652c        host=None,
+0001ed40: 0a20 2020 2020 2020 2070 6f72 743d 302c  .        port=0,
+0001ed50: 0a20 2020 2020 2020 2070 726f 746f 636f  .        protoco
+0001ed60: 6c3d 4e6f 6e65 2c0a 2020 2020 2020 2020  l=None,.        
+0001ed70: 6461 7368 626f 6172 645f 6164 6472 6573  dashboard_addres
+0001ed80: 733d 4e6f 6e65 2c0a 2020 2020 2020 2020  s=None,.        
+0001ed90: 6461 7368 626f 6172 643d 4e6f 6e65 2c0a  dashboard=None,.
+0001eda0: 2020 2020 2020 2020 6874 7470 5f70 7265          http_pre
+0001edb0: 6669 783d 222f 222c 0a20 2020 2020 2020  fix="/",.       
+0001edc0: 2070 7265 6c6f 6164 3d4e 6f6e 652c 0a20   preload=None,. 
+0001edd0: 2020 2020 2020 2070 7265 6c6f 6164 5f61         preload_a
+0001ede0: 7267 763d 2829 2c0a 2020 2020 2020 2020  rgv=(),.        
+0001edf0: 706c 7567 696e 733d 2829 2c0a 2020 2020  plugins=(),.    
+0001ee00: 2020 2020 636f 6e74 6163 745f 6164 6472      contact_addr
+0001ee10: 6573 733d 4e6f 6e65 2c0a 2020 2020 2020  ess=None,.      
+0001ee20: 2020 7472 616e 7369 7469 6f6e 5f63 6f75    transition_cou
+0001ee30: 6e74 6572 5f6d 6178 3d46 616c 7365 2c0a  nter_max=False,.
+0001ee40: 2020 2020 2020 2020 6a75 7079 7465 723d          jupyter=
+0001ee50: 4661 6c73 652c 0a20 2020 2020 2020 202a  False,.        *
+0001ee60: 2a6b 7761 7267 732c 0a20 2020 2029 3a0a  *kwargs,.    ):.
+0001ee70: 2020 2020 2020 2020 6966 2064 6173 6b2e          if dask.
+0001ee80: 636f 6e66 6967 2e67 6574 2822 6469 7374  config.get("dist
+0001ee90: 7269 6275 7465 642e 7363 6865 6475 6c65  ributed.schedule
+0001eea0: 722e 7069 636b 6c65 222c 2064 6566 6175  r.pickle", defau
+0001eeb0: 6c74 3d54 7275 6529 2069 7320 4661 6c73  lt=True) is Fals
+0001eec0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0001eed0: 6169 7365 2052 756e 7469 6d65 4572 726f  aise RuntimeErro
+0001eee0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0001eef0: 2020 2022 5069 636b 6c69 6e67 2063 616e     "Pickling can
+0001ef00: 206e 6f20 6c6f 6e67 6572 2062 6520 6469   no longer be di
+0001ef10: 7361 626c 6564 2077 6974 6820 7468 6520  sabled with the 
+0001ef20: 6064 6973 7472 6962 7574 6564 2e73 6368  `distributed.sch
+0001ef30: 6564 756c 6572 2e70 6963 6b6c 6560 206f  eduler.pickle` o
+0001ef40: 7074 696f 6e2e 2050 6c65 6173 6520 7265  ption. Please re
+0001ef50: 6d6f 7665 2074 6869 7320 636f 6e66 6967  move this config
+0001ef60: 7572 6174 696f 6e20 746f 2073 7461 7274  uration to start
+0001ef70: 2074 6865 2073 6368 6564 756c 6572 2e22   the scheduler."
+0001ef80: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001ef90: 2020 2020 2020 2069 6620 6c6f 6f70 2069         if loop i
+0001efa0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0001efb0: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
+0001efc0: 2e77 6172 6e28 0a20 2020 2020 2020 2020  .warn(.         
+0001efd0: 2020 2020 2020 2022 7468 6520 6c6f 6f70         "the loop
+0001efe0: 206b 7761 7267 2074 6f20 5363 6865 6475   kwarg to Schedu
+0001eff0: 6c65 7220 6973 2064 6570 7265 6361 7465  ler is deprecate
+0001f000: 6422 2c0a 2020 2020 2020 2020 2020 2020  d",.            
+0001f010: 2020 2020 4465 7072 6563 6174 696f 6e57      DeprecationW
+0001f020: 6172 6e69 6e67 2c0a 2020 2020 2020 2020  arning,.        
+0001f030: 2020 2020 2020 2020 7374 6163 6b6c 6576          stacklev
+0001f040: 656c 3d32 2c0a 2020 2020 2020 2020 2020  el=2,.          
+0001f050: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
+0001f060: 662e 6c6f 6f70 203d 2073 656c 662e 696f  f.loop = self.io
+0001f070: 5f6c 6f6f 7020 3d20 494f 4c6f 6f70 2e63  _loop = IOLoop.c
+0001f080: 7572 7265 6e74 2829 0a20 2020 2020 2020  urrent().       
+0001f090: 2073 656c 662e 5f73 6574 7570 5f6c 6f67   self._setup_log
+0001f0a0: 6769 6e67 286c 6f67 6765 7229 0a0a 2020  ging(logger)..  
+0001f0b0: 2020 2020 2020 2320 4174 7472 6962 7574        # Attribut
+0001f0c0: 6573 0a20 2020 2020 2020 2069 6620 636f  es.        if co
+0001f0d0: 6e74 6163 745f 6164 6472 6573 7320 6973  ntact_address is
+0001f0e0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001f0f0: 2020 2063 6f6e 7461 6374 5f61 6464 7265     contact_addre
+0001f100: 7373 203d 2064 6173 6b2e 636f 6e66 6967  ss = dask.config
+0001f110: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0001f120: 642e 7363 6865 6475 6c65 722e 636f 6e74  d.scheduler.cont
+0001f130: 6163 742d 6164 6472 6573 7322 290a 2020  act-address").  
+0001f140: 2020 2020 2020 7365 6c66 2e63 6f6e 7461        self.conta
+0001f150: 6374 5f61 6464 7265 7373 203d 2063 6f6e  ct_address = con
+0001f160: 7461 6374 5f61 6464 7265 7373 0a20 2020  tact_address.   
+0001f170: 2020 2020 2069 6620 616c 6c6f 7765 645f       if allowed_
+0001f180: 6661 696c 7572 6573 2069 7320 4e6f 6e65  failures is None
+0001f190: 3a0a 2020 2020 2020 2020 2020 2020 616c  :.            al
+0001f1a0: 6c6f 7765 645f 6661 696c 7572 6573 203d  lowed_failures =
+0001f1b0: 2064 6173 6b2e 636f 6e66 6967 2e67 6574   dask.config.get
+0001f1c0: 2822 6469 7374 7269 6275 7465 642e 7363  ("distributed.sc
+0001f1d0: 6865 6475 6c65 722e 616c 6c6f 7765 642d  heduler.allowed-
+0001f1e0: 6661 696c 7572 6573 2229 0a20 2020 2020  failures").     
+0001f1f0: 2020 2073 656c 662e 616c 6c6f 7765 645f     self.allowed_
+0001f200: 6661 696c 7572 6573 203d 2061 6c6c 6f77  failures = allow
+0001f210: 6564 5f66 6169 6c75 7265 730a 2020 2020  ed_failures.    
+0001f220: 2020 2020 6966 2076 616c 6964 6174 6520      if validate 
+0001f230: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+0001f240: 2020 2020 2076 616c 6964 6174 6520 3d20       validate = 
+0001f250: 6461 736b 2e63 6f6e 6669 672e 6765 7428  dask.config.get(
+0001f260: 2264 6973 7472 6962 7574 6564 2e73 6368  "distributed.sch
+0001f270: 6564 756c 6572 2e76 616c 6964 6174 6522  eduler.validate"
+0001f280: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+0001f290: 726f 6320 3d20 7073 7574 696c 2e50 726f  roc = psutil.Pro
+0001f2a0: 6365 7373 2829 0a20 2020 2020 2020 2073  cess().        s
+0001f2b0: 656c 662e 6465 6c65 7465 5f69 6e74 6572  elf.delete_inter
+0001f2c0: 7661 6c20 3d20 7061 7273 655f 7469 6d65  val = parse_time
+0001f2d0: 6465 6c74 6128 6465 6c65 7465 5f69 6e74  delta(delete_int
+0001f2e0: 6572 7661 6c2c 2064 6566 6175 6c74 3d22  erval, default="
+0001f2f0: 6d73 2229 0a20 2020 2020 2020 2073 656c  ms").        sel
+0001f300: 662e 7379 6e63 6872 6f6e 697a 655f 776f  f.synchronize_wo
+0001f310: 726b 6572 5f69 6e74 6572 7661 6c20 3d20  rker_interval = 
+0001f320: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
+0001f330: 0a20 2020 2020 2020 2020 2020 2073 796e  .            syn
+0001f340: 6368 726f 6e69 7a65 5f77 6f72 6b65 725f  chronize_worker_
+0001f350: 696e 7465 7276 616c 2c20 6465 6661 756c  interval, defaul
+0001f360: 743d 226d 7322 0a20 2020 2020 2020 2029  t="ms".        )
+0001f370: 0a20 2020 2020 2020 2073 656c 662e 7365  .        self.se
+0001f380: 7276 6963 655f 7370 6563 7320 3d20 7365  rvice_specs = se
+0001f390: 7276 6963 6573 206f 7220 7b7d 0a20 2020  rvices or {}.   
+0001f3a0: 2020 2020 2073 656c 662e 7365 7276 6963       self.servic
+0001f3b0: 655f 6b77 6172 6773 203d 2073 6572 7669  e_kwargs = servi
+0001f3c0: 6365 5f6b 7761 7267 7320 6f72 207b 7d0a  ce_kwargs or {}.
+0001f3d0: 2020 2020 2020 2020 7365 6c66 2e73 6572          self.ser
+0001f3e0: 7669 6365 7320 3d20 7b7d 0a20 2020 2020  vices = {}.     
+0001f3f0: 2020 2073 656c 662e 7363 6865 6475 6c65     self.schedule
+0001f400: 725f 6669 6c65 203d 2073 6368 6564 756c  r_file = schedul
+0001f410: 6572 5f66 696c 650a 0a20 2020 2020 2020  er_file..       
+0001f420: 2073 656c 662e 776f 726b 6572 5f74 746c   self.worker_ttl
+0001f430: 203d 2070 6172 7365 5f74 696d 6564 656c   = parse_timedel
+0001f440: 7461 280a 2020 2020 2020 2020 2020 2020  ta(.            
+0001f450: 776f 726b 6572 5f74 746c 206f 7220 6461  worker_ttl or da
+0001f460: 736b 2e63 6f6e 6669 672e 6765 7428 2264  sk.config.get("d
+0001f470: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0001f480: 756c 6572 2e77 6f72 6b65 722d 7474 6c22  uler.worker-ttl"
+0001f490: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+0001f4a0: 2020 2020 7365 6c66 2e69 646c 655f 7469      self.idle_ti
+0001f4b0: 6d65 6f75 7420 3d20 7061 7273 655f 7469  meout = parse_ti
+0001f4c0: 6d65 6465 6c74 6128 0a20 2020 2020 2020  medelta(.       
+0001f4d0: 2020 2020 2069 646c 655f 7469 6d65 6f75       idle_timeou
+0001f4e0: 7420 6f72 2064 6173 6b2e 636f 6e66 6967  t or dask.config
+0001f4f0: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0001f500: 642e 7363 6865 6475 6c65 722e 6964 6c65  d.scheduler.idle
+0001f510: 2d74 696d 656f 7574 2229 0a20 2020 2020  -timeout").     
+0001f520: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+0001f530: 662e 6964 6c65 5f73 696e 6365 203d 2074  f.idle_since = t
+0001f540: 696d 6528 290a 2020 2020 2020 2020 7365  ime().        se
+0001f550: 6c66 2e6e 6f5f 776f 726b 6572 735f 7469  lf.no_workers_ti
+0001f560: 6d65 6f75 7420 3d20 7061 7273 655f 7469  meout = parse_ti
+0001f570: 6d65 6465 6c74 6128 0a20 2020 2020 2020  medelta(.       
+0001f580: 2020 2020 2064 6173 6b2e 636f 6e66 6967       dask.config
+0001f590: 2e67 6574 2822 6469 7374 7269 6275 7465  .get("distribute
+0001f5a0: 642e 7363 6865 6475 6c65 722e 6e6f 2d77  d.scheduler.no-w
+0001f5b0: 6f72 6b65 7273 2d74 696d 656f 7574 2229  orkers-timeout")
+0001f5c0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0001f5d0: 2020 2073 656c 662e 5f6e 6f5f 776f 726b     self._no_work
+0001f5e0: 6572 735f 7369 6e63 6520 3d20 4e6f 6e65  ers_since = None
+0001f5f0: 0a0a 2020 2020 2020 2020 7365 6c66 2e74  ..        self.t
+0001f600: 696d 655f 7374 6172 7465 6420 3d20 7365  ime_started = se
+0001f610: 6c66 2e69 646c 655f 7369 6e63 6520 2023  lf.idle_since  #
+0001f620: 2063 6f6d 7061 7469 6269 6c69 7479 2066   compatibility f
+0001f630: 6f72 2064 6173 6b2d 6761 7465 7761 790a  or dask-gateway.
+0001f640: 2020 2020 2020 2020 7365 6c66 2e5f 7265          self._re
+0001f650: 706c 6963 615f 6c6f 636b 203d 2052 4c6f  plica_lock = RLo
+0001f660: 636b 2829 0a20 2020 2020 2020 2073 656c  ck().        sel
+0001f670: 662e 6261 6e64 7769 6474 685f 776f 726b  f.bandwidth_work
+0001f680: 6572 7320 3d20 6465 6661 756c 7464 6963  ers = defaultdic
+0001f690: 7428 666c 6f61 7429 0a20 2020 2020 2020  t(float).       
+0001f6a0: 2073 656c 662e 6261 6e64 7769 6474 685f   self.bandwidth_
+0001f6b0: 7479 7065 7320 3d20 6465 6661 756c 7464  types = defaultd
+0001f6c0: 6963 7428 666c 6f61 7429 0a0a 2020 2020  ict(float)..    
+0001f6d0: 2020 2020 2320 446f 6e27 7420 6361 7374      # Don't cast
+0001f6e0: 2069 6e74 206d 6574 7269 6373 2074 6f20   int metrics to 
+0001f6f0: 666c 6f61 740a 2020 2020 2020 2020 7365  float.        se
+0001f700: 6c66 2e63 756d 756c 6174 6976 655f 776f  lf.cumulative_wo
+0001f710: 726b 6572 5f6d 6574 7269 6373 203d 2064  rker_metrics = d
+0001f720: 6566 6175 6c74 6469 6374 2869 6e74 290a  efaultdict(int).
+0001f730: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0001f740: 7072 656c 6f61 643a 0a20 2020 2020 2020  preload:.       
+0001f750: 2020 2020 2070 7265 6c6f 6164 203d 2064       preload = d
+0001f760: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+0001f770: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
+0001f780: 6475 6c65 722e 7072 656c 6f61 6422 290a  duler.preload").
+0001f790: 2020 2020 2020 2020 6966 206e 6f74 2070          if not p
+0001f7a0: 7265 6c6f 6164 5f61 7267 763a 0a20 2020  reload_argv:.   
+0001f7b0: 2020 2020 2020 2020 2070 7265 6c6f 6164           preload
+0001f7c0: 5f61 7267 7620 3d20 6461 736b 2e63 6f6e  _argv = dask.con
+0001f7d0: 6669 672e 6765 7428 2264 6973 7472 6962  fig.get("distrib
+0001f7e0: 7574 6564 2e73 6368 6564 756c 6572 2e70  uted.scheduler.p
+0001f7f0: 7265 6c6f 6164 2d61 7267 7622 290a 2020  reload-argv").  
+0001f800: 2020 2020 2020 7365 6c66 2e70 7265 6c6f        self.prelo
+0001f810: 6164 7320 3d20 7072 656c 6f61 6469 6e67  ads = preloading
+0001f820: 2e70 726f 6365 7373 5f70 7265 6c6f 6164  .process_preload
+0001f830: 7328 7365 6c66 2c20 7072 656c 6f61 642c  s(self, preload,
+0001f840: 2070 7265 6c6f 6164 5f61 7267 7629 0a0a   preload_argv)..
+0001f850: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+0001f860: 7461 6e63 6528 7365 6375 7269 7479 2c20  tance(security, 
+0001f870: 6469 6374 293a 0a20 2020 2020 2020 2020  dict):.         
+0001f880: 2020 2073 6563 7572 6974 7920 3d20 5365     security = Se
+0001f890: 6375 7269 7479 282a 2a73 6563 7572 6974  curity(**securit
+0001f8a0: 7929 0a20 2020 2020 2020 2073 656c 662e  y).        self.
+0001f8b0: 7365 6375 7269 7479 203d 2073 6563 7572  security = secur
+0001f8c0: 6974 7920 6f72 2053 6563 7572 6974 7928  ity or Security(
+0001f8d0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0001f8e0: 2069 7369 6e73 7461 6e63 6528 7365 6c66   isinstance(self
+0001f8f0: 2e73 6563 7572 6974 792c 2053 6563 7572  .security, Secur
+0001f900: 6974 7929 0a20 2020 2020 2020 2073 656c  ity).        sel
+0001f910: 662e 636f 6e6e 6563 7469 6f6e 5f61 7267  f.connection_arg
+0001f920: 7320 3d20 7365 6c66 2e73 6563 7572 6974  s = self.securit
+0001f930: 792e 6765 745f 636f 6e6e 6563 7469 6f6e  y.get_connection
+0001f940: 5f61 7267 7328 2273 6368 6564 756c 6572  _args("scheduler
+0001f950: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+0001f960: 636f 6e6e 6563 7469 6f6e 5f61 7267 735b  connection_args[
+0001f970: 2268 616e 6473 6861 6b65 5f6f 7665 7272  "handshake_overr
+0001f980: 6964 6573 225d 203d 207b 2020 2320 636f  ides"] = {  # co
+0001f990: 6d6d 6f6e 2064 656e 6f6d 696e 6174 6f72  mmon denominator
+0001f9a0: 0a20 2020 2020 2020 2020 2020 2022 7069  .            "pi
+0001f9b0: 636b 6c65 2d70 726f 746f 636f 6c22 3a20  ckle-protocol": 
+0001f9c0: 340a 2020 2020 2020 2020 7d0a 0a20 2020  4.        }..   
+0001f9d0: 2020 2020 2073 656c 662e 5f73 7461 7274       self._start
+0001f9e0: 5f61 6464 7265 7373 203d 2061 6464 7265  _address = addre
+0001f9f0: 7373 6573 5f66 726f 6d5f 7573 6572 5f61  sses_from_user_a
+0001fa00: 7267 7328 0a20 2020 2020 2020 2020 2020  rgs(.           
+0001fa10: 2068 6f73 743d 686f 7374 2c0a 2020 2020   host=host,.    
+0001fa20: 2020 2020 2020 2020 706f 7274 3d70 6f72          port=por
+0001fa30: 742c 0a20 2020 2020 2020 2020 2020 2069  t,.            i
+0001fa40: 6e74 6572 6661 6365 3d69 6e74 6572 6661  nterface=interfa
+0001fa50: 6365 2c0a 2020 2020 2020 2020 2020 2020  ce,.            
+0001fa60: 7072 6f74 6f63 6f6c 3d70 726f 746f 636f  protocol=protoco
+0001fa70: 6c2c 0a20 2020 2020 2020 2020 2020 2073  l,.            s
+0001fa80: 6563 7572 6974 793d 7365 6375 7269 7479  ecurity=security
+0001fa90: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
+0001faa0: 6661 756c 745f 706f 7274 3d73 656c 662e  fault_port=self.
+0001fab0: 6465 6661 756c 745f 706f 7274 2c0a 2020  default_port,.  
+0001fac0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+0001fad0: 2068 7474 705f 7365 7276 6572 5f6d 6f64   http_server_mod
+0001fae0: 756c 6573 203d 2064 6173 6b2e 636f 6e66  ules = dask.conf
+0001faf0: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+0001fb00: 7465 642e 7363 6865 6475 6c65 722e 6874  ted.scheduler.ht
+0001fb10: 7470 2e72 6f75 7465 7322 290a 2020 2020  tp.routes").    
+0001fb20: 2020 2020 7368 6f77 5f64 6173 6862 6f61      show_dashboa
+0001fb30: 7264 203d 2064 6173 6862 6f61 7264 206f  rd = dashboard o
+0001fb40: 7220 2864 6173 6862 6f61 7264 2069 7320  r (dashboard is 
+0001fb50: 4e6f 6e65 2061 6e64 2064 6173 6862 6f61  None and dashboa
+0001fb60: 7264 5f61 6464 7265 7373 290a 2020 2020  rd_address).    
+0001fb70: 2020 2020 2320 696e 7374 616c 6c20 7661      # install va
+0001fb80: 6e69 6c6c 6120 726f 7574 6520 6966 2073  nilla route if s
+0001fb90: 686f 775f 6461 7368 626f 6172 6420 6275  how_dashboard bu
+0001fba0: 7420 626f 6b65 6820 6973 206e 6f74 2069  t bokeh is not i
+0001fbb0: 6e73 7461 6c6c 6564 0a20 2020 2020 2020  nstalled.       
+0001fbc0: 2069 6620 7368 6f77 5f64 6173 6862 6f61   if show_dashboa
+0001fbd0: 7264 3a0a 2020 2020 2020 2020 2020 2020  rd:.            
+0001fbe0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0001fbf0: 2020 2020 2069 6d70 6f72 7420 6469 7374       import dist
+0001fc00: 7269 6275 7465 642e 6461 7368 626f 6172  ributed.dashboar
+0001fc10: 642e 7363 6865 6475 6c65 720a 2020 2020  d.scheduler.    
+0001fc20: 2020 2020 2020 2020 6578 6365 7074 2049          except I
+0001fc30: 6d70 6f72 7445 7272 6f72 3a0a 2020 2020  mportError:.    
+0001fc40: 2020 2020 2020 2020 2020 2020 7368 6f77              show
+0001fc50: 5f64 6173 6862 6f61 7264 203d 2046 616c  _dashboard = Fal
+0001fc60: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
+0001fc70: 2020 2068 7474 705f 7365 7276 6572 5f6d     http_server_m
+0001fc80: 6f64 756c 6573 2e61 7070 656e 6428 2264  odules.append("d
+0001fc90: 6973 7472 6962 7574 6564 2e68 7474 702e  istributed.http.
+0001fca0: 7363 6865 6475 6c65 722e 6d69 7373 696e  scheduler.missin
+0001fcb0: 675f 626f 6b65 6822 290a 2020 2020 2020  g_bokeh").      
+0001fcc0: 2020 726f 7574 6573 203d 2067 6574 5f68    routes = get_h
+0001fcd0: 616e 646c 6572 7328 0a20 2020 2020 2020  andlers(.       
+0001fce0: 2020 2020 2073 6572 7665 723d 7365 6c66       server=self
+0001fcf0: 2c20 6d6f 6475 6c65 733d 6874 7470 5f73  , modules=http_s
+0001fd00: 6572 7665 725f 6d6f 6475 6c65 732c 2070  erver_modules, p
+0001fd10: 7265 6669 783d 6874 7470 5f70 7265 6669  refix=http_prefi
+0001fd20: 780a 2020 2020 2020 2020 290a 2020 2020  x.        ).    
+0001fd30: 2020 2020 7365 6c66 2e73 7461 7274 5f68      self.start_h
+0001fd40: 7474 705f 7365 7276 6572 2872 6f75 7465  ttp_server(route
+0001fd50: 732c 2064 6173 6862 6f61 7264 5f61 6464  s, dashboard_add
+0001fd60: 7265 7373 2c20 6465 6661 756c 745f 706f  ress, default_po
+0001fd70: 7274 3d38 3738 3729 0a20 2020 2020 2020  rt=8787).       
+0001fd80: 2073 656c 662e 6a75 7079 7465 7220 3d20   self.jupyter = 
+0001fd90: 6a75 7079 7465 720a 2020 2020 2020 2020  jupyter.        
+0001fda0: 6966 2073 686f 775f 6461 7368 626f 6172  if show_dashboar
+0001fdb0: 643a 0a20 2020 2020 2020 2020 2020 2064  d:.            d
+0001fdc0: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
+0001fdd0: 6f61 7264 2e73 6368 6564 756c 6572 2e63  oard.scheduler.c
+0001fde0: 6f6e 6e65 6374 280a 2020 2020 2020 2020  onnect(.        
+0001fdf0: 2020 2020 2020 2020 7365 6c66 2e68 7474          self.htt
+0001fe00: 705f 6170 706c 6963 6174 696f 6e2c 2073  p_application, s
+0001fe10: 656c 662e 6874 7470 5f73 6572 7665 722c  elf.http_server,
+0001fe20: 2073 656c 662c 2070 7265 6669 783d 6874   self, prefix=ht
+0001fe30: 7470 5f70 7265 6669 780a 2020 2020 2020  tp_prefix.      
+0001fe40: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0001fe50: 7363 6865 6475 6c65 7220 3d20 7365 6c66  scheduler = self
+0001fe60: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+0001fe70: 2e6a 7570 7974 6572 3a0a 2020 2020 2020  .jupyter:.      
+0001fe80: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+0001fe90: 2020 2020 2020 2020 2020 2066 726f 6d20             from 
+0001fea0: 6a75 7079 7465 725f 7365 7276 6572 2e73  jupyter_server.s
+0001feb0: 6572 7665 7261 7070 2069 6d70 6f72 7420  erverapp import 
+0001fec0: 5365 7276 6572 4170 700a 2020 2020 2020  ServerApp.      
+0001fed0: 2020 2020 2020 6578 6365 7074 2049 6d70        except Imp
+0001fee0: 6f72 7445 7272 6f72 3a0a 2020 2020 2020  ortError:.      
+0001fef0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0001ff00: 496d 706f 7274 4572 726f 7228 0a20 2020  ImportError(.   
+0001ff10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ff20: 2022 496e 206f 7264 6572 2074 6f20 7573   "In order to us
+0001ff30: 6520 7468 6520 4461 736b 206a 7570 7974  e the Dask jupyt
+0001ff40: 6572 206f 7074 696f 6e20 796f 7520 220a  er option you ".
 0001ff50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ff60: 2022 6e65 6564 2074 6f20 6861 7665 206a   "need to have j
-0001ff70: 7570 7974 6572 6c61 6220 696e 7374 616c  upyterlab instal
-0001ff80: 6c65 6422 0a20 2020 2020 2020 2020 2020  led".           
-0001ff90: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0001ffa0: 2020 2066 726f 6d20 7472 6169 746c 6574     from traitlet
-0001ffb0: 732e 636f 6e66 6967 2069 6d70 6f72 7420  s.config import 
-0001ffc0: 436f 6e66 6967 0a0a 2020 2020 2020 2020  Config..        
-0001ffd0: 2020 2020 2222 2248 5454 5020 6861 6e64      """HTTP hand
-0001ffe0: 6c65 7220 746f 2073 6875 7420 646f 776e  ler to shut down
-0001fff0: 2074 6865 204a 7570 7974 6572 2073 6572   the Jupyter ser
-00020000: 7665 722e 0a20 2020 2020 2020 2020 2020  ver..           
-00020010: 2022 2222 0a20 2020 2020 2020 2020 2020   """.           
-00020020: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00020030: 2020 2020 2020 6672 6f6d 206a 7570 7974        from jupyt
-00020040: 6572 5f73 6572 7665 722e 6175 7468 2069  er_server.auth i
-00020050: 6d70 6f72 7420 6175 7468 6f72 697a 6564  mport authorized
-00020060: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00020070: 6570 7420 496d 706f 7274 4572 726f 723a  ept ImportError:
-00020080: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00020090: 2020 6465 6620 6175 7468 6f72 697a 6564    def authorized
-000200a0: 2863 293a 0a20 2020 2020 2020 2020 2020  (c):.           
-000200b0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-000200c0: 630a 0a20 2020 2020 2020 2020 2020 2066  c..            f
-000200d0: 726f 6d20 6a75 7079 7465 725f 7365 7276  rom jupyter_serv
-000200e0: 6572 2e62 6173 652e 6861 6e64 6c65 7273  er.base.handlers
-000200f0: 2069 6d70 6f72 7420 4a75 7079 7465 7248   import JupyterH
-00020100: 616e 646c 6572 0a0a 2020 2020 2020 2020  andler..        
-00020110: 2020 2020 636c 6173 7320 5368 7574 646f      class Shutdo
-00020120: 776e 4861 6e64 6c65 7228 4a75 7079 7465  wnHandler(Jupyte
-00020130: 7248 616e 646c 6572 293a 0a20 2020 2020  rHandler):.     
-00020140: 2020 2020 2020 2020 2020 2022 2222 4120             """A 
-00020150: 7368 7574 646f 776e 2041 5049 2068 616e  shutdown API han
-00020160: 646c 6572 2e22 2222 0a0a 2020 2020 2020  dler."""..      
-00020170: 2020 2020 2020 2020 2020 6175 7468 5f72            auth_r
-00020180: 6573 6f75 7263 6520 3d20 2273 6572 7665  esource = "serve
-00020190: 7222 0a0a 2020 2020 2020 2020 2020 2020  r"..            
-000201a0: 2020 2020 4074 6f72 6e61 646f 2e77 6562      @tornado.web
-000201b0: 2e61 7574 6865 6e74 6963 6174 6564 0a20  .authenticated. 
-000201c0: 2020 2020 2020 2020 2020 2020 2020 2040                 @
-000201d0: 6175 7468 6f72 697a 6564 0a20 2020 2020  authorized.     
-000201e0: 2020 2020 2020 2020 2020 2061 7379 6e63             async
-000201f0: 2064 6566 2070 6f73 7428 7365 6c66 293a   def post(self):
-00020200: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020210: 2020 2020 2022 2222 5368 7574 2064 6f77       """Shut dow
-00020220: 6e20 7468 6520 7365 7276 6572 2e22 2222  n the server."""
-00020230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020240: 2020 2020 2073 656c 662e 6c6f 672e 696e       self.log.in
-00020250: 666f 2822 5368 7574 7469 6e67 2064 6f77  fo("Shutting dow
-00020260: 6e20 6f6e 202f 6170 692f 7368 7574 646f  n on /api/shutdo
-00020270: 776e 2072 6571 7565 7374 2e22 290a 0a20  wn request.").. 
-00020280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020290: 2020 2061 7761 6974 2073 6368 6564 756c     await schedul
-000202a0: 6572 2e63 6c6f 7365 2872 6561 736f 6e3d  er.close(reason=
-000202b0: 2273 6875 7464 6f77 6e20 7265 7175 6573  "shutdown reques
-000202c0: 7465 6420 7669 6120 4a75 7079 7465 7222  ted via Jupyter"
-000202d0: 290a 0a20 2020 2020 2020 2020 2020 206a  )..            j
-000202e0: 203d 2053 6572 7665 7241 7070 2e69 6e73   = ServerApp.ins
-000202f0: 7461 6e63 6528 0a20 2020 2020 2020 2020  tance(.         
-00020300: 2020 2020 2020 2063 6f6e 6669 673d 436f         config=Co
-00020310: 6e66 6967 280a 2020 2020 2020 2020 2020  nfig(.          
-00020320: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0001ff60: 2020 2020 226e 6565 6420 746f 2068 6176      "need to hav
+0001ff70: 6520 6a75 7079 7465 726c 6162 2069 6e73  e jupyterlab ins
+0001ff80: 7461 6c6c 6564 220a 2020 2020 2020 2020  talled".        
+0001ff90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001ffa0: 2020 2020 2020 6672 6f6d 2074 7261 6974        from trait
+0001ffb0: 6c65 7473 2e63 6f6e 6669 6720 696d 706f  lets.config impo
+0001ffc0: 7274 2043 6f6e 6669 670a 0a20 2020 2020  rt Config..     
+0001ffd0: 2020 2020 2020 2022 2222 4854 5450 2068         """HTTP h
+0001ffe0: 616e 646c 6572 2074 6f20 7368 7574 2064  andler to shut d
+0001fff0: 6f77 6e20 7468 6520 4a75 7079 7465 7220  own the Jupyter 
+00020000: 7365 7276 6572 2e0a 2020 2020 2020 2020  server..        
+00020010: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00020020: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00020030: 2020 2020 2020 2020 2066 726f 6d20 6a75           from ju
+00020040: 7079 7465 725f 7365 7276 6572 2e61 7574  pyter_server.aut
+00020050: 6820 696d 706f 7274 2061 7574 686f 7269  h import authori
+00020060: 7a65 640a 2020 2020 2020 2020 2020 2020  zed.            
+00020070: 6578 6365 7074 2049 6d70 6f72 7445 7272  except ImportErr
+00020080: 6f72 3a0a 0a20 2020 2020 2020 2020 2020  or:..           
+00020090: 2020 2020 2064 6566 2061 7574 686f 7269       def authori
+000200a0: 7a65 6428 6329 3a0a 2020 2020 2020 2020  zed(c):.        
+000200b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000200c0: 726e 2063 0a0a 2020 2020 2020 2020 2020  rn c..          
+000200d0: 2020 6672 6f6d 206a 7570 7974 6572 5f73    from jupyter_s
+000200e0: 6572 7665 722e 6261 7365 2e68 616e 646c  erver.base.handl
+000200f0: 6572 7320 696d 706f 7274 204a 7570 7974  ers import Jupyt
+00020100: 6572 4861 6e64 6c65 720a 0a20 2020 2020  erHandler..     
+00020110: 2020 2020 2020 2063 6c61 7373 2053 6875         class Shu
+00020120: 7464 6f77 6e48 616e 646c 6572 284a 7570  tdownHandler(Jup
+00020130: 7974 6572 4861 6e64 6c65 7229 3a0a 2020  yterHandler):.  
+00020140: 2020 2020 2020 2020 2020 2020 2020 2222                ""
+00020150: 2241 2073 6875 7464 6f77 6e20 4150 4920  "A shutdown API 
+00020160: 6861 6e64 6c65 722e 2222 220a 0a20 2020  handler."""..   
+00020170: 2020 2020 2020 2020 2020 2020 2061 7574               aut
+00020180: 685f 7265 736f 7572 6365 203d 2022 7365  h_resource = "se
+00020190: 7276 6572 220a 0a20 2020 2020 2020 2020  rver"..         
+000201a0: 2020 2020 2020 2040 746f 726e 6164 6f2e         @tornado.
+000201b0: 7765 622e 6175 7468 656e 7469 6361 7465  web.authenticate
+000201c0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+000201d0: 2020 4061 7574 686f 7269 7a65 640a 2020    @authorized.  
+000201e0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+000201f0: 796e 6320 6465 6620 706f 7374 2873 656c  ync def post(sel
+00020200: 6629 3a0a 2020 2020 2020 2020 2020 2020  f):.            
+00020210: 2020 2020 2020 2020 2222 2253 6875 7420          """Shut 
+00020220: 646f 776e 2074 6865 2073 6572 7665 722e  down the server.
+00020230: 2222 220a 2020 2020 2020 2020 2020 2020  """.            
+00020240: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00020250: 2e69 6e66 6f28 2253 6875 7474 696e 6720  .info("Shutting 
+00020260: 646f 776e 206f 6e20 2f61 7069 2f73 6875  down on /api/shu
+00020270: 7464 6f77 6e20 7265 7175 6573 742e 2229  tdown request.")
+00020280: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00020290: 2020 2020 2020 6177 6169 7420 7363 6865        await sche
+000202a0: 6475 6c65 722e 636c 6f73 6528 7265 6173  duler.close(reas
+000202b0: 6f6e 3d22 7368 7574 646f 776e 2072 6571  on="shutdown req
+000202c0: 7565 7374 6564 2076 6961 204a 7570 7974  uested via Jupyt
+000202d0: 6572 2229 0a0a 2020 2020 2020 2020 2020  er")..          
+000202e0: 2020 6a20 3d20 5365 7276 6572 4170 702e    j = ServerApp.
+000202f0: 696e 7374 616e 6365 280a 2020 2020 2020  instance(.      
+00020300: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00020310: 3d43 6f6e 6669 6728 0a20 2020 2020 2020  =Config(.       
+00020320: 2020 2020 2020 2020 2020 2020 207b 0a20               {. 
 00020330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020340: 2020 2020 2253 6572 7665 7241 7070 223a      "ServerApp":
-00020350: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00020360: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00020370: 6261 7365 5f75 726c 223a 2022 6a75 7079  base_url": "jupy
-00020380: 7465 7222 2c0a 2020 2020 2020 2020 2020  ter",.          
+00020340: 2020 2020 2020 2022 5365 7276 6572 4170         "ServerAp
+00020350: 7022 3a20 7b0a 2020 2020 2020 2020 2020  p": {.          
+00020360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020370: 2020 2262 6173 655f 7572 6c22 3a20 226a    "base_url": "j
+00020380: 7570 7974 6572 222c 0a20 2020 2020 2020  upyter",.       
 00020390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000203a0: 2020 2320 5345 4355 5249 5459 3a20 5765    # SECURITY: We
-000203b0: 2075 7375 616c 6c79 2065 7870 6563 7420   usually expect 
-000203c0: 7468 6520 6461 7368 626f 6172 6420 746f  the dashboard to
-000203d0: 2062 6520 6120 7265 6164 2d6f 6e6c 7920   be a read-only 
-000203e0: 7669 6577 2069 6e74 6f0a 2020 2020 2020  view into.      
+000203a0: 2020 2020 2023 2053 4543 5552 4954 593a       # SECURITY:
+000203b0: 2057 6520 7573 7561 6c6c 7920 6578 7065   We usually expe
+000203c0: 6374 2074 6865 2064 6173 6862 6f61 7264  ct the dashboard
+000203d0: 2074 6f20 6265 2061 2072 6561 642d 6f6e   to be a read-on
+000203e0: 6c79 2076 6965 7720 696e 746f 0a20 2020  ly view into.   
 000203f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020400: 2020 2020 2020 2320 7468 6520 7363 6865        # the sche
-00020410: 6475 6c65 7220 6163 7469 7669 7479 2e20  duler activity. 
-00020420: 486f 7765 7665 722c 2062 7920 6164 6469  However, by addi
-00020430: 6e67 2061 6e20 6f70 656e 204a 7570 7974  ng an open Jupyt
-00020440: 6572 2061 7070 6c69 6361 7469 6f6e 0a20  er application. 
-00020450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020460: 2020 2020 2020 2020 2020 2023 2077 6520             # we 
-00020470: 6172 6520 616c 6c6f 7769 6e67 2061 7262  are allowing arb
-00020480: 6974 7261 7279 2072 656d 6f74 6520 636f  itrary remote co
-00020490: 6465 2065 7865 6375 7469 6f6e 206f 6e20  de execution on 
-000204a0: 7468 6520 7363 6865 6475 6c65 7220 7669  the scheduler vi
-000204b0: 6120 7468 650a 2020 2020 2020 2020 2020  a the.          
+00020400: 2020 2020 2020 2020 2023 2074 6865 2073           # the s
+00020410: 6368 6564 756c 6572 2061 6374 6976 6974  cheduler activit
+00020420: 792e 2048 6f77 6576 6572 2c20 6279 2061  y. However, by a
+00020430: 6464 696e 6720 616e 206f 7065 6e20 4a75  dding an open Ju
+00020440: 7079 7465 7220 6170 706c 6963 6174 696f  pyter applicatio
+00020450: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
+00020460: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00020470: 7765 2061 7265 2061 6c6c 6f77 696e 6720  we are allowing 
+00020480: 6172 6269 7472 6172 7920 7265 6d6f 7465  arbitrary remote
+00020490: 2063 6f64 6520 6578 6563 7574 696f 6e20   code execution 
+000204a0: 6f6e 2074 6865 2073 6368 6564 756c 6572  on the scheduler
+000204b0: 2076 6961 2074 6865 0a20 2020 2020 2020   via the.       
 000204c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000204d0: 2020 2320 6461 7368 626f 6172 6420 7365    # dashboard se
-000204e0: 7276 6572 2e20 5468 6973 206f 7074 696f  rver. This optio
-000204f0: 6e20 7368 6f75 6c64 206f 6e6c 7920 6265  n should only be
-00020500: 2075 7365 6420 7768 656e 2074 6865 2064   used when the d
-00020510: 6173 6862 6f61 7264 2069 730a 2020 2020  ashboard is.    
+000204d0: 2020 2020 2023 2064 6173 6862 6f61 7264       # dashboard
+000204e0: 2073 6572 7665 722e 2054 6869 7320 6f70   server. This op
+000204f0: 7469 6f6e 2073 686f 756c 6420 6f6e 6c79  tion should only
+00020500: 2062 6520 7573 6564 2077 6865 6e20 7468   be used when th
+00020510: 6520 6461 7368 626f 6172 6420 6973 0a20  e dashboard is. 
 00020520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020530: 2020 2020 2020 2020 2320 7072 6f74 6563          # protec
-00020540: 7465 6420 7669 6120 6f74 6865 7220 6d65  ted via other me
-00020550: 616e 732c 206f 7220 7768 656e 2079 6f75  ans, or when you
-00020560: 2064 6f6e 2774 2063 6172 6520 6162 6f75   don't care abou
-00020570: 7420 636c 7573 7465 7220 7365 6375 7269  t cluster securi
-00020580: 7479 2e0a 2020 2020 2020 2020 2020 2020  ty..            
+00020530: 2020 2020 2020 2020 2020 2023 2070 726f             # pro
+00020540: 7465 6374 6564 2076 6961 206f 7468 6572  tected via other
+00020550: 206d 6561 6e73 2c20 6f72 2077 6865 6e20   means, or when 
+00020560: 796f 7520 646f 6e27 7420 6361 7265 2061  you don't care a
+00020570: 626f 7574 2063 6c75 7374 6572 2073 6563  bout cluster sec
+00020580: 7572 6974 792e 0a20 2020 2020 2020 2020  urity..         
 00020590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000205a0: 2274 6f6b 656e 223a 2022 222c 0a20 2020  "token": "",.   
+000205a0: 2020 2022 746f 6b65 6e22 3a20 2222 2c0a     "token": "",.
 000205b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000205c0: 2020 2020 2020 2020 2022 616c 6c6f 775f           "allow_
-000205d0: 7265 6d6f 7465 5f61 6363 6573 7322 3a20  remote_access": 
-000205e0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-000205f0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00020600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020610: 2020 2020 7d0a 2020 2020 2020 2020 2020      }.          
-00020620: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00020630: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00020640: 2020 6a2e 696e 6974 6961 6c69 7a65 280a    j.initialize(.
-00020650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020660: 6e65 775f 6874 7470 7365 7276 6572 3d46  new_httpserver=F
-00020670: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
-00020680: 2020 2020 2020 6172 6776 3d5b 5d2c 0a20        argv=[],. 
-00020690: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000206a0: 2020 2020 2020 2020 2073 656c 662e 5f6a           self._j
-000206b0: 7570 7974 6572 5f73 6572 7665 725f 6170  upyter_server_ap
-000206c0: 706c 6963 6174 696f 6e20 3d20 6a0a 2020  plication = j.  
-000206d0: 2020 2020 2020 2020 2020 7368 7574 646f            shutdo
-000206e0: 776e 5f61 7070 203d 2074 6f72 6e61 646f  wn_app = tornado
-000206f0: 2e77 6562 2e41 7070 6c69 6361 7469 6f6e  .web.Application
-00020700: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00020710: 2020 5b28 7222 2f6a 7570 7974 6572 2f61    [(r"/jupyter/a
-00020720: 7069 2f73 6875 7464 6f77 6e22 2c20 5368  pi/shutdown", Sh
-00020730: 7574 646f 776e 4861 6e64 6c65 7229 5d0a  utdownHandler)].
-00020740: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00020750: 2020 2020 2020 2020 2020 7368 7574 646f            shutdo
-00020760: 776e 5f61 7070 2e73 6574 7469 6e67 7320  wn_app.settings 
-00020770: 3d20 6a2e 7765 625f 6170 702e 7365 7474  = j.web_app.sett
-00020780: 696e 6773 0a20 2020 2020 2020 2020 2020  ings.           
-00020790: 2073 656c 662e 6874 7470 5f61 7070 6c69   self.http_appli
-000207a0: 6361 7469 6f6e 2e61 6464 5f61 7070 6c69  cation.add_appli
-000207b0: 6361 7469 6f6e 2873 6875 7464 6f77 6e5f  cation(shutdown_
-000207c0: 6170 7029 0a20 2020 2020 2020 2020 2020  app).           
-000207d0: 2073 656c 662e 6874 7470 5f61 7070 6c69   self.http_appli
-000207e0: 6361 7469 6f6e 2e61 6464 5f61 7070 6c69  cation.add_appli
-000207f0: 6361 7469 6f6e 286a 2e77 6562 5f61 7070  cation(j.web_app
-00020800: 290a 0a20 2020 2020 2020 2023 2043 6f6d  )..        # Com
-00020810: 6d75 6e69 6361 7469 6f6e 2073 7461 7465  munication state
-00020820: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
-00020830: 6965 6e74 5f63 6f6d 6d73 203d 207b 7d0a  ient_comms = {}.
-00020840: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
-00020850: 6561 6d5f 636f 6d6d 7320 3d20 7b7d 0a0a  eam_comms = {}..
-00020860: 2020 2020 2020 2020 2320 5461 736b 2073          # Task s
-00020870: 7461 7465 0a20 2020 2020 2020 2074 6173  tate.        tas
-00020880: 6b73 203d 207b 7d0a 0a20 2020 2020 2020  ks = {}..       
-00020890: 2073 656c 662e 6765 6e65 7261 7469 6f6e   self.generation
-000208a0: 203d 2030 0a20 2020 2020 2020 2073 656c   = 0.        sel
-000208b0: 662e 5f6c 6173 745f 636c 6965 6e74 203d  f._last_client =
-000208c0: 204e 6f6e 650a 2020 2020 2020 2020 7365   None.        se
-000208d0: 6c66 2e5f 6c61 7374 5f74 696d 6520 3d20  lf._last_time = 
-000208e0: 300a 2020 2020 2020 2020 756e 7275 6e6e  0.        unrunn
-000208f0: 6162 6c65 203d 2073 6574 2829 0a20 2020  able = set().   
-00020900: 2020 2020 2071 7565 7565 6420 3d20 4865       queued = He
-00020910: 6170 5365 7428 6b65 793d 6f70 6572 6174  apSet(key=operat
-00020920: 6f72 2e61 7474 7267 6574 7465 7228 2270  or.attrgetter("p
-00020930: 7269 6f72 6974 7922 2929 0a0a 2020 2020  riority"))..    
-00020940: 2020 2020 7365 6c66 2e64 6174 6173 6574      self.dataset
-00020950: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-00020960: 2320 5072 6566 6978 2d6b 6579 6564 2063  # Prefix-keyed c
-00020970: 6f6e 7461 696e 6572 730a 0a20 2020 2020  ontainers..     
-00020980: 2020 2023 2043 6c69 656e 7420 7374 6174     # Client stat
-00020990: 650a 2020 2020 2020 2020 636c 6965 6e74  e.        client
-000209a0: 7320 3d20 7b7d 0a0a 2020 2020 2020 2020  s = {}..        
-000209b0: 2320 576f 726b 6572 2073 7461 7465 0a20  # Worker state. 
-000209c0: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-000209d0: 2053 6f72 7465 6444 6963 7428 290a 0a20   SortedDict().. 
-000209e0: 2020 2020 2020 2068 6f73 745f 696e 666f         host_info
-000209f0: 203d 207b 7d0a 2020 2020 2020 2020 7265   = {}.        re
-00020a00: 736f 7572 6365 7320 3d20 7b7d 0a20 2020  sources = {}.   
-00020a10: 2020 2020 2061 6c69 6173 6573 203d 207b       aliases = {
-00020a20: 7d0a 0a20 2020 2020 2020 2073 656c 662e  }..        self.
-00020a30: 5f77 6f72 6b65 725f 636f 6c6c 6563 7469  _worker_collecti
-00020a40: 6f6e 7320 3d20 5b0a 2020 2020 2020 2020  ons = [.        
-00020a50: 2020 2020 776f 726b 6572 732c 0a20 2020      workers,.   
-00020a60: 2020 2020 2020 2020 2068 6f73 745f 696e           host_in
-00020a70: 666f 2c0a 2020 2020 2020 2020 2020 2020  fo,.            
-00020a80: 7265 736f 7572 6365 732c 0a20 2020 2020  resources,.     
-00020a90: 2020 2020 2020 2061 6c69 6173 6573 2c0a         aliases,.
-00020aa0: 2020 2020 2020 2020 5d0a 0a20 2020 2020          ]..     
-00020ab0: 2020 206d 6178 6c65 6e20 3d20 6461 736b     maxlen = dask
-00020ac0: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-00020ad0: 7472 6962 7574 6564 2e61 646d 696e 2e6c  tributed.admin.l
-00020ae0: 6f77 2d6c 6576 656c 2d6c 6f67 2d6c 656e  ow-level-log-len
-00020af0: 6774 6822 290a 2020 2020 2020 2020 7365  gth").        se
-00020b00: 6c66 2e65 7665 6e74 7320 3d20 6465 6661  lf.events = defa
-00020b10: 756c 7464 6963 7428 7061 7274 6961 6c28  ultdict(partial(
-00020b20: 6465 7175 652c 206d 6178 6c65 6e3d 6d61  deque, maxlen=ma
-00020b30: 786c 656e 2929 0a20 2020 2020 2020 2073  xlen)).        s
-00020b40: 656c 662e 6576 656e 745f 636f 756e 7473  elf.event_counts
-00020b50: 203d 2064 6566 6175 6c74 6469 6374 2869   = defaultdict(i
-00020b60: 6e74 290a 2020 2020 2020 2020 7365 6c66  nt).        self
-00020b70: 2e65 7665 6e74 5f73 7562 7363 7269 6265  .event_subscribe
-00020b80: 7220 3d20 6465 6661 756c 7464 6963 7428  r = defaultdict(
-00020b90: 7365 7429 0a20 2020 2020 2020 2073 656c  set).        sel
-00020ba0: 662e 776f 726b 6572 5f70 6c75 6769 6e73  f.worker_plugins
-00020bb0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-00020bc0: 6c66 2e6e 616e 6e79 5f70 6c75 6769 6e73  lf.nanny_plugins
-00020bd0: 203d 207b 7d0a 2020 2020 2020 2020 7365   = {}.        se
-00020be0: 6c66 2e5f 7374 6172 7469 6e67 5f6e 616e  lf._starting_nan
-00020bf0: 6e69 6573 203d 2073 6574 2829 0a20 2020  nies = set().   
-00020c00: 2020 2020 2073 656c 662e 5f73 7461 7274       self._start
-00020c10: 696e 675f 6e61 6e6e 6965 735f 636f 6e64  ing_nannies_cond
-00020c20: 203d 2061 7379 6e63 696f 2e43 6f6e 6469   = asyncio.Condi
-00020c30: 7469 6f6e 2829 0a0a 2020 2020 2020 2020  tion()..        
-00020c40: 776f 726b 6572 5f68 616e 646c 6572 7320  worker_handlers 
-00020c50: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00020c60: 2274 6173 6b2d 6669 6e69 7368 6564 223a  "task-finished":
-00020c70: 2073 656c 662e 6861 6e64 6c65 5f74 6173   self.handle_tas
-00020c80: 6b5f 6669 6e69 7368 6564 2c0a 2020 2020  k_finished,.    
-00020c90: 2020 2020 2020 2020 2274 6173 6b2d 6572          "task-er
-00020ca0: 7265 6422 3a20 7365 6c66 2e68 616e 646c  red": self.handl
-00020cb0: 655f 7461 736b 5f65 7272 6564 2c0a 2020  e_task_erred,.  
-00020cc0: 2020 2020 2020 2020 2020 2272 656c 6561            "relea
-00020cd0: 7365 2d77 6f72 6b65 722d 6461 7461 223a  se-worker-data":
-00020ce0: 2073 656c 662e 7265 6c65 6173 655f 776f   self.release_wo
-00020cf0: 726b 6572 5f64 6174 612c 0a20 2020 2020  rker_data,.     
-00020d00: 2020 2020 2020 2022 6164 642d 6b65 7973         "add-keys
-00020d10: 223a 2073 656c 662e 6164 645f 6b65 7973  ": self.add_keys
-00020d20: 2c0a 2020 2020 2020 2020 2020 2020 226c  ,.            "l
-00020d30: 6f6e 672d 7275 6e6e 696e 6722 3a20 7365  ong-running": se
-00020d40: 6c66 2e68 616e 646c 655f 6c6f 6e67 5f72  lf.handle_long_r
-00020d50: 756e 6e69 6e67 2c0a 2020 2020 2020 2020  unning,.        
-00020d60: 2020 2020 2272 6573 6368 6564 756c 6522      "reschedule"
-00020d70: 3a20 7365 6c66 2e5f 7265 7363 6865 6475  : self._reschedu
-00020d80: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
-00020d90: 226b 6565 702d 616c 6976 6522 3a20 6c61  "keep-alive": la
-00020da0: 6d62 6461 202a 6172 6773 2c20 2a2a 6b77  mbda *args, **kw
-00020db0: 6172 6773 3a20 4e6f 6e65 2c0a 2020 2020  args: None,.    
-00020dc0: 2020 2020 2020 2020 226c 6f67 2d65 7665          "log-eve
-00020dd0: 6e74 223a 2073 656c 662e 6c6f 675f 776f  nt": self.log_wo
-00020de0: 726b 6572 5f65 7665 6e74 2c0a 2020 2020  rker_event,.    
-00020df0: 2020 2020 2020 2020 2277 6f72 6b65 722d          "worker-
-00020e00: 7374 6174 7573 2d63 6861 6e67 6522 3a20  status-change": 
-00020e10: 7365 6c66 2e68 616e 646c 655f 776f 726b  self.handle_work
-00020e20: 6572 5f73 7461 7475 735f 6368 616e 6765  er_status_change
-00020e30: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
-00020e40: 6571 7565 7374 2d72 6566 7265 7368 2d77  equest-refresh-w
-00020e50: 686f 2d68 6173 223a 2073 656c 662e 6861  ho-has": self.ha
-00020e60: 6e64 6c65 5f72 6571 7565 7374 5f72 6566  ndle_request_ref
-00020e70: 7265 7368 5f77 686f 5f68 6173 2c0a 2020  resh_who_has,.  
-00020e80: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
-00020e90: 2063 6c69 656e 745f 6861 6e64 6c65 7273   client_handlers
-00020ea0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00020eb0: 2022 7570 6461 7465 2d67 7261 7068 223a   "update-graph":
-00020ec0: 2073 656c 662e 7570 6461 7465 5f67 7261   self.update_gra
-00020ed0: 7068 2c0a 2020 2020 2020 2020 2020 2020  ph,.            
-00020ee0: 2263 6c69 656e 742d 6465 7369 7265 732d  "client-desires-
-00020ef0: 6b65 7973 223a 2073 656c 662e 636c 6965  keys": self.clie
-00020f00: 6e74 5f64 6573 6972 6573 5f6b 6579 732c  nt_desires_keys,
-00020f10: 0a20 2020 2020 2020 2020 2020 2022 7570  .            "up
-00020f20: 6461 7465 2d64 6174 6122 3a20 7365 6c66  date-data": self
-00020f30: 2e75 7064 6174 655f 6461 7461 2c0a 2020  .update_data,.  
-00020f40: 2020 2020 2020 2020 2020 2272 6570 6f72            "repor
-00020f50: 742d 6b65 7922 3a20 7365 6c66 2e72 6570  t-key": self.rep
-00020f60: 6f72 745f 6f6e 5f6b 6579 2c0a 2020 2020  ort_on_key,.    
-00020f70: 2020 2020 2020 2020 2263 6c69 656e 742d          "client-
-00020f80: 7265 6c65 6173 6573 2d6b 6579 7322 3a20  releases-keys": 
-00020f90: 7365 6c66 2e63 6c69 656e 745f 7265 6c65  self.client_rele
-00020fa0: 6173 6573 5f6b 6579 732c 0a20 2020 2020  ases_keys,.     
-00020fb0: 2020 2020 2020 2022 6865 6172 7462 6561         "heartbea
-00020fc0: 742d 636c 6965 6e74 223a 2073 656c 662e  t-client": self.
-00020fd0: 636c 6965 6e74 5f68 6561 7274 6265 6174  client_heartbeat
-00020fe0: 2c0a 2020 2020 2020 2020 2020 2020 2263  ,.            "c
-00020ff0: 6c6f 7365 2d63 6c69 656e 7422 3a20 7365  lose-client": se
-00021000: 6c66 2e72 656d 6f76 655f 636c 6965 6e74  lf.remove_client
-00021010: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-00021020: 7562 7363 7269 6265 2d74 6f70 6963 223a  ubscribe-topic":
-00021030: 2073 656c 662e 7375 6273 6372 6962 655f   self.subscribe_
-00021040: 746f 7069 632c 0a20 2020 2020 2020 2020  topic,.         
-00021050: 2020 2022 756e 7375 6273 6372 6962 652d     "unsubscribe-
-00021060: 746f 7069 6322 3a20 7365 6c66 2e75 6e73  topic": self.uns
-00021070: 7562 7363 7269 6265 5f74 6f70 6963 2c0a  ubscribe_topic,.
-00021080: 2020 2020 2020 2020 2020 2020 2263 616e              "can
-00021090: 6365 6c2d 6b65 7973 223a 2073 656c 662e  cel-keys": self.
-000210a0: 7374 696d 756c 7573 5f63 616e 6365 6c2c  stimulus_cancel,
-000210b0: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
-000210c0: 2020 2020 7365 6c66 2e68 616e 646c 6572      self.handler
-000210d0: 7320 3d20 7b0a 2020 2020 2020 2020 2020  s = {.          
-000210e0: 2020 2272 6567 6973 7465 722d 636c 6965    "register-clie
-000210f0: 6e74 223a 2073 656c 662e 6164 645f 636c  nt": self.add_cl
-00021100: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
-00021110: 2020 2273 6361 7474 6572 223a 2073 656c    "scatter": sel
-00021120: 662e 7363 6174 7465 722c 0a20 2020 2020  f.scatter,.     
-00021130: 2020 2020 2020 2022 7265 6769 7374 6572         "register
-00021140: 2d77 6f72 6b65 7222 3a20 7365 6c66 2e61  -worker": self.a
-00021150: 6464 5f77 6f72 6b65 722c 0a20 2020 2020  dd_worker,.     
-00021160: 2020 2020 2020 2022 7265 6769 7374 6572         "register
-00021170: 5f6e 616e 6e79 223a 2073 656c 662e 6164  _nanny": self.ad
-00021180: 645f 6e61 6e6e 792c 0a20 2020 2020 2020  d_nanny,.       
-00021190: 2020 2020 2022 756e 7265 6769 7374 6572       "unregister
-000211a0: 223a 2073 656c 662e 7265 6d6f 7665 5f77  ": self.remove_w
-000211b0: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
-000211c0: 2020 2022 6761 7468 6572 223a 2073 656c     "gather": sel
-000211d0: 662e 6761 7468 6572 2c0a 2020 2020 2020  f.gather,.      
-000211e0: 2020 2020 2020 2272 6574 7279 223a 2073        "retry": s
-000211f0: 656c 662e 7374 696d 756c 7573 5f72 6574  elf.stimulus_ret
-00021200: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
-00021210: 2266 6565 6422 3a20 7365 6c66 2e66 6565  "feed": self.fee
-00021220: 642c 0a20 2020 2020 2020 2020 2020 2022  d,.            "
-00021230: 7465 726d 696e 6174 6522 3a20 7365 6c66  terminate": self
-00021240: 2e63 6c6f 7365 2c0a 2020 2020 2020 2020  .close,.        
-00021250: 2020 2020 2262 726f 6164 6361 7374 223a      "broadcast":
-00021260: 2073 656c 662e 6272 6f61 6463 6173 742c   self.broadcast,
-00021270: 0a20 2020 2020 2020 2020 2020 2022 7072  .            "pr
-00021280: 6f78 7922 3a20 7365 6c66 2e70 726f 7879  oxy": self.proxy
-00021290: 2c0a 2020 2020 2020 2020 2020 2020 226e  ,.            "n
-000212a0: 636f 7265 7322 3a20 7365 6c66 2e67 6574  cores": self.get
-000212b0: 5f6e 636f 7265 732c 0a20 2020 2020 2020  _ncores,.       
-000212c0: 2020 2020 2022 6e63 6f72 6573 5f72 756e       "ncores_run
-000212d0: 6e69 6e67 223a 2073 656c 662e 6765 745f  ning": self.get_
-000212e0: 6e63 6f72 6573 5f72 756e 6e69 6e67 2c0a  ncores_running,.
-000212f0: 2020 2020 2020 2020 2020 2020 2268 6173              "has
-00021300: 5f77 6861 7422 3a20 7365 6c66 2e67 6574  _what": self.get
-00021310: 5f68 6173 5f77 6861 742c 0a20 2020 2020  _has_what,.     
-00021320: 2020 2020 2020 2022 7768 6f5f 6861 7322         "who_has"
-00021330: 3a20 7365 6c66 2e67 6574 5f77 686f 5f68  : self.get_who_h
-00021340: 6173 2c0a 2020 2020 2020 2020 2020 2020  as,.            
-00021350: 2270 726f 6365 7373 696e 6722 3a20 7365  "processing": se
-00021360: 6c66 2e67 6574 5f70 726f 6365 7373 696e  lf.get_processin
-00021370: 672c 0a20 2020 2020 2020 2020 2020 2022  g,.            "
-00021380: 6361 6c6c 5f73 7461 636b 223a 2073 656c  call_stack": sel
-00021390: 662e 6765 745f 6361 6c6c 5f73 7461 636b  f.get_call_stack
-000213a0: 2c0a 2020 2020 2020 2020 2020 2020 2270  ,.            "p
-000213b0: 726f 6669 6c65 223a 2073 656c 662e 6765  rofile": self.ge
-000213c0: 745f 7072 6f66 696c 652c 0a20 2020 2020  t_profile,.     
-000213d0: 2020 2020 2020 2022 7065 7266 6f72 6d61         "performa
-000213e0: 6e63 655f 7265 706f 7274 223a 2073 656c  nce_report": sel
-000213f0: 662e 7065 7266 6f72 6d61 6e63 655f 7265  f.performance_re
-00021400: 706f 7274 2c0a 2020 2020 2020 2020 2020  port,.          
-00021410: 2020 2267 6574 5f6c 6f67 7322 3a20 7365    "get_logs": se
-00021420: 6c66 2e67 6574 5f6c 6f67 732c 0a20 2020  lf.get_logs,.   
-00021430: 2020 2020 2020 2020 2022 6c6f 6773 223a           "logs":
-00021440: 2073 656c 662e 6765 745f 6c6f 6773 2c0a   self.get_logs,.
-00021450: 2020 2020 2020 2020 2020 2020 2277 6f72              "wor
-00021460: 6b65 725f 6c6f 6773 223a 2073 656c 662e  ker_logs": self.
-00021470: 6765 745f 776f 726b 6572 5f6c 6f67 732c  get_worker_logs,
-00021480: 0a20 2020 2020 2020 2020 2020 2022 6c6f  .            "lo
-00021490: 675f 6576 656e 7422 3a20 7365 6c66 2e6c  g_event": self.l
-000214a0: 6f67 5f65 7665 6e74 2c0a 2020 2020 2020  og_event,.      
-000214b0: 2020 2020 2020 2265 7665 6e74 7322 3a20        "events": 
-000214c0: 7365 6c66 2e67 6574 5f65 7665 6e74 732c  self.get_events,
-000214d0: 0a20 2020 2020 2020 2020 2020 2022 6e62  .            "nb
-000214e0: 7974 6573 223a 2073 656c 662e 6765 745f  ytes": self.get_
-000214f0: 6e62 7974 6573 2c0a 2020 2020 2020 2020  nbytes,.        
-00021500: 2020 2020 2276 6572 7369 6f6e 7322 3a20      "versions": 
-00021510: 7365 6c66 2e76 6572 7369 6f6e 732c 0a20  self.versions,. 
-00021520: 2020 2020 2020 2020 2020 2022 6164 645f             "add_
-00021530: 6b65 7973 223a 2073 656c 662e 6164 645f  keys": self.add_
-00021540: 6b65 7973 2c0a 2020 2020 2020 2020 2020  keys,.          
-00021550: 2020 2272 6562 616c 616e 6365 223a 2073    "rebalance": s
-00021560: 656c 662e 7265 6261 6c61 6e63 652c 0a20  elf.rebalance,. 
-00021570: 2020 2020 2020 2020 2020 2022 7265 706c             "repl
-00021580: 6963 6174 6522 3a20 7365 6c66 2e72 6570  icate": self.rep
-00021590: 6c69 6361 7465 2c0a 2020 2020 2020 2020  licate,.        
-000215a0: 2020 2020 2272 756e 5f66 756e 6374 696f      "run_functio
-000215b0: 6e22 3a20 7365 6c66 2e72 756e 5f66 756e  n": self.run_fun
-000215c0: 6374 696f 6e2c 0a20 2020 2020 2020 2020  ction,.         
-000215d0: 2020 2022 7265 7374 6172 7422 3a20 7365     "restart": se
-000215e0: 6c66 2e72 6573 7461 7274 2c0a 2020 2020  lf.restart,.    
-000215f0: 2020 2020 2020 2020 2275 7064 6174 655f          "update_
-00021600: 6461 7461 223a 2073 656c 662e 7570 6461  data": self.upda
-00021610: 7465 5f64 6174 612c 0a20 2020 2020 2020  te_data,.       
-00021620: 2020 2020 2022 7365 745f 7265 736f 7572       "set_resour
-00021630: 6365 7322 3a20 7365 6c66 2e61 6464 5f72  ces": self.add_r
-00021640: 6573 6f75 7263 6573 2c0a 2020 2020 2020  esources,.      
-00021650: 2020 2020 2020 2272 6574 6972 655f 776f        "retire_wo
-00021660: 726b 6572 7322 3a20 7365 6c66 2e72 6574  rkers": self.ret
-00021670: 6972 655f 776f 726b 6572 732c 0a20 2020  ire_workers,.   
-00021680: 2020 2020 2020 2020 2022 6765 745f 6d65           "get_me
-00021690: 7461 6461 7461 223a 2073 656c 662e 6765  tadata": self.ge
-000216a0: 745f 6d65 7461 6461 7461 2c0a 2020 2020  t_metadata,.    
-000216b0: 2020 2020 2020 2020 2273 6574 5f6d 6574          "set_met
-000216c0: 6164 6174 6122 3a20 7365 6c66 2e73 6574  adata": self.set
-000216d0: 5f6d 6574 6164 6174 612c 0a20 2020 2020  _metadata,.     
-000216e0: 2020 2020 2020 2022 7365 745f 7265 7374         "set_rest
-000216f0: 7269 6374 696f 6e73 223a 2073 656c 662e  rictions": self.
-00021700: 7365 745f 7265 7374 7269 6374 696f 6e73  set_restrictions
-00021710: 2c0a 2020 2020 2020 2020 2020 2020 2268  ,.            "h
-00021720: 6561 7274 6265 6174 5f77 6f72 6b65 7222  eartbeat_worker"
-00021730: 3a20 7365 6c66 2e68 6561 7274 6265 6174  : self.heartbeat
-00021740: 5f77 6f72 6b65 722c 0a20 2020 2020 2020  _worker,.       
-00021750: 2020 2020 2022 6765 745f 7461 736b 5f73       "get_task_s
-00021760: 7461 7475 7322 3a20 7365 6c66 2e67 6574  tatus": self.get
-00021770: 5f74 6173 6b5f 7374 6174 7573 2c0a 2020  _task_status,.  
-00021780: 2020 2020 2020 2020 2020 2267 6574 5f74            "get_t
-00021790: 6173 6b5f 7374 7265 616d 223a 2073 656c  ask_stream": sel
-000217a0: 662e 6765 745f 7461 736b 5f73 7472 6561  f.get_task_strea
-000217b0: 6d2c 0a20 2020 2020 2020 2020 2020 2022  m,.            "
-000217c0: 6765 745f 7461 736b 5f70 7265 6669 785f  get_task_prefix_
-000217d0: 7374 6174 6573 223a 2073 656c 662e 6765  states": self.ge
-000217e0: 745f 7461 736b 5f70 7265 6669 785f 7374  t_task_prefix_st
-000217f0: 6174 6573 2c0a 2020 2020 2020 2020 2020  ates,.          
-00021800: 2020 2272 6567 6973 7465 725f 7363 6865    "register_sche
-00021810: 6475 6c65 725f 706c 7567 696e 223a 2073  duler_plugin": s
-00021820: 656c 662e 7265 6769 7374 6572 5f73 6368  elf.register_sch
-00021830: 6564 756c 6572 5f70 6c75 6769 6e2c 0a20  eduler_plugin,. 
-00021840: 2020 2020 2020 2020 2020 2022 756e 7265             "unre
-00021850: 6769 7374 6572 5f73 6368 6564 756c 6572  gister_scheduler
-00021860: 5f70 6c75 6769 6e22 3a20 7365 6c66 2e75  _plugin": self.u
-00021870: 6e72 6567 6973 7465 725f 7363 6865 6475  nregister_schedu
-00021880: 6c65 725f 706c 7567 696e 2c0a 2020 2020  ler_plugin,.    
-00021890: 2020 2020 2020 2020 2272 6567 6973 7465          "registe
-000218a0: 725f 776f 726b 6572 5f70 6c75 6769 6e22  r_worker_plugin"
-000218b0: 3a20 7365 6c66 2e72 6567 6973 7465 725f  : self.register_
-000218c0: 776f 726b 6572 5f70 6c75 6769 6e2c 0a20  worker_plugin,. 
-000218d0: 2020 2020 2020 2020 2020 2022 756e 7265             "unre
-000218e0: 6769 7374 6572 5f77 6f72 6b65 725f 706c  gister_worker_pl
-000218f0: 7567 696e 223a 2073 656c 662e 756e 7265  ugin": self.unre
-00021900: 6769 7374 6572 5f77 6f72 6b65 725f 706c  gister_worker_pl
-00021910: 7567 696e 2c0a 2020 2020 2020 2020 2020  ugin,.          
-00021920: 2020 2272 6567 6973 7465 725f 6e61 6e6e    "register_nann
-00021930: 795f 706c 7567 696e 223a 2073 656c 662e  y_plugin": self.
-00021940: 7265 6769 7374 6572 5f6e 616e 6e79 5f70  register_nanny_p
-00021950: 6c75 6769 6e2c 0a20 2020 2020 2020 2020  lugin,.         
-00021960: 2020 2022 756e 7265 6769 7374 6572 5f6e     "unregister_n
-00021970: 616e 6e79 5f70 6c75 6769 6e22 3a20 7365  anny_plugin": se
-00021980: 6c66 2e75 6e72 6567 6973 7465 725f 6e61  lf.unregister_na
-00021990: 6e6e 795f 706c 7567 696e 2c0a 2020 2020  nny_plugin,.    
-000219a0: 2020 2020 2020 2020 2261 6461 7074 6976          "adaptiv
-000219b0: 655f 7461 7267 6574 223a 2073 656c 662e  e_target": self.
-000219c0: 6164 6170 7469 7665 5f74 6172 6765 742c  adaptive_target,
-000219d0: 0a20 2020 2020 2020 2020 2020 2022 776f  .            "wo
-000219e0: 726b 6572 735f 746f 5f63 6c6f 7365 223a  rkers_to_close":
-000219f0: 2073 656c 662e 776f 726b 6572 735f 746f   self.workers_to
-00021a00: 5f63 6c6f 7365 2c0a 2020 2020 2020 2020  _close,.        
-00021a10: 2020 2020 2273 7562 7363 7269 6265 5f77      "subscribe_w
-00021a20: 6f72 6b65 725f 7374 6174 7573 223a 2073  orker_status": s
-00021a30: 656c 662e 7375 6273 6372 6962 655f 776f  elf.subscribe_wo
-00021a40: 726b 6572 5f73 7461 7475 732c 0a20 2020  rker_status,.   
-00021a50: 2020 2020 2020 2020 2022 7374 6172 745f           "start_
-00021a60: 7461 736b 5f6d 6574 6164 6174 6122 3a20  task_metadata": 
-00021a70: 7365 6c66 2e73 7461 7274 5f74 6173 6b5f  self.start_task_
-00021a80: 6d65 7461 6461 7461 2c0a 2020 2020 2020  metadata,.      
-00021a90: 2020 2020 2020 2273 746f 705f 7461 736b        "stop_task
-00021aa0: 5f6d 6574 6164 6174 6122 3a20 7365 6c66  _metadata": self
-00021ab0: 2e73 746f 705f 7461 736b 5f6d 6574 6164  .stop_task_metad
-00021ac0: 6174 612c 0a20 2020 2020 2020 2020 2020  ata,.           
-00021ad0: 2022 6765 745f 636c 7573 7465 725f 7374   "get_cluster_st
-00021ae0: 6174 6522 3a20 7365 6c66 2e67 6574 5f63  ate": self.get_c
-00021af0: 6c75 7374 6572 5f73 7461 7465 2c0a 2020  luster_state,.  
-00021b00: 2020 2020 2020 2020 2020 2264 756d 705f            "dump_
-00021b10: 636c 7573 7465 725f 7374 6174 655f 746f  cluster_state_to
-00021b20: 5f75 726c 223a 2073 656c 662e 6475 6d70  _url": self.dump
-00021b30: 5f63 6c75 7374 6572 5f73 7461 7465 5f74  _cluster_state_t
-00021b40: 6f5f 7572 6c2c 0a20 2020 2020 2020 2020  o_url,.         
-00021b50: 2020 2022 6265 6e63 686d 6172 6b5f 6861     "benchmark_ha
-00021b60: 7264 7761 7265 223a 2073 656c 662e 6265  rdware": self.be
-00021b70: 6e63 686d 6172 6b5f 6861 7264 7761 7265  nchmark_hardware
-00021b80: 2c0a 2020 2020 2020 2020 2020 2020 2267  ,.            "g
-00021b90: 6574 5f73 746f 7279 223a 2073 656c 662e  et_story": self.
-00021ba0: 6765 745f 7374 6f72 792c 0a20 2020 2020  get_story,.     
-00021bb0: 2020 2020 2020 2022 6368 6563 6b5f 6964         "check_id
-00021bc0: 6c65 223a 2073 656c 662e 6368 6563 6b5f  le": self.check_
-00021bd0: 6964 6c65 2c0a 2020 2020 2020 2020 7d0a  idle,.        }.
-00021be0: 0a20 2020 2020 2020 2063 6f6e 6e65 6374  .        connect
-00021bf0: 696f 6e5f 6c69 6d69 7420 3d20 6765 745f  ion_limit = get_
-00021c00: 6669 6c65 6e6f 5f6c 696d 6974 2829 202f  fileno_limit() /
-00021c10: 2032 0a0a 2020 2020 2020 2020 5363 6865   2..        Sche
-00021c20: 6475 6c65 7253 7461 7465 2e5f 5f69 6e69  dulerState.__ini
-00021c30: 745f 5f28 0a20 2020 2020 2020 2020 2020  t__(.           
-00021c40: 2073 656c 662c 0a20 2020 2020 2020 2020   self,.         
-00021c50: 2020 2061 6c69 6173 6573 3d61 6c69 6173     aliases=alias
-00021c60: 6573 2c0a 2020 2020 2020 2020 2020 2020  es,.            
-00021c70: 636c 6965 6e74 733d 636c 6965 6e74 732c  clients=clients,
-00021c80: 0a20 2020 2020 2020 2020 2020 2077 6f72  .            wor
-00021c90: 6b65 7273 3d77 6f72 6b65 7273 2c0a 2020  kers=workers,.  
-00021ca0: 2020 2020 2020 2020 2020 686f 7374 5f69            host_i
-00021cb0: 6e66 6f3d 686f 7374 5f69 6e66 6f2c 0a20  nfo=host_info,. 
-00021cc0: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
-00021cd0: 7263 6573 3d72 6573 6f75 7263 6573 2c0a  rces=resources,.
-00021ce0: 2020 2020 2020 2020 2020 2020 7461 736b              task
-00021cf0: 733d 7461 736b 732c 0a20 2020 2020 2020  s=tasks,.       
-00021d00: 2020 2020 2075 6e72 756e 6e61 626c 653d       unrunnable=
-00021d10: 756e 7275 6e6e 6162 6c65 2c0a 2020 2020  unrunnable,.    
-00021d20: 2020 2020 2020 2020 7175 6575 6564 3d71          queued=q
-00021d30: 7565 7565 642c 0a20 2020 2020 2020 2020  ueued,.         
-00021d40: 2020 2076 616c 6964 6174 653d 7661 6c69     validate=vali
-00021d50: 6461 7465 2c0a 2020 2020 2020 2020 2020  date,.          
-00021d60: 2020 706c 7567 696e 733d 706c 7567 696e    plugins=plugin
-00021d70: 732c 0a20 2020 2020 2020 2020 2020 2074  s,.            t
-00021d80: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
-00021d90: 725f 6d61 783d 7472 616e 7369 7469 6f6e  r_max=transition
-00021da0: 5f63 6f75 6e74 6572 5f6d 6178 2c0a 2020  _counter_max,.  
-00021db0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00021dc0: 5365 7276 6572 4e6f 6465 2e5f 5f69 6e69  ServerNode.__ini
-00021dd0: 745f 5f28 0a20 2020 2020 2020 2020 2020  t__(.           
-00021de0: 2073 656c 662c 0a20 2020 2020 2020 2020   self,.         
-00021df0: 2020 2068 616e 646c 6572 733d 7365 6c66     handlers=self
-00021e00: 2e68 616e 646c 6572 732c 0a20 2020 2020  .handlers,.     
-00021e10: 2020 2020 2020 2073 7472 6561 6d5f 6861         stream_ha
-00021e20: 6e64 6c65 7273 3d6d 6572 6765 2877 6f72  ndlers=merge(wor
-00021e30: 6b65 725f 6861 6e64 6c65 7273 2c20 636c  ker_handlers, cl
-00021e40: 6965 6e74 5f68 616e 646c 6572 7329 2c0a  ient_handlers),.
-00021e50: 2020 2020 2020 2020 2020 2020 636f 6e6e              conn
-00021e60: 6563 7469 6f6e 5f6c 696d 6974 3d63 6f6e  ection_limit=con
-00021e70: 6e65 6374 696f 6e5f 6c69 6d69 742c 0a20  nection_limit,. 
-00021e80: 2020 2020 2020 2020 2020 2064 6573 6572             deser
-00021e90: 6961 6c69 7a65 3d46 616c 7365 2c0a 2020  ialize=False,.  
-00021ea0: 2020 2020 2020 2020 2020 636f 6e6e 6563            connec
-00021eb0: 7469 6f6e 5f61 7267 733d 7365 6c66 2e63  tion_args=self.c
-00021ec0: 6f6e 6e65 6374 696f 6e5f 6172 6773 2c0a  onnection_args,.
-00021ed0: 2020 2020 2020 2020 2020 2020 2a2a 6b77              **kw
-00021ee0: 6172 6773 2c0a 2020 2020 2020 2020 290a  args,.        ).
-00021ef0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00021f00: 2e77 6f72 6b65 725f 7474 6c3a 0a20 2020  .worker_ttl:.   
-00021f10: 2020 2020 2020 2020 2070 6320 3d20 5065           pc = Pe
-00021f20: 7269 6f64 6963 4361 6c6c 6261 636b 2873  riodicCallback(s
-00021f30: 656c 662e 6368 6563 6b5f 776f 726b 6572  elf.check_worker
-00021f40: 5f74 746c 2c20 7365 6c66 2e77 6f72 6b65  _ttl, self.worke
-00021f50: 725f 7474 6c20 2a20 3130 3030 290a 2020  r_ttl * 1000).  
-00021f60: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-00021f70: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
-00021f80: 735b 2277 6f72 6b65 722d 7474 6c22 5d20  s["worker-ttl"] 
-00021f90: 3d20 7063 0a0a 2020 2020 2020 2020 7063  = pc..        pc
-00021fa0: 203d 2050 6572 696f 6469 6343 616c 6c62   = PeriodicCallb
-00021fb0: 6163 6b28 7365 6c66 2e63 6865 636b 5f69  ack(self.check_i
-00021fc0: 646c 652c 2032 3530 290a 2020 2020 2020  dle, 250).      
-00021fd0: 2020 7365 6c66 2e70 6572 696f 6469 635f    self.periodic_
-00021fe0: 6361 6c6c 6261 636b 735b 2269 646c 652d  callbacks["idle-
-00021ff0: 7469 6d65 6f75 7422 5d20 3d20 7063 0a0a  timeout"] = pc..
-00022000: 2020 2020 2020 2020 7063 203d 2050 6572          pc = Per
-00022010: 696f 6469 6343 616c 6c62 6163 6b28 7365  iodicCallback(se
-00022020: 6c66 2e5f 6368 6563 6b5f 6e6f 5f77 6f72  lf._check_no_wor
-00022030: 6b65 7273 2c20 3235 3029 0a20 2020 2020  kers, 250).     
-00022040: 2020 2073 656c 662e 7065 7269 6f64 6963     self.periodic
-00022050: 5f63 616c 6c62 6163 6b73 5b22 6e6f 2d77  _callbacks["no-w
-00022060: 6f72 6b65 7273 2d74 696d 656f 7574 225d  orkers-timeout"]
-00022070: 203d 2070 630a 0a20 2020 2020 2020 2069   = pc..        i
-00022080: 6620 6578 7465 6e73 696f 6e73 2069 7320  f extensions is 
-00022090: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-000220a0: 2020 6578 7465 6e73 696f 6e73 203d 2044    extensions = D
-000220b0: 4546 4155 4c54 5f45 5854 454e 5349 4f4e  EFAULT_EXTENSION
-000220c0: 532e 636f 7079 2829 0a20 2020 2020 2020  S.copy().       
-000220d0: 2020 2020 2069 6620 6e6f 7420 6461 736b       if not dask
-000220e0: 2e63 6f6e 6669 672e 6765 7428 2264 6973  .config.get("dis
-000220f0: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-00022100: 6572 2e77 6f72 6b2d 7374 6561 6c69 6e67  er.work-stealing
-00022110: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
-00022120: 2020 2020 6966 2022 7374 6561 6c69 6e67      if "stealing
-00022130: 2220 696e 2065 7874 656e 7369 6f6e 733a  " in extensions:
-00022140: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022150: 2020 2020 2064 656c 2065 7874 656e 7369       del extensi
-00022160: 6f6e 735b 2273 7465 616c 696e 6722 5d0a  ons["stealing"].
-00022170: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
-00022180: 652c 2065 7874 656e 7369 6f6e 2069 6e20  e, extension in 
-00022190: 6578 7465 6e73 696f 6e73 2e69 7465 6d73  extensions.items
-000221a0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-000221b0: 7365 6c66 2e65 7874 656e 7369 6f6e 735b  self.extensions[
-000221c0: 6e61 6d65 5d20 3d20 6578 7465 6e73 696f  name] = extensio
-000221d0: 6e28 7365 6c66 290a 0a20 2020 2020 2020  n(self)..       
-000221e0: 2073 6574 7072 6f63 7469 746c 6528 2264   setproctitle("d
-000221f0: 6173 6b20 7363 6865 6475 6c65 7220 5b6e  ask scheduler [n
-00022200: 6f74 2073 7461 7274 6564 5d22 290a 2020  ot started]").  
-00022210: 2020 2020 2020 5363 6865 6475 6c65 722e        Scheduler.
-00022220: 5f69 6e73 7461 6e63 6573 2e61 6464 2873  _instances.add(s
-00022230: 656c 6629 0a20 2020 2020 2020 2073 656c  elf).        sel
-00022240: 662e 7270 632e 616c 6c6f 775f 6f66 666c  f.rpc.allow_offl
-00022250: 6f61 6420 3d20 4661 6c73 650a 0a20 2020  oad = False..   
-00022260: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
-00022270: 2323 230a 2020 2020 2320 4164 6d69 6e69  ###.    # Admini
-00022280: 7374 7261 7469 6f6e 2023 0a20 2020 2023  stration #.    #
-00022290: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-000222a0: 230a 0a20 2020 2064 6566 205f 5f72 6570  #..    def __rep
-000222b0: 725f 5f28 7365 6c66 2920 2d3e 2073 7472  r__(self) -> str
-000222c0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000222d0: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
-000222e0: 223c 5363 6865 6475 6c65 7220 7b73 656c  "<Scheduler {sel
-000222f0: 662e 6164 6472 6573 735f 7361 6665 2172  f.address_safe!r
-00022300: 7d2c 2022 0a20 2020 2020 2020 2020 2020  }, ".           
-00022310: 2066 2277 6f72 6b65 7273 3a20 7b6c 656e   f"workers: {len
-00022320: 2873 656c 662e 776f 726b 6572 7329 7d2c  (self.workers)},
-00022330: 2022 0a20 2020 2020 2020 2020 2020 2066   ".            f
-00022340: 2263 6f72 6573 3a20 7b73 656c 662e 746f  "cores: {self.to
-00022350: 7461 6c5f 6e74 6872 6561 6473 7d2c 2022  tal_nthreads}, "
-00022360: 0a20 2020 2020 2020 2020 2020 2066 2274  .            f"t
-00022370: 6173 6b73 3a20 7b6c 656e 2873 656c 662e  asks: {len(self.
-00022380: 7461 736b 7329 7d3e 220a 2020 2020 2020  tasks)}>".      
-00022390: 2020 290a 0a20 2020 2064 6566 205f 7265    )..    def _re
-000223a0: 7072 5f68 746d 6c5f 2873 656c 6629 202d  pr_html_(self) -
-000223b0: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
-000223c0: 6574 7572 6e20 6765 745f 7465 6d70 6c61  eturn get_templa
-000223d0: 7465 2822 7363 6865 6475 6c65 722e 6874  te("scheduler.ht
-000223e0: 6d6c 2e6a 3222 292e 7265 6e64 6572 280a  ml.j2").render(.
-000223f0: 2020 2020 2020 2020 2020 2020 6164 6472              addr
-00022400: 6573 733d 7365 6c66 2e61 6464 7265 7373  ess=self.address
-00022410: 2c0a 2020 2020 2020 2020 2020 2020 776f  ,.            wo
-00022420: 726b 6572 733d 7365 6c66 2e77 6f72 6b65  rkers=self.worke
-00022430: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
-00022440: 7468 7265 6164 733d 7365 6c66 2e74 6f74  threads=self.tot
-00022450: 616c 5f6e 7468 7265 6164 732c 0a20 2020  al_nthreads,.   
-00022460: 2020 2020 2020 2020 2074 6173 6b73 3d73           tasks=s
-00022470: 656c 662e 7461 736b 732c 0a20 2020 2020  elf.tasks,.     
-00022480: 2020 2029 0a0a 2020 2020 6465 6620 6964     )..    def id
-00022490: 656e 7469 7479 2873 656c 6629 202d 3e20  entity(self) -> 
-000224a0: 6469 6374 5b73 7472 2c20 416e 795d 3a0a  dict[str, Any]:.
-000224b0: 2020 2020 2020 2020 2222 2242 6173 6963          """Basic
-000224c0: 2069 6e66 6f72 6d61 7469 6f6e 2061 626f   information abo
-000224d0: 7574 206f 7572 7365 6c76 6573 2061 6e64  ut ourselves and
-000224e0: 206f 7572 2063 6c75 7374 6572 2222 220a   our cluster""".
-000224f0: 2020 2020 2020 2020 6420 3d20 7b0a 2020          d = {.  
-00022500: 2020 2020 2020 2020 2020 2274 7970 6522            "type"
-00022510: 3a20 7479 7065 2873 656c 6629 2e5f 5f6e  : type(self).__n
-00022520: 616d 655f 5f2c 0a20 2020 2020 2020 2020  ame__,.         
-00022530: 2020 2022 6964 223a 2073 7472 2873 656c     "id": str(sel
-00022540: 662e 6964 292c 0a20 2020 2020 2020 2020  f.id),.         
-00022550: 2020 2022 6164 6472 6573 7322 3a20 7365     "address": se
-00022560: 6c66 2e61 6464 7265 7373 2c0a 2020 2020  lf.address,.    
-00022570: 2020 2020 2020 2020 2273 6572 7669 6365          "service
-00022580: 7322 3a20 7b6b 6579 3a20 762e 706f 7274  s": {key: v.port
-00022590: 2066 6f72 2028 6b65 792c 2076 2920 696e   for (key, v) in
-000225a0: 2073 656c 662e 7365 7276 6963 6573 2e69   self.services.i
-000225b0: 7465 6d73 2829 7d2c 0a20 2020 2020 2020  tems()},.       
-000225c0: 2020 2020 2022 7374 6172 7465 6422 3a20       "started": 
-000225d0: 7365 6c66 2e74 696d 655f 7374 6172 7465  self.time_starte
-000225e0: 642c 0a20 2020 2020 2020 2020 2020 2022  d,.            "
-000225f0: 776f 726b 6572 7322 3a20 7b0a 2020 2020  workers": {.    
-00022600: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00022610: 6572 2e61 6464 7265 7373 3a20 776f 726b  er.address: work
-00022620: 6572 2e69 6465 6e74 6974 7928 2920 666f  er.identity() fo
-00022630: 7220 776f 726b 6572 2069 6e20 7365 6c66  r worker in self
-00022640: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-00022650: 290a 2020 2020 2020 2020 2020 2020 7d2c  ).            },
-00022660: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-00022670: 2020 2072 6574 7572 6e20 640a 0a20 2020     return d..   
-00022680: 2064 6566 205f 746f 5f64 6963 7428 7365   def _to_dict(se
-00022690: 6c66 2c20 2a2c 2065 7863 6c75 6465 3a20  lf, *, exclude: 
-000226a0: 436f 6e74 6169 6e65 725b 7374 725d 203d  Container[str] =
-000226b0: 2028 2929 202d 3e20 6469 6374 3a0a 2020   ()) -> dict:.  
-000226c0: 2020 2020 2020 2222 2244 6963 7469 6f6e        """Diction
-000226d0: 6172 7920 7265 7072 6573 656e 7461 7469  ary representati
-000226e0: 6f6e 2066 6f72 2064 6562 7567 6769 6e67  on for debugging
-000226f0: 2070 7572 706f 7365 732e 0a20 2020 2020   purposes..     
-00022700: 2020 204e 6f74 2074 7970 6520 7374 6162     Not type stab
-00022710: 6c65 2061 6e64 206e 6f74 2069 6e74 656e  le and not inten
-00022720: 6465 6420 666f 7220 726f 756e 6474 7269  ded for roundtri
-00022730: 7073 2e0a 0a20 2020 2020 2020 2053 6565  ps...        See
-00022740: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
-00022750: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
-00022760: 6572 7665 722e 6964 656e 7469 7479 0a20  erver.identity. 
-00022770: 2020 2020 2020 2043 6c69 656e 742e 6475         Client.du
-00022780: 6d70 5f63 6c75 7374 6572 5f73 7461 7465  mp_cluster_state
-00022790: 0a20 2020 2020 2020 2064 6973 7472 6962  .        distrib
-000227a0: 7574 6564 2e75 7469 6c73 2e72 6563 7572  uted.utils.recur
-000227b0: 7369 7665 5f74 6f5f 6469 6374 0a20 2020  sive_to_dict.   
-000227c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000227d0: 2069 6e66 6f20 3d20 7375 7065 7228 292e   info = super().
-000227e0: 5f74 6f5f 6469 6374 2865 7863 6c75 6465  _to_dict(exclude
-000227f0: 3d65 7863 6c75 6465 290a 2020 2020 2020  =exclude).      
-00022800: 2020 6578 7472 6120 3d20 7b0a 2020 2020    extra = {.    
-00022810: 2020 2020 2020 2020 2274 7261 6e73 6974          "transit
-00022820: 696f 6e5f 6c6f 6722 3a20 7365 6c66 2e74  ion_log": self.t
-00022830: 7261 6e73 6974 696f 6e5f 6c6f 672c 0a20  ransition_log,. 
-00022840: 2020 2020 2020 2020 2020 2022 7472 616e             "tran
-00022850: 7369 7469 6f6e 5f63 6f75 6e74 6572 223a  sition_counter":
-00022860: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-00022870: 5f63 6f75 6e74 6572 2c0a 2020 2020 2020  _counter,.      
-00022880: 2020 2020 2020 2274 6173 6b73 223a 2073        "tasks": s
-00022890: 656c 662e 7461 736b 732c 0a20 2020 2020  elf.tasks,.     
-000228a0: 2020 2020 2020 2022 7461 736b 5f67 726f         "task_gro
-000228b0: 7570 7322 3a20 7365 6c66 2e74 6173 6b5f  ups": self.task_
-000228c0: 6772 6f75 7073 2c0a 2020 2020 2020 2020  groups,.        
-000228d0: 2020 2020 2320 4f76 6572 7772 6974 6520      # Overwrite 
-000228e0: 6469 6374 206f 6620 576f 726b 6572 5374  dict of WorkerSt
-000228f0: 6174 652e 6964 656e 7469 7479 2066 726f  ate.identity fro
-00022900: 6d20 696e 666f 0a20 2020 2020 2020 2020  m info.         
-00022910: 2020 2022 776f 726b 6572 7322 3a20 7365     "workers": se
-00022920: 6c66 2e77 6f72 6b65 7273 2c0a 2020 2020  lf.workers,.    
-00022930: 2020 2020 2020 2020 2263 6c69 656e 7473          "clients
-00022940: 223a 2073 656c 662e 636c 6965 6e74 732c  ": self.clients,
-00022950: 0a20 2020 2020 2020 2020 2020 2022 6d65  .            "me
-00022960: 6d6f 7279 223a 2073 656c 662e 6d65 6d6f  mory": self.memo
-00022970: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
-00022980: 2265 7665 6e74 7322 3a20 7365 6c66 2e65  "events": self.e
-00022990: 7665 6e74 732c 0a20 2020 2020 2020 2020  vents,.         
-000229a0: 2020 2022 6578 7465 6e73 696f 6e73 223a     "extensions":
-000229b0: 2073 656c 662e 6578 7465 6e73 696f 6e73   self.extensions
-000229c0: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
-000229d0: 2020 2020 6578 7472 6120 3d20 7b6b 3a20      extra = {k: 
-000229e0: 7620 666f 7220 6b2c 2076 2069 6e20 6578  v for k, v in ex
-000229f0: 7472 612e 6974 656d 7328 2920 6966 206b  tra.items() if k
-00022a00: 206e 6f74 2069 6e20 6578 636c 7564 657d   not in exclude}
-00022a10: 0a20 2020 2020 2020 2069 6e66 6f2e 7570  .        info.up
-00022a20: 6461 7465 2872 6563 7572 7369 7665 5f74  date(recursive_t
-00022a30: 6f5f 6469 6374 2865 7874 7261 2c20 6578  o_dict(extra, ex
-00022a40: 636c 7564 653d 6578 636c 7564 6529 290a  clude=exclude)).
-00022a50: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-00022a60: 6e66 6f0a 0a20 2020 2061 7379 6e63 2064  nfo..    async d
-00022a70: 6566 2067 6574 5f63 6c75 7374 6572 5f73  ef get_cluster_s
-00022a80: 7461 7465 280a 2020 2020 2020 2020 7365  tate(.        se
-00022a90: 6c66 2c0a 2020 2020 2020 2020 6578 636c  lf,.        excl
-00022aa0: 7564 653a 2043 6f6c 6c65 6374 696f 6e5b  ude: Collection[
-00022ab0: 7374 725d 2c0a 2020 2020 2920 2d3e 2064  str],.    ) -> d
-00022ac0: 6963 743a 0a20 2020 2020 2020 2022 5072  ict:.        "Pr
-00022ad0: 6f64 7563 6520 7468 6520 7374 6174 6520  oduce the state 
-00022ae0: 6469 6374 2075 7365 6420 696e 2061 2063  dict used in a c
-00022af0: 6c75 7374 6572 2073 7461 7465 2064 756d  luster state dum
-00022b00: 7022 0a20 2020 2020 2020 2023 204b 6963  p".        # Kic
-00022b10: 6b20 6f66 6620 7374 6174 652d 6475 6d70  k off state-dump
-00022b20: 696e 6720 6f6e 2077 6f72 6b65 7273 2062  ing on workers b
-00022b30: 6566 6f72 6520 7765 2062 6c6f 636b 2074  efore we block t
-00022b40: 6865 2065 7665 6e74 206c 6f6f 7020 696e  he event loop in
-00022b50: 2060 7365 6c66 2e5f 746f 5f64 6963 7460   `self._to_dict`
-00022b60: 2e0a 2020 2020 2020 2020 776f 726b 6572  ..        worker
-00022b70: 735f 6675 7475 7265 203d 2061 7379 6e63  s_future = async
-00022b80: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-00022b90: 2020 2020 2020 2073 656c 662e 6272 6f61         self.broa
-00022ba0: 6463 6173 7428 0a20 2020 2020 2020 2020  dcast(.         
-00022bb0: 2020 2020 2020 206d 7367 3d7b 226f 7022         msg={"op"
-00022bc0: 3a20 2264 756d 705f 7374 6174 6522 2c20  : "dump_state", 
-00022bd0: 2265 7863 6c75 6465 223a 2065 7863 6c75  "exclude": exclu
-00022be0: 6465 7d2c 0a20 2020 2020 2020 2020 2020  de},.           
-00022bf0: 2020 2020 206f 6e5f 6572 726f 723d 2272       on_error="r
-00022c00: 6574 7572 6e22 2c0a 2020 2020 2020 2020  eturn",.        
-00022c10: 2020 2020 292c 0a20 2020 2020 2020 2020      ),.         
-00022c20: 2020 2073 656c 662e 6272 6f61 6463 6173     self.broadcas
-00022c30: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
-00022c40: 2020 206d 7367 3d7b 226f 7022 3a20 2276     msg={"op": "v
-00022c50: 6572 7369 6f6e 7322 7d2c 0a20 2020 2020  ersions"},.     
-00022c60: 2020 2020 2020 2020 2020 206f 6e5f 6572             on_er
-00022c70: 726f 723d 2269 676e 6f72 6522 2c0a 2020  ror="ignore",.  
-00022c80: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
-00022c90: 2020 2020 2029 0a20 2020 2020 2020 2074       ).        t
-00022ca0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00022cb0: 7363 6865 6475 6c65 725f 7374 6174 6520  scheduler_state 
-00022cc0: 3d20 7365 6c66 2e5f 746f 5f64 6963 7428  = self._to_dict(
-00022cd0: 6578 636c 7564 653d 6578 636c 7564 6529  exclude=exclude)
-00022ce0: 0a0a 2020 2020 2020 2020 2020 2020 776f  ..            wo
-00022cf0: 726b 6572 5f73 7461 7465 732c 2077 6f72  rker_states, wor
-00022d00: 6b65 725f 7665 7273 696f 6e73 203d 2061  ker_versions = a
-00022d10: 7761 6974 2077 6f72 6b65 7273 5f66 7574  wait workers_fut
-00022d20: 7572 650a 2020 2020 2020 2020 6669 6e61  ure.        fina
-00022d30: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
-00022d40: 2023 2045 6e73 7572 6520 7468 6520 7461   # Ensure the ta
-00022d50: 736b 7320 6172 656e 2774 206c 6566 7420  sks aren't left 
-00022d60: 7275 6e6e 696e 6720 6966 2061 6e79 7468  running if anyth
-00022d70: 696e 6720 6661 696c 732e 0a20 2020 2020  ing fails..     
-00022d80: 2020 2020 2020 2023 2053 6f6d 6564 6179         # Someday
-00022d90: 2028 7079 332e 3131 292c 2075 7365 2061   (py3.11), use a
-00022da0: 2074 7269 6f2d 7374 796c 6520 5461 736b   trio-style Task
-00022db0: 4772 6f75 7020 666f 7220 7468 6973 2e0a  Group for this..
-00022dc0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00022dd0: 6572 735f 6675 7475 7265 2e63 616e 6365  ers_future.cance
-00022de0: 6c28 290a 0a20 2020 2020 2020 2023 2043  l()..        # C
-00022df0: 6f6e 7665 7274 2061 6e79 2052 5043 2065  onvert any RPC e
-00022e00: 7272 6f72 7320 746f 2073 7472 696e 6773  rrors to strings
-00022e10: 0a20 2020 2020 2020 2077 6f72 6b65 725f  .        worker_
-00022e20: 7374 6174 6573 203d 207b 0a20 2020 2020  states = {.     
-00022e30: 2020 2020 2020 206b 3a20 7265 7072 2876         k: repr(v
-00022e40: 2920 6966 2069 7369 6e73 7461 6e63 6528  ) if isinstance(
-00022e50: 762c 2045 7863 6570 7469 6f6e 2920 656c  v, Exception) el
-00022e60: 7365 2076 0a20 2020 2020 2020 2020 2020  se v.           
-00022e70: 2066 6f72 206b 2c20 7620 696e 2077 6f72   for k, v in wor
-00022e80: 6b65 725f 7374 6174 6573 2e69 7465 6d73  ker_states.items
-00022e90: 2829 0a20 2020 2020 2020 207d 0a0a 2020  ().        }..  
-00022ea0: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
-00022eb0: 2020 2020 2020 2020 2020 2022 7363 6865             "sche
-00022ec0: 6475 6c65 7222 3a20 7363 6865 6475 6c65  duler": schedule
-00022ed0: 725f 7374 6174 652c 0a20 2020 2020 2020  r_state,.       
-00022ee0: 2020 2020 2022 776f 726b 6572 7322 3a20       "workers": 
-00022ef0: 776f 726b 6572 5f73 7461 7465 732c 0a20  worker_states,. 
-00022f00: 2020 2020 2020 2020 2020 2022 7665 7273             "vers
-00022f10: 696f 6e73 223a 207b 2273 6368 6564 756c  ions": {"schedul
-00022f20: 6572 223a 2073 656c 662e 7665 7273 696f  er": self.versio
-00022f30: 6e73 2829 2c20 2277 6f72 6b65 7273 223a  ns(), "workers":
-00022f40: 2077 6f72 6b65 725f 7665 7273 696f 6e73   worker_versions
-00022f50: 7d2c 0a20 2020 2020 2020 207d 0a0a 2020  },.        }..  
-00022f60: 2020 6173 796e 6320 6465 6620 6475 6d70    async def dump
-00022f70: 5f63 6c75 7374 6572 5f73 7461 7465 5f74  _cluster_state_t
-00022f80: 6f5f 7572 6c28 0a20 2020 2020 2020 2073  o_url(.        s
-00022f90: 656c 662c 0a20 2020 2020 2020 2075 726c  elf,.        url
-00022fa0: 3a20 7374 722c 0a20 2020 2020 2020 2065  : str,.        e
-00022fb0: 7863 6c75 6465 3a20 436f 6c6c 6563 7469  xclude: Collecti
-00022fc0: 6f6e 5b73 7472 5d2c 0a20 2020 2020 2020  on[str],.       
-00022fd0: 2066 6f72 6d61 743a 204c 6974 6572 616c   format: Literal
-00022fe0: 5b22 6d73 6770 6163 6b22 2c20 2279 616d  ["msgpack", "yam
-00022ff0: 6c22 5d2c 0a20 2020 2020 2020 202a 2a73  l"],.        **s
-00023000: 746f 7261 6765 5f6f 7074 696f 6e73 3a20  torage_options: 
-00023010: 6469 6374 5b73 7472 2c20 416e 795d 2c0a  dict[str, Any],.
-00023020: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-00023030: 2020 2020 2020 2022 5772 6974 6520 6120         "Write a 
-00023040: 636c 7573 7465 7220 7374 6174 6520 6475  cluster state du
-00023050: 6d70 2074 6f20 616e 2066 7373 7065 632d  mp to an fsspec-
-00023060: 636f 6d70 6174 6962 6c65 2055 524c 2e22  compatible URL."
-00023070: 0a20 2020 2020 2020 2061 7761 6974 2063  .        await c
-00023080: 6c75 7374 6572 5f64 756d 702e 7772 6974  luster_dump.writ
-00023090: 655f 7374 6174 6528 0a20 2020 2020 2020  e_state(.       
-000230a0: 2020 2020 2070 6172 7469 616c 2873 656c       partial(sel
-000230b0: 662e 6765 745f 636c 7573 7465 725f 7374  f.get_cluster_st
-000230c0: 6174 652c 2065 7863 6c75 6465 292c 2075  ate, exclude), u
-000230d0: 726c 2c20 666f 726d 6174 2c20 2a2a 7374  rl, format, **st
-000230e0: 6f72 6167 655f 6f70 7469 6f6e 730a 2020  orage_options.  
-000230f0: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00023100: 2067 6574 5f77 6f72 6b65 725f 7365 7276   get_worker_serv
-00023110: 6963 655f 6164 6472 280a 2020 2020 2020  ice_addr(.      
-00023120: 2020 7365 6c66 2c20 776f 726b 6572 3a20    self, worker: 
-00023130: 7374 722c 2073 6572 7669 6365 5f6e 616d  str, service_nam
-00023140: 653a 2073 7472 2c20 7072 6f74 6f63 6f6c  e: str, protocol
-00023150: 3a20 626f 6f6c 203d 2046 616c 7365 0a20  : bool = False. 
-00023160: 2020 2029 202d 3e20 7475 706c 655b 7374     ) -> tuple[st
-00023170: 722c 2069 6e74 5d20 7c20 7374 7220 7c20  r, int] | str | 
-00023180: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-00023190: 220a 2020 2020 2020 2020 4765 7420 7468  ".        Get th
-000231a0: 6520 2868 6f73 742c 2070 6f72 7429 2061  e (host, port) a
-000231b0: 6464 7265 7373 206f 6620 7468 6520 6e61  ddress of the na
-000231c0: 6d65 6420 7365 7276 6963 6520 6f6e 2074  med service on t
-000231d0: 6865 202a 776f 726b 6572 2a2e 0a20 2020  he *worker*..   
-000231e0: 2020 2020 2052 6574 7572 6e73 204e 6f6e       Returns Non
-000231f0: 6520 6966 2074 6865 2073 6572 7669 6365  e if the service
-00023200: 2064 6f65 736e 2774 2065 7869 7374 2e0a   doesn't exist..
-00023210: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
-00023220: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
-00023230: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2077  ------.        w
-00023240: 6f72 6b65 7220 3a20 6164 6472 6573 730a  orker : address.
-00023250: 2020 2020 2020 2020 7365 7276 6963 655f          service_
-00023260: 6e61 6d65 203a 2073 7472 0a20 2020 2020  name : str.     
-00023270: 2020 2020 2020 2043 6f6d 6d6f 6e20 7365         Common se
-00023280: 7276 6963 6573 2069 6e63 6c75 6465 2027  rvices include '
-00023290: 626f 6b65 6827 2061 6e64 2027 6e61 6e6e  bokeh' and 'nann
-000232a0: 7927 0a20 2020 2020 2020 2070 726f 746f  y'.        proto
-000232b0: 636f 6c20 3a20 626f 6f6c 6561 6e0a 2020  col : boolean.  
-000232c0: 2020 2020 2020 2020 2020 5768 6574 6865            Whethe
-000232d0: 7220 6f72 206e 6f74 2074 6f20 696e 636c  r or not to incl
-000232e0: 7564 6520 6120 6675 6c6c 2061 6464 7265  ude a full addre
-000232f0: 7373 2077 6974 6820 7072 6f74 6f63 6f6c  ss with protocol
-00023300: 2028 5472 7565 290a 2020 2020 2020 2020   (True).        
-00023310: 2020 2020 6f72 206a 7573 7420 6120 2868      or just a (h
-00023320: 6f73 742c 2070 6f72 7429 2070 6169 720a  ost, port) pair.
-00023330: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00023340: 2020 2020 7773 203d 2073 656c 662e 776f      ws = self.wo
-00023350: 726b 6572 735b 776f 726b 6572 5d0a 2020  rkers[worker].  
-00023360: 2020 2020 2020 706f 7274 203d 2077 732e        port = ws.
-00023370: 7365 7276 6963 6573 2e67 6574 2873 6572  services.get(ser
-00023380: 7669 6365 5f6e 616d 6529 0a20 2020 2020  vice_name).     
-00023390: 2020 2069 6620 706f 7274 2069 7320 4e6f     if port is No
-000233a0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000233b0: 7265 7475 726e 204e 6f6e 650a 2020 2020  return None.    
-000233c0: 2020 2020 656c 6966 2070 726f 746f 636f      elif protoco
-000233d0: 6c3a 0a20 2020 2020 2020 2020 2020 2072  l:.            r
-000233e0: 6574 7572 6e20 2225 2870 726f 746f 636f  eturn "%(protoco
-000233f0: 6c29 733a 2f2f 2528 686f 7374 2973 3a25  l)s://%(host)s:%
-00023400: 2870 6f72 7429 6422 2025 207b 0a20 2020  (port)d" % {.   
-00023410: 2020 2020 2020 2020 2020 2020 2022 7072               "pr
-00023420: 6f74 6f63 6f6c 223a 2077 732e 6164 6472  otocol": ws.addr
-00023430: 6573 732e 7370 6c69 7428 223a 2f2f 2229  ess.split("://")
-00023440: 5b30 5d2c 0a20 2020 2020 2020 2020 2020  [0],.           
-00023450: 2020 2020 2022 686f 7374 223a 2077 732e       "host": ws.
-00023460: 686f 7374 2c0a 2020 2020 2020 2020 2020  host,.          
-00023470: 2020 2020 2020 2270 6f72 7422 3a20 706f        "port": po
-00023480: 7274 2c0a 2020 2020 2020 2020 2020 2020  rt,.            
-00023490: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
-000234a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000234b0: 726e 2077 732e 686f 7374 2c20 706f 7274  rn ws.host, port
-000234c0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-000234d0: 7374 6172 745f 756e 7361 6665 2873 656c  start_unsafe(sel
-000234e0: 6629 202d 3e20 5365 6c66 3a0a 2020 2020  f) -> Self:.    
-000234f0: 2020 2020 2222 2243 6c65 6172 206f 7574      """Clear out
-00023500: 206f 6c64 2073 7461 7465 2061 6e64 2072   old state and r
-00023510: 6573 7461 7274 2061 6c6c 2072 756e 6e69  estart all runni
-00023520: 6e67 2063 6f72 6f75 7469 6e65 7322 2222  ng coroutines"""
-00023530: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
-00023540: 7570 6572 2829 2e73 7461 7274 5f75 6e73  uper().start_uns
-00023550: 6166 6528 290a 0a20 2020 2020 2020 2065  afe()..        e
-00023560: 6e61 626c 655f 6763 5f64 6961 676e 6f73  nable_gc_diagnos
-00023570: 6973 2829 0a0a 2020 2020 2020 2020 7365  is()..        se
-00023580: 6c66 2e5f 636c 6561 725f 7461 736b 5f73  lf._clear_task_s
-00023590: 7461 7465 2829 0a0a 2020 2020 2020 2020  tate()..        
-000235a0: 666f 7220 6164 6472 2069 6e20 7365 6c66  for addr in self
-000235b0: 2e5f 7374 6172 745f 6164 6472 6573 733a  ._start_address:
-000235c0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-000235d0: 6974 2073 656c 662e 6c69 7374 656e 280a  it self.listen(.
-000235e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000235f0: 6164 6472 2c0a 2020 2020 2020 2020 2020  addr,.          
-00023600: 2020 2020 2020 616c 6c6f 775f 6f66 666c        allow_offl
-00023610: 6f61 643d 4661 6c73 652c 0a20 2020 2020  oad=False,.     
-00023620: 2020 2020 2020 2020 2020 2068 616e 6473             hands
-00023630: 6861 6b65 5f6f 7665 7272 6964 6573 3d7b  hake_overrides={
-00023640: 2270 6963 6b6c 652d 7072 6f74 6f63 6f6c  "pickle-protocol
-00023650: 223a 2034 2c20 2263 6f6d 7072 6573 7369  ": 4, "compressi
-00023660: 6f6e 223a 204e 6f6e 657d 2c0a 2020 2020  on": None},.    
-00023670: 2020 2020 2020 2020 2020 2020 2a2a 7365              **se
-00023680: 6c66 2e73 6563 7572 6974 792e 6765 745f  lf.security.get_
-00023690: 6c69 7374 656e 5f61 7267 7328 2273 6368  listen_args("sch
-000236a0: 6564 756c 6572 2229 2c0a 2020 2020 2020  eduler"),.      
-000236b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000236c0: 2020 2020 7365 6c66 2e69 7020 3d20 6765      self.ip = ge
-000236d0: 745f 6164 6472 6573 735f 686f 7374 2873  t_address_host(s
-000236e0: 656c 662e 6c69 7374 656e 5f61 6464 7265  elf.listen_addre
-000236f0: 7373 290a 2020 2020 2020 2020 2020 2020  ss).            
-00023700: 6c69 7374 656e 5f69 7020 3d20 7365 6c66  listen_ip = self
-00023710: 2e69 700a 0a20 2020 2020 2020 2020 2020  .ip..           
-00023720: 2069 6620 6c69 7374 656e 5f69 7020 3d3d   if listen_ip ==
-00023730: 2022 302e 302e 302e 3022 3a0a 2020 2020   "0.0.0.0":.    
-00023740: 2020 2020 2020 2020 2020 2020 6c69 7374              list
-00023750: 656e 5f69 7020 3d20 2222 0a0a 2020 2020  en_ip = ""..    
-00023760: 2020 2020 6966 2073 656c 662e 6164 6472      if self.addr
-00023770: 6573 732e 7374 6172 7473 7769 7468 2822  ess.startswith("
-00023780: 696e 7072 6f63 3a2f 2f22 293a 0a20 2020  inproc://"):.   
-00023790: 2020 2020 2020 2020 206c 6973 7465 6e5f           listen_
-000237a0: 6970 203d 2022 6c6f 6361 6c68 6f73 7422  ip = "localhost"
-000237b0: 0a0a 2020 2020 2020 2020 2320 5365 7276  ..        # Serv
-000237c0: 6963 6573 206c 6973 7465 6e20 6f6e 2061  ices listen on a
-000237d0: 6c6c 2061 6464 7265 7373 6573 0a20 2020  ll addresses.   
-000237e0: 2020 2020 2073 656c 662e 7374 6172 745f       self.start_
-000237f0: 7365 7276 6963 6573 286c 6973 7465 6e5f  services(listen_
-00023800: 6970 290a 0a20 2020 2020 2020 2066 6f72  ip)..        for
-00023810: 206c 6973 7465 6e65 7220 696e 2073 656c   listener in sel
-00023820: 662e 6c69 7374 656e 6572 733a 0a20 2020  f.listeners:.   
-00023830: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00023840: 696e 666f 2822 2020 5363 6865 6475 6c65  info("  Schedule
-00023850: 7220 6174 3a20 2532 3573 222c 206c 6973  r at: %25s", lis
-00023860: 7465 6e65 722e 636f 6e74 6163 745f 6164  tener.contact_ad
-00023870: 6472 6573 7329 0a20 2020 2020 2020 2066  dress).        f
-00023880: 6f72 206e 616d 652c 2073 6572 7665 7220  or name, server 
-00023890: 696e 2073 656c 662e 7365 7276 6963 6573  in self.services
-000238a0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-000238b0: 2020 2020 2020 6966 206e 616d 6520 3d3d        if name ==
-000238c0: 2022 6461 7368 626f 6172 6422 3a0a 2020   "dashboard":.  
-000238d0: 2020 2020 2020 2020 2020 2020 2020 6164                ad
-000238e0: 6472 203d 2067 6574 5f61 6464 7265 7373  dr = get_address
-000238f0: 5f68 6f73 7428 6c69 7374 656e 6572 2e63  _host(listener.c
-00023900: 6f6e 7461 6374 5f61 6464 7265 7373 290a  ontact_address).
-00023910: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023920: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00023930: 2020 2020 2020 2020 206c 696e 6b20 3d20           link = 
-00023940: 666f 726d 6174 5f64 6173 6862 6f61 7264  format_dashboard
-00023950: 5f6c 696e 6b28 6164 6472 2c20 7365 7276  _link(addr, serv
-00023960: 6572 2e70 6f72 7429 0a20 2020 2020 2020  er.port).       
-00023970: 2020 2020 2020 2020 2023 2066 6f72 6d61           # forma
-00023980: 7474 696e 6720 6461 7368 626f 6172 6420  tting dashboard 
-00023990: 6c69 6e6b 2063 616e 2066 6169 6c20 6966  link can fail if
-000239a0: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
-000239b0: 6862 6f61 7264 2e6c 696e 6b0a 2020 2020  hboard.link.    
-000239c0: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-000239d0: 6665 7273 2074 6f20 6e6f 6e2d 6578 6973  fers to non-exis
-000239e0: 7461 6e74 2065 6e76 2076 6172 732e 0a20  tant env vars.. 
-000239f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00023a00: 7863 6570 7420 4b65 7945 7272 6f72 2061  xcept KeyError a
-00023a10: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00023a20: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00023a30: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
-00023a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023a50: 2066 2246 6169 6c65 6420 746f 2066 6f72   f"Failed to for
-00023a60: 6d61 7420 6461 7368 626f 6172 6420 6c69  mat dashboard li
-00023a70: 6e6b 2c20 756e 6b6e 6f77 6e20 7661 6c75  nk, unknown valu
-00023a80: 653a 207b 657d 220a 2020 2020 2020 2020  e: {e}".        
-00023a90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00023aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023ab0: 2020 6c69 6e6b 203d 2066 223a 7b73 6572    link = f":{ser
-00023ac0: 7665 722e 706f 7274 7d22 0a20 2020 2020  ver.port}".     
-00023ad0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00023ae0: 2020 2020 2020 2020 2020 2020 206c 696e               lin
-00023af0: 6b20 3d20 6622 7b6c 6973 7465 6e5f 6970  k = f"{listen_ip
-00023b00: 7d3a 7b73 6572 7665 722e 706f 7274 7d22  }:{server.port}"
-00023b10: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-00023b20: 6765 722e 696e 666f 2822 2531 3173 2061  ger.info("%11s a
-00023b30: 743a 2020 2532 3573 222c 206e 616d 652c  t:  %25s", name,
-00023b40: 206c 696e 6b29 0a0a 2020 2020 2020 2020   link)..        
-00023b50: 6966 2073 656c 662e 7363 6865 6475 6c65  if self.schedule
-00023b60: 725f 6669 6c65 3a0a 2020 2020 2020 2020  r_file:.        
-00023b70: 2020 2020 7769 7468 206f 7065 6e28 7365      with open(se
-00023b80: 6c66 2e73 6368 6564 756c 6572 5f66 696c  lf.scheduler_fil
-00023b90: 652c 2022 7722 2920 6173 2066 3a0a 2020  e, "w") as f:.  
-00023ba0: 2020 2020 2020 2020 2020 2020 2020 6a73                js
-00023bb0: 6f6e 2e64 756d 7028 7365 6c66 2e69 6465  on.dump(self.ide
-00023bc0: 6e74 6974 7928 292c 2066 2c20 696e 6465  ntity(), f, inde
-00023bd0: 6e74 3d32 290a 0a20 2020 2020 2020 2020  nt=2)..         
-00023be0: 2020 2066 6e20 3d20 7365 6c66 2e73 6368     fn = self.sch
-00023bf0: 6564 756c 6572 5f66 696c 6520 2023 2072  eduler_file  # r
-00023c00: 656d 6f76 6520 6669 6c65 2077 6865 6e20  emove file when 
-00023c10: 7765 2063 6c6f 7365 2074 6865 2070 726f  we close the pro
-00023c20: 6365 7373 0a0a 2020 2020 2020 2020 2020  cess..          
-00023c30: 2020 6465 6620 6465 6c5f 7363 6865 6475    def del_schedu
-00023c40: 6c65 725f 6669 6c65 2829 202d 3e20 4e6f  ler_file() -> No
-00023c50: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00023c60: 2020 2020 6966 206f 732e 7061 7468 2e65      if os.path.e
-00023c70: 7869 7374 7328 666e 293a 0a20 2020 2020  xists(fn):.     
-00023c80: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00023c90: 732e 7265 6d6f 7665 2866 6e29 0a0a 2020  s.remove(fn)..  
-00023ca0: 2020 2020 2020 2020 2020 7765 616b 7265            weakre
-00023cb0: 662e 6669 6e61 6c69 7a65 2873 656c 662c  f.finalize(self,
-00023cc0: 2064 656c 5f73 6368 6564 756c 6572 5f66   del_scheduler_f
-00023cd0: 696c 6529 0a0a 2020 2020 2020 2020 6177  ile)..        aw
-00023ce0: 6169 7420 7365 6c66 2e70 7265 6c6f 6164  ait self.preload
-00023cf0: 732e 7374 6172 7428 290a 0a20 2020 2020  s.start()..     
-00023d00: 2020 2069 6620 7365 6c66 2e6a 7570 7974     if self.jupyt
-00023d10: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
-00023d20: 2320 416c 6c6f 7720 696e 7365 6375 7265  # Allow insecure
-00023d30: 2063 6f6d 6d75 6e69 6361 7469 6f6e 7320   communications 
-00023d40: 6672 6f6d 206c 6f63 616c 2075 7365 7273  from local users
-00023d50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00023d60: 7365 6c66 2e61 6464 7265 7373 2e73 7461  self.address.sta
-00023d70: 7274 7377 6974 6828 2274 6c73 3a2f 2f22  rtswith("tls://"
-00023d80: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00023d90: 2020 2061 7761 6974 2073 656c 662e 6c69     await self.li
-00023da0: 7374 656e 2822 7463 703a 2f2f 6c6f 6361  sten("tcp://loca
-00023db0: 6c68 6f73 743a 3022 290a 2020 2020 2020  lhost:0").      
-00023dc0: 2020 2020 2020 6f73 2e65 6e76 6972 6f6e        os.environ
-00023dd0: 5b22 4441 534b 5f53 4348 4544 554c 4552  ["DASK_SCHEDULER
-00023de0: 5f41 4444 5245 5353 225d 203d 2073 656c  _ADDRESS"] = sel
-00023df0: 662e 6c69 7374 656e 6572 735b 2d31 5d2e  f.listeners[-1].
-00023e00: 636f 6e74 6163 745f 6164 6472 6573 730a  contact_address.
-00023e10: 0a20 2020 2020 2020 2061 7761 6974 2061  .        await a
-00023e20: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
-00023e30: 2020 2020 2020 2020 2020 202a 5b70 6c75             *[plu
-00023e40: 6769 6e2e 7374 6172 7428 7365 6c66 2920  gin.start(self) 
-00023e50: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
-00023e60: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
-00023e70: 7661 6c75 6573 2829 295d 0a20 2020 2020  values())].     
-00023e80: 2020 2029 0a0a 2020 2020 2020 2020 7365     )..        se
-00023e90: 6c66 2e73 7461 7274 5f70 6572 696f 6469  lf.start_periodi
-00023ea0: 635f 6361 6c6c 6261 636b 7328 290a 0a20  c_callbacks().. 
-00023eb0: 2020 2020 2020 2073 6574 7072 6f63 7469         setprocti
-00023ec0: 746c 6528 6622 6461 736b 2073 6368 6564  tle(f"dask sched
-00023ed0: 756c 6572 205b 7b73 656c 662e 6164 6472  uler [{self.addr
-00023ee0: 6573 737d 5d22 290a 2020 2020 2020 2020  ess}]").        
-00023ef0: 7265 7475 726e 2073 656c 660a 0a20 2020  return self..   
-00023f00: 2061 7379 6e63 2064 6566 2063 6c6f 7365   async def close
-00023f10: 2873 656c 662c 2066 6173 743d 4e6f 6e65  (self, fast=None
-00023f20: 2c20 636c 6f73 655f 776f 726b 6572 733d  , close_workers=
-00023f30: 4e6f 6e65 2c20 7265 6173 6f6e 3d22 2229  None, reason="")
-00023f40: 3a0a 2020 2020 2020 2020 2222 2253 656e  :.        """Sen
-00023f50: 6420 636c 6561 6e75 7020 7369 676e 616c  d cleanup signal
-00023f60: 2074 6f20 616c 6c20 636f 726f 7574 696e   to all coroutin
-00023f70: 6573 2074 6865 6e20 7761 6974 2075 6e74  es then wait unt
-00023f80: 696c 2066 696e 6973 6865 640a 0a20 2020  il finished..   
-00023f90: 2020 2020 2053 6565 2041 6c73 6f0a 2020       See Also.  
-00023fa0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-00023fb0: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
-00023fc0: 2e63 6c65 616e 7570 0a20 2020 2020 2020  .cleanup.       
-00023fd0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-00023fe0: 6661 7374 2069 7320 6e6f 7420 4e6f 6e65  fast is not None
-00023ff0: 206f 7220 636c 6f73 655f 776f 726b 6572   or close_worker
-00024000: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
-00024010: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
-00024020: 6e67 732e 7761 726e 280a 2020 2020 2020  ngs.warn(.      
-00024030: 2020 2020 2020 2020 2020 2254 6865 2027            "The '
-00024040: 6661 7374 2720 616e 6420 2763 6c6f 7365  fast' and 'close
-00024050: 5f77 6f72 6b65 7273 2720 7061 7261 6d65  _workers' parame
-00024060: 7465 7273 2069 6e20 5363 6865 6475 6c65  ters in Schedule
-00024070: 722e 636c 6f73 6520 6861 7665 206e 6f20  r.close have no 
-00024080: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00024090: 2020 2265 6666 6563 7420 616e 6420 7769    "effect and wi
-000240a0: 6c6c 2062 6520 7265 6d6f 7665 6420 696e  ll be removed in
-000240b0: 2061 2066 7574 7572 6520 7665 7273 696f   a future versio
-000240c0: 6e20 6f66 2064 6973 7472 6962 7574 6564  n of distributed
-000240d0: 2e22 2c0a 2020 2020 2020 2020 2020 2020  .",.            
-000240e0: 2020 2020 4675 7475 7265 5761 726e 696e      FutureWarnin
-000240f0: 672c 0a20 2020 2020 2020 2020 2020 2029  g,.            )
-00024100: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00024110: 2e73 7461 7475 7320 696e 2028 5374 6174  .status in (Stat
-00024120: 7573 2e63 6c6f 7369 6e67 2c20 5374 6174  us.closing, Stat
-00024130: 7573 2e63 6c6f 7365 6429 3a0a 2020 2020  us.closed):.    
-00024140: 2020 2020 2020 2020 6177 6169 7420 7365          await se
-00024150: 6c66 2e66 696e 6973 6865 6428 290a 2020  lf.finished().  
-00024160: 2020 2020 2020 2020 2020 7265 7475 726e            return
-00024170: 0a0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
-00024180: 6465 6620 6c6f 675f 6572 726f 7273 2866  def log_errors(f
-00024190: 756e 6329 3a0a 2020 2020 2020 2020 2020  unc):.          
-000241a0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-000241b0: 2020 2020 2020 2061 7761 6974 2066 756e         await fun
-000241c0: 6328 290a 2020 2020 2020 2020 2020 2020  c().            
-000241d0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-000241e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000241f0: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
-00024200: 6f6e 2822 506c 7567 696e 2063 616c 6c20  on("Plugin call 
-00024210: 6661 696c 6564 2064 7572 696e 6720 7363  failed during sc
-00024220: 6865 6475 6c65 722e 636c 6f73 6522 290a  heduler.close").
-00024230: 0a20 2020 2020 2020 2061 7761 6974 2061  .        await a
-00024240: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
-00024250: 2020 2020 2020 2020 2020 202a 5b6c 6f67             *[log
-00024260: 5f65 7272 6f72 7328 706c 7567 696e 2e62  _errors(plugin.b
-00024270: 6566 6f72 655f 636c 6f73 6529 2066 6f72  efore_close) for
-00024280: 2070 6c75 6769 6e20 696e 206c 6973 7428   plugin in list(
-00024290: 7365 6c66 2e70 6c75 6769 6e73 2e76 616c  self.plugins.val
-000242a0: 7565 7328 2929 5d0a 2020 2020 2020 2020  ues())].        
-000242b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-000242c0: 7374 6174 7573 203d 2053 7461 7475 732e  status = Status.
-000242d0: 636c 6f73 696e 670a 2020 2020 2020 2020  closing.        
-000242e0: 6c6f 6767 6572 2e69 6e66 6f28 2253 6368  logger.info("Sch
-000242f0: 6564 756c 6572 2063 6c6f 7369 6e67 2064  eduler closing d
-00024300: 7565 2074 6f20 2573 2e2e 2e22 2c20 7265  ue to %s...", re
-00024310: 6173 6f6e 206f 7220 2275 6e6b 6e6f 776e  ason or "unknown
-00024320: 2072 6561 736f 6e22 290a 2020 2020 2020   reason").      
-00024330: 2020 7365 7470 726f 6374 6974 6c65 2822    setproctitle("
-00024340: 6461 736b 2073 6368 6564 756c 6572 205b  dask scheduler [
-00024350: 636c 6f73 696e 675d 2229 0a0a 2020 2020  closing]")..    
-00024360: 2020 2020 6177 6169 7420 7365 6c66 2e70      await self.p
-00024370: 7265 6c6f 6164 732e 7465 6172 646f 776e  reloads.teardown
-00024380: 2829 0a0a 2020 2020 2020 2020 6177 6169  ()..        awai
-00024390: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-000243a0: 280a 2020 2020 2020 2020 2020 2020 2a5b  (.            *[
-000243b0: 6c6f 675f 6572 726f 7273 2870 6c75 6769  log_errors(plugi
-000243c0: 6e2e 636c 6f73 6529 2066 6f72 2070 6c75  n.close) for plu
-000243d0: 6769 6e20 696e 206c 6973 7428 7365 6c66  gin in list(self
-000243e0: 2e70 6c75 6769 6e73 2e76 616c 7565 7328  .plugins.values(
-000243f0: 2929 5d0a 2020 2020 2020 2020 290a 0a20  ))].        ).. 
-00024400: 2020 2020 2020 2066 6f72 2070 6320 696e         for pc in
-00024410: 2073 656c 662e 7065 7269 6f64 6963 5f63   self.periodic_c
-00024420: 616c 6c62 6163 6b73 2e76 616c 7565 7328  allbacks.values(
-00024430: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
-00024440: 632e 7374 6f70 2829 0a20 2020 2020 2020  c.stop().       
-00024450: 2073 656c 662e 7065 7269 6f64 6963 5f63   self.periodic_c
-00024460: 616c 6c62 6163 6b73 2e63 6c65 6172 2829  allbacks.clear()
-00024470: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
-00024480: 746f 705f 7365 7276 6963 6573 2829 0a0a  top_services()..
-00024490: 2020 2020 2020 2020 666f 7220 6578 7420          for ext 
-000244a0: 696e 2073 656c 662e 6578 7465 6e73 696f  in self.extensio
-000244b0: 6e73 2e76 616c 7565 7328 293a 0a20 2020  ns.values():.   
-000244c0: 2020 2020 2020 2020 2077 6974 6820 7375           with su
-000244d0: 7070 7265 7373 2841 7474 7269 6275 7465  ppress(Attribute
-000244e0: 4572 726f 7229 3a0a 2020 2020 2020 2020  Error):.        
-000244f0: 2020 2020 2020 2020 6578 742e 7465 6172          ext.tear
-00024500: 646f 776e 2829 0a20 2020 2020 2020 206c  down().        l
-00024510: 6f67 6765 722e 696e 666f 2822 5363 6865  ogger.info("Sche
-00024520: 6475 6c65 7220 636c 6f73 696e 6720 616c  duler closing al
-00024530: 6c20 636f 6d6d 7322 290a 0a20 2020 2020  l comms")..     
-00024540: 2020 2066 7574 7572 6573 203d 205b 5d0a     futures = [].
-00024550: 2020 2020 2020 2020 666f 7220 5f2c 2063          for _, c
-00024560: 6f6d 6d20 696e 206c 6973 7428 7365 6c66  omm in list(self
-00024570: 2e73 7472 6561 6d5f 636f 6d6d 732e 6974  .stream_comms.it
-00024580: 656d 7328 2929 3a0a 2020 2020 2020 2020  ems()):.        
-00024590: 2020 2020 2320 4649 584d 4520 7573 6520      # FIXME use 
-000245a0: 6073 656c 662e 7265 6d6f 7665 5f77 6f72  `self.remove_wor
-000245b0: 6b65 7228 2960 2069 6e73 7465 6164 2061  ker()` instead a
-000245c0: 6674 6572 2068 7474 7073 3a2f 2f67 6974  fter https://git
-000245d0: 6875 622e 636f 6d2f 6461 736b 2f64 6973  hub.com/dask/dis
-000245e0: 7472 6962 7574 6564 2f69 7373 7565 732f  tributed/issues/
-000245f0: 3633 3930 0a20 2020 2020 2020 2020 2020  6390.           
-00024600: 2069 6620 6e6f 7420 636f 6d6d 2e63 6c6f   if not comm.clo
-00024610: 7365 6428 293a 0a20 2020 2020 2020 2020  sed():.         
-00024620: 2020 2020 2020 2023 2054 6869 7320 636c         # This cl
-00024630: 6f73 6573 2074 6865 2057 6f72 6b65 7220  oses the Worker 
-00024640: 616e 6420 656e 7375 7265 7320 7468 6174  and ensures that
-00024650: 2069 6620 6120 4e61 6e6e 7920 6973 2061   if a Nanny is a
-00024660: 726f 756e 642c 0a20 2020 2020 2020 2020  round,.         
-00024670: 2020 2020 2020 2023 2069 7420 6973 2063         # it is c
-00024680: 6c6f 7365 6420 6173 2077 656c 6c0a 2020  losed as well.  
-00024690: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000246a0: 6d6d 2e73 656e 6428 7b22 6f70 223a 2022  mm.send({"op": "
-000246b0: 636c 6f73 6522 2c20 2272 6561 736f 6e22  close", "reason"
-000246c0: 3a20 2273 6368 6564 756c 6572 2d63 6c6f  : "scheduler-clo
-000246d0: 7365 227d 290a 2020 2020 2020 2020 2020  se"}).          
-000246e0: 2020 2020 2020 636f 6d6d 2e73 656e 6428        comm.send(
-000246f0: 7b22 6f70 223a 2022 636c 6f73 652d 7374  {"op": "close-st
-00024700: 7265 616d 227d 290a 2020 2020 2020 2020  ream"}).        
-00024710: 2020 2020 2020 2020 2320 5e20 544f 444f          # ^ TODO
-00024720: 2072 656d 6f76 653f 2060 576f 726b 6572   remove? `Worker
-00024730: 2e63 6c6f 7365 6020 7769 6c6c 2063 6c6f  .close` will clo
-00024740: 7365 2074 6865 2073 7472 6561 6d20 616e  se the stream an
-00024750: 7977 6179 2e0a 2020 2020 2020 2020 2020  yway..          
-00024760: 2020 7769 7468 2073 7570 7072 6573 7328    with suppress(
-00024770: 4174 7472 6962 7574 6545 7272 6f72 293a  AttributeError):
-00024780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00024790: 2066 7574 7572 6573 2e61 7070 656e 6428   futures.append(
-000247a0: 636f 6d6d 2e63 6c6f 7365 2829 290a 0a20  comm.close()).. 
-000247b0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
-000247c0: 6e63 696f 2e67 6174 6865 7228 2a66 7574  ncio.gather(*fut
-000247d0: 7572 6573 290a 0a20 2020 2020 2020 2069  ures)..        i
-000247e0: 6620 7365 6c66 2e6a 7570 7974 6572 3a0a  f self.jupyter:.
-000247f0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
-00024800: 7420 7365 6c66 2e5f 6a75 7079 7465 725f  t self._jupyter_
-00024810: 7365 7276 6572 5f61 7070 6c69 6361 7469  server_applicati
-00024820: 6f6e 2e5f 636c 6561 6e75 7028 290a 0a20  on._cleanup().. 
-00024830: 2020 2020 2020 2066 6f72 2063 6f6d 6d20         for comm 
-00024840: 696e 2073 656c 662e 636c 6965 6e74 5f63  in self.client_c
-00024850: 6f6d 6d73 2e76 616c 7565 7328 293a 0a20  omms.values():. 
-00024860: 2020 2020 2020 2020 2020 2063 6f6d 6d2e             comm.
-00024870: 6162 6f72 7428 290a 0a20 2020 2020 2020  abort()..       
-00024880: 2061 7761 6974 2073 656c 662e 7270 632e   await self.rpc.
-00024890: 636c 6f73 6528 290a 0a20 2020 2020 2020  close()..       
-000248a0: 2073 656c 662e 7374 6174 7573 203d 2053   self.status = S
-000248b0: 7461 7475 732e 636c 6f73 6564 0a20 2020  tatus.closed.   
-000248c0: 2020 2020 2073 656c 662e 7374 6f70 2829       self.stop()
-000248d0: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
-000248e0: 7570 6572 2829 2e63 6c6f 7365 2829 0a0a  uper().close()..
-000248f0: 2020 2020 2020 2020 7365 7470 726f 6374          setproct
-00024900: 6974 6c65 2822 6461 736b 2073 6368 6564  itle("dask sched
-00024910: 756c 6572 205b 636c 6f73 6564 5d22 290a  uler [closed]").
-00024920: 2020 2020 2020 2020 6469 7361 626c 655f          disable_
-00024930: 6763 5f64 6961 676e 6f73 6973 2829 0a0a  gc_diagnosis()..
-00024940: 2020 2020 2323 2323 2323 2323 2323 230a      ###########.
-00024950: 2020 2020 2320 5374 696d 756c 6920 230a      # Stimuli #.
-00024960: 2020 2020 2323 2323 2323 2323 2323 230a      ###########.
-00024970: 0a20 2020 2064 6566 2068 6561 7274 6265  .    def heartbe
-00024980: 6174 5f77 6f72 6b65 7228 0a20 2020 2020  at_worker(.     
-00024990: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-000249a0: 202a 2c0a 2020 2020 2020 2020 6164 6472   *,.        addr
-000249b0: 6573 733a 2073 7472 2c0a 2020 2020 2020  ess: str,.      
-000249c0: 2020 7265 736f 6c76 655f 6164 6472 6573    resolve_addres
-000249d0: 733a 2062 6f6f 6c20 3d20 5472 7565 2c0a  s: bool = True,.
-000249e0: 2020 2020 2020 2020 6e6f 773a 2066 6c6f          now: flo
-000249f0: 6174 207c 204e 6f6e 6520 3d20 4e6f 6e65  at | None = None
-00024a00: 2c0a 2020 2020 2020 2020 7265 736f 7572  ,.        resour
-00024a10: 6365 733a 2064 6963 745b 7374 722c 2066  ces: dict[str, f
-00024a20: 6c6f 6174 5d20 7c20 4e6f 6e65 203d 204e  loat] | None = N
-00024a30: 6f6e 652c 0a20 2020 2020 2020 2068 6f73  one,.        hos
-00024a40: 745f 696e 666f 3a20 6469 6374 207c 204e  t_info: dict | N
-00024a50: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00024a60: 2020 2020 6d65 7472 6963 733a 2064 6963      metrics: dic
-00024a70: 742c 0a20 2020 2020 2020 2065 7865 6375  t,.        execu
-00024a80: 7469 6e67 3a20 6469 6374 5b4b 6579 2c20  ting: dict[Key, 
-00024a90: 666c 6f61 745d 207c 204e 6f6e 6520 3d20  float] | None = 
-00024aa0: 4e6f 6e65 2c0a 2020 2020 2020 2020 6578  None,.        ex
-00024ab0: 7465 6e73 696f 6e73 3a20 6469 6374 207c  tensions: dict |
-00024ac0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00024ad0: 2020 2920 2d3e 2064 6963 745b 7374 722c    ) -> dict[str,
-00024ae0: 2041 6e79 5d3a 0a20 2020 2020 2020 2061   Any]:.        a
-00024af0: 6464 7265 7373 203d 2073 656c 662e 636f  ddress = self.co
-00024b00: 6572 6365 5f61 6464 7265 7373 2861 6464  erce_address(add
-00024b10: 7265 7373 2c20 7265 736f 6c76 655f 6164  ress, resolve_ad
-00024b20: 6472 6573 7329 0a20 2020 2020 2020 2061  dress).        a
-00024b30: 6464 7265 7373 203d 206e 6f72 6d61 6c69  ddress = normali
-00024b40: 7a65 5f61 6464 7265 7373 2861 6464 7265  ze_address(addre
-00024b50: 7373 290a 2020 2020 2020 2020 7773 203d  ss).        ws =
-00024b60: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
-00024b70: 7428 6164 6472 6573 7329 0a20 2020 2020  t(address).     
-00024b80: 2020 2069 6620 7773 2069 7320 4e6f 6e65     if ws is None
-00024b90: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00024ba0: 6767 6572 2e77 6172 6e69 6e67 2866 2252  gger.warning(f"R
-00024bb0: 6563 6569 7665 6420 6865 6172 7462 6561  eceived heartbea
-00024bc0: 7420 6672 6f6d 2075 6e72 6567 6973 7465  t from unregiste
-00024bd0: 7265 6420 776f 726b 6572 207b 6164 6472  red worker {addr
-00024be0: 6573 7321 727d 2e22 290a 2020 2020 2020  ess!r}.").      
-00024bf0: 2020 2020 2020 7265 7475 726e 207b 2273        return {"s
-00024c00: 7461 7475 7322 3a20 226d 6973 7369 6e67  tatus": "missing
-00024c10: 227d 0a0a 2020 2020 2020 2020 686f 7374  "}..        host
-00024c20: 203d 2067 6574 5f61 6464 7265 7373 5f68   = get_address_h
-00024c30: 6f73 7428 6164 6472 6573 7329 0a20 2020  ost(address).   
-00024c40: 2020 2020 206c 6f63 616c 5f6e 6f77 203d       local_now =
-00024c50: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
-00024c60: 686f 7374 5f69 6e66 6f20 3d20 686f 7374  host_info = host
-00024c70: 5f69 6e66 6f20 6f72 207b 7d0a 0a20 2020  _info or {}..   
-00024c80: 2020 2020 2064 6820 3d20 7365 6c66 2e68       dh = self.h
-00024c90: 6f73 745f 696e 666f 2e73 6574 6465 6661  ost_info.setdefa
-00024ca0: 756c 7428 686f 7374 2c20 7b7d 290a 2020  ult(host, {}).  
-00024cb0: 2020 2020 2020 6468 5b22 6c61 7374 2d73        dh["last-s
-00024cc0: 6565 6e22 5d20 3d20 6c6f 6361 6c5f 6e6f  een"] = local_no
-00024cd0: 770a 0a20 2020 2020 2020 2066 7261 6320  w..        frac 
-00024ce0: 3d20 3120 2f20 6c65 6e28 7365 6c66 2e77  = 1 / len(self.w
-00024cf0: 6f72 6b65 7273 290a 2020 2020 2020 2020  orkers).        
-00024d00: 7365 6c66 2e62 616e 6477 6964 7468 203d  self.bandwidth =
-00024d10: 2028 0a20 2020 2020 2020 2020 2020 2073   (.            s
-00024d20: 656c 662e 6261 6e64 7769 6474 6820 2a20  elf.bandwidth * 
-00024d30: 2831 202d 2066 7261 6329 202b 206d 6574  (1 - frac) + met
-00024d40: 7269 6373 5b22 6261 6e64 7769 6474 6822  rics["bandwidth"
-00024d50: 5d5b 2274 6f74 616c 225d 202a 2066 7261  ]["total"] * fra
-00024d60: 630a 2020 2020 2020 2020 290a 2020 2020  c.        ).    
-00024d70: 2020 2020 666f 7220 6f74 6865 722c 2028      for other, (
-00024d80: 6277 2c20 636f 756e 7429 2069 6e20 6d65  bw, count) in me
-00024d90: 7472 6963 735b 2262 616e 6477 6964 7468  trics["bandwidth
-00024da0: 225d 5b22 776f 726b 6572 7322 5d2e 6974  "]["workers"].it
-00024db0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-00024dc0: 2020 2069 6620 2861 6464 7265 7373 2c20     if (address, 
-00024dd0: 6f74 6865 7229 206e 6f74 2069 6e20 7365  other) not in se
-00024de0: 6c66 2e62 616e 6477 6964 7468 5f77 6f72  lf.bandwidth_wor
-00024df0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-00024e00: 2020 2020 2020 7365 6c66 2e62 616e 6477        self.bandw
-00024e10: 6964 7468 5f77 6f72 6b65 7273 5b61 6464  idth_workers[add
-00024e20: 7265 7373 2c20 6f74 6865 725d 203d 2062  ress, other] = b
-00024e30: 7720 2f20 636f 756e 740a 2020 2020 2020  w / count.      
-00024e40: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00024e50: 2020 2020 2020 2020 2020 2020 616c 7068              alph
-00024e60: 6120 3d20 2831 202d 2066 7261 6329 202a  a = (1 - frac) *
-00024e70: 2a20 636f 756e 740a 2020 2020 2020 2020  * count.        
-00024e80: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
-00024e90: 6477 6964 7468 5f77 6f72 6b65 7273 5b61  dwidth_workers[a
-00024ea0: 6464 7265 7373 2c20 6f74 6865 725d 203d  ddress, other] =
-00024eb0: 2073 656c 662e 6261 6e64 7769 6474 685f   self.bandwidth_
-00024ec0: 776f 726b 6572 735b 0a20 2020 2020 2020  workers[.       
-00024ed0: 2020 2020 2020 2020 2020 2020 2061 6464               add
-00024ee0: 7265 7373 2c20 6f74 6865 720a 2020 2020  ress, other.    
-00024ef0: 2020 2020 2020 2020 2020 2020 5d20 2a20              ] * 
-00024f00: 616c 7068 6120 2b20 6277 202a 2028 3120  alpha + bw * (1 
-00024f10: 2d20 616c 7068 6129 0a20 2020 2020 2020  - alpha).       
-00024f20: 2066 6f72 2074 7970 2c20 2862 772c 2063   for typ, (bw, c
-00024f30: 6f75 6e74 2920 696e 206d 6574 7269 6373  ount) in metrics
-00024f40: 5b22 6261 6e64 7769 6474 6822 5d5b 2274  ["bandwidth"]["t
-00024f50: 7970 6573 225d 2e69 7465 6d73 2829 3a0a  ypes"].items():.
-00024f60: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00024f70: 7970 206e 6f74 2069 6e20 7365 6c66 2e62  yp not in self.b
-00024f80: 616e 6477 6964 7468 5f74 7970 6573 3a0a  andwidth_types:.
-00024f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00024fa0: 7365 6c66 2e62 616e 6477 6964 7468 5f74  self.bandwidth_t
-00024fb0: 7970 6573 5b74 7970 5d20 3d20 6277 202f  ypes[typ] = bw /
-00024fc0: 2063 6f75 6e74 0a20 2020 2020 2020 2020   count.         
-00024fd0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00024fe0: 2020 2020 2020 2020 2061 6c70 6861 203d           alpha =
-00024ff0: 2028 3120 2d20 6672 6163 2920 2a2a 2063   (1 - frac) ** c
-00025000: 6f75 6e74 0a20 2020 2020 2020 2020 2020  ount.           
-00025010: 2020 2020 2073 656c 662e 6261 6e64 7769       self.bandwi
-00025020: 6474 685f 7479 7065 735b 7479 705d 203d  dth_types[typ] =
-00025030: 2073 656c 662e 6261 6e64 7769 6474 685f   self.bandwidth_
-00025040: 7479 7065 735b 7479 705d 202a 2061 6c70  types[typ] * alp
-00025050: 6861 202b 2062 7720 2a20 280a 2020 2020  ha + bw * (.    
-00025060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00025070: 3120 2d20 616c 7068 610a 2020 2020 2020  1 - alpha.      
-00025080: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00025090: 2020 2020 2077 732e 6c61 7374 5f73 6565       ws.last_see
-000250a0: 6e20 3d20 6c6f 6361 6c5f 6e6f 770a 2020  n = local_now.  
-000250b0: 2020 2020 2020 6966 2065 7865 6375 7469        if executi
-000250c0: 6e67 2069 7320 6e6f 7420 4e6f 6e65 3a0a  ng is not None:.
-000250d0: 2020 2020 2020 2020 2020 2020 2320 4e4f              # NO
-000250e0: 5445 3a20 7468 6520 6578 6563 7574 696e  TE: the executin
-000250f0: 6720 6469 6374 2069 7320 756e 7573 6564  g dict is unused
-00025100: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
-00025110: 6578 6563 7574 696e 6720 3d20 7b7d 0a20  executing = {}. 
-00025120: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-00025130: 6579 2c20 6475 7261 7469 6f6e 2069 6e20  ey, duration in 
-00025140: 6578 6563 7574 696e 672e 6974 656d 7328  executing.items(
-00025150: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00025160: 2020 2069 6620 6b65 7920 696e 2073 656c     if key in sel
-00025170: 662e 7461 736b 733a 0a20 2020 2020 2020  f.tasks:.       
-00025180: 2020 2020 2020 2020 2020 2020 2074 7320               ts 
-00025190: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
-000251a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000251b0: 2020 2020 2020 7773 2e65 7865 6375 7469        ws.executi
-000251c0: 6e67 5b74 735d 203d 2064 7572 6174 696f  ng[ts] = duratio
-000251d0: 6e0a 2020 2020 2020 2020 2020 2020 2020  n.              
-000251e0: 2020 2020 2020 7473 2e70 7265 6669 782e        ts.prefix.
-000251f0: 6164 645f 6578 6563 5f74 696d 6528 6475  add_exec_time(du
-00025200: 7261 7469 6f6e 290a 0a20 2020 2020 2020  ration)..       
-00025210: 2066 6f72 206e 616d 652c 2076 616c 7565   for name, value
-00025220: 2069 6e20 6d65 7472 6963 735b 2264 6967   in metrics["dig
-00025230: 6573 7473 5f74 6f74 616c 5f73 696e 6365  ests_total_since
-00025240: 5f68 6561 7274 6265 6174 225d 2e69 7465  _heartbeat"].ite
-00025250: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00025260: 2020 7365 6c66 2e63 756d 756c 6174 6976    self.cumulativ
-00025270: 655f 776f 726b 6572 5f6d 6574 7269 6373  e_worker_metrics
-00025280: 5b6e 616d 655d 202b 3d20 7661 6c75 650a  [name] += value.
-00025290: 0a20 2020 2020 2020 2077 732e 6d65 7472  .        ws.metr
-000252a0: 6963 7320 3d20 6d65 7472 6963 730a 0a20  ics = metrics.. 
-000252b0: 2020 2020 2020 2023 2043 616c 6375 6c61         # Calcula
-000252c0: 7465 2052 5353 202d 2064 6173 6b20 6b65  te RSS - dask ke
-000252d0: 7973 2c20 7365 7061 7261 7469 6e67 2022  ys, separating "
-000252e0: 6f6c 6422 2061 6e64 2022 6e65 7722 2075  old" and "new" u
-000252f0: 7361 6765 0a20 2020 2020 2020 2023 2053  sage.        # S
-00025300: 6565 204d 656d 6f72 7953 7461 7465 2066  ee MemoryState f
-00025310: 6f72 2064 6574 6169 6c73 0a20 2020 2020  or details.     
-00025320: 2020 206d 6178 5f6d 656d 6f72 795f 756e     max_memory_un
-00025330: 6d61 6e61 6765 645f 6f6c 645f 6869 7374  managed_old_hist
-00025340: 5f61 6765 203d 206c 6f63 616c 5f6e 6f77  _age = local_now
-00025350: 202d 2073 656c 662e 4d45 4d4f 5259 5f52   - self.MEMORY_R
-00025360: 4543 454e 545f 544f 5f4f 4c44 5f54 494d  ECENT_TO_OLD_TIM
-00025370: 450a 2020 2020 2020 2020 6d65 6d6f 7279  E.        memory
-00025380: 5f75 6e6d 616e 6167 6564 5f6f 6c64 203d  _unmanaged_old =
-00025390: 2077 732e 5f6d 656d 6f72 795f 756e 6d61   ws._memory_unma
-000253a0: 6e61 6765 645f 6f6c 640a 2020 2020 2020  naged_old.      
-000253b0: 2020 7768 696c 6520 7773 2e5f 6d65 6d6f    while ws._memo
-000253c0: 7279 5f75 6e6d 616e 6167 6564 5f68 6973  ry_unmanaged_his
-000253d0: 746f 7279 3a0a 2020 2020 2020 2020 2020  tory:.          
-000253e0: 2020 7469 6d65 7374 616d 702c 2073 697a    timestamp, siz
-000253f0: 6520 3d20 7773 2e5f 6d65 6d6f 7279 5f75  e = ws._memory_u
-00025400: 6e6d 616e 6167 6564 5f68 6973 746f 7279  nmanaged_history
-00025410: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-00025420: 6966 2074 696d 6573 7461 6d70 203e 3d20  if timestamp >= 
-00025430: 6d61 785f 6d65 6d6f 7279 5f75 6e6d 616e  max_memory_unman
-00025440: 6167 6564 5f6f 6c64 5f68 6973 745f 6167  aged_old_hist_ag
-00025450: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00025460: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
-00025470: 2020 2020 2077 732e 5f6d 656d 6f72 795f       ws._memory_
-00025480: 756e 6d61 6e61 6765 645f 6869 7374 6f72  unmanaged_histor
-00025490: 792e 706f 706c 6566 7428 290a 2020 2020  y.popleft().    
-000254a0: 2020 2020 2020 2020 6966 2073 697a 6520          if size 
-000254b0: 3d3d 206d 656d 6f72 795f 756e 6d61 6e61  == memory_unmana
-000254c0: 6765 645f 6f6c 643a 0a20 2020 2020 2020  ged_old:.       
-000254d0: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
-000254e0: 756e 6d61 6e61 6765 645f 6f6c 6420 3d20  unmanaged_old = 
-000254f0: 3020 2023 2072 6563 616c 6375 6c61 7465  0  # recalculate
-00025500: 206d 696e 2829 0a0a 2020 2020 2020 2020   min()..        
-00025510: 2320 7773 2e5f 6e62 7974 6573 2069 7320  # ws._nbytes is 
-00025520: 7570 6461 7465 6420 6174 2061 2064 6966  updated at a dif
-00025530: 6665 7265 6e74 2074 696d 6520 616e 6420  ferent time and 
-00025540: 7369 7a65 6f66 2829 206d 6179 206e 6f74  sizeof() may not
-00025550: 2062 6520 6163 6375 7261 7465 2c0a 2020   be accurate,.  
-00025560: 2020 2020 2020 2320 736f 2073 697a 6520        # so size 
-00025570: 6d61 7920 6265 2028 7465 6d70 6f72 6172  may be (temporar
-00025580: 696c 7929 206e 6567 6174 6976 653b 2066  ily) negative; f
-00025590: 6c6f 6f72 2069 7420 746f 207a 6572 6f2e  loor it to zero.
-000255a0: 0a20 2020 2020 2020 2073 697a 6520 3d20  .        size = 
-000255b0: 6d61 7828 0a20 2020 2020 2020 2020 2020  max(.           
-000255c0: 2030 2c20 6d65 7472 6963 735b 226d 656d   0, metrics["mem
-000255d0: 6f72 7922 5d20 2d20 7773 2e6e 6279 7465  ory"] - ws.nbyte
-000255e0: 7320 2b20 6d65 7472 6963 735b 2273 7069  s + metrics["spi
-000255f0: 6c6c 6564 5f62 7974 6573 225d 5b22 6d65  lled_bytes"]["me
-00025600: 6d6f 7279 225d 0a20 2020 2020 2020 2029  mory"].        )
-00025610: 0a0a 2020 2020 2020 2020 7773 2e5f 6d65  ..        ws._me
-00025620: 6d6f 7279 5f75 6e6d 616e 6167 6564 5f68  mory_unmanaged_h
-00025630: 6973 746f 7279 2e61 7070 656e 6428 286c  istory.append((l
-00025640: 6f63 616c 5f6e 6f77 2c20 7369 7a65 2929  ocal_now, size))
-00025650: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00025660: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
-00025670: 5f6f 6c64 3a0a 2020 2020 2020 2020 2020  _old:.          
-00025680: 2020 2320 5468 6520 776f 726b 6572 2068    # The worker h
-00025690: 6173 206a 7573 7420 6265 656e 2073 7461  as just been sta
-000256a0: 7274 6564 206f 7220 7468 6520 7072 6576  rted or the prev
-000256b0: 696f 7573 206d 696e 696d 756d 2068 6173  ious minimum has
-000256c0: 2062 6565 6e20 6578 7075 6e67 6564 0a20   been expunged. 
-000256d0: 2020 2020 2020 2020 2020 2023 2062 6563             # bec
-000256e0: 6175 7365 2074 6f6f 206f 6c64 2e0a 2020  ause too old..  
-000256f0: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
-00025700: 3a20 7468 6973 2061 6c67 6f72 6974 686d  : this algorithm
-00025710: 2069 7320 6361 7070 6564 2074 6f20 3230   is capped to 20
-00025720: 3020 2a20 4d45 4d4f 5259 5f52 4543 454e  0 * MEMORY_RECEN
-00025730: 545f 544f 5f4f 4c44 5f54 494d 4520 656c  T_TO_OLD_TIME el
-00025740: 656d 656e 7473 0a20 2020 2020 2020 2020  ements.         
-00025750: 2020 2023 2063 6c75 7374 6572 2d77 6964     # cluster-wid
-00025760: 6520 6279 2068 6561 7274 6265 6174 5f69  e by heartbeat_i
-00025770: 6e74 6572 7661 6c28 292c 2072 6567 6172  nterval(), regar
-00025780: 646c 6573 7320 6f66 2074 6865 206e 756d  dless of the num
-00025790: 6265 7220 6f66 2077 6f72 6b65 7273 0a20  ber of workers. 
-000257a0: 2020 2020 2020 2020 2020 2077 732e 5f6d             ws._m
-000257b0: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-000257c0: 6f6c 6420 3d20 6d69 6e28 6d61 7028 7365  old = min(map(se
-000257d0: 636f 6e64 2c20 7773 2e5f 6d65 6d6f 7279  cond, ws._memory
-000257e0: 5f75 6e6d 616e 6167 6564 5f68 6973 746f  _unmanaged_histo
-000257f0: 7279 2929 0a20 2020 2020 2020 2065 6c69  ry)).        eli
-00025800: 6620 7369 7a65 203c 206d 656d 6f72 795f  f size < memory_
-00025810: 756e 6d61 6e61 6765 645f 6f6c 643a 0a20  unmanaged_old:. 
-00025820: 2020 2020 2020 2020 2020 2077 732e 5f6d             ws._m
-00025830: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
-00025840: 6f6c 6420 3d20 7369 7a65 0a0a 2020 2020  old = size..    
-00025850: 2020 2020 6966 2068 6f73 745f 696e 666f      if host_info
-00025860: 3a0a 2020 2020 2020 2020 2020 2020 6468  :.            dh
-00025870: 203d 2073 656c 662e 686f 7374 5f69 6e66   = self.host_inf
-00025880: 6f2e 7365 7464 6566 6175 6c74 2868 6f73  o.setdefault(hos
-00025890: 742c 207b 7d29 0a20 2020 2020 2020 2020  t, {}).         
-000258a0: 2020 2064 682e 7570 6461 7465 2868 6f73     dh.update(hos
-000258b0: 745f 696e 666f 290a 0a20 2020 2020 2020  t_info)..       
-000258c0: 2069 6620 6e6f 773a 0a20 2020 2020 2020   if now:.       
-000258d0: 2020 2020 2077 732e 7469 6d65 5f64 656c       ws.time_del
-000258e0: 6179 203d 206c 6f63 616c 5f6e 6f77 202d  ay = local_now -
-000258f0: 206e 6f77 0a0a 2020 2020 2020 2020 6966   now..        if
-00025900: 2072 6573 6f75 7263 6573 3a0a 2020 2020   resources:.    
-00025910: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00025920: 5f72 6573 6f75 7263 6573 2877 6f72 6b65  _resources(worke
-00025930: 723d 6164 6472 6573 732c 2072 6573 6f75  r=address, resou
-00025940: 7263 6573 3d72 6573 6f75 7263 6573 290a  rces=resources).
-00025950: 0a20 2020 2020 2020 2069 6620 6578 7465  .        if exte
-00025960: 6e73 696f 6e73 3a0a 2020 2020 2020 2020  nsions:.        
-00025970: 2020 2020 666f 7220 6e61 6d65 2c20 6461      for name, da
-00025980: 7461 2069 6e20 6578 7465 6e73 696f 6e73  ta in extensions
-00025990: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-000259a0: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
-000259b0: 7874 656e 7369 6f6e 735b 6e61 6d65 5d2e  xtensions[name].
-000259c0: 6865 6172 7462 6561 7428 7773 2c20 6461  heartbeat(ws, da
-000259d0: 7461 290a 0a20 2020 2020 2020 2072 6574  ta)..        ret
-000259e0: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
-000259f0: 2020 2273 7461 7475 7322 3a20 224f 4b22    "status": "OK"
-00025a00: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
-00025a10: 696d 6522 3a20 6c6f 6361 6c5f 6e6f 772c  ime": local_now,
-00025a20: 0a20 2020 2020 2020 2020 2020 2022 6865  .            "he
-00025a30: 6172 7462 6561 742d 696e 7465 7276 616c  artbeat-interval
-00025a40: 223a 2068 6561 7274 6265 6174 5f69 6e74  ": heartbeat_int
-00025a50: 6572 7661 6c28 6c65 6e28 7365 6c66 2e77  erval(len(self.w
-00025a60: 6f72 6b65 7273 2929 2c0a 2020 2020 2020  orkers)),.      
-00025a70: 2020 7d0a 0a20 2020 2040 6c6f 675f 6572    }..    @log_er
-00025a80: 726f 7273 0a20 2020 2061 7379 6e63 2064  rors.    async d
-00025a90: 6566 2061 6464 5f77 6f72 6b65 7228 0a20  ef add_worker(. 
-00025aa0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00025ab0: 2020 2020 2063 6f6d 6d3a 2043 6f6d 6d2c       comm: Comm,
-00025ac0: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
-00025ad0: 2020 2020 6164 6472 6573 733a 2073 7472      address: str
-00025ae0: 2c0a 2020 2020 2020 2020 7374 6174 7573  ,.        status
-00025af0: 3a20 7374 722c 0a20 2020 2020 2020 2073  : str,.        s
-00025b00: 6572 7665 725f 6964 3a20 7374 722c 0a20  erver_id: str,. 
-00025b10: 2020 2020 2020 206e 7468 7265 6164 733a         nthreads:
-00025b20: 2069 6e74 2c0a 2020 2020 2020 2020 6e61   int,.        na
-00025b30: 6d65 3a20 7374 722c 0a20 2020 2020 2020  me: str,.       
-00025b40: 2072 6573 6f6c 7665 5f61 6464 7265 7373   resolve_address
-00025b50: 3a20 626f 6f6c 203d 2054 7275 652c 0a20  : bool = True,. 
-00025b60: 2020 2020 2020 206e 6f77 3a20 666c 6f61         now: floa
-00025b70: 742c 0a20 2020 2020 2020 2072 6573 6f75  t,.        resou
-00025b80: 7263 6573 3a20 6469 6374 5b73 7472 2c20  rces: dict[str, 
-00025b90: 666c 6f61 745d 2c0a 2020 2020 2020 2020  float],.        
-00025ba0: 2320 4649 584d 453a 2054 6869 7320 6973  # FIXME: This is
-00025bb0: 206e 6576 6572 2073 7562 6d69 7474 6564   never submitted
-00025bc0: 2062 7920 7468 6520 776f 726b 6572 0a20   by the worker. 
-00025bd0: 2020 2020 2020 2068 6f73 745f 696e 666f         host_info
-00025be0: 3a20 4e6f 6e65 203d 204e 6f6e 652c 0a20  : None = None,. 
-00025bf0: 2020 2020 2020 206d 656d 6f72 795f 6c69         memory_li
-00025c00: 6d69 743a 2069 6e74 207c 204e 6f6e 652c  mit: int | None,
-00025c10: 0a20 2020 2020 2020 206d 6574 7269 6373  .        metrics
-00025c20: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
-00025c30: 2c0a 2020 2020 2020 2020 7069 643a 2069  ,.        pid: i
-00025c40: 6e74 203d 2030 2c0a 2020 2020 2020 2020  nt = 0,.        
-00025c50: 7365 7276 6963 6573 3a20 6469 6374 5b73  services: dict[s
-00025c60: 7472 2c20 696e 745d 2c0a 2020 2020 2020  tr, int],.      
-00025c70: 2020 6c6f 6361 6c5f 6469 7265 6374 6f72    local_director
-00025c80: 793a 2073 7472 2c0a 2020 2020 2020 2020  y: str,.        
-00025c90: 7665 7273 696f 6e73 3a20 6469 6374 5b73  versions: dict[s
-00025ca0: 7472 2c20 416e 795d 2c0a 2020 2020 2020  tr, Any],.      
-00025cb0: 2020 6e61 6e6e 793a 2073 7472 2c0a 2020    nanny: str,.  
-00025cc0: 2020 2020 2020 6578 7472 613a 2064 6963        extra: dic
-00025cd0: 742c 0a20 2020 2020 2020 2073 7469 6d75  t,.        stimu
-00025ce0: 6c75 735f 6964 3a20 7374 722c 0a20 2020  lus_id: str,.   
-00025cf0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00025d00: 2020 2020 2222 2241 6464 2061 206e 6577      """Add a new
-00025d10: 2077 6f72 6b65 7220 746f 2074 6865 2063   worker to the c
-00025d20: 6c75 7374 6572 2222 220a 2020 2020 2020  luster""".      
-00025d30: 2020 6164 6472 6573 7320 3d20 7365 6c66    address = self
-00025d40: 2e63 6f65 7263 655f 6164 6472 6573 7328  .coerce_address(
-00025d50: 6164 6472 6573 732c 2072 6573 6f6c 7665  address, resolve
-00025d60: 5f61 6464 7265 7373 290a 2020 2020 2020  _address).      
-00025d70: 2020 6164 6472 6573 7320 3d20 6e6f 726d    address = norm
-00025d80: 616c 697a 655f 6164 6472 6573 7328 6164  alize_address(ad
-00025d90: 6472 6573 7329 0a20 2020 2020 2020 2068  dress).        h
-00025da0: 6f73 7420 3d20 6765 745f 6164 6472 6573  ost = get_addres
-00025db0: 735f 686f 7374 2861 6464 7265 7373 290a  s_host(address).
-00025dc0: 0a20 2020 2020 2020 2069 6620 6164 6472  .        if addr
-00025dd0: 6573 7320 696e 2073 656c 662e 776f 726b  ess in self.work
-00025de0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-00025df0: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-00025e00: 7228 2257 6f72 6b65 7220 616c 7265 6164  r("Worker alread
-00025e10: 7920 6578 6973 7473 2025 7322 2025 2061  y exists %s" % a
-00025e20: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
-00025e30: 2069 6620 6e61 6d65 2069 6e20 7365 6c66   if name in self
-00025e40: 2e61 6c69 6173 6573 3a0a 2020 2020 2020  .aliases:.      
-00025e50: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
-00025e60: 6e69 6e67 2822 576f 726b 6572 2074 7269  ning("Worker tri
-00025e70: 6564 2074 6f20 636f 6e6e 6563 7420 7769  ed to connect wi
-00025e80: 7468 2061 2064 7570 6c69 6361 7465 206e  th a duplicate n
-00025e90: 616d 653a 2025 7322 2c20 6e61 6d65 290a  ame: %s", name).
-00025ea0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
-00025eb0: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
-00025ec0: 2020 2020 2273 7461 7475 7322 3a20 2265      "status": "e
-00025ed0: 7272 6f72 222c 0a20 2020 2020 2020 2020  rror",.         
-00025ee0: 2020 2020 2020 2022 6d65 7373 6167 6522         "message"
-00025ef0: 3a20 226e 616d 6520 7461 6b65 6e2c 2025  : "name taken, %
-00025f00: 7322 2025 206e 616d 652c 0a20 2020 2020  s" % name,.     
-00025f10: 2020 2020 2020 2020 2020 2022 7469 6d65             "time
-00025f20: 223a 2074 696d 6528 292c 0a20 2020 2020  ": time(),.     
-00025f30: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-00025f40: 2020 2020 2061 7761 6974 2063 6f6d 6d2e       await comm.
-00025f50: 7772 6974 6528 6d73 6729 0a20 2020 2020  write(msg).     
-00025f60: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
-00025f70: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
-00025f80: 6576 656e 7428 6164 6472 6573 732c 207b  event(address, {
-00025f90: 2261 6374 696f 6e22 3a20 2261 6464 2d77  "action": "add-w
-00025fa0: 6f72 6b65 7222 7d29 0a20 2020 2020 2020  orker"}).       
-00025fb0: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-00025fc0: 2261 6c6c 222c 207b 2261 6374 696f 6e22  "all", {"action"
-00025fd0: 3a20 2261 6464 2d77 6f72 6b65 7222 2c20  : "add-worker", 
-00025fe0: 2277 6f72 6b65 7222 3a20 6164 6472 6573  "worker": addres
-00025ff0: 737d 290a 0a20 2020 2020 2020 2073 656c  s})..        sel
-00026000: 662e 776f 726b 6572 735b 6164 6472 6573  f.workers[addres
-00026010: 735d 203d 2077 7320 3d20 576f 726b 6572  s] = ws = Worker
-00026020: 5374 6174 6528 0a20 2020 2020 2020 2020  State(.         
-00026030: 2020 2061 6464 7265 7373 3d61 6464 7265     address=addre
-00026040: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
-00026050: 7374 6174 7573 3d53 7461 7475 732e 6c6f  status=Status.lo
-00026060: 6f6b 7570 5b73 7461 7475 735d 2c20 2023  okup[status],  #
-00026070: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
-00026080: 2020 2020 2020 2020 2020 7069 643d 7069            pid=pi
-00026090: 642c 0a20 2020 2020 2020 2020 2020 206e  d,.            n
-000260a0: 7468 7265 6164 733d 6e74 6872 6561 6473  threads=nthreads
-000260b0: 2c0a 2020 2020 2020 2020 2020 2020 6d65  ,.            me
-000260c0: 6d6f 7279 5f6c 696d 6974 3d6d 656d 6f72  mory_limit=memor
-000260d0: 795f 6c69 6d69 7420 6f72 2030 2c0a 2020  y_limit or 0,.  
-000260e0: 2020 2020 2020 2020 2020 6e61 6d65 3d6e            name=n
-000260f0: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-00026100: 206c 6f63 616c 5f64 6972 6563 746f 7279   local_directory
-00026110: 3d6c 6f63 616c 5f64 6972 6563 746f 7279  =local_directory
-00026120: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
-00026130: 7276 6963 6573 3d73 6572 7669 6365 732c  rvices=services,
-00026140: 0a20 2020 2020 2020 2020 2020 2076 6572  .            ver
-00026150: 7369 6f6e 733d 7665 7273 696f 6e73 2c0a  sions=versions,.
-00026160: 2020 2020 2020 2020 2020 2020 6e61 6e6e              nann
-00026170: 793d 6e61 6e6e 792c 0a20 2020 2020 2020  y=nanny,.       
-00026180: 2020 2020 2065 7874 7261 3d65 7874 7261       extra=extra
-00026190: 2c0a 2020 2020 2020 2020 2020 2020 7365  ,.            se
-000261a0: 7276 6572 5f69 643d 7365 7276 6572 5f69  rver_id=server_i
-000261b0: 642c 0a20 2020 2020 2020 2020 2020 2073  d,.            s
-000261c0: 6368 6564 756c 6572 3d73 656c 662c 0a20  cheduler=self,. 
-000261d0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000261e0: 2069 6620 7773 2e73 7461 7475 7320 3d3d   if ws.status ==
-000261f0: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
-00026200: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00026210: 662e 7275 6e6e 696e 672e 6164 6428 7773  f.running.add(ws
-00026220: 290a 0a20 2020 2020 2020 2064 6820 3d20  )..        dh = 
-00026230: 7365 6c66 2e68 6f73 745f 696e 666f 2e67  self.host_info.g
-00026240: 6574 2868 6f73 7429 0a20 2020 2020 2020  et(host).       
-00026250: 2069 6620 6468 2069 7320 4e6f 6e65 3a0a   if dh is None:.
-00026260: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00026270: 2e68 6f73 745f 696e 666f 5b68 6f73 745d  .host_info[host]
-00026280: 203d 2064 6820 3d20 7b7d 0a0a 2020 2020   = dh = {}..    
-00026290: 2020 2020 6468 5f61 6464 7265 7373 6573      dh_addresses
-000262a0: 203d 2064 682e 6765 7428 2261 6464 7265   = dh.get("addre
-000262b0: 7373 6573 2229 0a20 2020 2020 2020 2069  sses").        i
-000262c0: 6620 6468 5f61 6464 7265 7373 6573 2069  f dh_addresses i
-000262d0: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-000262e0: 2020 2020 6468 5b22 6164 6472 6573 7365      dh["addresse
-000262f0: 7322 5d20 3d20 6468 5f61 6464 7265 7373  s"] = dh_address
-00026300: 6573 203d 2073 6574 2829 0a20 2020 2020  es = set().     
-00026310: 2020 2020 2020 2064 685b 226e 7468 7265         dh["nthre
-00026320: 6164 7322 5d20 3d20 300a 0a20 2020 2020  ads"] = 0..     
-00026330: 2020 2064 685f 6164 6472 6573 7365 732e     dh_addresses.
-00026340: 6164 6428 6164 6472 6573 7329 0a20 2020  add(address).   
-00026350: 2020 2020 2064 685b 226e 7468 7265 6164       dh["nthread
-00026360: 7322 5d20 2b3d 206e 7468 7265 6164 730a  s"] += nthreads.
-00026370: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
-00026380: 7461 6c5f 6e74 6872 6561 6473 202b 3d20  tal_nthreads += 
-00026390: 6e74 6872 6561 6473 0a20 2020 2020 2020  nthreads.       
-000263a0: 2073 656c 662e 746f 7461 6c5f 6e74 6872   self.total_nthr
-000263b0: 6561 6473 5f68 6973 746f 7279 2e61 7070  eads_history.app
-000263c0: 656e 6428 2874 696d 6528 292c 2073 656c  end((time(), sel
-000263d0: 662e 746f 7461 6c5f 6e74 6872 6561 6473  f.total_nthreads
-000263e0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-000263f0: 616c 6961 7365 735b 6e61 6d65 5d20 3d20  aliases[name] = 
-00026400: 6164 6472 6573 730a 0a20 2020 2020 2020  address..       
-00026410: 2073 656c 662e 6865 6172 7462 6561 745f   self.heartbeat_
-00026420: 776f 726b 6572 280a 2020 2020 2020 2020  worker(.        
-00026430: 2020 2020 6164 6472 6573 733d 6164 6472      address=addr
-00026440: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
-00026450: 2072 6573 6f6c 7665 5f61 6464 7265 7373   resolve_address
-00026460: 3d72 6573 6f6c 7665 5f61 6464 7265 7373  =resolve_address
-00026470: 2c0a 2020 2020 2020 2020 2020 2020 6e6f  ,.            no
-00026480: 773d 6e6f 772c 0a20 2020 2020 2020 2020  w=now,.         
-00026490: 2020 2072 6573 6f75 7263 6573 3d72 6573     resources=res
-000264a0: 6f75 7263 6573 2c0a 2020 2020 2020 2020  ources,.        
-000264b0: 2020 2020 686f 7374 5f69 6e66 6f3d 686f      host_info=ho
-000264c0: 7374 5f69 6e66 6f2c 0a20 2020 2020 2020  st_info,.       
-000264d0: 2020 2020 206d 6574 7269 6373 3d6d 6574       metrics=met
-000264e0: 7269 6373 2c0a 2020 2020 2020 2020 290a  rics,.        ).
-000264f0: 0a20 2020 2020 2020 2023 2044 6f20 6e6f  .        # Do no
-00026500: 7420 6e65 6564 2074 6f20 6164 6a75 7374  t need to adjust
-00026510: 2073 656c 662e 746f 7461 6c5f 6f63 6375   self.total_occu
-00026520: 7061 6e63 7920 6173 2073 656c 662e 6f63  pancy as self.oc
-00026530: 6375 7061 6e63 795b 7773 5d20 6361 6e6e  cupancy[ws] cann
-00026540: 6f74 0a20 2020 2020 2020 2023 2065 7869  ot.        # exi
-00026550: 7374 2062 6566 6f72 6520 7468 6973 2e0a  st before this..
-00026560: 2020 2020 2020 2020 7365 6c66 2e63 6865          self.che
-00026570: 636b 5f69 646c 655f 7361 7475 7261 7465  ck_idle_saturate
-00026580: 6428 7773 290a 0a20 2020 2020 2020 2073  d(ws)..        s
-00026590: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
-000265a0: 5b61 6464 7265 7373 5d20 3d20 4261 7463  [address] = Batc
-000265b0: 6865 6453 656e 6428 696e 7465 7276 616c  hedSend(interval
-000265c0: 3d22 356d 7322 2c20 6c6f 6f70 3d73 656c  ="5ms", loop=sel
-000265d0: 662e 6c6f 6f70 290a 0a20 2020 2020 2020  f.loop)..       
-000265e0: 2061 7761 6974 6162 6c65 7320 3d20 5b5d   awaitables = []
-000265f0: 0a20 2020 2020 2020 2066 6f72 2070 6c75  .        for plu
-00026600: 6769 6e20 696e 206c 6973 7428 7365 6c66  gin in list(self
-00026610: 2e70 6c75 6769 6e73 2e76 616c 7565 7328  .plugins.values(
-00026620: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00026630: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00026640: 2020 2020 2072 6573 756c 7420 3d20 706c       result = pl
-00026650: 7567 696e 2e61 6464 5f77 6f72 6b65 7228  ugin.add_worker(
-00026660: 7363 6865 6475 6c65 723d 7365 6c66 2c20  scheduler=self, 
-00026670: 776f 726b 6572 3d61 6464 7265 7373 290a  worker=address).
-00026680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026690: 6966 2072 6573 756c 7420 6973 206e 6f74  if result is not
-000266a0: 204e 6f6e 6520 616e 6420 696e 7370 6563   None and inspec
-000266b0: 742e 6973 6177 6169 7461 626c 6528 7265  t.isawaitable(re
-000266c0: 7375 6c74 293a 0a20 2020 2020 2020 2020  sult):.         
-000266d0: 2020 2020 2020 2020 2020 2061 7761 6974             await
-000266e0: 6162 6c65 732e 6170 7065 6e64 2872 6573  ables.append(res
-000266f0: 756c 7429 0a20 2020 2020 2020 2020 2020  ult).           
-00026700: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00026710: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-00026720: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-00026730: 7863 6570 7469 6f6e 2865 290a 0a20 2020  xception(e)..   
-00026740: 2020 2020 2070 6c75 6769 6e5f 6d73 6773       plugin_msgs
-00026750: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
-00026760: 2e67 6174 6865 7228 2a61 7761 6974 6162  .gather(*awaitab
-00026770: 6c65 732c 2072 6574 7572 6e5f 6578 6365  les, return_exce
-00026780: 7074 696f 6e73 3d54 7275 6529 0a20 2020  ptions=True).   
-00026790: 2020 2020 2070 6c75 6769 6e73 5f65 7863       plugins_exc
-000267a0: 6570 7469 6f6e 7320 3d20 5b6d 7367 2066  eptions = [msg f
-000267b0: 6f72 206d 7367 2069 6e20 706c 7567 696e  or msg in plugin
-000267c0: 5f6d 7367 7320 6966 2069 7369 6e73 7461  _msgs if isinsta
-000267d0: 6e63 6528 6d73 672c 2045 7863 6570 7469  nce(msg, Excepti
-000267e0: 6f6e 295d 0a20 2020 2020 2020 2066 6f72  on)].        for
-000267f0: 2065 7863 2069 6e20 706c 7567 696e 735f   exc in plugins_
-00026800: 6578 6365 7074 696f 6e73 3a0a 2020 2020  exceptions:.    
-00026810: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-00026820: 7863 6570 7469 6f6e 2865 7863 2c20 6578  xception(exc, ex
-00026830: 635f 696e 666f 3d65 7863 290a 0a20 2020  c_info=exc)..   
-00026840: 2020 2020 2069 6620 7773 2e73 7461 7475       if ws.statu
-00026850: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-00026860: 696e 673a 0a20 2020 2020 2020 2020 2020  ing:.           
-00026870: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-00026880: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00026890: 2020 2073 656c 662e 6275 6c6b 5f73 6368     self.bulk_sch
-000268a0: 6564 756c 655f 756e 7275 6e6e 6162 6c65  edule_unrunnable
-000268b0: 5f61 6674 6572 5f61 6464 696e 675f 776f  _after_adding_wo
-000268c0: 726b 6572 2877 7329 2c20 7374 696d 756c  rker(ws), stimul
-000268d0: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
-000268e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000268f0: 7365 6c66 2e73 7469 6d75 6c75 735f 7175  self.stimulus_qu
-00026900: 6575 655f 736c 6f74 735f 6d61 7962 655f  eue_slots_maybe_
-00026910: 6f70 656e 6564 2873 7469 6d75 6c75 735f  opened(stimulus_
-00026920: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
-00026930: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
-00026940: 696e 666f 2822 5265 6769 7374 6572 2077  info("Register w
-00026950: 6f72 6b65 7220 2573 222c 2077 7329 0a0a  orker %s", ws)..
-00026960: 2020 2020 2020 2020 6d73 6720 3d20 7b0a          msg = {.
-00026970: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-00026980: 7475 7322 3a20 224f 4b22 2c0a 2020 2020  tus": "OK",.    
-00026990: 2020 2020 2020 2020 2274 696d 6522 3a20          "time": 
-000269a0: 7469 6d65 2829 2c0a 2020 2020 2020 2020  time(),.        
-000269b0: 2020 2020 2268 6561 7274 6265 6174 2d69      "heartbeat-i
-000269c0: 6e74 6572 7661 6c22 3a20 6865 6172 7462  nterval": heartb
-000269d0: 6561 745f 696e 7465 7276 616c 286c 656e  eat_interval(len
-000269e0: 2873 656c 662e 776f 726b 6572 7329 292c  (self.workers)),
-000269f0: 0a20 2020 2020 2020 2020 2020 2022 776f  .            "wo
-00026a00: 726b 6572 2d70 6c75 6769 6e73 223a 2073  rker-plugins": s
-00026a10: 656c 662e 776f 726b 6572 5f70 6c75 6769  elf.worker_plugi
-00026a20: 6e73 2c0a 2020 2020 2020 2020 7d0a 0a20  ns,.        }.. 
-00026a30: 2020 2020 2020 2076 6572 7369 6f6e 5f77         version_w
-00026a40: 6172 6e69 6e67 203d 2076 6572 7369 6f6e  arning = version
-00026a50: 5f6d 6f64 756c 652e 6572 726f 725f 6d65  _module.error_me
-00026a60: 7373 6167 6528 0a20 2020 2020 2020 2020  ssage(.         
-00026a70: 2020 2076 6572 7369 6f6e 5f6d 6f64 756c     version_modul
-00026a80: 652e 6765 745f 7665 7273 696f 6e73 2829  e.get_versions()
-00026a90: 2c0a 2020 2020 2020 2020 2020 2020 7b77  ,.            {w
-00026aa0: 3a20 7773 2e76 6572 7369 6f6e 7320 666f  : ws.versions fo
-00026ab0: 7220 772c 2077 7320 696e 2073 656c 662e  r w, ws in self.
-00026ac0: 776f 726b 6572 732e 6974 656d 7328 297d  workers.items()}
-00026ad0: 2c0a 2020 2020 2020 2020 2020 2020 7665  ,.            ve
-00026ae0: 7273 696f 6e73 2c0a 2020 2020 2020 2020  rsions,.        
-00026af0: 2020 2020 736f 7572 6365 5f6e 616d 653d      source_name=
-00026b00: 7374 7228 7773 2e73 6572 7665 725f 6964  str(ws.server_id
-00026b10: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
-00026b20: 2020 2020 206d 7367 2e75 7064 6174 6528       msg.update(
-00026b30: 7665 7273 696f 6e5f 7761 726e 696e 6729  version_warning)
-00026b40: 0a0a 2020 2020 2020 2020 6177 6169 7420  ..        await 
-00026b50: 636f 6d6d 2e77 7269 7465 286d 7367 290a  comm.write(msg).
-00026b60: 2020 2020 2020 2020 2320 5468 6973 2077          # This w
-00026b70: 696c 6c20 6b65 6570 2072 756e 6e69 6e67  ill keep running
-00026b80: 2075 6e74 696c 2074 6865 2077 6f72 6b65   until the worke
-00026b90: 7220 6973 2072 656d 6f76 6564 0a20 2020  r is removed.   
-00026ba0: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
-00026bb0: 6861 6e64 6c65 5f77 6f72 6b65 7228 636f  handle_worker(co
-00026bc0: 6d6d 2c20 6164 6472 6573 7329 0a0a 2020  mm, address)..  
-00026bd0: 2020 6173 796e 6320 6465 6620 6164 645f    async def add_
-00026be0: 6e61 6e6e 7928 7365 6c66 2c20 636f 6d6d  nanny(self, comm
-00026bf0: 3a20 436f 6d6d 2c20 6164 6472 6573 733a  : Comm, address:
-00026c00: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-00026c10: 2020 2020 2020 2061 7379 6e63 2077 6974         async wit
-00026c20: 6820 7365 6c66 2e5f 7374 6172 7469 6e67  h self._starting
-00026c30: 5f6e 616e 6e69 6573 5f63 6f6e 643a 0a20  _nannies_cond:. 
-00026c40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00026c50: 5f73 7461 7274 696e 675f 6e61 6e6e 6965  _starting_nannie
-00026c60: 732e 6164 6428 6164 6472 6573 7329 0a20  s.add(address). 
-00026c70: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00026c80: 2020 2020 2020 2020 6d73 6720 3d20 7b0a          msg = {.
-00026c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026ca0: 2273 7461 7475 7322 3a20 224f 4b22 2c0a  "status": "OK",.
-00026cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026cc0: 226e 616e 6e79 2d70 6c75 6769 6e73 223a  "nanny-plugins":
-00026cd0: 2073 656c 662e 6e61 6e6e 795f 706c 7567   self.nanny_plug
-00026ce0: 696e 732c 0a20 2020 2020 2020 2020 2020  ins,.           
-00026cf0: 207d 0a20 2020 2020 2020 2020 2020 2061   }.            a
-00026d00: 7761 6974 2063 6f6d 6d2e 7772 6974 6528  wait comm.write(
-00026d10: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-00026d20: 2061 7761 6974 2063 6f6d 6d2e 7265 6164   await comm.read
-00026d30: 2829 0a20 2020 2020 2020 2066 696e 616c  ().        final
-00026d40: 6c79 3a0a 2020 2020 2020 2020 2020 2020  ly:.            
-00026d50: 6173 796e 6320 7769 7468 2073 656c 662e  async with self.
-00026d60: 5f73 7461 7274 696e 675f 6e61 6e6e 6965  _starting_nannie
-00026d70: 735f 636f 6e64 3a0a 2020 2020 2020 2020  s_cond:.        
-00026d80: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
-00026d90: 6172 7469 6e67 5f6e 616e 6e69 6573 2e64  arting_nannies.d
-00026da0: 6973 6361 7264 2861 6464 7265 7373 290a  iscard(address).
+000205c0: 2020 2020 2020 2020 2020 2020 2261 6c6c              "all
+000205d0: 6f77 5f72 656d 6f74 655f 6163 6365 7373  ow_remote_access
+000205e0: 223a 2054 7275 652c 0a20 2020 2020 2020  ": True,.       
+000205f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020600: 207d 0a20 2020 2020 2020 2020 2020 2020   }.             
+00020610: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+00020620: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00020630: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00020640: 2020 2020 206a 2e69 6e69 7469 616c 697a       j.initializ
+00020650: 6528 0a20 2020 2020 2020 2020 2020 2020  e(.             
+00020660: 2020 206e 6577 5f68 7474 7073 6572 7665     new_httpserve
+00020670: 723d 4661 6c73 652c 0a20 2020 2020 2020  r=False,.       
+00020680: 2020 2020 2020 2020 2061 7267 763d 5b5d           argv=[]
+00020690: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+000206a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000206b0: 2e5f 6a75 7079 7465 725f 7365 7276 6572  ._jupyter_server
+000206c0: 5f61 7070 6c69 6361 7469 6f6e 203d 206a  _application = j
+000206d0: 0a20 2020 2020 2020 2020 2020 2073 6875  .            shu
+000206e0: 7464 6f77 6e5f 6170 7020 3d20 746f 726e  tdown_app = torn
+000206f0: 6164 6f2e 7765 622e 4170 706c 6963 6174  ado.web.Applicat
+00020700: 696f 6e28 0a20 2020 2020 2020 2020 2020  ion(.           
+00020710: 2020 2020 205b 2872 222f 6a75 7079 7465       [(r"/jupyte
+00020720: 722f 6170 692f 7368 7574 646f 776e 222c  r/api/shutdown",
+00020730: 2053 6875 7464 6f77 6e48 616e 646c 6572   ShutdownHandler
+00020740: 295d 0a20 2020 2020 2020 2020 2020 2029  )].            )
+00020750: 0a20 2020 2020 2020 2020 2020 2073 6875  .            shu
+00020760: 7464 6f77 6e5f 6170 702e 7365 7474 696e  tdown_app.settin
+00020770: 6773 203d 206a 2e77 6562 5f61 7070 2e73  gs = j.web_app.s
+00020780: 6574 7469 6e67 730a 2020 2020 2020 2020  ettings.        
+00020790: 2020 2020 7365 6c66 2e68 7474 705f 6170      self.http_ap
+000207a0: 706c 6963 6174 696f 6e2e 6164 645f 6170  plication.add_ap
+000207b0: 706c 6963 6174 696f 6e28 7368 7574 646f  plication(shutdo
+000207c0: 776e 5f61 7070 290a 2020 2020 2020 2020  wn_app).        
+000207d0: 2020 2020 7365 6c66 2e68 7474 705f 6170      self.http_ap
+000207e0: 706c 6963 6174 696f 6e2e 6164 645f 6170  plication.add_ap
+000207f0: 706c 6963 6174 696f 6e28 6a2e 7765 625f  plication(j.web_
+00020800: 6170 7029 0a0a 2020 2020 2020 2020 2320  app)..        # 
+00020810: 436f 6d6d 756e 6963 6174 696f 6e20 7374  Communication st
+00020820: 6174 650a 2020 2020 2020 2020 7365 6c66  ate.        self
+00020830: 2e63 6c69 656e 745f 636f 6d6d 7320 3d20  .client_comms = 
+00020840: 7b7d 0a20 2020 2020 2020 2073 656c 662e  {}.        self.
+00020850: 7374 7265 616d 5f63 6f6d 6d73 203d 207b  stream_comms = {
+00020860: 7d0a 0a20 2020 2020 2020 2023 2054 6173  }..        # Tas
+00020870: 6b20 7374 6174 650a 2020 2020 2020 2020  k state.        
+00020880: 7461 736b 7320 3d20 7b7d 0a0a 2020 2020  tasks = {}..    
+00020890: 2020 2020 7365 6c66 2e67 656e 6572 6174      self.generat
+000208a0: 696f 6e20 3d20 300a 2020 2020 2020 2020  ion = 0.        
+000208b0: 7365 6c66 2e5f 6c61 7374 5f63 6c69 656e  self._last_clien
+000208c0: 7420 3d20 4e6f 6e65 0a20 2020 2020 2020  t = None.       
+000208d0: 2073 656c 662e 5f6c 6173 745f 7469 6d65   self._last_time
+000208e0: 203d 2030 0a20 2020 2020 2020 2075 6e72   = 0.        unr
+000208f0: 756e 6e61 626c 6520 3d20 7365 7428 290a  unnable = set().
+00020900: 2020 2020 2020 2020 7175 6575 6564 203d          queued =
+00020910: 2048 6561 7053 6574 286b 6579 3d6f 7065   HeapSet(key=ope
+00020920: 7261 746f 722e 6174 7472 6765 7474 6572  rator.attrgetter
+00020930: 2822 7072 696f 7269 7479 2229 290a 0a20  ("priority")).. 
+00020940: 2020 2020 2020 2073 656c 662e 6461 7461         self.data
+00020950: 7365 7473 203d 207b 7d0a 0a20 2020 2020  sets = {}..     
+00020960: 2020 2023 2050 7265 6669 782d 6b65 7965     # Prefix-keye
+00020970: 6420 636f 6e74 6169 6e65 7273 0a0a 2020  d containers..  
+00020980: 2020 2020 2020 2320 436c 6965 6e74 2073        # Client s
+00020990: 7461 7465 0a20 2020 2020 2020 2063 6c69  tate.        cli
+000209a0: 656e 7473 203d 207b 7d0a 0a20 2020 2020  ents = {}..     
+000209b0: 2020 2023 2057 6f72 6b65 7220 7374 6174     # Worker stat
+000209c0: 650a 2020 2020 2020 2020 776f 726b 6572  e.        worker
+000209d0: 7320 3d20 536f 7274 6564 4469 6374 2829  s = SortedDict()
+000209e0: 0a0a 2020 2020 2020 2020 686f 7374 5f69  ..        host_i
+000209f0: 6e66 6f20 3d20 7b7d 0a20 2020 2020 2020  nfo = {}.       
+00020a00: 2072 6573 6f75 7263 6573 203d 207b 7d0a   resources = {}.
+00020a10: 2020 2020 2020 2020 616c 6961 7365 7320          aliases 
+00020a20: 3d20 7b7d 0a0a 2020 2020 2020 2020 7365  = {}..        se
+00020a30: 6c66 2e5f 776f 726b 6572 5f63 6f6c 6c65  lf._worker_colle
+00020a40: 6374 696f 6e73 203d 205b 0a20 2020 2020  ctions = [.     
+00020a50: 2020 2020 2020 2077 6f72 6b65 7273 2c0a         workers,.
+00020a60: 2020 2020 2020 2020 2020 2020 686f 7374              host
+00020a70: 5f69 6e66 6f2c 0a20 2020 2020 2020 2020  _info,.         
+00020a80: 2020 2072 6573 6f75 7263 6573 2c0a 2020     resources,.  
+00020a90: 2020 2020 2020 2020 2020 616c 6961 7365            aliase
+00020aa0: 732c 0a20 2020 2020 2020 205d 0a0a 2020  s,.        ]..  
+00020ab0: 2020 2020 2020 6d61 786c 656e 203d 2064        maxlen = d
+00020ac0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+00020ad0: 6469 7374 7269 6275 7465 642e 6164 6d69  distributed.admi
+00020ae0: 6e2e 6c6f 772d 6c65 7665 6c2d 6c6f 672d  n.low-level-log-
+00020af0: 6c65 6e67 7468 2229 0a20 2020 2020 2020  length").       
+00020b00: 2073 656c 662e 6576 656e 7473 203d 2064   self.events = d
+00020b10: 6566 6175 6c74 6469 6374 2870 6172 7469  efaultdict(parti
+00020b20: 616c 2864 6571 7565 2c20 6d61 786c 656e  al(deque, maxlen
+00020b30: 3d6d 6178 6c65 6e29 290a 2020 2020 2020  =maxlen)).      
+00020b40: 2020 7365 6c66 2e65 7665 6e74 5f63 6f75    self.event_cou
+00020b50: 6e74 7320 3d20 6465 6661 756c 7464 6963  nts = defaultdic
+00020b60: 7428 696e 7429 0a20 2020 2020 2020 2073  t(int).        s
+00020b70: 656c 662e 6576 656e 745f 7375 6273 6372  elf.event_subscr
+00020b80: 6962 6572 203d 2064 6566 6175 6c74 6469  iber = defaultdi
+00020b90: 6374 2873 6574 290a 2020 2020 2020 2020  ct(set).        
+00020ba0: 7365 6c66 2e77 6f72 6b65 725f 706c 7567  self.worker_plug
+00020bb0: 696e 7320 3d20 7b7d 0a20 2020 2020 2020  ins = {}.       
+00020bc0: 2073 656c 662e 6e61 6e6e 795f 706c 7567   self.nanny_plug
+00020bd0: 696e 7320 3d20 7b7d 0a20 2020 2020 2020  ins = {}.       
+00020be0: 2073 656c 662e 5f73 7461 7274 696e 675f   self._starting_
+00020bf0: 6e61 6e6e 6965 7320 3d20 7365 7428 290a  nannies = set().
+00020c00: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
+00020c10: 6172 7469 6e67 5f6e 616e 6e69 6573 5f63  arting_nannies_c
+00020c20: 6f6e 6420 3d20 6173 796e 6369 6f2e 436f  ond = asyncio.Co
+00020c30: 6e64 6974 696f 6e28 290a 0a20 2020 2020  ndition()..     
+00020c40: 2020 2077 6f72 6b65 725f 6861 6e64 6c65     worker_handle
+00020c50: 7273 203d 207b 0a20 2020 2020 2020 2020  rs = {.         
+00020c60: 2020 2022 7461 736b 2d66 696e 6973 6865     "task-finishe
+00020c70: 6422 3a20 7365 6c66 2e68 616e 646c 655f  d": self.handle_
+00020c80: 7461 736b 5f66 696e 6973 6865 642c 0a20  task_finished,. 
+00020c90: 2020 2020 2020 2020 2020 2022 7461 736b             "task
+00020ca0: 2d65 7272 6564 223a 2073 656c 662e 6861  -erred": self.ha
+00020cb0: 6e64 6c65 5f74 6173 6b5f 6572 7265 642c  ndle_task_erred,
+00020cc0: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+00020cd0: 6c65 6173 652d 776f 726b 6572 2d64 6174  lease-worker-dat
+00020ce0: 6122 3a20 7365 6c66 2e72 656c 6561 7365  a": self.release
+00020cf0: 5f77 6f72 6b65 725f 6461 7461 2c0a 2020  _worker_data,.  
+00020d00: 2020 2020 2020 2020 2020 2261 6464 2d6b            "add-k
+00020d10: 6579 7322 3a20 7365 6c66 2e61 6464 5f6b  eys": self.add_k
+00020d20: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
+00020d30: 2022 6c6f 6e67 2d72 756e 6e69 6e67 223a   "long-running":
+00020d40: 2073 656c 662e 6861 6e64 6c65 5f6c 6f6e   self.handle_lon
+00020d50: 675f 7275 6e6e 696e 672c 0a20 2020 2020  g_running,.     
+00020d60: 2020 2020 2020 2022 7265 7363 6865 6475         "reschedu
+00020d70: 6c65 223a 2073 656c 662e 5f72 6573 6368  le": self._resch
+00020d80: 6564 756c 652c 0a20 2020 2020 2020 2020  edule,.         
+00020d90: 2020 2022 6b65 6570 2d61 6c69 7665 223a     "keep-alive":
+00020da0: 206c 616d 6264 6120 2a61 7267 732c 202a   lambda *args, *
+00020db0: 2a6b 7761 7267 733a 204e 6f6e 652c 0a20  *kwargs: None,. 
+00020dc0: 2020 2020 2020 2020 2020 2022 6c6f 672d             "log-
+00020dd0: 6576 656e 7422 3a20 7365 6c66 2e6c 6f67  event": self.log
+00020de0: 5f77 6f72 6b65 725f 6576 656e 742c 0a20  _worker_event,. 
+00020df0: 2020 2020 2020 2020 2020 2022 776f 726b             "work
+00020e00: 6572 2d73 7461 7475 732d 6368 616e 6765  er-status-change
+00020e10: 223a 2073 656c 662e 6861 6e64 6c65 5f77  ": self.handle_w
+00020e20: 6f72 6b65 725f 7374 6174 7573 5f63 6861  orker_status_cha
+00020e30: 6e67 652c 0a20 2020 2020 2020 2020 2020  nge,.           
+00020e40: 2022 7265 7175 6573 742d 7265 6672 6573   "request-refres
+00020e50: 682d 7768 6f2d 6861 7322 3a20 7365 6c66  h-who-has": self
+00020e60: 2e68 616e 646c 655f 7265 7175 6573 745f  .handle_request_
+00020e70: 7265 6672 6573 685f 7768 6f5f 6861 732c  refresh_who_has,
+00020e80: 0a20 2020 2020 2020 207d 0a0a 2020 2020  .        }..    
+00020e90: 2020 2020 636c 6965 6e74 5f68 616e 646c      client_handl
+00020ea0: 6572 7320 3d20 7b0a 2020 2020 2020 2020  ers = {.        
+00020eb0: 2020 2020 2275 7064 6174 652d 6772 6170      "update-grap
+00020ec0: 6822 3a20 7365 6c66 2e75 7064 6174 655f  h": self.update_
+00020ed0: 6772 6170 682c 0a20 2020 2020 2020 2020  graph,.         
+00020ee0: 2020 2022 636c 6965 6e74 2d64 6573 6972     "client-desir
+00020ef0: 6573 2d6b 6579 7322 3a20 7365 6c66 2e63  es-keys": self.c
+00020f00: 6c69 656e 745f 6465 7369 7265 735f 6b65  lient_desires_ke
+00020f10: 7973 2c0a 2020 2020 2020 2020 2020 2020  ys,.            
+00020f20: 2275 7064 6174 652d 6461 7461 223a 2073  "update-data": s
+00020f30: 656c 662e 7570 6461 7465 5f64 6174 612c  elf.update_data,
+00020f40: 0a20 2020 2020 2020 2020 2020 2022 7265  .            "re
+00020f50: 706f 7274 2d6b 6579 223a 2073 656c 662e  port-key": self.
+00020f60: 7265 706f 7274 5f6f 6e5f 6b65 792c 0a20  report_on_key,. 
+00020f70: 2020 2020 2020 2020 2020 2022 636c 6965             "clie
+00020f80: 6e74 2d72 656c 6561 7365 732d 6b65 7973  nt-releases-keys
+00020f90: 223a 2073 656c 662e 636c 6965 6e74 5f72  ": self.client_r
+00020fa0: 656c 6561 7365 735f 6b65 7973 2c0a 2020  eleases_keys,.  
+00020fb0: 2020 2020 2020 2020 2020 2268 6561 7274            "heart
+00020fc0: 6265 6174 2d63 6c69 656e 7422 3a20 7365  beat-client": se
+00020fd0: 6c66 2e63 6c69 656e 745f 6865 6172 7462  lf.client_heartb
+00020fe0: 6561 742c 0a20 2020 2020 2020 2020 2020  eat,.           
+00020ff0: 2022 636c 6f73 652d 636c 6965 6e74 223a   "close-client":
+00021000: 2073 656c 662e 7265 6d6f 7665 5f63 6c69   self.remove_cli
+00021010: 656e 742c 0a20 2020 2020 2020 2020 2020  ent,.           
+00021020: 2022 7375 6273 6372 6962 652d 746f 7069   "subscribe-topi
+00021030: 6322 3a20 7365 6c66 2e73 7562 7363 7269  c": self.subscri
+00021040: 6265 5f74 6f70 6963 2c0a 2020 2020 2020  be_topic,.      
+00021050: 2020 2020 2020 2275 6e73 7562 7363 7269        "unsubscri
+00021060: 6265 2d74 6f70 6963 223a 2073 656c 662e  be-topic": self.
+00021070: 756e 7375 6273 6372 6962 655f 746f 7069  unsubscribe_topi
+00021080: 632c 0a20 2020 2020 2020 2020 2020 2022  c,.            "
+00021090: 6361 6e63 656c 2d6b 6579 7322 3a20 7365  cancel-keys": se
+000210a0: 6c66 2e73 7469 6d75 6c75 735f 6361 6e63  lf.stimulus_canc
+000210b0: 656c 2c0a 2020 2020 2020 2020 7d0a 0a20  el,.        }.. 
+000210c0: 2020 2020 2020 2073 656c 662e 6861 6e64         self.hand
+000210d0: 6c65 7273 203d 207b 0a20 2020 2020 2020  lers = {.       
+000210e0: 2020 2020 2022 7265 6769 7374 6572 2d63       "register-c
+000210f0: 6c69 656e 7422 3a20 7365 6c66 2e61 6464  lient": self.add
+00021100: 5f63 6c69 656e 742c 0a20 2020 2020 2020  _client,.       
+00021110: 2020 2020 2022 7363 6174 7465 7222 3a20       "scatter": 
+00021120: 7365 6c66 2e73 6361 7474 6572 2c0a 2020  self.scatter,.  
+00021130: 2020 2020 2020 2020 2020 2272 6567 6973            "regis
+00021140: 7465 722d 776f 726b 6572 223a 2073 656c  ter-worker": sel
+00021150: 662e 6164 645f 776f 726b 6572 2c0a 2020  f.add_worker,.  
+00021160: 2020 2020 2020 2020 2020 2272 6567 6973            "regis
+00021170: 7465 725f 6e61 6e6e 7922 3a20 7365 6c66  ter_nanny": self
+00021180: 2e61 6464 5f6e 616e 6e79 2c0a 2020 2020  .add_nanny,.    
+00021190: 2020 2020 2020 2020 2275 6e72 6567 6973          "unregis
+000211a0: 7465 7222 3a20 7365 6c66 2e72 656d 6f76  ter": self.remov
+000211b0: 655f 776f 726b 6572 2c0a 2020 2020 2020  e_worker,.      
+000211c0: 2020 2020 2020 2267 6174 6865 7222 3a20        "gather": 
+000211d0: 7365 6c66 2e67 6174 6865 722c 0a20 2020  self.gather,.   
+000211e0: 2020 2020 2020 2020 2022 7265 7472 7922           "retry"
+000211f0: 3a20 7365 6c66 2e73 7469 6d75 6c75 735f  : self.stimulus_
+00021200: 7265 7472 792c 0a20 2020 2020 2020 2020  retry,.         
+00021210: 2020 2022 6665 6564 223a 2073 656c 662e     "feed": self.
+00021220: 6665 6564 2c0a 2020 2020 2020 2020 2020  feed,.          
+00021230: 2020 2274 6572 6d69 6e61 7465 223a 2073    "terminate": s
+00021240: 656c 662e 636c 6f73 652c 0a20 2020 2020  elf.close,.     
+00021250: 2020 2020 2020 2022 6272 6f61 6463 6173         "broadcas
+00021260: 7422 3a20 7365 6c66 2e62 726f 6164 6361  t": self.broadca
+00021270: 7374 2c0a 2020 2020 2020 2020 2020 2020  st,.            
+00021280: 2270 726f 7879 223a 2073 656c 662e 7072  "proxy": self.pr
+00021290: 6f78 792c 0a20 2020 2020 2020 2020 2020  oxy,.           
+000212a0: 2022 6e63 6f72 6573 223a 2073 656c 662e   "ncores": self.
+000212b0: 6765 745f 6e63 6f72 6573 2c0a 2020 2020  get_ncores,.    
+000212c0: 2020 2020 2020 2020 226e 636f 7265 735f          "ncores_
+000212d0: 7275 6e6e 696e 6722 3a20 7365 6c66 2e67  running": self.g
+000212e0: 6574 5f6e 636f 7265 735f 7275 6e6e 696e  et_ncores_runnin
+000212f0: 672c 0a20 2020 2020 2020 2020 2020 2022  g,.            "
+00021300: 6861 735f 7768 6174 223a 2073 656c 662e  has_what": self.
+00021310: 6765 745f 6861 735f 7768 6174 2c0a 2020  get_has_what,.  
+00021320: 2020 2020 2020 2020 2020 2277 686f 5f68            "who_h
+00021330: 6173 223a 2073 656c 662e 6765 745f 7768  as": self.get_wh
+00021340: 6f5f 6861 732c 0a20 2020 2020 2020 2020  o_has,.         
+00021350: 2020 2022 7072 6f63 6573 7369 6e67 223a     "processing":
+00021360: 2073 656c 662e 6765 745f 7072 6f63 6573   self.get_proces
+00021370: 7369 6e67 2c0a 2020 2020 2020 2020 2020  sing,.          
+00021380: 2020 2263 616c 6c5f 7374 6163 6b22 3a20    "call_stack": 
+00021390: 7365 6c66 2e67 6574 5f63 616c 6c5f 7374  self.get_call_st
+000213a0: 6163 6b2c 0a20 2020 2020 2020 2020 2020  ack,.           
+000213b0: 2022 7072 6f66 696c 6522 3a20 7365 6c66   "profile": self
+000213c0: 2e67 6574 5f70 726f 6669 6c65 2c0a 2020  .get_profile,.  
+000213d0: 2020 2020 2020 2020 2020 2270 6572 666f            "perfo
+000213e0: 726d 616e 6365 5f72 6570 6f72 7422 3a20  rmance_report": 
+000213f0: 7365 6c66 2e70 6572 666f 726d 616e 6365  self.performance
+00021400: 5f72 6570 6f72 742c 0a20 2020 2020 2020  _report,.       
+00021410: 2020 2020 2022 6765 745f 6c6f 6773 223a       "get_logs":
+00021420: 2073 656c 662e 6765 745f 6c6f 6773 2c0a   self.get_logs,.
+00021430: 2020 2020 2020 2020 2020 2020 226c 6f67              "log
+00021440: 7322 3a20 7365 6c66 2e67 6574 5f6c 6f67  s": self.get_log
+00021450: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+00021460: 776f 726b 6572 5f6c 6f67 7322 3a20 7365  worker_logs": se
+00021470: 6c66 2e67 6574 5f77 6f72 6b65 725f 6c6f  lf.get_worker_lo
+00021480: 6773 2c0a 2020 2020 2020 2020 2020 2020  gs,.            
+00021490: 226c 6f67 5f65 7665 6e74 223a 2073 656c  "log_event": sel
+000214a0: 662e 6c6f 675f 6576 656e 742c 0a20 2020  f.log_event,.   
+000214b0: 2020 2020 2020 2020 2022 6576 656e 7473           "events
+000214c0: 223a 2073 656c 662e 6765 745f 6576 656e  ": self.get_even
+000214d0: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
+000214e0: 226e 6279 7465 7322 3a20 7365 6c66 2e67  "nbytes": self.g
+000214f0: 6574 5f6e 6279 7465 732c 0a20 2020 2020  et_nbytes,.     
+00021500: 2020 2020 2020 2022 7665 7273 696f 6e73         "versions
+00021510: 223a 2073 656c 662e 7665 7273 696f 6e73  ": self.versions
+00021520: 2c0a 2020 2020 2020 2020 2020 2020 2261  ,.            "a
+00021530: 6464 5f6b 6579 7322 3a20 7365 6c66 2e61  dd_keys": self.a
+00021540: 6464 5f6b 6579 732c 0a20 2020 2020 2020  dd_keys,.       
+00021550: 2020 2020 2022 7265 6261 6c61 6e63 6522       "rebalance"
+00021560: 3a20 7365 6c66 2e72 6562 616c 616e 6365  : self.rebalance
+00021570: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+00021580: 6570 6c69 6361 7465 223a 2073 656c 662e  eplicate": self.
+00021590: 7265 706c 6963 6174 652c 0a20 2020 2020  replicate,.     
+000215a0: 2020 2020 2020 2022 7275 6e5f 6675 6e63         "run_func
+000215b0: 7469 6f6e 223a 2073 656c 662e 7275 6e5f  tion": self.run_
+000215c0: 6675 6e63 7469 6f6e 2c0a 2020 2020 2020  function,.      
+000215d0: 2020 2020 2020 2272 6573 7461 7274 223a        "restart":
+000215e0: 2073 656c 662e 7265 7374 6172 742c 0a20   self.restart,. 
+000215f0: 2020 2020 2020 2020 2020 2022 7265 7374             "rest
+00021600: 6172 745f 776f 726b 6572 7322 3a20 7365  art_workers": se
+00021610: 6c66 2e72 6573 7461 7274 5f77 6f72 6b65  lf.restart_worke
+00021620: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+00021630: 2275 7064 6174 655f 6461 7461 223a 2073  "update_data": s
+00021640: 656c 662e 7570 6461 7465 5f64 6174 612c  elf.update_data,
+00021650: 0a20 2020 2020 2020 2020 2020 2022 7365  .            "se
+00021660: 745f 7265 736f 7572 6365 7322 3a20 7365  t_resources": se
+00021670: 6c66 2e61 6464 5f72 6573 6f75 7263 6573  lf.add_resources
+00021680: 2c0a 2020 2020 2020 2020 2020 2020 2272  ,.            "r
+00021690: 6574 6972 655f 776f 726b 6572 7322 3a20  etire_workers": 
+000216a0: 7365 6c66 2e72 6574 6972 655f 776f 726b  self.retire_work
+000216b0: 6572 732c 0a20 2020 2020 2020 2020 2020  ers,.           
+000216c0: 2022 6765 745f 6d65 7461 6461 7461 223a   "get_metadata":
+000216d0: 2073 656c 662e 6765 745f 6d65 7461 6461   self.get_metada
+000216e0: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
+000216f0: 2273 6574 5f6d 6574 6164 6174 6122 3a20  "set_metadata": 
+00021700: 7365 6c66 2e73 6574 5f6d 6574 6164 6174  self.set_metadat
+00021710: 612c 0a20 2020 2020 2020 2020 2020 2022  a,.            "
+00021720: 7365 745f 7265 7374 7269 6374 696f 6e73  set_restrictions
+00021730: 223a 2073 656c 662e 7365 745f 7265 7374  ": self.set_rest
+00021740: 7269 6374 696f 6e73 2c0a 2020 2020 2020  rictions,.      
+00021750: 2020 2020 2020 2268 6561 7274 6265 6174        "heartbeat
+00021760: 5f77 6f72 6b65 7222 3a20 7365 6c66 2e68  _worker": self.h
+00021770: 6561 7274 6265 6174 5f77 6f72 6b65 722c  eartbeat_worker,
+00021780: 0a20 2020 2020 2020 2020 2020 2022 6765  .            "ge
+00021790: 745f 7461 736b 5f73 7461 7475 7322 3a20  t_task_status": 
+000217a0: 7365 6c66 2e67 6574 5f74 6173 6b5f 7374  self.get_task_st
+000217b0: 6174 7573 2c0a 2020 2020 2020 2020 2020  atus,.          
+000217c0: 2020 2267 6574 5f74 6173 6b5f 7374 7265    "get_task_stre
+000217d0: 616d 223a 2073 656c 662e 6765 745f 7461  am": self.get_ta
+000217e0: 736b 5f73 7472 6561 6d2c 0a20 2020 2020  sk_stream,.     
+000217f0: 2020 2020 2020 2022 6765 745f 7461 736b         "get_task
+00021800: 5f70 7265 6669 785f 7374 6174 6573 223a  _prefix_states":
+00021810: 2073 656c 662e 6765 745f 7461 736b 5f70   self.get_task_p
+00021820: 7265 6669 785f 7374 6174 6573 2c0a 2020  refix_states,.  
+00021830: 2020 2020 2020 2020 2020 2272 6567 6973            "regis
+00021840: 7465 725f 7363 6865 6475 6c65 725f 706c  ter_scheduler_pl
+00021850: 7567 696e 223a 2073 656c 662e 7265 6769  ugin": self.regi
+00021860: 7374 6572 5f73 6368 6564 756c 6572 5f70  ster_scheduler_p
+00021870: 6c75 6769 6e2c 0a20 2020 2020 2020 2020  lugin,.         
+00021880: 2020 2022 756e 7265 6769 7374 6572 5f73     "unregister_s
+00021890: 6368 6564 756c 6572 5f70 6c75 6769 6e22  cheduler_plugin"
+000218a0: 3a20 7365 6c66 2e75 6e72 6567 6973 7465  : self.unregiste
+000218b0: 725f 7363 6865 6475 6c65 725f 706c 7567  r_scheduler_plug
+000218c0: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+000218d0: 2272 6567 6973 7465 725f 776f 726b 6572  "register_worker
+000218e0: 5f70 6c75 6769 6e22 3a20 7365 6c66 2e72  _plugin": self.r
+000218f0: 6567 6973 7465 725f 776f 726b 6572 5f70  egister_worker_p
+00021900: 6c75 6769 6e2c 0a20 2020 2020 2020 2020  lugin,.         
+00021910: 2020 2022 756e 7265 6769 7374 6572 5f77     "unregister_w
+00021920: 6f72 6b65 725f 706c 7567 696e 223a 2073  orker_plugin": s
+00021930: 656c 662e 756e 7265 6769 7374 6572 5f77  elf.unregister_w
+00021940: 6f72 6b65 725f 706c 7567 696e 2c0a 2020  orker_plugin,.  
+00021950: 2020 2020 2020 2020 2020 2272 6567 6973            "regis
+00021960: 7465 725f 6e61 6e6e 795f 706c 7567 696e  ter_nanny_plugin
+00021970: 223a 2073 656c 662e 7265 6769 7374 6572  ": self.register
+00021980: 5f6e 616e 6e79 5f70 6c75 6769 6e2c 0a20  _nanny_plugin,. 
+00021990: 2020 2020 2020 2020 2020 2022 756e 7265             "unre
+000219a0: 6769 7374 6572 5f6e 616e 6e79 5f70 6c75  gister_nanny_plu
+000219b0: 6769 6e22 3a20 7365 6c66 2e75 6e72 6567  gin": self.unreg
+000219c0: 6973 7465 725f 6e61 6e6e 795f 706c 7567  ister_nanny_plug
+000219d0: 696e 2c0a 2020 2020 2020 2020 2020 2020  in,.            
+000219e0: 2261 6461 7074 6976 655f 7461 7267 6574  "adaptive_target
+000219f0: 223a 2073 656c 662e 6164 6170 7469 7665  ": self.adaptive
+00021a00: 5f74 6172 6765 742c 0a20 2020 2020 2020  _target,.       
+00021a10: 2020 2020 2022 776f 726b 6572 735f 746f       "workers_to
+00021a20: 5f63 6c6f 7365 223a 2073 656c 662e 776f  _close": self.wo
+00021a30: 726b 6572 735f 746f 5f63 6c6f 7365 2c0a  rkers_to_close,.
+00021a40: 2020 2020 2020 2020 2020 2020 2273 7562              "sub
+00021a50: 7363 7269 6265 5f77 6f72 6b65 725f 7374  scribe_worker_st
+00021a60: 6174 7573 223a 2073 656c 662e 7375 6273  atus": self.subs
+00021a70: 6372 6962 655f 776f 726b 6572 5f73 7461  cribe_worker_sta
+00021a80: 7475 732c 0a20 2020 2020 2020 2020 2020  tus,.           
+00021a90: 2022 7374 6172 745f 7461 736b 5f6d 6574   "start_task_met
+00021aa0: 6164 6174 6122 3a20 7365 6c66 2e73 7461  adata": self.sta
+00021ab0: 7274 5f74 6173 6b5f 6d65 7461 6461 7461  rt_task_metadata
+00021ac0: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
+00021ad0: 746f 705f 7461 736b 5f6d 6574 6164 6174  top_task_metadat
+00021ae0: 6122 3a20 7365 6c66 2e73 746f 705f 7461  a": self.stop_ta
+00021af0: 736b 5f6d 6574 6164 6174 612c 0a20 2020  sk_metadata,.   
+00021b00: 2020 2020 2020 2020 2022 6765 745f 636c           "get_cl
+00021b10: 7573 7465 725f 7374 6174 6522 3a20 7365  uster_state": se
+00021b20: 6c66 2e67 6574 5f63 6c75 7374 6572 5f73  lf.get_cluster_s
+00021b30: 7461 7465 2c0a 2020 2020 2020 2020 2020  tate,.          
+00021b40: 2020 2264 756d 705f 636c 7573 7465 725f    "dump_cluster_
+00021b50: 7374 6174 655f 746f 5f75 726c 223a 2073  state_to_url": s
+00021b60: 656c 662e 6475 6d70 5f63 6c75 7374 6572  elf.dump_cluster
+00021b70: 5f73 7461 7465 5f74 6f5f 7572 6c2c 0a20  _state_to_url,. 
+00021b80: 2020 2020 2020 2020 2020 2022 6265 6e63             "benc
+00021b90: 686d 6172 6b5f 6861 7264 7761 7265 223a  hmark_hardware":
+00021ba0: 2073 656c 662e 6265 6e63 686d 6172 6b5f   self.benchmark_
+00021bb0: 6861 7264 7761 7265 2c0a 2020 2020 2020  hardware,.      
+00021bc0: 2020 2020 2020 2267 6574 5f73 746f 7279        "get_story
+00021bd0: 223a 2073 656c 662e 6765 745f 7374 6f72  ": self.get_stor
+00021be0: 792c 0a20 2020 2020 2020 2020 2020 2022  y,.            "
+00021bf0: 6368 6563 6b5f 6964 6c65 223a 2073 656c  check_idle": sel
+00021c00: 662e 6368 6563 6b5f 6964 6c65 2c0a 2020  f.check_idle,.  
+00021c10: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00021c20: 2063 6f6e 6e65 6374 696f 6e5f 6c69 6d69   connection_limi
+00021c30: 7420 3d20 6765 745f 6669 6c65 6e6f 5f6c  t = get_fileno_l
+00021c40: 696d 6974 2829 202f 2032 0a0a 2020 2020  imit() / 2..    
+00021c50: 2020 2020 5363 6865 6475 6c65 7253 7461      SchedulerSta
+00021c60: 7465 2e5f 5f69 6e69 745f 5f28 0a20 2020  te.__init__(.   
+00021c70: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
+00021c80: 2020 2020 2020 2020 2020 2061 6c69 6173             alias
+00021c90: 6573 3d61 6c69 6173 6573 2c0a 2020 2020  es=aliases,.    
+00021ca0: 2020 2020 2020 2020 636c 6965 6e74 733d          clients=
+00021cb0: 636c 6965 6e74 732c 0a20 2020 2020 2020  clients,.       
+00021cc0: 2020 2020 2077 6f72 6b65 7273 3d77 6f72       workers=wor
+00021cd0: 6b65 7273 2c0a 2020 2020 2020 2020 2020  kers,.          
+00021ce0: 2020 686f 7374 5f69 6e66 6f3d 686f 7374    host_info=host
+00021cf0: 5f69 6e66 6f2c 0a20 2020 2020 2020 2020  _info,.         
+00021d00: 2020 2072 6573 6f75 7263 6573 3d72 6573     resources=res
+00021d10: 6f75 7263 6573 2c0a 2020 2020 2020 2020  ources,.        
+00021d20: 2020 2020 7461 736b 733d 7461 736b 732c      tasks=tasks,
+00021d30: 0a20 2020 2020 2020 2020 2020 2075 6e72  .            unr
+00021d40: 756e 6e61 626c 653d 756e 7275 6e6e 6162  unnable=unrunnab
+00021d50: 6c65 2c0a 2020 2020 2020 2020 2020 2020  le,.            
+00021d60: 7175 6575 6564 3d71 7565 7565 642c 0a20  queued=queued,. 
+00021d70: 2020 2020 2020 2020 2020 2076 616c 6964             valid
+00021d80: 6174 653d 7661 6c69 6461 7465 2c0a 2020  ate=validate,.  
+00021d90: 2020 2020 2020 2020 2020 706c 7567 696e            plugin
+00021da0: 733d 706c 7567 696e 732c 0a20 2020 2020  s=plugins,.     
+00021db0: 2020 2020 2020 2074 7261 6e73 6974 696f         transitio
+00021dc0: 6e5f 636f 756e 7465 725f 6d61 783d 7472  n_counter_max=tr
+00021dd0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+00021de0: 5f6d 6178 2c0a 2020 2020 2020 2020 290a  _max,.        ).
+00021df0: 2020 2020 2020 2020 5365 7276 6572 4e6f          ServerNo
+00021e00: 6465 2e5f 5f69 6e69 745f 5f28 0a20 2020  de.__init__(.   
+00021e10: 2020 2020 2020 2020 2073 656c 662c 0a20           self,. 
+00021e20: 2020 2020 2020 2020 2020 2068 616e 646c             handl
+00021e30: 6572 733d 7365 6c66 2e68 616e 646c 6572  ers=self.handler
+00021e40: 732c 0a20 2020 2020 2020 2020 2020 2073  s,.            s
+00021e50: 7472 6561 6d5f 6861 6e64 6c65 7273 3d6d  tream_handlers=m
+00021e60: 6572 6765 2877 6f72 6b65 725f 6861 6e64  erge(worker_hand
+00021e70: 6c65 7273 2c20 636c 6965 6e74 5f68 616e  lers, client_han
+00021e80: 646c 6572 7329 2c0a 2020 2020 2020 2020  dlers),.        
+00021e90: 2020 2020 636f 6e6e 6563 7469 6f6e 5f6c      connection_l
+00021ea0: 696d 6974 3d63 6f6e 6e65 6374 696f 6e5f  imit=connection_
+00021eb0: 6c69 6d69 742c 0a20 2020 2020 2020 2020  limit,.         
+00021ec0: 2020 2064 6573 6572 6961 6c69 7a65 3d46     deserialize=F
+00021ed0: 616c 7365 2c0a 2020 2020 2020 2020 2020  alse,.          
+00021ee0: 2020 636f 6e6e 6563 7469 6f6e 5f61 7267    connection_arg
+00021ef0: 733d 7365 6c66 2e63 6f6e 6e65 6374 696f  s=self.connectio
+00021f00: 6e5f 6172 6773 2c0a 2020 2020 2020 2020  n_args,.        
+00021f10: 2020 2020 2a2a 6b77 6172 6773 2c0a 2020      **kwargs,.  
+00021f20: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00021f30: 2069 6620 7365 6c66 2e77 6f72 6b65 725f   if self.worker_
+00021f40: 7474 6c3a 0a20 2020 2020 2020 2020 2020  ttl:.           
+00021f50: 2070 6320 3d20 5065 7269 6f64 6963 4361   pc = PeriodicCa
+00021f60: 6c6c 6261 636b 2873 656c 662e 6368 6563  llback(self.chec
+00021f70: 6b5f 776f 726b 6572 5f74 746c 2c20 7365  k_worker_ttl, se
+00021f80: 6c66 2e77 6f72 6b65 725f 7474 6c20 2a20  lf.worker_ttl * 
+00021f90: 3130 3030 290a 2020 2020 2020 2020 2020  1000).          
+00021fa0: 2020 7365 6c66 2e70 6572 696f 6469 635f    self.periodic_
+00021fb0: 6361 6c6c 6261 636b 735b 2277 6f72 6b65  callbacks["worke
+00021fc0: 722d 7474 6c22 5d20 3d20 7063 0a0a 2020  r-ttl"] = pc..  
+00021fd0: 2020 2020 2020 7063 203d 2050 6572 696f        pc = Perio
+00021fe0: 6469 6343 616c 6c62 6163 6b28 7365 6c66  dicCallback(self
+00021ff0: 2e63 6865 636b 5f69 646c 652c 2032 3530  .check_idle, 250
+00022000: 290a 2020 2020 2020 2020 7365 6c66 2e70  ).        self.p
+00022010: 6572 696f 6469 635f 6361 6c6c 6261 636b  eriodic_callback
+00022020: 735b 2269 646c 652d 7469 6d65 6f75 7422  s["idle-timeout"
+00022030: 5d20 3d20 7063 0a0a 2020 2020 2020 2020  ] = pc..        
+00022040: 7063 203d 2050 6572 696f 6469 6343 616c  pc = PeriodicCal
+00022050: 6c62 6163 6b28 7365 6c66 2e5f 6368 6563  lback(self._chec
+00022060: 6b5f 6e6f 5f77 6f72 6b65 7273 2c20 3235  k_no_workers, 25
+00022070: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
+00022080: 7065 7269 6f64 6963 5f63 616c 6c62 6163  periodic_callbac
+00022090: 6b73 5b22 6e6f 2d77 6f72 6b65 7273 2d74  ks["no-workers-t
+000220a0: 696d 656f 7574 225d 203d 2070 630a 0a20  imeout"] = pc.. 
+000220b0: 2020 2020 2020 2069 6620 6578 7465 6e73         if extens
+000220c0: 696f 6e73 2069 7320 4e6f 6e65 3a0a 2020  ions is None:.  
+000220d0: 2020 2020 2020 2020 2020 6578 7465 6e73            extens
+000220e0: 696f 6e73 203d 2044 4546 4155 4c54 5f45  ions = DEFAULT_E
+000220f0: 5854 454e 5349 4f4e 532e 636f 7079 2829  XTENSIONS.copy()
+00022100: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00022110: 6e6f 7420 6461 736b 2e63 6f6e 6669 672e  not dask.config.
+00022120: 6765 7428 2264 6973 7472 6962 7574 6564  get("distributed
+00022130: 2e73 6368 6564 756c 6572 2e77 6f72 6b2d  .scheduler.work-
+00022140: 7374 6561 6c69 6e67 2229 3a0a 2020 2020  stealing"):.    
+00022150: 2020 2020 2020 2020 2020 2020 6966 2022              if "
+00022160: 7374 6561 6c69 6e67 2220 696e 2065 7874  stealing" in ext
+00022170: 656e 7369 6f6e 733a 0a20 2020 2020 2020  ensions:.       
+00022180: 2020 2020 2020 2020 2020 2020 2064 656c               del
+00022190: 2065 7874 656e 7369 6f6e 735b 2273 7465   extensions["ste
+000221a0: 616c 696e 6722 5d0a 0a20 2020 2020 2020  aling"]..       
+000221b0: 2066 6f72 206e 616d 652c 2065 7874 656e   for name, exten
+000221c0: 7369 6f6e 2069 6e20 6578 7465 6e73 696f  sion in extensio
+000221d0: 6e73 2e69 7465 6d73 2829 3a0a 2020 2020  ns.items():.    
+000221e0: 2020 2020 2020 2020 7365 6c66 2e65 7874          self.ext
+000221f0: 656e 7369 6f6e 735b 6e61 6d65 5d20 3d20  ensions[name] = 
+00022200: 6578 7465 6e73 696f 6e28 7365 6c66 290a  extension(self).
+00022210: 0a20 2020 2020 2020 2073 6574 7072 6f63  .        setproc
+00022220: 7469 746c 6528 2264 6173 6b20 7363 6865  title("dask sche
+00022230: 6475 6c65 7220 5b6e 6f74 2073 7461 7274  duler [not start
+00022240: 6564 5d22 290a 2020 2020 2020 2020 5363  ed]").        Sc
+00022250: 6865 6475 6c65 722e 5f69 6e73 7461 6e63  heduler._instanc
+00022260: 6573 2e61 6464 2873 656c 6629 0a20 2020  es.add(self).   
+00022270: 2020 2020 2073 656c 662e 7270 632e 616c       self.rpc.al
+00022280: 6c6f 775f 6f66 666c 6f61 6420 3d20 4661  low_offload = Fa
+00022290: 6c73 650a 0a20 2020 2023 2323 2323 2323  lse..    #######
+000222a0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+000222b0: 2320 4164 6d69 6e69 7374 7261 7469 6f6e  # Administration
+000222c0: 2023 0a20 2020 2023 2323 2323 2323 2323   #.    #########
+000222d0: 2323 2323 2323 2323 230a 0a20 2020 2064  #########..    d
+000222e0: 6566 205f 5f72 6570 725f 5f28 7365 6c66  ef __repr__(self
+000222f0: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+00022300: 2020 7265 7475 726e 2028 0a20 2020 2020    return (.     
+00022310: 2020 2020 2020 2066 223c 5363 6865 6475         f"<Schedu
+00022320: 6c65 7220 7b73 656c 662e 6164 6472 6573  ler {self.addres
+00022330: 735f 7361 6665 2172 7d2c 2022 0a20 2020  s_safe!r}, ".   
+00022340: 2020 2020 2020 2020 2066 2277 6f72 6b65           f"worke
+00022350: 7273 3a20 7b6c 656e 2873 656c 662e 776f  rs: {len(self.wo
+00022360: 726b 6572 7329 7d2c 2022 0a20 2020 2020  rkers)}, ".     
+00022370: 2020 2020 2020 2066 2263 6f72 6573 3a20         f"cores: 
+00022380: 7b73 656c 662e 746f 7461 6c5f 6e74 6872  {self.total_nthr
+00022390: 6561 6473 7d2c 2022 0a20 2020 2020 2020  eads}, ".       
+000223a0: 2020 2020 2066 2274 6173 6b73 3a20 7b6c       f"tasks: {l
+000223b0: 656e 2873 656c 662e 7461 736b 7329 7d3e  en(self.tasks)}>
+000223c0: 220a 2020 2020 2020 2020 290a 0a20 2020  ".        )..   
+000223d0: 2064 6566 205f 7265 7072 5f68 746d 6c5f   def _repr_html_
+000223e0: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
+000223f0: 2020 2020 2020 2072 6574 7572 6e20 6765         return ge
+00022400: 745f 7465 6d70 6c61 7465 2822 7363 6865  t_template("sche
+00022410: 6475 6c65 722e 6874 6d6c 2e6a 3222 292e  duler.html.j2").
+00022420: 7265 6e64 6572 280a 2020 2020 2020 2020  render(.        
+00022430: 2020 2020 6164 6472 6573 733d 7365 6c66      address=self
+00022440: 2e61 6464 7265 7373 2c0a 2020 2020 2020  .address,.      
+00022450: 2020 2020 2020 776f 726b 6572 733d 7365        workers=se
+00022460: 6c66 2e77 6f72 6b65 7273 2c0a 2020 2020  lf.workers,.    
+00022470: 2020 2020 2020 2020 7468 7265 6164 733d          threads=
+00022480: 7365 6c66 2e74 6f74 616c 5f6e 7468 7265  self.total_nthre
+00022490: 6164 732c 0a20 2020 2020 2020 2020 2020  ads,.           
+000224a0: 2074 6173 6b73 3d73 656c 662e 7461 736b   tasks=self.task
+000224b0: 732c 0a20 2020 2020 2020 2029 0a0a 2020  s,.        )..  
+000224c0: 2020 6465 6620 6964 656e 7469 7479 2873    def identity(s
+000224d0: 656c 6629 202d 3e20 6469 6374 5b73 7472  elf) -> dict[str
+000224e0: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
+000224f0: 2222 2242 6173 6963 2069 6e66 6f72 6d61  """Basic informa
+00022500: 7469 6f6e 2061 626f 7574 206f 7572 7365  tion about ourse
+00022510: 6c76 6573 2061 6e64 206f 7572 2063 6c75  lves and our clu
+00022520: 7374 6572 2222 220a 2020 2020 2020 2020  ster""".        
+00022530: 6420 3d20 7b0a 2020 2020 2020 2020 2020  d = {.          
+00022540: 2020 2274 7970 6522 3a20 7479 7065 2873    "type": type(s
+00022550: 656c 6629 2e5f 5f6e 616d 655f 5f2c 0a20  elf).__name__,. 
+00022560: 2020 2020 2020 2020 2020 2022 6964 223a             "id":
+00022570: 2073 7472 2873 656c 662e 6964 292c 0a20   str(self.id),. 
+00022580: 2020 2020 2020 2020 2020 2022 6164 6472             "addr
+00022590: 6573 7322 3a20 7365 6c66 2e61 6464 7265  ess": self.addre
+000225a0: 7373 2c0a 2020 2020 2020 2020 2020 2020  ss,.            
+000225b0: 2273 6572 7669 6365 7322 3a20 7b6b 6579  "services": {key
+000225c0: 3a20 762e 706f 7274 2066 6f72 2028 6b65  : v.port for (ke
+000225d0: 792c 2076 2920 696e 2073 656c 662e 7365  y, v) in self.se
+000225e0: 7276 6963 6573 2e69 7465 6d73 2829 7d2c  rvices.items()},
+000225f0: 0a20 2020 2020 2020 2020 2020 2022 7374  .            "st
+00022600: 6172 7465 6422 3a20 7365 6c66 2e74 696d  arted": self.tim
+00022610: 655f 7374 6172 7465 642c 0a20 2020 2020  e_started,.     
+00022620: 2020 2020 2020 2022 776f 726b 6572 7322         "workers"
+00022630: 3a20 7b0a 2020 2020 2020 2020 2020 2020  : {.            
+00022640: 2020 2020 776f 726b 6572 2e61 6464 7265      worker.addre
+00022650: 7373 3a20 776f 726b 6572 2e69 6465 6e74  ss: worker.ident
+00022660: 6974 7928 2920 666f 7220 776f 726b 6572  ity() for worker
+00022670: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+00022680: 2e76 616c 7565 7328 290a 2020 2020 2020  .values().      
+00022690: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+000226a0: 207d 0a20 2020 2020 2020 2072 6574 7572   }.        retur
+000226b0: 6e20 640a 0a20 2020 2064 6566 205f 746f  n d..    def _to
+000226c0: 5f64 6963 7428 7365 6c66 2c20 2a2c 2065  _dict(self, *, e
+000226d0: 7863 6c75 6465 3a20 436f 6e74 6169 6e65  xclude: Containe
+000226e0: 725b 7374 725d 203d 2028 2929 202d 3e20  r[str] = ()) -> 
+000226f0: 6469 6374 3a0a 2020 2020 2020 2020 2222  dict:.        ""
+00022700: 2244 6963 7469 6f6e 6172 7920 7265 7072  "Dictionary repr
+00022710: 6573 656e 7461 7469 6f6e 2066 6f72 2064  esentation for d
+00022720: 6562 7567 6769 6e67 2070 7572 706f 7365  ebugging purpose
+00022730: 732e 0a20 2020 2020 2020 204e 6f74 2074  s..        Not t
+00022740: 7970 6520 7374 6162 6c65 2061 6e64 206e  ype stable and n
+00022750: 6f74 2069 6e74 656e 6465 6420 666f 7220  ot intended for 
+00022760: 726f 756e 6474 7269 7073 2e0a 0a20 2020  roundtrips...   
+00022770: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
+00022780: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
+00022790: 2020 2020 2020 2053 6572 7665 722e 6964         Server.id
+000227a0: 656e 7469 7479 0a20 2020 2020 2020 2043  entity.        C
+000227b0: 6c69 656e 742e 6475 6d70 5f63 6c75 7374  lient.dump_clust
+000227c0: 6572 5f73 7461 7465 0a20 2020 2020 2020  er_state.       
+000227d0: 2064 6973 7472 6962 7574 6564 2e75 7469   distributed.uti
+000227e0: 6c73 2e72 6563 7572 7369 7665 5f74 6f5f  ls.recursive_to_
+000227f0: 6469 6374 0a20 2020 2020 2020 2022 2222  dict.        """
+00022800: 0a20 2020 2020 2020 2069 6e66 6f20 3d20  .        info = 
+00022810: 7375 7065 7228 292e 5f74 6f5f 6469 6374  super()._to_dict
+00022820: 2865 7863 6c75 6465 3d65 7863 6c75 6465  (exclude=exclude
+00022830: 290a 2020 2020 2020 2020 6578 7472 6120  ).        extra 
+00022840: 3d20 7b0a 2020 2020 2020 2020 2020 2020  = {.            
+00022850: 2274 7261 6e73 6974 696f 6e5f 6c6f 6722  "transition_log"
+00022860: 3a20 7365 6c66 2e74 7261 6e73 6974 696f  : self.transitio
+00022870: 6e5f 6c6f 672c 0a20 2020 2020 2020 2020  n_log,.         
+00022880: 2020 2022 7472 616e 7369 7469 6f6e 5f63     "transition_c
+00022890: 6f75 6e74 6572 223a 2073 656c 662e 7472  ounter": self.tr
+000228a0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+000228b0: 2c0a 2020 2020 2020 2020 2020 2020 2274  ,.            "t
+000228c0: 6173 6b73 223a 2073 656c 662e 7461 736b  asks": self.task
+000228d0: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
+000228e0: 7461 736b 5f67 726f 7570 7322 3a20 7365  task_groups": se
+000228f0: 6c66 2e74 6173 6b5f 6772 6f75 7073 2c0a  lf.task_groups,.
+00022900: 2020 2020 2020 2020 2020 2020 2320 4f76              # Ov
+00022910: 6572 7772 6974 6520 6469 6374 206f 6620  erwrite dict of 
+00022920: 576f 726b 6572 5374 6174 652e 6964 656e  WorkerState.iden
+00022930: 7469 7479 2066 726f 6d20 696e 666f 0a20  tity from info. 
+00022940: 2020 2020 2020 2020 2020 2022 776f 726b             "work
+00022950: 6572 7322 3a20 7365 6c66 2e77 6f72 6b65  ers": self.worke
+00022960: 7273 2c0a 2020 2020 2020 2020 2020 2020  rs,.            
+00022970: 2263 6c69 656e 7473 223a 2073 656c 662e  "clients": self.
+00022980: 636c 6965 6e74 732c 0a20 2020 2020 2020  clients,.       
+00022990: 2020 2020 2022 6d65 6d6f 7279 223a 2073       "memory": s
+000229a0: 656c 662e 6d65 6d6f 7279 2c0a 2020 2020  elf.memory,.    
+000229b0: 2020 2020 2020 2020 2265 7665 6e74 7322          "events"
+000229c0: 3a20 7365 6c66 2e65 7665 6e74 732c 0a20  : self.events,. 
+000229d0: 2020 2020 2020 2020 2020 2022 6578 7465             "exte
+000229e0: 6e73 696f 6e73 223a 2073 656c 662e 6578  nsions": self.ex
+000229f0: 7465 6e73 696f 6e73 2c0a 2020 2020 2020  tensions,.      
+00022a00: 2020 7d0a 2020 2020 2020 2020 6578 7472    }.        extr
+00022a10: 6120 3d20 7b6b 3a20 7620 666f 7220 6b2c  a = {k: v for k,
+00022a20: 2076 2069 6e20 6578 7472 612e 6974 656d   v in extra.item
+00022a30: 7328 2920 6966 206b 206e 6f74 2069 6e20  s() if k not in 
+00022a40: 6578 636c 7564 657d 0a20 2020 2020 2020  exclude}.       
+00022a50: 2069 6e66 6f2e 7570 6461 7465 2872 6563   info.update(rec
+00022a60: 7572 7369 7665 5f74 6f5f 6469 6374 2865  ursive_to_dict(e
+00022a70: 7874 7261 2c20 6578 636c 7564 653d 6578  xtra, exclude=ex
+00022a80: 636c 7564 6529 290a 2020 2020 2020 2020  clude)).        
+00022a90: 7265 7475 726e 2069 6e66 6f0a 0a20 2020  return info..   
+00022aa0: 2061 7379 6e63 2064 6566 2067 6574 5f63   async def get_c
+00022ab0: 6c75 7374 6572 5f73 7461 7465 280a 2020  luster_state(.  
+00022ac0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+00022ad0: 2020 2020 6578 636c 7564 653a 2043 6f6c      exclude: Col
+00022ae0: 6c65 6374 696f 6e5b 7374 725d 2c0a 2020  lection[str],.  
+00022af0: 2020 2920 2d3e 2064 6963 743a 0a20 2020    ) -> dict:.   
+00022b00: 2020 2020 2022 5072 6f64 7563 6520 7468       "Produce th
+00022b10: 6520 7374 6174 6520 6469 6374 2075 7365  e state dict use
+00022b20: 6420 696e 2061 2063 6c75 7374 6572 2073  d in a cluster s
+00022b30: 7461 7465 2064 756d 7022 0a20 2020 2020  tate dump".     
+00022b40: 2020 2023 204b 6963 6b20 6f66 6620 7374     # Kick off st
+00022b50: 6174 652d 6475 6d70 696e 6720 6f6e 2077  ate-dumping on w
+00022b60: 6f72 6b65 7273 2062 6566 6f72 6520 7765  orkers before we
+00022b70: 2062 6c6f 636b 2074 6865 2065 7665 6e74   block the event
+00022b80: 206c 6f6f 7020 696e 2060 7365 6c66 2e5f   loop in `self._
+00022b90: 746f 5f64 6963 7460 2e0a 2020 2020 2020  to_dict`..      
+00022ba0: 2020 776f 726b 6572 735f 6675 7475 7265    workers_future
+00022bb0: 203d 2061 7379 6e63 696f 2e67 6174 6865   = asyncio.gathe
+00022bc0: 7228 0a20 2020 2020 2020 2020 2020 2073  r(.            s
+00022bd0: 656c 662e 6272 6f61 6463 6173 7428 0a20  elf.broadcast(. 
+00022be0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00022bf0: 7367 3d7b 226f 7022 3a20 2264 756d 705f  sg={"op": "dump_
+00022c00: 7374 6174 6522 2c20 2265 7863 6c75 6465  state", "exclude
+00022c10: 223a 2065 7863 6c75 6465 7d2c 0a20 2020  ": exclude},.   
+00022c20: 2020 2020 2020 2020 2020 2020 206f 6e5f               on_
+00022c30: 6572 726f 723d 2272 6574 7572 6e22 2c0a  error="return",.
+00022c40: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
+00022c50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00022c60: 6272 6f61 6463 6173 7428 0a20 2020 2020  broadcast(.     
+00022c70: 2020 2020 2020 2020 2020 206d 7367 3d7b             msg={
+00022c80: 226f 7022 3a20 2276 6572 7369 6f6e 7322  "op": "versions"
+00022c90: 7d2c 0a20 2020 2020 2020 2020 2020 2020  },.             
+00022ca0: 2020 206f 6e5f 6572 726f 723d 2269 676e     on_error="ign
+00022cb0: 6f72 6522 2c0a 2020 2020 2020 2020 2020  ore",.          
+00022cc0: 2020 292c 0a20 2020 2020 2020 2029 0a20    ),.        ). 
+00022cd0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00022ce0: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+00022cf0: 725f 7374 6174 6520 3d20 7365 6c66 2e5f  r_state = self._
+00022d00: 746f 5f64 6963 7428 6578 636c 7564 653d  to_dict(exclude=
+00022d10: 6578 636c 7564 6529 0a0a 2020 2020 2020  exclude)..      
+00022d20: 2020 2020 2020 776f 726b 6572 5f73 7461        worker_sta
+00022d30: 7465 732c 2077 6f72 6b65 725f 7665 7273  tes, worker_vers
+00022d40: 696f 6e73 203d 2061 7761 6974 2077 6f72  ions = await wor
+00022d50: 6b65 7273 5f66 7574 7572 650a 2020 2020  kers_future.    
+00022d60: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
+00022d70: 2020 2020 2020 2020 2023 2045 6e73 7572           # Ensur
+00022d80: 6520 7468 6520 7461 736b 7320 6172 656e  e the tasks aren
+00022d90: 2774 206c 6566 7420 7275 6e6e 696e 6720  't left running 
+00022da0: 6966 2061 6e79 7468 696e 6720 6661 696c  if anything fail
+00022db0: 732e 0a20 2020 2020 2020 2020 2020 2023  s..            #
+00022dc0: 2053 6f6d 6564 6179 2028 7079 332e 3131   Someday (py3.11
+00022dd0: 292c 2075 7365 2061 2074 7269 6f2d 7374  ), use a trio-st
+00022de0: 796c 6520 5461 736b 4772 6f75 7020 666f  yle TaskGroup fo
+00022df0: 7220 7468 6973 2e0a 2020 2020 2020 2020  r this..        
+00022e00: 2020 2020 776f 726b 6572 735f 6675 7475      workers_futu
+00022e10: 7265 2e63 616e 6365 6c28 290a 0a20 2020  re.cancel()..   
+00022e20: 2020 2020 2023 2043 6f6e 7665 7274 2061       # Convert a
+00022e30: 6e79 2052 5043 2065 7272 6f72 7320 746f  ny RPC errors to
+00022e40: 2073 7472 696e 6773 0a20 2020 2020 2020   strings.       
+00022e50: 2077 6f72 6b65 725f 7374 6174 6573 203d   worker_states =
+00022e60: 207b 0a20 2020 2020 2020 2020 2020 206b   {.            k
+00022e70: 3a20 7265 7072 2876 2920 6966 2069 7369  : repr(v) if isi
+00022e80: 6e73 7461 6e63 6528 762c 2045 7863 6570  nstance(v, Excep
+00022e90: 7469 6f6e 2920 656c 7365 2076 0a20 2020  tion) else v.   
+00022ea0: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
+00022eb0: 7620 696e 2077 6f72 6b65 725f 7374 6174  v in worker_stat
+00022ec0: 6573 2e69 7465 6d73 2829 0a20 2020 2020  es.items().     
+00022ed0: 2020 207d 0a0a 2020 2020 2020 2020 7265     }..        re
+00022ee0: 7475 726e 207b 0a20 2020 2020 2020 2020  turn {.         
+00022ef0: 2020 2022 7363 6865 6475 6c65 7222 3a20     "scheduler": 
+00022f00: 7363 6865 6475 6c65 725f 7374 6174 652c  scheduler_state,
+00022f10: 0a20 2020 2020 2020 2020 2020 2022 776f  .            "wo
+00022f20: 726b 6572 7322 3a20 776f 726b 6572 5f73  rkers": worker_s
+00022f30: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+00022f40: 2020 2022 7665 7273 696f 6e73 223a 207b     "versions": {
+00022f50: 2273 6368 6564 756c 6572 223a 2073 656c  "scheduler": sel
+00022f60: 662e 7665 7273 696f 6e73 2829 2c20 2277  f.versions(), "w
+00022f70: 6f72 6b65 7273 223a 2077 6f72 6b65 725f  orkers": worker_
+00022f80: 7665 7273 696f 6e73 7d2c 0a20 2020 2020  versions},.     
+00022f90: 2020 207d 0a0a 2020 2020 6173 796e 6320     }..    async 
+00022fa0: 6465 6620 6475 6d70 5f63 6c75 7374 6572  def dump_cluster
+00022fb0: 5f73 7461 7465 5f74 6f5f 7572 6c28 0a20  _state_to_url(. 
+00022fc0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+00022fd0: 2020 2020 2075 726c 3a20 7374 722c 0a20       url: str,. 
+00022fe0: 2020 2020 2020 2065 7863 6c75 6465 3a20         exclude: 
+00022ff0: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d2c  Collection[str],
+00023000: 0a20 2020 2020 2020 2066 6f72 6d61 743a  .        format:
+00023010: 204c 6974 6572 616c 5b22 6d73 6770 6163   Literal["msgpac
+00023020: 6b22 2c20 2279 616d 6c22 5d2c 0a20 2020  k", "yaml"],.   
+00023030: 2020 2020 202a 2a73 746f 7261 6765 5f6f       **storage_o
+00023040: 7074 696f 6e73 3a20 6469 6374 5b73 7472  ptions: dict[str
+00023050: 2c20 416e 795d 2c0a 2020 2020 2920 2d3e  , Any],.    ) ->
+00023060: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00023070: 5772 6974 6520 6120 636c 7573 7465 7220  Write a cluster 
+00023080: 7374 6174 6520 6475 6d70 2074 6f20 616e  state dump to an
+00023090: 2066 7373 7065 632d 636f 6d70 6174 6962   fsspec-compatib
+000230a0: 6c65 2055 524c 2e22 0a20 2020 2020 2020  le URL.".       
+000230b0: 2061 7761 6974 2063 6c75 7374 6572 5f64   await cluster_d
+000230c0: 756d 702e 7772 6974 655f 7374 6174 6528  ump.write_state(
+000230d0: 0a20 2020 2020 2020 2020 2020 2070 6172  .            par
+000230e0: 7469 616c 2873 656c 662e 6765 745f 636c  tial(self.get_cl
+000230f0: 7573 7465 725f 7374 6174 652c 2065 7863  uster_state, exc
+00023100: 6c75 6465 292c 2075 726c 2c20 666f 726d  lude), url, form
+00023110: 6174 2c20 2a2a 7374 6f72 6167 655f 6f70  at, **storage_op
+00023120: 7469 6f6e 730a 2020 2020 2020 2020 290a  tions.        ).
+00023130: 0a20 2020 2064 6566 2067 6574 5f77 6f72  .    def get_wor
+00023140: 6b65 725f 7365 7276 6963 655f 6164 6472  ker_service_addr
+00023150: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00023160: 776f 726b 6572 3a20 7374 722c 2073 6572  worker: str, ser
+00023170: 7669 6365 5f6e 616d 653a 2073 7472 2c20  vice_name: str, 
+00023180: 7072 6f74 6f63 6f6c 3a20 626f 6f6c 203d  protocol: bool =
+00023190: 2046 616c 7365 0a20 2020 2029 202d 3e20   False.    ) -> 
+000231a0: 7475 706c 655b 7374 722c 2069 6e74 5d20  tuple[str, int] 
+000231b0: 7c20 7374 7220 7c20 4e6f 6e65 3a0a 2020  | str | None:.  
+000231c0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000231d0: 2020 4765 7420 7468 6520 2868 6f73 742c    Get the (host,
+000231e0: 2070 6f72 7429 2061 6464 7265 7373 206f   port) address o
+000231f0: 6620 7468 6520 6e61 6d65 6420 7365 7276  f the named serv
+00023200: 6963 6520 6f6e 2074 6865 202a 776f 726b  ice on the *work
+00023210: 6572 2a2e 0a20 2020 2020 2020 2052 6574  er*..        Ret
+00023220: 7572 6e73 204e 6f6e 6520 6966 2074 6865  urns None if the
+00023230: 2073 6572 7669 6365 2064 6f65 736e 2774   service doesn't
+00023240: 2065 7869 7374 2e0a 0a20 2020 2020 2020   exist...       
+00023250: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00023260: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00023270: 2020 2020 2020 2077 6f72 6b65 7220 3a20         worker : 
+00023280: 6164 6472 6573 730a 2020 2020 2020 2020  address.        
+00023290: 7365 7276 6963 655f 6e61 6d65 203a 2073  service_name : s
+000232a0: 7472 0a20 2020 2020 2020 2020 2020 2043  tr.            C
+000232b0: 6f6d 6d6f 6e20 7365 7276 6963 6573 2069  ommon services i
+000232c0: 6e63 6c75 6465 2027 626f 6b65 6827 2061  nclude 'bokeh' a
+000232d0: 6e64 2027 6e61 6e6e 7927 0a20 2020 2020  nd 'nanny'.     
+000232e0: 2020 2070 726f 746f 636f 6c20 3a20 626f     protocol : bo
+000232f0: 6f6c 6561 6e0a 2020 2020 2020 2020 2020  olean.          
+00023300: 2020 5768 6574 6865 7220 6f72 206e 6f74    Whether or not
+00023310: 2074 6f20 696e 636c 7564 6520 6120 6675   to include a fu
+00023320: 6c6c 2061 6464 7265 7373 2077 6974 6820  ll address with 
+00023330: 7072 6f74 6f63 6f6c 2028 5472 7565 290a  protocol (True).
+00023340: 2020 2020 2020 2020 2020 2020 6f72 206a              or j
+00023350: 7573 7420 6120 2868 6f73 742c 2070 6f72  ust a (host, por
+00023360: 7429 2070 6169 720a 2020 2020 2020 2020  t) pair.        
+00023370: 2222 220a 2020 2020 2020 2020 7773 203d  """.        ws =
+00023380: 2073 656c 662e 776f 726b 6572 735b 776f   self.workers[wo
+00023390: 726b 6572 5d0a 2020 2020 2020 2020 706f  rker].        po
+000233a0: 7274 203d 2077 732e 7365 7276 6963 6573  rt = ws.services
+000233b0: 2e67 6574 2873 6572 7669 6365 5f6e 616d  .get(service_nam
+000233c0: 6529 0a20 2020 2020 2020 2069 6620 706f  e).        if po
+000233d0: 7274 2069 7320 4e6f 6e65 3a0a 2020 2020  rt is None:.    
+000233e0: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+000233f0: 6f6e 650a 2020 2020 2020 2020 656c 6966  one.        elif
+00023400: 2070 726f 746f 636f 6c3a 0a20 2020 2020   protocol:.     
+00023410: 2020 2020 2020 2072 6574 7572 6e20 2225         return "%
+00023420: 2870 726f 746f 636f 6c29 733a 2f2f 2528  (protocol)s://%(
+00023430: 686f 7374 2973 3a25 2870 6f72 7429 6422  host)s:%(port)d"
+00023440: 2025 207b 0a20 2020 2020 2020 2020 2020   % {.           
+00023450: 2020 2020 2022 7072 6f74 6f63 6f6c 223a       "protocol":
+00023460: 2077 732e 6164 6472 6573 732e 7370 6c69   ws.address.spli
+00023470: 7428 223a 2f2f 2229 5b30 5d2c 0a20 2020  t("://")[0],.   
+00023480: 2020 2020 2020 2020 2020 2020 2022 686f               "ho
+00023490: 7374 223a 2077 732e 686f 7374 2c0a 2020  st": ws.host,.  
+000234a0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
+000234b0: 6f72 7422 3a20 706f 7274 2c0a 2020 2020  ort": port,.    
+000234c0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000234d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+000234e0: 2020 2020 7265 7475 726e 2077 732e 686f      return ws.ho
+000234f0: 7374 2c20 706f 7274 0a0a 2020 2020 6173  st, port..    as
+00023500: 796e 6320 6465 6620 7374 6172 745f 756e  ync def start_un
+00023510: 7361 6665 2873 656c 6629 202d 3e20 5365  safe(self) -> Se
+00023520: 6c66 3a0a 2020 2020 2020 2020 2222 2243  lf:.        """C
+00023530: 6c65 6172 206f 7574 206f 6c64 2073 7461  lear out old sta
+00023540: 7465 2061 6e64 2072 6573 7461 7274 2061  te and restart a
+00023550: 6c6c 2072 756e 6e69 6e67 2063 6f72 6f75  ll running corou
+00023560: 7469 6e65 7322 2222 0a20 2020 2020 2020  tines""".       
+00023570: 2061 7761 6974 2073 7570 6572 2829 2e73   await super().s
+00023580: 7461 7274 5f75 6e73 6166 6528 290a 0a20  tart_unsafe().. 
+00023590: 2020 2020 2020 2065 6e61 626c 655f 6763         enable_gc
+000235a0: 5f64 6961 676e 6f73 6973 2829 0a0a 2020  _diagnosis()..  
+000235b0: 2020 2020 2020 7365 6c66 2e5f 636c 6561        self._clea
+000235c0: 725f 7461 736b 5f73 7461 7465 2829 0a0a  r_task_state()..
+000235d0: 2020 2020 2020 2020 666f 7220 6164 6472          for addr
+000235e0: 2069 6e20 7365 6c66 2e5f 7374 6172 745f   in self._start_
+000235f0: 6164 6472 6573 733a 0a20 2020 2020 2020  address:.       
+00023600: 2020 2020 2061 7761 6974 2073 656c 662e       await self.
+00023610: 6c69 7374 656e 280a 2020 2020 2020 2020  listen(.        
+00023620: 2020 2020 2020 2020 6164 6472 2c0a 2020          addr,.  
+00023630: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00023640: 6c6f 775f 6f66 666c 6f61 643d 4661 6c73  low_offload=Fals
+00023650: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00023660: 2020 2068 616e 6473 6861 6b65 5f6f 7665     handshake_ove
+00023670: 7272 6964 6573 3d7b 2270 6963 6b6c 652d  rrides={"pickle-
+00023680: 7072 6f74 6f63 6f6c 223a 2034 2c20 2263  protocol": 4, "c
+00023690: 6f6d 7072 6573 7369 6f6e 223a 204e 6f6e  ompression": Non
+000236a0: 657d 2c0a 2020 2020 2020 2020 2020 2020  e},.            
+000236b0: 2020 2020 2a2a 7365 6c66 2e73 6563 7572      **self.secur
+000236c0: 6974 792e 6765 745f 6c69 7374 656e 5f61  ity.get_listen_a
+000236d0: 7267 7328 2273 6368 6564 756c 6572 2229  rgs("scheduler")
+000236e0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+000236f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00023700: 2e69 7020 3d20 6765 745f 6164 6472 6573  .ip = get_addres
+00023710: 735f 686f 7374 2873 656c 662e 6c69 7374  s_host(self.list
+00023720: 656e 5f61 6464 7265 7373 290a 2020 2020  en_address).    
+00023730: 2020 2020 2020 2020 6c69 7374 656e 5f69          listen_i
+00023740: 7020 3d20 7365 6c66 2e69 700a 0a20 2020  p = self.ip..   
+00023750: 2020 2020 2020 2020 2069 6620 6c69 7374           if list
+00023760: 656e 5f69 7020 3d3d 2022 302e 302e 302e  en_ip == "0.0.0.
+00023770: 3022 3a0a 2020 2020 2020 2020 2020 2020  0":.            
+00023780: 2020 2020 6c69 7374 656e 5f69 7020 3d20      listen_ip = 
+00023790: 2222 0a0a 2020 2020 2020 2020 6966 2073  ""..        if s
+000237a0: 656c 662e 6164 6472 6573 732e 7374 6172  elf.address.star
+000237b0: 7473 7769 7468 2822 696e 7072 6f63 3a2f  tswith("inproc:/
+000237c0: 2f22 293a 0a20 2020 2020 2020 2020 2020  /"):.           
+000237d0: 206c 6973 7465 6e5f 6970 203d 2022 6c6f   listen_ip = "lo
+000237e0: 6361 6c68 6f73 7422 0a0a 2020 2020 2020  calhost"..      
+000237f0: 2020 2320 5365 7276 6963 6573 206c 6973    # Services lis
+00023800: 7465 6e20 6f6e 2061 6c6c 2061 6464 7265  ten on all addre
+00023810: 7373 6573 0a20 2020 2020 2020 2073 656c  sses.        sel
+00023820: 662e 7374 6172 745f 7365 7276 6963 6573  f.start_services
+00023830: 286c 6973 7465 6e5f 6970 290a 0a20 2020  (listen_ip)..   
+00023840: 2020 2020 2066 6f72 206c 6973 7465 6e65       for listene
+00023850: 7220 696e 2073 656c 662e 6c69 7374 656e  r in self.listen
+00023860: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+00023870: 206c 6f67 6765 722e 696e 666f 2822 2020   logger.info("  
+00023880: 5363 6865 6475 6c65 7220 6174 3a20 2532  Scheduler at: %2
+00023890: 3573 222c 206c 6973 7465 6e65 722e 636f  5s", listener.co
+000238a0: 6e74 6163 745f 6164 6472 6573 7329 0a20  ntact_address). 
+000238b0: 2020 2020 2020 2066 6f72 206e 616d 652c         for name,
+000238c0: 2073 6572 7665 7220 696e 2073 656c 662e   server in self.
+000238d0: 7365 7276 6963 6573 2e69 7465 6d73 2829  services.items()
+000238e0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
+000238f0: 206e 616d 6520 3d3d 2022 6461 7368 626f   name == "dashbo
+00023900: 6172 6422 3a0a 2020 2020 2020 2020 2020  ard":.          
+00023910: 2020 2020 2020 6164 6472 203d 2067 6574        addr = get
+00023920: 5f61 6464 7265 7373 5f68 6f73 7428 6c69  _address_host(li
+00023930: 7374 656e 6572 2e63 6f6e 7461 6374 5f61  stener.contact_a
+00023940: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+00023950: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00023960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023970: 206c 696e 6b20 3d20 666f 726d 6174 5f64   link = format_d
+00023980: 6173 6862 6f61 7264 5f6c 696e 6b28 6164  ashboard_link(ad
+00023990: 6472 2c20 7365 7276 6572 2e70 6f72 7429  dr, server.port)
+000239a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000239b0: 2023 2066 6f72 6d61 7474 696e 6720 6461   # formatting da
+000239c0: 7368 626f 6172 6420 6c69 6e6b 2063 616e  shboard link can
+000239d0: 2066 6169 6c20 6966 2064 6973 7472 6962   fail if distrib
+000239e0: 7574 6564 2e64 6173 6862 6f61 7264 2e6c  uted.dashboard.l
+000239f0: 696e 6b0a 2020 2020 2020 2020 2020 2020  ink.            
+00023a00: 2020 2020 2320 7265 6665 7273 2074 6f20      # refers to 
+00023a10: 6e6f 6e2d 6578 6973 7461 6e74 2065 6e76  non-existant env
+00023a20: 2076 6172 732e 0a20 2020 2020 2020 2020   vars..         
+00023a30: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+00023a40: 7945 7272 6f72 2061 7320 653a 0a20 2020  yError as e:.   
+00023a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023a60: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+00023a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023a80: 2020 2020 2020 2020 2066 2246 6169 6c65           f"Faile
+00023a90: 6420 746f 2066 6f72 6d61 7420 6461 7368  d to format dash
+00023aa0: 626f 6172 6420 6c69 6e6b 2c20 756e 6b6e  board link, unkn
+00023ab0: 6f77 6e20 7661 6c75 653a 207b 657d 220a  own value: {e}".
+00023ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023ad0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00023ae0: 2020 2020 2020 2020 2020 6c69 6e6b 203d            link =
+00023af0: 2066 223a 7b73 6572 7665 722e 706f 7274   f":{server.port
+00023b00: 7d22 0a20 2020 2020 2020 2020 2020 2065  }".            e
+00023b10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00023b20: 2020 2020 206c 696e 6b20 3d20 6622 7b6c       link = f"{l
+00023b30: 6973 7465 6e5f 6970 7d3a 7b73 6572 7665  isten_ip}:{serve
+00023b40: 722e 706f 7274 7d22 0a20 2020 2020 2020  r.port}".       
+00023b50: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+00023b60: 2822 2531 3173 2061 743a 2020 2532 3573  ("%11s at:  %25s
+00023b70: 222c 206e 616d 652c 206c 696e 6b29 0a0a  ", name, link)..
+00023b80: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00023b90: 7363 6865 6475 6c65 725f 6669 6c65 3a0a  scheduler_file:.
+00023ba0: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00023bb0: 206f 7065 6e28 7365 6c66 2e73 6368 6564   open(self.sched
+00023bc0: 756c 6572 5f66 696c 652c 2022 7722 2920  uler_file, "w") 
+00023bd0: 6173 2066 3a0a 2020 2020 2020 2020 2020  as f:.          
+00023be0: 2020 2020 2020 6a73 6f6e 2e64 756d 7028        json.dump(
+00023bf0: 7365 6c66 2e69 6465 6e74 6974 7928 292c  self.identity(),
+00023c00: 2066 2c20 696e 6465 6e74 3d32 290a 0a20   f, indent=2).. 
+00023c10: 2020 2020 2020 2020 2020 2066 6e20 3d20             fn = 
+00023c20: 7365 6c66 2e73 6368 6564 756c 6572 5f66  self.scheduler_f
+00023c30: 696c 6520 2023 2072 656d 6f76 6520 6669  ile  # remove fi
+00023c40: 6c65 2077 6865 6e20 7765 2063 6c6f 7365  le when we close
+00023c50: 2074 6865 2070 726f 6365 7373 0a0a 2020   the process..  
+00023c60: 2020 2020 2020 2020 2020 6465 6620 6465            def de
+00023c70: 6c5f 7363 6865 6475 6c65 725f 6669 6c65  l_scheduler_file
+00023c80: 2829 202d 3e20 4e6f 6e65 3a0a 2020 2020  () -> None:.    
+00023c90: 2020 2020 2020 2020 2020 2020 6966 206f              if o
+00023ca0: 732e 7061 7468 2e65 7869 7374 7328 666e  s.path.exists(fn
+00023cb0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00023cc0: 2020 2020 2020 206f 732e 7265 6d6f 7665         os.remove
+00023cd0: 2866 6e29 0a0a 2020 2020 2020 2020 2020  (fn)..          
+00023ce0: 2020 7765 616b 7265 662e 6669 6e61 6c69    weakref.finali
+00023cf0: 7a65 2873 656c 662c 2064 656c 5f73 6368  ze(self, del_sch
+00023d00: 6564 756c 6572 5f66 696c 6529 0a0a 2020  eduler_file)..  
+00023d10: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+00023d20: 2e70 7265 6c6f 6164 732e 7374 6172 7428  .preloads.start(
+00023d30: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
+00023d40: 6c66 2e6a 7570 7974 6572 3a0a 2020 2020  lf.jupyter:.    
+00023d50: 2020 2020 2020 2020 2320 416c 6c6f 7720          # Allow 
+00023d60: 696e 7365 6375 7265 2063 6f6d 6d75 6e69  insecure communi
+00023d70: 6361 7469 6f6e 7320 6672 6f6d 206c 6f63  cations from loc
+00023d80: 616c 2075 7365 7273 0a20 2020 2020 2020  al users.       
+00023d90: 2020 2020 2069 6620 7365 6c66 2e61 6464       if self.add
+00023da0: 7265 7373 2e73 7461 7274 7377 6974 6828  ress.startswith(
+00023db0: 2274 6c73 3a2f 2f22 293a 0a20 2020 2020  "tls://"):.     
+00023dc0: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00023dd0: 2073 656c 662e 6c69 7374 656e 2822 7463   self.listen("tc
+00023de0: 703a 2f2f 6c6f 6361 6c68 6f73 743a 3022  p://localhost:0"
+00023df0: 290a 2020 2020 2020 2020 2020 2020 6f73  ).            os
+00023e00: 2e65 6e76 6972 6f6e 5b22 4441 534b 5f53  .environ["DASK_S
+00023e10: 4348 4544 554c 4552 5f41 4444 5245 5353  CHEDULER_ADDRESS
+00023e20: 225d 203d 2073 656c 662e 6c69 7374 656e  "] = self.listen
+00023e30: 6572 735b 2d31 5d2e 636f 6e74 6163 745f  ers[-1].contact_
+00023e40: 6164 6472 6573 730a 0a20 2020 2020 2020  address..       
+00023e50: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+00023e60: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+00023e70: 2020 202a 5b70 6c75 6769 6e2e 7374 6172     *[plugin.star
+00023e80: 7428 7365 6c66 2920 666f 7220 706c 7567  t(self) for plug
+00023e90: 696e 2069 6e20 6c69 7374 2873 656c 662e  in in list(self.
+00023ea0: 706c 7567 696e 732e 7661 6c75 6573 2829  plugins.values()
+00023eb0: 295d 0a20 2020 2020 2020 2029 0a0a 2020  )].        )..  
+00023ec0: 2020 2020 2020 7365 6c66 2e73 7461 7274        self.start
+00023ed0: 5f70 6572 696f 6469 635f 6361 6c6c 6261  _periodic_callba
+00023ee0: 636b 7328 290a 0a20 2020 2020 2020 2073  cks()..        s
+00023ef0: 6574 7072 6f63 7469 746c 6528 6622 6461  etproctitle(f"da
+00023f00: 736b 2073 6368 6564 756c 6572 205b 7b73  sk scheduler [{s
+00023f10: 656c 662e 6164 6472 6573 737d 5d22 290a  elf.address}]").
+00023f20: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00023f30: 656c 660a 0a20 2020 2061 7379 6e63 2064  elf..    async d
+00023f40: 6566 2063 6c6f 7365 2873 656c 662c 2066  ef close(self, f
+00023f50: 6173 743d 4e6f 6e65 2c20 636c 6f73 655f  ast=None, close_
+00023f60: 776f 726b 6572 733d 4e6f 6e65 2c20 7265  workers=None, re
+00023f70: 6173 6f6e 3d22 2229 3a0a 2020 2020 2020  ason=""):.      
+00023f80: 2020 2222 2253 656e 6420 636c 6561 6e75    """Send cleanu
+00023f90: 7020 7369 676e 616c 2074 6f20 616c 6c20  p signal to all 
+00023fa0: 636f 726f 7574 696e 6573 2074 6865 6e20  coroutines then 
+00023fb0: 7761 6974 2075 6e74 696c 2066 696e 6973  wait until finis
+00023fc0: 6865 640a 0a20 2020 2020 2020 2053 6565  hed..        See
+00023fd0: 2041 6c73 6f0a 2020 2020 2020 2020 2d2d   Also.        --
+00023fe0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
+00023ff0: 6368 6564 756c 6572 2e63 6c65 616e 7570  cheduler.cleanup
+00024000: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00024010: 2020 2020 2069 6620 6661 7374 2069 7320       if fast is 
+00024020: 6e6f 7420 4e6f 6e65 206f 7220 636c 6f73  not None or clos
+00024030: 655f 776f 726b 6572 7320 6973 206e 6f74  e_workers is not
+00024040: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00024050: 2020 2077 6172 6e69 6e67 732e 7761 726e     warnings.warn
+00024060: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00024070: 2020 2254 6865 2027 6661 7374 2720 616e    "The 'fast' an
+00024080: 6420 2763 6c6f 7365 5f77 6f72 6b65 7273  d 'close_workers
+00024090: 2720 7061 7261 6d65 7465 7273 2069 6e20  ' parameters in 
+000240a0: 5363 6865 6475 6c65 722e 636c 6f73 6520  Scheduler.close 
+000240b0: 6861 7665 206e 6f20 220a 2020 2020 2020  have no ".      
+000240c0: 2020 2020 2020 2020 2020 2265 6666 6563            "effec
+000240d0: 7420 616e 6420 7769 6c6c 2062 6520 7265  t and will be re
+000240e0: 6d6f 7665 6420 696e 2061 2066 7574 7572  moved in a futur
+000240f0: 6520 7665 7273 696f 6e20 6f66 2064 6973  e version of dis
+00024100: 7472 6962 7574 6564 2e22 2c0a 2020 2020  tributed.",.    
+00024110: 2020 2020 2020 2020 2020 2020 4675 7475              Futu
+00024120: 7265 5761 726e 696e 672c 0a20 2020 2020  reWarning,.     
+00024130: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00024140: 2069 6620 7365 6c66 2e73 7461 7475 7320   if self.status 
+00024150: 696e 2028 5374 6174 7573 2e63 6c6f 7369  in (Status.closi
+00024160: 6e67 2c20 5374 6174 7573 2e63 6c6f 7365  ng, Status.close
+00024170: 6429 3a0a 2020 2020 2020 2020 2020 2020  d):.            
+00024180: 6177 6169 7420 7365 6c66 2e66 696e 6973  await self.finis
+00024190: 6865 6428 290a 2020 2020 2020 2020 2020  hed().          
+000241a0: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
+000241b0: 2020 6173 796e 6320 6465 6620 6c6f 675f    async def log_
+000241c0: 6572 726f 7273 2866 756e 6329 3a0a 2020  errors(func):.  
+000241d0: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+000241e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+000241f0: 7761 6974 2066 756e 6328 290a 2020 2020  wait func().    
+00024200: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+00024210: 7863 6570 7469 6f6e 3a0a 2020 2020 2020  xception:.      
+00024220: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00024230: 2e65 7863 6570 7469 6f6e 2822 506c 7567  .exception("Plug
+00024240: 696e 2063 616c 6c20 6661 696c 6564 2064  in call failed d
+00024250: 7572 696e 6720 7363 6865 6475 6c65 722e  uring scheduler.
+00024260: 636c 6f73 6522 290a 0a20 2020 2020 2020  close")..       
+00024270: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
+00024280: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
+00024290: 2020 202a 5b6c 6f67 5f65 7272 6f72 7328     *[log_errors(
+000242a0: 706c 7567 696e 2e62 6566 6f72 655f 636c  plugin.before_cl
+000242b0: 6f73 6529 2066 6f72 2070 6c75 6769 6e20  ose) for plugin 
+000242c0: 696e 206c 6973 7428 7365 6c66 2e70 6c75  in list(self.plu
+000242d0: 6769 6e73 2e76 616c 7565 7328 2929 5d0a  gins.values())].
+000242e0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000242f0: 2020 2073 656c 662e 7374 6174 7573 203d     self.status =
+00024300: 2053 7461 7475 732e 636c 6f73 696e 670a   Status.closing.
+00024310: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00024320: 6e66 6f28 2253 6368 6564 756c 6572 2063  nfo("Scheduler c
+00024330: 6c6f 7369 6e67 2064 7565 2074 6f20 2573  losing due to %s
+00024340: 2e2e 2e22 2c20 7265 6173 6f6e 206f 7220  ...", reason or 
+00024350: 2275 6e6b 6e6f 776e 2072 6561 736f 6e22  "unknown reason"
+00024360: 290a 2020 2020 2020 2020 7365 7470 726f  ).        setpro
+00024370: 6374 6974 6c65 2822 6461 736b 2073 6368  ctitle("dask sch
+00024380: 6564 756c 6572 205b 636c 6f73 696e 675d  eduler [closing]
+00024390: 2229 0a0a 2020 2020 2020 2020 6177 6169  ")..        awai
+000243a0: 7420 7365 6c66 2e70 7265 6c6f 6164 732e  t self.preloads.
+000243b0: 7465 6172 646f 776e 2829 0a0a 2020 2020  teardown()..    
+000243c0: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+000243d0: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+000243e0: 2020 2020 2020 2a5b 6c6f 675f 6572 726f        *[log_erro
+000243f0: 7273 2870 6c75 6769 6e2e 636c 6f73 6529  rs(plugin.close)
+00024400: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
+00024410: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
+00024420: 2e76 616c 7565 7328 2929 5d0a 2020 2020  .values())].    
+00024430: 2020 2020 290a 0a20 2020 2020 2020 2066      )..        f
+00024440: 6f72 2070 6320 696e 2073 656c 662e 7065  or pc in self.pe
+00024450: 7269 6f64 6963 5f63 616c 6c62 6163 6b73  riodic_callbacks
+00024460: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+00024470: 2020 2020 2020 2070 632e 7374 6f70 2829         pc.stop()
+00024480: 0a20 2020 2020 2020 2073 656c 662e 7065  .        self.pe
+00024490: 7269 6f64 6963 5f63 616c 6c62 6163 6b73  riodic_callbacks
+000244a0: 2e63 6c65 6172 2829 0a0a 2020 2020 2020  .clear()..      
+000244b0: 2020 7365 6c66 2e73 746f 705f 7365 7276    self.stop_serv
+000244c0: 6963 6573 2829 0a0a 2020 2020 2020 2020  ices()..        
+000244d0: 666f 7220 6578 7420 696e 2073 656c 662e  for ext in self.
+000244e0: 6578 7465 6e73 696f 6e73 2e76 616c 7565  extensions.value
+000244f0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00024500: 2077 6974 6820 7375 7070 7265 7373 2841   with suppress(A
+00024510: 7474 7269 6275 7465 4572 726f 7229 3a0a  ttributeError):.
+00024520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024530: 6578 742e 7465 6172 646f 776e 2829 0a20  ext.teardown(). 
+00024540: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+00024550: 666f 2822 5363 6865 6475 6c65 7220 636c  fo("Scheduler cl
+00024560: 6f73 696e 6720 616c 6c20 636f 6d6d 7322  osing all comms"
+00024570: 290a 0a20 2020 2020 2020 2066 7574 7572  )..        futur
+00024580: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
+00024590: 666f 7220 5f2c 2063 6f6d 6d20 696e 206c  for _, comm in l
+000245a0: 6973 7428 7365 6c66 2e73 7472 6561 6d5f  ist(self.stream_
+000245b0: 636f 6d6d 732e 6974 656d 7328 2929 3a0a  comms.items()):.
+000245c0: 2020 2020 2020 2020 2020 2020 2320 4649              # FI
+000245d0: 584d 4520 7573 6520 6073 656c 662e 7265  XME use `self.re
+000245e0: 6d6f 7665 5f77 6f72 6b65 7228 2960 2069  move_worker()` i
+000245f0: 6e73 7465 6164 2061 6674 6572 2068 7474  nstead after htt
+00024600: 7073 3a2f 2f67 6974 6875 622e 636f 6d2f  ps://github.com/
+00024610: 6461 736b 2f64 6973 7472 6962 7574 6564  dask/distributed
+00024620: 2f69 7373 7565 732f 3633 3930 0a20 2020  /issues/6390.   
+00024630: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00024640: 636f 6d6d 2e63 6c6f 7365 6428 293a 0a20  comm.closed():. 
+00024650: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00024660: 2054 6869 7320 636c 6f73 6573 2074 6865   This closes the
+00024670: 2057 6f72 6b65 7220 616e 6420 656e 7375   Worker and ensu
+00024680: 7265 7320 7468 6174 2069 6620 6120 4e61  res that if a Na
+00024690: 6e6e 7920 6973 2061 726f 756e 642c 0a20  nny is around,. 
+000246a0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+000246b0: 2069 7420 6973 2063 6c6f 7365 6420 6173   it is closed as
+000246c0: 2077 656c 6c0a 2020 2020 2020 2020 2020   well.          
+000246d0: 2020 2020 2020 636f 6d6d 2e73 656e 6428        comm.send(
+000246e0: 7b22 6f70 223a 2022 636c 6f73 6522 2c20  {"op": "close", 
+000246f0: 2272 6561 736f 6e22 3a20 2273 6368 6564  "reason": "sched
+00024700: 756c 6572 2d63 6c6f 7365 227d 290a 2020  uler-close"}).  
+00024710: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00024720: 6d6d 2e73 656e 6428 7b22 6f70 223a 2022  mm.send({"op": "
+00024730: 636c 6f73 652d 7374 7265 616d 227d 290a  close-stream"}).
+00024740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024750: 2320 5e20 544f 444f 2072 656d 6f76 653f  # ^ TODO remove?
+00024760: 2060 576f 726b 6572 2e63 6c6f 7365 6020   `Worker.close` 
+00024770: 7769 6c6c 2063 6c6f 7365 2074 6865 2073  will close the s
+00024780: 7472 6561 6d20 616e 7977 6179 2e0a 2020  tream anyway..  
+00024790: 2020 2020 2020 2020 2020 7769 7468 2073            with s
+000247a0: 7570 7072 6573 7328 4174 7472 6962 7574  uppress(Attribut
+000247b0: 6545 7272 6f72 293a 0a20 2020 2020 2020  eError):.       
+000247c0: 2020 2020 2020 2020 2066 7574 7572 6573           futures
+000247d0: 2e61 7070 656e 6428 636f 6d6d 2e63 6c6f  .append(comm.clo
+000247e0: 7365 2829 290a 0a20 2020 2020 2020 2061  se())..        a
+000247f0: 7761 6974 2061 7379 6e63 696f 2e67 6174  wait asyncio.gat
+00024800: 6865 7228 2a66 7574 7572 6573 290a 0a20  her(*futures).. 
+00024810: 2020 2020 2020 2069 6620 7365 6c66 2e6a         if self.j
+00024820: 7570 7974 6572 3a0a 2020 2020 2020 2020  upyter:.        
+00024830: 2020 2020 6177 6169 7420 7365 6c66 2e5f      await self._
+00024840: 6a75 7079 7465 725f 7365 7276 6572 5f61  jupyter_server_a
+00024850: 7070 6c69 6361 7469 6f6e 2e5f 636c 6561  pplication._clea
+00024860: 6e75 7028 290a 0a20 2020 2020 2020 2066  nup()..        f
+00024870: 6f72 2063 6f6d 6d20 696e 2073 656c 662e  or comm in self.
+00024880: 636c 6965 6e74 5f63 6f6d 6d73 2e76 616c  client_comms.val
+00024890: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
+000248a0: 2020 2063 6f6d 6d2e 6162 6f72 7428 290a     comm.abort().
+000248b0: 0a20 2020 2020 2020 2061 7761 6974 2073  .        await s
+000248c0: 656c 662e 7270 632e 636c 6f73 6528 290a  elf.rpc.close().
+000248d0: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+000248e0: 6174 7573 203d 2053 7461 7475 732e 636c  atus = Status.cl
+000248f0: 6f73 6564 0a20 2020 2020 2020 2073 656c  osed.        sel
+00024900: 662e 7374 6f70 2829 0a20 2020 2020 2020  f.stop().       
+00024910: 2061 7761 6974 2073 7570 6572 2829 2e63   await super().c
+00024920: 6c6f 7365 2829 0a0a 2020 2020 2020 2020  lose()..        
+00024930: 7365 7470 726f 6374 6974 6c65 2822 6461  setproctitle("da
+00024940: 736b 2073 6368 6564 756c 6572 205b 636c  sk scheduler [cl
+00024950: 6f73 6564 5d22 290a 2020 2020 2020 2020  osed]").        
+00024960: 6469 7361 626c 655f 6763 5f64 6961 676e  disable_gc_diagn
+00024970: 6f73 6973 2829 0a0a 2020 2020 2323 2323  osis()..    ####
+00024980: 2323 2323 2323 230a 2020 2020 2320 5374  #######.    # St
+00024990: 696d 756c 6920 230a 2020 2020 2323 2323  imuli #.    ####
+000249a0: 2323 2323 2323 230a 0a20 2020 2064 6566  #######..    def
+000249b0: 2068 6561 7274 6265 6174 5f77 6f72 6b65   heartbeat_worke
+000249c0: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
+000249d0: 0a20 2020 2020 2020 202a 2c0a 2020 2020  .        *,.    
+000249e0: 2020 2020 6164 6472 6573 733a 2073 7472      address: str
+000249f0: 2c0a 2020 2020 2020 2020 7265 736f 6c76  ,.        resolv
+00024a00: 655f 6164 6472 6573 733a 2062 6f6f 6c20  e_address: bool 
+00024a10: 3d20 5472 7565 2c0a 2020 2020 2020 2020  = True,.        
+00024a20: 6e6f 773a 2066 6c6f 6174 207c 204e 6f6e  now: float | Non
+00024a30: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00024a40: 2020 7265 736f 7572 6365 733a 2064 6963    resources: dic
+00024a50: 745b 7374 722c 2066 6c6f 6174 5d20 7c20  t[str, float] | 
+00024a60: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00024a70: 2020 2020 2068 6f73 745f 696e 666f 3a20       host_info: 
+00024a80: 6469 6374 207c 204e 6f6e 6520 3d20 4e6f  dict | None = No
+00024a90: 6e65 2c0a 2020 2020 2020 2020 6d65 7472  ne,.        metr
+00024aa0: 6963 733a 2064 6963 742c 0a20 2020 2020  ics: dict,.     
+00024ab0: 2020 2065 7865 6375 7469 6e67 3a20 6469     executing: di
+00024ac0: 6374 5b4b 6579 2c20 666c 6f61 745d 207c  ct[Key, float] |
+00024ad0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00024ae0: 2020 2020 2020 6578 7465 6e73 696f 6e73        extensions
+00024af0: 3a20 6469 6374 207c 204e 6f6e 6520 3d20  : dict | None = 
+00024b00: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2064  None,.    ) -> d
+00024b10: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+00024b20: 2020 2020 2020 2061 6464 7265 7373 203d         address =
+00024b30: 2073 656c 662e 636f 6572 6365 5f61 6464   self.coerce_add
+00024b40: 7265 7373 2861 6464 7265 7373 2c20 7265  ress(address, re
+00024b50: 736f 6c76 655f 6164 6472 6573 7329 0a20  solve_address). 
+00024b60: 2020 2020 2020 2061 6464 7265 7373 203d         address =
+00024b70: 206e 6f72 6d61 6c69 7a65 5f61 6464 7265   normalize_addre
+00024b80: 7373 2861 6464 7265 7373 290a 2020 2020  ss(address).    
+00024b90: 2020 2020 7773 203d 2073 656c 662e 776f      ws = self.wo
+00024ba0: 726b 6572 732e 6765 7428 6164 6472 6573  rkers.get(addres
+00024bb0: 7329 0a20 2020 2020 2020 2069 6620 7773  s).        if ws
+00024bc0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00024bd0: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+00024be0: 6e69 6e67 2866 2252 6563 6569 7665 6420  ning(f"Received 
+00024bf0: 6865 6172 7462 6561 7420 6672 6f6d 2075  heartbeat from u
+00024c00: 6e72 6567 6973 7465 7265 6420 776f 726b  nregistered work
+00024c10: 6572 207b 6164 6472 6573 7321 727d 2e22  er {address!r}."
+00024c20: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00024c30: 7475 726e 207b 2273 7461 7475 7322 3a20  turn {"status": 
+00024c40: 226d 6973 7369 6e67 227d 0a0a 2020 2020  "missing"}..    
+00024c50: 2020 2020 686f 7374 203d 2067 6574 5f61      host = get_a
+00024c60: 6464 7265 7373 5f68 6f73 7428 6164 6472  ddress_host(addr
+00024c70: 6573 7329 0a20 2020 2020 2020 206c 6f63  ess).        loc
+00024c80: 616c 5f6e 6f77 203d 2074 696d 6528 290a  al_now = time().
+00024c90: 2020 2020 2020 2020 686f 7374 5f69 6e66          host_inf
+00024ca0: 6f20 3d20 686f 7374 5f69 6e66 6f20 6f72  o = host_info or
+00024cb0: 207b 7d0a 0a20 2020 2020 2020 2064 6820   {}..        dh 
+00024cc0: 3d20 7365 6c66 2e68 6f73 745f 696e 666f  = self.host_info
+00024cd0: 2e73 6574 6465 6661 756c 7428 686f 7374  .setdefault(host
+00024ce0: 2c20 7b7d 290a 2020 2020 2020 2020 6468  , {}).        dh
+00024cf0: 5b22 6c61 7374 2d73 6565 6e22 5d20 3d20  ["last-seen"] = 
+00024d00: 6c6f 6361 6c5f 6e6f 770a 0a20 2020 2020  local_now..     
+00024d10: 2020 2066 7261 6320 3d20 3120 2f20 6c65     frac = 1 / le
+00024d20: 6e28 7365 6c66 2e77 6f72 6b65 7273 290a  n(self.workers).
+00024d30: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+00024d40: 6477 6964 7468 203d 2028 0a20 2020 2020  dwidth = (.     
+00024d50: 2020 2020 2020 2073 656c 662e 6261 6e64         self.band
+00024d60: 7769 6474 6820 2a20 2831 202d 2066 7261  width * (1 - fra
+00024d70: 6329 202b 206d 6574 7269 6373 5b22 6261  c) + metrics["ba
+00024d80: 6e64 7769 6474 6822 5d5b 2274 6f74 616c  ndwidth"]["total
+00024d90: 225d 202a 2066 7261 630a 2020 2020 2020  "] * frac.      
+00024da0: 2020 290a 2020 2020 2020 2020 666f 7220    ).        for 
+00024db0: 6f74 6865 722c 2028 6277 2c20 636f 756e  other, (bw, coun
+00024dc0: 7429 2069 6e20 6d65 7472 6963 735b 2262  t) in metrics["b
+00024dd0: 616e 6477 6964 7468 225d 5b22 776f 726b  andwidth"]["work
+00024de0: 6572 7322 5d2e 6974 656d 7328 293a 0a20  ers"].items():. 
+00024df0: 2020 2020 2020 2020 2020 2069 6620 2861             if (a
+00024e00: 6464 7265 7373 2c20 6f74 6865 7229 206e  ddress, other) n
+00024e10: 6f74 2069 6e20 7365 6c66 2e62 616e 6477  ot in self.bandw
+00024e20: 6964 7468 5f77 6f72 6b65 7273 3a0a 2020  idth_workers:.  
+00024e30: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00024e40: 6c66 2e62 616e 6477 6964 7468 5f77 6f72  lf.bandwidth_wor
+00024e50: 6b65 7273 5b61 6464 7265 7373 2c20 6f74  kers[address, ot
+00024e60: 6865 725d 203d 2062 7720 2f20 636f 756e  her] = bw / coun
+00024e70: 740a 2020 2020 2020 2020 2020 2020 656c  t.            el
+00024e80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00024e90: 2020 2020 616c 7068 6120 3d20 2831 202d      alpha = (1 -
+00024ea0: 2066 7261 6329 202a 2a20 636f 756e 740a   frac) ** count.
+00024eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024ec0: 7365 6c66 2e62 616e 6477 6964 7468 5f77  self.bandwidth_w
+00024ed0: 6f72 6b65 7273 5b61 6464 7265 7373 2c20  orkers[address, 
+00024ee0: 6f74 6865 725d 203d 2073 656c 662e 6261  other] = self.ba
+00024ef0: 6e64 7769 6474 685f 776f 726b 6572 735b  ndwidth_workers[
+00024f00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00024f10: 2020 2020 2061 6464 7265 7373 2c20 6f74       address, ot
+00024f20: 6865 720a 2020 2020 2020 2020 2020 2020  her.            
+00024f30: 2020 2020 5d20 2a20 616c 7068 6120 2b20      ] * alpha + 
+00024f40: 6277 202a 2028 3120 2d20 616c 7068 6129  bw * (1 - alpha)
+00024f50: 0a20 2020 2020 2020 2066 6f72 2074 7970  .        for typ
+00024f60: 2c20 2862 772c 2063 6f75 6e74 2920 696e  , (bw, count) in
+00024f70: 206d 6574 7269 6373 5b22 6261 6e64 7769   metrics["bandwi
+00024f80: 6474 6822 5d5b 2274 7970 6573 225d 2e69  dth"]["types"].i
+00024f90: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00024fa0: 2020 2020 6966 2074 7970 206e 6f74 2069      if typ not i
+00024fb0: 6e20 7365 6c66 2e62 616e 6477 6964 7468  n self.bandwidth
+00024fc0: 5f74 7970 6573 3a0a 2020 2020 2020 2020  _types:.        
+00024fd0: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
+00024fe0: 6477 6964 7468 5f74 7970 6573 5b74 7970  dwidth_types[typ
+00024ff0: 5d20 3d20 6277 202f 2063 6f75 6e74 0a20  ] = bw / count. 
+00025000: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00025010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025020: 2061 6c70 6861 203d 2028 3120 2d20 6672   alpha = (1 - fr
+00025030: 6163 2920 2a2a 2063 6f75 6e74 0a20 2020  ac) ** count.   
+00025040: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00025050: 662e 6261 6e64 7769 6474 685f 7479 7065  f.bandwidth_type
+00025060: 735b 7479 705d 203d 2073 656c 662e 6261  s[typ] = self.ba
+00025070: 6e64 7769 6474 685f 7479 7065 735b 7479  ndwidth_types[ty
+00025080: 705d 202a 2061 6c70 6861 202b 2062 7720  p] * alpha + bw 
+00025090: 2a20 280a 2020 2020 2020 2020 2020 2020  * (.            
+000250a0: 2020 2020 2020 2020 3120 2d20 616c 7068          1 - alph
+000250b0: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+000250c0: 2020 290a 0a20 2020 2020 2020 2077 732e    )..        ws.
+000250d0: 6c61 7374 5f73 6565 6e20 3d20 6c6f 6361  last_seen = loca
+000250e0: 6c5f 6e6f 770a 2020 2020 2020 2020 6966  l_now.        if
+000250f0: 2065 7865 6375 7469 6e67 2069 7320 6e6f   executing is no
+00025100: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00025110: 2020 2020 2320 4e4f 5445 3a20 7468 6520      # NOTE: the 
+00025120: 6578 6563 7574 696e 6720 6469 6374 2069  executing dict i
+00025130: 7320 756e 7573 6564 0a20 2020 2020 2020  s unused.       
+00025140: 2020 2020 2077 732e 6578 6563 7574 696e       ws.executin
+00025150: 6720 3d20 7b7d 0a20 2020 2020 2020 2020  g = {}.         
+00025160: 2020 2066 6f72 206b 6579 2c20 6475 7261     for key, dura
+00025170: 7469 6f6e 2069 6e20 6578 6563 7574 696e  tion in executin
+00025180: 672e 6974 656d 7328 293a 0a20 2020 2020  g.items():.     
+00025190: 2020 2020 2020 2020 2020 2069 6620 6b65             if ke
+000251a0: 7920 696e 2073 656c 662e 7461 736b 733a  y in self.tasks:
+000251b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000251c0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+000251d0: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
+000251e0: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+000251f0: 2e65 7865 6375 7469 6e67 5b74 735d 203d  .executing[ts] =
+00025200: 2064 7572 6174 696f 6e0a 2020 2020 2020   duration.      
+00025210: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+00025220: 2e70 7265 6669 782e 6164 645f 6578 6563  .prefix.add_exec
+00025230: 5f74 696d 6528 6475 7261 7469 6f6e 290a  _time(duration).
+00025240: 0a20 2020 2020 2020 2066 6f72 206e 616d  .        for nam
+00025250: 652c 2076 616c 7565 2069 6e20 6d65 7472  e, value in metr
+00025260: 6963 735b 2264 6967 6573 7473 5f74 6f74  ics["digests_tot
+00025270: 616c 5f73 696e 6365 5f68 6561 7274 6265  al_since_heartbe
+00025280: 6174 225d 2e69 7465 6d73 2829 3a0a 2020  at"].items():.  
+00025290: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+000252a0: 756d 756c 6174 6976 655f 776f 726b 6572  umulative_worker
+000252b0: 5f6d 6574 7269 6373 5b6e 616d 655d 202b  _metrics[name] +
+000252c0: 3d20 7661 6c75 650a 0a20 2020 2020 2020  = value..       
+000252d0: 2077 732e 6d65 7472 6963 7320 3d20 6d65   ws.metrics = me
+000252e0: 7472 6963 730a 0a20 2020 2020 2020 2023  trics..        #
+000252f0: 2043 616c 6375 6c61 7465 2052 5353 202d   Calculate RSS -
+00025300: 2064 6173 6b20 6b65 7973 2c20 7365 7061   dask keys, sepa
+00025310: 7261 7469 6e67 2022 6f6c 6422 2061 6e64  rating "old" and
+00025320: 2022 6e65 7722 2075 7361 6765 0a20 2020   "new" usage.   
+00025330: 2020 2020 2023 2053 6565 204d 656d 6f72       # See Memor
+00025340: 7953 7461 7465 2066 6f72 2064 6574 6169  yState for detai
+00025350: 6c73 0a20 2020 2020 2020 206d 6178 5f6d  ls.        max_m
+00025360: 656d 6f72 795f 756e 6d61 6e61 6765 645f  emory_unmanaged_
+00025370: 6f6c 645f 6869 7374 5f61 6765 203d 206c  old_hist_age = l
+00025380: 6f63 616c 5f6e 6f77 202d 2073 656c 662e  ocal_now - self.
+00025390: 4d45 4d4f 5259 5f52 4543 454e 545f 544f  MEMORY_RECENT_TO
+000253a0: 5f4f 4c44 5f54 494d 450a 2020 2020 2020  _OLD_TIME.      
+000253b0: 2020 6d65 6d6f 7279 5f75 6e6d 616e 6167    memory_unmanag
+000253c0: 6564 5f6f 6c64 203d 2077 732e 5f6d 656d  ed_old = ws._mem
+000253d0: 6f72 795f 756e 6d61 6e61 6765 645f 6f6c  ory_unmanaged_ol
+000253e0: 640a 2020 2020 2020 2020 7768 696c 6520  d.        while 
+000253f0: 7773 2e5f 6d65 6d6f 7279 5f75 6e6d 616e  ws._memory_unman
+00025400: 6167 6564 5f68 6973 746f 7279 3a0a 2020  aged_history:.  
+00025410: 2020 2020 2020 2020 2020 7469 6d65 7374            timest
+00025420: 616d 702c 2073 697a 6520 3d20 7773 2e5f  amp, size = ws._
+00025430: 6d65 6d6f 7279 5f75 6e6d 616e 6167 6564  memory_unmanaged
+00025440: 5f68 6973 746f 7279 5b30 5d0a 2020 2020  _history[0].    
+00025450: 2020 2020 2020 2020 6966 2074 696d 6573          if times
+00025460: 7461 6d70 203e 3d20 6d61 785f 6d65 6d6f  tamp >= max_memo
+00025470: 7279 5f75 6e6d 616e 6167 6564 5f6f 6c64  ry_unmanaged_old
+00025480: 5f68 6973 745f 6167 653a 0a20 2020 2020  _hist_age:.     
+00025490: 2020 2020 2020 2020 2020 2062 7265 616b             break
+000254a0: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
+000254b0: 5f6d 656d 6f72 795f 756e 6d61 6e61 6765  _memory_unmanage
+000254c0: 645f 6869 7374 6f72 792e 706f 706c 6566  d_history.poplef
+000254d0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+000254e0: 6966 2073 697a 6520 3d3d 206d 656d 6f72  if size == memor
+000254f0: 795f 756e 6d61 6e61 6765 645f 6f6c 643a  y_unmanaged_old:
+00025500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025510: 206d 656d 6f72 795f 756e 6d61 6e61 6765   memory_unmanage
+00025520: 645f 6f6c 6420 3d20 3020 2023 2072 6563  d_old = 0  # rec
+00025530: 616c 6375 6c61 7465 206d 696e 2829 0a0a  alculate min()..
+00025540: 2020 2020 2020 2020 2320 7773 2e5f 6e62          # ws._nb
+00025550: 7974 6573 2069 7320 7570 6461 7465 6420  ytes is updated 
+00025560: 6174 2061 2064 6966 6665 7265 6e74 2074  at a different t
+00025570: 696d 6520 616e 6420 7369 7a65 6f66 2829  ime and sizeof()
+00025580: 206d 6179 206e 6f74 2062 6520 6163 6375   may not be accu
+00025590: 7261 7465 2c0a 2020 2020 2020 2020 2320  rate,.        # 
+000255a0: 736f 2073 697a 6520 6d61 7920 6265 2028  so size may be (
+000255b0: 7465 6d70 6f72 6172 696c 7929 206e 6567  temporarily) neg
+000255c0: 6174 6976 653b 2066 6c6f 6f72 2069 7420  ative; floor it 
+000255d0: 746f 207a 6572 6f2e 0a20 2020 2020 2020  to zero..       
+000255e0: 2073 697a 6520 3d20 6d61 7828 0a20 2020   size = max(.   
+000255f0: 2020 2020 2020 2020 2030 2c20 6d65 7472           0, metr
+00025600: 6963 735b 226d 656d 6f72 7922 5d20 2d20  ics["memory"] - 
+00025610: 7773 2e6e 6279 7465 7320 2b20 6d65 7472  ws.nbytes + metr
+00025620: 6963 735b 2273 7069 6c6c 6564 5f62 7974  ics["spilled_byt
+00025630: 6573 225d 5b22 6d65 6d6f 7279 225d 0a20  es"]["memory"]. 
+00025640: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+00025650: 2020 7773 2e5f 6d65 6d6f 7279 5f75 6e6d    ws._memory_unm
+00025660: 616e 6167 6564 5f68 6973 746f 7279 2e61  anaged_history.a
+00025670: 7070 656e 6428 286c 6f63 616c 5f6e 6f77  ppend((local_now
+00025680: 2c20 7369 7a65 2929 0a20 2020 2020 2020  , size)).       
+00025690: 2069 6620 6e6f 7420 6d65 6d6f 7279 5f75   if not memory_u
+000256a0: 6e6d 616e 6167 6564 5f6f 6c64 3a0a 2020  nmanaged_old:.  
+000256b0: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
+000256c0: 776f 726b 6572 2068 6173 206a 7573 7420  worker has just 
+000256d0: 6265 656e 2073 7461 7274 6564 206f 7220  been started or 
+000256e0: 7468 6520 7072 6576 696f 7573 206d 696e  the previous min
+000256f0: 696d 756d 2068 6173 2062 6565 6e20 6578  imum has been ex
+00025700: 7075 6e67 6564 0a20 2020 2020 2020 2020  punged.         
+00025710: 2020 2023 2062 6563 6175 7365 2074 6f6f     # because too
+00025720: 206f 6c64 2e0a 2020 2020 2020 2020 2020   old..          
+00025730: 2020 2320 4e6f 7465 3a20 7468 6973 2061    # Note: this a
+00025740: 6c67 6f72 6974 686d 2069 7320 6361 7070  lgorithm is capp
+00025750: 6564 2074 6f20 3230 3020 2a20 4d45 4d4f  ed to 200 * MEMO
+00025760: 5259 5f52 4543 454e 545f 544f 5f4f 4c44  RY_RECENT_TO_OLD
+00025770: 5f54 494d 4520 656c 656d 656e 7473 0a20  _TIME elements. 
+00025780: 2020 2020 2020 2020 2020 2023 2063 6c75             # clu
+00025790: 7374 6572 2d77 6964 6520 6279 2068 6561  ster-wide by hea
+000257a0: 7274 6265 6174 5f69 6e74 6572 7661 6c28  rtbeat_interval(
+000257b0: 292c 2072 6567 6172 646c 6573 7320 6f66  ), regardless of
+000257c0: 2074 6865 206e 756d 6265 7220 6f66 2077   the number of w
+000257d0: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
+000257e0: 2020 2077 732e 5f6d 656d 6f72 795f 756e     ws._memory_un
+000257f0: 6d61 6e61 6765 645f 6f6c 6420 3d20 6d69  managed_old = mi
+00025800: 6e28 6d61 7028 7365 636f 6e64 2c20 7773  n(map(second, ws
+00025810: 2e5f 6d65 6d6f 7279 5f75 6e6d 616e 6167  ._memory_unmanag
+00025820: 6564 5f68 6973 746f 7279 2929 0a20 2020  ed_history)).   
+00025830: 2020 2020 2065 6c69 6620 7369 7a65 203c       elif size <
+00025840: 206d 656d 6f72 795f 756e 6d61 6e61 6765   memory_unmanage
+00025850: 645f 6f6c 643a 0a20 2020 2020 2020 2020  d_old:.         
+00025860: 2020 2077 732e 5f6d 656d 6f72 795f 756e     ws._memory_un
+00025870: 6d61 6e61 6765 645f 6f6c 6420 3d20 7369  managed_old = si
+00025880: 7a65 0a0a 2020 2020 2020 2020 6966 2068  ze..        if h
+00025890: 6f73 745f 696e 666f 3a0a 2020 2020 2020  ost_info:.      
+000258a0: 2020 2020 2020 6468 203d 2073 656c 662e        dh = self.
+000258b0: 686f 7374 5f69 6e66 6f2e 7365 7464 6566  host_info.setdef
+000258c0: 6175 6c74 2868 6f73 742c 207b 7d29 0a20  ault(host, {}). 
+000258d0: 2020 2020 2020 2020 2020 2064 682e 7570             dh.up
+000258e0: 6461 7465 2868 6f73 745f 696e 666f 290a  date(host_info).
+000258f0: 0a20 2020 2020 2020 2069 6620 6e6f 773a  .        if now:
+00025900: 0a20 2020 2020 2020 2020 2020 2077 732e  .            ws.
+00025910: 7469 6d65 5f64 656c 6179 203d 206c 6f63  time_delay = loc
+00025920: 616c 5f6e 6f77 202d 206e 6f77 0a0a 2020  al_now - now..  
+00025930: 2020 2020 2020 6966 2072 6573 6f75 7263        if resourc
+00025940: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00025950: 7365 6c66 2e61 6464 5f72 6573 6f75 7263  self.add_resourc
+00025960: 6573 2877 6f72 6b65 723d 6164 6472 6573  es(worker=addres
+00025970: 732c 2072 6573 6f75 7263 6573 3d72 6573  s, resources=res
+00025980: 6f75 7263 6573 290a 0a20 2020 2020 2020  ources)..       
+00025990: 2069 6620 6578 7465 6e73 696f 6e73 3a0a   if extensions:.
+000259a0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000259b0: 6e61 6d65 2c20 6461 7461 2069 6e20 6578  name, data in ex
+000259c0: 7465 6e73 696f 6e73 2e69 7465 6d73 2829  tensions.items()
+000259d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000259e0: 2020 7365 6c66 2e65 7874 656e 7369 6f6e    self.extension
+000259f0: 735b 6e61 6d65 5d2e 6865 6172 7462 6561  s[name].heartbea
+00025a00: 7428 7773 2c20 6461 7461 290a 0a20 2020  t(ws, data)..   
+00025a10: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+00025a20: 2020 2020 2020 2020 2020 2273 7461 7475            "statu
+00025a30: 7322 3a20 224f 4b22 2c0a 2020 2020 2020  s": "OK",.      
+00025a40: 2020 2020 2020 2274 696d 6522 3a20 6c6f        "time": lo
+00025a50: 6361 6c5f 6e6f 772c 0a20 2020 2020 2020  cal_now,.       
+00025a60: 2020 2020 2022 6865 6172 7462 6561 742d       "heartbeat-
+00025a70: 696e 7465 7276 616c 223a 2068 6561 7274  interval": heart
+00025a80: 6265 6174 5f69 6e74 6572 7661 6c28 6c65  beat_interval(le
+00025a90: 6e28 7365 6c66 2e77 6f72 6b65 7273 2929  n(self.workers))
+00025aa0: 2c0a 2020 2020 2020 2020 7d0a 0a20 2020  ,.        }..   
+00025ab0: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+00025ac0: 2061 7379 6e63 2064 6566 2061 6464 5f77   async def add_w
+00025ad0: 6f72 6b65 7228 0a20 2020 2020 2020 2073  orker(.        s
+00025ae0: 656c 662c 0a20 2020 2020 2020 2063 6f6d  elf,.        com
+00025af0: 6d3a 2043 6f6d 6d2c 0a20 2020 2020 2020  m: Comm,.       
+00025b00: 202a 2c0a 2020 2020 2020 2020 6164 6472   *,.        addr
+00025b10: 6573 733a 2073 7472 2c0a 2020 2020 2020  ess: str,.      
+00025b20: 2020 7374 6174 7573 3a20 7374 722c 0a20    status: str,. 
+00025b30: 2020 2020 2020 2073 6572 7665 725f 6964         server_id
+00025b40: 3a20 7374 722c 0a20 2020 2020 2020 206e  : str,.        n
+00025b50: 7468 7265 6164 733a 2069 6e74 2c0a 2020  threads: int,.  
+00025b60: 2020 2020 2020 6e61 6d65 3a20 7374 722c        name: str,
+00025b70: 0a20 2020 2020 2020 2072 6573 6f6c 7665  .        resolve
+00025b80: 5f61 6464 7265 7373 3a20 626f 6f6c 203d  _address: bool =
+00025b90: 2054 7275 652c 0a20 2020 2020 2020 206e   True,.        n
+00025ba0: 6f77 3a20 666c 6f61 742c 0a20 2020 2020  ow: float,.     
+00025bb0: 2020 2072 6573 6f75 7263 6573 3a20 6469     resources: di
+00025bc0: 6374 5b73 7472 2c20 666c 6f61 745d 2c0a  ct[str, float],.
+00025bd0: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
+00025be0: 2054 6869 7320 6973 206e 6576 6572 2073   This is never s
+00025bf0: 7562 6d69 7474 6564 2062 7920 7468 6520  ubmitted by the 
+00025c00: 776f 726b 6572 0a20 2020 2020 2020 2068  worker.        h
+00025c10: 6f73 745f 696e 666f 3a20 4e6f 6e65 203d  ost_info: None =
+00025c20: 204e 6f6e 652c 0a20 2020 2020 2020 206d   None,.        m
+00025c30: 656d 6f72 795f 6c69 6d69 743a 2069 6e74  emory_limit: int
+00025c40: 207c 204e 6f6e 652c 0a20 2020 2020 2020   | None,.       
+00025c50: 206d 6574 7269 6373 3a20 6469 6374 5b73   metrics: dict[s
+00025c60: 7472 2c20 416e 795d 2c0a 2020 2020 2020  tr, Any],.      
+00025c70: 2020 7069 643a 2069 6e74 203d 2030 2c0a    pid: int = 0,.
+00025c80: 2020 2020 2020 2020 7365 7276 6963 6573          services
+00025c90: 3a20 6469 6374 5b73 7472 2c20 696e 745d  : dict[str, int]
+00025ca0: 2c0a 2020 2020 2020 2020 6c6f 6361 6c5f  ,.        local_
+00025cb0: 6469 7265 6374 6f72 793a 2073 7472 2c0a  directory: str,.
+00025cc0: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
+00025cd0: 3a20 6469 6374 5b73 7472 2c20 416e 795d  : dict[str, Any]
+00025ce0: 2c0a 2020 2020 2020 2020 6e61 6e6e 793a  ,.        nanny:
+00025cf0: 2073 7472 2c0a 2020 2020 2020 2020 6578   str,.        ex
+00025d00: 7472 613a 2064 6963 742c 0a20 2020 2020  tra: dict,.     
+00025d10: 2020 2073 7469 6d75 6c75 735f 6964 3a20     stimulus_id: 
+00025d20: 7374 722c 0a20 2020 2029 202d 3e20 4e6f  str,.    ) -> No
+00025d30: 6e65 3a0a 2020 2020 2020 2020 2222 2241  ne:.        """A
+00025d40: 6464 2061 206e 6577 2077 6f72 6b65 7220  dd a new worker 
+00025d50: 746f 2074 6865 2063 6c75 7374 6572 2222  to the cluster""
+00025d60: 220a 2020 2020 2020 2020 6164 6472 6573  ".        addres
+00025d70: 7320 3d20 7365 6c66 2e63 6f65 7263 655f  s = self.coerce_
+00025d80: 6164 6472 6573 7328 6164 6472 6573 732c  address(address,
+00025d90: 2072 6573 6f6c 7665 5f61 6464 7265 7373   resolve_address
+00025da0: 290a 2020 2020 2020 2020 6164 6472 6573  ).        addres
+00025db0: 7320 3d20 6e6f 726d 616c 697a 655f 6164  s = normalize_ad
+00025dc0: 6472 6573 7328 6164 6472 6573 7329 0a20  dress(address). 
+00025dd0: 2020 2020 2020 2068 6f73 7420 3d20 6765         host = ge
+00025de0: 745f 6164 6472 6573 735f 686f 7374 2861  t_address_host(a
+00025df0: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
+00025e00: 2069 6620 6164 6472 6573 7320 696e 2073   if address in s
+00025e10: 656c 662e 776f 726b 6572 733a 0a20 2020  elf.workers:.   
+00025e20: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00025e30: 616c 7565 4572 726f 7228 2257 6f72 6b65  alueError("Worke
+00025e40: 7220 616c 7265 6164 7920 6578 6973 7473  r already exists
+00025e50: 2025 7322 2025 2061 6464 7265 7373 290a   %s" % address).
+00025e60: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
+00025e70: 2069 6e20 7365 6c66 2e61 6c69 6173 6573   in self.aliases
+00025e80: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+00025e90: 6767 6572 2e77 6172 6e69 6e67 2822 576f  gger.warning("Wo
+00025ea0: 726b 6572 2074 7269 6564 2074 6f20 636f  rker tried to co
+00025eb0: 6e6e 6563 7420 7769 7468 2061 2064 7570  nnect with a dup
+00025ec0: 6c69 6361 7465 206e 616d 653a 2025 7322  licate name: %s"
+00025ed0: 2c20 6e61 6d65 290a 2020 2020 2020 2020  , name).        
+00025ee0: 2020 2020 6d73 6720 3d20 7b0a 2020 2020      msg = {.    
+00025ef0: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
+00025f00: 7475 7322 3a20 2265 7272 6f72 222c 0a20  tus": "error",. 
+00025f10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00025f20: 6d65 7373 6167 6522 3a20 226e 616d 6520  message": "name 
+00025f30: 7461 6b65 6e2c 2025 7322 2025 206e 616d  taken, %s" % nam
+00025f40: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
+00025f50: 2020 2022 7469 6d65 223a 2074 696d 6528     "time": time(
+00025f60: 292c 0a20 2020 2020 2020 2020 2020 207d  ),.            }
+00025f70: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00025f80: 6974 2063 6f6d 6d2e 7772 6974 6528 6d73  it comm.write(ms
+00025f90: 6729 0a20 2020 2020 2020 2020 2020 2072  g).            r
+00025fa0: 6574 7572 6e0a 0a20 2020 2020 2020 2073  eturn..        s
+00025fb0: 656c 662e 6c6f 675f 6576 656e 7428 6164  elf.log_event(ad
+00025fc0: 6472 6573 732c 207b 2261 6374 696f 6e22  dress, {"action"
+00025fd0: 3a20 2261 6464 2d77 6f72 6b65 7222 7d29  : "add-worker"})
+00025fe0: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+00025ff0: 675f 6576 656e 7428 2261 6c6c 222c 207b  g_event("all", {
+00026000: 2261 6374 696f 6e22 3a20 2261 6464 2d77  "action": "add-w
+00026010: 6f72 6b65 7222 2c20 2277 6f72 6b65 7222  orker", "worker"
+00026020: 3a20 6164 6472 6573 737d 290a 0a20 2020  : address})..   
+00026030: 2020 2020 2073 656c 662e 776f 726b 6572       self.worker
+00026040: 735b 6164 6472 6573 735d 203d 2077 7320  s[address] = ws 
+00026050: 3d20 576f 726b 6572 5374 6174 6528 0a20  = WorkerState(. 
+00026060: 2020 2020 2020 2020 2020 2061 6464 7265             addre
+00026070: 7373 3d61 6464 7265 7373 2c0a 2020 2020  ss=address,.    
+00026080: 2020 2020 2020 2020 7374 6174 7573 3d53          status=S
+00026090: 7461 7475 732e 6c6f 6f6b 7570 5b73 7461  tatus.lookup[sta
+000260a0: 7475 735d 2c20 2023 2074 7970 653a 2069  tus],  # type: i
+000260b0: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
+000260c0: 2020 7069 643d 7069 642c 0a20 2020 2020    pid=pid,.     
+000260d0: 2020 2020 2020 206e 7468 7265 6164 733d         nthreads=
+000260e0: 6e74 6872 6561 6473 2c0a 2020 2020 2020  nthreads,.      
+000260f0: 2020 2020 2020 6d65 6d6f 7279 5f6c 696d        memory_lim
+00026100: 6974 3d6d 656d 6f72 795f 6c69 6d69 7420  it=memory_limit 
+00026110: 6f72 2030 2c0a 2020 2020 2020 2020 2020  or 0,.          
+00026120: 2020 6e61 6d65 3d6e 616d 652c 0a20 2020    name=name,.   
+00026130: 2020 2020 2020 2020 206c 6f63 616c 5f64           local_d
+00026140: 6972 6563 746f 7279 3d6c 6f63 616c 5f64  irectory=local_d
+00026150: 6972 6563 746f 7279 2c0a 2020 2020 2020  irectory,.      
+00026160: 2020 2020 2020 7365 7276 6963 6573 3d73        services=s
+00026170: 6572 7669 6365 732c 0a20 2020 2020 2020  ervices,.       
+00026180: 2020 2020 2076 6572 7369 6f6e 733d 7665       versions=ve
+00026190: 7273 696f 6e73 2c0a 2020 2020 2020 2020  rsions,.        
+000261a0: 2020 2020 6e61 6e6e 793d 6e61 6e6e 792c      nanny=nanny,
+000261b0: 0a20 2020 2020 2020 2020 2020 2065 7874  .            ext
+000261c0: 7261 3d65 7874 7261 2c0a 2020 2020 2020  ra=extra,.      
+000261d0: 2020 2020 2020 7365 7276 6572 5f69 643d        server_id=
+000261e0: 7365 7276 6572 5f69 642c 0a20 2020 2020  server_id,.     
+000261f0: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+00026200: 3d73 656c 662c 0a20 2020 2020 2020 2029  =self,.        )
+00026210: 0a20 2020 2020 2020 2069 6620 7773 2e73  .        if ws.s
+00026220: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
+00026230: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
+00026240: 2020 2020 2073 656c 662e 7275 6e6e 696e       self.runnin
+00026250: 672e 6164 6428 7773 290a 0a20 2020 2020  g.add(ws)..     
+00026260: 2020 2064 6820 3d20 7365 6c66 2e68 6f73     dh = self.hos
+00026270: 745f 696e 666f 2e67 6574 2868 6f73 7429  t_info.get(host)
+00026280: 0a20 2020 2020 2020 2069 6620 6468 2069  .        if dh i
+00026290: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+000262a0: 2020 2020 7365 6c66 2e68 6f73 745f 696e      self.host_in
+000262b0: 666f 5b68 6f73 745d 203d 2064 6820 3d20  fo[host] = dh = 
+000262c0: 7b7d 0a0a 2020 2020 2020 2020 6468 5f61  {}..        dh_a
+000262d0: 6464 7265 7373 6573 203d 2064 682e 6765  ddresses = dh.ge
+000262e0: 7428 2261 6464 7265 7373 6573 2229 0a20  t("addresses"). 
+000262f0: 2020 2020 2020 2069 6620 6468 5f61 6464         if dh_add
+00026300: 7265 7373 6573 2069 7320 4e6f 6e65 3a0a  resses is None:.
+00026310: 2020 2020 2020 2020 2020 2020 6468 5b22              dh["
+00026320: 6164 6472 6573 7365 7322 5d20 3d20 6468  addresses"] = dh
+00026330: 5f61 6464 7265 7373 6573 203d 2073 6574  _addresses = set
+00026340: 2829 0a20 2020 2020 2020 2020 2020 2064  ().            d
+00026350: 685b 226e 7468 7265 6164 7322 5d20 3d20  h["nthreads"] = 
+00026360: 300a 0a20 2020 2020 2020 2064 685f 6164  0..        dh_ad
+00026370: 6472 6573 7365 732e 6164 6428 6164 6472  dresses.add(addr
+00026380: 6573 7329 0a20 2020 2020 2020 2064 685b  ess).        dh[
+00026390: 226e 7468 7265 6164 7322 5d20 2b3d 206e  "nthreads"] += n
+000263a0: 7468 7265 6164 730a 0a20 2020 2020 2020  threads..       
+000263b0: 2073 656c 662e 746f 7461 6c5f 6e74 6872   self.total_nthr
+000263c0: 6561 6473 202b 3d20 6e74 6872 6561 6473  eads += nthreads
+000263d0: 0a20 2020 2020 2020 2073 656c 662e 746f  .        self.to
+000263e0: 7461 6c5f 6e74 6872 6561 6473 5f68 6973  tal_nthreads_his
+000263f0: 746f 7279 2e61 7070 656e 6428 2874 696d  tory.append((tim
+00026400: 6528 292c 2073 656c 662e 746f 7461 6c5f  e(), self.total_
+00026410: 6e74 6872 6561 6473 2929 0a20 2020 2020  nthreads)).     
+00026420: 2020 2073 656c 662e 616c 6961 7365 735b     self.aliases[
+00026430: 6e61 6d65 5d20 3d20 6164 6472 6573 730a  name] = address.
+00026440: 0a20 2020 2020 2020 2073 656c 662e 6865  .        self.he
+00026450: 6172 7462 6561 745f 776f 726b 6572 280a  artbeat_worker(.
+00026460: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+00026470: 6573 733d 6164 6472 6573 732c 0a20 2020  ess=address,.   
+00026480: 2020 2020 2020 2020 2072 6573 6f6c 7665           resolve
+00026490: 5f61 6464 7265 7373 3d72 6573 6f6c 7665  _address=resolve
+000264a0: 5f61 6464 7265 7373 2c0a 2020 2020 2020  _address,.      
+000264b0: 2020 2020 2020 6e6f 773d 6e6f 772c 0a20        now=now,. 
+000264c0: 2020 2020 2020 2020 2020 2072 6573 6f75             resou
+000264d0: 7263 6573 3d72 6573 6f75 7263 6573 2c0a  rces=resources,.
+000264e0: 2020 2020 2020 2020 2020 2020 686f 7374              host
+000264f0: 5f69 6e66 6f3d 686f 7374 5f69 6e66 6f2c  _info=host_info,
+00026500: 0a20 2020 2020 2020 2020 2020 206d 6574  .            met
+00026510: 7269 6373 3d6d 6574 7269 6373 2c0a 2020  rics=metrics,.  
+00026520: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00026530: 2023 2044 6f20 6e6f 7420 6e65 6564 2074   # Do not need t
+00026540: 6f20 6164 6a75 7374 2073 656c 662e 746f  o adjust self.to
+00026550: 7461 6c5f 6f63 6375 7061 6e63 7920 6173  tal_occupancy as
+00026560: 2073 656c 662e 6f63 6375 7061 6e63 795b   self.occupancy[
+00026570: 7773 5d20 6361 6e6e 6f74 0a20 2020 2020  ws] cannot.     
+00026580: 2020 2023 2065 7869 7374 2062 6566 6f72     # exist befor
+00026590: 6520 7468 6973 2e0a 2020 2020 2020 2020  e this..        
+000265a0: 7365 6c66 2e63 6865 636b 5f69 646c 655f  self.check_idle_
+000265b0: 7361 7475 7261 7465 6428 7773 290a 0a20  saturated(ws).. 
+000265c0: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
+000265d0: 616d 5f63 6f6d 6d73 5b61 6464 7265 7373  am_comms[address
+000265e0: 5d20 3d20 4261 7463 6865 6453 656e 6428  ] = BatchedSend(
+000265f0: 696e 7465 7276 616c 3d22 356d 7322 2c20  interval="5ms", 
+00026600: 6c6f 6f70 3d73 656c 662e 6c6f 6f70 290a  loop=self.loop).
+00026610: 0a20 2020 2020 2020 2061 7761 6974 6162  .        awaitab
+00026620: 6c65 7320 3d20 5b5d 0a20 2020 2020 2020  les = [].       
+00026630: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
+00026640: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
+00026650: 2e76 616c 7565 7328 2929 3a0a 2020 2020  .values()):.    
+00026660: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00026670: 2020 2020 2020 2020 2020 2020 2072 6573               res
+00026680: 756c 7420 3d20 706c 7567 696e 2e61 6464  ult = plugin.add
+00026690: 5f77 6f72 6b65 7228 7363 6865 6475 6c65  _worker(schedule
+000266a0: 723d 7365 6c66 2c20 776f 726b 6572 3d61  r=self, worker=a
+000266b0: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+000266c0: 2020 2020 2020 2020 6966 2072 6573 756c          if resul
+000266d0: 7420 6973 206e 6f74 204e 6f6e 6520 616e  t is not None an
+000266e0: 6420 696e 7370 6563 742e 6973 6177 6169  d inspect.isawai
+000266f0: 7461 626c 6528 7265 7375 6c74 293a 0a20  table(result):. 
+00026700: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026710: 2020 2061 7761 6974 6162 6c65 732e 6170     awaitables.ap
+00026720: 7065 6e64 2872 6573 756c 7429 0a20 2020  pend(result).   
+00026730: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00026740: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+00026750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026760: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
+00026770: 2865 290a 0a20 2020 2020 2020 2070 6c75  (e)..        plu
+00026780: 6769 6e5f 6d73 6773 203d 2061 7761 6974  gin_msgs = await
+00026790: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+000267a0: 2a61 7761 6974 6162 6c65 732c 2072 6574  *awaitables, ret
+000267b0: 7572 6e5f 6578 6365 7074 696f 6e73 3d54  urn_exceptions=T
+000267c0: 7275 6529 0a20 2020 2020 2020 2070 6c75  rue).        plu
+000267d0: 6769 6e73 5f65 7863 6570 7469 6f6e 7320  gins_exceptions 
+000267e0: 3d20 5b6d 7367 2066 6f72 206d 7367 2069  = [msg for msg i
+000267f0: 6e20 706c 7567 696e 5f6d 7367 7320 6966  n plugin_msgs if
+00026800: 2069 7369 6e73 7461 6e63 6528 6d73 672c   isinstance(msg,
+00026810: 2045 7863 6570 7469 6f6e 295d 0a20 2020   Exception)].   
+00026820: 2020 2020 2066 6f72 2065 7863 2069 6e20       for exc in 
+00026830: 706c 7567 696e 735f 6578 6365 7074 696f  plugins_exceptio
+00026840: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00026850: 6c6f 6767 6572 2e65 7863 6570 7469 6f6e  logger.exception
+00026860: 2865 7863 2c20 6578 635f 696e 666f 3d65  (exc, exc_info=e
+00026870: 7863 290a 0a20 2020 2020 2020 2069 6620  xc)..        if 
+00026880: 7773 2e73 7461 7475 7320 3d3d 2053 7461  ws.status == Sta
+00026890: 7475 732e 7275 6e6e 696e 673a 0a20 2020  tus.running:.   
+000268a0: 2020 2020 2020 2020 2073 656c 662e 7472           self.tr
+000268b0: 616e 7369 7469 6f6e 7328 0a20 2020 2020  ansitions(.     
+000268c0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000268d0: 6275 6c6b 5f73 6368 6564 756c 655f 756e  bulk_schedule_un
+000268e0: 7275 6e6e 6162 6c65 5f61 6674 6572 5f61  runnable_after_a
+000268f0: 6464 696e 675f 776f 726b 6572 2877 7329  dding_worker(ws)
+00026900: 2c20 7374 696d 756c 7573 5f69 640a 2020  , stimulus_id.  
+00026910: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00026920: 2020 2020 2020 2020 7365 6c66 2e73 7469          self.sti
+00026930: 6d75 6c75 735f 7175 6575 655f 736c 6f74  mulus_queue_slot
+00026940: 735f 6d61 7962 655f 6f70 656e 6564 2873  s_maybe_opened(s
+00026950: 7469 6d75 6c75 735f 6964 3d73 7469 6d75  timulus_id=stimu
+00026960: 6c75 735f 6964 290a 0a20 2020 2020 2020  lus_id)..       
+00026970: 206c 6f67 6765 722e 696e 666f 2822 5265   logger.info("Re
+00026980: 6769 7374 6572 2077 6f72 6b65 7220 2573  gister worker %s
+00026990: 222c 2077 7329 0a0a 2020 2020 2020 2020  ", ws)..        
+000269a0: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
+000269b0: 2020 2020 2273 7461 7475 7322 3a20 224f      "status": "O
+000269c0: 4b22 2c0a 2020 2020 2020 2020 2020 2020  K",.            
+000269d0: 2274 696d 6522 3a20 7469 6d65 2829 2c0a  "time": time(),.
+000269e0: 2020 2020 2020 2020 2020 2020 2268 6561              "hea
+000269f0: 7274 6265 6174 2d69 6e74 6572 7661 6c22  rtbeat-interval"
+00026a00: 3a20 6865 6172 7462 6561 745f 696e 7465  : heartbeat_inte
+00026a10: 7276 616c 286c 656e 2873 656c 662e 776f  rval(len(self.wo
+00026a20: 726b 6572 7329 292c 0a20 2020 2020 2020  rkers)),.       
+00026a30: 2020 2020 2022 776f 726b 6572 2d70 6c75       "worker-plu
+00026a40: 6769 6e73 223a 2073 656c 662e 776f 726b  gins": self.work
+00026a50: 6572 5f70 6c75 6769 6e73 2c0a 2020 2020  er_plugins,.    
+00026a60: 2020 2020 7d0a 0a20 2020 2020 2020 2076      }..        v
+00026a70: 6572 7369 6f6e 5f77 6172 6e69 6e67 203d  ersion_warning =
+00026a80: 2076 6572 7369 6f6e 5f6d 6f64 756c 652e   version_module.
+00026a90: 6572 726f 725f 6d65 7373 6167 6528 0a20  error_message(. 
+00026aa0: 2020 2020 2020 2020 2020 2076 6572 7369             versi
+00026ab0: 6f6e 5f6d 6f64 756c 652e 6765 745f 7665  on_module.get_ve
+00026ac0: 7273 696f 6e73 2829 2c0a 2020 2020 2020  rsions(),.      
+00026ad0: 2020 2020 2020 7b77 3a20 7773 2e76 6572        {w: ws.ver
+00026ae0: 7369 6f6e 7320 666f 7220 772c 2077 7320  sions for w, ws 
+00026af0: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+00026b00: 6974 656d 7328 297d 2c0a 2020 2020 2020  items()},.      
+00026b10: 2020 2020 2020 7665 7273 696f 6e73 2c0a        versions,.
+00026b20: 2020 2020 2020 2020 2020 2020 736f 7572              sour
+00026b30: 6365 5f6e 616d 653d 7374 7228 7773 2e73  ce_name=str(ws.s
+00026b40: 6572 7665 725f 6964 292c 0a20 2020 2020  erver_id),.     
+00026b50: 2020 2029 0a20 2020 2020 2020 206d 7367     ).        msg
+00026b60: 2e75 7064 6174 6528 7665 7273 696f 6e5f  .update(version_
+00026b70: 7761 726e 696e 6729 0a0a 2020 2020 2020  warning)..      
+00026b80: 2020 6177 6169 7420 636f 6d6d 2e77 7269    await comm.wri
+00026b90: 7465 286d 7367 290a 2020 2020 2020 2020  te(msg).        
+00026ba0: 2320 5468 6973 2077 696c 6c20 6b65 6570  # This will keep
+00026bb0: 2072 756e 6e69 6e67 2075 6e74 696c 2074   running until t
+00026bc0: 6865 2077 6f72 6b65 7220 6973 2072 656d  he worker is rem
+00026bd0: 6f76 6564 0a20 2020 2020 2020 2061 7761  oved.        awa
+00026be0: 6974 2073 656c 662e 6861 6e64 6c65 5f77  it self.handle_w
+00026bf0: 6f72 6b65 7228 636f 6d6d 2c20 6164 6472  orker(comm, addr
+00026c00: 6573 7329 0a0a 2020 2020 6173 796e 6320  ess)..    async 
+00026c10: 6465 6620 6164 645f 6e61 6e6e 7928 7365  def add_nanny(se
+00026c20: 6c66 2c20 636f 6d6d 3a20 436f 6d6d 2c20  lf, comm: Comm, 
+00026c30: 6164 6472 6573 733a 2073 7472 2920 2d3e  address: str) ->
+00026c40: 204e 6f6e 653a 0a20 2020 2020 2020 2061   None:.        a
+00026c50: 7379 6e63 2077 6974 6820 7365 6c66 2e5f  sync with self._
+00026c60: 7374 6172 7469 6e67 5f6e 616e 6e69 6573  starting_nannies
+00026c70: 5f63 6f6e 643a 0a20 2020 2020 2020 2020  _cond:.         
+00026c80: 2020 2073 656c 662e 5f73 7461 7274 696e     self._startin
+00026c90: 675f 6e61 6e6e 6965 732e 6164 6428 6164  g_nannies.add(ad
+00026ca0: 6472 6573 7329 0a20 2020 2020 2020 2074  dress).        t
+00026cb0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00026cc0: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
+00026cd0: 2020 2020 2020 2020 2273 7461 7475 7322          "status"
+00026ce0: 3a20 224f 4b22 2c0a 2020 2020 2020 2020  : "OK",.        
+00026cf0: 2020 2020 2020 2020 226e 616e 6e79 2d70          "nanny-p
+00026d00: 6c75 6769 6e73 223a 2073 656c 662e 6e61  lugins": self.na
+00026d10: 6e6e 795f 706c 7567 696e 732c 0a20 2020  nny_plugins,.   
+00026d20: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
+00026d30: 2020 2020 2020 2061 7761 6974 2063 6f6d         await com
+00026d40: 6d2e 7772 6974 6528 6d73 6729 0a20 2020  m.write(msg).   
+00026d50: 2020 2020 2020 2020 2061 7761 6974 2063           await c
+00026d60: 6f6d 6d2e 7265 6164 2829 0a20 2020 2020  omm.read().     
+00026d70: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
+00026d80: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
+00026d90: 7468 2073 656c 662e 5f73 7461 7274 696e  th self._startin
+00026da0: 675f 6e61 6e6e 6965 735f 636f 6e64 3a0a  g_nannies_cond:.
 00026db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
 00026dc0: 7365 6c66 2e5f 7374 6172 7469 6e67 5f6e  self._starting_n
-00026dd0: 616e 6e69 6573 5f63 6f6e 642e 6e6f 7469  annies_cond.noti
-00026de0: 6679 5f61 6c6c 2829 0a0a 2020 2020 6465  fy_all()..    de
-00026df0: 6620 5f6d 6174 6368 5f67 7261 7068 5f77  f _match_graph_w
-00026e00: 6974 685f 7461 736b 7328 0a20 2020 2020  ith_tasks(.     
-00026e10: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00026e20: 2064 736b 3a20 6469 6374 5b4b 6579 2c20   dsk: dict[Key, 
-00026e30: 545f 7275 6e73 7065 635d 2c0a 2020 2020  T_runspec],.    
-00026e40: 2020 2020 6465 7065 6e64 656e 6369 6573      dependencies
-00026e50: 3a20 6469 6374 5b4b 6579 2c20 7365 745b  : dict[Key, set[
-00026e60: 4b65 795d 5d2c 0a20 2020 2020 2020 206b  Key]],.        k
-00026e70: 6579 733a 2073 6574 5b4b 6579 5d2c 0a20  eys: set[Key],. 
-00026e80: 2020 2029 202d 3e20 7365 745b 4b65 795d     ) -> set[Key]
-00026e90: 3a0a 2020 2020 2020 2020 6e20 3d20 300a  :.        n = 0.
-00026ea0: 2020 2020 2020 2020 6c6f 7374 5f6b 6579          lost_key
-00026eb0: 7320 3d20 7365 7428 290a 2020 2020 2020  s = set().      
-00026ec0: 2020 7768 696c 6520 6c65 6e28 6473 6b29    while len(dsk)
-00026ed0: 2021 3d20 6e3a 2020 2320 7761 6c6b 2074   != n:  # walk t
-00026ee0: 6872 6f75 6768 206e 6577 2074 6173 6b73  hrough new tasks
-00026ef0: 2c20 6361 6e63 656c 2061 6e79 2062 6164  , cancel any bad
-00026f00: 2064 6570 730a 2020 2020 2020 2020 2020   deps.          
-00026f10: 2020 6e20 3d20 6c65 6e28 6473 6b29 0a20    n = len(dsk). 
-00026f20: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-00026f30: 2c20 6465 7073 2069 6e20 6c69 7374 2864  , deps in list(d
-00026f40: 6570 656e 6465 6e63 6965 732e 6974 656d  ependencies.item
-00026f50: 7328 2929 3a0a 2020 2020 2020 2020 2020  s()):.          
-00026f60: 2020 2020 2020 6966 2061 6e79 280a 2020        if any(.  
-00026f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00026f80: 2020 6465 7020 6e6f 7420 696e 2073 656c    dep not in sel
-00026f90: 662e 7461 736b 7320 616e 6420 6465 7020  f.tasks and dep 
-00026fa0: 6e6f 7420 696e 2064 736b 2066 6f72 2064  not in dsk for d
-00026fb0: 6570 2069 6e20 6465 7073 0a20 2020 2020  ep in deps.     
-00026fc0: 2020 2020 2020 2020 2020 2029 3a20 2023             ):  #
-00026fd0: 2062 6164 206b 6579 0a20 2020 2020 2020   bad key.       
-00026fe0: 2020 2020 2020 2020 2020 2020 206c 6f73               los
-00026ff0: 745f 6b65 7973 2e61 6464 286b 290a 2020  t_keys.add(k).  
-00027000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027010: 2020 6c6f 6767 6572 2e69 6e66 6f28 2255    logger.info("U
-00027020: 7365 7220 6173 6b65 6420 666f 7220 636f  ser asked for co
-00027030: 6d70 7574 6174 696f 6e20 6f6e 206c 6f73  mputation on los
-00027040: 7420 6461 7461 2c20 2573 222c 206b 290a  t data, %s", k).
-00027050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027060: 2020 2020 6465 6c20 6473 6b5b 6b5d 0a20      del dsk[k]. 
-00027070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027080: 2020 2064 656c 2064 6570 656e 6465 6e63     del dependenc
-00027090: 6965 735b 6b5d 0a20 2020 2020 2020 2020  ies[k].         
-000270a0: 2020 2020 2020 2020 2020 2069 6620 6b20             if k 
-000270b0: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
-000270c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000270d0: 206b 6579 732e 7265 6d6f 7665 286b 290a   keys.remove(k).
-000270e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000270f0: 6465 6c20 6465 7073 0a20 2020 2020 2020  del deps.       
-00027100: 2023 2041 766f 6964 2063 6f6d 7075 7461   # Avoid computa
-00027110: 7469 6f6e 2074 6861 7420 6973 2061 6c72  tion that is alr
-00027120: 6561 6479 2066 696e 6973 6865 640a 2020  eady finished.  
-00027130: 2020 2020 2020 646f 6e65 203d 2073 6574        done = set
-00027140: 2829 2020 2320 7461 736b 7320 7468 6174  ()  # tasks that
-00027150: 2061 7265 2061 6c72 6561 6479 2064 6f6e   are already don
-00027160: 650a 2020 2020 2020 2020 666f 7220 6b2c  e.        for k,
-00027170: 2076 2069 6e20 6465 7065 6e64 656e 6369   v in dependenci
-00027180: 6573 2e69 7465 6d73 2829 3a0a 2020 2020  es.items():.    
-00027190: 2020 2020 2020 2020 6966 2076 2061 6e64          if v and
-000271a0: 206b 2069 6e20 7365 6c66 2e74 6173 6b73   k in self.tasks
-000271b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000271c0: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
-000271d0: 735b 6b5d 0a20 2020 2020 2020 2020 2020  s[k].           
-000271e0: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
-000271f0: 2069 6e20 2822 6d65 6d6f 7279 222c 2022   in ("memory", "
-00027200: 6572 7265 6422 293a 0a20 2020 2020 2020  erred"):.       
-00027210: 2020 2020 2020 2020 2020 2020 2064 6f6e               don
-00027220: 652e 6164 6428 6b29 0a0a 2020 2020 2020  e.add(k)..      
-00027230: 2020 6966 2064 6f6e 653a 0a20 2020 2020    if done:.     
-00027240: 2020 2020 2020 2064 6570 656e 6465 6e74         dependent
-00027250: 7320 3d20 6461 736b 2e63 6f72 652e 7265  s = dask.core.re
-00027260: 7665 7273 655f 6469 6374 2864 6570 656e  verse_dict(depen
-00027270: 6465 6e63 6965 7329 0a20 2020 2020 2020  dencies).       
-00027280: 2020 2020 2073 7461 636b 203d 206c 6973       stack = lis
-00027290: 7428 646f 6e65 290a 2020 2020 2020 2020  t(done).        
-000272a0: 2020 2020 7768 696c 6520 7374 6163 6b3a      while stack:
-000272b0: 2020 2320 7265 6d6f 7665 2075 6e6e 6563    # remove unnec
-000272c0: 6573 7361 7279 2064 6570 656e 6465 6e63  essary dependenc
-000272d0: 6965 730a 2020 2020 2020 2020 2020 2020  ies.            
-000272e0: 2020 2020 6b65 7920 3d20 7374 6163 6b2e      key = stack.
-000272f0: 706f 7028 290a 2020 2020 2020 2020 2020  pop().          
-00027300: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00027310: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00027320: 6570 7320 3d20 6465 7065 6e64 656e 6369  eps = dependenci
-00027330: 6573 5b6b 6579 5d0a 2020 2020 2020 2020  es[key].        
-00027340: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-00027350: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-00027360: 2020 2020 2020 2020 2020 2020 2064 6570               dep
-00027370: 7320 3d20 7b74 732e 6b65 7920 666f 7220  s = {ts.key for 
-00027380: 7473 2069 6e20 7365 6c66 2e74 6173 6b73  ts in self.tasks
-00027390: 5b6b 6579 5d2e 6465 7065 6e64 656e 6369  [key].dependenci
-000273a0: 6573 7d0a 2020 2020 2020 2020 2020 2020  es}.            
-000273b0: 2020 2020 666f 7220 6465 7020 696e 2064      for dep in d
-000273c0: 6570 733a 0a20 2020 2020 2020 2020 2020  eps:.           
-000273d0: 2020 2020 2020 2020 2069 6620 6465 7020           if dep 
-000273e0: 696e 2064 6570 656e 6465 6e74 733a 0a20  in dependents:. 
-000273f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027400: 2020 2020 2020 2063 6869 6c64 5f64 6570         child_dep
-00027410: 7320 3d20 6465 7065 6e64 656e 7473 5b64  s = dependents[d
-00027420: 6570 5d0a 2020 2020 2020 2020 2020 2020  ep].            
-00027430: 2020 2020 2020 2020 656c 6966 2064 6570          elif dep
-00027440: 2069 6e20 7365 6c66 2e74 6173 6b73 3a0a   in self.tasks:.
-00027450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027460: 2020 2020 2020 2020 6368 696c 645f 6465          child_de
-00027470: 7073 203d 207b 7473 2e6b 6579 2066 6f72  ps = {ts.key for
-00027480: 2074 7320 696e 2073 656c 662e 7461 736b   ts in self.task
-00027490: 735b 6b65 795d 2e64 6570 656e 6465 6e63  s[key].dependenc
-000274a0: 6965 737d 0a20 2020 2020 2020 2020 2020  ies}.           
-000274b0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-000274c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000274d0: 2020 2020 2020 2063 6869 6c64 5f64 6570         child_dep
-000274e0: 7320 3d20 7365 7428 290a 2020 2020 2020  s = set().      
-000274f0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00027500: 2061 6c6c 2864 2069 6e20 646f 6e65 2066   all(d in done f
-00027510: 6f72 2064 2069 6e20 6368 696c 645f 6465  or d in child_de
-00027520: 7073 293a 0a20 2020 2020 2020 2020 2020  ps):.           
-00027530: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00027540: 6465 7020 696e 2073 656c 662e 7461 736b  dep in self.task
-00027550: 7320 616e 6420 6465 7020 6e6f 7420 696e  s and dep not in
-00027560: 2064 6f6e 653a 0a20 2020 2020 2020 2020   done:.         
-00027570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00027580: 2020 2064 6f6e 652e 6164 6428 6465 7029     done.add(dep)
-00027590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000275a0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-000275b0: 636b 2e61 7070 656e 6428 6465 7029 0a20  ck.append(dep). 
-000275c0: 2020 2020 2020 2066 6f72 2061 6e63 2069         for anc i
-000275d0: 6e20 646f 6e65 3a0a 2020 2020 2020 2020  n done:.        
-000275e0: 2020 2020 6473 6b2e 706f 7028 616e 632c      dsk.pop(anc,
-000275f0: 204e 6f6e 6529 0a20 2020 2020 2020 2020   None).         
-00027600: 2020 2064 6570 656e 6465 6e63 6965 732e     dependencies.
-00027610: 706f 7028 616e 632c 204e 6f6e 6529 0a20  pop(anc, None). 
-00027620: 2020 2020 2020 2072 6574 7572 6e20 6c6f         return lo
-00027630: 7374 5f6b 6579 730a 0a20 2020 2064 6566  st_keys..    def
-00027640: 205f 6372 6561 7465 5f74 6173 6b73 7461   _create_tasksta
-00027650: 7465 5f66 726f 6d5f 6772 6170 6828 0a20  te_from_graph(. 
-00027660: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00027670: 2020 2020 202a 2c0a 2020 2020 2020 2020       *,.        
-00027680: 7374 6172 743a 2066 6c6f 6174 2c0a 2020  start: float,.  
-00027690: 2020 2020 2020 6473 6b3a 2064 6963 745b        dsk: dict[
-000276a0: 4b65 792c 2054 5f72 756e 7370 6563 5d2c  Key, T_runspec],
-000276b0: 0a20 2020 2020 2020 2064 6570 656e 6465  .        depende
-000276c0: 6e63 6965 733a 2064 6963 742c 0a20 2020  ncies: dict,.   
-000276d0: 2020 2020 206b 6579 733a 2073 6574 5b4b       keys: set[K
-000276e0: 6579 5d2c 0a20 2020 2020 2020 206f 7264  ey],.        ord
-000276f0: 6572 6564 3a20 6469 6374 5b4b 6579 2c20  ered: dict[Key, 
-00027700: 696e 745d 2c0a 2020 2020 2020 2020 636c  int],.        cl
-00027710: 6965 6e74 3a20 7374 722c 0a20 2020 2020  ient: str,.     
-00027720: 2020 2061 6e6e 6f74 6174 696f 6e73 5f62     annotations_b
-00027730: 795f 7479 7065 3a20 6469 6374 2c0a 2020  y_type: dict,.  
-00027740: 2020 2020 2020 676c 6f62 616c 5f61 6e6e        global_ann
-00027750: 6f74 6174 696f 6e73 3a20 6469 6374 207c  otations: dict |
-00027760: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
-00027770: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
-00027780: 0a20 2020 2020 2020 2073 7562 6d69 7474  .        submitt
-00027790: 696e 675f 7461 736b 3a20 4b65 7920 7c20  ing_task: Key | 
-000277a0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7573  None,.        us
-000277b0: 6572 5f70 7269 6f72 6974 793a 2069 6e74  er_priority: int
-000277c0: 207c 2064 6963 745b 4b65 792c 2069 6e74   | dict[Key, int
-000277d0: 5d20 3d20 302c 0a20 2020 2020 2020 2061  ] = 0,.        a
-000277e0: 6374 6f72 733a 2062 6f6f 6c20 7c20 6c69  ctors: bool | li
-000277f0: 7374 5b4b 6579 5d20 7c20 4e6f 6e65 203d  st[Key] | None =
-00027800: 204e 6f6e 652c 0a20 2020 2020 2020 2066   None,.        f
-00027810: 6966 6f5f 7469 6d65 6f75 743a 2066 6c6f  ifo_timeout: flo
-00027820: 6174 203d 2030 2e30 2c0a 2020 2020 2020  at = 0.0,.      
-00027830: 2020 636f 6465 3a20 7475 706c 655b 536f    code: tuple[So
-00027840: 7572 6365 436f 6465 2c20 2e2e 2e5d 203d  urceCode, ...] =
-00027850: 2028 292c 0a20 2020 2029 202d 3e20 4e6f   (),.    ) -> No
-00027860: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
-00027870: 2020 2020 2020 2020 5461 6b65 2061 206c          Take a l
-00027880: 6f77 206c 6576 656c 2067 7261 7068 2061  ow level graph a
-00027890: 6e64 2063 7265 6174 6520 7468 6520 6e65  nd create the ne
-000278a0: 6365 7373 6172 7920 7363 6865 6475 6c65  cessary schedule
-000278b0: 7220 7374 6174 6520 746f 0a20 2020 2020  r state to.     
-000278c0: 2020 2063 6f6d 7075 7465 2069 742e 0a0a     compute it...
-000278d0: 2020 2020 2020 2020 5741 524e 494e 470a          WARNING.
-000278e0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d0a          -------.
-000278f0: 2020 2020 2020 2020 5468 6973 206d 6574          This met
-00027900: 686f 6420 6d75 7374 206e 6f74 2062 6520  hod must not be 
-00027910: 6d61 6465 2061 7379 6e63 2073 696e 6365  made async since
-00027920: 206e 6f74 6869 6e67 2068 6572 6520 6973   nothing here is
-00027930: 2063 6f6e 6375 7272 656e 6379 0a20 2020   concurrency.   
-00027940: 2020 2020 2073 6166 652e 2041 6c6c 2069       safe. All i
-00027950: 6e74 6572 6163 7469 6f6e 7320 7769 7468  nteractions with
-00027960: 2054 6173 6b53 7461 7465 206f 626a 6563   TaskState objec
-00027970: 7473 2068 6572 6520 7368 6f75 6c64 2062  ts here should b
-00027980: 6520 6861 7070 656e 696e 670a 2020 2020  e happening.    
-00027990: 2020 2020 696e 2074 6865 2073 616d 6520      in the same 
-000279a0: 6576 656e 7420 6c6f 6f70 2074 6963 6b2e  event loop tick.
-000279b0: 0a20 2020 2020 2020 2022 2222 0a0a 2020  .        """..  
-000279c0: 2020 2020 2020 6c6f 7374 5f6b 6579 7320        lost_keys 
-000279d0: 3d20 7365 6c66 2e5f 6d61 7463 685f 6772  = self._match_gr
-000279e0: 6170 685f 7769 7468 5f74 6173 6b73 2864  aph_with_tasks(d
-000279f0: 736b 2c20 6465 7065 6e64 656e 6369 6573  sk, dependencies
-00027a00: 2c20 6b65 7973 290a 0a20 2020 2020 2020  , keys)..       
-00027a10: 2069 6620 6c65 6e28 6473 6b29 203e 2031   if len(dsk) > 1
-00027a20: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00027a30: 6c66 2e6c 6f67 5f65 7665 6e74 280a 2020  lf.log_event(.  
-00027a40: 2020 2020 2020 2020 2020 2020 2020 5b22                ["
-00027a50: 616c 6c22 2c20 636c 6965 6e74 5d2c 207b  all", client], {
-00027a60: 2261 6374 696f 6e22 3a20 2275 7064 6174  "action": "updat
-00027a70: 655f 6772 6170 6822 2c20 2263 6f75 6e74  e_graph", "count
-00027a80: 223a 206c 656e 2864 736b 297d 0a20 2020  ": len(dsk)}.   
-00027a90: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00027aa0: 2020 2020 6966 206c 6f73 745f 6b65 7973      if lost_keys
-00027ab0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00027ac0: 6c66 2e72 6570 6f72 7428 7b22 6f70 223a  lf.report({"op":
-00027ad0: 2022 6361 6e63 656c 6c65 642d 6b65 7973   "cancelled-keys
-00027ae0: 222c 2022 6b65 7973 223a 206c 6f73 745f  ", "keys": lost_
-00027af0: 6b65 7973 7d2c 2063 6c69 656e 743d 636c  keys}, client=cl
-00027b00: 6965 6e74 290a 2020 2020 2020 2020 2020  ient).          
-00027b10: 2020 7365 6c66 2e63 6c69 656e 745f 7265    self.client_re
-00027b20: 6c65 6173 6573 5f6b 6579 7328 0a20 2020  leases_keys(.   
-00027b30: 2020 2020 2020 2020 2020 2020 206b 6579               key
-00027b40: 733d 6c6f 7374 5f6b 6579 732c 2063 6c69  s=lost_keys, cli
-00027b50: 656e 743d 636c 6965 6e74 2c20 7374 696d  ent=client, stim
-00027b60: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-00027b70: 5f69 640a 2020 2020 2020 2020 2020 2020  _id.            
-00027b80: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-00027b90: 7420 7365 6c66 2e69 735f 6964 6c65 2061  t self.is_idle a
-00027ba0: 6e64 2073 656c 662e 636f 6d70 7574 6174  nd self.computat
-00027bb0: 696f 6e73 3a0a 2020 2020 2020 2020 2020  ions:.          
-00027bc0: 2020 2320 5374 696c 6c20 776f 726b 696e    # Still workin
-00027bd0: 6720 6f6e 2073 6f6d 6574 6869 6e67 2e20  g on something. 
-00027be0: 4173 7369 676e 206e 6577 2074 6173 6b73  Assign new tasks
-00027bf0: 2074 6f20 7361 6d65 2063 6f6d 7075 7461   to same computa
-00027c00: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-00027c10: 2063 6f6d 7075 7461 7469 6f6e 203d 2073   computation = s
-00027c20: 656c 662e 636f 6d70 7574 6174 696f 6e73  elf.computations
-00027c30: 5b2d 315d 0a20 2020 2020 2020 2065 6c73  [-1].        els
-00027c40: 653a 0a20 2020 2020 2020 2020 2020 2063  e:.            c
-00027c50: 6f6d 7075 7461 7469 6f6e 203d 2043 6f6d  omputation = Com
-00027c60: 7075 7461 7469 6f6e 2829 0a20 2020 2020  putation().     
-00027c70: 2020 2020 2020 2073 656c 662e 636f 6d70         self.comp
-00027c80: 7574 6174 696f 6e73 2e61 7070 656e 6428  utations.append(
-00027c90: 636f 6d70 7574 6174 696f 6e29 0a0a 2020  computation)..  
-00027ca0: 2020 2020 2020 6966 2063 6f64 653a 2020        if code:  
-00027cb0: 2320 6164 6420 6e65 7720 636f 6465 2062  # add new code b
-00027cc0: 6c6f 636b 730a 2020 2020 2020 2020 2020  locks.          
-00027cd0: 2020 636f 6d70 7574 6174 696f 6e2e 636f    computation.co
-00027ce0: 6465 2e61 6464 2863 6f64 6529 0a20 2020  de.add(code).   
-00027cf0: 2020 2020 2069 6620 676c 6f62 616c 5f61       if global_a
-00027d00: 6e6e 6f74 6174 696f 6e73 3a0a 2020 2020  nnotations:.    
-00027d10: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
-00027d20: 2054 6869 7320 6973 206b 696e 6420 6f66   This is kind of
-00027d30: 2069 6e63 6f6e 7369 7374 656e 7420 7369   inconsistent si
-00027d40: 6e63 6520 6974 206f 6e6c 7920 696e 636c  nce it only incl
-00027d50: 7564 6573 2067 6c6f 6261 6c0a 2020 2020  udes global.    
-00027d60: 2020 2020 2020 2020 2320 616e 6e6f 7461          # annota
-00027d70: 7469 6f6e 732e 0a20 2020 2020 2020 2020  tions..         
-00027d80: 2020 2063 6f6d 7075 7461 7469 6f6e 2e61     computation.a
-00027d90: 6e6e 6f74 6174 696f 6e73 2e75 7064 6174  nnotations.updat
-00027da0: 6528 676c 6f62 616c 5f61 6e6e 6f74 6174  e(global_annotat
-00027db0: 696f 6e73 290a 2020 2020 2020 2020 6465  ions).        de
-00027dc0: 6c20 676c 6f62 616c 5f61 6e6e 6f74 6174  l global_annotat
-00027dd0: 696f 6e73 0a0a 2020 2020 2020 2020 7275  ions..        ru
-00027de0: 6e6e 6162 6c65 2c20 746f 7563 6865 645f  nnable, touched_
-00027df0: 7461 736b 732c 206e 6577 5f74 6173 6b73  tasks, new_tasks
-00027e00: 203d 2073 656c 662e 5f67 656e 6572 6174   = self._generat
-00027e10: 655f 7461 736b 7374 6174 6573 280a 2020  e_taskstates(.  
-00027e20: 2020 2020 2020 2020 2020 6b65 7973 3d6b            keys=k
-00027e30: 6579 732c 0a20 2020 2020 2020 2020 2020  eys,.           
-00027e40: 2064 736b 3d64 736b 2c0a 2020 2020 2020   dsk=dsk,.      
-00027e50: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
-00027e60: 6573 3d64 6570 656e 6465 6e63 6965 732c  es=dependencies,
-00027e70: 0a20 2020 2020 2020 2020 2020 2063 6f6d  .            com
-00027e80: 7075 7461 7469 6f6e 3d63 6f6d 7075 7461  putation=computa
-00027e90: 7469 6f6e 2c0a 2020 2020 2020 2020 290a  tion,.        ).
-00027ea0: 0a20 2020 2020 2020 206b 6579 735f 7769  .        keys_wi
-00027eb0: 7468 5f61 6e6e 6f74 6174 696f 6e73 203d  th_annotations =
-00027ec0: 2073 656c 662e 5f61 7070 6c79 5f61 6e6e   self._apply_ann
-00027ed0: 6f74 6174 696f 6e73 280a 2020 2020 2020  otations(.      
-00027ee0: 2020 2020 2020 7461 736b 733d 6e65 775f        tasks=new_
-00027ef0: 7461 736b 732c 0a20 2020 2020 2020 2020  tasks,.         
-00027f00: 2020 2061 6e6e 6f74 6174 696f 6e73 5f62     annotations_b
-00027f10: 795f 7479 7065 3d61 6e6e 6f74 6174 696f  y_type=annotatio
-00027f20: 6e73 5f62 795f 7479 7065 2c0a 2020 2020  ns_by_type,.    
-00027f30: 2020 2020 290a 0a20 2020 2020 2020 2073      )..        s
-00027f40: 656c 662e 5f73 6574 5f70 7269 6f72 6974  elf._set_priorit
-00027f50: 6965 7328 0a20 2020 2020 2020 2020 2020  ies(.           
-00027f60: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
-00027f70: 7479 3d6f 7264 6572 6564 2c0a 2020 2020  ty=ordered,.    
-00027f80: 2020 2020 2020 2020 7375 626d 6974 7469          submitti
-00027f90: 6e67 5f74 6173 6b3d 7375 626d 6974 7469  ng_task=submitti
-00027fa0: 6e67 5f74 6173 6b2c 0a20 2020 2020 2020  ng_task,.       
-00027fb0: 2020 2020 2075 7365 725f 7072 696f 7269       user_priori
-00027fc0: 7479 3d75 7365 725f 7072 696f 7269 7479  ty=user_priority
-00027fd0: 2c0a 2020 2020 2020 2020 2020 2020 6669  ,.            fi
-00027fe0: 666f 5f74 696d 656f 7574 3d66 6966 6f5f  fo_timeout=fifo_
-00027ff0: 7469 6d65 6f75 742c 0a20 2020 2020 2020  timeout,.       
-00028000: 2020 2020 2073 7461 7274 3d73 7461 7274       start=start
-00028010: 2c0a 2020 2020 2020 2020 2020 2020 7461  ,.            ta
-00028020: 736b 733d 7275 6e6e 6162 6c65 2c0a 2020  sks=runnable,.  
-00028030: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00028040: 2073 656c 662e 636c 6965 6e74 5f64 6573   self.client_des
-00028050: 6972 6573 5f6b 6579 7328 6b65 7973 3d6b  ires_keys(keys=k
-00028060: 6579 732c 2063 6c69 656e 743d 636c 6965  eys, client=clie
-00028070: 6e74 290a 0a20 2020 2020 2020 2023 2041  nt)..        # A
-00028080: 6464 2061 6374 6f72 730a 2020 2020 2020  dd actors.      
-00028090: 2020 6966 2061 6374 6f72 7320 6973 2054    if actors is T
-000280a0: 7275 653a 0a20 2020 2020 2020 2020 2020  rue:.           
-000280b0: 2061 6374 6f72 7320 3d20 6c69 7374 286b   actors = list(k
-000280c0: 6579 7329 0a20 2020 2020 2020 2066 6f72  eys).        for
-000280d0: 2061 6374 6f72 2069 6e20 6163 746f 7273   actor in actors
-000280e0: 206f 7220 5b5d 3a0a 2020 2020 2020 2020   or []:.        
-000280f0: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
-00028100: 736b 735b 6163 746f 725d 0a20 2020 2020  sks[actor].     
-00028110: 2020 2020 2020 2074 732e 6163 746f 7220         ts.actor 
-00028120: 3d20 5472 7565 0a0a 2020 2020 2020 2020  = True..        
-00028130: 2320 436f 6d70 7574 6520 7265 636f 6d6d  # Compute recomm
-00028140: 656e 6461 7469 6f6e 730a 2020 2020 2020  endations.      
-00028150: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-00028160: 733a 2052 6563 7320 3d20 7b7d 0a20 2020  s: Recs = {}.   
-00028170: 2020 2020 2070 7269 6f72 6974 7920 3d20       priority = 
-00028180: 6469 6374 2829 0a20 2020 2020 2020 2066  dict().        f
-00028190: 6f72 2074 7320 696e 2073 6f72 7465 6428  or ts in sorted(
-000281a0: 0a20 2020 2020 2020 2020 2020 2072 756e  .            run
-000281b0: 6e61 626c 652c 0a20 2020 2020 2020 2020  nable,.         
-000281c0: 2020 206b 6579 3d6f 7065 7261 746f 722e     key=operator.
-000281d0: 6174 7472 6765 7474 6572 2822 7072 696f  attrgetter("prio
-000281e0: 7269 7479 2229 2c0a 2020 2020 2020 2020  rity"),.        
-000281f0: 2020 2020 7265 7665 7273 653d 5472 7565      reverse=True
-00028200: 2c0a 2020 2020 2020 2020 293a 0a20 2020  ,.        ):.   
-00028210: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00028220: 7473 2e70 7269 6f72 6974 7920 2023 206d  ts.priority  # m
-00028230: 7970 790a 2020 2020 2020 2020 2020 2020  ypy.            
-00028240: 7072 696f 7269 7479 5b74 732e 6b65 795d  priority[ts.key]
-00028250: 203d 2074 732e 7072 696f 7269 7479 0a20   = ts.priority. 
-00028260: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00028270: 7420 7473 2e72 756e 5f73 7065 630a 2020  t ts.run_spec.  
-00028280: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
-00028290: 7374 6174 6520 3d3d 2022 7265 6c65 6173  state == "releas
-000282a0: 6564 223a 0a20 2020 2020 2020 2020 2020  ed":.           
-000282b0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-000282c0: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
-000282d0: 7761 6974 696e 6722 0a0a 2020 2020 2020  waiting"..      
-000282e0: 2020 666f 7220 7473 2069 6e20 7275 6e6e    for ts in runn
-000282f0: 6162 6c65 3a0a 2020 2020 2020 2020 2020  able:.          
-00028300: 2020 666f 7220 6474 7320 696e 2074 732e    for dts in ts.
-00028310: 6465 7065 6e64 656e 6369 6573 3a0a 2020  dependencies:.  
-00028320: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00028330: 2064 7473 2e65 7863 6570 7469 6f6e 5f62   dts.exception_b
-00028340: 6c61 6d65 3a0a 2020 2020 2020 2020 2020  lame:.          
-00028350: 2020 2020 2020 2020 2020 7473 2e65 7863            ts.exc
-00028360: 6570 7469 6f6e 5f62 6c61 6d65 203d 2064  eption_blame = d
-00028370: 7473 2e65 7863 6570 7469 6f6e 5f62 6c61  ts.exception_bla
-00028380: 6d65 0a20 2020 2020 2020 2020 2020 2020  me.             
-00028390: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
-000283a0: 6174 696f 6e73 5b74 732e 6b65 795d 203d  ations[ts.key] =
-000283b0: 2022 6572 7265 6422 0a20 2020 2020 2020   "erred".       
-000283c0: 2020 2020 2020 2020 2020 2020 2062 7265               bre
-000283d0: 616b 0a0a 2020 2020 2020 2020 616e 6e6f  ak..        anno
-000283e0: 7461 7469 6f6e 735f 666f 725f 706c 7567  tations_for_plug
-000283f0: 696e 3a20 6465 6661 756c 7464 6963 745b  in: defaultdict[
-00028400: 7374 722c 2064 6963 745b 4b65 792c 2041  str, dict[Key, A
-00028410: 6e79 5d5d 203d 2064 6566 6175 6c74 6469  ny]] = defaultdi
-00028420: 6374 2864 6963 7429 0a20 2020 2020 2020  ct(dict).       
-00028430: 2066 6f72 206b 6579 2069 6e20 6b65 7973   for key in keys
-00028440: 5f77 6974 685f 616e 6e6f 7461 7469 6f6e  _with_annotation
-00028450: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-00028460: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00028470: 6579 5d0a 2020 2020 2020 2020 2020 2020  ey].            
-00028480: 6966 2074 732e 616e 6e6f 7461 7469 6f6e  if ts.annotation
-00028490: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-000284a0: 2020 2066 6f72 2061 6e6e 6f74 2c20 7661     for annot, va
-000284b0: 6c75 6520 696e 2074 732e 616e 6e6f 7461  lue in ts.annota
-000284c0: 7469 6f6e 732e 6974 656d 7328 293a 0a20  tions.items():. 
-000284d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000284e0: 2020 2061 6e6e 6f74 6174 696f 6e73 5f66     annotations_f
-000284f0: 6f72 5f70 6c75 6769 6e5b 616e 6e6f 745d  or_plugin[annot]
-00028500: 5b6b 6579 5d20 3d20 7661 6c75 650a 0a20  [key] = value.. 
-00028510: 2020 2020 2020 2073 7061 6e73 5f65 7874         spans_ext
-00028520: 3a20 5370 616e 7353 6368 6564 756c 6572  : SpansScheduler
-00028530: 4578 7465 6e73 696f 6e20 7c20 4e6f 6e65  Extension | None
-00028540: 203d 2073 656c 662e 6578 7465 6e73 696f   = self.extensio
-00028550: 6e73 2e67 6574 2822 7370 616e 7322 290a  ns.get("spans").
-00028560: 2020 2020 2020 2020 6966 2073 7061 6e73          if spans
-00028570: 5f65 7874 3a0a 2020 2020 2020 2020 2020  _ext:.          
-00028580: 2020 2320 6e65 775f 7461 736b 7320 646f    # new_tasks do
-00028590: 6573 206e 6f74 206e 6563 6573 7361 7269  es not necessari
-000285a0: 6c79 2063 6f6e 7461 696e 2061 6c6c 2072  ly contain all r
-000285b0: 756e 6e61 626c 6520 7461 736b 733b 0a20  unnable tasks;. 
-000285c0: 2020 2020 2020 2020 2020 2023 205f 6765             # _ge
-000285d0: 6e65 7261 7465 5f74 6173 6b73 7461 7465  nerate_taskstate
-000285e0: 7320 6973 206e 6f74 2074 6865 206f 6e6c  s is not the onl
-000285f0: 7920 7468 696e 6720 7468 6174 2063 616c  y thing that cal
-00028600: 6c73 206e 6577 5f74 6173 6b28 292e 2041  ls new_task(). A
-00028610: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00028620: 6173 6b53 7461 7465 206d 6179 2068 6176  askState may hav
-00028630: 6520 616c 736f 2062 6565 6e20 6372 6561  e also been crea
-00028640: 7465 6420 6279 2063 6c69 656e 745f 6465  ted by client_de
-00028650: 7369 7265 735f 6b65 7973 206f 7220 7363  sires_keys or sc
-00028660: 6174 7465 722c 0a20 2020 2020 2020 2020  atter,.         
-00028670: 2020 2023 2061 6e64 206f 6e6c 7920 6c61     # and only la
-00028680: 7465 7220 6761 696e 6564 2061 2072 756e  ter gained a run
-00028690: 5f73 7065 632e 0a20 2020 2020 2020 2020  _spec..         
-000286a0: 2020 2073 7061 6e5f 616e 6e6f 7461 7469     span_annotati
-000286b0: 6f6e 7320 3d20 7370 616e 735f 6578 742e  ons = spans_ext.
-000286c0: 6f62 7365 7276 655f 7461 736b 7328 7275  observe_tasks(ru
-000286d0: 6e6e 6162 6c65 2c20 636f 6465 3d63 6f64  nnable, code=cod
-000286e0: 6529 0a20 2020 2020 2020 2020 2020 2023  e).            #
-000286f0: 2049 6e20 6361 7365 206f 6620 5461 736b   In case of Task
-00028700: 4772 6f75 7020 636f 6c6c 6973 696f 6e2c  Group collision,
-00028710: 2073 7061 6e73 206d 6179 2068 6176 6520   spans may have 
-00028720: 6368 616e 6765 640a 2020 2020 2020 2020  changed.        
-00028730: 2020 2020 2320 4649 584d 453a 2049 7320      # FIXME: Is 
-00028740: 7468 6973 2075 7365 6420 616e 7977 6865  this used anywhe
-00028750: 7265 2062 6573 6964 6573 2074 6573 7473  re besides tests
-00028760: 3f0a 2020 2020 2020 2020 2020 2020 6966  ?.            if
-00028770: 2073 7061 6e5f 616e 6e6f 7461 7469 6f6e   span_annotation
-00028780: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-00028790: 2020 2061 6e6e 6f74 6174 696f 6e73 5f66     annotations_f
-000287a0: 6f72 5f70 6c75 6769 6e5b 2273 7061 6e22  or_plugin["span"
-000287b0: 5d20 3d20 7370 616e 5f61 6e6e 6f74 6174  ] = span_annotat
-000287c0: 696f 6e73 0a20 2020 2020 2020 2020 2020  ions.           
-000287d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000287e0: 2020 2020 2020 2061 6e6e 6f74 6174 696f         annotatio
-000287f0: 6e73 5f66 6f72 5f70 6c75 6769 6e2e 706f  ns_for_plugin.po
-00028800: 7028 2273 7061 6e22 2c20 4e6f 6e65 290a  p("span", None).
-00028810: 0a20 2020 2020 2020 2066 6f72 2070 6c75  .        for plu
-00028820: 6769 6e20 696e 206c 6973 7428 7365 6c66  gin in list(self
-00028830: 2e70 6c75 6769 6e73 2e76 616c 7565 7328  .plugins.values(
-00028840: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00028850: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00028860: 2020 2020 2070 6c75 6769 6e2e 7570 6461       plugin.upda
-00028870: 7465 5f67 7261 7068 280a 2020 2020 2020  te_graph(.      
-00028880: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00028890: 6c66 2c0a 2020 2020 2020 2020 2020 2020  lf,.            
-000288a0: 2020 2020 2020 2020 636c 6965 6e74 3d63          client=c
-000288b0: 6c69 656e 742c 0a20 2020 2020 2020 2020  lient,.         
-000288c0: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
-000288d0: 3d5b 7473 2e6b 6579 2066 6f72 2074 7320  =[ts.key for ts 
-000288e0: 696e 2074 6f75 6368 6564 5f74 6173 6b73  in touched_tasks
-000288f0: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00028900: 2020 2020 2020 206b 6579 733d 6b65 7973         keys=keys
-00028910: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00028920: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
-00028930: 6573 3d64 6570 656e 6465 6e63 6965 732c  es=dependencies,
-00028940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00028950: 2020 2020 2061 6e6e 6f74 6174 696f 6e73       annotations
-00028960: 3d64 6963 7428 616e 6e6f 7461 7469 6f6e  =dict(annotation
-00028970: 735f 666f 725f 706c 7567 696e 292c 0a20  s_for_plugin),. 
-00028980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028990: 2020 2070 7269 6f72 6974 793d 7072 696f     priority=prio
-000289a0: 7269 7479 2c0a 2020 2020 2020 2020 2020  rity,.          
-000289b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000289c0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-000289d0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
-000289e0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-000289f0: 722e 6578 6365 7074 696f 6e28 6529 0a0a  r.exception(e)..
-00028a00: 2020 2020 2020 2020 7365 6c66 2e74 7261          self.tra
-00028a10: 6e73 6974 696f 6e73 2872 6563 6f6d 6d65  nsitions(recomme
-00028a20: 6e64 6174 696f 6e73 2c20 7374 696d 756c  ndations, stimul
-00028a30: 7573 5f69 6429 0a0a 2020 2020 2020 2020  us_id)..        
-00028a40: 666f 7220 7473 2069 6e20 746f 7563 6865  for ts in touche
-00028a50: 645f 7461 736b 733a 0a20 2020 2020 2020  d_tasks:.       
-00028a60: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
-00028a70: 2069 6e20 2822 6d65 6d6f 7279 222c 2022   in ("memory", "
-00028a80: 6572 7265 6422 293a 0a20 2020 2020 2020  erred"):.       
-00028a90: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-00028aa0: 706f 7274 5f6f 6e5f 6b65 7928 7473 3d74  port_on_key(ts=t
-00028ab0: 732c 2063 6c69 656e 743d 636c 6965 6e74  s, client=client
-00028ac0: 290a 0a20 2020 2040 6c6f 675f 6572 726f  )..    @log_erro
-00028ad0: 7273 0a20 2020 2061 7379 6e63 2064 6566  rs.    async def
-00028ae0: 2075 7064 6174 655f 6772 6170 6828 0a20   update_graph(. 
-00028af0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
-00028b00: 2020 2020 2063 6c69 656e 743a 2073 7472       client: str
-00028b10: 2c0a 2020 2020 2020 2020 6772 6170 685f  ,.        graph_
-00028b20: 6865 6164 6572 3a20 6469 6374 2c0a 2020  header: dict,.  
-00028b30: 2020 2020 2020 6772 6170 685f 6672 616d        graph_fram
-00028b40: 6573 3a20 6c69 7374 5b62 7974 6573 5d2c  es: list[bytes],
-00028b50: 0a20 2020 2020 2020 206b 6579 733a 2073  .        keys: s
-00028b60: 6574 5b4b 6579 5d2c 0a20 2020 2020 2020  et[Key],.       
-00028b70: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
-00028b80: 7479 3a20 6469 6374 5b4b 6579 2c20 696e  ty: dict[Key, in
-00028b90: 745d 207c 204e 6f6e 652c 0a20 2020 2020  t] | None,.     
-00028ba0: 2020 2073 7562 6d69 7474 696e 675f 7461     submitting_ta
-00028bb0: 736b 3a20 4b65 7920 7c20 4e6f 6e65 2c0a  sk: Key | None,.
-00028bc0: 2020 2020 2020 2020 7573 6572 5f70 7269          user_pri
-00028bd0: 6f72 6974 793a 2069 6e74 207c 2064 6963  ority: int | dic
-00028be0: 745b 4b65 792c 2069 6e74 5d20 3d20 302c  t[Key, int] = 0,
-00028bf0: 0a20 2020 2020 2020 2061 6374 6f72 733a  .        actors:
-00028c00: 2062 6f6f 6c20 7c20 6c69 7374 5b4b 6579   bool | list[Key
-00028c10: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 652c  ] | None = None,
-00028c20: 0a20 2020 2020 2020 2066 6966 6f5f 7469  .        fifo_ti
-00028c30: 6d65 6f75 743a 2066 6c6f 6174 203d 2030  meout: float = 0
-00028c40: 2e30 2c0a 2020 2020 2020 2020 636f 6465  .0,.        code
-00028c50: 3a20 7475 706c 655b 536f 7572 6365 436f  : tuple[SourceCo
-00028c60: 6465 2c20 2e2e 2e5d 203d 2028 292c 0a20  de, ...] = (),. 
-00028c70: 2020 2020 2020 2061 6e6e 6f74 6174 696f         annotatio
-00028c80: 6e73 3a20 6469 6374 207c 204e 6f6e 6520  ns: dict | None 
-00028c90: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00028ca0: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00028cb0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-00028cc0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-00028cd0: 2020 2020 2020 2023 2046 4958 4d45 3a20         # FIXME: 
-00028ce0: 4170 7061 7265 6e74 6c79 2065 6d70 7479  Apparently empty
-00028cf0: 2064 6963 7473 2061 7272 6976 6520 6173   dicts arrive as
-00028d00: 2061 2054 6f50 6963 6b6c 6520 6f62 6a65   a ToPickle obje
-00028d10: 6374 0a20 2020 2020 2020 2069 6620 6973  ct.        if is
-00028d20: 696e 7374 616e 6365 2861 6e6e 6f74 6174  instance(annotat
-00028d30: 696f 6e73 2c20 546f 5069 636b 6c65 293a  ions, ToPickle):
-00028d40: 0a20 2020 2020 2020 2020 2020 2061 6e6e  .            ann
-00028d50: 6f74 6174 696f 6e73 203d 2061 6e6e 6f74  otations = annot
-00028d60: 6174 696f 6e73 2e64 6174 6120 2023 2074  ations.data  # t
-00028d70: 7970 653a 2069 676e 6f72 655b 756e 7265  ype: ignore[unre
-00028d80: 6163 6861 626c 655d 0a20 2020 2020 2020  achable].       
-00028d90: 2073 7461 7274 203d 2074 696d 6528 290a   start = time().
-00028da0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00028db0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00028dc0: 2020 2020 2020 2020 2020 2020 2020 6772                gr
-00028dd0: 6170 6820 3d20 6465 7365 7269 616c 697a  aph = deserializ
-00028de0: 6528 6772 6170 685f 6865 6164 6572 2c20  e(graph_header, 
-00028df0: 6772 6170 685f 6672 616d 6573 292e 6461  graph_frames).da
-00028e00: 7461 0a20 2020 2020 2020 2020 2020 2020  ta.             
-00028e10: 2020 2064 656c 2067 7261 7068 5f68 6561     del graph_hea
-00028e20: 6465 722c 2067 7261 7068 5f66 7261 6d65  der, graph_frame
-00028e30: 730a 2020 2020 2020 2020 2020 2020 6578  s.            ex
-00028e40: 6365 7074 2045 7863 6570 7469 6f6e 2061  cept Exception a
-00028e50: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
-00028e60: 2020 2020 206d 7367 203d 2022 2222 5c0a       msg = """\.
-00028e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00028e80: 2020 2020 4572 726f 7220 6475 7269 6e67      Error during
-00028e90: 2064 6573 6572 6961 6c69 7a61 7469 6f6e   deserialization
-00028ea0: 206f 6620 7468 6520 7461 736b 2067 7261   of the task gra
-00028eb0: 7068 2e20 5468 6973 2066 7265 7175 656e  ph. This frequen
-00028ec0: 746c 790a 2020 2020 2020 2020 2020 2020  tly.            
-00028ed0: 2020 2020 2020 2020 6f63 6375 7273 2069          occurs i
-00028ee0: 6620 7468 6520 5363 6865 6475 6c65 7220  f the Scheduler 
-00028ef0: 616e 6420 436c 6965 6e74 2068 6176 6520  and Client have 
-00028f00: 6469 6666 6572 656e 7420 656e 7669 726f  different enviro
-00028f10: 6e6d 656e 7473 2e0a 2020 2020 2020 2020  nments..        
-00028f20: 2020 2020 2020 2020 2020 2020 466f 7220              For 
-00028f30: 6d6f 7265 2069 6e66 6f72 6d61 7469 6f6e  more information
-00028f40: 2c20 7365 650a 2020 2020 2020 2020 2020  , see.          
-00028f50: 2020 2020 2020 2020 2020 6874 7470 733a            https:
-00028f60: 2f2f 646f 6373 2e64 6173 6b2e 6f72 672f  //docs.dask.org/
-00028f70: 656e 2f73 7461 626c 652f 6465 706c 6f79  en/stable/deploy
-00028f80: 6d65 6e74 2d63 6f6e 7369 6465 7261 7469  ment-considerati
-00028f90: 6f6e 732e 6874 6d6c 2363 6f6e 7369 7374  ons.html#consist
-00028fa0: 656e 742d 736f 6674 7761 7265 2d65 6e76  ent-software-env
-00028fb0: 6972 6f6e 6d65 6e74 730a 2020 2020 2020  ironments.      
-00028fc0: 2020 2020 2020 2020 2020 2222 220a 2020            """.  
-00028fd0: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00028fe0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-00028ff0: 2874 6578 7477 7261 702e 6465 6465 6e74  (textwrap.dedent
-00029000: 286d 7367 2929 2066 726f 6d20 650a 2020  (msg)) from e.  
-00029010: 2020 2020 2020 2020 2020 280a 2020 2020            (.    
-00029020: 2020 2020 2020 2020 2020 2020 6473 6b2c              dsk,
-00029030: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00029040: 2064 6570 656e 6465 6e63 6965 732c 0a20   dependencies,. 
-00029050: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00029060: 6e6e 6f74 6174 696f 6e73 5f62 795f 7479  nnotations_by_ty
-00029070: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
-00029080: 2920 3d20 6177 6169 7420 6f66 666c 6f61  ) = await offloa
-00029090: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-000290a0: 2020 205f 6d61 7465 7269 616c 697a 655f     _materialize_
-000290b0: 6772 6170 682c 0a20 2020 2020 2020 2020  graph,.         
-000290c0: 2020 2020 2020 2067 7261 7068 3d67 7261         graph=gra
-000290d0: 7068 2c0a 2020 2020 2020 2020 2020 2020  ph,.            
-000290e0: 2020 2020 676c 6f62 616c 5f61 6e6e 6f74      global_annot
-000290f0: 6174 696f 6e73 3d61 6e6e 6f74 6174 696f  ations=annotatio
-00029100: 6e73 206f 7220 7b7d 2c0a 2020 2020 2020  ns or {},.      
-00029110: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00029120: 2020 2020 6465 6c20 6772 6170 680a 2020      del graph.  
-00029130: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00029140: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
-00029150: 7479 3a0a 2020 2020 2020 2020 2020 2020  ty:.            
-00029160: 2020 2020 2320 5265 6d6f 7669 6e67 2061      # Removing a
-00029170: 6c6c 206e 6f6e 2d6c 6f63 616c 206b 6579  ll non-local key
-00029180: 7320 6265 666f 7265 2063 616c 6c69 6e67  s before calling
-00029190: 206f 7264 6572 2829 0a20 2020 2020 2020   order().       
-000291a0: 2020 2020 2020 2020 2064 736b 5f6b 6579           dsk_key
-000291b0: 7320 3d20 7365 7428 0a20 2020 2020 2020  s = set(.       
-000291c0: 2020 2020 2020 2020 2020 2020 2064 736b               dsk
+00026dd0: 616e 6e69 6573 2e64 6973 6361 7264 2861  annies.discard(a
+00026de0: 6464 7265 7373 290a 2020 2020 2020 2020  ddress).        
+00026df0: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
+00026e00: 6172 7469 6e67 5f6e 616e 6e69 6573 5f63  arting_nannies_c
+00026e10: 6f6e 642e 6e6f 7469 6679 5f61 6c6c 2829  ond.notify_all()
+00026e20: 0a0a 2020 2020 6465 6620 5f6d 6174 6368  ..    def _match
+00026e30: 5f67 7261 7068 5f77 6974 685f 7461 736b  _graph_with_task
+00026e40: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+00026e50: 0a20 2020 2020 2020 2064 736b 3a20 6469  .        dsk: di
+00026e60: 6374 5b4b 6579 2c20 545f 7275 6e73 7065  ct[Key, T_runspe
+00026e70: 635d 2c0a 2020 2020 2020 2020 6465 7065  c],.        depe
+00026e80: 6e64 656e 6369 6573 3a20 6469 6374 5b4b  ndencies: dict[K
+00026e90: 6579 2c20 7365 745b 4b65 795d 5d2c 0a20  ey, set[Key]],. 
+00026ea0: 2020 2020 2020 206b 6579 733a 2073 6574         keys: set
+00026eb0: 5b4b 6579 5d2c 0a20 2020 2029 202d 3e20  [Key],.    ) -> 
+00026ec0: 7365 745b 4b65 795d 3a0a 2020 2020 2020  set[Key]:.      
+00026ed0: 2020 6e20 3d20 300a 2020 2020 2020 2020    n = 0.        
+00026ee0: 6c6f 7374 5f6b 6579 7320 3d20 7365 7428  lost_keys = set(
+00026ef0: 290a 2020 2020 2020 2020 7768 696c 6520  ).        while 
+00026f00: 6c65 6e28 6473 6b29 2021 3d20 6e3a 2020  len(dsk) != n:  
+00026f10: 2320 7761 6c6b 2074 6872 6f75 6768 206e  # walk through n
+00026f20: 6577 2074 6173 6b73 2c20 6361 6e63 656c  ew tasks, cancel
+00026f30: 2061 6e79 2062 6164 2064 6570 730a 2020   any bad deps.  
+00026f40: 2020 2020 2020 2020 2020 6e20 3d20 6c65            n = le
+00026f50: 6e28 6473 6b29 0a20 2020 2020 2020 2020  n(dsk).         
+00026f60: 2020 2066 6f72 206b 2c20 6465 7073 2069     for k, deps i
+00026f70: 6e20 6c69 7374 2864 6570 656e 6465 6e63  n list(dependenc
+00026f80: 6965 732e 6974 656d 7328 2929 3a0a 2020  ies.items()):.  
+00026f90: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00026fa0: 2061 6e79 280a 2020 2020 2020 2020 2020   any(.          
+00026fb0: 2020 2020 2020 2020 2020 6465 7020 6e6f            dep no
+00026fc0: 7420 696e 2073 656c 662e 7461 736b 7320  t in self.tasks 
+00026fd0: 616e 6420 6465 7020 6e6f 7420 696e 2064  and dep not in d
+00026fe0: 736b 2066 6f72 2064 6570 2069 6e20 6465  sk for dep in de
+00026ff0: 7073 0a20 2020 2020 2020 2020 2020 2020  ps.             
+00027000: 2020 2029 3a20 2023 2062 6164 206b 6579     ):  # bad key
+00027010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027020: 2020 2020 206c 6f73 745f 6b65 7973 2e61       lost_keys.a
+00027030: 6464 286b 290a 2020 2020 2020 2020 2020  dd(k).          
+00027040: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00027050: 2e69 6e66 6f28 2255 7365 7220 6173 6b65  .info("User aske
+00027060: 6420 666f 7220 636f 6d70 7574 6174 696f  d for computatio
+00027070: 6e20 6f6e 206c 6f73 7420 6461 7461 2c20  n on lost data, 
+00027080: 2573 222c 206b 290a 2020 2020 2020 2020  %s", k).        
+00027090: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+000270a0: 6473 6b5b 6b5d 0a20 2020 2020 2020 2020  dsk[k].         
+000270b0: 2020 2020 2020 2020 2020 2064 656c 2064             del d
+000270c0: 6570 656e 6465 6e63 6965 735b 6b5d 0a20  ependencies[k]. 
+000270d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000270e0: 2020 2069 6620 6b20 696e 206b 6579 733a     if k in keys:
+000270f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027100: 2020 2020 2020 2020 206b 6579 732e 7265           keys.re
+00027110: 6d6f 7665 286b 290a 2020 2020 2020 2020  move(k).        
+00027120: 2020 2020 2020 2020 6465 6c20 6465 7073          del deps
+00027130: 0a20 2020 2020 2020 2023 2041 766f 6964  .        # Avoid
+00027140: 2063 6f6d 7075 7461 7469 6f6e 2074 6861   computation tha
+00027150: 7420 6973 2061 6c72 6561 6479 2066 696e  t is already fin
+00027160: 6973 6865 640a 2020 2020 2020 2020 646f  ished.        do
+00027170: 6e65 203d 2073 6574 2829 2020 2320 7461  ne = set()  # ta
+00027180: 736b 7320 7468 6174 2061 7265 2061 6c72  sks that are alr
+00027190: 6561 6479 2064 6f6e 650a 2020 2020 2020  eady done.      
+000271a0: 2020 666f 7220 6b2c 2076 2069 6e20 6465    for k, v in de
+000271b0: 7065 6e64 656e 6369 6573 2e69 7465 6d73  pendencies.items
+000271c0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000271d0: 6966 2076 2061 6e64 206b 2069 6e20 7365  if v and k in se
+000271e0: 6c66 2e74 6173 6b73 3a0a 2020 2020 2020  lf.tasks:.      
+000271f0: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+00027200: 656c 662e 7461 736b 735b 6b5d 0a20 2020  elf.tasks[k].   
+00027210: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00027220: 7473 2e73 7461 7465 2069 6e20 2822 6d65  ts.state in ("me
+00027230: 6d6f 7279 222c 2022 6572 7265 6422 293a  mory", "erred"):
+00027240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027250: 2020 2020 2064 6f6e 652e 6164 6428 6b29       done.add(k)
+00027260: 0a0a 2020 2020 2020 2020 6966 2064 6f6e  ..        if don
+00027270: 653a 0a20 2020 2020 2020 2020 2020 2064  e:.            d
+00027280: 6570 656e 6465 6e74 7320 3d20 6461 736b  ependents = dask
+00027290: 2e63 6f72 652e 7265 7665 7273 655f 6469  .core.reverse_di
+000272a0: 6374 2864 6570 656e 6465 6e63 6965 7329  ct(dependencies)
+000272b0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+000272c0: 636b 203d 206c 6973 7428 646f 6e65 290a  ck = list(done).
+000272d0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+000272e0: 6520 7374 6163 6b3a 2020 2320 7265 6d6f  e stack:  # remo
+000272f0: 7665 2075 6e6e 6563 6573 7361 7279 2064  ve unnecessary d
+00027300: 6570 656e 6465 6e63 6965 730a 2020 2020  ependencies.    
+00027310: 2020 2020 2020 2020 2020 2020 6b65 7920              key 
+00027320: 3d20 7374 6163 6b2e 706f 7028 290a 2020  = stack.pop().  
+00027330: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+00027340: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+00027350: 2020 2020 2020 2064 6570 7320 3d20 6465         deps = de
+00027360: 7065 6e64 656e 6369 6573 5b6b 6579 5d0a  pendencies[key].
+00027370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027380: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
+00027390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000273a0: 2020 2020 2064 6570 7320 3d20 7b74 732e       deps = {ts.
+000273b0: 6b65 7920 666f 7220 7473 2069 6e20 7365  key for ts in se
+000273c0: 6c66 2e74 6173 6b73 5b6b 6579 5d2e 6465  lf.tasks[key].de
+000273d0: 7065 6e64 656e 6369 6573 7d0a 2020 2020  pendencies}.    
+000273e0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+000273f0: 6465 7020 696e 2064 6570 733a 0a20 2020  dep in deps:.   
+00027400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027410: 2069 6620 6465 7020 696e 2064 6570 656e   if dep in depen
+00027420: 6465 6e74 733a 0a20 2020 2020 2020 2020  dents:.         
+00027430: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00027440: 6869 6c64 5f64 6570 7320 3d20 6465 7065  hild_deps = depe
+00027450: 6e64 656e 7473 5b64 6570 5d0a 2020 2020  ndents[dep].    
+00027460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027470: 656c 6966 2064 6570 2069 6e20 7365 6c66  elif dep in self
+00027480: 2e74 6173 6b73 3a0a 2020 2020 2020 2020  .tasks:.        
+00027490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000274a0: 6368 696c 645f 6465 7073 203d 207b 7473  child_deps = {ts
+000274b0: 2e6b 6579 2066 6f72 2074 7320 696e 2073  .key for ts in s
+000274c0: 656c 662e 7461 736b 735b 6b65 795d 2e64  elf.tasks[key].d
+000274d0: 6570 656e 6465 6e63 6965 737d 0a20 2020  ependencies}.   
+000274e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000274f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00027500: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00027510: 6869 6c64 5f64 6570 7320 3d20 7365 7428  hild_deps = set(
+00027520: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00027530: 2020 2020 2020 6966 2061 6c6c 2864 2069        if all(d i
+00027540: 6e20 646f 6e65 2066 6f72 2064 2069 6e20  n done for d in 
+00027550: 6368 696c 645f 6465 7073 293a 0a20 2020  child_deps):.   
+00027560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027570: 2020 2020 2069 6620 6465 7020 696e 2073       if dep in s
+00027580: 656c 662e 7461 736b 7320 616e 6420 6465  elf.tasks and de
+00027590: 7020 6e6f 7420 696e 2064 6f6e 653a 0a20  p not in done:. 
+000275a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000275b0: 2020 2020 2020 2020 2020 2064 6f6e 652e             done.
+000275c0: 6164 6428 6465 7029 0a20 2020 2020 2020  add(dep).       
+000275d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000275e0: 2020 2020 2073 7461 636b 2e61 7070 656e       stack.appen
+000275f0: 6428 6465 7029 0a20 2020 2020 2020 2066  d(dep).        f
+00027600: 6f72 2061 6e63 2069 6e20 646f 6e65 3a0a  or anc in done:.
+00027610: 2020 2020 2020 2020 2020 2020 6473 6b2e              dsk.
+00027620: 706f 7028 616e 632c 204e 6f6e 6529 0a20  pop(anc, None). 
+00027630: 2020 2020 2020 2020 2020 2064 6570 656e             depen
+00027640: 6465 6e63 6965 732e 706f 7028 616e 632c  dencies.pop(anc,
+00027650: 204e 6f6e 6529 0a20 2020 2020 2020 2072   None).        r
+00027660: 6574 7572 6e20 6c6f 7374 5f6b 6579 730a  eturn lost_keys.
+00027670: 0a20 2020 2064 6566 205f 6372 6561 7465  .    def _create
+00027680: 5f74 6173 6b73 7461 7465 5f66 726f 6d5f  _taskstate_from_
+00027690: 6772 6170 6828 0a20 2020 2020 2020 2073  graph(.        s
+000276a0: 656c 662c 0a20 2020 2020 2020 202a 2c0a  elf,.        *,.
+000276b0: 2020 2020 2020 2020 7374 6172 743a 2066          start: f
+000276c0: 6c6f 6174 2c0a 2020 2020 2020 2020 6473  loat,.        ds
+000276d0: 6b3a 2064 6963 745b 4b65 792c 2054 5f72  k: dict[Key, T_r
+000276e0: 756e 7370 6563 5d2c 0a20 2020 2020 2020  unspec],.       
+000276f0: 2064 6570 656e 6465 6e63 6965 733a 2064   dependencies: d
+00027700: 6963 742c 0a20 2020 2020 2020 206b 6579  ict,.        key
+00027710: 733a 2073 6574 5b4b 6579 5d2c 0a20 2020  s: set[Key],.   
+00027720: 2020 2020 206f 7264 6572 6564 3a20 6469       ordered: di
+00027730: 6374 5b4b 6579 2c20 696e 745d 2c0a 2020  ct[Key, int],.  
+00027740: 2020 2020 2020 636c 6965 6e74 3a20 7374        client: st
+00027750: 722c 0a20 2020 2020 2020 2061 6e6e 6f74  r,.        annot
+00027760: 6174 696f 6e73 5f62 795f 7479 7065 3a20  ations_by_type: 
+00027770: 6469 6374 2c0a 2020 2020 2020 2020 676c  dict,.        gl
+00027780: 6f62 616c 5f61 6e6e 6f74 6174 696f 6e73  obal_annotations
+00027790: 3a20 6469 6374 207c 204e 6f6e 652c 0a20  : dict | None,. 
+000277a0: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+000277b0: 6964 3a20 7374 722c 0a20 2020 2020 2020  id: str,.       
+000277c0: 2073 7562 6d69 7474 696e 675f 7461 736b   submitting_task
+000277d0: 3a20 4b65 7920 7c20 4e6f 6e65 2c0a 2020  : Key | None,.  
+000277e0: 2020 2020 2020 7573 6572 5f70 7269 6f72        user_prior
+000277f0: 6974 793a 2069 6e74 207c 2064 6963 745b  ity: int | dict[
+00027800: 4b65 792c 2069 6e74 5d20 3d20 302c 0a20  Key, int] = 0,. 
+00027810: 2020 2020 2020 2061 6374 6f72 733a 2062         actors: b
+00027820: 6f6f 6c20 7c20 6c69 7374 5b4b 6579 5d20  ool | list[Key] 
+00027830: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00027840: 2020 2020 2020 2066 6966 6f5f 7469 6d65         fifo_time
+00027850: 6f75 743a 2066 6c6f 6174 203d 2030 2e30  out: float = 0.0
+00027860: 2c0a 2020 2020 2020 2020 636f 6465 3a20  ,.        code: 
+00027870: 7475 706c 655b 536f 7572 6365 436f 6465  tuple[SourceCode
+00027880: 2c20 2e2e 2e5d 203d 2028 292c 0a20 2020  , ...] = (),.   
+00027890: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+000278a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000278b0: 5461 6b65 2061 206c 6f77 206c 6576 656c  Take a low level
+000278c0: 2067 7261 7068 2061 6e64 2063 7265 6174   graph and creat
+000278d0: 6520 7468 6520 6e65 6365 7373 6172 7920  e the necessary 
+000278e0: 7363 6865 6475 6c65 7220 7374 6174 6520  scheduler state 
+000278f0: 746f 0a20 2020 2020 2020 2063 6f6d 7075  to.        compu
+00027900: 7465 2069 742e 0a0a 2020 2020 2020 2020  te it...        
+00027910: 5741 524e 494e 470a 2020 2020 2020 2020  WARNING.        
+00027920: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+00027930: 5468 6973 206d 6574 686f 6420 6d75 7374  This method must
+00027940: 206e 6f74 2062 6520 6d61 6465 2061 7379   not be made asy
+00027950: 6e63 2073 696e 6365 206e 6f74 6869 6e67  nc since nothing
+00027960: 2068 6572 6520 6973 2063 6f6e 6375 7272   here is concurr
+00027970: 656e 6379 0a20 2020 2020 2020 2073 6166  ency.        saf
+00027980: 652e 2041 6c6c 2069 6e74 6572 6163 7469  e. All interacti
+00027990: 6f6e 7320 7769 7468 2054 6173 6b53 7461  ons with TaskSta
+000279a0: 7465 206f 626a 6563 7473 2068 6572 6520  te objects here 
+000279b0: 7368 6f75 6c64 2062 6520 6861 7070 656e  should be happen
+000279c0: 696e 670a 2020 2020 2020 2020 696e 2074  ing.        in t
+000279d0: 6865 2073 616d 6520 6576 656e 7420 6c6f  he same event lo
+000279e0: 6f70 2074 6963 6b2e 0a20 2020 2020 2020  op tick..       
+000279f0: 2022 2222 0a0a 2020 2020 2020 2020 6c6f   """..        lo
+00027a00: 7374 5f6b 6579 7320 3d20 7365 6c66 2e5f  st_keys = self._
+00027a10: 6d61 7463 685f 6772 6170 685f 7769 7468  match_graph_with
+00027a20: 5f74 6173 6b73 2864 736b 2c20 6465 7065  _tasks(dsk, depe
+00027a30: 6e64 656e 6369 6573 2c20 6b65 7973 290a  ndencies, keys).
+00027a40: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
+00027a50: 6473 6b29 203e 2031 3a0a 2020 2020 2020  dsk) > 1:.      
+00027a60: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+00027a70: 7665 6e74 280a 2020 2020 2020 2020 2020  vent(.          
+00027a80: 2020 2020 2020 5b22 616c 6c22 2c20 636c        ["all", cl
+00027a90: 6965 6e74 5d2c 207b 2261 6374 696f 6e22  ient], {"action"
+00027aa0: 3a20 2275 7064 6174 655f 6772 6170 6822  : "update_graph"
+00027ab0: 2c20 2263 6f75 6e74 223a 206c 656e 2864  , "count": len(d
+00027ac0: 736b 297d 0a20 2020 2020 2020 2020 2020  sk)}.           
+00027ad0: 2029 0a0a 2020 2020 2020 2020 6966 206c   )..        if l
+00027ae0: 6f73 745f 6b65 7973 3a0a 2020 2020 2020  ost_keys:.      
+00027af0: 2020 2020 2020 7365 6c66 2e72 6570 6f72        self.repor
+00027b00: 7428 7b22 6f70 223a 2022 6361 6e63 656c  t({"op": "cancel
+00027b10: 6c65 642d 6b65 7973 222c 2022 6b65 7973  led-keys", "keys
+00027b20: 223a 206c 6f73 745f 6b65 7973 7d2c 2063  ": lost_keys}, c
+00027b30: 6c69 656e 743d 636c 6965 6e74 290a 2020  lient=client).  
+00027b40: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+00027b50: 6c69 656e 745f 7265 6c65 6173 6573 5f6b  lient_releases_k
+00027b60: 6579 7328 0a20 2020 2020 2020 2020 2020  eys(.           
+00027b70: 2020 2020 206b 6579 733d 6c6f 7374 5f6b       keys=lost_k
+00027b80: 6579 732c 2063 6c69 656e 743d 636c 6965  eys, client=clie
+00027b90: 6e74 2c20 7374 696d 756c 7573 5f69 643d  nt, stimulus_id=
+00027ba0: 7374 696d 756c 7573 5f69 640a 2020 2020  stimulus_id.    
+00027bb0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00027bc0: 2020 2069 6620 6e6f 7420 7365 6c66 2e69     if not self.i
+00027bd0: 735f 6964 6c65 2061 6e64 2073 656c 662e  s_idle and self.
+00027be0: 636f 6d70 7574 6174 696f 6e73 3a0a 2020  computations:.  
+00027bf0: 2020 2020 2020 2020 2020 2320 5374 696c            # Stil
+00027c00: 6c20 776f 726b 696e 6720 6f6e 2073 6f6d  l working on som
+00027c10: 6574 6869 6e67 2e20 4173 7369 676e 206e  ething. Assign n
+00027c20: 6577 2074 6173 6b73 2074 6f20 7361 6d65  ew tasks to same
+00027c30: 2063 6f6d 7075 7461 7469 6f6e 0a20 2020   computation.   
+00027c40: 2020 2020 2020 2020 2063 6f6d 7075 7461           computa
+00027c50: 7469 6f6e 203d 2073 656c 662e 636f 6d70  tion = self.comp
+00027c60: 7574 6174 696f 6e73 5b2d 315d 0a20 2020  utations[-1].   
+00027c70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00027c80: 2020 2020 2020 2063 6f6d 7075 7461 7469         computati
+00027c90: 6f6e 203d 2043 6f6d 7075 7461 7469 6f6e  on = Computation
+00027ca0: 2829 0a20 2020 2020 2020 2020 2020 2073  ().            s
+00027cb0: 656c 662e 636f 6d70 7574 6174 696f 6e73  elf.computations
+00027cc0: 2e61 7070 656e 6428 636f 6d70 7574 6174  .append(computat
+00027cd0: 696f 6e29 0a0a 2020 2020 2020 2020 6966  ion)..        if
+00027ce0: 2063 6f64 653a 2020 2320 6164 6420 6e65   code:  # add ne
+00027cf0: 7720 636f 6465 2062 6c6f 636b 730a 2020  w code blocks.  
+00027d00: 2020 2020 2020 2020 2020 636f 6d70 7574            comput
+00027d10: 6174 696f 6e2e 636f 6465 2e61 6464 2863  ation.code.add(c
+00027d20: 6f64 6529 0a20 2020 2020 2020 2069 6620  ode).        if 
+00027d30: 676c 6f62 616c 5f61 6e6e 6f74 6174 696f  global_annotatio
+00027d40: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+00027d50: 2320 4649 584d 453a 2054 6869 7320 6973  # FIXME: This is
+00027d60: 206b 696e 6420 6f66 2069 6e63 6f6e 7369   kind of inconsi
+00027d70: 7374 656e 7420 7369 6e63 6520 6974 206f  stent since it o
+00027d80: 6e6c 7920 696e 636c 7564 6573 2067 6c6f  nly includes glo
+00027d90: 6261 6c0a 2020 2020 2020 2020 2020 2020  bal.            
+00027da0: 2320 616e 6e6f 7461 7469 6f6e 732e 0a20  # annotations.. 
+00027db0: 2020 2020 2020 2020 2020 2063 6f6d 7075             compu
+00027dc0: 7461 7469 6f6e 2e61 6e6e 6f74 6174 696f  tation.annotatio
+00027dd0: 6e73 2e75 7064 6174 6528 676c 6f62 616c  ns.update(global
+00027de0: 5f61 6e6e 6f74 6174 696f 6e73 290a 2020  _annotations).  
+00027df0: 2020 2020 2020 6465 6c20 676c 6f62 616c        del global
+00027e00: 5f61 6e6e 6f74 6174 696f 6e73 0a0a 2020  _annotations..  
+00027e10: 2020 2020 2020 7275 6e6e 6162 6c65 2c20        runnable, 
+00027e20: 746f 7563 6865 645f 7461 736b 732c 206e  touched_tasks, n
+00027e30: 6577 5f74 6173 6b73 203d 2073 656c 662e  ew_tasks = self.
+00027e40: 5f67 656e 6572 6174 655f 7461 736b 7374  _generate_taskst
+00027e50: 6174 6573 280a 2020 2020 2020 2020 2020  ates(.          
+00027e60: 2020 6b65 7973 3d6b 6579 732c 0a20 2020    keys=keys,.   
+00027e70: 2020 2020 2020 2020 2064 736b 3d64 736b           dsk=dsk
+00027e80: 2c0a 2020 2020 2020 2020 2020 2020 6465  ,.            de
+00027e90: 7065 6e64 656e 6369 6573 3d64 6570 656e  pendencies=depen
+00027ea0: 6465 6e63 6965 732c 0a20 2020 2020 2020  dencies,.       
+00027eb0: 2020 2020 2063 6f6d 7075 7461 7469 6f6e       computation
+00027ec0: 3d63 6f6d 7075 7461 7469 6f6e 2c0a 2020  =computation,.  
+00027ed0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00027ee0: 206b 6579 735f 7769 7468 5f61 6e6e 6f74   keys_with_annot
+00027ef0: 6174 696f 6e73 203d 2073 656c 662e 5f61  ations = self._a
+00027f00: 7070 6c79 5f61 6e6e 6f74 6174 696f 6e73  pply_annotations
+00027f10: 280a 2020 2020 2020 2020 2020 2020 7461  (.            ta
+00027f20: 736b 733d 6e65 775f 7461 736b 732c 0a20  sks=new_tasks,. 
+00027f30: 2020 2020 2020 2020 2020 2061 6e6e 6f74             annot
+00027f40: 6174 696f 6e73 5f62 795f 7479 7065 3d61  ations_by_type=a
+00027f50: 6e6e 6f74 6174 696f 6e73 5f62 795f 7479  nnotations_by_ty
+00027f60: 7065 2c0a 2020 2020 2020 2020 290a 0a20  pe,.        ).. 
+00027f70: 2020 2020 2020 2073 656c 662e 5f73 6574         self._set
+00027f80: 5f70 7269 6f72 6974 6965 7328 0a20 2020  _priorities(.   
+00027f90: 2020 2020 2020 2020 2069 6e74 6572 6e61           interna
+00027fa0: 6c5f 7072 696f 7269 7479 3d6f 7264 6572  l_priority=order
+00027fb0: 6564 2c0a 2020 2020 2020 2020 2020 2020  ed,.            
+00027fc0: 7375 626d 6974 7469 6e67 5f74 6173 6b3d  submitting_task=
+00027fd0: 7375 626d 6974 7469 6e67 5f74 6173 6b2c  submitting_task,
+00027fe0: 0a20 2020 2020 2020 2020 2020 2075 7365  .            use
+00027ff0: 725f 7072 696f 7269 7479 3d75 7365 725f  r_priority=user_
+00028000: 7072 696f 7269 7479 2c0a 2020 2020 2020  priority,.      
+00028010: 2020 2020 2020 6669 666f 5f74 696d 656f        fifo_timeo
+00028020: 7574 3d66 6966 6f5f 7469 6d65 6f75 742c  ut=fifo_timeout,
+00028030: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+00028040: 7274 3d73 7461 7274 2c0a 2020 2020 2020  rt=start,.      
+00028050: 2020 2020 2020 7461 736b 733d 7275 6e6e        tasks=runn
+00028060: 6162 6c65 2c0a 2020 2020 2020 2020 290a  able,.        ).
+00028070: 0a20 2020 2020 2020 2073 656c 662e 636c  .        self.cl
+00028080: 6965 6e74 5f64 6573 6972 6573 5f6b 6579  ient_desires_key
+00028090: 7328 6b65 7973 3d6b 6579 732c 2063 6c69  s(keys=keys, cli
+000280a0: 656e 743d 636c 6965 6e74 290a 0a20 2020  ent=client)..   
+000280b0: 2020 2020 2023 2041 6464 2061 6374 6f72       # Add actor
+000280c0: 730a 2020 2020 2020 2020 6966 2061 6374  s.        if act
+000280d0: 6f72 7320 6973 2054 7275 653a 0a20 2020  ors is True:.   
+000280e0: 2020 2020 2020 2020 2061 6374 6f72 7320           actors 
+000280f0: 3d20 6c69 7374 286b 6579 7329 0a20 2020  = list(keys).   
+00028100: 2020 2020 2066 6f72 2061 6374 6f72 2069       for actor i
+00028110: 6e20 6163 746f 7273 206f 7220 5b5d 3a0a  n actors or []:.
+00028120: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
+00028130: 2073 656c 662e 7461 736b 735b 6163 746f   self.tasks[acto
+00028140: 725d 0a20 2020 2020 2020 2020 2020 2074  r].            t
+00028150: 732e 6163 746f 7220 3d20 5472 7565 0a0a  s.actor = True..
+00028160: 2020 2020 2020 2020 2320 436f 6d70 7574          # Comput
+00028170: 6520 7265 636f 6d6d 656e 6461 7469 6f6e  e recommendation
+00028180: 730a 2020 2020 2020 2020 7265 636f 6d6d  s.        recomm
+00028190: 656e 6461 7469 6f6e 733a 2052 6563 7320  endations: Recs 
+000281a0: 3d20 7b7d 0a20 2020 2020 2020 2070 7269  = {}.        pri
+000281b0: 6f72 6974 7920 3d20 6469 6374 2829 0a20  ority = dict(). 
+000281c0: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
+000281d0: 2073 6f72 7465 6428 0a20 2020 2020 2020   sorted(.       
+000281e0: 2020 2020 2072 756e 6e61 626c 652c 0a20       runnable,. 
+000281f0: 2020 2020 2020 2020 2020 206b 6579 3d6f             key=o
+00028200: 7065 7261 746f 722e 6174 7472 6765 7474  perator.attrgett
+00028210: 6572 2822 7072 696f 7269 7479 2229 2c0a  er("priority"),.
+00028220: 2020 2020 2020 2020 2020 2020 7265 7665              reve
+00028230: 7273 653d 5472 7565 2c0a 2020 2020 2020  rse=True,.      
+00028240: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+00028250: 2061 7373 6572 7420 7473 2e70 7269 6f72   assert ts.prior
+00028260: 6974 7920 2023 206d 7970 790a 2020 2020  ity  # mypy.    
+00028270: 2020 2020 2020 2020 7072 696f 7269 7479          priority
+00028280: 5b74 732e 6b65 795d 203d 2074 732e 7072  [ts.key] = ts.pr
+00028290: 696f 7269 7479 0a20 2020 2020 2020 2020  iority.         
+000282a0: 2020 2061 7373 6572 7420 7473 2e72 756e     assert ts.run
+000282b0: 5f73 7065 630a 2020 2020 2020 2020 2020  _spec.          
+000282c0: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
+000282d0: 2022 7265 6c65 6173 6564 223a 0a20 2020   "released":.   
+000282e0: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+000282f0: 6f6d 6d65 6e64 6174 696f 6e73 5b74 732e  ommendations[ts.
+00028300: 6b65 795d 203d 2022 7761 6974 696e 6722  key] = "waiting"
+00028310: 0a0a 2020 2020 2020 2020 666f 7220 7473  ..        for ts
+00028320: 2069 6e20 7275 6e6e 6162 6c65 3a0a 2020   in runnable:.  
+00028330: 2020 2020 2020 2020 2020 666f 7220 6474            for dt
+00028340: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+00028350: 6369 6573 3a0a 2020 2020 2020 2020 2020  cies:.          
+00028360: 2020 2020 2020 6966 2064 7473 2e65 7863        if dts.exc
+00028370: 6570 7469 6f6e 5f62 6c61 6d65 3a0a 2020  eption_blame:.  
+00028380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028390: 2020 7473 2e65 7863 6570 7469 6f6e 5f62    ts.exception_b
+000283a0: 6c61 6d65 203d 2064 7473 2e65 7863 6570  lame = dts.excep
+000283b0: 7469 6f6e 5f62 6c61 6d65 0a20 2020 2020  tion_blame.     
+000283c0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000283d0: 6563 6f6d 6d65 6e64 6174 696f 6e73 5b74  ecommendations[t
+000283e0: 732e 6b65 795d 203d 2022 6572 7265 6422  s.key] = "erred"
+000283f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028400: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+00028410: 2020 2020 616e 6e6f 7461 7469 6f6e 735f      annotations_
+00028420: 666f 725f 706c 7567 696e 3a20 6465 6661  for_plugin: defa
+00028430: 756c 7464 6963 745b 7374 722c 2064 6963  ultdict[str, dic
+00028440: 745b 4b65 792c 2041 6e79 5d5d 203d 2064  t[Key, Any]] = d
+00028450: 6566 6175 6c74 6469 6374 2864 6963 7429  efaultdict(dict)
+00028460: 0a20 2020 2020 2020 2066 6f72 206b 6579  .        for key
+00028470: 2069 6e20 6b65 7973 5f77 6974 685f 616e   in keys_with_an
+00028480: 6e6f 7461 7469 6f6e 733a 0a20 2020 2020  notations:.     
+00028490: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+000284a0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+000284b0: 2020 2020 2020 2020 6966 2074 732e 616e          if ts.an
+000284c0: 6e6f 7461 7469 6f6e 733a 0a20 2020 2020  notations:.     
+000284d0: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
+000284e0: 6e6e 6f74 2c20 7661 6c75 6520 696e 2074  nnot, value in t
+000284f0: 732e 616e 6e6f 7461 7469 6f6e 732e 6974  s.annotations.it
+00028500: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+00028510: 2020 2020 2020 2020 2020 2061 6e6e 6f74             annot
+00028520: 6174 696f 6e73 5f66 6f72 5f70 6c75 6769  ations_for_plugi
+00028530: 6e5b 616e 6e6f 745d 5b6b 6579 5d20 3d20  n[annot][key] = 
+00028540: 7661 6c75 650a 0a20 2020 2020 2020 2073  value..        s
+00028550: 7061 6e73 5f65 7874 3a20 5370 616e 7353  pans_ext: SpansS
+00028560: 6368 6564 756c 6572 4578 7465 6e73 696f  chedulerExtensio
+00028570: 6e20 7c20 4e6f 6e65 203d 2073 656c 662e  n | None = self.
+00028580: 6578 7465 6e73 696f 6e73 2e67 6574 2822  extensions.get("
+00028590: 7370 616e 7322 290a 2020 2020 2020 2020  spans").        
+000285a0: 6966 2073 7061 6e73 5f65 7874 3a0a 2020  if spans_ext:.  
+000285b0: 2020 2020 2020 2020 2020 2320 6e65 775f            # new_
+000285c0: 7461 736b 7320 646f 6573 206e 6f74 206e  tasks does not n
+000285d0: 6563 6573 7361 7269 6c79 2063 6f6e 7461  ecessarily conta
+000285e0: 696e 2061 6c6c 2072 756e 6e61 626c 6520  in all runnable 
+000285f0: 7461 736b 733b 0a20 2020 2020 2020 2020  tasks;.         
+00028600: 2020 2023 205f 6765 6e65 7261 7465 5f74     # _generate_t
+00028610: 6173 6b73 7461 7465 7320 6973 206e 6f74  askstates is not
+00028620: 2074 6865 206f 6e6c 7920 7468 696e 6720   the only thing 
+00028630: 7468 6174 2063 616c 6c73 206e 6577 5f74  that calls new_t
+00028640: 6173 6b28 292e 2041 0a20 2020 2020 2020  ask(). A.       
+00028650: 2020 2020 2023 2054 6173 6b53 7461 7465       # TaskState
+00028660: 206d 6179 2068 6176 6520 616c 736f 2062   may have also b
+00028670: 6565 6e20 6372 6561 7465 6420 6279 2063  een created by c
+00028680: 6c69 656e 745f 6465 7369 7265 735f 6b65  lient_desires_ke
+00028690: 7973 206f 7220 7363 6174 7465 722c 0a20  ys or scatter,. 
+000286a0: 2020 2020 2020 2020 2020 2023 2061 6e64             # and
+000286b0: 206f 6e6c 7920 6c61 7465 7220 6761 696e   only later gain
+000286c0: 6564 2061 2072 756e 5f73 7065 632e 0a20  ed a run_spec.. 
+000286d0: 2020 2020 2020 2020 2020 2073 7061 6e5f             span_
+000286e0: 616e 6e6f 7461 7469 6f6e 7320 3d20 7370  annotations = sp
+000286f0: 616e 735f 6578 742e 6f62 7365 7276 655f  ans_ext.observe_
+00028700: 7461 736b 7328 7275 6e6e 6162 6c65 2c20  tasks(runnable, 
+00028710: 636f 6465 3d63 6f64 6529 0a20 2020 2020  code=code).     
+00028720: 2020 2020 2020 2023 2049 6e20 6361 7365         # In case
+00028730: 206f 6620 5461 736b 4772 6f75 7020 636f   of TaskGroup co
+00028740: 6c6c 6973 696f 6e2c 2073 7061 6e73 206d  llision, spans m
+00028750: 6179 2068 6176 6520 6368 616e 6765 640a  ay have changed.
+00028760: 2020 2020 2020 2020 2020 2020 2320 4649              # FI
+00028770: 584d 453a 2049 7320 7468 6973 2075 7365  XME: Is this use
+00028780: 6420 616e 7977 6865 7265 2062 6573 6964  d anywhere besid
+00028790: 6573 2074 6573 7473 3f0a 2020 2020 2020  es tests?.      
+000287a0: 2020 2020 2020 6966 2073 7061 6e5f 616e        if span_an
+000287b0: 6e6f 7461 7469 6f6e 733a 0a20 2020 2020  notations:.     
+000287c0: 2020 2020 2020 2020 2020 2061 6e6e 6f74             annot
+000287d0: 6174 696f 6e73 5f66 6f72 5f70 6c75 6769  ations_for_plugi
+000287e0: 6e5b 2273 7061 6e22 5d20 3d20 7370 616e  n["span"] = span
+000287f0: 5f61 6e6e 6f74 6174 696f 6e73 0a20 2020  _annotations.   
+00028800: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00028810: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00028820: 6e6e 6f74 6174 696f 6e73 5f66 6f72 5f70  nnotations_for_p
+00028830: 6c75 6769 6e2e 706f 7028 2273 7061 6e22  lugin.pop("span"
+00028840: 2c20 4e6f 6e65 290a 0a20 2020 2020 2020  , None)..       
+00028850: 2066 6f72 2070 6c75 6769 6e20 696e 206c   for plugin in l
+00028860: 6973 7428 7365 6c66 2e70 6c75 6769 6e73  ist(self.plugins
+00028870: 2e76 616c 7565 7328 2929 3a0a 2020 2020  .values()):.    
+00028880: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00028890: 2020 2020 2020 2020 2020 2020 2070 6c75               plu
+000288a0: 6769 6e2e 7570 6461 7465 5f67 7261 7068  gin.update_graph
+000288b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000288c0: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
+000288d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000288e0: 636c 6965 6e74 3d63 6c69 656e 742c 0a20  client=client,. 
+000288f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028900: 2020 2074 6173 6b73 3d5b 7473 2e6b 6579     tasks=[ts.key
+00028910: 2066 6f72 2074 7320 696e 2074 6f75 6368   for ts in touch
+00028920: 6564 5f74 6173 6b73 5d2c 0a20 2020 2020  ed_tasks],.     
+00028930: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+00028940: 6579 733d 6b65 7973 2c0a 2020 2020 2020  eys=keys,.      
+00028950: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00028960: 7065 6e64 656e 6369 6573 3d64 6570 656e  pendencies=depen
+00028970: 6465 6e63 6965 732c 0a20 2020 2020 2020  dencies,.       
+00028980: 2020 2020 2020 2020 2020 2020 2061 6e6e               ann
+00028990: 6f74 6174 696f 6e73 3d64 6963 7428 616e  otations=dict(an
+000289a0: 6e6f 7461 7469 6f6e 735f 666f 725f 706c  notations_for_pl
+000289b0: 7567 696e 292c 0a20 2020 2020 2020 2020  ugin),.         
+000289c0: 2020 2020 2020 2020 2020 2070 7269 6f72             prior
+000289d0: 6974 793d 7072 696f 7269 7479 2c0a 2020  ity=priority,.  
+000289e0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000289f0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00028a00: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+00028a10: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00028a20: 2020 206c 6f67 6765 722e 6578 6365 7074     logger.except
+00028a30: 696f 6e28 6529 0a0a 2020 2020 2020 2020  ion(e)..        
+00028a40: 7365 6c66 2e74 7261 6e73 6974 696f 6e73  self.transitions
+00028a50: 2872 6563 6f6d 6d65 6e64 6174 696f 6e73  (recommendations
+00028a60: 2c20 7374 696d 756c 7573 5f69 6429 0a0a  , stimulus_id)..
+00028a70: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
+00028a80: 6e20 746f 7563 6865 645f 7461 736b 733a  n touched_tasks:
+00028a90: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00028aa0: 7473 2e73 7461 7465 2069 6e20 2822 6d65  ts.state in ("me
+00028ab0: 6d6f 7279 222c 2022 6572 7265 6422 293a  mory", "erred"):
+00028ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028ad0: 2073 656c 662e 7265 706f 7274 5f6f 6e5f   self.report_on_
+00028ae0: 6b65 7928 7473 3d74 732c 2063 6c69 656e  key(ts=ts, clien
+00028af0: 743d 636c 6965 6e74 290a 0a20 2020 2040  t=client)..    @
+00028b00: 6c6f 675f 6572 726f 7273 0a20 2020 2061  log_errors.    a
+00028b10: 7379 6e63 2064 6566 2075 7064 6174 655f  sync def update_
+00028b20: 6772 6170 6828 0a20 2020 2020 2020 2073  graph(.        s
+00028b30: 656c 662c 0a20 2020 2020 2020 2063 6c69  elf,.        cli
+00028b40: 656e 743a 2073 7472 2c0a 2020 2020 2020  ent: str,.      
+00028b50: 2020 6772 6170 685f 6865 6164 6572 3a20    graph_header: 
+00028b60: 6469 6374 2c0a 2020 2020 2020 2020 6772  dict,.        gr
+00028b70: 6170 685f 6672 616d 6573 3a20 6c69 7374  aph_frames: list
+00028b80: 5b62 7974 6573 5d2c 0a20 2020 2020 2020  [bytes],.       
+00028b90: 206b 6579 733a 2073 6574 5b4b 6579 5d2c   keys: set[Key],
+00028ba0: 0a20 2020 2020 2020 2069 6e74 6572 6e61  .        interna
+00028bb0: 6c5f 7072 696f 7269 7479 3a20 6469 6374  l_priority: dict
+00028bc0: 5b4b 6579 2c20 696e 745d 207c 204e 6f6e  [Key, int] | Non
+00028bd0: 652c 0a20 2020 2020 2020 2073 7562 6d69  e,.        submi
+00028be0: 7474 696e 675f 7461 736b 3a20 4b65 7920  tting_task: Key 
+00028bf0: 7c20 4e6f 6e65 2c0a 2020 2020 2020 2020  | None,.        
+00028c00: 7573 6572 5f70 7269 6f72 6974 793a 2069  user_priority: i
+00028c10: 6e74 207c 2064 6963 745b 4b65 792c 2069  nt | dict[Key, i
+00028c20: 6e74 5d20 3d20 302c 0a20 2020 2020 2020  nt] = 0,.       
+00028c30: 2061 6374 6f72 733a 2062 6f6f 6c20 7c20   actors: bool | 
+00028c40: 6c69 7374 5b4b 6579 5d20 7c20 4e6f 6e65  list[Key] | None
+00028c50: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00028c60: 2066 6966 6f5f 7469 6d65 6f75 743a 2066   fifo_timeout: f
+00028c70: 6c6f 6174 203d 2030 2e30 2c0a 2020 2020  loat = 0.0,.    
+00028c80: 2020 2020 636f 6465 3a20 7475 706c 655b      code: tuple[
+00028c90: 536f 7572 6365 436f 6465 2c20 2e2e 2e5d  SourceCode, ...]
+00028ca0: 203d 2028 292c 0a20 2020 2020 2020 2061   = (),.        a
+00028cb0: 6e6e 6f74 6174 696f 6e73 3a20 6469 6374  nnotations: dict
+00028cc0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00028cd0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+00028ce0: 5f69 643a 2073 7472 207c 204e 6f6e 6520  _id: str | None 
+00028cf0: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
+00028d00: 204e 6f6e 653a 0a20 2020 2020 2020 2023   None:.        #
+00028d10: 2046 4958 4d45 3a20 4170 7061 7265 6e74   FIXME: Apparent
+00028d20: 6c79 2065 6d70 7479 2064 6963 7473 2061  ly empty dicts a
+00028d30: 7272 6976 6520 6173 2061 2054 6f50 6963  rrive as a ToPic
+00028d40: 6b6c 6520 6f62 6a65 6374 0a20 2020 2020  kle object.     
+00028d50: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+00028d60: 2861 6e6e 6f74 6174 696f 6e73 2c20 546f  (annotations, To
+00028d70: 5069 636b 6c65 293a 0a20 2020 2020 2020  Pickle):.       
+00028d80: 2020 2020 2061 6e6e 6f74 6174 696f 6e73       annotations
+00028d90: 203d 2061 6e6e 6f74 6174 696f 6e73 2e64   = annotations.d
+00028da0: 6174 6120 2023 2074 7970 653a 2069 676e  ata  # type: ign
+00028db0: 6f72 655b 756e 7265 6163 6861 626c 655d  ore[unreachable]
+00028dc0: 0a20 2020 2020 2020 2073 7461 7274 203d  .        start =
+00028dd0: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
+00028de0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00028df0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00028e00: 2020 2020 2020 6772 6170 6820 3d20 6465        graph = de
+00028e10: 7365 7269 616c 697a 6528 6772 6170 685f  serialize(graph_
+00028e20: 6865 6164 6572 2c20 6772 6170 685f 6672  header, graph_fr
+00028e30: 616d 6573 292e 6461 7461 0a20 2020 2020  ames).data.     
+00028e40: 2020 2020 2020 2020 2020 2064 656c 2067             del g
+00028e50: 7261 7068 5f68 6561 6465 722c 2067 7261  raph_header, gra
+00028e60: 7068 5f66 7261 6d65 730a 2020 2020 2020  ph_frames.      
+00028e70: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00028e80: 6570 7469 6f6e 2061 7320 653a 0a20 2020  eption as e:.   
+00028e90: 2020 2020 2020 2020 2020 2020 206d 7367               msg
+00028ea0: 203d 2022 2222 5c0a 2020 2020 2020 2020   = """\.        
+00028eb0: 2020 2020 2020 2020 2020 2020 4572 726f              Erro
+00028ec0: 7220 6475 7269 6e67 2064 6573 6572 6961  r during deseria
+00028ed0: 6c69 7a61 7469 6f6e 206f 6620 7468 6520  lization of the 
+00028ee0: 7461 736b 2067 7261 7068 2e20 5468 6973  task graph. This
+00028ef0: 2066 7265 7175 656e 746c 790a 2020 2020   frequently.    
+00028f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f10: 6f63 6375 7273 2069 6620 7468 6520 5363  occurs if the Sc
+00028f20: 6865 6475 6c65 7220 616e 6420 436c 6965  heduler and Clie
+00028f30: 6e74 2068 6176 6520 6469 6666 6572 656e  nt have differen
+00028f40: 7420 656e 7669 726f 6e6d 656e 7473 2e0a  t environments..
+00028f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f60: 2020 2020 466f 7220 6d6f 7265 2069 6e66      For more inf
+00028f70: 6f72 6d61 7469 6f6e 2c20 7365 650a 2020  ormation, see.  
+00028f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f90: 2020 6874 7470 733a 2f2f 646f 6373 2e64    https://docs.d
+00028fa0: 6173 6b2e 6f72 672f 656e 2f73 7461 626c  ask.org/en/stabl
+00028fb0: 652f 6465 706c 6f79 6d65 6e74 2d63 6f6e  e/deployment-con
+00028fc0: 7369 6465 7261 7469 6f6e 732e 6874 6d6c  siderations.html
+00028fd0: 2363 6f6e 7369 7374 656e 742d 736f 6674  #consistent-soft
+00028fe0: 7761 7265 2d65 6e76 6972 6f6e 6d65 6e74  ware-environment
+00028ff0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+00029000: 2020 2222 220a 2020 2020 2020 2020 2020    """.          
+00029010: 2020 2020 2020 7261 6973 6520 5275 6e74        raise Runt
+00029020: 696d 6545 7272 6f72 2874 6578 7477 7261  imeError(textwra
+00029030: 702e 6465 6465 6e74 286d 7367 2929 2066  p.dedent(msg)) f
+00029040: 726f 6d20 650a 2020 2020 2020 2020 2020  rom e.          
+00029050: 2020 280a 2020 2020 2020 2020 2020 2020    (.            
+00029060: 2020 2020 6473 6b2c 0a20 2020 2020 2020      dsk,.       
+00029070: 2020 2020 2020 2020 2064 6570 656e 6465           depende
+00029080: 6e63 6965 732c 0a20 2020 2020 2020 2020  ncies,.         
+00029090: 2020 2020 2020 2061 6e6e 6f74 6174 696f         annotatio
+000290a0: 6e73 5f62 795f 7479 7065 2c0a 2020 2020  ns_by_type,.    
+000290b0: 2020 2020 2020 2020 2920 3d20 6177 6169          ) = awai
+000290c0: 7420 6f66 666c 6f61 6428 0a20 2020 2020  t offload(.     
+000290d0: 2020 2020 2020 2020 2020 205f 6d61 7465             _mate
+000290e0: 7269 616c 697a 655f 6772 6170 682c 0a20  rialize_graph,. 
+000290f0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+00029100: 7261 7068 3d67 7261 7068 2c0a 2020 2020  raph=graph,.    
+00029110: 2020 2020 2020 2020 2020 2020 676c 6f62              glob
+00029120: 616c 5f61 6e6e 6f74 6174 696f 6e73 3d61  al_annotations=a
+00029130: 6e6e 6f74 6174 696f 6e73 206f 7220 7b7d  nnotations or {}
+00029140: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00029150: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
+00029160: 6772 6170 680a 2020 2020 2020 2020 2020  graph.          
+00029170: 2020 6966 206e 6f74 2069 6e74 6572 6e61    if not interna
+00029180: 6c5f 7072 696f 7269 7479 3a0a 2020 2020  l_priority:.    
+00029190: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+000291a0: 6d6f 7669 6e67 2061 6c6c 206e 6f6e 2d6c  moving all non-l
+000291b0: 6f63 616c 206b 6579 7320 6265 666f 7265  ocal keys before
+000291c0: 2063 616c 6c69 6e67 206f 7264 6572 2829   calling order()
 000291d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000291e0: 2029 2020 2320 696e 7465 7273 6563 7469   )  # intersecti
-000291f0: 6f6e 2829 206f 6620 7365 7473 2069 7320  on() of sets is 
-00029200: 6d75 6368 2066 6173 7465 7220 7468 616e  much faster than
-00029210: 2064 6963 745f 6b65 7973 0a20 2020 2020   dict_keys.     
-00029220: 2020 2020 2020 2020 2020 2073 7472 6970             strip
-00029230: 7065 645f 6465 7073 203d 207b 0a20 2020  ped_deps = {.   
-00029240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029250: 206b 3a20 762e 696e 7465 7273 6563 7469   k: v.intersecti
-00029260: 6f6e 2864 736b 5f6b 6579 7329 0a20 2020  on(dsk_keys).   
-00029270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029280: 2066 6f72 206b 2c20 7620 696e 2064 6570   for k, v in dep
-00029290: 656e 6465 6e63 6965 732e 6974 656d 7328  endencies.items(
-000292a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000292b0: 2020 2020 2020 6966 206b 2069 6e20 6473        if k in ds
-000292c0: 6b5f 6b65 7973 0a20 2020 2020 2020 2020  k_keys.         
-000292d0: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
-000292e0: 2020 2020 2020 2020 2069 6e74 6572 6e61           interna
-000292f0: 6c5f 7072 696f 7269 7479 203d 2061 7761  l_priority = awa
-00029300: 6974 206f 6666 6c6f 6164 280a 2020 2020  it offload(.    
-00029310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029320: 6461 736b 2e6f 7264 6572 2e6f 7264 6572  dask.order.order
-00029330: 2c20 6473 6b3d 6473 6b2c 2064 6570 656e  , dsk=dsk, depen
-00029340: 6465 6e63 6965 733d 7374 7269 7070 6564  dencies=stripped
-00029350: 5f64 6570 730a 2020 2020 2020 2020 2020  _deps.          
-00029360: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00029370: 2020 2020 2073 656c 662e 5f63 7265 6174       self._creat
-00029380: 655f 7461 736b 7374 6174 655f 6672 6f6d  e_taskstate_from
-00029390: 5f67 7261 7068 280a 2020 2020 2020 2020  _graph(.        
-000293a0: 2020 2020 2020 2020 6473 6b3d 6473 6b2c          dsk=dsk,
-000293b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000293c0: 2063 6c69 656e 743d 636c 6965 6e74 2c0a   client=client,.
+000291e0: 2064 736b 5f6b 6579 7320 3d20 7365 7428   dsk_keys = set(
+000291f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029200: 2020 2020 2064 736b 0a20 2020 2020 2020       dsk.       
+00029210: 2020 2020 2020 2020 2029 2020 2320 696e           )  # in
+00029220: 7465 7273 6563 7469 6f6e 2829 206f 6620  tersection() of 
+00029230: 7365 7473 2069 7320 6d75 6368 2066 6173  sets is much fas
+00029240: 7465 7220 7468 616e 2064 6963 745f 6b65  ter than dict_ke
+00029250: 7973 0a20 2020 2020 2020 2020 2020 2020  ys.             
+00029260: 2020 2073 7472 6970 7065 645f 6465 7073     stripped_deps
+00029270: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00029280: 2020 2020 2020 2020 206b 3a20 762e 696e           k: v.in
+00029290: 7465 7273 6563 7469 6f6e 2864 736b 5f6b  tersection(dsk_k
+000292a0: 6579 7329 0a20 2020 2020 2020 2020 2020  eys).           
+000292b0: 2020 2020 2020 2020 2066 6f72 206b 2c20           for k, 
+000292c0: 7620 696e 2064 6570 656e 6465 6e63 6965  v in dependencie
+000292d0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
+000292e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+000292f0: 206b 2069 6e20 6473 6b5f 6b65 7973 0a20   k in dsk_keys. 
+00029300: 2020 2020 2020 2020 2020 2020 2020 207d                 }
+00029310: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029320: 2069 6e74 6572 6e61 6c5f 7072 696f 7269   internal_priori
+00029330: 7479 203d 2061 7761 6974 206f 6666 6c6f  ty = await offlo
+00029340: 6164 280a 2020 2020 2020 2020 2020 2020  ad(.            
+00029350: 2020 2020 2020 2020 6461 736b 2e6f 7264          dask.ord
+00029360: 6572 2e6f 7264 6572 2c20 6473 6b3d 6473  er.order, dsk=ds
+00029370: 6b2c 2064 6570 656e 6465 6e63 6965 733d  k, dependencies=
+00029380: 7374 7269 7070 6564 5f64 6570 730a 2020  stripped_deps.  
+00029390: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000293a0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000293b0: 662e 5f63 7265 6174 655f 7461 736b 7374  f._create_taskst
+000293c0: 6174 655f 6672 6f6d 5f67 7261 7068 280a  ate_from_graph(.
 000293d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000293e0: 6465 7065 6e64 656e 6369 6573 3d64 6570  dependencies=dep
-000293f0: 656e 6465 6e63 6965 732c 0a20 2020 2020  endencies,.     
-00029400: 2020 2020 2020 2020 2020 206b 6579 733d             keys=
-00029410: 7365 7428 6b65 7973 292c 0a20 2020 2020  set(keys),.     
-00029420: 2020 2020 2020 2020 2020 206f 7264 6572             order
-00029430: 6564 3d69 6e74 6572 6e61 6c5f 7072 696f  ed=internal_prio
-00029440: 7269 7479 206f 7220 7b7d 2c0a 2020 2020  rity or {},.    
-00029450: 2020 2020 2020 2020 2020 2020 7375 626d              subm
-00029460: 6974 7469 6e67 5f74 6173 6b3d 7375 626d  itting_task=subm
-00029470: 6974 7469 6e67 5f74 6173 6b2c 0a20 2020  itting_task,.   
-00029480: 2020 2020 2020 2020 2020 2020 2075 7365               use
-00029490: 725f 7072 696f 7269 7479 3d75 7365 725f  r_priority=user_
-000294a0: 7072 696f 7269 7479 2c0a 2020 2020 2020  priority,.      
-000294b0: 2020 2020 2020 2020 2020 6163 746f 7273            actors
-000294c0: 3d61 6374 6f72 732c 0a20 2020 2020 2020  =actors,.       
-000294d0: 2020 2020 2020 2020 2066 6966 6f5f 7469           fifo_ti
-000294e0: 6d65 6f75 743d 6669 666f 5f74 696d 656f  meout=fifo_timeo
-000294f0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-00029500: 2020 2020 636f 6465 3d63 6f64 652c 0a20      code=code,. 
-00029510: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00029520: 6e6e 6f74 6174 696f 6e73 5f62 795f 7479  nnotations_by_ty
-00029530: 7065 3d61 6e6e 6f74 6174 696f 6e73 5f62  pe=annotations_b
-00029540: 795f 7479 7065 2c0a 2020 2020 2020 2020  y_type,.        
-00029550: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
-00029560: 2054 6869 7320 6973 206a 7573 7420 7573   This is just us
-00029570: 6564 2074 6f20 6174 7461 6368 2074 6f20  ed to attach to 
-00029580: 436f 6d70 7574 6174 696f 6e0a 2020 2020  Computation.    
-00029590: 2020 2020 2020 2020 2020 2020 2320 6f62              # ob
-000295a0: 6a65 6374 732e 2054 6869 7320 7368 6f75  jects. This shou
-000295b0: 6c64 2062 6520 7265 6d6f 7665 640a 2020  ld be removed.  
-000295c0: 2020 2020 2020 2020 2020 2020 2020 676c                gl
-000295d0: 6f62 616c 5f61 6e6e 6f74 6174 696f 6e73  obal_annotations
-000295e0: 3d61 6e6e 6f74 6174 696f 6e73 2c0a 2020  =annotations,.  
-000295f0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00029600: 6172 743d 7374 6172 742c 0a20 2020 2020  art=start,.     
-00029610: 2020 2020 2020 2020 2020 2073 7469 6d75             stimu
-00029620: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-00029630: 6964 206f 7220 6622 7570 6461 7465 2d67  id or f"update-g
-00029640: 7261 7068 2d7b 7374 6172 747d 222c 0a20  raph-{start}",. 
-00029650: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-00029660: 2020 2020 2065 7863 6570 7420 5275 6e74       except Runt
-00029670: 696d 6545 7272 6f72 2061 7320 653a 0a20  imeError as e:. 
-00029680: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00029690: 722e 6572 726f 7228 7374 7228 6529 290a  r.error(str(e)).
-000296a0: 2020 2020 2020 2020 2020 2020 6572 7220              err 
-000296b0: 3d20 6572 726f 725f 6d65 7373 6167 6528  = error_message(
-000296c0: 6529 0a20 2020 2020 2020 2020 2020 2066  e).            f
-000296d0: 6f72 206b 6579 2069 6e20 6b65 7973 3a0a  or key in keys:.
-000296e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000296f0: 7365 6c66 2e72 6570 6f72 7428 0a20 2020  self.report(.   
-00029700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029710: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00029720: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
-00029730: 2022 7461 736b 2d65 7272 6564 222c 0a20   "task-erred",. 
-00029740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029750: 2020 2020 2020 2022 6b65 7922 3a20 6b65         "key": ke
-00029760: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-00029770: 2020 2020 2020 2020 2020 2022 6578 6365             "exce
-00029780: 7074 696f 6e22 3a20 6572 725b 2265 7863  ption": err["exc
-00029790: 6570 7469 6f6e 225d 2c0a 2020 2020 2020  eption"],.      
+000293e0: 6473 6b3d 6473 6b2c 0a20 2020 2020 2020  dsk=dsk,.       
+000293f0: 2020 2020 2020 2020 2063 6c69 656e 743d           client=
+00029400: 636c 6965 6e74 2c0a 2020 2020 2020 2020  client,.        
+00029410: 2020 2020 2020 2020 6465 7065 6e64 656e          dependen
+00029420: 6369 6573 3d64 6570 656e 6465 6e63 6965  cies=dependencie
+00029430: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00029440: 2020 206b 6579 733d 7365 7428 6b65 7973     keys=set(keys
+00029450: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00029460: 2020 206f 7264 6572 6564 3d69 6e74 6572     ordered=inter
+00029470: 6e61 6c5f 7072 696f 7269 7479 206f 7220  nal_priority or 
+00029480: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
+00029490: 2020 2020 7375 626d 6974 7469 6e67 5f74      submitting_t
+000294a0: 6173 6b3d 7375 626d 6974 7469 6e67 5f74  ask=submitting_t
+000294b0: 6173 6b2c 0a20 2020 2020 2020 2020 2020  ask,.           
+000294c0: 2020 2020 2075 7365 725f 7072 696f 7269       user_priori
+000294d0: 7479 3d75 7365 725f 7072 696f 7269 7479  ty=user_priority
+000294e0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000294f0: 2020 6163 746f 7273 3d61 6374 6f72 732c    actors=actors,
+00029500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029510: 2066 6966 6f5f 7469 6d65 6f75 743d 6669   fifo_timeout=fi
+00029520: 666f 5f74 696d 656f 7574 2c0a 2020 2020  fo_timeout,.    
+00029530: 2020 2020 2020 2020 2020 2020 636f 6465              code
+00029540: 3d63 6f64 652c 0a20 2020 2020 2020 2020  =code,.         
+00029550: 2020 2020 2020 2061 6e6e 6f74 6174 696f         annotatio
+00029560: 6e73 5f62 795f 7479 7065 3d61 6e6e 6f74  ns_by_type=annot
+00029570: 6174 696f 6e73 5f62 795f 7479 7065 2c0a  ations_by_type,.
+00029580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029590: 2320 4649 584d 453a 2054 6869 7320 6973  # FIXME: This is
+000295a0: 206a 7573 7420 7573 6564 2074 6f20 6174   just used to at
+000295b0: 7461 6368 2074 6f20 436f 6d70 7574 6174  tach to Computat
+000295c0: 696f 6e0a 2020 2020 2020 2020 2020 2020  ion.            
+000295d0: 2020 2020 2320 6f62 6a65 6374 732e 2054      # objects. T
+000295e0: 6869 7320 7368 6f75 6c64 2062 6520 7265  his should be re
+000295f0: 6d6f 7665 640a 2020 2020 2020 2020 2020  moved.          
+00029600: 2020 2020 2020 676c 6f62 616c 5f61 6e6e        global_ann
+00029610: 6f74 6174 696f 6e73 3d61 6e6e 6f74 6174  otations=annotat
+00029620: 696f 6e73 2c0a 2020 2020 2020 2020 2020  ions,.          
+00029630: 2020 2020 2020 7374 6172 743d 7374 6172        start=star
+00029640: 742c 0a20 2020 2020 2020 2020 2020 2020  t,.             
+00029650: 2020 2073 7469 6d75 6c75 735f 6964 3d73     stimulus_id=s
+00029660: 7469 6d75 6c75 735f 6964 206f 7220 6622  timulus_id or f"
+00029670: 7570 6461 7465 2d67 7261 7068 2d7b 7374  update-graph-{st
+00029680: 6172 747d 222c 0a20 2020 2020 2020 2020  art}",.         
+00029690: 2020 2029 0a20 2020 2020 2020 2065 7863     ).        exc
+000296a0: 6570 7420 5275 6e74 696d 6545 7272 6f72  ept RuntimeError
+000296b0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
+000296c0: 2020 206c 6f67 6765 722e 6572 726f 7228     logger.error(
+000296d0: 7374 7228 6529 290a 2020 2020 2020 2020  str(e)).        
+000296e0: 2020 2020 6572 7220 3d20 6572 726f 725f      err = error_
+000296f0: 6d65 7373 6167 6528 6529 0a20 2020 2020  message(e).     
+00029700: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
+00029710: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+00029720: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
+00029730: 6f72 7428 0a20 2020 2020 2020 2020 2020  ort(.           
+00029740: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
+00029750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029760: 2020 2022 6f70 223a 2022 7461 736b 2d65     "op": "task-e
+00029770: 7272 6564 222c 0a20 2020 2020 2020 2020  rred",.         
+00029780: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00029790: 6b65 7922 3a20 6b65 792c 0a20 2020 2020  key": key,.     
 000297a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000297b0: 2020 2274 7261 6365 6261 636b 223a 2065    "traceback": e
-000297c0: 7272 5b22 7472 6163 6562 6163 6b22 5d2c  rr["traceback"],
-000297d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000297e0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
-000297f0: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-00029800: 6973 2069 6e66 6f72 6d73 2061 6c6c 2063  is informs all c
-00029810: 6c69 656e 7473 2069 6e20 7768 6f5f 7761  lients in who_wa
-00029820: 6e74 7320 706c 7573 2074 6865 2063 7572  nts plus the cur
-00029830: 7265 6e74 2063 6c69 656e 740a 2020 2020  rent client.    
-00029840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029850: 2320 2877 6869 6368 206d 6179 206e 6f74  # (which may not
-00029860: 2068 6176 6520 6265 656e 2061 6464 6564   have been added
-00029870: 2074 6f20 7768 6f5f 7761 6e74 7320 7965   to who_wants ye
-00029880: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00029890: 2020 2020 2020 2063 6c69 656e 743d 636c         client=cl
-000298a0: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
-000298b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000298c0: 656e 6420 3d20 7469 6d65 2829 0a20 2020  end = time().   
-000298d0: 2020 2020 2073 656c 662e 6469 6765 7374       self.digest
-000298e0: 5f6d 6574 7269 6328 2275 7064 6174 652d  _metric("update-
-000298f0: 6772 6170 682d 6475 7261 7469 6f6e 222c  graph-duration",
-00029900: 2065 6e64 202d 2073 7461 7274 290a 0a20   end - start).. 
-00029910: 2020 2064 6566 205f 6765 6e65 7261 7465     def _generate
-00029920: 5f74 6173 6b73 7461 7465 7328 0a20 2020  _taskstates(.   
-00029930: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00029940: 2020 206b 6579 733a 2073 6574 5b4b 6579     keys: set[Key
-00029950: 5d2c 0a20 2020 2020 2020 2064 736b 3a20  ],.        dsk: 
-00029960: 6469 6374 5b4b 6579 2c20 545f 7275 6e73  dict[Key, T_runs
-00029970: 7065 635d 2c0a 2020 2020 2020 2020 6465  pec],.        de
-00029980: 7065 6e64 656e 6369 6573 3a20 6469 6374  pendencies: dict
-00029990: 5b4b 6579 2c20 7365 745b 4b65 795d 5d2c  [Key, set[Key]],
-000299a0: 0a20 2020 2020 2020 2063 6f6d 7075 7461  .        computa
-000299b0: 7469 6f6e 3a20 436f 6d70 7574 6174 696f  tion: Computatio
-000299c0: 6e2c 0a20 2020 2029 202d 3e20 7475 706c  n,.    ) -> tupl
-000299d0: 653a 0a20 2020 2020 2020 2023 2047 6574  e:.        # Get
-000299e0: 206f 7220 6372 6561 7465 2074 6173 6b20   or create task 
-000299f0: 7374 6174 6573 0a20 2020 2020 2020 2072  states.        r
-00029a00: 756e 6e61 626c 6520 3d20 5b5d 0a20 2020  unnable = [].   
-00029a10: 2020 2020 206e 6577 5f74 6173 6b73 203d       new_tasks =
-00029a20: 205b 5d0a 2020 2020 2020 2020 7374 6163   [].        stac
-00029a30: 6b20 3d20 6c69 7374 286b 6579 7329 0a20  k = list(keys). 
-00029a40: 2020 2020 2020 2074 6f75 6368 6564 5f6b         touched_k
-00029a50: 6579 7320 3d20 7365 7428 290a 2020 2020  eys = set().    
-00029a60: 2020 2020 746f 7563 6865 645f 7461 736b      touched_task
-00029a70: 7320 3d20 5b5d 0a20 2020 2020 2020 2074  s = [].        t
-00029a80: 6773 5f77 6974 685f 6261 645f 7275 6e5f  gs_with_bad_run_
-00029a90: 7370 6563 203d 2073 6574 2829 0a20 2020  spec = set().   
-00029aa0: 2020 2020 2077 6869 6c65 2073 7461 636b       while stack
-00029ab0: 3a0a 2020 2020 2020 2020 2020 2020 6b20  :.            k 
-00029ac0: 3d20 7374 6163 6b2e 706f 7028 290a 2020  = stack.pop().  
-00029ad0: 2020 2020 2020 2020 2020 6966 206b 2069            if k i
-00029ae0: 6e20 746f 7563 6865 645f 6b65 7973 3a0a  n touched_keys:.
-00029af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00029b00: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-00029b10: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-00029b20: 6173 6b73 2e67 6574 286b 290a 2020 2020  asks.get(k).    
-00029b30: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
-00029b40: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00029b50: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00029b60: 2e6e 6577 5f74 6173 6b28 6b2c 2064 736b  .new_task(k, dsk
-00029b70: 2e67 6574 286b 292c 2022 7265 6c65 6173  .get(k), "releas
-00029b80: 6564 222c 2063 6f6d 7075 7461 7469 6f6e  ed", computation
-00029b90: 3d63 6f6d 7075 7461 7469 6f6e 290a 2020  =computation).  
-00029ba0: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-00029bb0: 775f 7461 736b 732e 6170 7065 6e64 2874  w_tasks.append(t
-00029bc0: 7329 0a20 2020 2020 2020 2020 2020 2023  s).            #
-00029bd0: 2049 7420 6973 2070 6f73 7369 626c 6520   It is possible 
-00029be0: 746f 2063 7265 6174 6520 7468 6520 5461  to create the Ta
-00029bf0: 736b 5374 6174 6520 6f62 6a65 6374 2062  skState object b
-00029c00: 6566 6f72 6520 6974 7320 7275 6e73 7065  efore its runspe
-00029c10: 6320 6973 206b 6e6f 776e 0a20 2020 2020  c is known.     
-00029c20: 2020 2020 2020 2023 2074 6f20 7468 6520         # to the 
-00029c30: 7363 6865 6475 6c65 722e 2046 6f72 2069  scheduler. For i
-00029c40: 6e73 7461 6e63 652c 2074 6869 7320 6973  nstance, this is
-00029c50: 2070 6f73 7369 626c 6520 7768 656e 2075   possible when u
-00029c60: 7369 6e67 2061 2056 6172 6961 626c 653a  sing a Variable:
-00029c70: 0a20 2020 2020 2020 2020 2020 2023 2060  .            # `
-00029c80: 6620 3d20 632e 7375 626d 6974 2866 6f6f  f = c.submit(foo
-00029c90: 293b 2061 7761 6974 2056 6172 6961 626c  ); await Variabl
-00029ca0: 6528 292e 7365 7428 6629 6020 7369 6e63  e().set(f)` sinc
-00029cb0: 6520 7468 6520 5661 7269 6162 6c65 2075  e the Variable u
-00029cc0: 7365 7320 610a 2020 2020 2020 2020 2020  ses a.          
-00029cd0: 2020 2320 6469 6666 6572 656e 7420 636f    # different co
-00029ce0: 6d6d 2063 6861 6e6e 656c 2c20 736f 2074  mm channel, so t
-00029cf0: 6865 2060 636c 6965 6e74 5f64 6573 6972  he `client_desir
-00029d00: 6573 5f6b 6579 6020 6d65 7373 6167 6520  es_key` message 
-00029d10: 636f 756c 6420 6172 7269 7665 0a20 2020  could arrive.   
-00029d20: 2020 2020 2020 2020 2023 2062 6566 6f72           # befor
-00029d30: 6520 6075 7064 6174 655f 6772 6170 6860  e `update_graph`
-00029d40: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00029d50: 5468 6572 6520 6172 6520 616c 736f 2061  There are also a
-00029d60: 6e74 692d 7061 7474 6572 6e20 7072 6f63  nti-pattern proc
-00029d70: 6573 7365 7320 706f 7373 6962 6c65 3b0a  esses possible;.
-00029d80: 2020 2020 2020 2020 2020 2020 2320 7365              # se
-00029d90: 6520 666f 7220 6578 616d 706c 6520 7465  e for example te
-00029da0: 7374 5f73 6361 7474 6572 5f63 7265 6174  st_scatter_creat
-00029db0: 6573 5f74 730a 2020 2020 2020 2020 2020  es_ts.          
-00029dc0: 2020 656c 6966 2074 732e 7275 6e5f 7370    elif ts.run_sp
-00029dd0: 6563 2069 7320 4e6f 6e65 3a0a 2020 2020  ec is None:.    
-00029de0: 2020 2020 2020 2020 2020 2020 7473 2e72              ts.r
-00029df0: 756e 5f73 7065 6320 3d20 6473 6b2e 6765  un_spec = dsk.ge
-00029e00: 7428 6b29 0a20 2020 2020 2020 2020 2020  t(k).           
-00029e10: 2023 2072 756e 5f73 7065 6320 696e 2074   # run_spec in t
-00029e20: 6865 2073 7562 6d69 7474 6564 2067 7261  he submitted gra
-00029e30: 7068 206d 6179 2062 6520 4e6f 6e65 2e20  ph may be None. 
-00029e40: 5468 6973 2068 6170 7065 6e73 0a20 2020  This happens.   
-00029e50: 2020 2020 2020 2020 2023 2077 6865 6e20           # when 
-00029e60: 616e 2061 6c72 6561 6479 2070 6572 7369  an already persi
-00029e70: 7374 6564 2066 7574 7572 6520 6973 2070  sted future is p
-00029e80: 6172 7420 6f66 2074 6865 2067 7261 7068  art of the graph
-00029e90: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
-00029ea0: 6620 6b20 696e 2064 736b 3a0a 2020 2020  f k in dsk:.    
-00029eb0: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-00029ec0: 2062 6f74 6820 746f 6b65 6e73 2061 7265   both tokens are
-00029ed0: 206e 6f6e 2d64 6574 6572 6d69 6e69 7374   non-determinist
-00029ee0: 6963 2c20 736b 6970 2063 6f6d 7061 7269  ic, skip compari
-00029ef0: 736f 6e0a 2020 2020 2020 2020 2020 2020  son.            
-00029f00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00029f10: 2020 2020 2020 2020 2020 2020 2074 6f6b               tok
-00029f20: 5f6c 6873 203d 2074 6f6b 656e 697a 6528  _lhs = tokenize(
-00029f30: 7473 2e72 756e 5f73 7065 632c 2065 6e73  ts.run_spec, ens
-00029f40: 7572 655f 6465 7465 726d 696e 6973 7469  ure_deterministi
-00029f50: 633d 5472 7565 290a 2020 2020 2020 2020  c=True).        
-00029f60: 2020 2020 2020 2020 6578 6365 7074 2054          except T
-00029f70: 6f6b 656e 697a 6174 696f 6e45 7272 6f72  okenizationError
-00029f80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00029f90: 2020 2020 2020 746f 6b5f 6c68 7320 3d20        tok_lhs = 
-00029fa0: 2222 0a20 2020 2020 2020 2020 2020 2020  "".             
-00029fb0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00029fc0: 2020 2020 2020 2020 2020 2020 746f 6b5f              tok_
-00029fd0: 7268 7320 3d20 746f 6b65 6e69 7a65 2864  rhs = tokenize(d
-00029fe0: 736b 5b6b 5d2c 2065 6e73 7572 655f 6465  sk[k], ensure_de
-00029ff0: 7465 726d 696e 6973 7469 633d 5472 7565  terministic=True
-0002a000: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002a010: 2020 6578 6365 7074 2054 6f6b 656e 697a    except Tokeniz
-0002a020: 6174 696f 6e45 7272 6f72 3a0a 2020 2020  ationError:.    
-0002a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a040: 746f 6b5f 7268 7320 3d20 2222 0a0a 2020  tok_rhs = ""..  
-0002a050: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002a060: 4164 6469 7469 6f6e 616c 6c79 2063 6865  Additionally che
-0002a070: 636b 2064 6570 656e 6465 6e63 7920 6e61  ck dependency na
-0002a080: 6d65 732e 2054 6869 7320 7368 6f75 6c64  mes. This should
-0002a090: 206f 6e6c 7920 6265 206e 6563 6573 7361   only be necessa
-0002a0a0: 7279 0a20 2020 2020 2020 2020 2020 2020  ry.             
-0002a0b0: 2020 2023 2069 6620 7275 6e5f 7370 6563     # if run_spec
-0002a0c0: 7320 6361 6e27 7420 6265 2074 6f6b 656e  s can't be token
-0002a0d0: 697a 6564 2064 6574 6572 6d69 6e69 7374  ized determinist
-0002a0e0: 6963 616c 6c79 2e0a 2020 2020 2020 2020  ically..        
-0002a0f0: 2020 2020 2020 2020 6465 7073 5f6c 6873          deps_lhs
-0002a100: 203d 207b 6474 732e 6b65 7920 666f 7220   = {dts.key for 
-0002a110: 6474 7320 696e 2074 732e 6465 7065 6e64  dts in ts.depend
-0002a120: 656e 6369 6573 7d0a 2020 2020 2020 2020  encies}.        
-0002a130: 2020 2020 2020 2020 6465 7073 5f72 6873          deps_rhs
-0002a140: 203d 2064 6570 656e 6465 6e63 6965 735b   = dependencies[
-0002a150: 6b5d 0a0a 2020 2020 2020 2020 2020 2020  k]..            
-0002a160: 2020 2020 2320 4649 584d 4520 4974 2077      # FIXME It w
-0002a170: 6f75 6c64 2062 6520 6120 7265 616c 6c79  ould be a really
-0002a180: 2068 6561 6c74 6879 2069 6465 6120 746f   healthy idea to
-0002a190: 2063 6861 6e67 6520 7468 6973 2074 6f20   change this to 
-0002a1a0: 6120 6861 7264 0a20 2020 2020 2020 2020  a hard.         
-0002a1b0: 2020 2020 2020 2023 2066 6169 6c75 7265         # failure
-0002a1c0: 2e20 486f 7765 7665 722c 2074 6869 7320  . However, this 
-0002a1d0: 6973 206e 6f74 2070 6f73 7369 626c 6520  is not possible 
-0002a1e0: 6174 2074 6865 206d 6f6d 656e 7420 6265  at the moment be
-0002a1f0: 6361 7573 6520 6f66 0a20 2020 2020 2020  cause of.       
-0002a200: 2020 2020 2020 2020 2023 2068 7474 7073           # https
-0002a210: 3a2f 2f67 6974 6875 622e 636f 6d2f 6461  ://github.com/da
-0002a220: 736b 2f64 6173 6b2f 6973 7375 6573 2f39  sk/dask/issues/9
-0002a230: 3838 380a 2020 2020 2020 2020 2020 2020  888.            
-0002a240: 2020 2020 6966 2074 6f6b 5f6c 6873 2021      if tok_lhs !
-0002a250: 3d20 746f 6b5f 7268 7320 6f72 2064 6570  = tok_rhs or dep
-0002a260: 735f 6c68 7320 213d 2064 6570 735f 7268  s_lhs != deps_rh
-0002a270: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0002a280: 2020 2020 2020 2023 2052 6574 6169 6e20         # Retain 
-0002a290: 6f6c 6420 7275 6e5f 7370 6563 2061 6e64  old run_spec and
-0002a2a0: 2064 6570 656e 6465 6e63 6965 733b 2072   dependencies; r
-0002a2b0: 6572 756e 2074 6865 6d20 6966 206e 6563  erun them if nec
-0002a2c0: 6573 7361 7279 2e0a 2020 2020 2020 2020  essary..        
-0002a2d0: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
-0002a2e0: 6973 2073 7765 6570 7320 7468 6520 6973  is sweeps the is
-0002a2f0: 7375 6520 6f66 2063 6f6c 6c69 7369 6f6e  sue of collision
-0002a300: 2075 6e64 6572 2074 6865 2063 6172 7065   under the carpe
-0002a310: 7420 6173 206c 6f6e 6720 6173 2074 6865  t as long as the
-0002a320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a330: 2020 2020 2023 206f 6c64 2061 6e64 206e       # old and n
-0002a340: 6577 2074 6173 6b20 7072 6f64 7563 6520  ew task produce 
-0002a350: 7468 6520 7361 6d65 206f 7574 7075 7420  the same output 
-0002a360: 2d20 7375 6368 2061 7320 696e 0a20 2020  - such as in.   
-0002a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a380: 2023 2064 6173 6b2f 6461 736b 2339 3838   # dask/dask#988
-0002a390: 382e 0a20 2020 2020 2020 2020 2020 2020  8..             
-0002a3a0: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
-0002a3b0: 6965 735b 6b5d 203d 2064 6570 735f 6c68  ies[k] = deps_lh
-0002a3c0: 730a 0a20 2020 2020 2020 2020 2020 2020  s..             
-0002a3d0: 2020 2020 2020 2069 6620 7473 2e67 726f         if ts.gro
-0002a3e0: 7570 206e 6f74 2069 6e20 7467 735f 7769  up not in tgs_wi
-0002a3f0: 7468 5f62 6164 5f72 756e 5f73 7065 633a  th_bad_run_spec:
-0002a400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a410: 2020 2020 2020 2020 2074 6773 5f77 6974           tgs_wit
-0002a420: 685f 6261 645f 7275 6e5f 7370 6563 2e61  h_bad_run_spec.a
-0002a430: 6464 2874 732e 6772 6f75 7029 0a20 2020  dd(ts.group).   
+000297b0: 2020 2022 6578 6365 7074 696f 6e22 3a20     "exception": 
+000297c0: 6572 725b 2265 7863 6570 7469 6f6e 225d  err["exception"]
+000297d0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000297e0: 2020 2020 2020 2020 2020 2274 7261 6365            "trace
+000297f0: 6261 636b 223a 2065 7272 5b22 7472 6163  back": err["trac
+00029800: 6562 6163 6b22 5d2c 0a20 2020 2020 2020  eback"],.       
+00029810: 2020 2020 2020 2020 2020 2020 207d 2c0a               },.
+00029820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029830: 2020 2020 2320 5468 6973 2069 6e66 6f72      # This infor
+00029840: 6d73 2061 6c6c 2063 6c69 656e 7473 2069  ms all clients i
+00029850: 6e20 7768 6f5f 7761 6e74 7320 706c 7573  n who_wants plus
+00029860: 2074 6865 2063 7572 7265 6e74 2063 6c69   the current cli
+00029870: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+00029880: 2020 2020 2020 2020 2320 2877 6869 6368          # (which
+00029890: 206d 6179 206e 6f74 2068 6176 6520 6265   may not have be
+000298a0: 656e 2061 6464 6564 2074 6f20 7768 6f5f  en added to who_
+000298b0: 7761 6e74 7320 7965 7429 0a20 2020 2020  wants yet).     
+000298c0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000298d0: 6c69 656e 743d 636c 6965 6e74 2c0a 2020  lient=client,.  
+000298e0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000298f0: 2020 2020 2020 2020 656e 6420 3d20 7469          end = ti
+00029900: 6d65 2829 0a20 2020 2020 2020 2073 656c  me().        sel
+00029910: 662e 6469 6765 7374 5f6d 6574 7269 6328  f.digest_metric(
+00029920: 2275 7064 6174 652d 6772 6170 682d 6475  "update-graph-du
+00029930: 7261 7469 6f6e 222c 2065 6e64 202d 2073  ration", end - s
+00029940: 7461 7274 290a 0a20 2020 2064 6566 205f  tart)..    def _
+00029950: 6765 6e65 7261 7465 5f74 6173 6b73 7461  generate_tasksta
+00029960: 7465 7328 0a20 2020 2020 2020 2073 656c  tes(.        sel
+00029970: 662c 0a20 2020 2020 2020 206b 6579 733a  f,.        keys:
+00029980: 2073 6574 5b4b 6579 5d2c 0a20 2020 2020   set[Key],.     
+00029990: 2020 2064 736b 3a20 6469 6374 5b4b 6579     dsk: dict[Key
+000299a0: 2c20 545f 7275 6e73 7065 635d 2c0a 2020  , T_runspec],.  
+000299b0: 2020 2020 2020 6465 7065 6e64 656e 6369        dependenci
+000299c0: 6573 3a20 6469 6374 5b4b 6579 2c20 7365  es: dict[Key, se
+000299d0: 745b 4b65 795d 5d2c 0a20 2020 2020 2020  t[Key]],.       
+000299e0: 2063 6f6d 7075 7461 7469 6f6e 3a20 436f   computation: Co
+000299f0: 6d70 7574 6174 696f 6e2c 0a20 2020 2029  mputation,.    )
+00029a00: 202d 3e20 7475 706c 653a 0a20 2020 2020   -> tuple:.     
+00029a10: 2020 2023 2047 6574 206f 7220 6372 6561     # Get or crea
+00029a20: 7465 2074 6173 6b20 7374 6174 6573 0a20  te task states. 
+00029a30: 2020 2020 2020 2072 756e 6e61 626c 6520         runnable 
+00029a40: 3d20 5b5d 0a20 2020 2020 2020 206e 6577  = [].        new
+00029a50: 5f74 6173 6b73 203d 205b 5d0a 2020 2020  _tasks = [].    
+00029a60: 2020 2020 7374 6163 6b20 3d20 6c69 7374      stack = list
+00029a70: 286b 6579 7329 0a20 2020 2020 2020 2074  (keys).        t
+00029a80: 6f75 6368 6564 5f6b 6579 7320 3d20 7365  ouched_keys = se
+00029a90: 7428 290a 2020 2020 2020 2020 746f 7563  t().        touc
+00029aa0: 6865 645f 7461 736b 7320 3d20 5b5d 0a20  hed_tasks = []. 
+00029ab0: 2020 2020 2020 2074 6773 5f77 6974 685f         tgs_with_
+00029ac0: 6261 645f 7275 6e5f 7370 6563 203d 2073  bad_run_spec = s
+00029ad0: 6574 2829 0a20 2020 2020 2020 2077 6869  et().        whi
+00029ae0: 6c65 2073 7461 636b 3a0a 2020 2020 2020  le stack:.      
+00029af0: 2020 2020 2020 6b20 3d20 7374 6163 6b2e        k = stack.
+00029b00: 706f 7028 290a 2020 2020 2020 2020 2020  pop().          
+00029b10: 2020 6966 206b 2069 6e20 746f 7563 6865    if k in touche
+00029b20: 645f 6b65 7973 3a0a 2020 2020 2020 2020  d_keys:.        
+00029b30: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+00029b40: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
+00029b50: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
+00029b60: 286b 290a 2020 2020 2020 2020 2020 2020  (k).            
+00029b70: 6966 2074 7320 6973 204e 6f6e 653a 0a20  if ts is None:. 
+00029b80: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00029b90: 7320 3d20 7365 6c66 2e6e 6577 5f74 6173  s = self.new_tas
+00029ba0: 6b28 6b2c 2064 736b 2e67 6574 286b 292c  k(k, dsk.get(k),
+00029bb0: 2022 7265 6c65 6173 6564 222c 2063 6f6d   "released", com
+00029bc0: 7075 7461 7469 6f6e 3d63 6f6d 7075 7461  putation=computa
+00029bd0: 7469 6f6e 290a 2020 2020 2020 2020 2020  tion).          
+00029be0: 2020 2020 2020 6e65 775f 7461 736b 732e        new_tasks.
+00029bf0: 6170 7065 6e64 2874 7329 0a20 2020 2020  append(ts).     
+00029c00: 2020 2020 2020 2023 2049 7420 6973 2070         # It is p
+00029c10: 6f73 7369 626c 6520 746f 2063 7265 6174  ossible to creat
+00029c20: 6520 7468 6520 5461 736b 5374 6174 6520  e the TaskState 
+00029c30: 6f62 6a65 6374 2062 6566 6f72 6520 6974  object before it
+00029c40: 7320 7275 6e73 7065 6320 6973 206b 6e6f  s runspec is kno
+00029c50: 776e 0a20 2020 2020 2020 2020 2020 2023  wn.            #
+00029c60: 2074 6f20 7468 6520 7363 6865 6475 6c65   to the schedule
+00029c70: 722e 2046 6f72 2069 6e73 7461 6e63 652c  r. For instance,
+00029c80: 2074 6869 7320 6973 2070 6f73 7369 626c   this is possibl
+00029c90: 6520 7768 656e 2075 7369 6e67 2061 2056  e when using a V
+00029ca0: 6172 6961 626c 653a 0a20 2020 2020 2020  ariable:.       
+00029cb0: 2020 2020 2023 2060 6620 3d20 632e 7375       # `f = c.su
+00029cc0: 626d 6974 2866 6f6f 293b 2061 7761 6974  bmit(foo); await
+00029cd0: 2056 6172 6961 626c 6528 292e 7365 7428   Variable().set(
+00029ce0: 6629 6020 7369 6e63 6520 7468 6520 5661  f)` since the Va
+00029cf0: 7269 6162 6c65 2075 7365 7320 610a 2020  riable uses a.  
+00029d00: 2020 2020 2020 2020 2020 2320 6469 6666            # diff
+00029d10: 6572 656e 7420 636f 6d6d 2063 6861 6e6e  erent comm chann
+00029d20: 656c 2c20 736f 2074 6865 2060 636c 6965  el, so the `clie
+00029d30: 6e74 5f64 6573 6972 6573 5f6b 6579 6020  nt_desires_key` 
+00029d40: 6d65 7373 6167 6520 636f 756c 6420 6172  message could ar
+00029d50: 7269 7665 0a20 2020 2020 2020 2020 2020  rive.           
+00029d60: 2023 2062 6566 6f72 6520 6075 7064 6174   # before `updat
+00029d70: 655f 6772 6170 6860 2e0a 2020 2020 2020  e_graph`..      
+00029d80: 2020 2020 2020 2320 5468 6572 6520 6172        # There ar
+00029d90: 6520 616c 736f 2061 6e74 692d 7061 7474  e also anti-patt
+00029da0: 6572 6e20 7072 6f63 6573 7365 7320 706f  ern processes po
+00029db0: 7373 6962 6c65 3b0a 2020 2020 2020 2020  ssible;.        
+00029dc0: 2020 2020 2320 7365 6520 666f 7220 6578      # see for ex
+00029dd0: 616d 706c 6520 7465 7374 5f73 6361 7474  ample test_scatt
+00029de0: 6572 5f63 7265 6174 6573 5f74 730a 2020  er_creates_ts.  
+00029df0: 2020 2020 2020 2020 2020 656c 6966 2074            elif t
+00029e00: 732e 7275 6e5f 7370 6563 2069 7320 4e6f  s.run_spec is No
+00029e10: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00029e20: 2020 2020 7473 2e72 756e 5f73 7065 6320      ts.run_spec 
+00029e30: 3d20 6473 6b2e 6765 7428 6b29 0a20 2020  = dsk.get(k).   
+00029e40: 2020 2020 2020 2020 2023 2072 756e 5f73           # run_s
+00029e50: 7065 6320 696e 2074 6865 2073 7562 6d69  pec in the submi
+00029e60: 7474 6564 2067 7261 7068 206d 6179 2062  tted graph may b
+00029e70: 6520 4e6f 6e65 2e20 5468 6973 2068 6170  e None. This hap
+00029e80: 7065 6e73 0a20 2020 2020 2020 2020 2020  pens.           
+00029e90: 2023 2077 6865 6e20 616e 2061 6c72 6561   # when an alrea
+00029ea0: 6479 2070 6572 7369 7374 6564 2066 7574  dy persisted fut
+00029eb0: 7572 6520 6973 2070 6172 7420 6f66 2074  ure is part of t
+00029ec0: 6865 2067 7261 7068 0a20 2020 2020 2020  he graph.       
+00029ed0: 2020 2020 2065 6c69 6620 6b20 696e 2064       elif k in d
+00029ee0: 736b 3a0a 2020 2020 2020 2020 2020 2020  sk:.            
+00029ef0: 2020 2020 2320 4966 2062 6f74 6820 746f      # If both to
+00029f00: 6b65 6e73 2061 7265 206e 6f6e 2d64 6574  kens are non-det
+00029f10: 6572 6d69 6e69 7374 6963 2c20 736b 6970  erministic, skip
+00029f20: 2063 6f6d 7061 7269 736f 6e0a 2020 2020   comparison.    
+00029f30: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+00029f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029f50: 2020 2020 2074 6f6b 5f6c 6873 203d 2074       tok_lhs = t
+00029f60: 6f6b 656e 697a 6528 7473 2e72 756e 5f73  okenize(ts.run_s
+00029f70: 7065 632c 2065 6e73 7572 655f 6465 7465  pec, ensure_dete
+00029f80: 726d 696e 6973 7469 633d 5472 7565 290a  rministic=True).
+00029f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029fa0: 6578 6365 7074 2054 6f6b 656e 697a 6174  except Tokenizat
+00029fb0: 696f 6e45 7272 6f72 3a0a 2020 2020 2020  ionError:.      
+00029fc0: 2020 2020 2020 2020 2020 2020 2020 746f                to
+00029fd0: 6b5f 6c68 7320 3d20 2222 0a20 2020 2020  k_lhs = "".     
+00029fe0: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00029ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a000: 2020 2020 746f 6b5f 7268 7320 3d20 746f      tok_rhs = to
+0002a010: 6b65 6e69 7a65 2864 736b 5b6b 5d2c 2065  kenize(dsk[k], e
+0002a020: 6e73 7572 655f 6465 7465 726d 696e 6973  nsure_determinis
+0002a030: 7469 633d 5472 7565 290a 2020 2020 2020  tic=True).      
+0002a040: 2020 2020 2020 2020 2020 6578 6365 7074            except
+0002a050: 2054 6f6b 656e 697a 6174 696f 6e45 7272   TokenizationErr
+0002a060: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+0002a070: 2020 2020 2020 2020 746f 6b5f 7268 7320          tok_rhs 
+0002a080: 3d20 2222 0a0a 2020 2020 2020 2020 2020  = ""..          
+0002a090: 2020 2020 2020 2320 4164 6469 7469 6f6e        # Addition
+0002a0a0: 616c 6c79 2063 6865 636b 2064 6570 656e  ally check depen
+0002a0b0: 6465 6e63 7920 6e61 6d65 732e 2054 6869  dency names. Thi
+0002a0c0: 7320 7368 6f75 6c64 206f 6e6c 7920 6265  s should only be
+0002a0d0: 206e 6563 6573 7361 7279 0a20 2020 2020   necessary.     
+0002a0e0: 2020 2020 2020 2020 2020 2023 2069 6620             # if 
+0002a0f0: 7275 6e5f 7370 6563 7320 6361 6e27 7420  run_specs can't 
+0002a100: 6265 2074 6f6b 656e 697a 6564 2064 6574  be tokenized det
+0002a110: 6572 6d69 6e69 7374 6963 616c 6c79 2e0a  erministically..
+0002a120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a130: 6465 7073 5f6c 6873 203d 207b 6474 732e  deps_lhs = {dts.
+0002a140: 6b65 7920 666f 7220 6474 7320 696e 2074  key for dts in t
+0002a150: 732e 6465 7065 6e64 656e 6369 6573 7d0a  s.dependencies}.
+0002a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a170: 6465 7073 5f72 6873 203d 2064 6570 656e  deps_rhs = depen
+0002a180: 6465 6e63 6965 735b 6b5d 0a0a 2020 2020  dencies[k]..    
+0002a190: 2020 2020 2020 2020 2020 2020 2320 4649              # FI
+0002a1a0: 584d 4520 4974 2077 6f75 6c64 2062 6520  XME It would be 
+0002a1b0: 6120 7265 616c 6c79 2068 6561 6c74 6879  a really healthy
+0002a1c0: 2069 6465 6120 746f 2063 6861 6e67 6520   idea to change 
+0002a1d0: 7468 6973 2074 6f20 6120 6861 7264 0a20  this to a hard. 
+0002a1e0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002a1f0: 2066 6169 6c75 7265 2e20 486f 7765 7665   failure. Howeve
+0002a200: 722c 2074 6869 7320 6973 206e 6f74 2070  r, this is not p
+0002a210: 6f73 7369 626c 6520 6174 2074 6865 206d  ossible at the m
+0002a220: 6f6d 656e 7420 6265 6361 7573 6520 6f66  oment because of
+0002a230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a240: 2023 2068 7474 7073 3a2f 2f67 6974 6875   # https://githu
+0002a250: 622e 636f 6d2f 6461 736b 2f64 6173 6b2f  b.com/dask/dask/
+0002a260: 6973 7375 6573 2f39 3838 380a 2020 2020  issues/9888.    
+0002a270: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0002a280: 6f6b 5f6c 6873 2021 3d20 746f 6b5f 7268  ok_lhs != tok_rh
+0002a290: 7320 6f72 2064 6570 735f 6c68 7320 213d  s or deps_lhs !=
+0002a2a0: 2064 6570 735f 7268 733a 0a20 2020 2020   deps_rhs:.     
+0002a2b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0002a2c0: 2052 6574 6169 6e20 6f6c 6420 7275 6e5f   Retain old run_
+0002a2d0: 7370 6563 2061 6e64 2064 6570 656e 6465  spec and depende
+0002a2e0: 6e63 6965 733b 2072 6572 756e 2074 6865  ncies; rerun the
+0002a2f0: 6d20 6966 206e 6563 6573 7361 7279 2e0a  m if necessary..
+0002a300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a310: 2020 2020 2320 5468 6973 2073 7765 6570      # This sweep
+0002a320: 7320 7468 6520 6973 7375 6520 6f66 2063  s the issue of c
+0002a330: 6f6c 6c69 7369 6f6e 2075 6e64 6572 2074  ollision under t
+0002a340: 6865 2063 6172 7065 7420 6173 206c 6f6e  he carpet as lon
+0002a350: 6720 6173 2074 6865 0a20 2020 2020 2020  g as the.       
+0002a360: 2020 2020 2020 2020 2020 2020 2023 206f               # o
+0002a370: 6c64 2061 6e64 206e 6577 2074 6173 6b20  ld and new task 
+0002a380: 7072 6f64 7563 6520 7468 6520 7361 6d65  produce the same
+0002a390: 206f 7574 7075 7420 2d20 7375 6368 2061   output - such a
+0002a3a0: 7320 696e 0a20 2020 2020 2020 2020 2020  s in.           
+0002a3b0: 2020 2020 2020 2020 2023 2064 6173 6b2f           # dask/
+0002a3c0: 6461 736b 2339 3838 382e 0a20 2020 2020  dask#9888..     
+0002a3d0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0002a3e0: 6570 656e 6465 6e63 6965 735b 6b5d 203d  ependencies[k] =
+0002a3f0: 2064 6570 735f 6c68 730a 0a20 2020 2020   deps_lhs..     
+0002a400: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002a410: 6620 7473 2e67 726f 7570 206e 6f74 2069  f ts.group not i
+0002a420: 6e20 7467 735f 7769 7468 5f62 6164 5f72  n tgs_with_bad_r
+0002a430: 756e 5f73 7065 633a 0a20 2020 2020 2020  un_spec:.       
 0002a440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a450: 2020 2020 206c 6f67 6765 722e 7761 726e       logger.warn
-0002a460: 696e 6728 0a20 2020 2020 2020 2020 2020  ing(.           
-0002a470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a480: 2066 2244 6574 6563 7465 6420 6469 6666   f"Detected diff
-0002a490: 6572 656e 7420 6072 756e 5f73 7065 6360  erent `run_spec`
-0002a4a0: 2066 6f72 206b 6579 207b 7473 2e6b 6579   for key {ts.key
-0002a4b0: 2172 7d20 6265 7477 6565 6e20 220a 2020  !r} between ".  
-0002a4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a4d0: 2020 2020 2020 2020 2020 2274 776f 2063            "two c
-0002a4e0: 6f6e 7365 6375 7469 7665 2063 616c 6c73  onsecutive calls
-0002a4f0: 2074 6f20 6075 7064 6174 655f 6772 6170   to `update_grap
-0002a500: 6860 2e20 220a 2020 2020 2020 2020 2020  h`. ".          
-0002a510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a520: 2020 2254 6869 7320 6361 6e20 6361 7573    "This can caus
-0002a530: 6520 6661 696c 7572 6573 2061 6e64 2064  e failures and d
-0002a540: 6561 646c 6f63 6b73 2064 6f77 6e20 7468  eadlocks down th
-0002a550: 6520 6c69 6e65 2e20 220a 2020 2020 2020  e line. ".      
-0002a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a570: 2020 2020 2020 2250 6c65 6173 6520 656e        "Please en
-0002a580: 7375 7265 2075 6e69 7175 6520 6b65 7920  sure unique key 
-0002a590: 6e61 6d65 732e 2022 0a20 2020 2020 2020  names. ".       
-0002a5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a5b0: 2020 2020 2022 4966 2079 6f75 2061 7265       "If you are
-0002a5c0: 2075 7369 6e67 2061 2073 7461 6e64 6172   using a standar
-0002a5d0: 6420 6461 736b 2063 6f6c 6c65 6374 696f  d dask collectio
-0002a5e0: 6e73 2c20 636f 6e73 6964 6572 2022 0a20  ns, consider ". 
-0002a5f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a600: 2020 2020 2020 2020 2020 2022 7265 6c65             "rele
-0002a610: 6173 696e 6720 616c 6c20 7468 6520 6461  asing all the da
-0002a620: 7461 2062 6566 6f72 6520 7265 7375 626d  ta before resubm
-0002a630: 6974 7469 6e67 2061 6e6f 7468 6572 2022  itting another "
-0002a640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a650: 2020 2020 2020 2020 2020 2020 2022 636f               "co
-0002a660: 6d70 7574 6174 696f 6e2e 204d 6f72 6520  mputation. More 
-0002a670: 6465 7461 696c 7320 616e 6420 6865 6c70  details and help
-0002a680: 2063 616e 2062 6520 666f 756e 6420 6174   can be found at
-0002a690: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0002a6a0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002a6b0: 6874 7470 733a 2f2f 6769 7468 7562 2e63  https://github.c
-0002a6c0: 6f6d 2f64 6173 6b2f 6461 736b 2f69 7373  om/dask/dask/iss
-0002a6d0: 7565 732f 3938 3838 2e20 220a 2020 2020  ues/9888. ".    
-0002a6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a6f0: 2020 2020 2020 2020 2b20 7465 7874 7772          + textwr
-0002a700: 6170 2e64 6564 656e 7428 0a20 2020 2020  ap.dedent(.     
-0002a710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a720: 2020 2020 2020 2020 2020 2066 2222 220a             f""".
-0002a730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a750: 4465 6275 6767 696e 6720 696e 666f 726d  Debugging inform
-0002a760: 6174 696f 6e0a 2020 2020 2020 2020 2020  ation.          
+0002a450: 2074 6773 5f77 6974 685f 6261 645f 7275   tgs_with_bad_ru
+0002a460: 6e5f 7370 6563 2e61 6464 2874 732e 6772  n_spec.add(ts.gr
+0002a470: 6f75 7029 0a20 2020 2020 2020 2020 2020  oup).           
+0002a480: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0002a490: 6765 722e 7761 726e 696e 6728 0a20 2020  ger.warning(.   
+0002a4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a4b0: 2020 2020 2020 2020 2066 2244 6574 6563           f"Detec
+0002a4c0: 7465 6420 6469 6666 6572 656e 7420 6072  ted different `r
+0002a4d0: 756e 5f73 7065 6360 2066 6f72 206b 6579  un_spec` for key
+0002a4e0: 207b 7473 2e6b 6579 2172 7d20 6265 7477   {ts.key!r} betw
+0002a4f0: 6565 6e20 220a 2020 2020 2020 2020 2020  een ".          
+0002a500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a510: 2020 2274 776f 2063 6f6e 7365 6375 7469    "two consecuti
+0002a520: 7665 2063 616c 6c73 2074 6f20 6075 7064  ve calls to `upd
+0002a530: 6174 655f 6772 6170 6860 2e20 220a 2020  ate_graph`. ".  
+0002a540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a550: 2020 2020 2020 2020 2020 2254 6869 7320            "This 
+0002a560: 6361 6e20 6361 7573 6520 6661 696c 7572  can cause failur
+0002a570: 6573 2061 6e64 2064 6561 646c 6f63 6b73  es and deadlocks
+0002a580: 2064 6f77 6e20 7468 6520 6c69 6e65 2e20   down the line. 
+0002a590: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002a5a0: 2020 2020 2020 2020 2020 2020 2020 2250                "P
+0002a5b0: 6c65 6173 6520 656e 7375 7265 2075 6e69  lease ensure uni
+0002a5c0: 7175 6520 6b65 7920 6e61 6d65 732e 2022  que key names. "
+0002a5d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a5e0: 2020 2020 2020 2020 2020 2020 2022 4966               "If
+0002a5f0: 2079 6f75 2061 7265 2075 7369 6e67 2061   you are using a
+0002a600: 2073 7461 6e64 6172 6420 6461 736b 2063   standard dask c
+0002a610: 6f6c 6c65 6374 696f 6e73 2c20 636f 6e73  ollections, cons
+0002a620: 6964 6572 2022 0a20 2020 2020 2020 2020  ider ".         
+0002a630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a640: 2020 2022 7265 6c65 6173 696e 6720 616c     "releasing al
+0002a650: 6c20 7468 6520 6461 7461 2062 6566 6f72  l the data befor
+0002a660: 6520 7265 7375 626d 6974 7469 6e67 2061  e resubmitting a
+0002a670: 6e6f 7468 6572 2022 0a20 2020 2020 2020  nother ".       
+0002a680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a690: 2020 2020 2022 636f 6d70 7574 6174 696f       "computatio
+0002a6a0: 6e2e 204d 6f72 6520 6465 7461 696c 7320  n. More details 
+0002a6b0: 616e 6420 6865 6c70 2063 616e 2062 6520  and help can be 
+0002a6c0: 666f 756e 6420 6174 2022 0a20 2020 2020  found at ".     
+0002a6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a6e0: 2020 2020 2020 2022 6874 7470 733a 2f2f         "https://
+0002a6f0: 6769 7468 7562 2e63 6f6d 2f64 6173 6b2f  github.com/dask/
+0002a700: 6461 736b 2f69 7373 7565 732f 3938 3838  dask/issues/9888
+0002a710: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+0002a720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a730: 2b20 7465 7874 7772 6170 2e64 6564 656e  + textwrap.deden
+0002a740: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0002a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a760: 2020 2066 2222 220a 2020 2020 2020 2020     f""".        
 0002a770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a780: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d        ----------
-0002a790: 2d2d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020  -----------.    
+0002a780: 2020 2020 2020 2020 4465 6275 6767 696e          Debuggin
+0002a790: 6720 696e 666f 726d 6174 696f 6e0a 2020  g information.  
 0002a7a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7b0: 2020 2020 2020 2020 2020 2020 6f6c 6420              old 
-0002a7c0: 7461 736b 2073 7461 7465 3a20 7b74 732e  task state: {ts.
-0002a7d0: 7374 6174 657d 0a20 2020 2020 2020 2020  state}.         
+0002a7b0: 2020 2020 2020 2020 2020 2020 2020 2d2d                --
+0002a7c0: 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d 2d2d  ----------------
+0002a7d0: 2d2d 2d0a 2020 2020 2020 2020 2020 2020  ---.            
 0002a7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a7f0: 2020 2020 2020 206f 6c64 2072 756e 5f73         old run_s
-0002a800: 7065 633a 207b 7473 2e72 756e 5f73 7065  pec: {ts.run_spe
-0002a810: 6321 727d 0a20 2020 2020 2020 2020 2020  c!r}.           
-0002a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a830: 2020 2020 206e 6577 2072 756e 5f73 7065       new run_spe
-0002a840: 633a 207b 6473 6b5b 6b5d 2172 7d0a 2020  c: {dsk[k]!r}.  
+0002a7f0: 2020 2020 6f6c 6420 7461 736b 2073 7461      old task sta
+0002a800: 7465 3a20 7b74 732e 7374 6174 657d 0a20  te: {ts.state}. 
+0002a810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a820: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0002a830: 6c64 2072 756e 5f73 7065 633a 207b 7473  ld run_spec: {ts
+0002a840: 2e72 756e 5f73 7065 6321 727d 0a20 2020  .run_spec!r}.   
 0002a850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a860: 2020 2020 2020 2020 2020 2020 2020 6f6c                ol
-0002a870: 6420 746f 6b65 6e3a 207b 6e6f 726d 616c  d token: {normal
-0002a880: 697a 655f 746f 6b65 6e28 7473 2e72 756e  ize_token(ts.run
-0002a890: 5f73 7065 6329 2172 7d0a 2020 2020 2020  _spec)!r}.      
-0002a8a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a8b0: 2020 2020 2020 2020 2020 6e65 7720 746f            new to
-0002a8c0: 6b65 6e3a 207b 6e6f 726d 616c 697a 655f  ken: {normalize_
-0002a8d0: 746f 6b65 6e28 6473 6b5b 6b5d 2921 727d  token(dsk[k])!r}
-0002a8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a900: 206f 6c64 2064 6570 656e 6465 6e63 6965   old dependencie
-0002a910: 733a 207b 6465 7073 5f6c 6873 7d0a 2020  s: {deps_lhs}.  
+0002a860: 2020 2020 2020 2020 2020 2020 206e 6577               new
+0002a870: 2072 756e 5f73 7065 633a 207b 6473 6b5b   run_spec: {dsk[
+0002a880: 6b5d 2172 7d0a 2020 2020 2020 2020 2020  k]!r}.          
+0002a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a8a0: 2020 2020 2020 6f6c 6420 746f 6b65 6e3a        old token:
+0002a8b0: 207b 6e6f 726d 616c 697a 655f 746f 6b65   {normalize_toke
+0002a8c0: 6e28 7473 2e72 756e 5f73 7065 6329 2172  n(ts.run_spec)!r
+0002a8d0: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
+0002a8e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a8f0: 2020 6e65 7720 746f 6b65 6e3a 207b 6e6f    new token: {no
+0002a900: 726d 616c 697a 655f 746f 6b65 6e28 6473  rmalize_token(ds
+0002a910: 6b5b 6b5d 2921 727d 0a20 2020 2020 2020  k[k])!r}.       
 0002a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a930: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
-0002a940: 7720 6465 7065 6e64 656e 6369 6573 3a20  w dependencies: 
-0002a950: 7b64 6570 735f 7268 737d 0a20 2020 2020  {deps_rhs}.     
+0002a930: 2020 2020 2020 2020 206f 6c64 2064 6570           old dep
+0002a940: 656e 6465 6e63 6965 733a 207b 6465 7073  endencies: {deps
+0002a950: 5f6c 6873 7d0a 2020 2020 2020 2020 2020  _lhs}.          
 0002a960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a970: 2020 2020 2020 2020 2020 2022 2222 0a20             """. 
-0002a980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a990: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0002a970: 2020 2020 2020 6e65 7720 6465 7065 6e64        new depend
+0002a980: 656e 6369 6573 3a20 7b64 6570 735f 7268  encies: {deps_rh
+0002a990: 737d 0a20 2020 2020 2020 2020 2020 2020  s}.             
 0002a9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002a9b0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0002a9c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0002a9d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002a9e0: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0002a9f0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-0002aa00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aa10: 2020 2066 2244 6574 6563 7465 6420 6469     f"Detected di
-0002aa20: 6666 6572 656e 7420 6072 756e 5f73 7065  fferent `run_spe
-0002aa30: 6360 2066 6f72 206b 6579 207b 7473 2e6b  c` for key {ts.k
-0002aa40: 6579 2172 7d20 6265 7477 6565 6e20 220a  ey!r} between ".
-0002aa50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002aa60: 2020 2020 2020 2020 2020 2020 2274 776f              "two
-0002aa70: 2063 6f6e 7365 6375 7469 7665 2063 616c   consecutive cal
-0002aa80: 6c73 2074 6f20 6075 7064 6174 655f 6772  ls to `update_gr
-0002aa90: 6170 6860 2e22 0a20 2020 2020 2020 2020  aph`.".         
-0002aaa0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0002aab0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0002aac0: 2074 732e 7275 6e5f 7370 6563 3a0a 2020   ts.run_spec:.  
-0002aad0: 2020 2020 2020 2020 2020 2020 2020 7275                ru
-0002aae0: 6e6e 6162 6c65 2e61 7070 656e 6428 7473  nnable.append(ts
-0002aaf0: 290a 2020 2020 2020 2020 2020 2020 746f  ).            to
-0002ab00: 7563 6865 645f 6b65 7973 2e61 6464 286b  uched_keys.add(k
-0002ab10: 290a 2020 2020 2020 2020 2020 2020 746f  ).            to
-0002ab20: 7563 6865 645f 7461 736b 732e 6170 7065  uched_tasks.appe
-0002ab30: 6e64 2874 7329 0a20 2020 2020 2020 2020  nd(ts).         
-0002ab40: 2020 2073 7461 636b 2e65 7874 656e 6428     stack.extend(
-0002ab50: 6465 7065 6e64 656e 6369 6573 2e67 6574  dependencies.get
-0002ab60: 286b 2c20 2829 2929 0a0a 2020 2020 2020  (k, ()))..      
-0002ab70: 2020 2320 4164 6420 6465 7065 6e64 656e    # Add dependen
-0002ab80: 6369 6573 0a20 2020 2020 2020 2066 6f72  cies.        for
-0002ab90: 206b 6579 2c20 6465 7073 2069 6e20 6465   key, deps in de
-0002aba0: 7065 6e64 656e 6369 6573 2e69 7465 6d73  pendencies.items
-0002abb0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-0002abc0: 7473 203d 2073 656c 662e 7461 736b 732e  ts = self.tasks.
-0002abd0: 6765 7428 6b65 7929 0a20 2020 2020 2020  get(key).       
-0002abe0: 2020 2020 2069 6620 7473 2069 7320 4e6f       if ts is No
-0002abf0: 6e65 206f 7220 7473 2e64 6570 656e 6465  ne or ts.depende
-0002ac00: 6e63 6965 733a 0a20 2020 2020 2020 2020  ncies:.         
-0002ac10: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
-0002ac20: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0002ac30: 6465 7020 696e 2064 6570 733a 0a20 2020  dep in deps:.   
-0002ac40: 2020 2020 2020 2020 2020 2020 2064 7473               dts
-0002ac50: 203d 2073 656c 662e 7461 736b 735b 6465   = self.tasks[de
-0002ac60: 705d 0a20 2020 2020 2020 2020 2020 2020  p].             
-0002ac70: 2020 2074 732e 6164 645f 6465 7065 6e64     ts.add_depend
-0002ac80: 656e 6379 2864 7473 290a 0a20 2020 2020  ency(dts)..     
-0002ac90: 2020 2069 6620 6c65 6e28 746f 7563 6865     if len(touche
-0002aca0: 645f 7461 736b 7329 203c 206c 656e 286b  d_tasks) < len(k
-0002acb0: 6579 7329 3a0a 2020 2020 2020 2020 2020  eys):.          
-0002acc0: 2020 6c6f 6767 6572 2e69 6e66 6f28 0a20    logger.info(. 
-0002acd0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002ace0: 5375 626d 6974 7465 6420 6772 6170 6820  Submitted graph 
-0002acf0: 7769 7468 206c 656e 6774 6820 2573 2062  with length %s b
-0002ad00: 7574 2072 6571 7565 7374 6564 2067 7261  ut requested gra
-0002ad10: 7068 206f 6e6c 7920 696e 636c 7564 6573  ph only includes
-0002ad20: 2025 7320 6b65 7973 222c 0a20 2020 2020   %s keys",.     
-0002ad30: 2020 2020 2020 2020 2020 206c 656e 2874             len(t
-0002ad40: 6f75 6368 6564 5f74 6173 6b73 292c 0a20  ouched_tasks),. 
-0002ad50: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-0002ad60: 656e 286b 6579 7329 2c0a 2020 2020 2020  en(keys),.      
-0002ad70: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-0002ad80: 7265 7475 726e 2072 756e 6e61 626c 652c  return runnable,
-0002ad90: 2074 6f75 6368 6564 5f74 6173 6b73 2c20   touched_tasks, 
-0002ada0: 6e65 775f 7461 736b 730a 0a20 2020 2064  new_tasks..    d
-0002adb0: 6566 205f 6170 706c 795f 616e 6e6f 7461  ef _apply_annota
-0002adc0: 7469 6f6e 7328 0a20 2020 2020 2020 2073  tions(.        s
-0002add0: 656c 662c 0a20 2020 2020 2020 2074 6173  elf,.        tas
-0002ade0: 6b73 3a20 4974 6572 6162 6c65 5b54 6173  ks: Iterable[Tas
-0002adf0: 6b53 7461 7465 5d2c 0a20 2020 2020 2020  kState],.       
-0002ae00: 2061 6e6e 6f74 6174 696f 6e73 5f62 795f   annotations_by_
-0002ae10: 7479 7065 3a20 6469 6374 5b73 7472 2c20  type: dict[str, 
-0002ae20: 6469 6374 5b4b 6579 2c20 416e 795d 5d2c  dict[Key, Any]],
-0002ae30: 0a20 2020 2029 202d 3e20 7365 745b 4b65  .    ) -> set[Ke
-0002ae40: 795d 3a0a 2020 2020 2020 2020 2222 2241  y]:.        """A
-0002ae50: 7070 6c79 2074 6865 2070 726f 7669 6465  pply the provide
-0002ae60: 6420 616e 6e6f 7461 7469 6f6e 7320 746f  d annotations to
-0002ae70: 2074 6865 2070 726f 7669 6465 6420 6054   the provided `T
-0002ae80: 6173 6b53 7461 7465 6020 6f62 6a65 6374  askState` object
-0002ae90: 732e 0a0a 2020 2020 2020 2020 5468 6520  s...        The 
-0002aea0: 7261 7720 616e 6e6f 7461 7469 6f6e 7320  raw annotations 
-0002aeb0: 7769 6c6c 2062 6520 7374 6f72 6564 2069  will be stored i
-0002aec0: 6e20 7468 6520 6061 6e6e 6f74 6174 696f  n the `annotatio
-0002aed0: 6e73 6020 6174 7472 6962 7574 652e 0a0a  ns` attribute...
-0002aee0: 2020 2020 2020 2020 4c61 7965 7220 2f20          Layer / 
-0002aef0: 6b65 7920 7370 6563 6966 6963 2061 6e6e  key specific ann
-0002af00: 6f74 6174 696f 6e73 2077 696c 6c20 7461  otations will ta
-0002af10: 6b65 2070 7265 6365 6465 6e63 6520 6f76  ke precedence ov
-0002af20: 6572 2067 6c6f 6261 6c20 2f20 6765 6e65  er global / gene
-0002af30: 7269 6320 616e 6e6f 7461 7469 6f6e 732e  ric annotations.
-0002af40: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-0002af50: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
-0002af60: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-0002af70: 7461 736b 7320 3a20 4974 6572 6162 6c65  tasks : Iterable
-0002af80: 5b54 6173 6b53 7461 7465 5d0a 2020 2020  [TaskState].    
-0002af90: 2020 2020 2020 2020 5f64 6573 6372 6970          _descrip
-0002afa0: 7469 6f6e 5f0a 2020 2020 2020 2020 616e  tion_.        an
-0002afb0: 6e6f 7461 7469 6f6e 7320 3a20 6469 6374  notations : dict
-0002afc0: 0a20 2020 2020 2020 2020 2020 205f 6465  .            _de
-0002afd0: 7363 7269 7074 696f 6e5f 0a0a 2020 2020  scription_..    
-0002afe0: 2020 2020 5265 7475 726e 730a 2020 2020      Returns.    
-0002aff0: 2020 2020 2d2d 2d2d 2d2d 2d0a 2020 2020      -------.    
-0002b000: 2020 2020 6b65 7973 5f77 6974 685f 616e      keys_with_an
-0002b010: 6e6f 7461 7469 6f6e 730a 2020 2020 2020  notations.      
-0002b020: 2020 2222 220a 2020 2020 2020 2020 6b65    """.        ke
-0002b030: 7973 5f77 6974 685f 616e 6e6f 7461 7469  ys_with_annotati
-0002b040: 6f6e 733a 2073 6574 5b4b 6579 5d20 3d20  ons: set[Key] = 
-0002b050: 7365 7428 290a 2020 2020 2020 2020 6966  set().        if
-0002b060: 206e 6f74 2061 6e6e 6f74 6174 696f 6e73   not annotations
-0002b070: 5f62 795f 7479 7065 3a0a 2020 2020 2020  _by_type:.      
-0002b080: 2020 2020 2020 7265 7475 726e 206b 6579        return key
-0002b090: 735f 7769 7468 5f61 6e6e 6f74 6174 696f  s_with_annotatio
-0002b0a0: 6e73 0a0a 2020 2020 2020 2020 666f 7220  ns..        for 
-0002b0b0: 7473 2069 6e20 7461 736b 733a 0a20 2020  ts in tasks:.   
-0002b0c0: 2020 2020 2020 2020 206b 6579 203d 2074           key = t
-0002b0d0: 732e 6b65 790a 0a20 2020 2020 2020 2020  s.key..         
-0002b0e0: 2020 2074 735f 616e 6e6f 7461 7469 6f6e     ts_annotation
-0002b0f0: 7320 3d20 7b7d 0a20 2020 2020 2020 2020  s = {}.         
-0002b100: 2020 2066 6f72 2061 6e6e 6f74 2c20 6b65     for annot, ke
-0002b110: 795f 7661 6c75 6520 696e 2061 6e6e 6f74  y_value in annot
-0002b120: 6174 696f 6e73 5f62 795f 7479 7065 2e69  ations_by_type.i
-0002b130: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
-0002b140: 2020 2020 2020 2020 6966 2028 7661 6c75          if (valu
-0002b150: 6520 3a3d 206b 6579 5f76 616c 7565 2e67  e := key_value.g
-0002b160: 6574 286b 6579 2929 2069 7320 6e6f 7420  et(key)) is not 
-0002b170: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0002b180: 2020 2020 2020 2020 2020 7473 5f61 6e6e            ts_ann
-0002b190: 6f74 6174 696f 6e73 5b61 6e6e 6f74 5d20  otations[annot] 
-0002b1a0: 3d20 7661 6c75 650a 2020 2020 2020 2020  = value.        
-0002b1b0: 2020 2020 6966 206e 6f74 2074 735f 616e      if not ts_an
-0002b1c0: 6e6f 7461 7469 6f6e 733a 0a20 2020 2020  notations:.     
-0002b1d0: 2020 2020 2020 2020 2020 2063 6f6e 7469             conti
-0002b1e0: 6e75 650a 2020 2020 2020 2020 2020 2020  nue.            
-0002b1f0: 6b65 7973 5f77 6974 685f 616e 6e6f 7461  keys_with_annota
-0002b200: 7469 6f6e 732e 6164 6428 6b65 7929 0a20  tions.add(key). 
-0002b210: 2020 2020 2020 2020 2020 2074 732e 616e             ts.an
-0002b220: 6e6f 7461 7469 6f6e 7320 3d20 7473 5f61  notations = ts_a
-0002b230: 6e6e 6f74 6174 696f 6e73 0a20 2020 2020  nnotations.     
-0002b240: 2020 2020 2020 2066 6f72 2061 6e6e 6f74         for annot
-0002b250: 2c20 7661 6c75 6520 696e 2074 735f 616e  , value in ts_an
-0002b260: 6e6f 7461 7469 6f6e 732e 6974 656d 7328  notations.items(
-0002b270: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0002b280: 2020 2069 6620 616e 6e6f 7420 696e 2028     if annot in (
-0002b290: 2272 6573 7472 6963 7469 6f6e 7322 2c20  "restrictions", 
-0002b2a0: 2277 6f72 6b65 7273 2229 3a0a 2020 2020  "workers"):.    
-0002b2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b2c0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-0002b2d0: 6528 7661 6c75 652c 2028 6c69 7374 2c20  e(value, (list, 
-0002b2e0: 7475 706c 652c 2073 6574 2929 3a0a 2020  tuple, set)):.  
-0002b2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b300: 2020 2020 2020 7661 6c75 6520 3d20 5b76        value = [v
-0002b310: 616c 7565 5d0a 2020 2020 2020 2020 2020  alue].          
-0002b320: 2020 2020 2020 2020 2020 686f 7374 5f72            host_r
-0002b330: 6573 7472 6963 7469 6f6e 7320 3d20 7365  estrictions = se
-0002b340: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0002b350: 2020 2020 2020 2020 776f 726b 6572 5f72          worker_r
-0002b360: 6573 7472 6963 7469 6f6e 7320 3d20 7365  estrictions = se
-0002b370: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
-0002b380: 2020 2020 2020 2020 666f 7220 7720 696e          for w in
-0002b390: 2076 616c 7565 3a0a 2020 2020 2020 2020   value:.        
-0002b3a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b3b0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0002b3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b3d0: 2077 203d 2073 656c 662e 636f 6572 6365   w = self.coerce
-0002b3e0: 5f61 6464 7265 7373 2877 290a 2020 2020  _address(w).    
+0002a9b0: 2020 2022 2222 0a20 2020 2020 2020 2020     """.         
+0002a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a9d0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0002a9e0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0002a9f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aa00: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0002aa10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aa20: 206c 6f67 6765 722e 6465 6275 6728 0a20   logger.debug(. 
+0002aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aa40: 2020 2020 2020 2020 2020 2066 2244 6574             f"Det
+0002aa50: 6563 7465 6420 6469 6666 6572 656e 7420  ected different 
+0002aa60: 6072 756e 5f73 7065 6360 2066 6f72 206b  `run_spec` for k
+0002aa70: 6579 207b 7473 2e6b 6579 2172 7d20 6265  ey {ts.key!r} be
+0002aa80: 7477 6565 6e20 220a 2020 2020 2020 2020  tween ".        
+0002aa90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aaa0: 2020 2020 2274 776f 2063 6f6e 7365 6375      "two consecu
+0002aab0: 7469 7665 2063 616c 6c73 2074 6f20 6075  tive calls to `u
+0002aac0: 7064 6174 655f 6772 6170 6860 2e22 0a20  pdate_graph`.". 
+0002aad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002aae0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0002aaf0: 2020 2020 2020 6966 2074 732e 7275 6e5f        if ts.run_
+0002ab00: 7370 6563 3a0a 2020 2020 2020 2020 2020  spec:.          
+0002ab10: 2020 2020 2020 7275 6e6e 6162 6c65 2e61        runnable.a
+0002ab20: 7070 656e 6428 7473 290a 2020 2020 2020  ppend(ts).      
+0002ab30: 2020 2020 2020 746f 7563 6865 645f 6b65        touched_ke
+0002ab40: 7973 2e61 6464 286b 290a 2020 2020 2020  ys.add(k).      
+0002ab50: 2020 2020 2020 746f 7563 6865 645f 7461        touched_ta
+0002ab60: 736b 732e 6170 7065 6e64 2874 7329 0a20  sks.append(ts). 
+0002ab70: 2020 2020 2020 2020 2020 2073 7461 636b             stack
+0002ab80: 2e65 7874 656e 6428 6465 7065 6e64 656e  .extend(dependen
+0002ab90: 6369 6573 2e67 6574 286b 2c20 2829 2929  cies.get(k, ()))
+0002aba0: 0a0a 2020 2020 2020 2020 2320 4164 6420  ..        # Add 
+0002abb0: 6465 7065 6e64 656e 6369 6573 0a20 2020  dependencies.   
+0002abc0: 2020 2020 2066 6f72 206b 6579 2c20 6465       for key, de
+0002abd0: 7073 2069 6e20 6465 7065 6e64 656e 6369  ps in dependenci
+0002abe0: 6573 2e69 7465 6d73 2829 3a0a 2020 2020  es.items():.    
+0002abf0: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
+0002ac00: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
+0002ac10: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002ac20: 7473 2069 7320 4e6f 6e65 206f 7220 7473  ts is None or ts
+0002ac30: 2e64 6570 656e 6465 6e63 6965 733a 0a20  .dependencies:. 
+0002ac40: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0002ac50: 6f6e 7469 6e75 650a 2020 2020 2020 2020  ontinue.        
+0002ac60: 2020 2020 666f 7220 6465 7020 696e 2064      for dep in d
+0002ac70: 6570 733a 0a20 2020 2020 2020 2020 2020  eps:.           
+0002ac80: 2020 2020 2064 7473 203d 2073 656c 662e       dts = self.
+0002ac90: 7461 736b 735b 6465 705d 0a20 2020 2020  tasks[dep].     
+0002aca0: 2020 2020 2020 2020 2020 2074 732e 6164             ts.ad
+0002acb0: 645f 6465 7065 6e64 656e 6379 2864 7473  d_dependency(dts
+0002acc0: 290a 0a20 2020 2020 2020 2069 6620 6c65  )..        if le
+0002acd0: 6e28 746f 7563 6865 645f 7461 736b 7329  n(touched_tasks)
+0002ace0: 203c 206c 656e 286b 6579 7329 3a0a 2020   < len(keys):.  
+0002acf0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0002ad00: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
+0002ad10: 2020 2020 2020 2022 5375 626d 6974 7465         "Submitte
+0002ad20: 6420 6772 6170 6820 7769 7468 206c 656e  d graph with len
+0002ad30: 6774 6820 2573 2062 7574 2072 6571 7565  gth %s but reque
+0002ad40: 7374 6564 2067 7261 7068 206f 6e6c 7920  sted graph only 
+0002ad50: 696e 636c 7564 6573 2025 7320 6b65 7973  includes %s keys
+0002ad60: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0002ad70: 2020 206c 656e 2874 6f75 6368 6564 5f74     len(touched_t
+0002ad80: 6173 6b73 292c 0a20 2020 2020 2020 2020  asks),.         
+0002ad90: 2020 2020 2020 206c 656e 286b 6579 7329         len(keys)
+0002ada0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0002adb0: 2020 2020 2020 2020 7265 7475 726e 2072          return r
+0002adc0: 756e 6e61 626c 652c 2074 6f75 6368 6564  unnable, touched
+0002add0: 5f74 6173 6b73 2c20 6e65 775f 7461 736b  _tasks, new_task
+0002ade0: 730a 0a20 2020 2064 6566 205f 6170 706c  s..    def _appl
+0002adf0: 795f 616e 6e6f 7461 7469 6f6e 7328 0a20  y_annotations(. 
+0002ae00: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0002ae10: 2020 2020 2074 6173 6b73 3a20 4974 6572       tasks: Iter
+0002ae20: 6162 6c65 5b54 6173 6b53 7461 7465 5d2c  able[TaskState],
+0002ae30: 0a20 2020 2020 2020 2061 6e6e 6f74 6174  .        annotat
+0002ae40: 696f 6e73 5f62 795f 7479 7065 3a20 6469  ions_by_type: di
+0002ae50: 6374 5b73 7472 2c20 6469 6374 5b4b 6579  ct[str, dict[Key
+0002ae60: 2c20 416e 795d 5d2c 0a20 2020 2029 202d  , Any]],.    ) -
+0002ae70: 3e20 7365 745b 4b65 795d 3a0a 2020 2020  > set[Key]:.    
+0002ae80: 2020 2020 2222 2241 7070 6c79 2074 6865      """Apply the
+0002ae90: 2070 726f 7669 6465 6420 616e 6e6f 7461   provided annota
+0002aea0: 7469 6f6e 7320 746f 2074 6865 2070 726f  tions to the pro
+0002aeb0: 7669 6465 6420 6054 6173 6b53 7461 7465  vided `TaskState
+0002aec0: 6020 6f62 6a65 6374 732e 0a0a 2020 2020  ` objects...    
+0002aed0: 2020 2020 5468 6520 7261 7720 616e 6e6f      The raw anno
+0002aee0: 7461 7469 6f6e 7320 7769 6c6c 2062 6520  tations will be 
+0002aef0: 7374 6f72 6564 2069 6e20 7468 6520 6061  stored in the `a
+0002af00: 6e6e 6f74 6174 696f 6e73 6020 6174 7472  nnotations` attr
+0002af10: 6962 7574 652e 0a0a 2020 2020 2020 2020  ibute...        
+0002af20: 4c61 7965 7220 2f20 6b65 7920 7370 6563  Layer / key spec
+0002af30: 6966 6963 2061 6e6e 6f74 6174 696f 6e73  ific annotations
+0002af40: 2077 696c 6c20 7461 6b65 2070 7265 6365   will take prece
+0002af50: 6465 6e63 6520 6f76 6572 2067 6c6f 6261  dence over globa
+0002af60: 6c20 2f20 6765 6e65 7269 6320 616e 6e6f  l / generic anno
+0002af70: 7461 7469 6f6e 732e 0a0a 2020 2020 2020  tations...      
+0002af80: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+0002af90: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
+0002afa0: 2020 2020 2020 2020 7461 736b 7320 3a20          tasks : 
+0002afb0: 4974 6572 6162 6c65 5b54 6173 6b53 7461  Iterable[TaskSta
+0002afc0: 7465 5d0a 2020 2020 2020 2020 2020 2020  te].            
+0002afd0: 5f64 6573 6372 6970 7469 6f6e 5f0a 2020  _description_.  
+0002afe0: 2020 2020 2020 616e 6e6f 7461 7469 6f6e        annotation
+0002aff0: 7320 3a20 6469 6374 0a20 2020 2020 2020  s : dict.       
+0002b000: 2020 2020 205f 6465 7363 7269 7074 696f       _descriptio
+0002b010: 6e5f 0a0a 2020 2020 2020 2020 5265 7475  n_..        Retu
+0002b020: 726e 730a 2020 2020 2020 2020 2d2d 2d2d  rns.        ----
+0002b030: 2d2d 2d0a 2020 2020 2020 2020 6b65 7973  ---.        keys
+0002b040: 5f77 6974 685f 616e 6e6f 7461 7469 6f6e  _with_annotation
+0002b050: 730a 2020 2020 2020 2020 2222 220a 2020  s.        """.  
+0002b060: 2020 2020 2020 6b65 7973 5f77 6974 685f        keys_with_
+0002b070: 616e 6e6f 7461 7469 6f6e 733a 2073 6574  annotations: set
+0002b080: 5b4b 6579 5d20 3d20 7365 7428 290a 2020  [Key] = set().  
+0002b090: 2020 2020 2020 6966 206e 6f74 2061 6e6e        if not ann
+0002b0a0: 6f74 6174 696f 6e73 5f62 795f 7479 7065  otations_by_type
+0002b0b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0002b0c0: 7475 726e 206b 6579 735f 7769 7468 5f61  turn keys_with_a
+0002b0d0: 6e6e 6f74 6174 696f 6e73 0a0a 2020 2020  nnotations..    
+0002b0e0: 2020 2020 666f 7220 7473 2069 6e20 7461      for ts in ta
+0002b0f0: 736b 733a 0a20 2020 2020 2020 2020 2020  sks:.           
+0002b100: 206b 6579 203d 2074 732e 6b65 790a 0a20   key = ts.key.. 
+0002b110: 2020 2020 2020 2020 2020 2074 735f 616e             ts_an
+0002b120: 6e6f 7461 7469 6f6e 7320 3d20 7b7d 0a20  notations = {}. 
+0002b130: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
+0002b140: 6e6e 6f74 2c20 6b65 795f 7661 6c75 6520  nnot, key_value 
+0002b150: 696e 2061 6e6e 6f74 6174 696f 6e73 5f62  in annotations_b
+0002b160: 795f 7479 7065 2e69 7465 6d73 2829 3a0a  y_type.items():.
+0002b170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b180: 6966 2028 7661 6c75 6520 3a3d 206b 6579  if (value := key
+0002b190: 5f76 616c 7565 2e67 6574 286b 6579 2929  _value.get(key))
+0002b1a0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0002b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b1c0: 2020 7473 5f61 6e6e 6f74 6174 696f 6e73    ts_annotations
+0002b1d0: 5b61 6e6e 6f74 5d20 3d20 7661 6c75 650a  [annot] = value.
+0002b1e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0002b1f0: 6f74 2074 735f 616e 6e6f 7461 7469 6f6e  ot ts_annotation
+0002b200: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002b210: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+0002b220: 2020 2020 2020 2020 6b65 7973 5f77 6974          keys_wit
+0002b230: 685f 616e 6e6f 7461 7469 6f6e 732e 6164  h_annotations.ad
+0002b240: 6428 6b65 7929 0a20 2020 2020 2020 2020  d(key).         
+0002b250: 2020 2074 732e 616e 6e6f 7461 7469 6f6e     ts.annotation
+0002b260: 7320 3d20 7473 5f61 6e6e 6f74 6174 696f  s = ts_annotatio
+0002b270: 6e73 0a20 2020 2020 2020 2020 2020 2066  ns.            f
+0002b280: 6f72 2061 6e6e 6f74 2c20 7661 6c75 6520  or annot, value 
+0002b290: 696e 2074 735f 616e 6e6f 7461 7469 6f6e  in ts_annotation
+0002b2a0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
+0002b2b0: 2020 2020 2020 2020 2020 2069 6620 616e             if an
+0002b2c0: 6e6f 7420 696e 2028 2272 6573 7472 6963  not in ("restric
+0002b2d0: 7469 6f6e 7322 2c20 2277 6f72 6b65 7273  tions", "workers
+0002b2e0: 2229 3a0a 2020 2020 2020 2020 2020 2020  "):.            
+0002b2f0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
+0002b300: 7369 6e73 7461 6e63 6528 7661 6c75 652c  sinstance(value,
+0002b310: 2028 6c69 7374 2c20 7475 706c 652c 2073   (list, tuple, s
+0002b320: 6574 2929 3a0a 2020 2020 2020 2020 2020  et)):.          
+0002b330: 2020 2020 2020 2020 2020 2020 2020 7661                va
+0002b340: 6c75 6520 3d20 5b76 616c 7565 5d0a 2020  lue = [value].  
+0002b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b360: 2020 686f 7374 5f72 6573 7472 6963 7469    host_restricti
+0002b370: 6f6e 7320 3d20 7365 7428 290a 2020 2020  ons = set().    
+0002b380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b390: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
+0002b3a0: 6f6e 7320 3d20 7365 7428 290a 2020 2020  ons = set().    
+0002b3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3c0: 666f 7220 7720 696e 2076 616c 7565 3a0a  for w in value:.
+0002b3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b3e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
 0002b3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b400: 2020 2020 6578 6365 7074 2056 616c 7565      except Value
-0002b410: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-0002b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b430: 2020 2023 204e 6f74 2061 2076 616c 6964     # Not a valid
-0002b440: 2061 6464 7265 7373 2c20 6275 7420 7065   address, but pe
-0002b450: 7268 6170 7320 6974 2773 2061 2068 6f73  rhaps it's a hos
-0002b460: 746e 616d 650a 2020 2020 2020 2020 2020  tname.          
-0002b470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b480: 2020 686f 7374 5f72 6573 7472 6963 7469    host_restricti
-0002b490: 6f6e 732e 6164 6428 7729 0a20 2020 2020  ons.add(w).     
+0002b400: 2020 2020 2020 2020 2077 203d 2073 656c           w = sel
+0002b410: 662e 636f 6572 6365 5f61 6464 7265 7373  f.coerce_address
+0002b420: 2877 290a 2020 2020 2020 2020 2020 2020  (w).            
+0002b430: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0002b440: 7074 2056 616c 7565 4572 726f 723a 0a20  pt ValueError:. 
+0002b450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b460: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
+0002b470: 2061 2076 616c 6964 2061 6464 7265 7373   a valid address
+0002b480: 2c20 6275 7420 7065 7268 6170 7320 6974  , but perhaps it
+0002b490: 2773 2061 2068 6f73 746e 616d 650a 2020  's a hostname.  
 0002b4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0002b4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b4d0: 2020 2020 2077 6f72 6b65 725f 7265 7374       worker_rest
-0002b4e0: 7269 6374 696f 6e73 2e61 6464 2877 290a  rictions.add(w).
-0002b4f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b500: 2020 2020 6966 2068 6f73 745f 7265 7374      if host_rest
-0002b510: 7269 6374 696f 6e73 3a0a 2020 2020 2020  rictions:.      
-0002b520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b530: 2020 7473 2e68 6f73 745f 7265 7374 7269    ts.host_restri
-0002b540: 6374 696f 6e73 203d 2068 6f73 745f 7265  ctions = host_re
-0002b550: 7374 7269 6374 696f 6e73 0a20 2020 2020  strictions.     
-0002b560: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0002b570: 6620 776f 726b 6572 5f72 6573 7472 6963  f worker_restric
-0002b580: 7469 6f6e 733a 0a20 2020 2020 2020 2020  tions:.         
-0002b590: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002b5a0: 732e 776f 726b 6572 5f72 6573 7472 6963  s.worker_restric
-0002b5b0: 7469 6f6e 7320 3d20 776f 726b 6572 5f72  tions = worker_r
-0002b5c0: 6573 7472 6963 7469 6f6e 730a 2020 2020  estrictions.    
-0002b5d0: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-0002b5e0: 2061 6e6e 6f74 2069 6e20 2822 6c6f 6f73   annot in ("loos
-0002b5f0: 655f 7265 7374 7269 6374 696f 6e73 222c  e_restrictions",
-0002b600: 2022 616c 6c6f 775f 6f74 6865 725f 776f   "allow_other_wo
-0002b610: 726b 6572 7322 293a 0a20 2020 2020 2020  rkers"):.       
-0002b620: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-0002b630: 6c6f 6f73 655f 7265 7374 7269 6374 696f  loose_restrictio
-0002b640: 6e73 203d 2076 616c 7565 0a20 2020 2020  ns = value.     
-0002b650: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0002b660: 616e 6e6f 7420 3d3d 2022 7265 736f 7572  annot == "resour
-0002b670: 6365 7322 3a0a 2020 2020 2020 2020 2020  ces":.          
-0002b680: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0002b690: 2069 7369 6e73 7461 6e63 6528 7661 6c75   isinstance(valu
-0002b6a0: 652c 2064 6963 7429 0a20 2020 2020 2020  e, dict).       
-0002b6b0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
-0002b6c0: 7265 736f 7572 6365 5f72 6573 7472 6963  resource_restric
-0002b6d0: 7469 6f6e 7320 3d20 7661 6c75 650a 2020  tions = value.  
-0002b6e0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0002b6f0: 6966 2061 6e6e 6f74 203d 3d20 2270 7269  if annot == "pri
-0002b700: 6f72 6974 7922 3a0a 2020 2020 2020 2020  ority":.        
-0002b710: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
-0002b720: 6520 5363 6865 6475 6c65 722e 5f73 6574  e Scheduler._set
-0002b730: 5f70 7269 6f72 6974 6965 730a 2020 2020  _priorities.    
+0002b4b0: 2020 2020 2020 2020 2020 686f 7374 5f72            host_r
+0002b4c0: 6573 7472 6963 7469 6f6e 732e 6164 6428  estrictions.add(
+0002b4d0: 7729 0a20 2020 2020 2020 2020 2020 2020  w).             
+0002b4e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0002b4f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b500: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+0002b510: 6b65 725f 7265 7374 7269 6374 696f 6e73  ker_restrictions
+0002b520: 2e61 6464 2877 290a 2020 2020 2020 2020  .add(w).        
+0002b530: 2020 2020 2020 2020 2020 2020 6966 2068              if h
+0002b540: 6f73 745f 7265 7374 7269 6374 696f 6e73  ost_restrictions
+0002b550: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002b560: 2020 2020 2020 2020 2020 7473 2e68 6f73            ts.hos
+0002b570: 745f 7265 7374 7269 6374 696f 6e73 203d  t_restrictions =
+0002b580: 2068 6f73 745f 7265 7374 7269 6374 696f   host_restrictio
+0002b590: 6e73 0a20 2020 2020 2020 2020 2020 2020  ns.             
+0002b5a0: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
+0002b5b0: 5f72 6573 7472 6963 7469 6f6e 733a 0a20  _restrictions:. 
+0002b5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b5d0: 2020 2020 2020 2074 732e 776f 726b 6572         ts.worker
+0002b5e0: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
+0002b5f0: 776f 726b 6572 5f72 6573 7472 6963 7469  worker_restricti
+0002b600: 6f6e 730a 2020 2020 2020 2020 2020 2020  ons.            
+0002b610: 2020 2020 656c 6966 2061 6e6e 6f74 2069      elif annot i
+0002b620: 6e20 2822 6c6f 6f73 655f 7265 7374 7269  n ("loose_restri
+0002b630: 6374 696f 6e73 222c 2022 616c 6c6f 775f  ctions", "allow_
+0002b640: 6f74 6865 725f 776f 726b 6572 7322 293a  other_workers"):
+0002b650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b660: 2020 2020 2074 732e 6c6f 6f73 655f 7265       ts.loose_re
+0002b670: 7374 7269 6374 696f 6e73 203d 2076 616c  strictions = val
+0002b680: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+0002b690: 2020 2065 6c69 6620 616e 6e6f 7420 3d3d     elif annot ==
+0002b6a0: 2022 7265 736f 7572 6365 7322 3a0a 2020   "resources":.  
+0002b6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b6c0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+0002b6d0: 6e63 6528 7661 6c75 652c 2064 6963 7429  nce(value, dict)
+0002b6e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b6f0: 2020 2020 2074 732e 7265 736f 7572 6365       ts.resource
+0002b700: 5f72 6573 7472 6963 7469 6f6e 7320 3d20  _restrictions = 
+0002b710: 7661 6c75 650a 2020 2020 2020 2020 2020  value.          
+0002b720: 2020 2020 2020 656c 6966 2061 6e6e 6f74        elif annot
+0002b730: 203d 3d20 2270 7269 6f72 6974 7922 3a0a   == "priority":.
 0002b740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002b750: 636f 6e74 696e 7565 0a20 2020 2020 2020  continue.       
-0002b760: 2020 2020 2020 2020 2065 6c69 6620 616e           elif an
-0002b770: 6e6f 7420 3d3d 2022 7265 7472 6965 7322  not == "retries"
-0002b780: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002b790: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-0002b7a0: 6e73 7461 6e63 6528 7661 6c75 652c 2069  nstance(value, i
-0002b7b0: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-0002b7c0: 2020 2020 2020 2020 7473 2e72 6574 7269          ts.retri
-0002b7d0: 6573 203d 2076 616c 7565 0a20 2020 2020  es = value.     
-0002b7e0: 2020 2072 6574 7572 6e20 6b65 7973 5f77     return keys_w
-0002b7f0: 6974 685f 616e 6e6f 7461 7469 6f6e 730a  ith_annotations.
-0002b800: 0a20 2020 2064 6566 205f 7365 745f 7072  .    def _set_pr
-0002b810: 696f 7269 7469 6573 280a 2020 2020 2020  iorities(.      
-0002b820: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0002b830: 696e 7465 726e 616c 5f70 7269 6f72 6974  internal_priorit
-0002b840: 793a 2064 6963 745b 4b65 792c 2069 6e74  y: dict[Key, int
-0002b850: 5d2c 0a20 2020 2020 2020 2073 7562 6d69  ],.        submi
-0002b860: 7474 696e 675f 7461 736b 3a20 4b65 7920  tting_task: Key 
-0002b870: 7c20 4e6f 6e65 2c0a 2020 2020 2020 2020  | None,.        
-0002b880: 7573 6572 5f70 7269 6f72 6974 793a 2069  user_priority: i
-0002b890: 6e74 207c 2064 6963 745b 4b65 792c 2069  nt | dict[Key, i
-0002b8a0: 6e74 5d2c 0a20 2020 2020 2020 2066 6966  nt],.        fif
-0002b8b0: 6f5f 7469 6d65 6f75 743a 2069 6e74 207c  o_timeout: int |
-0002b8c0: 2066 6c6f 6174 207c 2073 7472 2c0a 2020   float | str,.  
-0002b8d0: 2020 2020 2020 7374 6172 743a 2066 6c6f        start: flo
-0002b8e0: 6174 2c0a 2020 2020 2020 2020 7461 736b  at,.        task
-0002b8f0: 733a 206c 6973 745b 5461 736b 5374 6174  s: list[TaskStat
-0002b900: 655d 2c0a 2020 2020 2920 2d3e 204e 6f6e  e],.    ) -> Non
-0002b910: 653a 0a20 2020 2020 2020 2066 6966 6f5f  e:.        fifo_
-0002b920: 7469 6d65 6f75 7420 3d20 7061 7273 655f  timeout = parse_
-0002b930: 7469 6d65 6465 6c74 6128 6669 666f 5f74  timedelta(fifo_t
-0002b940: 696d 656f 7574 290a 2020 2020 2020 2020  imeout).        
-0002b950: 6966 2073 7562 6d69 7474 696e 675f 7461  if submitting_ta
-0002b960: 736b 3a20 2023 2073 7562 2d74 6173 6b73  sk:  # sub-tasks
-0002b970: 2067 6574 2062 6574 7465 7220 7072 696f   get better prio
-0002b980: 7269 7479 2074 6861 6e20 7061 7265 6e74  rity than parent
-0002b990: 2074 6173 6b73 0a20 2020 2020 2020 2020   tasks.         
-0002b9a0: 2020 2073 7473 203d 2073 656c 662e 7461     sts = self.ta
-0002b9b0: 736b 732e 6765 7428 7375 626d 6974 7469  sks.get(submitti
-0002b9c0: 6e67 5f74 6173 6b29 0a20 2020 2020 2020  ng_task).       
-0002b9d0: 2020 2020 2069 6620 7374 7320 6973 206e       if sts is n
-0002b9e0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-0002b9f0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0002ba00: 7374 732e 7072 696f 7269 7479 0a20 2020  sts.priority.   
-0002ba10: 2020 2020 2020 2020 2020 2020 2067 656e               gen
-0002ba20: 6572 6174 696f 6e20 3d20 7374 732e 7072  eration = sts.pr
-0002ba30: 696f 7269 7479 5b30 5d20 2d20 302e 3031  iority[0] - 0.01
-0002ba40: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0002ba50: 653a 2020 2320 7375 7065 722d 7461 736b  e:  # super-task
-0002ba60: 2061 6c72 6561 6479 2063 6c65 616e 6564   already cleaned
-0002ba70: 2075 700a 2020 2020 2020 2020 2020 2020   up.            
-0002ba80: 2020 2020 6765 6e65 7261 7469 6f6e 203d      generation =
-0002ba90: 2073 656c 662e 6765 6e65 7261 7469 6f6e   self.generation
-0002baa0: 0a20 2020 2020 2020 2065 6c69 6620 7365  .        elif se
-0002bab0: 6c66 2e5f 6c61 7374 5f74 696d 6520 2b20  lf._last_time + 
-0002bac0: 6669 666f 5f74 696d 656f 7574 203c 2073  fifo_timeout < s
-0002bad0: 7461 7274 3a0a 2020 2020 2020 2020 2020  tart:.          
-0002bae0: 2020 7365 6c66 2e67 656e 6572 6174 696f    self.generatio
-0002baf0: 6e20 2b3d 2031 2020 2320 6f6c 6465 7220  n += 1  # older 
-0002bb00: 6772 6170 6820 6765 6e65 7261 7469 6f6e  graph generation
-0002bb10: 7320 7461 6b65 2070 7265 6365 6465 6e63  s take precedenc
-0002bb20: 650a 2020 2020 2020 2020 2020 2020 6765  e.            ge
-0002bb30: 6e65 7261 7469 6f6e 203d 2073 656c 662e  neration = self.
-0002bb40: 6765 6e65 7261 7469 6f6e 0a20 2020 2020  generation.     
-0002bb50: 2020 2020 2020 2073 656c 662e 5f6c 6173         self._las
-0002bb60: 745f 7469 6d65 203d 2073 7461 7274 0a20  t_time = start. 
-0002bb70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002bb80: 2020 2020 2020 2020 2067 656e 6572 6174           generat
-0002bb90: 696f 6e20 3d20 7365 6c66 2e67 656e 6572  ion = self.gener
-0002bba0: 6174 696f 6e0a 0a20 2020 2020 2020 2066  ation..        f
-0002bbb0: 6f72 2074 7320 696e 2074 6173 6b73 3a0a  or ts in tasks:.
-0002bbc0: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0002bbd0: 7369 6e73 7461 6e63 6528 7573 6572 5f70  sinstance(user_p
-0002bbe0: 7269 6f72 6974 792c 2064 6963 7429 3a0a  riority, dict):.
-0002bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bc00: 7461 736b 5f75 7365 725f 7072 696f 203d  task_user_prio =
-0002bc10: 2075 7365 725f 7072 696f 7269 7479 2e67   user_priority.g
-0002bc20: 6574 2874 732e 6b65 792c 2030 290a 2020  et(ts.key, 0).  
-0002bc30: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0002bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002bc50: 7461 736b 5f75 7365 725f 7072 696f 203d  task_user_prio =
-0002bc60: 2075 7365 725f 7072 696f 7269 7479 0a20   user_priority. 
-0002bc70: 2020 2020 2020 2020 2020 2023 2041 6e6e             # Ann
-0002bc80: 6f74 6174 696f 6e73 2074 6861 7420 6172  otations that ar
-0002bc90: 6520 616c 7265 6164 7920 6173 7369 676e  e already assign
-0002bca0: 6564 2074 6f20 7468 6520 5461 736b 5374  ed to the TaskSt
-0002bcb0: 6174 6520 6f62 6a65 6374 0a20 2020 2020  ate object.     
-0002bcc0: 2020 2020 2020 2023 206f 7269 6769 6e61         # origina
-0002bcd0: 7465 2066 726f 6d20 6120 4c61 7965 7220  te from a Layer 
-0002bce0: 616e 6e6f 7461 7469 6f6e 2077 6869 6368  annotation which
-0002bcf0: 2074 616b 6573 2070 7265 6365 6465 6e63   takes precedenc
-0002bd00: 6520 6f76 6572 2074 6865 0a20 2020 2020  e over the.     
-0002bd10: 2020 2020 2020 2023 2067 6c6f 6261 6c20         # global 
-0002bd20: 616e 6e6f 7461 7469 6f6e 2e0a 2020 2020  annotation..    
-0002bd30: 2020 2020 2020 2020 6966 2074 732e 616e          if ts.an
-0002bd40: 6e6f 7461 7469 6f6e 733a 0a20 2020 2020  notations:.     
-0002bd50: 2020 2020 2020 2020 2020 2061 6e6e 6f74             annot
-0002bd60: 6174 6564 5f70 7269 6f20 3d20 7473 2e61  ated_prio = ts.a
-0002bd70: 6e6e 6f74 6174 696f 6e73 2e67 6574 2822  nnotations.get("
-0002bd80: 7072 696f 7269 7479 222c 2074 6173 6b5f  priority", task_
-0002bd90: 7573 6572 5f70 7269 6f29 0a20 2020 2020  user_prio).     
-0002bda0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0002bdb0: 2020 2020 2020 2020 2020 2020 2061 6e6e               ann
-0002bdc0: 6f74 6174 6564 5f70 7269 6f20 3d20 7461  otated_prio = ta
-0002bdd0: 736b 5f75 7365 725f 7072 696f 0a0a 2020  sk_user_prio..  
-0002bde0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0002bdf0: 2074 732e 7072 696f 7269 7479 2061 6e64   ts.priority and
-0002be00: 2074 732e 6b65 7920 696e 2069 6e74 6572   ts.key in inter
-0002be10: 6e61 6c5f 7072 696f 7269 7479 3a0a 2020  nal_priority:.  
-0002be20: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-0002be30: 2e70 7269 6f72 6974 7920 3d20 280a 2020  .priority = (.  
-0002be40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002be50: 2020 2d61 6e6e 6f74 6174 6564 5f70 7269    -annotated_pri
-0002be60: 6f2c 0a20 2020 2020 2020 2020 2020 2020  o,.             
-0002be70: 2020 2020 2020 2067 656e 6572 6174 696f         generatio
-0002be80: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
-0002be90: 2020 2020 2020 2069 6e74 6572 6e61 6c5f         internal_
-0002bea0: 7072 696f 7269 7479 5b74 732e 6b65 795d  priority[ts.key]
-0002beb0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002bec0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-0002bed0: 2069 6620 7365 6c66 2e76 616c 6964 6174   if self.validat
-0002bee0: 6520 616e 6420 7473 2e72 756e 5f73 7065  e and ts.run_spe
-0002bef0: 633a 0a20 2020 2020 2020 2020 2020 2020  c:.             
-0002bf00: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-0002bf10: 616e 6365 2874 732e 7072 696f 7269 7479  ance(ts.priority
-0002bf20: 2c20 7475 706c 6529 2061 6e64 2061 6c6c  , tuple) and all
-0002bf30: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0002bf40: 2020 2020 2020 6973 696e 7374 616e 6365        isinstance
-0002bf50: 2865 6c2c 2028 696e 742c 2066 6c6f 6174  (el, (int, float
-0002bf60: 2929 2066 6f72 2065 6c20 696e 2074 732e  )) for el in ts.
-0002bf70: 7072 696f 7269 7479 0a20 2020 2020 2020  priority.       
-0002bf80: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0002bf90: 6465 6620 7374 696d 756c 7573 5f71 7565  def stimulus_que
-0002bfa0: 7565 5f73 6c6f 7473 5f6d 6179 6265 5f6f  ue_slots_maybe_o
-0002bfb0: 7065 6e65 6428 7365 6c66 2c20 2a2c 2073  pened(self, *, s
-0002bfc0: 7469 6d75 6c75 735f 6964 3a20 7374 7229  timulus_id: str)
-0002bfd0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0002bfe0: 2020 2222 2252 6573 706f 6e64 2074 6f20    """Respond to 
-0002bff0: 616e 2065 7665 6e74 2077 6869 6368 206d  an event which m
-0002c000: 6179 2068 6176 6520 6f70 656e 6564 2073  ay have opened s
-0002c010: 706f 7473 206f 6e20 776f 726b 6572 2074  pots on worker t
-0002c020: 6872 6561 6470 6f6f 6c73 0a0a 2020 2020  hreadpools..    
-0002c030: 2020 2020 5365 6c65 6374 7320 7468 6520      Selects the 
-0002c040: 6170 7072 6f70 7269 6174 6520 6e75 6d62  appropriate numb
-0002c050: 6572 206f 6620 7461 736b 7320 6672 6f6d  er of tasks from
-0002c060: 2074 6865 2066 726f 6e74 206f 6620 7468   the front of th
-0002c070: 6520 7175 6575 6520 6163 636f 7264 696e  e queue accordin
-0002c080: 6720 746f 0a20 2020 2020 2020 2074 6865  g to.        the
-0002c090: 2074 6f74 616c 206e 756d 6265 7220 6f66   total number of
-0002c0a0: 2074 6173 6b20 736c 6f74 7320 6176 6169   task slots avai
-0002c0b0: 6c61 626c 6520 6f6e 2077 6f72 6b65 7273  lable on workers
-0002c0c0: 2028 706f 7465 6e74 6961 6c6c 7920 3029   (potentially 0)
-0002c0d0: 2c20 616e 640a 2020 2020 2020 2020 7472  , and.        tr
-0002c0e0: 616e 7369 7469 6f6e 7320 7468 656d 2074  ansitions them t
-0002c0f0: 6f20 6060 7072 6f63 6573 7369 6e67 6060  o ``processing``
-0002c100: 2e0a 0a20 2020 2020 2020 204e 6f74 6573  ...        Notes
-0002c110: 0a20 2020 2020 2020 202d 2d2d 2d2d 0a20  .        -----. 
-0002c120: 2020 2020 2020 204f 7468 6572 2074 7261         Other tra
-0002c130: 6e73 6974 696f 6e73 2072 656c 6174 6564  nsitions related
-0002c140: 2074 6f20 7468 6973 2073 7469 6d75 6c75   to this stimulu
-0002c150: 7320 7368 6f75 6c64 2062 6520 6675 6c6c  s should be full
-0002c160: 7920 7072 6f63 6573 7365 6420 6265 666f  y processed befo
-0002c170: 7265 6861 6e64 2c0a 2020 2020 2020 2020  rehand,.        
-0002c180: 736f 2061 6e79 2074 6173 6b73 2074 6861  so any tasks tha
-0002c190: 7420 6265 6361 6d65 2072 756e 6e61 626c  t became runnabl
-0002c1a0: 6520 6172 6520 616c 7265 6164 7920 696e  e are already in
-0002c1b0: 2060 6070 726f 6365 7373 696e 6760 602e   ``processing``.
-0002c1c0: 204f 7468 6572 7769 7365 2c0a 2020 2020   Otherwise,.    
-0002c1d0: 2020 2020 6f76 6572 7072 6f64 7563 7469      overproducti
-0002c1e0: 6f6e 2063 616e 206f 6363 7572 2069 6620  on can occur if 
-0002c1f0: 7175 6575 6564 2074 6173 6b73 2067 6574  queued tasks get
-0002c200: 2073 6368 6564 756c 6564 2062 6566 6f72   scheduled befor
-0002c210: 6520 646f 776e 7374 7265 616d 2074 6173  e downstream tas
-0002c220: 6b73 2e0a 0a20 2020 2020 2020 204d 7573  ks...        Mus
-0002c230: 7420 6265 2063 616c 6c65 6420 6166 7465  t be called afte
-0002c240: 7220 6063 6865 636b 5f69 646c 655f 7361  r `check_idle_sa
-0002c250: 7475 7261 7465 6460 3b20 692e 652e 2060  turated`; i.e. `
-0002c260: 6964 6c65 5f74 6173 6b5f 636f 756e 7460  idle_task_count`
-0002c270: 206d 7573 7420 6265 2075 7020 746f 2064   must be up to d
-0002c280: 6174 652e 0a20 2020 2020 2020 2022 2222  ate..        """
-0002c290: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-0002c2a0: 7365 6c66 2e71 7565 7565 643a 0a20 2020  self.queued:.   
-0002c2b0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-0002c2c0: 2020 2020 2020 2020 736c 6f74 735f 6176          slots_av
-0002c2d0: 6169 6c61 626c 6520 3d20 7375 6d28 0a20  ailable = sum(. 
-0002c2e0: 2020 2020 2020 2020 2020 205f 7461 736b             _task
-0002c2f0: 5f73 6c6f 7473 5f61 7661 696c 6162 6c65  _slots_available
-0002c300: 2877 732c 2073 656c 662e 574f 524b 4552  (ws, self.WORKER
-0002c310: 5f53 4154 5552 4154 494f 4e29 0a20 2020  _SATURATION).   
-0002c320: 2020 2020 2020 2020 2066 6f72 2077 7320           for ws 
-0002c330: 696e 2073 656c 662e 6964 6c65 5f74 6173  in self.idle_tas
-0002c340: 6b5f 636f 756e 740a 2020 2020 2020 2020  k_count.        
-0002c350: 290a 2020 2020 2020 2020 6966 2073 6c6f  ).        if slo
-0002c360: 7473 5f61 7661 696c 6162 6c65 203d 3d20  ts_available == 
-0002c370: 303a 0a20 2020 2020 2020 2020 2020 2072  0:.            r
-0002c380: 6574 7572 6e0a 0a20 2020 2020 2020 2066  eturn..        f
-0002c390: 6f72 205f 2069 6e20 7261 6e67 6528 736c  or _ in range(sl
-0002c3a0: 6f74 735f 6176 6169 6c61 626c 6529 3a0a  ots_available):.
-0002c3b0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-0002c3c0: 6f74 2073 656c 662e 7175 6575 6564 3a0a  ot self.queued:.
-0002c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002c3e0: 7265 7475 726e 0a20 2020 2020 2020 2020  return.         
-0002c3f0: 2020 2023 2049 6465 616c 6c79 2c20 7765     # Ideally, we
-0002c400: 2764 2062 6520 706f 7070 696e 6720 6974  'd be popping it
-0002c410: 2068 6572 6520 616c 7265 6164 7920 6275   here already bu
-0002c420: 7420 7468 6973 2077 6f75 6c64 2062 7265  t this would bre
-0002c430: 616b 0a20 2020 2020 2020 2020 2020 2023  ak.            #
-0002c440: 2063 6572 7461 696e 2073 7461 7465 2069   certain state i
-0002c450: 6e76 6172 6961 6e74 7320 7369 6e63 6520  nvariants since 
-0002c460: 7468 6520 7461 736b 2069 7320 6e6f 7420  the task is not 
-0002c470: 7472 616e 7369 7469 6f6e 6564 2c20 7965  transitioned, ye
-0002c480: 740a 2020 2020 2020 2020 2020 2020 7174  t.            qt
-0002c490: 7320 3d20 7365 6c66 2e71 7565 7565 642e  s = self.queued.
-0002c4a0: 7065 656b 2829 0a20 2020 2020 2020 2020  peek().         
-0002c4b0: 2020 2069 6620 7365 6c66 2e76 616c 6964     if self.valid
-0002c4c0: 6174 653a 0a20 2020 2020 2020 2020 2020  ate:.           
-0002c4d0: 2020 2020 2061 7373 6572 7420 7174 732e       assert qts.
-0002c4e0: 7374 6174 6520 3d3d 2022 7175 6575 6564  state == "queued
-0002c4f0: 222c 2071 7473 2e73 7461 7465 0a20 2020  ", qts.state.   
+0002b750: 2020 2020 2320 5365 6520 5363 6865 6475      # See Schedu
+0002b760: 6c65 722e 5f73 6574 5f70 7269 6f72 6974  ler._set_priorit
+0002b770: 6965 730a 2020 2020 2020 2020 2020 2020  ies.            
+0002b780: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
+0002b790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002b7a0: 2065 6c69 6620 616e 6e6f 7420 3d3d 2022   elif annot == "
+0002b7b0: 7265 7472 6965 7322 3a0a 2020 2020 2020  retries":.      
+0002b7c0: 2020 2020 2020 2020 2020 2020 2020 6173                as
+0002b7d0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+0002b7e0: 7661 6c75 652c 2069 6e74 290a 2020 2020  value, int).    
+0002b7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002b800: 7473 2e72 6574 7269 6573 203d 2076 616c  ts.retries = val
+0002b810: 7565 0a20 2020 2020 2020 2072 6574 7572  ue.        retur
+0002b820: 6e20 6b65 7973 5f77 6974 685f 616e 6e6f  n keys_with_anno
+0002b830: 7461 7469 6f6e 730a 0a20 2020 2064 6566  tations..    def
+0002b840: 205f 7365 745f 7072 696f 7269 7469 6573   _set_priorities
+0002b850: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0002b860: 2020 2020 2020 2020 696e 7465 726e 616c          internal
+0002b870: 5f70 7269 6f72 6974 793a 2064 6963 745b  _priority: dict[
+0002b880: 4b65 792c 2069 6e74 5d2c 0a20 2020 2020  Key, int],.     
+0002b890: 2020 2073 7562 6d69 7474 696e 675f 7461     submitting_ta
+0002b8a0: 736b 3a20 4b65 7920 7c20 4e6f 6e65 2c0a  sk: Key | None,.
+0002b8b0: 2020 2020 2020 2020 7573 6572 5f70 7269          user_pri
+0002b8c0: 6f72 6974 793a 2069 6e74 207c 2064 6963  ority: int | dic
+0002b8d0: 745b 4b65 792c 2069 6e74 5d2c 0a20 2020  t[Key, int],.   
+0002b8e0: 2020 2020 2066 6966 6f5f 7469 6d65 6f75       fifo_timeou
+0002b8f0: 743a 2069 6e74 207c 2066 6c6f 6174 207c  t: int | float |
+0002b900: 2073 7472 2c0a 2020 2020 2020 2020 7374   str,.        st
+0002b910: 6172 743a 2066 6c6f 6174 2c0a 2020 2020  art: float,.    
+0002b920: 2020 2020 7461 736b 733a 206c 6973 745b      tasks: list[
+0002b930: 5461 736b 5374 6174 655d 2c0a 2020 2020  TaskState],.    
+0002b940: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0002b950: 2020 2066 6966 6f5f 7469 6d65 6f75 7420     fifo_timeout 
+0002b960: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
+0002b970: 6128 6669 666f 5f74 696d 656f 7574 290a  a(fifo_timeout).
+0002b980: 2020 2020 2020 2020 6966 2073 7562 6d69          if submi
+0002b990: 7474 696e 675f 7461 736b 3a20 2023 2073  tting_task:  # s
+0002b9a0: 7562 2d74 6173 6b73 2067 6574 2062 6574  ub-tasks get bet
+0002b9b0: 7465 7220 7072 696f 7269 7479 2074 6861  ter priority tha
+0002b9c0: 6e20 7061 7265 6e74 2074 6173 6b73 0a20  n parent tasks. 
+0002b9d0: 2020 2020 2020 2020 2020 2073 7473 203d             sts =
+0002b9e0: 2073 656c 662e 7461 736b 732e 6765 7428   self.tasks.get(
+0002b9f0: 7375 626d 6974 7469 6e67 5f74 6173 6b29  submitting_task)
+0002ba00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002ba10: 7374 7320 6973 206e 6f74 204e 6f6e 653a  sts is not None:
+0002ba20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002ba30: 2061 7373 6572 7420 7374 732e 7072 696f   assert sts.prio
+0002ba40: 7269 7479 0a20 2020 2020 2020 2020 2020  rity.           
+0002ba50: 2020 2020 2067 656e 6572 6174 696f 6e20       generation 
+0002ba60: 3d20 7374 732e 7072 696f 7269 7479 5b30  = sts.priority[0
+0002ba70: 5d20 2d20 302e 3031 0a20 2020 2020 2020  ] - 0.01.       
+0002ba80: 2020 2020 2065 6c73 653a 2020 2320 7375       else:  # su
+0002ba90: 7065 722d 7461 736b 2061 6c72 6561 6479  per-task already
+0002baa0: 2063 6c65 616e 6564 2075 700a 2020 2020   cleaned up.    
+0002bab0: 2020 2020 2020 2020 2020 2020 6765 6e65              gene
+0002bac0: 7261 7469 6f6e 203d 2073 656c 662e 6765  ration = self.ge
+0002bad0: 6e65 7261 7469 6f6e 0a20 2020 2020 2020  neration.       
+0002bae0: 2065 6c69 6620 7365 6c66 2e5f 6c61 7374   elif self._last
+0002baf0: 5f74 696d 6520 2b20 6669 666f 5f74 696d  _time + fifo_tim
+0002bb00: 656f 7574 203c 2073 7461 7274 3a0a 2020  eout < start:.  
+0002bb10: 2020 2020 2020 2020 2020 7365 6c66 2e67            self.g
+0002bb20: 656e 6572 6174 696f 6e20 2b3d 2031 2020  eneration += 1  
+0002bb30: 2320 6f6c 6465 7220 6772 6170 6820 6765  # older graph ge
+0002bb40: 6e65 7261 7469 6f6e 7320 7461 6b65 2070  nerations take p
+0002bb50: 7265 6365 6465 6e63 650a 2020 2020 2020  recedence.      
+0002bb60: 2020 2020 2020 6765 6e65 7261 7469 6f6e        generation
+0002bb70: 203d 2073 656c 662e 6765 6e65 7261 7469   = self.generati
+0002bb80: 6f6e 0a20 2020 2020 2020 2020 2020 2073  on.            s
+0002bb90: 656c 662e 5f6c 6173 745f 7469 6d65 203d  elf._last_time =
+0002bba0: 2073 7461 7274 0a20 2020 2020 2020 2065   start.        e
+0002bbb0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002bbc0: 2067 656e 6572 6174 696f 6e20 3d20 7365   generation = se
+0002bbd0: 6c66 2e67 656e 6572 6174 696f 6e0a 0a20  lf.generation.. 
+0002bbe0: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
+0002bbf0: 2074 6173 6b73 3a0a 2020 2020 2020 2020   tasks:.        
+0002bc00: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+0002bc10: 6528 7573 6572 5f70 7269 6f72 6974 792c  e(user_priority,
+0002bc20: 2064 6963 7429 3a0a 2020 2020 2020 2020   dict):.        
+0002bc30: 2020 2020 2020 2020 7461 736b 5f75 7365          task_use
+0002bc40: 725f 7072 696f 203d 2075 7365 725f 7072  r_prio = user_pr
+0002bc50: 696f 7269 7479 2e67 6574 2874 732e 6b65  iority.get(ts.ke
+0002bc60: 792c 2030 290a 2020 2020 2020 2020 2020  y, 0).          
+0002bc70: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002bc80: 2020 2020 2020 2020 7461 736b 5f75 7365          task_use
+0002bc90: 725f 7072 696f 203d 2075 7365 725f 7072  r_prio = user_pr
+0002bca0: 696f 7269 7479 0a20 2020 2020 2020 2020  iority.         
+0002bcb0: 2020 2023 2041 6e6e 6f74 6174 696f 6e73     # Annotations
+0002bcc0: 2074 6861 7420 6172 6520 616c 7265 6164   that are alread
+0002bcd0: 7920 6173 7369 676e 6564 2074 6f20 7468  y assigned to th
+0002bce0: 6520 5461 736b 5374 6174 6520 6f62 6a65  e TaskState obje
+0002bcf0: 6374 0a20 2020 2020 2020 2020 2020 2023  ct.            #
+0002bd00: 206f 7269 6769 6e61 7465 2066 726f 6d20   originate from 
+0002bd10: 6120 4c61 7965 7220 616e 6e6f 7461 7469  a Layer annotati
+0002bd20: 6f6e 2077 6869 6368 2074 616b 6573 2070  on which takes p
+0002bd30: 7265 6365 6465 6e63 6520 6f76 6572 2074  recedence over t
+0002bd40: 6865 0a20 2020 2020 2020 2020 2020 2023  he.            #
+0002bd50: 2067 6c6f 6261 6c20 616e 6e6f 7461 7469   global annotati
+0002bd60: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
+0002bd70: 6966 2074 732e 616e 6e6f 7461 7469 6f6e  if ts.annotation
+0002bd80: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0002bd90: 2020 2061 6e6e 6f74 6174 6564 5f70 7269     annotated_pri
+0002bda0: 6f20 3d20 7473 2e61 6e6e 6f74 6174 696f  o = ts.annotatio
+0002bdb0: 6e73 2e67 6574 2822 7072 696f 7269 7479  ns.get("priority
+0002bdc0: 222c 2074 6173 6b5f 7573 6572 5f70 7269  ", task_user_pri
+0002bdd0: 6f29 0a20 2020 2020 2020 2020 2020 2065  o).            e
+0002bde0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0002bdf0: 2020 2020 2061 6e6e 6f74 6174 6564 5f70       annotated_p
+0002be00: 7269 6f20 3d20 7461 736b 5f75 7365 725f  rio = task_user_
+0002be10: 7072 696f 0a0a 2020 2020 2020 2020 2020  prio..          
+0002be20: 2020 6966 206e 6f74 2074 732e 7072 696f    if not ts.prio
+0002be30: 7269 7479 2061 6e64 2074 732e 6b65 7920  rity and ts.key 
+0002be40: 696e 2069 6e74 6572 6e61 6c5f 7072 696f  in internal_prio
+0002be50: 7269 7479 3a0a 2020 2020 2020 2020 2020  rity:.          
+0002be60: 2020 2020 2020 7473 2e70 7269 6f72 6974        ts.priorit
+0002be70: 7920 3d20 280a 2020 2020 2020 2020 2020  y = (.          
+0002be80: 2020 2020 2020 2020 2020 2d61 6e6e 6f74            -annot
+0002be90: 6174 6564 5f70 7269 6f2c 0a20 2020 2020  ated_prio,.     
+0002bea0: 2020 2020 2020 2020 2020 2020 2020 2067                 g
+0002beb0: 656e 6572 6174 696f 6e2c 0a20 2020 2020  eneration,.     
+0002bec0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0002bed0: 6e74 6572 6e61 6c5f 7072 696f 7269 7479  nternal_priority
+0002bee0: 5b74 732e 6b65 795d 2c0a 2020 2020 2020  [ts.key],.      
+0002bef0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0002bf00: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0002bf10: 2e76 616c 6964 6174 6520 616e 6420 7473  .validate and ts
+0002bf20: 2e72 756e 5f73 7065 633a 0a20 2020 2020  .run_spec:.     
+0002bf30: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0002bf40: 7420 6973 696e 7374 616e 6365 2874 732e  t isinstance(ts.
+0002bf50: 7072 696f 7269 7479 2c20 7475 706c 6529  priority, tuple)
+0002bf60: 2061 6e64 2061 6c6c 280a 2020 2020 2020   and all(.      
+0002bf70: 2020 2020 2020 2020 2020 2020 2020 6973                is
+0002bf80: 696e 7374 616e 6365 2865 6c2c 2028 696e  instance(el, (in
+0002bf90: 742c 2066 6c6f 6174 2929 2066 6f72 2065  t, float)) for e
+0002bfa0: 6c20 696e 2074 732e 7072 696f 7269 7479  l in ts.priority
+0002bfb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002bfc0: 2029 0a0a 2020 2020 6465 6620 7374 696d   )..    def stim
+0002bfd0: 756c 7573 5f71 7565 7565 5f73 6c6f 7473  ulus_queue_slots
+0002bfe0: 5f6d 6179 6265 5f6f 7065 6e65 6428 7365  _maybe_opened(se
+0002bff0: 6c66 2c20 2a2c 2073 7469 6d75 6c75 735f  lf, *, stimulus_
+0002c000: 6964 3a20 7374 7229 202d 3e20 4e6f 6e65  id: str) -> None
+0002c010: 3a0a 2020 2020 2020 2020 2222 2252 6573  :.        """Res
+0002c020: 706f 6e64 2074 6f20 616e 2065 7665 6e74  pond to an event
+0002c030: 2077 6869 6368 206d 6179 2068 6176 6520   which may have 
+0002c040: 6f70 656e 6564 2073 706f 7473 206f 6e20  opened spots on 
+0002c050: 776f 726b 6572 2074 6872 6561 6470 6f6f  worker threadpoo
+0002c060: 6c73 0a0a 2020 2020 2020 2020 5365 6c65  ls..        Sele
+0002c070: 6374 7320 7468 6520 6170 7072 6f70 7269  cts the appropri
+0002c080: 6174 6520 6e75 6d62 6572 206f 6620 7461  ate number of ta
+0002c090: 736b 7320 6672 6f6d 2074 6865 2066 726f  sks from the fro
+0002c0a0: 6e74 206f 6620 7468 6520 7175 6575 6520  nt of the queue 
+0002c0b0: 6163 636f 7264 696e 6720 746f 0a20 2020  according to.   
+0002c0c0: 2020 2020 2074 6865 2074 6f74 616c 206e       the total n
+0002c0d0: 756d 6265 7220 6f66 2074 6173 6b20 736c  umber of task sl
+0002c0e0: 6f74 7320 6176 6169 6c61 626c 6520 6f6e  ots available on
+0002c0f0: 2077 6f72 6b65 7273 2028 706f 7465 6e74   workers (potent
+0002c100: 6961 6c6c 7920 3029 2c20 616e 640a 2020  ially 0), and.  
+0002c110: 2020 2020 2020 7472 616e 7369 7469 6f6e        transition
+0002c120: 7320 7468 656d 2074 6f20 6060 7072 6f63  s them to ``proc
+0002c130: 6573 7369 6e67 6060 2e0a 0a20 2020 2020  essing``...     
+0002c140: 2020 204e 6f74 6573 0a20 2020 2020 2020     Notes.       
+0002c150: 202d 2d2d 2d2d 0a20 2020 2020 2020 204f   -----.        O
+0002c160: 7468 6572 2074 7261 6e73 6974 696f 6e73  ther transitions
+0002c170: 2072 656c 6174 6564 2074 6f20 7468 6973   related to this
+0002c180: 2073 7469 6d75 6c75 7320 7368 6f75 6c64   stimulus should
+0002c190: 2062 6520 6675 6c6c 7920 7072 6f63 6573   be fully proces
+0002c1a0: 7365 6420 6265 666f 7265 6861 6e64 2c0a  sed beforehand,.
+0002c1b0: 2020 2020 2020 2020 736f 2061 6e79 2074          so any t
+0002c1c0: 6173 6b73 2074 6861 7420 6265 6361 6d65  asks that became
+0002c1d0: 2072 756e 6e61 626c 6520 6172 6520 616c   runnable are al
+0002c1e0: 7265 6164 7920 696e 2060 6070 726f 6365  ready in ``proce
+0002c1f0: 7373 696e 6760 602e 204f 7468 6572 7769  ssing``. Otherwi
+0002c200: 7365 2c0a 2020 2020 2020 2020 6f76 6572  se,.        over
+0002c210: 7072 6f64 7563 7469 6f6e 2063 616e 206f  production can o
+0002c220: 6363 7572 2069 6620 7175 6575 6564 2074  ccur if queued t
+0002c230: 6173 6b73 2067 6574 2073 6368 6564 756c  asks get schedul
+0002c240: 6564 2062 6566 6f72 6520 646f 776e 7374  ed before downst
+0002c250: 7265 616d 2074 6173 6b73 2e0a 0a20 2020  ream tasks...   
+0002c260: 2020 2020 204d 7573 7420 6265 2063 616c       Must be cal
+0002c270: 6c65 6420 6166 7465 7220 6063 6865 636b  led after `check
+0002c280: 5f69 646c 655f 7361 7475 7261 7465 6460  _idle_saturated`
+0002c290: 3b20 692e 652e 2060 6964 6c65 5f74 6173  ; i.e. `idle_tas
+0002c2a0: 6b5f 636f 756e 7460 206d 7573 7420 6265  k_count` must be
+0002c2b0: 2075 7020 746f 2064 6174 652e 0a20 2020   up to date..   
+0002c2c0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0002c2d0: 2069 6620 6e6f 7420 7365 6c66 2e71 7565   if not self.que
+0002c2e0: 7565 643a 0a20 2020 2020 2020 2020 2020  ued:.           
+0002c2f0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+0002c300: 736c 6f74 735f 6176 6169 6c61 626c 6520  slots_available 
+0002c310: 3d20 7375 6d28 0a20 2020 2020 2020 2020  = sum(.         
+0002c320: 2020 205f 7461 736b 5f73 6c6f 7473 5f61     _task_slots_a
+0002c330: 7661 696c 6162 6c65 2877 732c 2073 656c  vailable(ws, sel
+0002c340: 662e 574f 524b 4552 5f53 4154 5552 4154  f.WORKER_SATURAT
+0002c350: 494f 4e29 0a20 2020 2020 2020 2020 2020  ION).           
+0002c360: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
+0002c370: 6964 6c65 5f74 6173 6b5f 636f 756e 740a  idle_task_count.
+0002c380: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002c390: 2020 6966 2073 6c6f 7473 5f61 7661 696c    if slots_avail
+0002c3a0: 6162 6c65 203d 3d20 303a 0a20 2020 2020  able == 0:.     
+0002c3b0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+0002c3c0: 2020 2020 2020 2066 6f72 205f 2069 6e20         for _ in 
+0002c3d0: 7261 6e67 6528 736c 6f74 735f 6176 6169  range(slots_avai
+0002c3e0: 6c61 626c 6529 3a0a 2020 2020 2020 2020  lable):.        
+0002c3f0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+0002c400: 7175 6575 6564 3a0a 2020 2020 2020 2020  queued:.        
+0002c410: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
+0002c420: 2020 2020 2020 2020 2020 2023 2049 6465             # Ide
+0002c430: 616c 6c79 2c20 7765 2764 2062 6520 706f  ally, we'd be po
+0002c440: 7070 696e 6720 6974 2068 6572 6520 616c  pping it here al
+0002c450: 7265 6164 7920 6275 7420 7468 6973 2077  ready but this w
+0002c460: 6f75 6c64 2062 7265 616b 0a20 2020 2020  ould break.     
+0002c470: 2020 2020 2020 2023 2063 6572 7461 696e         # certain
+0002c480: 2073 7461 7465 2069 6e76 6172 6961 6e74   state invariant
+0002c490: 7320 7369 6e63 6520 7468 6520 7461 736b  s since the task
+0002c4a0: 2069 7320 6e6f 7420 7472 616e 7369 7469   is not transiti
+0002c4b0: 6f6e 6564 2c20 7965 740a 2020 2020 2020  oned, yet.      
+0002c4c0: 2020 2020 2020 7174 7320 3d20 7365 6c66        qts = self
+0002c4d0: 2e71 7565 7565 642e 7065 656b 2829 0a20  .queued.peek(). 
+0002c4e0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+0002c4f0: 6c66 2e76 616c 6964 6174 653a 0a20 2020  lf.validate:.   
 0002c500: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0002c510: 6572 7420 6e6f 7420 7174 732e 7072 6f63  ert not qts.proc
-0002c520: 6573 7369 6e67 5f6f 6e2c 2028 7174 732c  essing_on, (qts,
-0002c530: 2071 7473 2e70 726f 6365 7373 696e 675f   qts.processing_
-0002c540: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-0002c550: 2020 2020 6173 7365 7274 206e 6f74 2071      assert not q
-0002c560: 7473 2e77 6169 7469 6e67 5f6f 6e2c 2028  ts.waiting_on, (
-0002c570: 7174 732c 2071 7473 2e70 726f 6365 7373  qts, qts.process
-0002c580: 696e 675f 6f6e 290a 2020 2020 2020 2020  ing_on).        
-0002c590: 2020 2020 2020 2020 6173 7365 7274 2071          assert q
-0002c5a0: 7473 2e77 686f 5f77 616e 7473 206f 7220  ts.who_wants or 
-0002c5b0: 7174 732e 7761 6974 6572 732c 2071 7473  qts.waiters, qts
-0002c5c0: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-0002c5d0: 5468 6973 2072 656d 6f76 6573 2074 6865  This removes the
-0002c5e0: 2074 6173 6b20 6672 6f6d 2074 6865 2074   task from the t
-0002c5f0: 6f70 206f 6620 7468 6520 7365 6c66 2e71  op of the self.q
-0002c600: 7565 7565 6420 6865 6170 0a20 2020 2020  ueued heap.     
-0002c610: 2020 2020 2020 2073 656c 662e 7472 616e         self.tran
-0002c620: 7369 7469 6f6e 7328 7b71 7473 2e6b 6579  sitions({qts.key
-0002c630: 3a20 2270 726f 6365 7373 696e 6722 7d2c  : "processing"},
-0002c640: 2073 7469 6d75 6c75 735f 6964 290a 2020   stimulus_id).  
-0002c650: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0002c660: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
-0002c670: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-0002c680: 7274 2071 7473 2e73 7461 7465 203d 3d20  rt qts.state == 
-0002c690: 2270 726f 6365 7373 696e 6722 0a20 2020  "processing".   
-0002c6a0: 2020 2020 2020 2020 2020 2020 2061 7373               ass
-0002c6b0: 6572 7420 6e6f 7420 7365 6c66 2e71 7565  ert not self.que
-0002c6c0: 7565 6420 6f72 2073 656c 662e 7175 6575  ued or self.queu
-0002c6d0: 6564 2e70 6565 6b28 2920 213d 2071 7473  ed.peek() != qts
-0002c6e0: 0a0a 2020 2020 6465 6620 7374 696d 756c  ..    def stimul
-0002c6f0: 7573 5f74 6173 6b5f 6669 6e69 7368 6564  us_task_finished
-0002c700: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0002c710: 6b65 793a 204b 6579 2c20 776f 726b 6572  key: Key, worker
-0002c720: 3a20 7374 722c 2073 7469 6d75 6c75 735f  : str, stimulus_
-0002c730: 6964 3a20 7374 722c 2072 756e 5f69 643a  id: str, run_id:
-0002c740: 2069 6e74 2c20 2a2a 6b77 6172 6773 3a20   int, **kwargs: 
-0002c750: 416e 790a 2020 2020 2920 2d3e 2052 6563  Any.    ) -> Rec
-0002c760: 734d 7367 733a 0a20 2020 2020 2020 2022  sMsgs:.        "
-0002c770: 2222 4d61 726b 2074 6861 7420 6120 7461  ""Mark that a ta
-0002c780: 736b 2068 6173 2066 696e 6973 6865 6420  sk has finished 
-0002c790: 6578 6563 7574 696f 6e20 6f6e 2061 2070  execution on a p
-0002c7a0: 6172 7469 6375 6c61 7220 776f 726b 6572  articular worker
-0002c7b0: 2222 220a 2020 2020 2020 2020 6c6f 6767  """.        logg
-0002c7c0: 6572 2e64 6562 7567 2822 5374 696d 756c  er.debug("Stimul
-0002c7d0: 7573 2074 6173 6b20 6669 6e69 7368 6564  us task finished
-0002c7e0: 2025 735b 2564 5d20 2573 222c 206b 6579   %s[%d] %s", key
-0002c7f0: 2c20 7275 6e5f 6964 2c20 776f 726b 6572  , run_id, worker
-0002c800: 290a 0a20 2020 2020 2020 2072 6563 6f6d  )..        recom
-0002c810: 6d65 6e64 6174 696f 6e73 3a20 5265 6373  mendations: Recs
-0002c820: 203d 207b 7d0a 2020 2020 2020 2020 636c   = {}.        cl
-0002c830: 6965 6e74 5f6d 7367 733a 204d 7367 7320  ient_msgs: Msgs 
-0002c840: 3d20 7b7d 0a20 2020 2020 2020 2077 6f72  = {}.        wor
-0002c850: 6b65 725f 6d73 6773 3a20 4d73 6773 203d  ker_msgs: Msgs =
-0002c860: 207b 7d0a 0a20 2020 2020 2020 2074 7320   {}..        ts 
-0002c870: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
-0002c880: 286b 6579 290a 2020 2020 2020 2020 6966  (key).        if
-0002c890: 2074 7320 6973 204e 6f6e 6520 6f72 2074   ts is None or t
-0002c8a0: 732e 7374 6174 6520 696e 2028 2272 656c  s.state in ("rel
-0002c8b0: 6561 7365 6422 2c20 2271 7565 7565 6422  eased", "queued"
-0002c8c0: 2c20 226e 6f2d 776f 726b 6572 2229 3a0a  , "no-worker"):.
-0002c8d0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0002c8e0: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
-0002c8f0: 2020 2020 2020 2020 2020 2252 6563 6569            "Recei
-0002c900: 7665 6420 616c 7265 6164 7920 636f 6d70  ved already comp
-0002c910: 7574 6564 2074 6173 6b2c 2077 6f72 6b65  uted task, worke
-0002c920: 723a 2025 732c 2073 7461 7465 3a20 2573  r: %s, state: %s
-0002c930: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0002c940: 2020 222c 206b 6579 3a20 2573 2c20 7768    ", key: %s, wh
-0002c950: 6f5f 6861 733a 2025 7322 2c0a 2020 2020  o_has: %s",.    
-0002c960: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0002c970: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
-0002c980: 2020 2020 7473 2e73 7461 7465 2069 6620      ts.state if 
-0002c990: 7473 2065 6c73 6520 2266 6f72 676f 7474  ts else "forgott
-0002c9a0: 656e 222c 0a20 2020 2020 2020 2020 2020  en",.           
-0002c9b0: 2020 2020 206b 6579 2c0a 2020 2020 2020       key,.      
-0002c9c0: 2020 2020 2020 2020 2020 7473 2e77 686f            ts.who
-0002c9d0: 5f68 6173 2069 6620 7473 2065 6c73 6520  _has if ts else 
-0002c9e0: 7b7d 2c0a 2020 2020 2020 2020 2020 2020  {},.            
-0002c9f0: 290a 2020 2020 2020 2020 2020 2020 776f  ).            wo
-0002ca00: 726b 6572 5f6d 7367 735b 776f 726b 6572  rker_msgs[worker
-0002ca10: 5d20 3d20 5b0a 2020 2020 2020 2020 2020  ] = [.          
-0002ca20: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0002ca30: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
-0002ca40: 3a20 2266 7265 652d 6b65 7973 222c 0a20  : "free-keys",. 
-0002ca50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ca60: 2020 2022 6b65 7973 223a 205b 6b65 795d     "keys": [key]
-0002ca70: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002ca80: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
-0002ca90: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
-0002caa0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002cab0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
-0002cac0: 5d0a 2020 2020 2020 2020 656c 6966 2074  ].        elif t
-0002cad0: 732e 7374 6174 6520 3d3d 2022 6572 7265  s.state == "erre
-0002cae0: 6422 3a0a 2020 2020 2020 2020 2020 2020  d":.            
-0002caf0: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
-0002cb00: 2020 2020 2020 2020 2020 2020 2020 2252                "R
-0002cb10: 6563 6569 7665 6420 616c 7265 6164 7920  eceived already 
-0002cb20: 6572 7265 6420 7461 736b 2c20 776f 726b  erred task, work
-0002cb30: 6572 3a20 2573 2220 222c 206b 6579 3a20  er: %s" ", key: 
-0002cb40: 2573 222c 0a20 2020 2020 2020 2020 2020  %s",.           
-0002cb50: 2020 2020 2077 6f72 6b65 722c 0a20 2020       worker,.   
-0002cb60: 2020 2020 2020 2020 2020 2020 206b 6579               key
-0002cb70: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-0002cb80: 2020 2020 2020 2020 2020 2020 776f 726b              work
-0002cb90: 6572 5f6d 7367 735b 776f 726b 6572 5d20  er_msgs[worker] 
-0002cba0: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-0002cbb0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0002cbc0: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-0002cbd0: 2266 7265 652d 6b65 7973 222c 0a20 2020  "free-keys",.   
-0002cbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cbf0: 2022 6b65 7973 223a 205b 6b65 795d 2c0a   "keys": [key],.
-0002cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc10: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
-0002cc20: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
-0002cc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cc40: 7d0a 2020 2020 2020 2020 2020 2020 5d0a  }.            ].
-0002cc50: 2020 2020 2020 2020 656c 6966 2074 732e          elif ts.
-0002cc60: 7275 6e5f 6964 2021 3d20 7275 6e5f 6964  run_id != run_id
-0002cc70: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-0002cc80: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
-0002cc90: 6e67 5f6f 6e20 6f72 2074 732e 7072 6f63  ng_on or ts.proc
-0002cca0: 6573 7369 6e67 5f6f 6e2e 6164 6472 6573  essing_on.addres
-0002ccb0: 7320 213d 2077 6f72 6b65 723a 0a20 2020  s != worker:.   
-0002ccc0: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-0002ccd0: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
-0002cce0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0002ccf0: 5265 6365 6976 6564 2073 7461 6c65 2074  Received stale t
-0002cd00: 6173 6b20 7275 6e2c 2077 6f72 6b65 723a  ask run, worker:
-0002cd10: 2025 732c 206b 6579 3a20 2573 2c20 7275   %s, key: %s, ru
-0002cd20: 6e5f 6964 3a20 2564 2028 2564 2922 2c0a  n_id: %d (%d)",.
-0002cd30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cd40: 2020 2020 776f 726b 6572 2c0a 2020 2020      worker,.    
-0002cd50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cd60: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
-0002cd70: 2020 2020 2020 2020 2072 756e 5f69 642c           run_id,
-0002cd80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002cd90: 2020 2020 2074 732e 7275 6e5f 6964 2c0a       ts.run_id,.
+0002c510: 6572 7420 7174 732e 7374 6174 6520 3d3d  ert qts.state ==
+0002c520: 2022 7175 6575 6564 222c 2071 7473 2e73   "queued", qts.s
+0002c530: 7461 7465 0a20 2020 2020 2020 2020 2020  tate.           
+0002c540: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0002c550: 7174 732e 7072 6f63 6573 7369 6e67 5f6f  qts.processing_o
+0002c560: 6e2c 2028 7174 732c 2071 7473 2e70 726f  n, (qts, qts.pro
+0002c570: 6365 7373 696e 675f 6f6e 290a 2020 2020  cessing_on).    
+0002c580: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0002c590: 7274 206e 6f74 2071 7473 2e77 6169 7469  rt not qts.waiti
+0002c5a0: 6e67 5f6f 6e2c 2028 7174 732c 2071 7473  ng_on, (qts, qts
+0002c5b0: 2e70 726f 6365 7373 696e 675f 6f6e 290a  .processing_on).
+0002c5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002c5d0: 6173 7365 7274 2071 7473 2e77 686f 5f77  assert qts.who_w
+0002c5e0: 616e 7473 206f 7220 7174 732e 7761 6974  ants or qts.wait
+0002c5f0: 6572 732c 2071 7473 0a0a 2020 2020 2020  ers, qts..      
+0002c600: 2020 2020 2020 2320 5468 6973 2072 656d        # This rem
+0002c610: 6f76 6573 2074 6865 2074 6173 6b20 6672  oves the task fr
+0002c620: 6f6d 2074 6865 2074 6f70 206f 6620 7468  om the top of th
+0002c630: 6520 7365 6c66 2e71 7565 7565 6420 6865  e self.queued he
+0002c640: 6170 0a20 2020 2020 2020 2020 2020 2073  ap.            s
+0002c650: 656c 662e 7472 616e 7369 7469 6f6e 7328  elf.transitions(
+0002c660: 7b71 7473 2e6b 6579 3a20 2270 726f 6365  {qts.key: "proce
+0002c670: 7373 696e 6722 7d2c 2073 7469 6d75 6c75  ssing"}, stimulu
+0002c680: 735f 6964 290a 2020 2020 2020 2020 2020  s_id).          
+0002c690: 2020 6966 2073 656c 662e 7661 6c69 6461    if self.valida
+0002c6a0: 7465 3a0a 2020 2020 2020 2020 2020 2020  te:.            
+0002c6b0: 2020 2020 6173 7365 7274 2071 7473 2e73      assert qts.s
+0002c6c0: 7461 7465 203d 3d20 2270 726f 6365 7373  tate == "process
+0002c6d0: 696e 6722 0a20 2020 2020 2020 2020 2020  ing".           
+0002c6e0: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0002c6f0: 7365 6c66 2e71 7565 7565 6420 6f72 2073  self.queued or s
+0002c700: 656c 662e 7175 6575 6564 2e70 6565 6b28  elf.queued.peek(
+0002c710: 2920 213d 2071 7473 0a0a 2020 2020 6465  ) != qts..    de
+0002c720: 6620 7374 696d 756c 7573 5f74 6173 6b5f  f stimulus_task_
+0002c730: 6669 6e69 7368 6564 280a 2020 2020 2020  finished(.      
+0002c740: 2020 7365 6c66 2c20 6b65 793a 204b 6579    self, key: Key
+0002c750: 2c20 776f 726b 6572 3a20 7374 722c 2073  , worker: str, s
+0002c760: 7469 6d75 6c75 735f 6964 3a20 7374 722c  timulus_id: str,
+0002c770: 2072 756e 5f69 643a 2069 6e74 2c20 2a2a   run_id: int, **
+0002c780: 6b77 6172 6773 3a20 416e 790a 2020 2020  kwargs: Any.    
+0002c790: 2920 2d3e 2052 6563 734d 7367 733a 0a20  ) -> RecsMsgs:. 
+0002c7a0: 2020 2020 2020 2022 2222 4d61 726b 2074         """Mark t
+0002c7b0: 6861 7420 6120 7461 736b 2068 6173 2066  hat a task has f
+0002c7c0: 696e 6973 6865 6420 6578 6563 7574 696f  inished executio
+0002c7d0: 6e20 6f6e 2061 2070 6172 7469 6375 6c61  n on a particula
+0002c7e0: 7220 776f 726b 6572 2222 220a 2020 2020  r worker""".    
+0002c7f0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+0002c800: 2822 5374 696d 756c 7573 2074 6173 6b20  ("Stimulus task 
+0002c810: 6669 6e69 7368 6564 2025 735b 2564 5d20  finished %s[%d] 
+0002c820: 2573 222c 206b 6579 2c20 7275 6e5f 6964  %s", key, run_id
+0002c830: 2c20 776f 726b 6572 290a 0a20 2020 2020  , worker)..     
+0002c840: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0002c850: 6e73 3a20 5265 6373 203d 207b 7d0a 2020  ns: Recs = {}.  
+0002c860: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
+0002c870: 733a 204d 7367 7320 3d20 7b7d 0a20 2020  s: Msgs = {}.   
+0002c880: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
+0002c890: 3a20 4d73 6773 203d 207b 7d0a 0a20 2020  : Msgs = {}..   
+0002c8a0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+0002c8b0: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
+0002c8c0: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
+0002c8d0: 6f6e 6520 6f72 2074 732e 7374 6174 6520  one or ts.state 
+0002c8e0: 696e 2028 2272 656c 6561 7365 6422 2c20  in ("released", 
+0002c8f0: 2271 7565 7565 6422 2c20 226e 6f2d 776f  "queued", "no-wo
+0002c900: 726b 6572 2229 3a0a 2020 2020 2020 2020  rker"):.        
+0002c910: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+0002c920: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0002c930: 2020 2252 6563 6569 7665 6420 616c 7265    "Received alre
+0002c940: 6164 7920 636f 6d70 7574 6564 2074 6173  ady computed tas
+0002c950: 6b2c 2077 6f72 6b65 723a 2025 732c 2073  k, worker: %s, s
+0002c960: 7461 7465 3a20 2573 220a 2020 2020 2020  tate: %s".      
+0002c970: 2020 2020 2020 2020 2020 222c 206b 6579            ", key
+0002c980: 3a20 2573 2c20 7768 6f5f 6861 733a 2025  : %s, who_has: %
+0002c990: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
+0002c9a0: 2020 2020 776f 726b 6572 2c0a 2020 2020      worker,.    
+0002c9b0: 2020 2020 2020 2020 2020 2020 7473 2e73              ts.s
+0002c9c0: 7461 7465 2069 6620 7473 2065 6c73 6520  tate if ts else 
+0002c9d0: 2266 6f72 676f 7474 656e 222c 0a20 2020  "forgotten",.   
+0002c9e0: 2020 2020 2020 2020 2020 2020 206b 6579               key
+0002c9f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002ca00: 2020 7473 2e77 686f 5f68 6173 2069 6620    ts.who_has if 
+0002ca10: 7473 2065 6c73 6520 7b7d 2c0a 2020 2020  ts else {},.    
+0002ca20: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002ca30: 2020 2020 2020 776f 726b 6572 5f6d 7367        worker_msg
+0002ca40: 735b 776f 726b 6572 5d20 3d20 5b0a 2020  s[worker] = [.  
+0002ca50: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
+0002ca60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ca70: 2020 2020 226f 7022 3a20 2266 7265 652d      "op": "free-
+0002ca80: 6b65 7973 222c 0a20 2020 2020 2020 2020  keys",.         
+0002ca90: 2020 2020 2020 2020 2020 2022 6b65 7973             "keys
+0002caa0: 223a 205b 6b65 795d 2c0a 2020 2020 2020  ": [key],.      
+0002cab0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+0002cac0: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
+0002cad0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+0002cae0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+0002caf0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+0002cb00: 2020 656c 6966 2074 732e 7374 6174 6520    elif ts.state 
+0002cb10: 3d3d 2022 6572 7265 6422 3a0a 2020 2020  == "erred":.    
+0002cb20: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+0002cb30: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0002cb40: 2020 2020 2020 2252 6563 6569 7665 6420        "Received 
+0002cb50: 616c 7265 6164 7920 6572 7265 6420 7461  already erred ta
+0002cb60: 736b 2c20 776f 726b 6572 3a20 2573 2220  sk, worker: %s" 
+0002cb70: 222c 206b 6579 3a20 2573 222c 0a20 2020  ", key: %s",.   
+0002cb80: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
+0002cb90: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
+0002cba0: 2020 2020 206b 6579 2c0a 2020 2020 2020       key,.      
+0002cbb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002cbc0: 2020 2020 776f 726b 6572 5f6d 7367 735b      worker_msgs[
+0002cbd0: 776f 726b 6572 5d20 3d20 5b0a 2020 2020  worker] = [.    
+0002cbe0: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+0002cbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cc00: 2020 226f 7022 3a20 2266 7265 652d 6b65    "op": "free-ke
+0002cc10: 7973 222c 0a20 2020 2020 2020 2020 2020  ys",.           
+0002cc20: 2020 2020 2020 2020 2022 6b65 7973 223a           "keys":
+0002cc30: 205b 6b65 795d 2c0a 2020 2020 2020 2020   [key],.        
+0002cc40: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+0002cc50: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
+0002cc60: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+0002cc70: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+0002cc80: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
+0002cc90: 656c 6966 2074 732e 7275 6e5f 6964 2021  elif ts.run_id !
+0002cca0: 3d20 7275 6e5f 6964 3a0a 2020 2020 2020  = run_id:.      
+0002ccb0: 2020 2020 2020 6966 206e 6f74 2074 732e        if not ts.
+0002ccc0: 7072 6f63 6573 7369 6e67 5f6f 6e20 6f72  processing_on or
+0002ccd0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+0002cce0: 6e2e 6164 6472 6573 7320 213d 2077 6f72  n.address != wor
+0002ccf0: 6b65 723a 0a20 2020 2020 2020 2020 2020  ker:.           
+0002cd00: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
+0002cd10: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+0002cd20: 2020 2020 2020 2022 5265 6365 6976 6564         "Received
+0002cd30: 2073 7461 6c65 2074 6173 6b20 7275 6e2c   stale task run,
+0002cd40: 2077 6f72 6b65 723a 2025 732c 206b 6579   worker: %s, key
+0002cd50: 3a20 2573 2c20 7275 6e5f 6964 3a20 2564  : %s, run_id: %d
+0002cd60: 2028 2564 2922 2c0a 2020 2020 2020 2020   (%d)",.        
+0002cd70: 2020 2020 2020 2020 2020 2020 776f 726b              work
+0002cd80: 6572 2c0a 2020 2020 2020 2020 2020 2020  er,.            
+0002cd90: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
 0002cda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cdb0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0002cdc0: 2020 776f 726b 6572 5f6d 7367 735b 776f    worker_msgs[wo
-0002cdd0: 726b 6572 5d20 3d20 5b0a 2020 2020 2020  rker] = [.      
-0002cde0: 2020 2020 2020 2020 2020 2020 2020 7b0a                {.
-0002cdf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ce00: 2020 2020 2020 2020 226f 7022 3a20 2266          "op": "f
-0002ce10: 7265 652d 6b65 7973 222c 0a20 2020 2020  ree-keys",.     
-0002ce20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ce30: 2020 2022 6b65 7973 223a 205b 6b65 795d     "keys": [key]
-0002ce40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002ce50: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
-0002ce60: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
-0002ce70: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
-0002ce80: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
-0002ce90: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-0002cea0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0002cdb0: 2072 756e 5f69 642c 0a20 2020 2020 2020   run_id,.       
+0002cdc0: 2020 2020 2020 2020 2020 2020 2074 732e               ts.
+0002cdd0: 7275 6e5f 6964 2c0a 2020 2020 2020 2020  run_id,.        
+0002cde0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002cdf0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+0002ce00: 5f6d 7367 735b 776f 726b 6572 5d20 3d20  _msgs[worker] = 
+0002ce10: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+0002ce20: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0002ce30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce40: 226f 7022 3a20 2266 7265 652d 6b65 7973  "op": "free-keys
+0002ce50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0002ce60: 2020 2020 2020 2020 2020 2022 6b65 7973             "keys
+0002ce70: 223a 205b 6b65 795d 2c0a 2020 2020 2020  ": [key],.      
+0002ce80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ce90: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
+0002cea0: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
 0002ceb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002cec0: 7265 636f 6d6d 656e 6461 7469 6f6e 735b  recommendations[
-0002ced0: 7473 2e6b 6579 5d20 3d20 2272 656c 6561  ts.key] = "relea
-0002cee0: 7365 6422 0a20 2020 2020 2020 2065 6c69  sed".        eli
-0002cef0: 6620 7473 2e73 7461 7465 203d 3d20 226d  f ts.state == "m
-0002cf00: 656d 6f72 7922 3a0a 2020 2020 2020 2020  emory":.        
-0002cf10: 2020 2020 7365 6c66 2e61 6464 5f6b 6579      self.add_key
-0002cf20: 7328 776f 726b 6572 3d77 6f72 6b65 722c  s(worker=worker,
-0002cf30: 206b 6579 733d 5b6b 6579 5d29 0a20 2020   keys=[key]).   
-0002cf40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002cf50: 2020 2020 2020 2069 6620 6b77 6172 6773         if kwargs
-0002cf60: 5b22 6d65 7461 6461 7461 225d 3a0a 2020  ["metadata"]:.  
-0002cf70: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002cf80: 2074 732e 6d65 7461 6461 7461 2069 7320   ts.metadata is 
-0002cf90: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0002cfa0: 2020 2020 2020 2020 2020 7473 2e6d 6574            ts.met
-0002cfb0: 6164 6174 6120 3d20 6469 6374 2829 0a20  adata = dict(). 
-0002cfc0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0002cfd0: 732e 6d65 7461 6461 7461 2e75 7064 6174  s.metadata.updat
-0002cfe0: 6528 6b77 6172 6773 5b22 6d65 7461 6461  e(kwargs["metada
-0002cff0: 7461 225d 290a 2020 2020 2020 2020 2020  ta"]).          
-0002d000: 2020 7265 7475 726e 2073 656c 662e 5f74    return self._t
-0002d010: 7261 6e73 6974 696f 6e28 6b65 792c 2022  ransition(key, "
-0002d020: 6d65 6d6f 7279 222c 2073 7469 6d75 6c75  memory", stimulu
-0002d030: 735f 6964 2c20 776f 726b 6572 3d77 6f72  s_id, worker=wor
-0002d040: 6b65 722c 202a 2a6b 7761 7267 7329 0a0a  ker, **kwargs)..
-0002d050: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-0002d060: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-0002d070: 636c 6965 6e74 5f6d 7367 732c 2077 6f72  client_msgs, wor
-0002d080: 6b65 725f 6d73 6773 0a0a 2020 2020 6465  ker_msgs..    de
-0002d090: 6620 7374 696d 756c 7573 5f74 6173 6b5f  f stimulus_task_
-0002d0a0: 6572 7265 6428 0a20 2020 2020 2020 2073  erred(.        s
-0002d0b0: 656c 662c 0a20 2020 2020 2020 206b 6579  elf,.        key
-0002d0c0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
-0002d0d0: 6f72 6b65 723d 4e6f 6e65 2c0a 2020 2020  orker=None,.    
-0002d0e0: 2020 2020 6578 6365 7074 696f 6e3d 4e6f      exception=No
-0002d0f0: 6e65 2c0a 2020 2020 2020 2020 7374 696d  ne,.        stim
-0002d100: 756c 7573 5f69 643d 4e6f 6e65 2c0a 2020  ulus_id=None,.  
-0002d110: 2020 2020 2020 7472 6163 6562 6163 6b3d        traceback=
-0002d120: 4e6f 6e65 2c0a 2020 2020 2020 2020 7275  None,.        ru
-0002d130: 6e5f 6964 3d4e 6f6e 652c 0a20 2020 2020  n_id=None,.     
-0002d140: 2020 202a 2a6b 7761 7267 732c 0a20 2020     **kwargs,.   
-0002d150: 2029 3a0a 2020 2020 2020 2020 2222 224d   ):.        """M
-0002d160: 6172 6b20 7468 6174 2061 2074 6173 6b20  ark that a task 
-0002d170: 6861 7320 6572 7265 6420 6f6e 2061 2070  has erred on a p
-0002d180: 6172 7469 6375 6c61 7220 776f 726b 6572  articular worker
-0002d190: 2222 220a 2020 2020 2020 2020 6c6f 6767  """.        logg
-0002d1a0: 6572 2e64 6562 7567 2822 5374 696d 756c  er.debug("Stimul
-0002d1b0: 7573 2074 6173 6b20 6572 7265 6420 2573  us task erred %s
-0002d1c0: 2c20 2573 222c 206b 6579 2c20 776f 726b  , %s", key, work
-0002d1d0: 6572 290a 0a20 2020 2020 2020 2074 7320  er)..        ts 
-0002d1e0: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
-0002d1f0: 286b 6579 290a 2020 2020 2020 2020 6966  (key).        if
-0002d200: 2074 7320 6973 204e 6f6e 6520 6f72 2074   ts is None or t
-0002d210: 732e 7374 6174 6520 213d 2022 7072 6f63  s.state != "proc
-0002d220: 6573 7369 6e67 223a 0a20 2020 2020 2020  essing":.       
-0002d230: 2020 2020 2072 6574 7572 6e20 7b7d 2c20       return {}, 
-0002d240: 7b7d 2c20 7b7d 0a0a 2020 2020 2020 2020  {}, {}..        
-0002d250: 6966 2074 732e 7275 6e5f 6964 2021 3d20  if ts.run_id != 
-0002d260: 7275 6e5f 6964 3a0a 2020 2020 2020 2020  run_id:.        
-0002d270: 2020 2020 6966 2074 732e 7072 6f63 6573      if ts.proces
-0002d280: 7369 6e67 5f6f 6e20 616e 6420 7473 2e70  sing_on and ts.p
-0002d290: 726f 6365 7373 696e 675f 6f6e 2e61 6464  rocessing_on.add
-0002d2a0: 7265 7373 203d 3d20 776f 726b 6572 3a0a  ress == worker:.
-0002d2b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d2c0: 7265 7475 726e 2073 656c 662e 5f74 7261  return self._tra
-0002d2d0: 6e73 6974 696f 6e28 6b65 792c 2022 7265  nsition(key, "re
-0002d2e0: 6c65 6173 6564 222c 2073 7469 6d75 6c75  leased", stimulu
-0002d2f0: 735f 6964 290a 2020 2020 2020 2020 2020  s_id).          
-0002d300: 2020 7265 7475 726e 207b 7d2c 207b 7d2c    return {}, {},
-0002d310: 207b 7d0a 0a20 2020 2020 2020 2069 6620   {}..        if 
-0002d320: 7473 2e72 6574 7269 6573 203e 2030 3a0a  ts.retries > 0:.
-0002d330: 2020 2020 2020 2020 2020 2020 7473 2e72              ts.r
-0002d340: 6574 7269 6573 202d 3d20 310a 2020 2020  etries -= 1.    
-0002d350: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-0002d360: 656c 662e 5f74 7261 6e73 6974 696f 6e28  elf._transition(
-0002d370: 6b65 792c 2022 7761 6974 696e 6722 2c20  key, "waiting", 
-0002d380: 7374 696d 756c 7573 5f69 6429 0a20 2020  stimulus_id).   
-0002d390: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0002d3a0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0002d3b0: 6c66 2e5f 7472 616e 7369 7469 6f6e 280a  lf._transition(.
-0002d3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d3d0: 6b65 792c 0a20 2020 2020 2020 2020 2020  key,.           
-0002d3e0: 2020 2020 2022 6572 7265 6422 2c0a 2020       "erred",.  
-0002d3f0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0002d400: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
-0002d410: 2020 2020 2020 2020 2020 2063 6175 7365             cause
-0002d420: 3d6b 6579 2c0a 2020 2020 2020 2020 2020  =key,.          
-0002d430: 2020 2020 2020 6578 6365 7074 696f 6e3d        exception=
-0002d440: 6578 6365 7074 696f 6e2c 0a20 2020 2020  exception,.     
-0002d450: 2020 2020 2020 2020 2020 2074 7261 6365             trace
-0002d460: 6261 636b 3d74 7261 6365 6261 636b 2c0a  back=traceback,.
-0002d470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002d480: 776f 726b 6572 3d77 6f72 6b65 722c 0a20  worker=worker,. 
-0002d490: 2020 2020 2020 2020 2020 2020 2020 202a                 *
-0002d4a0: 2a6b 7761 7267 732c 0a20 2020 2020 2020  *kwargs,.       
-0002d4b0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-0002d4c0: 7374 696d 756c 7573 5f72 6574 7279 280a  stimulus_retry(.
-0002d4d0: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
-0002d4e0: 7973 3a20 436f 6c6c 6563 7469 6f6e 5b4b  ys: Collection[K
-0002d4f0: 6579 5d2c 2063 6c69 656e 743a 2073 7472  ey], client: str
-0002d500: 207c 204e 6f6e 6520 3d20 4e6f 6e65 0a20   | None = None. 
-0002d510: 2020 2029 202d 3e20 7475 706c 655b 4b65     ) -> tuple[Ke
-0002d520: 792c 202e 2e2e 5d3a 0a20 2020 2020 2020  y, ...]:.       
-0002d530: 206c 6f67 6765 722e 696e 666f 2822 436c   logger.info("Cl
-0002d540: 6965 6e74 2025 7320 7265 7175 6573 7473  ient %s requests
-0002d550: 2074 6f20 7265 7472 7920 2564 206b 6579   to retry %d key
-0002d560: 7322 2c20 636c 6965 6e74 2c20 6c65 6e28  s", client, len(
-0002d570: 6b65 7973 2929 0a20 2020 2020 2020 2069  keys)).        i
-0002d580: 6620 636c 6965 6e74 3a0a 2020 2020 2020  f client:.      
-0002d590: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
-0002d5a0: 7665 6e74 2863 6c69 656e 742c 207b 2261  vent(client, {"a
-0002d5b0: 6374 696f 6e22 3a20 2272 6574 7279 222c  ction": "retry",
-0002d5c0: 2022 636f 756e 7422 3a20 6c65 6e28 6b65   "count": len(ke
-0002d5d0: 7973 297d 290a 0a20 2020 2020 2020 2073  ys)})..        s
-0002d5e0: 7461 636b 203d 206c 6973 7428 6b65 7973  tack = list(keys
-0002d5f0: 290a 2020 2020 2020 2020 7365 656e 203d  ).        seen =
-0002d600: 2073 6574 2829 0a20 2020 2020 2020 2072   set().        r
-0002d610: 6f6f 7473 203d 205b 5d0a 2020 2020 2020  oots = [].      
-0002d620: 2020 7768 696c 6520 7374 6163 6b3a 0a20    while stack:. 
-0002d630: 2020 2020 2020 2020 2020 206b 6579 203d             key =
-0002d640: 2073 7461 636b 2e70 6f70 2829 0a20 2020   stack.pop().   
-0002d650: 2020 2020 2020 2020 2073 6565 6e2e 6164           seen.ad
-0002d660: 6428 6b65 7929 0a20 2020 2020 2020 2020  d(key).         
-0002d670: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
-0002d680: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
-0002d690: 2020 2020 6572 7265 645f 6465 7073 203d      erred_deps =
-0002d6a0: 205b 6474 732e 6b65 7920 666f 7220 6474   [dts.key for dt
-0002d6b0: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
-0002d6c0: 6369 6573 2069 6620 6474 732e 7374 6174  cies if dts.stat
-0002d6d0: 6520 3d3d 2022 6572 7265 6422 5d0a 2020  e == "erred"].  
-0002d6e0: 2020 2020 2020 2020 2020 6966 2065 7272            if err
-0002d6f0: 6564 5f64 6570 733a 0a20 2020 2020 2020  ed_deps:.       
-0002d700: 2020 2020 2020 2020 2073 7461 636b 2e65           stack.e
-0002d710: 7874 656e 6428 6572 7265 645f 6465 7073  xtend(erred_deps
-0002d720: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
-0002d730: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0002d740: 2020 2020 726f 6f74 732e 6170 7065 6e64      roots.append
-0002d750: 286b 6579 290a 0a20 2020 2020 2020 2072  (key)..        r
-0002d760: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-0002d770: 5265 6373 203d 207b 6b65 793a 2022 7761  Recs = {key: "wa
-0002d780: 6974 696e 6722 2066 6f72 206b 6579 2069  iting" for key i
-0002d790: 6e20 726f 6f74 737d 0a20 2020 2020 2020  n roots}.       
-0002d7a0: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-0002d7b0: 7328 7265 636f 6d6d 656e 6461 7469 6f6e  s(recommendation
-0002d7c0: 732c 2066 2273 7469 6d75 6c75 732d 7265  s, f"stimulus-re
-0002d7d0: 7472 792d 7b74 696d 6528 297d 2229 0a0a  try-{time()}")..
-0002d7e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0002d7f0: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-0002d800: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
-0002d810: 2073 6565 6e3a 0a20 2020 2020 2020 2020   seen:.         
-0002d820: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
-0002d830: 7420 7365 6c66 2e74 6173 6b73 5b6b 6579  t self.tasks[key
-0002d840: 5d2e 6578 6365 7074 696f 6e5f 626c 616d  ].exception_blam
-0002d850: 650a 0a20 2020 2020 2020 2072 6574 7572  e..        retur
-0002d860: 6e20 7475 706c 6528 7365 656e 290a 0a20  n tuple(seen).. 
-0002d870: 2020 2064 6566 2063 6c6f 7365 5f77 6f72     def close_wor
-0002d880: 6b65 7228 7365 6c66 2c20 776f 726b 6572  ker(self, worker
-0002d890: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
-0002d8a0: 2020 2020 2020 2020 2222 2241 736b 2061          """Ask a
-0002d8b0: 2077 6f72 6b65 7220 746f 2073 6875 7420   worker to shut 
-0002d8c0: 6974 7365 6c66 2064 6f77 6e2e 2044 6f20  itself down. Do 
-0002d8d0: 6e6f 7420 7761 6974 2066 6f72 2069 7420  not wait for it 
-0002d8e0: 746f 2074 616b 6520 6566 6665 6374 2e0a  to take effect..
-0002d8f0: 2020 2020 2020 2020 4e6f 7465 2074 6861          Note tha
-0002d900: 7420 7468 6572 6520 6973 206e 6f20 6775  t there is no gu
-0002d910: 6172 616e 7465 6520 7468 6174 2074 6865  arantee that the
-0002d920: 2077 6f72 6b65 7220 7769 6c6c 2061 6374   worker will act
-0002d930: 7561 6c6c 7920 6163 6365 7074 2074 6865  ually accept the
-0002d940: 0a20 2020 2020 2020 2063 6f6d 6d61 6e64  .        command
-0002d950: 2e0a 0a20 2020 2020 2020 204e 6f74 6520  ...        Note 
-0002d960: 7468 6174 203a 6d65 7468 3a60 7265 6d6f  that :meth:`remo
-0002d970: 7665 5f77 6f72 6b65 7260 2073 656e 6473  ve_worker` sends
-0002d980: 2074 6865 2073 616d 6520 636f 6d6d 616e   the same comman
-0002d990: 6420 696e 7465 726e 616c 6c79 2069 6620  d internally if 
-0002d9a0: 636c 6f73 653d 5472 7565 2e0a 0a20 2020  close=True...   
-0002d9b0: 2020 2020 2053 6565 2061 6c73 6f0a 2020       See also.  
-0002d9c0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-0002d9d0: 2020 2020 2020 2072 6574 6972 655f 776f         retire_wo
-0002d9e0: 726b 6572 730a 2020 2020 2020 2020 7265  rkers.        re
-0002d9f0: 6d6f 7665 5f77 6f72 6b65 720a 2020 2020  move_worker.    
-0002da00: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0002da10: 6966 2077 6f72 6b65 7220 6e6f 7420 696e  if worker not in
-0002da20: 2073 656c 662e 776f 726b 6572 733a 0a20   self.workers:. 
-0002da30: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0002da40: 6e0a 0a20 2020 2020 2020 206c 6f67 6765  n..        logge
-0002da50: 722e 696e 666f 2822 436c 6f73 696e 6720  r.info("Closing 
-0002da60: 776f 726b 6572 2025 7322 2c20 776f 726b  worker %s", work
-0002da70: 6572 290a 2020 2020 2020 2020 7365 6c66  er).        self
-0002da80: 2e6c 6f67 5f65 7665 6e74 2877 6f72 6b65  .log_event(worke
-0002da90: 722c 207b 2261 6374 696f 6e22 3a20 2263  r, {"action": "c
-0002daa0: 6c6f 7365 2d77 6f72 6b65 7222 7d29 0a20  lose-worker"}). 
-0002dab0: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
-0002dac0: 6572 5f73 656e 6428 776f 726b 6572 2c20  er_send(worker, 
-0002dad0: 7b22 6f70 223a 2022 636c 6f73 6522 2c20  {"op": "close", 
-0002dae0: 2272 6561 736f 6e22 3a20 2273 6368 6564  "reason": "sched
-0002daf0: 756c 6572 2d63 6c6f 7365 2d77 6f72 6b65  uler-close-worke
-0002db00: 7222 7d29 0a0a 2020 2020 406c 6f67 5f65  r"})..    @log_e
-0002db10: 7272 6f72 730a 2020 2020 6173 796e 6320  rrors.    async 
-0002db20: 6465 6620 7265 6d6f 7665 5f77 6f72 6b65  def remove_worke
-0002db30: 7228 0a20 2020 2020 2020 2073 656c 662c  r(.        self,
-0002db40: 2061 6464 7265 7373 3a20 7374 722c 202a   address: str, *
-0002db50: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-0002db60: 7472 2c20 7361 6665 3a20 626f 6f6c 203d  tr, safe: bool =
-0002db70: 2046 616c 7365 2c20 636c 6f73 653a 2062   False, close: b
-0002db80: 6f6f 6c20 3d20 5472 7565 0a20 2020 2029  ool = True.    )
-0002db90: 202d 3e20 4c69 7465 7261 6c5b 224f 4b22   -> Literal["OK"
-0002dba0: 2c20 2261 6c72 6561 6479 2d72 656d 6f76  , "already-remov
-0002dbb0: 6564 225d 3a0a 2020 2020 2020 2020 2222  ed"]:.        ""
-0002dbc0: 2252 656d 6f76 6520 776f 726b 6572 2066  "Remove worker f
-0002dbd0: 726f 6d20 636c 7573 7465 722e 0a0a 2020  rom cluster...  
-0002dbe0: 2020 2020 2020 5765 2064 6f20 7468 6973        We do this
-0002dbf0: 2077 6865 6e20 6120 776f 726b 6572 2072   when a worker r
-0002dc00: 6570 6f72 7473 2074 6861 7420 6974 2070  eports that it p
-0002dc10: 6c61 6e73 2074 6f20 6c65 6176 6520 6f72  lans to leave or
-0002dc20: 2077 6865 6e20 6974 2061 7070 6561 7273   when it appears
-0002dc30: 2074 6f20 6265 0a20 2020 2020 2020 2075   to be.        u
-0002dc40: 6e72 6573 706f 6e73 6976 652e 2054 6869  nresponsive. Thi
-0002dc50: 7320 6d61 7920 7365 6e64 2069 7473 2074  s may send its t
-0002dc60: 6173 6b73 2062 6163 6b20 746f 2061 2072  asks back to a r
-0002dc70: 656c 6561 7365 6420 7374 6174 652e 0a0a  eleased state...
-0002dc80: 2020 2020 2020 2020 5365 6520 616c 736f          See also
-0002dc90: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-0002dca0: 2d0a 2020 2020 2020 2020 7265 7469 7265  -.        retire
-0002dcb0: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
-0002dcc0: 2063 6c6f 7365 5f77 6f72 6b65 720a 2020   close_worker.  
-0002dcd0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0002dce0: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
-0002dcf0: 203d 3d20 5374 6174 7573 2e63 6c6f 7365   == Status.close
-0002dd00: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
-0002dd10: 6574 7572 6e20 2261 6c72 6561 6479 2d72  eturn "already-r
-0002dd20: 656d 6f76 6564 220a 0a20 2020 2020 2020  emoved"..       
-0002dd30: 2061 6464 7265 7373 203d 2073 656c 662e   address = self.
-0002dd40: 636f 6572 6365 5f61 6464 7265 7373 2861  coerce_address(a
-0002dd50: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
-0002dd60: 2069 6620 6164 6472 6573 7320 6e6f 7420   if address not 
-0002dd70: 696e 2073 656c 662e 776f 726b 6572 733a  in self.workers:
-0002dd80: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0002dd90: 7572 6e20 2261 6c72 6561 6479 2d72 656d  urn "already-rem
-0002dda0: 6f76 6564 220a 0a20 2020 2020 2020 2068  oved"..        h
-0002ddb0: 6f73 7420 3d20 6765 745f 6164 6472 6573  ost = get_addres
-0002ddc0: 735f 686f 7374 2861 6464 7265 7373 290a  s_host(address).
-0002ddd0: 0a20 2020 2020 2020 2077 7320 3d20 7365  .        ws = se
-0002dde0: 6c66 2e77 6f72 6b65 7273 5b61 6464 7265  lf.workers[addre
-0002ddf0: 7373 5d0a 0a20 2020 2020 2020 206c 6f67  ss]..        log
-0002de00: 6765 722e 696e 666f 2866 2252 656d 6f76  ger.info(f"Remov
-0002de10: 6520 776f 726b 6572 207b 7773 7d20 287b  e worker {ws} ({
-0002de20: 7374 696d 756c 7573 5f69 643d 7d29 2229  stimulus_id=})")
-0002de30: 0a20 2020 2020 2020 2069 6620 636c 6f73  .        if clos
-0002de40: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-0002de50: 6974 6820 7375 7070 7265 7373 2841 7474  ith suppress(Att
-0002de60: 7269 6275 7465 4572 726f 722c 2043 6f6d  ributeError, Com
-0002de70: 6d43 6c6f 7365 6445 7272 6f72 293a 0a20  mClosedError):. 
-0002de80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002de90: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
-0002dea0: 5b61 6464 7265 7373 5d2e 7365 6e64 280a  [address].send(.
-0002deb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002dec0: 2020 2020 7b22 6f70 223a 2022 636c 6f73      {"op": "clos
-0002ded0: 6522 2c20 2272 6561 736f 6e22 3a20 2273  e", "reason": "s
-0002dee0: 6368 6564 756c 6572 2d72 656d 6f76 652d  cheduler-remove-
-0002def0: 776f 726b 6572 227d 0a20 2020 2020 2020  worker"}.       
-0002df00: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0002df10: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
-0002df20: 7265 736f 7572 6365 7328 6164 6472 6573  resources(addres
-0002df30: 7329 0a0a 2020 2020 2020 2020 6468 203d  s)..        dh =
-0002df40: 2073 656c 662e 686f 7374 5f69 6e66 6f5b   self.host_info[
-0002df50: 686f 7374 5d0a 2020 2020 2020 2020 6468  host].        dh
-0002df60: 5f61 6464 7265 7373 6573 3a20 7365 7420  _addresses: set 
-0002df70: 3d20 6468 5b22 6164 6472 6573 7365 7322  = dh["addresses"
-0002df80: 5d0a 2020 2020 2020 2020 6468 5f61 6464  ].        dh_add
-0002df90: 7265 7373 6573 2e72 656d 6f76 6528 6164  resses.remove(ad
-0002dfa0: 6472 6573 7329 0a20 2020 2020 2020 2064  dress).        d
-0002dfb0: 685b 226e 7468 7265 6164 7322 5d20 2d3d  h["nthreads"] -=
-0002dfc0: 2077 732e 6e74 6872 6561 6473 0a20 2020   ws.nthreads.   
-0002dfd0: 2020 2020 2073 656c 662e 746f 7461 6c5f       self.total_
-0002dfe0: 6e74 6872 6561 6473 202d 3d20 7773 2e6e  nthreads -= ws.n
-0002dff0: 7468 7265 6164 730a 2020 2020 2020 2020  threads.        
-0002e000: 7365 6c66 2e74 6f74 616c 5f6e 7468 7265  self.total_nthre
-0002e010: 6164 735f 6869 7374 6f72 792e 6170 7065  ads_history.appe
-0002e020: 6e64 2828 7469 6d65 2829 2c20 7365 6c66  nd((time(), self
-0002e030: 2e74 6f74 616c 5f6e 7468 7265 6164 7329  .total_nthreads)
-0002e040: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0002e050: 2064 685f 6164 6472 6573 7365 733a 0a20   dh_addresses:. 
-0002e060: 2020 2020 2020 2020 2020 2064 656c 2073             del s
-0002e070: 656c 662e 686f 7374 5f69 6e66 6f5b 686f  elf.host_info[ho
-0002e080: 7374 5d0a 0a20 2020 2020 2020 2073 656c  st]..        sel
-0002e090: 662e 7270 632e 7265 6d6f 7665 2861 6464  f.rpc.remove(add
-0002e0a0: 7265 7373 290a 2020 2020 2020 2020 6465  ress).        de
-0002e0b0: 6c20 7365 6c66 2e73 7472 6561 6d5f 636f  l self.stream_co
-0002e0c0: 6d6d 735b 6164 6472 6573 735d 0a20 2020  mms[address].   
-0002e0d0: 2020 2020 2064 656c 2073 656c 662e 616c       del self.al
-0002e0e0: 6961 7365 735b 7773 2e6e 616d 655d 0a20  iases[ws.name]. 
-0002e0f0: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
-0002e100: 2e70 6f70 2877 732e 6164 6472 6573 732c  .pop(ws.address,
-0002e110: 204e 6f6e 6529 0a20 2020 2020 2020 2073   None).        s
-0002e120: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
-0002e130: 756e 742e 6469 7363 6172 6428 7773 290a  unt.discard(ws).
-0002e140: 2020 2020 2020 2020 7365 6c66 2e73 6174          self.sat
-0002e150: 7572 6174 6564 2e64 6973 6361 7264 2877  urated.discard(w
-0002e160: 7329 0a20 2020 2020 2020 2064 656c 2073  s).        del s
-0002e170: 656c 662e 776f 726b 6572 735b 6164 6472  elf.workers[addr
-0002e180: 6573 735d 0a20 2020 2020 2020 2077 732e  ess].        ws.
-0002e190: 7374 6174 7573 203d 2053 7461 7475 732e  status = Status.
-0002e1a0: 636c 6f73 6564 0a20 2020 2020 2020 2073  closed.        s
-0002e1b0: 656c 662e 7275 6e6e 696e 672e 6469 7363  elf.running.disc
-0002e1c0: 6172 6428 7773 290a 0a20 2020 2020 2020  ard(ws)..       
-0002e1d0: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
-0002e1e0: 3a20 5265 6373 203d 207b 7d0a 0a20 2020  : Recs = {}..   
-0002e1f0: 2020 2020 2070 726f 6365 7373 696e 675f       processing_
-0002e200: 6b65 7973 203d 207b 7473 2e6b 6579 2066  keys = {ts.key f
-0002e210: 6f72 2074 7320 696e 2077 732e 7072 6f63  or ts in ws.proc
-0002e220: 6573 7369 6e67 7d0a 2020 2020 2020 2020  essing}.        
-0002e230: 666f 7220 7473 2069 6e20 6c69 7374 2877  for ts in list(w
-0002e240: 732e 7072 6f63 6573 7369 6e67 293a 0a20  s.processing):. 
-0002e250: 2020 2020 2020 2020 2020 206b 203d 2074             k = t
-0002e260: 732e 6b65 790a 2020 2020 2020 2020 2020  s.key.          
-0002e270: 2020 7265 636f 6d6d 656e 6461 7469 6f6e    recommendation
-0002e280: 735b 6b5d 203d 2022 7265 6c65 6173 6564  s[k] = "released
-0002e290: 220a 2020 2020 2020 2020 2020 2020 6966  ".            if
-0002e2a0: 206e 6f74 2073 6166 653a 0a20 2020 2020   not safe:.     
-0002e2b0: 2020 2020 2020 2020 2020 2074 732e 7375             ts.su
-0002e2c0: 7370 6963 696f 7573 202b 3d20 310a 2020  spicious += 1.  
-0002e2d0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-0002e2e0: 2e70 7265 6669 782e 7375 7370 6963 696f  .prefix.suspicio
-0002e2f0: 7573 202b 3d20 310a 2020 2020 2020 2020  us += 1.        
-0002e300: 2020 2020 2020 2020 6966 2074 732e 7375          if ts.su
-0002e310: 7370 6963 696f 7573 203e 2073 656c 662e  spicious > self.
-0002e320: 616c 6c6f 7765 645f 6661 696c 7572 6573  allowed_failures
-0002e330: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002e340: 2020 2020 2020 6465 6c20 7265 636f 6d6d        del recomm
-0002e350: 656e 6461 7469 6f6e 735b 6b5d 0a20 2020  endations[k].   
-0002e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e370: 2065 203d 2070 6963 6b6c 652e 6475 6d70   e = pickle.dump
-0002e380: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-0002e390: 2020 2020 2020 2020 2020 204b 696c 6c65             Kille
-0002e3a0: 6457 6f72 6b65 7228 0a20 2020 2020 2020  dWorker(.       
-0002e3b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e3c0: 2020 2020 2074 6173 6b3d 6b2c 0a20 2020       task=k,.   
-0002e3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e3e0: 2020 2020 2020 2020 206c 6173 745f 776f           last_wo
-0002e3f0: 726b 6572 3d77 732e 636c 6561 6e28 292c  rker=ws.clean(),
-0002e400: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e410: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
-0002e420: 6f77 6564 5f66 6169 6c75 7265 733d 7365  owed_failures=se
-0002e430: 6c66 2e61 6c6c 6f77 6564 5f66 6169 6c75  lf.allowed_failu
-0002e440: 7265 732c 0a20 2020 2020 2020 2020 2020  res,.           
-0002e450: 2020 2020 2020 2020 2020 2020 2029 2c0a               ),.
-0002e460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e470: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0002e480: 2020 2020 2020 2020 2020 7220 3d20 7365            r = se
-0002e490: 6c66 2e74 7261 6e73 6974 696f 6e28 0a20  lf.transition(. 
-0002e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e4b0: 2020 2020 2020 206b 2c0a 2020 2020 2020         k,.      
-0002e4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e4d0: 2020 2265 7272 6564 222c 0a20 2020 2020    "erred",.     
-0002e4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e4f0: 2020 2065 7863 6570 7469 6f6e 3d65 2c0a     exception=e,.
-0002e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e510: 2020 2020 2020 2020 6361 7573 653d 6b2c          cause=k,
-0002e520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e530: 2020 2020 2020 2020 2073 7469 6d75 6c75           stimulu
-0002e540: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
-0002e550: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0002e560: 2020 2020 2020 2020 2020 776f 726b 6572            worker
-0002e570: 3d61 6464 7265 7373 2c0a 2020 2020 2020  =address,.      
-0002e580: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0002cec0: 2020 7d0a 2020 2020 2020 2020 2020 2020    }.            
+0002ced0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+0002cee0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0002cef0: 2020 2020 2020 2020 7265 636f 6d6d 656e          recommen
+0002cf00: 6461 7469 6f6e 735b 7473 2e6b 6579 5d20  dations[ts.key] 
+0002cf10: 3d20 2272 656c 6561 7365 6422 0a20 2020  = "released".   
+0002cf20: 2020 2020 2065 6c69 6620 7473 2e73 7461       elif ts.sta
+0002cf30: 7465 203d 3d20 226d 656d 6f72 7922 3a0a  te == "memory":.
+0002cf40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0002cf50: 2e61 6464 5f6b 6579 7328 776f 726b 6572  .add_keys(worker
+0002cf60: 3d77 6f72 6b65 722c 206b 6579 733d 5b6b  =worker, keys=[k
+0002cf70: 6579 5d29 0a20 2020 2020 2020 2065 6c73  ey]).        els
+0002cf80: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+0002cf90: 6620 6b77 6172 6773 5b22 6d65 7461 6461  f kwargs["metada
+0002cfa0: 7461 225d 3a0a 2020 2020 2020 2020 2020  ta"]:.          
+0002cfb0: 2020 2020 2020 6966 2074 732e 6d65 7461        if ts.meta
+0002cfc0: 6461 7461 2069 7320 4e6f 6e65 3a0a 2020  data is None:.  
+0002cfd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002cfe0: 2020 7473 2e6d 6574 6164 6174 6120 3d20    ts.metadata = 
+0002cff0: 6469 6374 2829 0a20 2020 2020 2020 2020  dict().         
+0002d000: 2020 2020 2020 2074 732e 6d65 7461 6461         ts.metada
+0002d010: 7461 2e75 7064 6174 6528 6b77 6172 6773  ta.update(kwargs
+0002d020: 5b22 6d65 7461 6461 7461 225d 290a 2020  ["metadata"]).  
+0002d030: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002d040: 2073 656c 662e 5f74 7261 6e73 6974 696f   self._transitio
+0002d050: 6e28 6b65 792c 2022 6d65 6d6f 7279 222c  n(key, "memory",
+0002d060: 2073 7469 6d75 6c75 735f 6964 2c20 776f   stimulus_id, wo
+0002d070: 726b 6572 3d77 6f72 6b65 722c 202a 2a6b  rker=worker, **k
+0002d080: 7761 7267 7329 0a0a 2020 2020 2020 2020  wargs)..        
+0002d090: 7265 7475 726e 2072 6563 6f6d 6d65 6e64  return recommend
+0002d0a0: 6174 696f 6e73 2c20 636c 6965 6e74 5f6d  ations, client_m
+0002d0b0: 7367 732c 2077 6f72 6b65 725f 6d73 6773  sgs, worker_msgs
+0002d0c0: 0a0a 2020 2020 6465 6620 7374 696d 756c  ..    def stimul
+0002d0d0: 7573 5f74 6173 6b5f 6572 7265 6428 0a20  us_task_erred(. 
+0002d0e0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0002d0f0: 2020 2020 206b 6579 3d4e 6f6e 652c 0a20       key=None,. 
+0002d100: 2020 2020 2020 2077 6f72 6b65 723d 4e6f         worker=No
+0002d110: 6e65 2c0a 2020 2020 2020 2020 6578 6365  ne,.        exce
+0002d120: 7074 696f 6e3d 4e6f 6e65 2c0a 2020 2020  ption=None,.    
+0002d130: 2020 2020 7374 696d 756c 7573 5f69 643d      stimulus_id=
+0002d140: 4e6f 6e65 2c0a 2020 2020 2020 2020 7472  None,.        tr
+0002d150: 6163 6562 6163 6b3d 4e6f 6e65 2c0a 2020  aceback=None,.  
+0002d160: 2020 2020 2020 7275 6e5f 6964 3d4e 6f6e        run_id=Non
+0002d170: 652c 0a20 2020 2020 2020 202a 2a6b 7761  e,.        **kwa
+0002d180: 7267 732c 0a20 2020 2029 3a0a 2020 2020  rgs,.    ):.    
+0002d190: 2020 2020 2222 224d 6172 6b20 7468 6174      """Mark that
+0002d1a0: 2061 2074 6173 6b20 6861 7320 6572 7265   a task has erre
+0002d1b0: 6420 6f6e 2061 2070 6172 7469 6375 6c61  d on a particula
+0002d1c0: 7220 776f 726b 6572 2222 220a 2020 2020  r worker""".    
+0002d1d0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+0002d1e0: 2822 5374 696d 756c 7573 2074 6173 6b20  ("Stimulus task 
+0002d1f0: 6572 7265 6420 2573 2c20 2573 222c 206b  erred %s, %s", k
+0002d200: 6579 2c20 776f 726b 6572 290a 0a20 2020  ey, worker)..   
+0002d210: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
+0002d220: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
+0002d230: 2020 2020 2020 6966 2074 7320 6973 204e        if ts is N
+0002d240: 6f6e 6520 6f72 2074 732e 7374 6174 6520  one or ts.state 
+0002d250: 213d 2022 7072 6f63 6573 7369 6e67 223a  != "processing":
+0002d260: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0002d270: 7572 6e20 7b7d 2c20 7b7d 2c20 7b7d 0a0a  urn {}, {}, {}..
+0002d280: 2020 2020 2020 2020 6966 2074 732e 7275          if ts.ru
+0002d290: 6e5f 6964 2021 3d20 7275 6e5f 6964 3a0a  n_id != run_id:.
+0002d2a0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0002d2b0: 732e 7072 6f63 6573 7369 6e67 5f6f 6e20  s.processing_on 
+0002d2c0: 616e 6420 7473 2e70 726f 6365 7373 696e  and ts.processin
+0002d2d0: 675f 6f6e 2e61 6464 7265 7373 203d 3d20  g_on.address == 
+0002d2e0: 776f 726b 6572 3a0a 2020 2020 2020 2020  worker:.        
+0002d2f0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0002d300: 656c 662e 5f74 7261 6e73 6974 696f 6e28  elf._transition(
+0002d310: 6b65 792c 2022 7265 6c65 6173 6564 222c  key, "released",
+0002d320: 2073 7469 6d75 6c75 735f 6964 290a 2020   stimulus_id).  
+0002d330: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0002d340: 207b 7d2c 207b 7d2c 207b 7d0a 0a20 2020   {}, {}, {}..   
+0002d350: 2020 2020 2069 6620 7473 2e72 6574 7269       if ts.retri
+0002d360: 6573 203e 2030 3a0a 2020 2020 2020 2020  es > 0:.        
+0002d370: 2020 2020 7473 2e72 6574 7269 6573 202d      ts.retries -
+0002d380: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+0002d390: 7265 7475 726e 2073 656c 662e 5f74 7261  return self._tra
+0002d3a0: 6e73 6974 696f 6e28 6b65 792c 2022 7761  nsition(key, "wa
+0002d3b0: 6974 696e 6722 2c20 7374 696d 756c 7573  iting", stimulus
+0002d3c0: 5f69 6429 0a20 2020 2020 2020 2065 6c73  _id).        els
+0002d3d0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+0002d3e0: 6574 7572 6e20 7365 6c66 2e5f 7472 616e  eturn self._tran
+0002d3f0: 7369 7469 6f6e 280a 2020 2020 2020 2020  sition(.        
+0002d400: 2020 2020 2020 2020 6b65 792c 0a20 2020          key,.   
+0002d410: 2020 2020 2020 2020 2020 2020 2022 6572               "er
+0002d420: 7265 6422 2c0a 2020 2020 2020 2020 2020  red",.          
+0002d430: 2020 2020 2020 7374 696d 756c 7573 5f69        stimulus_i
+0002d440: 642c 0a20 2020 2020 2020 2020 2020 2020  d,.             
+0002d450: 2020 2063 6175 7365 3d6b 6579 2c0a 2020     cause=key,.  
+0002d460: 2020 2020 2020 2020 2020 2020 2020 6578                ex
+0002d470: 6365 7074 696f 6e3d 6578 6365 7074 696f  ception=exceptio
+0002d480: 6e2c 0a20 2020 2020 2020 2020 2020 2020  n,.             
+0002d490: 2020 2074 7261 6365 6261 636b 3d74 7261     traceback=tra
+0002d4a0: 6365 6261 636b 2c0a 2020 2020 2020 2020  ceback,.        
+0002d4b0: 2020 2020 2020 2020 776f 726b 6572 3d77          worker=w
+0002d4c0: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
+0002d4d0: 2020 2020 2020 202a 2a6b 7761 7267 732c         **kwargs,
+0002d4e0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
+0002d4f0: 2020 2020 6465 6620 7374 696d 756c 7573      def stimulus
+0002d500: 5f72 6574 7279 280a 2020 2020 2020 2020  _retry(.        
+0002d510: 7365 6c66 2c20 6b65 7973 3a20 436f 6c6c  self, keys: Coll
+0002d520: 6563 7469 6f6e 5b4b 6579 5d2c 2063 6c69  ection[Key], cli
+0002d530: 656e 743a 2073 7472 207c 204e 6f6e 6520  ent: str | None 
+0002d540: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
+0002d550: 7475 706c 655b 4b65 792c 202e 2e2e 5d3a  tuple[Key, ...]:
+0002d560: 0a20 2020 2020 2020 206c 6f67 6765 722e  .        logger.
+0002d570: 696e 666f 2822 436c 6965 6e74 2025 7320  info("Client %s 
+0002d580: 7265 7175 6573 7473 2074 6f20 7265 7472  requests to retr
+0002d590: 7920 2564 206b 6579 7322 2c20 636c 6965  y %d keys", clie
+0002d5a0: 6e74 2c20 6c65 6e28 6b65 7973 2929 0a20  nt, len(keys)). 
+0002d5b0: 2020 2020 2020 2069 6620 636c 6965 6e74         if client
+0002d5c0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0002d5d0: 6c66 2e6c 6f67 5f65 7665 6e74 2863 6c69  lf.log_event(cli
+0002d5e0: 656e 742c 207b 2261 6374 696f 6e22 3a20  ent, {"action": 
+0002d5f0: 2272 6574 7279 222c 2022 636f 756e 7422  "retry", "count"
+0002d600: 3a20 6c65 6e28 6b65 7973 297d 290a 0a20  : len(keys)}).. 
+0002d610: 2020 2020 2020 2073 7461 636b 203d 206c         stack = l
+0002d620: 6973 7428 6b65 7973 290a 2020 2020 2020  ist(keys).      
+0002d630: 2020 7365 656e 203d 2073 6574 2829 0a20    seen = set(). 
+0002d640: 2020 2020 2020 2072 6f6f 7473 203d 205b         roots = [
+0002d650: 5d0a 2020 2020 2020 2020 7768 696c 6520  ].        while 
+0002d660: 7374 6163 6b3a 0a20 2020 2020 2020 2020  stack:.         
+0002d670: 2020 206b 6579 203d 2073 7461 636b 2e70     key = stack.p
+0002d680: 6f70 2829 0a20 2020 2020 2020 2020 2020  op().           
+0002d690: 2073 6565 6e2e 6164 6428 6b65 7929 0a20   seen.add(key). 
+0002d6a0: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
+0002d6b0: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
+0002d6c0: 2020 2020 2020 2020 2020 2020 6572 7265              erre
+0002d6d0: 645f 6465 7073 203d 205b 6474 732e 6b65  d_deps = [dts.ke
+0002d6e0: 7920 666f 7220 6474 7320 696e 2074 732e  y for dts in ts.
+0002d6f0: 6465 7065 6e64 656e 6369 6573 2069 6620  dependencies if 
+0002d700: 6474 732e 7374 6174 6520 3d3d 2022 6572  dts.state == "er
+0002d710: 7265 6422 5d0a 2020 2020 2020 2020 2020  red"].          
+0002d720: 2020 6966 2065 7272 6564 5f64 6570 733a    if erred_deps:
+0002d730: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002d740: 2073 7461 636b 2e65 7874 656e 6428 6572   stack.extend(er
+0002d750: 7265 645f 6465 7073 290a 2020 2020 2020  red_deps).      
+0002d760: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0002d770: 2020 2020 2020 2020 2020 2020 726f 6f74              root
+0002d780: 732e 6170 7065 6e64 286b 6579 290a 0a20  s.append(key).. 
+0002d790: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+0002d7a0: 6174 696f 6e73 3a20 5265 6373 203d 207b  ations: Recs = {
+0002d7b0: 6b65 793a 2022 7761 6974 696e 6722 2066  key: "waiting" f
+0002d7c0: 6f72 206b 6579 2069 6e20 726f 6f74 737d  or key in roots}
+0002d7d0: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
+0002d7e0: 616e 7369 7469 6f6e 7328 7265 636f 6d6d  ansitions(recomm
+0002d7f0: 656e 6461 7469 6f6e 732c 2066 2273 7469  endations, f"sti
+0002d800: 6d75 6c75 732d 7265 7472 792d 7b74 696d  mulus-retry-{tim
+0002d810: 6528 297d 2229 0a0a 2020 2020 2020 2020  e()}")..        
+0002d820: 6966 2073 656c 662e 7661 6c69 6461 7465  if self.validate
+0002d830: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
+0002d840: 7220 6b65 7920 696e 2073 6565 6e3a 0a20  r key in seen:. 
+0002d850: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0002d860: 7373 6572 7420 6e6f 7420 7365 6c66 2e74  ssert not self.t
+0002d870: 6173 6b73 5b6b 6579 5d2e 6578 6365 7074  asks[key].except
+0002d880: 696f 6e5f 626c 616d 650a 0a20 2020 2020  ion_blame..     
+0002d890: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
+0002d8a0: 7365 656e 290a 0a20 2020 2064 6566 2063  seen)..    def c
+0002d8b0: 6c6f 7365 5f77 6f72 6b65 7228 7365 6c66  lose_worker(self
+0002d8c0: 2c20 776f 726b 6572 3a20 7374 7229 202d  , worker: str) -
+0002d8d0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0002d8e0: 2222 2241 736b 2061 2077 6f72 6b65 7220  """Ask a worker 
+0002d8f0: 746f 2073 6875 7420 6974 7365 6c66 2064  to shut itself d
+0002d900: 6f77 6e2e 2044 6f20 6e6f 7420 7761 6974  own. Do not wait
+0002d910: 2066 6f72 2069 7420 746f 2074 616b 6520   for it to take 
+0002d920: 6566 6665 6374 2e0a 2020 2020 2020 2020  effect..        
+0002d930: 4e6f 7465 2074 6861 7420 7468 6572 6520  Note that there 
+0002d940: 6973 206e 6f20 6775 6172 616e 7465 6520  is no guarantee 
+0002d950: 7468 6174 2074 6865 2077 6f72 6b65 7220  that the worker 
+0002d960: 7769 6c6c 2061 6374 7561 6c6c 7920 6163  will actually ac
+0002d970: 6365 7074 2074 6865 0a20 2020 2020 2020  cept the.       
+0002d980: 2063 6f6d 6d61 6e64 2e0a 0a20 2020 2020   command...     
+0002d990: 2020 204e 6f74 6520 7468 6174 203a 6d65     Note that :me
+0002d9a0: 7468 3a60 7265 6d6f 7665 5f77 6f72 6b65  th:`remove_worke
+0002d9b0: 7260 2073 656e 6473 2074 6865 2073 616d  r` sends the sam
+0002d9c0: 6520 636f 6d6d 616e 6420 696e 7465 726e  e command intern
+0002d9d0: 616c 6c79 2069 6620 636c 6f73 653d 5472  ally if close=Tr
+0002d9e0: 7565 2e0a 0a20 2020 2020 2020 2053 6565  ue...        See
+0002d9f0: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
+0002da00: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2072  ------.        r
+0002da10: 6574 6972 655f 776f 726b 6572 730a 2020  etire_workers.  
+0002da20: 2020 2020 2020 7265 6d6f 7665 5f77 6f72        remove_wor
+0002da30: 6b65 720a 2020 2020 2020 2020 2222 220a  ker.        """.
+0002da40: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
+0002da50: 7220 6e6f 7420 696e 2073 656c 662e 776f  r not in self.wo
+0002da60: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
+0002da70: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
+0002da80: 2020 206c 6f67 6765 722e 696e 666f 2822     logger.info("
+0002da90: 436c 6f73 696e 6720 776f 726b 6572 2025  Closing worker %
+0002daa0: 7322 2c20 776f 726b 6572 290a 2020 2020  s", worker).    
+0002dab0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+0002dac0: 6e74 2877 6f72 6b65 722c 207b 2261 6374  nt(worker, {"act
+0002dad0: 696f 6e22 3a20 2263 6c6f 7365 2d77 6f72  ion": "close-wor
+0002dae0: 6b65 7222 7d29 0a20 2020 2020 2020 2073  ker"}).        s
+0002daf0: 656c 662e 776f 726b 6572 5f73 656e 6428  elf.worker_send(
+0002db00: 776f 726b 6572 2c20 7b22 6f70 223a 2022  worker, {"op": "
+0002db10: 636c 6f73 6522 2c20 2272 6561 736f 6e22  close", "reason"
+0002db20: 3a20 2273 6368 6564 756c 6572 2d63 6c6f  : "scheduler-clo
+0002db30: 7365 2d77 6f72 6b65 7222 7d29 0a0a 2020  se-worker"})..  
+0002db40: 2020 406c 6f67 5f65 7272 6f72 730a 2020    @log_errors.  
+0002db50: 2020 6173 796e 6320 6465 6620 7265 6d6f    async def remo
+0002db60: 7665 5f77 6f72 6b65 7228 0a20 2020 2020  ve_worker(.     
+0002db70: 2020 2073 656c 662c 2061 6464 7265 7373     self, address
+0002db80: 3a20 7374 722c 202a 2c20 7374 696d 756c  : str, *, stimul
+0002db90: 7573 5f69 643a 2073 7472 2c20 7361 6665  us_id: str, safe
+0002dba0: 3a20 626f 6f6c 203d 2046 616c 7365 2c20  : bool = False, 
+0002dbb0: 636c 6f73 653a 2062 6f6f 6c20 3d20 5472  close: bool = Tr
+0002dbc0: 7565 0a20 2020 2029 202d 3e20 4c69 7465  ue.    ) -> Lite
+0002dbd0: 7261 6c5b 224f 4b22 2c20 2261 6c72 6561  ral["OK", "alrea
+0002dbe0: 6479 2d72 656d 6f76 6564 225d 3a0a 2020  dy-removed"]:.  
+0002dbf0: 2020 2020 2020 2222 2252 656d 6f76 6520        """Remove 
+0002dc00: 776f 726b 6572 2066 726f 6d20 636c 7573  worker from clus
+0002dc10: 7465 722e 0a0a 2020 2020 2020 2020 5765  ter...        We
+0002dc20: 2064 6f20 7468 6973 2077 6865 6e20 6120   do this when a 
+0002dc30: 776f 726b 6572 2072 6570 6f72 7473 2074  worker reports t
+0002dc40: 6861 7420 6974 2070 6c61 6e73 2074 6f20  hat it plans to 
+0002dc50: 6c65 6176 6520 6f72 2077 6865 6e20 6974  leave or when it
+0002dc60: 2061 7070 6561 7273 2074 6f20 6265 0a20   appears to be. 
+0002dc70: 2020 2020 2020 2075 6e72 6573 706f 6e73         unrespons
+0002dc80: 6976 652e 2054 6869 7320 6d61 7920 7365  ive. This may se
+0002dc90: 6e64 2069 7473 2074 6173 6b73 2062 6163  nd its tasks bac
+0002dca0: 6b20 746f 2061 2072 656c 6561 7365 6420  k to a released 
+0002dcb0: 7374 6174 652e 0a0a 2020 2020 2020 2020  state...        
+0002dcc0: 5365 6520 616c 736f 0a20 2020 2020 2020  See also.       
+0002dcd0: 202d 2d2d 2d2d 2d2d 2d0a 2020 2020 2020   --------.      
+0002dce0: 2020 7265 7469 7265 5f77 6f72 6b65 7273    retire_workers
+0002dcf0: 0a20 2020 2020 2020 2063 6c6f 7365 5f77  .        close_w
+0002dd00: 6f72 6b65 720a 2020 2020 2020 2020 2222  orker.        ""
+0002dd10: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
+0002dd20: 662e 7374 6174 7573 203d 3d20 5374 6174  f.status == Stat
+0002dd30: 7573 2e63 6c6f 7365 643a 0a20 2020 2020  us.closed:.     
+0002dd40: 2020 2020 2020 2072 6574 7572 6e20 2261         return "a
+0002dd50: 6c72 6561 6479 2d72 656d 6f76 6564 220a  lready-removed".
+0002dd60: 0a20 2020 2020 2020 2061 6464 7265 7373  .        address
+0002dd70: 203d 2073 656c 662e 636f 6572 6365 5f61   = self.coerce_a
+0002dd80: 6464 7265 7373 2861 6464 7265 7373 290a  ddress(address).
+0002dd90: 0a20 2020 2020 2020 2069 6620 6164 6472  .        if addr
+0002dda0: 6573 7320 6e6f 7420 696e 2073 656c 662e  ess not in self.
+0002ddb0: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
+0002ddc0: 2020 2020 2072 6574 7572 6e20 2261 6c72       return "alr
+0002ddd0: 6561 6479 2d72 656d 6f76 6564 220a 0a20  eady-removed".. 
+0002dde0: 2020 2020 2020 2068 6f73 7420 3d20 6765         host = ge
+0002ddf0: 745f 6164 6472 6573 735f 686f 7374 2861  t_address_host(a
+0002de00: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
+0002de10: 2077 7320 3d20 7365 6c66 2e77 6f72 6b65   ws = self.worke
+0002de20: 7273 5b61 6464 7265 7373 5d0a 0a20 2020  rs[address]..   
+0002de30: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+0002de40: 2866 2252 656d 6f76 6520 776f 726b 6572  (f"Remove worker
+0002de50: 207b 7773 7d20 287b 7374 696d 756c 7573   {ws} ({stimulus
+0002de60: 5f69 643d 7d29 2229 0a20 2020 2020 2020  _id=})").       
+0002de70: 2069 6620 636c 6f73 653a 0a20 2020 2020   if close:.     
+0002de80: 2020 2020 2020 2077 6974 6820 7375 7070         with supp
+0002de90: 7265 7373 2841 7474 7269 6275 7465 4572  ress(AttributeEr
+0002dea0: 726f 722c 2043 6f6d 6d43 6c6f 7365 6445  ror, CommClosedE
+0002deb0: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
+0002dec0: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
+0002ded0: 616d 5f63 6f6d 6d73 5b61 6464 7265 7373  am_comms[address
+0002dee0: 5d2e 7365 6e64 280a 2020 2020 2020 2020  ].send(.        
+0002def0: 2020 2020 2020 2020 2020 2020 7b22 6f70              {"op
+0002df00: 223a 2022 636c 6f73 6522 2c20 2272 6561  ": "close", "rea
+0002df10: 736f 6e22 3a20 2273 6368 6564 756c 6572  son": "scheduler
+0002df20: 2d72 656d 6f76 652d 776f 726b 6572 227d  -remove-worker"}
+0002df30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002df40: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
+0002df50: 2e72 656d 6f76 655f 7265 736f 7572 6365  .remove_resource
+0002df60: 7328 6164 6472 6573 7329 0a0a 2020 2020  s(address)..    
+0002df70: 2020 2020 6468 203d 2073 656c 662e 686f      dh = self.ho
+0002df80: 7374 5f69 6e66 6f5b 686f 7374 5d0a 2020  st_info[host].  
+0002df90: 2020 2020 2020 6468 5f61 6464 7265 7373        dh_address
+0002dfa0: 6573 3a20 7365 7420 3d20 6468 5b22 6164  es: set = dh["ad
+0002dfb0: 6472 6573 7365 7322 5d0a 2020 2020 2020  dresses"].      
+0002dfc0: 2020 6468 5f61 6464 7265 7373 6573 2e72    dh_addresses.r
+0002dfd0: 656d 6f76 6528 6164 6472 6573 7329 0a20  emove(address). 
+0002dfe0: 2020 2020 2020 2064 685b 226e 7468 7265         dh["nthre
+0002dff0: 6164 7322 5d20 2d3d 2077 732e 6e74 6872  ads"] -= ws.nthr
+0002e000: 6561 6473 0a20 2020 2020 2020 2073 656c  eads.        sel
+0002e010: 662e 746f 7461 6c5f 6e74 6872 6561 6473  f.total_nthreads
+0002e020: 202d 3d20 7773 2e6e 7468 7265 6164 730a   -= ws.nthreads.
+0002e030: 2020 2020 2020 2020 7365 6c66 2e74 6f74          self.tot
+0002e040: 616c 5f6e 7468 7265 6164 735f 6869 7374  al_nthreads_hist
+0002e050: 6f72 792e 6170 7065 6e64 2828 7469 6d65  ory.append((time
+0002e060: 2829 2c20 7365 6c66 2e74 6f74 616c 5f6e  (), self.total_n
+0002e070: 7468 7265 6164 7329 290a 2020 2020 2020  threads)).      
+0002e080: 2020 6966 206e 6f74 2064 685f 6164 6472    if not dh_addr
+0002e090: 6573 7365 733a 0a20 2020 2020 2020 2020  esses:.         
+0002e0a0: 2020 2064 656c 2073 656c 662e 686f 7374     del self.host
+0002e0b0: 5f69 6e66 6f5b 686f 7374 5d0a 0a20 2020  _info[host]..   
+0002e0c0: 2020 2020 2073 656c 662e 7270 632e 7265       self.rpc.re
+0002e0d0: 6d6f 7665 2861 6464 7265 7373 290a 2020  move(address).  
+0002e0e0: 2020 2020 2020 6465 6c20 7365 6c66 2e73        del self.s
+0002e0f0: 7472 6561 6d5f 636f 6d6d 735b 6164 6472  tream_comms[addr
+0002e100: 6573 735d 0a20 2020 2020 2020 2064 656c  ess].        del
+0002e110: 2073 656c 662e 616c 6961 7365 735b 7773   self.aliases[ws
+0002e120: 2e6e 616d 655d 0a20 2020 2020 2020 2073  .name].        s
+0002e130: 656c 662e 6964 6c65 2e70 6f70 2877 732e  elf.idle.pop(ws.
+0002e140: 6164 6472 6573 732c 204e 6f6e 6529 0a20  address, None). 
+0002e150: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+0002e160: 5f74 6173 6b5f 636f 756e 742e 6469 7363  _task_count.disc
+0002e170: 6172 6428 7773 290a 2020 2020 2020 2020  ard(ws).        
+0002e180: 7365 6c66 2e73 6174 7572 6174 6564 2e64  self.saturated.d
+0002e190: 6973 6361 7264 2877 7329 0a20 2020 2020  iscard(ws).     
+0002e1a0: 2020 2064 656c 2073 656c 662e 776f 726b     del self.work
+0002e1b0: 6572 735b 6164 6472 6573 735d 0a20 2020  ers[address].   
+0002e1c0: 2020 2020 2077 732e 7374 6174 7573 203d       ws.status =
+0002e1d0: 2053 7461 7475 732e 636c 6f73 6564 0a20   Status.closed. 
+0002e1e0: 2020 2020 2020 2073 656c 662e 7275 6e6e         self.runn
+0002e1f0: 696e 672e 6469 7363 6172 6428 7773 290a  ing.discard(ws).
+0002e200: 0a20 2020 2020 2020 2072 6563 6f6d 6d65  .        recomme
+0002e210: 6e64 6174 696f 6e73 3a20 5265 6373 203d  ndations: Recs =
+0002e220: 207b 7d0a 0a20 2020 2020 2020 2070 726f   {}..        pro
+0002e230: 6365 7373 696e 675f 6b65 7973 203d 207b  cessing_keys = {
+0002e240: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
+0002e250: 2077 732e 7072 6f63 6573 7369 6e67 7d0a   ws.processing}.
+0002e260: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
+0002e270: 6e20 6c69 7374 2877 732e 7072 6f63 6573  n list(ws.proces
+0002e280: 7369 6e67 293a 0a20 2020 2020 2020 2020  sing):.         
+0002e290: 2020 206b 203d 2074 732e 6b65 790a 2020     k = ts.key.  
+0002e2a0: 2020 2020 2020 2020 2020 7265 636f 6d6d            recomm
+0002e2b0: 656e 6461 7469 6f6e 735b 6b5d 203d 2022  endations[k] = "
+0002e2c0: 7265 6c65 6173 6564 220a 2020 2020 2020  released".      
+0002e2d0: 2020 2020 2020 6966 206e 6f74 2073 6166        if not saf
+0002e2e0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002e2f0: 2020 2074 732e 7375 7370 6963 696f 7573     ts.suspicious
+0002e300: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+0002e310: 2020 2020 2020 7473 2e70 7265 6669 782e        ts.prefix.
+0002e320: 7375 7370 6963 696f 7573 202b 3d20 310a  suspicious += 1.
+0002e330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e340: 6966 2074 732e 7375 7370 6963 696f 7573  if ts.suspicious
+0002e350: 203e 2073 656c 662e 616c 6c6f 7765 645f   > self.allowed_
+0002e360: 6661 696c 7572 6573 3a0a 2020 2020 2020  failures:.      
+0002e370: 2020 2020 2020 2020 2020 2020 2020 6465                de
+0002e380: 6c20 7265 636f 6d6d 656e 6461 7469 6f6e  l recommendation
+0002e390: 735b 6b5d 0a20 2020 2020 2020 2020 2020  s[k].           
+0002e3a0: 2020 2020 2020 2020 2065 203d 2070 6963           e = pic
+0002e3b0: 6b6c 652e 6475 6d70 7328 0a20 2020 2020  kle.dumps(.     
+0002e3c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e3d0: 2020 204b 696c 6c65 6457 6f72 6b65 7228     KilledWorker(
+0002e3e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e3f0: 2020 2020 2020 2020 2020 2020 2074 6173               tas
+0002e400: 6b3d 6b2c 0a20 2020 2020 2020 2020 2020  k=k,.           
+0002e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e420: 206c 6173 745f 776f 726b 6572 3d77 732e   last_worker=ws.
+0002e430: 636c 6561 6e28 292c 0a20 2020 2020 2020  clean(),.       
+0002e440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e450: 2020 2020 2061 6c6c 6f77 6564 5f66 6169       allowed_fai
+0002e460: 6c75 7265 733d 7365 6c66 2e61 6c6c 6f77  lures=self.allow
+0002e470: 6564 5f66 6169 6c75 7265 732c 0a20 2020  ed_failures,.   
+0002e480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e490: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+0002e4a0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+0002e4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e4c0: 2020 7220 3d20 7365 6c66 2e74 7261 6e73    r = self.trans
+0002e4d0: 6974 696f 6e28 0a20 2020 2020 2020 2020  ition(.         
+0002e4e0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+0002e4f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002e500: 2020 2020 2020 2020 2020 2265 7272 6564            "erred
+0002e510: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0002e520: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+0002e530: 7469 6f6e 3d65 2c0a 2020 2020 2020 2020  tion=e,.        
+0002e540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e550: 6361 7573 653d 6b2c 0a20 2020 2020 2020  cause=k,.       
+0002e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e570: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
+0002e580: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
 0002e590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5a0: 2020 2020 7265 636f 6d6d 656e 6461 7469      recommendati
-0002e5b0: 6f6e 732e 7570 6461 7465 2872 290a 2020  ons.update(r).  
-0002e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5d0: 2020 6c6f 6767 6572 2e65 7272 6f72 280a    logger.error(.
-0002e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e5f0: 2020 2020 2020 2020 2254 6173 6b20 2573          "Task %s
-0002e600: 206d 6172 6b65 6420 6173 2066 6169 6c65   marked as faile
-0002e610: 6420 6265 6361 7573 6520 2564 2077 6f72  d because %d wor
-0002e620: 6b65 7273 2064 6965 6422 0a20 2020 2020  kers died".     
-0002e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e640: 2020 2022 2077 6869 6c65 2074 7279 696e     " while tryin
-0002e650: 6720 746f 2072 756e 2069 7422 2c0a 2020  g to run it",.  
-0002e660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e670: 2020 2020 2020 7473 2e6b 6579 2c0a 2020        ts.key,.  
-0002e680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e690: 2020 2020 2020 7473 2e73 7573 7069 6369        ts.suspici
-0002e6a0: 6f75 732c 0a20 2020 2020 2020 2020 2020  ous,.           
-0002e6b0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-0002e6c0: 2020 2020 7265 636f 6d70 7574 655f 6b65      recompute_ke
-0002e6d0: 7973 203d 2073 6574 2829 0a20 2020 2020  ys = set().     
-0002e6e0: 2020 206c 6f73 745f 6b65 7973 203d 2073     lost_keys = s
-0002e6f0: 6574 2829 0a0a 2020 2020 2020 2020 666f  et()..        fo
-0002e700: 7220 7473 2069 6e20 6c69 7374 2877 732e  r ts in list(ws.
-0002e710: 6861 735f 7768 6174 293a 0a20 2020 2020  has_what):.     
-0002e720: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
-0002e730: 7665 5f72 6570 6c69 6361 2874 732c 2077  ve_replica(ts, w
-0002e740: 7329 0a20 2020 2020 2020 2020 2020 2069  s).            i
-0002e750: 6620 6e6f 7420 7473 2e77 686f 5f68 6173  f not ts.who_has
-0002e760: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002e770: 2020 6966 2074 732e 7275 6e5f 7370 6563    if ts.run_spec
-0002e780: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002e790: 2020 2020 2020 7265 636f 6d70 7574 655f        recompute_
-0002e7a0: 6b65 7973 2e61 6464 2874 732e 6b65 7929  keys.add(ts.key)
-0002e7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002e7c0: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-0002e7d0: 696f 6e73 5b74 732e 6b65 795d 203d 2022  ions[ts.key] = "
-0002e7e0: 7265 6c65 6173 6564 220a 2020 2020 2020  released".      
-0002e7f0: 2020 2020 2020 2020 2020 656c 7365 3a20            else: 
-0002e800: 2023 2070 7572 6520 6461 7461 0a20 2020   # pure data.   
-0002e810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002e820: 206c 6f73 745f 6b65 7973 2e61 6464 2874   lost_keys.add(t
-0002e830: 732e 6b65 7929 0a20 2020 2020 2020 2020  s.key).         
-0002e840: 2020 2020 2020 2020 2020 2072 6563 6f6d             recom
-0002e850: 6d65 6e64 6174 696f 6e73 5b74 732e 6b65  mendations[ts.ke
-0002e860: 795d 203d 2022 666f 7267 6f74 7465 6e22  y] = "forgotten"
-0002e870: 0a0a 2020 2020 2020 2020 6966 2072 6563  ..        if rec
-0002e880: 6f6d 7075 7465 5f6b 6579 733a 0a20 2020  ompute_keys:.   
-0002e890: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-0002e8a0: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
-0002e8b0: 2020 2020 2020 2020 2066 2252 656d 6f76           f"Remov
-0002e8c0: 696e 6720 776f 726b 6572 207b 7773 2e61  ing worker {ws.a
-0002e8d0: 6464 7265 7373 2172 7d20 6361 7573 6564  ddress!r} caused
-0002e8e0: 2074 6865 2063 6c75 7374 6572 2074 6f20   the cluster to 
-0002e8f0: 6c6f 7365 2022 0a20 2020 2020 2020 2020  lose ".         
-0002e900: 2020 2020 2020 2022 616c 7265 6164 7920         "already 
-0002e910: 636f 6d70 7574 6564 2074 6173 6b28 7329  computed task(s)
-0002e920: 2c20 7768 6963 6820 7769 6c6c 2062 6520  , which will be 
-0002e930: 7265 636f 6d70 7574 6564 2065 6c73 6577  recomputed elsew
-0002e940: 6865 7265 3a20 220a 2020 2020 2020 2020  here: ".        
-0002e950: 2020 2020 2020 2020 6622 7b72 6563 6f6d          f"{recom
-0002e960: 7075 7465 5f6b 6579 737d 2028 7b73 7469  pute_keys} ({sti
-0002e970: 6d75 6c75 735f 6964 3d7d 2922 0a20 2020  mulus_id=})".   
-0002e980: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0002e990: 2020 2069 6620 6c6f 7374 5f6b 6579 733a     if lost_keys:
-0002e9a0: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
-0002e9b0: 6765 722e 6572 726f 7228 0a20 2020 2020  ger.error(.     
-0002e9c0: 2020 2020 2020 2020 2020 2066 2252 656d             f"Rem
-0002e9d0: 6f76 696e 6720 776f 726b 6572 207b 7773  oving worker {ws
-0002e9e0: 2e61 6464 7265 7373 2172 7d20 6361 7573  .address!r} caus
-0002e9f0: 6564 2074 6865 2063 6c75 7374 6572 2074  ed the cluster t
-0002ea00: 6f20 6c6f 7365 2073 6361 7474 6572 6564  o lose scattered
-0002ea10: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0002ea20: 2020 2066 2264 6174 612c 2077 6869 6368     f"data, which
-0002ea30: 2063 616e 2774 2062 6520 7265 636f 7665   can't be recove
-0002ea40: 7265 643a 207b 6c6f 7374 5f6b 6579 737d  red: {lost_keys}
-0002ea50: 2028 7b73 7469 6d75 6c75 735f 6964 3d7d   ({stimulus_id=}
-0002ea60: 2922 0a20 2020 2020 2020 2020 2020 2029  )".            )
-0002ea70: 0a0a 2020 2020 2020 2020 6576 656e 745f  ..        event_
-0002ea80: 6d73 6720 3d20 7b0a 2020 2020 2020 2020  msg = {.        
-0002ea90: 2020 2020 2261 6374 696f 6e22 3a20 2272      "action": "r
-0002eaa0: 656d 6f76 652d 776f 726b 6572 222c 0a20  emove-worker",. 
-0002eab0: 2020 2020 2020 2020 2020 2022 7072 6f63             "proc
-0002eac0: 6573 7369 6e67 2d74 6173 6b73 223a 2070  essing-tasks": p
-0002ead0: 726f 6365 7373 696e 675f 6b65 7973 2c0a  rocessing_keys,.
-0002eae0: 2020 2020 2020 2020 2020 2020 226c 6f73              "los
-0002eaf0: 742d 636f 6d70 7574 6564 2d74 6173 6b73  t-computed-tasks
-0002eb00: 223a 2072 6563 6f6d 7075 7465 5f6b 6579  ": recompute_key
-0002eb10: 732c 0a20 2020 2020 2020 2020 2020 2022  s,.            "
-0002eb20: 6c6f 7374 2d73 6361 7474 6572 6564 2d74  lost-scattered-t
-0002eb30: 6173 6b73 223a 206c 6f73 745f 6b65 7973  asks": lost_keys
-0002eb40: 2c0a 2020 2020 2020 2020 2020 2020 2273  ,.            "s
-0002eb50: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
-0002eb60: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
-0002eb70: 2020 7d0a 2020 2020 2020 2020 7365 6c66    }.        self
-0002eb80: 2e6c 6f67 5f65 7665 6e74 2861 6464 7265  .log_event(addre
-0002eb90: 7373 2c20 6576 656e 745f 6d73 672e 636f  ss, event_msg.co
-0002eba0: 7079 2829 290a 2020 2020 2020 2020 6576  py()).        ev
-0002ebb0: 656e 745f 6d73 675b 2277 6f72 6b65 7222  ent_msg["worker"
-0002ebc0: 5d20 3d20 6164 6472 6573 730a 2020 2020  ] = address.    
-0002ebd0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
-0002ebe0: 6e74 2822 616c 6c22 2c20 6576 656e 745f  nt("all", event_
-0002ebf0: 6d73 6729 0a0a 2020 2020 2020 2020 7365  msg)..        se
-0002ec00: 6c66 2e74 7261 6e73 6974 696f 6e73 2872  lf.transitions(r
-0002ec10: 6563 6f6d 6d65 6e64 6174 696f 6e73 2c20  ecommendations, 
-0002ec20: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
-0002ec30: 756c 7573 5f69 6429 0a0a 2020 2020 2020  ulus_id)..      
-0002ec40: 2020 6177 6169 7461 626c 6573 203d 205b    awaitables = [
-0002ec50: 5d0a 2020 2020 2020 2020 666f 7220 706c  ].        for pl
-0002ec60: 7567 696e 2069 6e20 6c69 7374 2873 656c  ugin in list(sel
-0002ec70: 662e 706c 7567 696e 732e 7661 6c75 6573  f.plugins.values
-0002ec80: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
-0002ec90: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-0002eca0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0002ecb0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0002ecc0: 6573 756c 7420 3d20 706c 7567 696e 2e72  esult = plugin.r
-0002ecd0: 656d 6f76 655f 776f 726b 6572 280a 2020  emove_worker(.  
-0002ece0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ecf0: 2020 2020 2020 7363 6865 6475 6c65 723d        scheduler=
-0002ed00: 7365 6c66 2c20 776f 726b 6572 3d61 6464  self, worker=add
-0002ed10: 7265 7373 2c20 7374 696d 756c 7573 5f69  ress, stimulus_i
-0002ed20: 643d 7374 696d 756c 7573 5f69 640a 2020  d=stimulus_id.  
-0002ed30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ed40: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0002ed50: 2020 2020 6578 6365 7074 2054 7970 6545      except TypeE
-0002ed60: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-0002ed70: 2020 2020 2020 2020 2020 7061 7261 6d65            parame
-0002ed80: 7465 7273 203d 2069 6e73 7065 6374 2e73  ters = inspect.s
-0002ed90: 6967 6e61 7475 7265 2870 6c75 6769 6e2e  ignature(plugin.
-0002eda0: 7265 6d6f 7665 5f77 6f72 6b65 7229 2e70  remove_worker).p
-0002edb0: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
-0002edc0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0002edd0: 2022 7374 696d 756c 7573 5f69 6422 206e   "stimulus_id" n
-0002ede0: 6f74 2069 6e20 7061 7261 6d65 7465 7273  ot in parameters
-0002edf0: 2061 6e64 206e 6f74 2061 6e79 280a 2020   and not any(.  
-0002ee00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ee10: 2020 2020 2020 702e 6b69 6e64 2069 7320        p.kind is 
-0002ee20: 702e 5641 525f 4b45 5957 4f52 4420 666f  p.VAR_KEYWORD fo
-0002ee30: 7220 7020 696e 2070 6172 616d 6574 6572  r p in parameter
-0002ee40: 732e 7661 6c75 6573 2829 0a20 2020 2020  s.values().     
-0002ee50: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0002ee60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0002ee70: 2020 2020 2020 2020 2020 2320 4465 7072            # Depr
-0002ee80: 6563 6174 6564 2028 7365 6520 6164 645f  ecated (see add_
-0002ee90: 706c 7567 696e 290a 2020 2020 2020 2020  plugin).        
+0002e5a0: 2020 776f 726b 6572 3d61 6464 7265 7373    worker=address
+0002e5b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002e5c0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0002e5d0: 2020 2020 2020 2020 2020 2020 7265 636f              reco
+0002e5e0: 6d6d 656e 6461 7469 6f6e 732e 7570 6461  mmendations.upda
+0002e5f0: 7465 2872 290a 2020 2020 2020 2020 2020  te(r).          
+0002e600: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+0002e610: 2e65 7272 6f72 280a 2020 2020 2020 2020  .error(.        
+0002e620: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e630: 2254 6173 6b20 2573 206d 6172 6b65 6420  "Task %s marked 
+0002e640: 6173 2066 6169 6c65 6420 6265 6361 7573  as failed becaus
+0002e650: 6520 2564 2077 6f72 6b65 7273 2064 6965  e %d workers die
+0002e660: 6422 0a20 2020 2020 2020 2020 2020 2020  d".             
+0002e670: 2020 2020 2020 2020 2020 2022 2077 6869             " whi
+0002e680: 6c65 2074 7279 696e 6720 746f 2072 756e  le trying to run
+0002e690: 2069 7422 2c0a 2020 2020 2020 2020 2020   it",.          
+0002e6a0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+0002e6b0: 2e6b 6579 2c0a 2020 2020 2020 2020 2020  .key,.          
+0002e6c0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+0002e6d0: 2e73 7573 7069 6369 6f75 732c 0a20 2020  .suspicious,.   
+0002e6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e6f0: 2029 0a0a 2020 2020 2020 2020 7265 636f   )..        reco
+0002e700: 6d70 7574 655f 6b65 7973 203d 2073 6574  mpute_keys = set
+0002e710: 2829 0a20 2020 2020 2020 206c 6f73 745f  ().        lost_
+0002e720: 6b65 7973 203d 2073 6574 2829 0a0a 2020  keys = set()..  
+0002e730: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+0002e740: 6c69 7374 2877 732e 6861 735f 7768 6174  list(ws.has_what
+0002e750: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+0002e760: 656c 662e 7265 6d6f 7665 5f72 6570 6c69  elf.remove_repli
+0002e770: 6361 2874 732c 2077 7329 0a20 2020 2020  ca(ts, ws).     
+0002e780: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
+0002e790: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
+0002e7a0: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
+0002e7b0: 7275 6e5f 7370 6563 3a0a 2020 2020 2020  run_spec:.      
+0002e7c0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0002e7d0: 636f 6d70 7574 655f 6b65 7973 2e61 6464  compute_keys.add
+0002e7e0: 2874 732e 6b65 7929 0a20 2020 2020 2020  (ts.key).       
+0002e7f0: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+0002e800: 6f6d 6d65 6e64 6174 696f 6e73 5b74 732e  ommendations[ts.
+0002e810: 6b65 795d 203d 2022 7265 6c65 6173 6564  key] = "released
+0002e820: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
+0002e830: 2020 656c 7365 3a20 2023 2070 7572 6520    else:  # pure 
+0002e840: 6461 7461 0a20 2020 2020 2020 2020 2020  data.           
+0002e850: 2020 2020 2020 2020 206c 6f73 745f 6b65           lost_ke
+0002e860: 7973 2e61 6464 2874 732e 6b65 7929 0a20  ys.add(ts.key). 
+0002e870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e880: 2020 2072 6563 6f6d 6d65 6e64 6174 696f     recommendatio
+0002e890: 6e73 5b74 732e 6b65 795d 203d 2022 666f  ns[ts.key] = "fo
+0002e8a0: 7267 6f74 7465 6e22 0a0a 2020 2020 2020  rgotten"..      
+0002e8b0: 2020 6966 2072 6563 6f6d 7075 7465 5f6b    if recompute_k
+0002e8c0: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
+0002e8d0: 206c 6f67 6765 722e 7761 726e 696e 6728   logger.warning(
+0002e8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002e8f0: 2066 2252 656d 6f76 696e 6720 776f 726b   f"Removing work
+0002e900: 6572 207b 7773 2e61 6464 7265 7373 2172  er {ws.address!r
+0002e910: 7d20 6361 7573 6564 2074 6865 2063 6c75  } caused the clu
+0002e920: 7374 6572 2074 6f20 6c6f 7365 2022 0a20  ster to lose ". 
+0002e930: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0002e940: 616c 7265 6164 7920 636f 6d70 7574 6564  already computed
+0002e950: 2074 6173 6b28 7329 2c20 7768 6963 6820   task(s), which 
+0002e960: 7769 6c6c 2062 6520 7265 636f 6d70 7574  will be recomput
+0002e970: 6564 2065 6c73 6577 6865 7265 3a20 220a  ed elsewhere: ".
+0002e980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002e990: 6622 7b72 6563 6f6d 7075 7465 5f6b 6579  f"{recompute_key
+0002e9a0: 737d 2028 7b73 7469 6d75 6c75 735f 6964  s} ({stimulus_id
+0002e9b0: 3d7d 2922 0a20 2020 2020 2020 2020 2020  =})".           
+0002e9c0: 2029 0a20 2020 2020 2020 2069 6620 6c6f   ).        if lo
+0002e9d0: 7374 5f6b 6579 733a 0a20 2020 2020 2020  st_keys:.       
+0002e9e0: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
+0002e9f0: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+0002ea00: 2020 2066 2252 656d 6f76 696e 6720 776f     f"Removing wo
+0002ea10: 726b 6572 207b 7773 2e61 6464 7265 7373  rker {ws.address
+0002ea20: 2172 7d20 6361 7573 6564 2074 6865 2063  !r} caused the c
+0002ea30: 6c75 7374 6572 2074 6f20 6c6f 7365 2073  luster to lose s
+0002ea40: 6361 7474 6572 6564 2022 0a20 2020 2020  cattered ".     
+0002ea50: 2020 2020 2020 2020 2020 2066 2264 6174             f"dat
+0002ea60: 612c 2077 6869 6368 2063 616e 2774 2062  a, which can't b
+0002ea70: 6520 7265 636f 7665 7265 643a 207b 6c6f  e recovered: {lo
+0002ea80: 7374 5f6b 6579 737d 2028 7b73 7469 6d75  st_keys} ({stimu
+0002ea90: 6c75 735f 6964 3d7d 2922 0a20 2020 2020  lus_id=})".     
+0002eaa0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0002eab0: 2020 6576 656e 745f 6d73 6720 3d20 7b0a    event_msg = {.
+0002eac0: 2020 2020 2020 2020 2020 2020 2261 6374              "act
+0002ead0: 696f 6e22 3a20 2272 656d 6f76 652d 776f  ion": "remove-wo
+0002eae0: 726b 6572 222c 0a20 2020 2020 2020 2020  rker",.         
+0002eaf0: 2020 2022 7072 6f63 6573 7369 6e67 2d74     "processing-t
+0002eb00: 6173 6b73 223a 2070 726f 6365 7373 696e  asks": processin
+0002eb10: 675f 6b65 7973 2c0a 2020 2020 2020 2020  g_keys,.        
+0002eb20: 2020 2020 226c 6f73 742d 636f 6d70 7574      "lost-comput
+0002eb30: 6564 2d74 6173 6b73 223a 2072 6563 6f6d  ed-tasks": recom
+0002eb40: 7075 7465 5f6b 6579 732c 0a20 2020 2020  pute_keys,.     
+0002eb50: 2020 2020 2020 2022 6c6f 7374 2d73 6361         "lost-sca
+0002eb60: 7474 6572 6564 2d74 6173 6b73 223a 206c  ttered-tasks": l
+0002eb70: 6f73 745f 6b65 7973 2c0a 2020 2020 2020  ost_keys,.      
+0002eb80: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
+0002eb90: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
+0002eba0: 2c0a 2020 2020 2020 2020 7d0a 2020 2020  ,.        }.    
+0002ebb0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+0002ebc0: 6e74 2861 6464 7265 7373 2c20 6576 656e  nt(address, even
+0002ebd0: 745f 6d73 672e 636f 7079 2829 290a 2020  t_msg.copy()).  
+0002ebe0: 2020 2020 2020 6576 656e 745f 6d73 675b        event_msg[
+0002ebf0: 2277 6f72 6b65 7222 5d20 3d20 6164 6472  "worker"] = addr
+0002ec00: 6573 730a 2020 2020 2020 2020 7365 6c66  ess.        self
+0002ec10: 2e6c 6f67 5f65 7665 6e74 2822 616c 6c22  .log_event("all"
+0002ec20: 2c20 6576 656e 745f 6d73 6729 0a0a 2020  , event_msg)..  
+0002ec30: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
+0002ec40: 6974 696f 6e73 2872 6563 6f6d 6d65 6e64  itions(recommend
+0002ec50: 6174 696f 6e73 2c20 7374 696d 756c 7573  ations, stimulus
+0002ec60: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
+0002ec70: 0a0a 2020 2020 2020 2020 6177 6169 7461  ..        awaita
+0002ec80: 626c 6573 203d 205b 5d0a 2020 2020 2020  bles = [].      
+0002ec90: 2020 666f 7220 706c 7567 696e 2069 6e20    for plugin in 
+0002eca0: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
+0002ecb0: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
+0002ecc0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0002ecd0: 2020 2020 2020 2020 2020 2020 2020 7472                tr
+0002ece0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0002ecf0: 2020 2020 2020 2072 6573 756c 7420 3d20         result = 
+0002ed00: 706c 7567 696e 2e72 656d 6f76 655f 776f  plugin.remove_wo
+0002ed10: 726b 6572 280a 2020 2020 2020 2020 2020  rker(.          
+0002ed20: 2020 2020 2020 2020 2020 2020 2020 7363                sc
+0002ed30: 6865 6475 6c65 723d 7365 6c66 2c20 776f  heduler=self, wo
+0002ed40: 726b 6572 3d61 6464 7265 7373 2c20 7374  rker=address, st
+0002ed50: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+0002ed60: 7573 5f69 640a 2020 2020 2020 2020 2020  us_id.          
+0002ed70: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+0002ed80: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+0002ed90: 7074 2054 7970 6545 7272 6f72 3a0a 2020  pt TypeError:.  
+0002eda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002edb0: 2020 7061 7261 6d65 7465 7273 203d 2069    parameters = i
+0002edc0: 6e73 7065 6374 2e73 6967 6e61 7475 7265  nspect.signature
+0002edd0: 2870 6c75 6769 6e2e 7265 6d6f 7665 5f77  (plugin.remove_w
+0002ede0: 6f72 6b65 7229 2e70 6172 616d 6574 6572  orker).parameter
+0002edf0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0002ee00: 2020 2020 2020 6966 2022 7374 696d 756c        if "stimul
+0002ee10: 7573 5f69 6422 206e 6f74 2069 6e20 7061  us_id" not in pa
+0002ee20: 7261 6d65 7465 7273 2061 6e64 206e 6f74  rameters and not
+0002ee30: 2061 6e79 280a 2020 2020 2020 2020 2020   any(.          
+0002ee40: 2020 2020 2020 2020 2020 2020 2020 702e                p.
+0002ee50: 6b69 6e64 2069 7320 702e 5641 525f 4b45  kind is p.VAR_KE
+0002ee60: 5957 4f52 4420 666f 7220 7020 696e 2070  YWORD for p in p
+0002ee70: 6172 616d 6574 6572 732e 7661 6c75 6573  arameters.values
+0002ee80: 2829 0a20 2020 2020 2020 2020 2020 2020  ().             
+0002ee90: 2020 2020 2020 2029 3a0a 2020 2020 2020         ):.      
 0002eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002eeb0: 7265 7375 6c74 203d 2070 6c75 6769 6e2e  result = plugin.
-0002eec0: 7265 6d6f 7665 5f77 6f72 6b65 7228 7363  remove_worker(sc
-0002eed0: 6865 6475 6c65 723d 7365 6c66 2c20 776f  heduler=self, wo
-0002eee0: 726b 6572 3d61 6464 7265 7373 2920 2023  rker=address)  #
-0002eef0: 2074 7970 653a 2069 676e 6f72 650a 2020   type: ignore.  
-0002ef00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ef10: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0002ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002ef30: 7261 6973 650a 2020 2020 2020 2020 2020  raise.          
-0002ef40: 2020 2020 2020 6966 2069 6e73 7065 6374        if inspect
-0002ef50: 2e69 7361 7761 6974 6162 6c65 2872 6573  .isawaitable(res
-0002ef60: 756c 7429 3a0a 2020 2020 2020 2020 2020  ult):.          
-0002ef70: 2020 2020 2020 2020 2020 6177 6169 7461            awaita
-0002ef80: 626c 6573 2e61 7070 656e 6428 7265 7375  bles.append(resu
-0002ef90: 6c74 290a 2020 2020 2020 2020 2020 2020  lt).            
-0002efa0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-0002efb0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-0002efc0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-0002efd0: 6365 7074 696f 6e28 6529 0a0a 2020 2020  ception(e)..    
-0002efe0: 2020 2020 706c 7567 696e 5f6d 7367 7320      plugin_msgs 
-0002eff0: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
-0002f000: 6761 7468 6572 282a 6177 6169 7461 626c  gather(*awaitabl
-0002f010: 6573 2c20 7265 7475 726e 5f65 7863 6570  es, return_excep
-0002f020: 7469 6f6e 733d 5472 7565 290a 2020 2020  tions=True).    
-0002f030: 2020 2020 706c 7567 696e 735f 6578 6365      plugins_exce
-0002f040: 7074 696f 6e73 203d 205b 6d73 6720 666f  ptions = [msg fo
-0002f050: 7220 6d73 6720 696e 2070 6c75 6769 6e5f  r msg in plugin_
-0002f060: 6d73 6773 2069 6620 6973 696e 7374 616e  msgs if isinstan
-0002f070: 6365 286d 7367 2c20 4578 6365 7074 696f  ce(msg, Exceptio
-0002f080: 6e29 5d0a 2020 2020 2020 2020 666f 7220  n)].        for 
-0002f090: 6578 6320 696e 2070 6c75 6769 6e73 5f65  exc in plugins_e
-0002f0a0: 7863 6570 7469 6f6e 733a 0a20 2020 2020  xceptions:.     
-0002f0b0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-0002f0c0: 6365 7074 696f 6e28 6578 632c 2065 7863  ception(exc, exc
-0002f0d0: 5f69 6e66 6f3d 6578 6329 0a0a 2020 2020  _info=exc)..    
-0002f0e0: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-0002f0f0: 776f 726b 6572 733a 0a20 2020 2020 2020  workers:.       
-0002f100: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-0002f110: 2822 4c6f 7374 2061 6c6c 2077 6f72 6b65  ("Lost all worke
-0002f120: 7273 2229 0a0a 2020 2020 2020 2020 666f  rs")..        fo
-0002f130: 7220 7720 696e 2073 656c 662e 776f 726b  r w in self.work
-0002f140: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-0002f150: 2073 656c 662e 6261 6e64 7769 6474 685f   self.bandwidth_
-0002f160: 776f 726b 6572 732e 706f 7028 2861 6464  workers.pop((add
-0002f170: 7265 7373 2c20 7729 2c20 4e6f 6e65 290a  ress, w), None).
-0002f180: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0002f190: 2e62 616e 6477 6964 7468 5f77 6f72 6b65  .bandwidth_worke
-0002f1a0: 7273 2e70 6f70 2828 772c 2061 6464 7265  rs.pop((w, addre
-0002f1b0: 7373 292c 204e 6f6e 6529 0a0a 2020 2020  ss), None)..    
-0002f1c0: 2020 2020 6173 796e 6320 6465 6620 7265      async def re
-0002f1d0: 6d6f 7665 5f77 6f72 6b65 725f 6672 6f6d  move_worker_from
-0002f1e0: 5f65 7665 6e74 7328 2920 2d3e 204e 6f6e  _events() -> Non
-0002f1f0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0002f200: 2049 6620 7468 6520 776f 726b 6572 2069   If the worker i
-0002f210: 736e 2774 2072 6567 6973 7465 7265 6420  sn't registered 
-0002f220: 616e 796d 6f72 6520 6166 7465 7220 7468  anymore after th
-0002f230: 6520 6465 6c61 792c 2072 656d 6f76 6520  e delay, remove 
-0002f240: 6672 6f6d 2065 7665 6e74 730a 2020 2020  from events.    
-0002f250: 2020 2020 2020 2020 6966 2061 6464 7265          if addre
-0002f260: 7373 206e 6f74 2069 6e20 7365 6c66 2e77  ss not in self.w
-0002f270: 6f72 6b65 7273 2061 6e64 2061 6464 7265  orkers and addre
-0002f280: 7373 2069 6e20 7365 6c66 2e65 7665 6e74  ss in self.event
-0002f290: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0002f2a0: 2020 2064 656c 2073 656c 662e 6576 656e     del self.even
-0002f2b0: 7473 5b61 6464 7265 7373 5d0a 0a20 2020  ts[address]..   
-0002f2c0: 2020 2020 2063 6c65 616e 7570 5f64 656c       cleanup_del
-0002f2d0: 6179 203d 2070 6172 7365 5f74 696d 6564  ay = parse_timed
-0002f2e0: 656c 7461 280a 2020 2020 2020 2020 2020  elta(.          
-0002f2f0: 2020 6461 736b 2e63 6f6e 6669 672e 6765    dask.config.ge
-0002f300: 7428 2264 6973 7472 6962 7574 6564 2e73  t("distributed.s
-0002f310: 6368 6564 756c 6572 2e65 7665 6e74 732d  cheduler.events-
-0002f320: 636c 6561 6e75 702d 6465 6c61 7922 290a  cleanup-delay").
-0002f330: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0002f340: 2020 2073 656c 662e 5f6f 6e67 6f69 6e67     self._ongoing
-0002f350: 5f62 6163 6b67 726f 756e 645f 7461 736b  _background_task
-0002f360: 732e 6361 6c6c 5f6c 6174 6572 280a 2020  s.call_later(.  
-0002f370: 2020 2020 2020 2020 2020 636c 6561 6e75            cleanu
-0002f380: 705f 6465 6c61 792c 2072 656d 6f76 655f  p_delay, remove_
-0002f390: 776f 726b 6572 5f66 726f 6d5f 6576 656e  worker_from_even
-0002f3a0: 7473 0a20 2020 2020 2020 2029 0a20 2020  ts.        ).   
-0002f3b0: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-0002f3c0: 6728 2252 656d 6f76 6564 2077 6f72 6b65  g("Removed worke
-0002f3d0: 7220 2573 222c 2077 7329 0a0a 2020 2020  r %s", ws)..    
-0002f3e0: 2020 2020 666f 7220 7720 696e 2073 656c      for w in sel
-0002f3f0: 662e 776f 726b 6572 733a 0a20 2020 2020  f.workers:.     
-0002f400: 2020 2020 2020 2073 656c 662e 776f 726b         self.work
-0002f410: 6572 5f73 656e 6428 0a20 2020 2020 2020  er_send(.       
-0002f420: 2020 2020 2020 2020 2077 2c0a 2020 2020           w,.    
-0002f430: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
-0002f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f450: 2020 226f 7022 3a20 2272 656d 6f76 652d    "op": "remove-
-0002f460: 776f 726b 6572 222c 0a20 2020 2020 2020  worker",.       
-0002f470: 2020 2020 2020 2020 2020 2020 2022 776f               "wo
-0002f480: 726b 6572 223a 2061 6464 7265 7373 2c0a  rker": address,.
-0002f490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f4a0: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
-0002f4b0: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
-0002f4c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f4d0: 7d2c 0a20 2020 2020 2020 2020 2020 2029  },.            )
-0002f4e0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-0002f4f0: 2022 4f4b 220a 0a20 2020 2064 6566 2073   "OK"..    def s
-0002f500: 7469 6d75 6c75 735f 6361 6e63 656c 280a  timulus_cancel(.
-0002f510: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
-0002f520: 7973 3a20 436f 6c6c 6563 7469 6f6e 5b4b  ys: Collection[K
-0002f530: 6579 5d2c 2063 6c69 656e 743a 2073 7472  ey], client: str
-0002f540: 2c20 666f 7263 653a 2062 6f6f 6c20 3d20  , force: bool = 
-0002f550: 4661 6c73 650a 2020 2020 2920 2d3e 204e  False.    ) -> N
-0002f560: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-0002f570: 5374 6f70 2065 7865 6375 7469 6f6e 206f  Stop execution o
-0002f580: 6e20 6120 6c69 7374 206f 6620 6b65 7973  n a list of keys
-0002f590: 2222 220a 2020 2020 2020 2020 6c6f 6767  """.        logg
-0002f5a0: 6572 2e69 6e66 6f28 2243 6c69 656e 7420  er.info("Client 
-0002f5b0: 2573 2072 6571 7565 7374 7320 746f 2063  %s requests to c
-0002f5c0: 616e 6365 6c20 2564 206b 6579 7322 2c20  ancel %d keys", 
-0002f5d0: 636c 6965 6e74 2c20 6c65 6e28 6b65 7973  client, len(keys
-0002f5e0: 2929 0a20 2020 2020 2020 2073 656c 662e  )).        self.
-0002f5f0: 6c6f 675f 6576 656e 7428 636c 6965 6e74  log_event(client
-0002f600: 2c20 7b22 6163 7469 6f6e 223a 2022 6361  , {"action": "ca
-0002f610: 6e63 656c 222c 2022 636f 756e 7422 3a20  ncel", "count": 
-0002f620: 6c65 6e28 6b65 7973 292c 2022 666f 7263  len(keys), "forc
-0002f630: 6522 3a20 666f 7263 657d 290a 2020 2020  e": force}).    
-0002f640: 2020 2020 6373 203d 2073 656c 662e 636c      cs = self.cl
-0002f650: 6965 6e74 732e 6765 7428 636c 6965 6e74  ients.get(client
-0002f660: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
-0002f670: 2063 733a 0a20 2020 2020 2020 2020 2020   cs:.           
-0002f680: 2072 6574 7572 6e0a 0a20 2020 2020 2020   return..       
-0002f690: 2063 616e 6365 6c6c 6564 5f6b 6579 7320   cancelled_keys 
-0002f6a0: 3d20 5b5d 0a20 2020 2020 2020 2063 6c69  = [].        cli
-0002f6b0: 656e 7473 203d 205b 5d0a 2020 2020 2020  ents = [].      
-0002f6c0: 2020 666f 7220 6b65 7920 696e 206b 6579    for key in key
-0002f6d0: 733a 0a20 2020 2020 2020 2020 2020 2074  s:.            t
-0002f6e0: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
-0002f6f0: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
-0002f700: 2020 2020 6966 206e 6f74 2074 733a 0a20      if not ts:. 
-0002f710: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0002f720: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
-0002f730: 2020 2020 2069 6620 666f 7263 6520 6f72       if force or
-0002f740: 2074 732e 7768 6f5f 7761 6e74 7320 3d3d   ts.who_wants ==
-0002f750: 207b 6373 7d3a 2020 2320 6e6f 206f 6e65   {cs}:  # no one
-0002f760: 2065 6c73 6520 7761 6e74 7320 7468 6973   else wants this
-0002f770: 206b 6579 0a20 2020 2020 2020 2020 2020   key.           
-0002f780: 2020 2020 2069 6620 7473 2e64 6570 656e       if ts.depen
-0002f790: 6465 6e74 733a 0a20 2020 2020 2020 2020  dents:.         
-0002f7a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0002f7b0: 7374 696d 756c 7573 5f63 616e 6365 6c28  stimulus_cancel(
-0002f7c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f7d0: 2020 2020 2020 2020 205b 6474 732e 6b65           [dts.ke
-0002f7e0: 7920 666f 7220 6474 7320 696e 2074 732e  y for dts in ts.
-0002f7f0: 6465 7065 6e64 656e 7473 5d2c 2063 6c69  dependents], cli
-0002f800: 656e 742c 2066 6f72 6365 3d66 6f72 6365  ent, force=force
-0002f810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0002f820: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-0002f830: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
-0002f840: 666f 2822 5363 6865 6475 6c65 7220 6361  fo("Scheduler ca
-0002f850: 6e63 656c 7320 6b65 7920 2573 2e20 2046  ncels key %s.  F
-0002f860: 6f72 6365 3d25 7322 2c20 6b65 792c 2066  orce=%s", key, f
-0002f870: 6f72 6365 290a 2020 2020 2020 2020 2020  orce).          
-0002f880: 2020 2020 2020 6361 6e63 656c 6c65 645f        cancelled_
-0002f890: 6b65 7973 2e61 7070 656e 6428 6b65 7929  keys.append(key)
-0002f8a0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-0002f8b0: 6572 7420 7473 2e77 686f 5f77 616e 7473  ert ts.who_wants
-0002f8c0: 0a20 2020 2020 2020 2020 2020 2063 6c69  .            cli
-0002f8d0: 656e 7473 2e65 7874 656e 6428 6c69 7374  ents.extend(list
-0002f8e0: 2874 732e 7768 6f5f 7761 6e74 7329 2069  (ts.who_wants) i
-0002f8f0: 6620 666f 7263 6520 656c 7365 205b 6373  f force else [cs
-0002f900: 5d29 0a20 2020 2020 2020 2066 6f72 2063  ]).        for c
-0002f910: 7320 696e 2063 6c69 656e 7473 3a0a 2020  s in clients:.  
-0002f920: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
-0002f930: 6c69 656e 745f 7265 6c65 6173 6573 5f6b  lient_releases_k
-0002f940: 6579 7328 0a20 2020 2020 2020 2020 2020  eys(.           
-0002f950: 2020 2020 206b 6579 733d 6361 6e63 656c       keys=cancel
-0002f960: 6c65 645f 6b65 7973 2c0a 2020 2020 2020  led_keys,.      
-0002f970: 2020 2020 2020 2020 2020 636c 6965 6e74            client
-0002f980: 3d63 732e 636c 6965 6e74 5f6b 6579 2c0a  =cs.client_key,.
-0002f990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0002f9a0: 7374 696d 756c 7573 5f69 643d 6622 6361  stimulus_id=f"ca
-0002f9b0: 6e63 656c 2d6b 6579 2d7b 7469 6d65 2829  ncel-key-{time()
-0002f9c0: 7d22 2c0a 2020 2020 2020 2020 2020 2020  }",.            
-0002f9d0: 290a 2020 2020 2020 2020 7365 6c66 2e72  ).        self.r
-0002f9e0: 6570 6f72 7428 7b22 6f70 223a 2022 6361  eport({"op": "ca
-0002f9f0: 6e63 656c 6c65 642d 6b65 7973 222c 2022  ncelled-keys", "
-0002fa00: 6b65 7973 223a 2063 616e 6365 6c6c 6564  keys": cancelled
-0002fa10: 5f6b 6579 737d 290a 0a20 2020 2064 6566  _keys})..    def
-0002fa20: 2063 6c69 656e 745f 6465 7369 7265 735f   client_desires_
-0002fa30: 6b65 7973 2873 656c 662c 206b 6579 733a  keys(self, keys:
-0002fa40: 2043 6f6c 6c65 6374 696f 6e5b 4b65 795d   Collection[Key]
-0002fa50: 2c20 636c 6965 6e74 3a20 7374 7229 202d  , client: str) -
-0002fa60: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0002fa70: 6373 203d 2073 656c 662e 636c 6965 6e74  cs = self.client
-0002fa80: 732e 6765 7428 636c 6965 6e74 290a 2020  s.get(client).  
-0002fa90: 2020 2020 2020 6966 2063 7320 6973 204e        if cs is N
-0002faa0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0002fab0: 2023 2046 6f72 2070 7562 6c69 7368 2c20   # For publish, 
-0002fac0: 7175 6575 6573 2065 7463 2e0a 2020 2020  queues etc..    
-0002fad0: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-0002fae0: 656e 7473 5b63 6c69 656e 745d 203d 2063  ents[client] = c
-0002faf0: 7320 3d20 436c 6965 6e74 5374 6174 6528  s = ClientState(
-0002fb00: 636c 6965 6e74 290a 0a20 2020 2020 2020  client)..       
-0002fb10: 2066 6f72 206b 2069 6e20 6b65 7973 3a0a   for k in keys:.
-0002fb20: 2020 2020 2020 2020 2020 2020 7473 203d              ts =
-0002fb30: 2073 656c 662e 7461 736b 732e 6765 7428   self.tasks.get(
-0002fb40: 6b29 0a20 2020 2020 2020 2020 2020 2069  k).            i
-0002fb50: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
-0002fb60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0002fb70: 466f 7220 7075 626c 6973 682c 2071 7565  For publish, que
-0002fb80: 7565 7320 6574 632e 0a20 2020 2020 2020  ues etc..       
-0002fb90: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
-0002fba0: 6c66 2e6e 6577 5f74 6173 6b28 6b2c 204e  lf.new_task(k, N
-0002fbb0: 6f6e 652c 2022 7265 6c65 6173 6564 2229  one, "released")
-0002fbc0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0002fbd0: 7473 2e77 686f 5f77 616e 7473 2069 7320  ts.who_wants is 
-0002fbe0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0002fbf0: 2020 2020 2020 7473 2e77 686f 5f77 616e        ts.who_wan
-0002fc00: 7473 203d 2073 6574 2829 0a20 2020 2020  ts = set().     
-0002fc10: 2020 2020 2020 2074 732e 7768 6f5f 7761         ts.who_wa
-0002fc20: 6e74 732e 6164 6428 6373 290a 2020 2020  nts.add(cs).    
-0002fc30: 2020 2020 2020 2020 6373 2e77 616e 7473          cs.wants
-0002fc40: 5f77 6861 742e 6164 6428 7473 290a 0a20  _what.add(ts).. 
-0002fc50: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-0002fc60: 2e73 7461 7465 2069 6e20 2822 6d65 6d6f  .state in ("memo
-0002fc70: 7279 222c 2022 6572 7265 6422 293a 0a20  ry", "erred"):. 
-0002fc80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0002fc90: 656c 662e 7265 706f 7274 5f6f 6e5f 6b65  elf.report_on_ke
-0002fca0: 7928 7473 3d74 732c 2063 6c69 656e 743d  y(ts=ts, client=
-0002fcb0: 636c 6965 6e74 290a 0a20 2020 2064 6566  client)..    def
-0002fcc0: 2063 6c69 656e 745f 7265 6c65 6173 6573   client_releases
-0002fcd0: 5f6b 6579 7328 0a20 2020 2020 2020 2073  _keys(.        s
-0002fce0: 656c 662c 206b 6579 733a 2043 6f6c 6c65  elf, keys: Colle
-0002fcf0: 6374 696f 6e5b 4b65 795d 2c20 636c 6965  ction[Key], clie
-0002fd00: 6e74 3a20 7374 722c 2073 7469 6d75 6c75  nt: str, stimulu
-0002fd10: 735f 6964 3a20 7374 7220 7c20 4e6f 6e65  s_id: str | None
-0002fd20: 203d 204e 6f6e 650a 2020 2020 2920 2d3e   = None.    ) ->
-0002fd30: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0002fd40: 2222 5265 6d6f 7665 206b 6579 7320 6672  ""Remove keys fr
-0002fd50: 6f6d 2063 6c69 656e 7420 6465 7369 7265  om client desire
-0002fd60: 6420 6c69 7374 2222 220a 2020 2020 2020  d list""".      
-0002fd70: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-0002fd80: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
-0002fd90: 2263 6c69 656e 742d 7265 6c65 6173 6573  "client-releases
-0002fda0: 2d6b 6579 732d 7b74 696d 6528 297d 220a  -keys-{time()}".
-0002fdb0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-0002fdc0: 7369 6e73 7461 6e63 6528 6b65 7973 2c20  sinstance(keys, 
-0002fdd0: 6c69 7374 293a 0a20 2020 2020 2020 2020  list):.         
-0002fde0: 2020 206b 6579 7320 3d20 6c69 7374 286b     keys = list(k
-0002fdf0: 6579 7329 0a20 2020 2020 2020 2063 7320  eys).        cs 
-0002fe00: 3d20 7365 6c66 2e63 6c69 656e 7473 5b63  = self.clients[c
-0002fe10: 6c69 656e 745d 0a20 2020 2020 2020 2072  lient].        r
-0002fe20: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-0002fe30: 5265 6373 203d 207b 7d0a 0a20 2020 2020  Recs = {}..     
-0002fe40: 2020 2073 656c 662e 5f63 6c69 656e 745f     self._client_
-0002fe50: 7265 6c65 6173 6573 5f6b 6579 7328 6b65  releases_keys(ke
-0002fe60: 7973 3d6b 6579 732c 2063 733d 6373 2c20  ys=keys, cs=cs, 
-0002fe70: 7265 636f 6d6d 656e 6461 7469 6f6e 733d  recommendations=
-0002fe80: 7265 636f 6d6d 656e 6461 7469 6f6e 7329  recommendations)
-0002fe90: 0a20 2020 2020 2020 2073 656c 662e 7472  .        self.tr
-0002fea0: 616e 7369 7469 6f6e 7328 7265 636f 6d6d  ansitions(recomm
-0002feb0: 656e 6461 7469 6f6e 732c 2073 7469 6d75  endations, stimu
-0002fec0: 6c75 735f 6964 290a 0a20 2020 2020 2020  lus_id)..       
-0002fed0: 2073 656c 662e 7374 696d 756c 7573 5f71   self.stimulus_q
-0002fee0: 7565 7565 5f73 6c6f 7473 5f6d 6179 6265  ueue_slots_maybe
-0002fef0: 5f6f 7065 6e65 6428 7374 696d 756c 7573  _opened(stimulus
-0002ff00: 5f69 643d 7374 696d 756c 7573 5f69 6429  _id=stimulus_id)
-0002ff10: 0a0a 2020 2020 6465 6620 636c 6965 6e74  ..    def client
-0002ff20: 5f68 6561 7274 6265 6174 2873 656c 662c  _heartbeat(self,
-0002ff30: 2063 6c69 656e 743a 2073 7472 2920 2d3e   client: str) ->
-0002ff40: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-0002ff50: 2222 4861 6e64 6c65 2068 6561 7274 6265  ""Handle heartbe
-0002ff60: 6174 7320 6672 6f6d 2043 6c69 656e 7422  ats from Client"
-0002ff70: 2222 0a20 2020 2020 2020 2063 7320 3d20  "".        cs = 
-0002ff80: 7365 6c66 2e63 6c69 656e 7473 5b63 6c69  self.clients[cli
-0002ff90: 656e 745d 0a20 2020 2020 2020 2063 732e  ent].        cs.
-0002ffa0: 6c61 7374 5f73 6565 6e20 3d20 7469 6d65  last_seen = time
-0002ffb0: 2829 0a0a 2020 2020 2323 2323 2323 2323  ()..    ########
-0002ffc0: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
-0002ffd0: 2320 5461 736b 2056 616c 6964 6174 696f  # Task Validatio
-0002ffe0: 6e20 230a 2020 2020 2323 2323 2323 2323  n #.    ########
-0002fff0: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
-00030000: 2064 6566 2076 616c 6964 6174 655f 7265   def validate_re
-00030010: 6c65 6173 6564 2873 656c 662c 206b 6579  leased(self, key
-00030020: 3a20 4b65 7929 202d 3e20 4e6f 6e65 3a0a  : Key) -> None:.
-00030030: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00030040: 662e 7461 736b 735b 6b65 795d 0a20 2020  f.tasks[key].   
-00030050: 2020 2020 2061 7373 6572 7420 7473 2e73       assert ts.s
-00030060: 7461 7465 203d 3d20 2272 656c 6561 7365  tate == "release
-00030070: 6422 0a20 2020 2020 2020 2061 7373 6572  d".        asser
-00030080: 7420 6e6f 7420 7473 2e77 6169 7465 7273  t not ts.waiters
-00030090: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000300a0: 6e6f 7420 7473 2e77 6169 7469 6e67 5f6f  not ts.waiting_o
-000300b0: 6e0a 2020 2020 2020 2020 6173 7365 7274  n.        assert
-000300c0: 206e 6f74 2074 732e 7768 6f5f 6861 730a   not ts.who_has.
-000300d0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-000300e0: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
-000300f0: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
-00030100: 7274 206e 6f74 2061 6e79 285b 7473 2069  rt not any([ts i
-00030110: 6e20 2864 7473 2e77 6169 7465 7273 206f  n (dts.waiters o
-00030120: 7220 2829 2920 666f 7220 6474 7320 696e  r ()) for dts in
-00030130: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-00030140: 5d29 0a20 2020 2020 2020 2061 7373 6572  ]).        asser
-00030150: 7420 7473 206e 6f74 2069 6e20 7365 6c66  t ts not in self
-00030160: 2e75 6e72 756e 6e61 626c 650a 2020 2020  .unrunnable.    
-00030170: 2020 2020 6173 7365 7274 2074 7320 6e6f      assert ts no
-00030180: 7420 696e 2073 656c 662e 7175 6575 6564  t in self.queued
-00030190: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
-000301a0: 7465 5f77 6169 7469 6e67 2873 656c 662c  te_waiting(self,
-000301b0: 206b 6579 3a20 4b65 7929 202d 3e20 4e6f   key: Key) -> No
-000301c0: 6e65 3a0a 2020 2020 2020 2020 7473 203d  ne:.        ts =
-000301d0: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
-000301e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000301f0: 7473 2e77 6169 7469 6e67 5f6f 6e0a 2020  ts.waiting_on.  
-00030200: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
-00030210: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
-00030220: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
-00030230: 732e 7072 6f63 6573 7369 6e67 5f6f 6e0a  s.processing_on.
-00030240: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-00030250: 7320 6e6f 7420 696e 2073 656c 662e 756e  s not in self.un
-00030260: 7275 6e6e 6162 6c65 0a20 2020 2020 2020  runnable.       
-00030270: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-00030280: 6e20 7365 6c66 2e71 7565 7565 640a 2020  n self.queued.  
-00030290: 2020 2020 2020 666f 7220 6474 7320 696e        for dts in
-000302a0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-000302b0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-000302c0: 5765 2061 7265 2077 6169 7469 6e67 206f  We are waiting o
-000302d0: 6e20 6120 6465 7065 6e64 656e 6379 2069  n a dependency i
-000302e0: 6666 2069 7427 7320 6e6f 7420 7374 6f72  ff it's not stor
-000302f0: 6564 0a20 2020 2020 2020 2020 2020 2061  ed.            a
-00030300: 7373 6572 7420 626f 6f6c 2864 7473 2e77  ssert bool(dts.w
-00030310: 686f 5f68 6173 2920 213d 2028 6474 7320  ho_has) != (dts 
-00030320: 696e 2028 7473 2e77 6169 7469 6e67 5f6f  in (ts.waiting_o
-00030330: 6e20 6f72 2028 2929 290a 2020 2020 2020  n or ())).      
-00030340: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-00030350: 696e 2028 6474 732e 7761 6974 6572 7320  in (dts.waiters 
-00030360: 6f72 2028 2929 2020 2320 5858 5820 6576  or ())  # XXX ev
-00030370: 656e 2069 6620 6474 732e 5f77 686f 5f68  en if dts._who_h
-00030380: 6173 3f0a 0a20 2020 2064 6566 2076 616c  as?..    def val
-00030390: 6964 6174 655f 7175 6575 6564 2873 656c  idate_queued(sel
-000303a0: 662c 206b 6579 3a20 4b65 7929 202d 3e20  f, key: Key) -> 
-000303b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
-000303c0: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
-000303d0: 795d 0a20 2020 2020 2020 2061 7373 6572  y].        asser
-000303e0: 7420 7473 2069 6e20 7365 6c66 2e71 7565  t ts in self.que
-000303f0: 7565 640a 2020 2020 2020 2020 6173 7365  ued.        asse
-00030400: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
-00030410: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
-00030420: 6572 7420 6e6f 7420 7473 2e77 686f 5f68  ert not ts.who_h
-00030430: 6173 0a20 2020 2020 2020 2061 7373 6572  as.        asser
-00030440: 7420 6e6f 7420 7473 2e70 726f 6365 7373  t not ts.process
-00030450: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
-00030460: 7373 6572 7420 6e6f 7420 280a 2020 2020  ssert not (.    
-00030470: 2020 2020 2020 2020 7473 2e77 6f72 6b65          ts.worke
-00030480: 725f 7265 7374 7269 6374 696f 6e73 206f  r_restrictions o
-00030490: 7220 7473 2e68 6f73 745f 7265 7374 7269  r ts.host_restri
-000304a0: 6374 696f 6e73 206f 7220 7473 2e72 6573  ctions or ts.res
-000304b0: 6f75 7263 655f 7265 7374 7269 6374 696f  ource_restrictio
-000304c0: 6e73 0a20 2020 2020 2020 2029 0a20 2020  ns.        ).   
-000304d0: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
-000304e0: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
-000304f0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00030500: 6572 7420 6474 732e 7768 6f5f 6861 730a  ert dts.who_has.
-00030510: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00030520: 7274 2074 7320 696e 2028 6474 732e 7761  rt ts in (dts.wa
-00030530: 6974 6572 7320 6f72 2028 2929 0a0a 2020  iters or ())..  
-00030540: 2020 6465 6620 7661 6c69 6461 7465 5f70    def validate_p
-00030550: 726f 6365 7373 696e 6728 7365 6c66 2c20  rocessing(self, 
-00030560: 6b65 793a 204b 6579 2920 2d3e 204e 6f6e  key: Key) -> Non
-00030570: 653a 0a20 2020 2020 2020 2074 7320 3d20  e:.        ts = 
-00030580: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00030590: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-000305a0: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
-000305b0: 0a20 2020 2020 2020 2077 7320 3d20 7473  .        ws = ts
-000305c0: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
-000305d0: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
-000305e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000305f0: 7473 2069 6e20 7773 2e70 726f 6365 7373  ts in ws.process
-00030600: 696e 670a 2020 2020 2020 2020 6173 7365  ing.        asse
-00030610: 7274 206e 6f74 2074 732e 7768 6f5f 6861  rt not ts.who_ha
-00030620: 730a 2020 2020 2020 2020 6173 7365 7274  s.        assert
-00030630: 2074 7320 6e6f 7420 696e 2073 656c 662e   ts not in self.
-00030640: 7175 6575 6564 0a20 2020 2020 2020 2066  queued.        f
-00030650: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-00030660: 656e 6465 6e63 6965 733a 0a20 2020 2020  endencies:.     
-00030670: 2020 2020 2020 2061 7373 6572 7420 6474         assert dt
-00030680: 732e 7768 6f5f 6861 7320 6f72 2028 290a  s.who_has or ().
-00030690: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000306a0: 7274 2074 7320 696e 2028 6474 732e 7761  rt ts in (dts.wa
-000306b0: 6974 6572 7320 6f72 2028 2929 0a0a 2020  iters or ())..  
-000306c0: 2020 6465 6620 7661 6c69 6461 7465 5f6d    def validate_m
-000306d0: 656d 6f72 7928 7365 6c66 2c20 6b65 793a  emory(self, key:
-000306e0: 204b 6579 2920 2d3e 204e 6f6e 653a 0a20   Key) -> None:. 
-000306f0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00030700: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-00030710: 2020 2020 6173 7365 7274 2074 732e 7768      assert ts.wh
-00030720: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
-00030730: 7365 7274 2062 6f6f 6c28 7473 2069 6e20  sert bool(ts in 
-00030740: 7365 6c66 2e72 6570 6c69 6361 7465 645f  self.replicated_
-00030750: 7461 736b 7329 203d 3d20 286c 656e 2874  tasks) == (len(t
-00030760: 732e 7768 6f5f 6861 7329 203e 2031 290a  s.who_has) > 1).
-00030770: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00030780: 6f74 2074 732e 7072 6f63 6573 7369 6e67  ot ts.processing
-00030790: 5f6f 6e0a 2020 2020 2020 2020 6173 7365  _on.        asse
-000307a0: 7274 206e 6f74 2074 732e 7761 6974 696e  rt not ts.waitin
-000307b0: 675f 6f6e 0a20 2020 2020 2020 2061 7373  g_on.        ass
-000307c0: 6572 7420 7473 206e 6f74 2069 6e20 7365  ert ts not in se
-000307d0: 6c66 2e75 6e72 756e 6e61 626c 650a 2020  lf.unrunnable.  
-000307e0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-000307f0: 6e6f 7420 696e 2073 656c 662e 7175 6575  not in self.queu
-00030800: 6564 0a20 2020 2020 2020 2066 6f72 2064  ed.        for d
-00030810: 7473 2069 6e20 7473 2e64 6570 656e 6465  ts in ts.depende
-00030820: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-00030830: 2061 7373 6572 7420 2864 7473 2069 6e20   assert (dts in 
-00030840: 2874 732e 7761 6974 6572 7320 6f72 2028  (ts.waiters or (
-00030850: 2929 2920 3d3d 2028 0a20 2020 2020 2020  ))) == (.       
-00030860: 2020 2020 2020 2020 2064 7473 2e73 7461           dts.sta
-00030870: 7465 2069 6e20 2822 7761 6974 696e 6722  te in ("waiting"
-00030880: 2c20 2271 7565 7565 6422 2c20 2270 726f  , "queued", "pro
-00030890: 6365 7373 696e 6722 2c20 226e 6f2d 776f  cessing", "no-wo
-000308a0: 726b 6572 2229 0a20 2020 2020 2020 2020  rker").         
-000308b0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-000308c0: 2061 7373 6572 7420 7473 206e 6f74 2069   assert ts not i
-000308d0: 6e20 2864 7473 2e77 6169 7469 6e67 5f6f  n (dts.waiting_o
-000308e0: 6e20 6f72 2028 2929 0a0a 2020 2020 6465  n or ())..    de
-000308f0: 6620 7661 6c69 6461 7465 5f6e 6f5f 776f  f validate_no_wo
-00030900: 726b 6572 2873 656c 662c 206b 6579 3a20  rker(self, key: 
-00030910: 4b65 7929 202d 3e20 4e6f 6e65 3a0a 2020  Key) -> None:.  
-00030920: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
-00030930: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
-00030940: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-00030950: 7365 6c66 2e75 6e72 756e 6e61 626c 650a  self.unrunnable.
-00030960: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00030970: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
-00030980: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00030990: 7473 2069 6e20 7365 6c66 2e75 6e72 756e  ts in self.unrun
-000309a0: 6e61 626c 650a 2020 2020 2020 2020 6173  nable.        as
-000309b0: 7365 7274 206e 6f74 2074 732e 7072 6f63  sert not ts.proc
-000309c0: 6573 7369 6e67 5f6f 6e0a 2020 2020 2020  essing_on.      
-000309d0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
-000309e0: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
-000309f0: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
-00030a00: 2073 656c 662e 7175 6575 6564 0a20 2020   self.queued.   
-00030a10: 2020 2020 2066 6f72 2064 7473 2069 6e20       for dts in 
-00030a20: 7473 2e64 6570 656e 6465 6e63 6965 733a  ts.dependencies:
-00030a30: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00030a40: 6572 7420 6474 732e 7768 6f5f 6861 730a  ert dts.who_has.
-00030a50: 0a20 2020 2064 6566 2076 616c 6964 6174  .    def validat
-00030a60: 655f 6572 7265 6428 7365 6c66 2c20 6b65  e_erred(self, ke
-00030a70: 793a 204b 6579 2920 2d3e 204e 6f6e 653a  y: Key) -> None:
-00030a80: 0a20 2020 2020 2020 2074 7320 3d20 7365  .        ts = se
-00030a90: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
-00030aa0: 2020 2020 2020 6173 7365 7274 2074 732e        assert ts.
-00030ab0: 6578 6365 7074 696f 6e5f 626c 616d 650a  exception_blame.
-00030ac0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-00030ad0: 6f74 2074 732e 7768 6f5f 6861 730a 2020  ot ts.who_has.  
-00030ae0: 2020 2020 2020 6173 7365 7274 2074 7320        assert ts 
-00030af0: 6e6f 7420 696e 2073 656c 662e 7175 6575  not in self.queu
-00030b00: 6564 0a0a 2020 2020 6465 6620 7661 6c69  ed..    def vali
-00030b10: 6461 7465 5f6b 6579 2873 656c 662c 206b  date_key(self, k
-00030b20: 6579 3a20 4b65 792c 2074 733a 2054 6173  ey: Key, ts: Tas
-00030b30: 6b53 7461 7465 207c 204e 6f6e 6520 3d20  kState | None = 
-00030b40: 4e6f 6e65 2920 2d3e 204e 6f6e 653a 0a20  None) -> None:. 
-00030b50: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00030b60: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
-00030b70: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00030b80: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-00030b90: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
-00030ba0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00030bb0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00030bc0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-00030bd0: 722e 6465 6275 6728 224b 6579 206c 6f73  r.debug("Key los
-00030be0: 743a 2025 7322 2c20 6b65 7929 0a20 2020  t: %s", key).   
-00030bf0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00030c00: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00030c10: 732e 7661 6c69 6461 7465 2829 0a20 2020  s.validate().   
-00030c20: 2020 2020 2020 2020 2020 2020 2074 7279               try
-00030c30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00030c40: 2020 2020 2020 6675 6e63 203d 2067 6574        func = get
-00030c50: 6174 7472 2873 656c 662c 2022 7661 6c69  attr(self, "vali
-00030c60: 6461 7465 5f22 202b 2074 732e 7374 6174  date_" + ts.stat
-00030c70: 652e 7265 706c 6163 6528 222d 222c 2022  e.replace("-", "
-00030c80: 5f22 2929 0a20 2020 2020 2020 2020 2020  _")).           
-00030c90: 2020 2020 2065 7863 6570 7420 4174 7472       except Attr
-00030ca0: 6962 7574 6545 7272 6f72 3a0a 2020 2020  ibuteError:.    
-00030cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030cc0: 6c6f 6767 6572 2e65 7272 6f72 280a 2020  logger.error(.  
-00030cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030ce0: 2020 2020 2020 2273 656c 662e 7661 6c69        "self.vali
-00030cf0: 6461 7465 5f25 7320 6e6f 7420 666f 756e  date_%s not foun
-00030d00: 6422 2c20 7473 2e73 7461 7465 2e72 6570  d", ts.state.rep
-00030d10: 6c61 6365 2822 2d22 2c20 225f 2229 0a20  lace("-", "_"). 
-00030d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030d30: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00030d40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00030d50: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00030d60: 756e 6328 6b65 7929 0a20 2020 2020 2020  unc(key).       
-00030d70: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00030d80: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-00030d90: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
-00030da0: 7469 6f6e 2865 290a 2020 2020 2020 2020  tion(e).        
-00030db0: 2020 2020 6966 204c 4f47 5f50 4442 3a0a      if LOG_PDB:.
-00030dc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00030dd0: 696d 706f 7274 2070 6462 0a0a 2020 2020  import pdb..    
-00030de0: 2020 2020 2020 2020 2020 2020 7064 622e              pdb.
-00030df0: 7365 745f 7472 6163 6528 290a 2020 2020  set_trace().    
-00030e00: 2020 2020 2020 2020 7261 6973 650a 0a20          raise.. 
-00030e10: 2020 2064 6566 2076 616c 6964 6174 655f     def validate_
-00030e20: 7374 6174 6528 7365 6c66 2c20 616c 6c6f  state(self, allo
-00030e30: 775f 6f76 6572 6c61 703a 2062 6f6f 6c20  w_overlap: bool 
-00030e40: 3d20 4661 6c73 6529 202d 3e20 4e6f 6e65  = False) -> None
-00030e50: 3a0a 2020 2020 2020 2020 7661 6c69 6461  :.        valida
-00030e60: 7465 5f73 7461 7465 2873 656c 662e 7461  te_state(self.ta
-00030e70: 736b 732c 2073 656c 662e 776f 726b 6572  sks, self.worker
-00030e80: 732c 2073 656c 662e 636c 6965 6e74 7329  s, self.clients)
-00030e90: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
-00030ea0: 2028 7365 7428 7365 6c66 2e77 6f72 6b65   (set(self.worke
-00030eb0: 7273 2920 3d3d 2073 6574 2873 656c 662e  rs) == set(self.
-00030ec0: 7374 7265 616d 5f63 6f6d 6d73 2929 3a0a  stream_comms)):.
-00030ed0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-00030ee0: 6520 5661 6c75 6545 7272 6f72 2822 576f  e ValueError("Wo
-00030ef0: 726b 6572 7320 6e6f 7420 7468 6520 7361  rkers not the sa
-00030f00: 6d65 2069 6e20 616c 6c20 636f 6c6c 6563  me in all collec
-00030f10: 7469 6f6e 7322 290a 0a20 2020 2020 2020  tions")..       
-00030f20: 2061 7373 6572 7420 7365 6c66 2e72 756e   assert self.run
-00030f30: 6e69 6e67 2e69 7373 7570 6572 7365 7428  ning.issuperset(
-00030f40: 7365 6c66 2e69 646c 652e 7661 6c75 6573  self.idle.values
-00030f50: 2829 292c 2028 0a20 2020 2020 2020 2020  ()), (.         
-00030f60: 2020 2073 656c 662e 7275 6e6e 696e 672e     self.running.
-00030f70: 636f 7079 2829 2c0a 2020 2020 2020 2020  copy(),.        
-00030f80: 2020 2020 7365 7428 7365 6c66 2e69 646c      set(self.idl
-00030f90: 652e 7661 6c75 6573 2829 292c 0a20 2020  e.values()),.   
-00030fa0: 2020 2020 2029 0a20 2020 2020 2020 2061       ).        a
-00030fb0: 7373 6572 7420 7365 6c66 2e72 756e 6e69  ssert self.runni
-00030fc0: 6e67 2e69 7373 7570 6572 7365 7428 7365  ng.issuperset(se
-00030fd0: 6c66 2e69 646c 655f 7461 736b 5f63 6f75  lf.idle_task_cou
-00030fe0: 6e74 292c 2028 0a20 2020 2020 2020 2020  nt), (.         
-00030ff0: 2020 2073 656c 662e 7275 6e6e 696e 672e     self.running.
-00031000: 636f 7079 2829 2c0a 2020 2020 2020 2020  copy(),.        
-00031010: 2020 2020 7365 6c66 2e69 646c 655f 7461      self.idle_ta
-00031020: 736b 5f63 6f75 6e74 2e63 6f70 7928 292c  sk_count.copy(),
-00031030: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00031040: 2020 2061 7373 6572 7420 7365 6c66 2e72     assert self.r
-00031050: 756e 6e69 6e67 2e69 7373 7570 6572 7365  unning.issuperse
-00031060: 7428 7365 6c66 2e73 6174 7572 6174 6564  t(self.saturated
-00031070: 292c 2028 0a20 2020 2020 2020 2020 2020  ), (.           
-00031080: 2073 656c 662e 7275 6e6e 696e 672e 636f   self.running.co
-00031090: 7079 2829 2c0a 2020 2020 2020 2020 2020  py(),.          
-000310a0: 2020 7365 6c66 2e73 6174 7572 6174 6564    self.saturated
-000310b0: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
-000310c0: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
-000310d0: 7420 7365 6c66 2e73 6174 7572 6174 6564  t self.saturated
-000310e0: 2e69 7364 6973 6a6f 696e 7428 7365 6c66  .isdisjoint(self
-000310f0: 2e69 646c 652e 7661 6c75 6573 2829 292c  .idle.values()),
-00031100: 2028 0a20 2020 2020 2020 2020 2020 2073   (.            s
-00031110: 656c 662e 7361 7475 7261 7465 642e 636f  elf.saturated.co
-00031120: 7079 2829 2c0a 2020 2020 2020 2020 2020  py(),.          
-00031130: 2020 7365 7428 7365 6c66 2e69 646c 652e    set(self.idle.
-00031140: 7661 6c75 6573 2829 292c 0a20 2020 2020  values()),.     
-00031150: 2020 2029 0a0a 2020 2020 2020 2020 7461     )..        ta
-00031160: 736b 5f70 7265 6669 785f 636f 756e 7473  sk_prefix_counts
-00031170: 3a20 6465 6661 756c 7464 6963 745b 7374  : defaultdict[st
-00031180: 722c 2069 6e74 5d20 3d20 6465 6661 756c  r, int] = defaul
-00031190: 7464 6963 7428 696e 7429 0a20 2020 2020  tdict(int).     
-000311a0: 2020 2066 6f72 2077 2c20 7773 2069 6e20     for w, ws in 
-000311b0: 7365 6c66 2e77 6f72 6b65 7273 2e69 7465  self.workers.ite
-000311c0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-000311d0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-000311e0: 6e63 6528 772c 2073 7472 292c 2028 7479  nce(w, str), (ty
-000311f0: 7065 2877 292c 2077 290a 2020 2020 2020  pe(w), w).      
-00031200: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
-00031210: 6e73 7461 6e63 6528 7773 2c20 576f 726b  nstance(ws, Work
-00031220: 6572 5374 6174 6529 2c20 2874 7970 6528  erState), (type(
-00031230: 7773 292c 2077 7329 0a20 2020 2020 2020  ws), ws).       
-00031240: 2020 2020 2061 7373 6572 7420 7773 2e61       assert ws.a
-00031250: 6464 7265 7373 203d 3d20 770a 0a20 2020  ddress == w..   
-00031260: 2020 2020 2020 2020 2069 6620 7773 2e73           if ws.s
-00031270: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
-00031280: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-00031290: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000312a0: 7773 2069 6e20 7365 6c66 2e72 756e 6e69  ws in self.runni
-000312b0: 6e67 0a20 2020 2020 2020 2020 2020 2065  ng.            e
-000312c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000312d0: 2020 2020 2061 7373 6572 7420 7773 206e       assert ws n
-000312e0: 6f74 2069 6e20 7365 6c66 2e72 756e 6e69  ot in self.runni
-000312f0: 6e67 0a20 2020 2020 2020 2020 2020 2020  ng.             
-00031300: 2020 2061 7373 6572 7420 7773 2e61 6464     assert ws.add
-00031310: 7265 7373 206e 6f74 2069 6e20 7365 6c66  ress not in self
-00031320: 2e69 646c 650a 2020 2020 2020 2020 2020  .idle.          
-00031330: 2020 2020 2020 6173 7365 7274 2077 7320        assert ws 
-00031340: 6e6f 7420 696e 2073 656c 662e 7361 7475  not in self.satu
-00031350: 7261 7465 640a 0a20 2020 2020 2020 2020  rated..         
-00031360: 2020 2061 7373 6572 7420 7773 2e6c 6f6e     assert ws.lon
-00031370: 675f 7275 6e6e 696e 672e 6973 7375 6273  g_running.issubs
-00031380: 6574 2877 732e 7072 6f63 6573 7369 6e67  et(ws.processing
-00031390: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000313a0: 206e 6f74 2077 732e 7072 6f63 6573 7369   not ws.processi
-000313b0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
-000313c0: 2020 2020 6173 7365 7274 206e 6f74 2077      assert not w
-000313d0: 732e 6f63 6375 7061 6e63 790a 2020 2020  s.occupancy.    
-000313e0: 2020 2020 2020 2020 2020 2020 6966 2077              if w
-000313f0: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-00031400: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
-00031410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00031420: 6173 7365 7274 2077 732e 6164 6472 6573  assert ws.addres
-00031430: 7320 696e 2073 656c 662e 6964 6c65 0a20  s in self.idle. 
-00031440: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00031450: 7420 6e6f 7420 7773 2e6e 6565 6473 5f77  t not ws.needs_w
-00031460: 6861 742e 6b65 7973 2829 2026 2077 732e  hat.keys() & ws.
-00031470: 6861 735f 7768 6174 0a20 2020 2020 2020  has_what.       
-00031480: 2020 2020 2061 6374 7561 6c5f 6e65 6564       actual_need
-00031490: 735f 7768 6174 3a20 6465 6661 756c 7464  s_what: defaultd
-000314a0: 6963 745b 5461 736b 5374 6174 652c 2069  ict[TaskState, i
-000314b0: 6e74 5d20 3d20 6465 6661 756c 7464 6963  nt] = defaultdic
-000314c0: 7428 696e 7429 0a20 2020 2020 2020 2020  t(int).         
-000314d0: 2020 2066 6f72 2074 7320 696e 2077 732e     for ts in ws.
-000314e0: 7072 6f63 6573 7369 6e67 3a0a 2020 2020  processing:.    
-000314f0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00031500: 7473 7320 696e 2074 732e 6465 7065 6e64  tss in ts.depend
-00031510: 656e 6369 6573 3a0a 2020 2020 2020 2020  encies:.        
-00031520: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-00031530: 7373 206e 6f74 2069 6e20 7773 2e68 6173  ss not in ws.has
-00031540: 5f77 6861 743a 0a20 2020 2020 2020 2020  _what:.         
-00031550: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00031560: 6374 7561 6c5f 6e65 6564 735f 7768 6174  ctual_needs_what
-00031570: 5b74 7373 5d20 2b3d 2031 0a20 2020 2020  [tss] += 1.     
-00031580: 2020 2020 2020 2061 7373 6572 7420 6163         assert ac
-00031590: 7475 616c 5f6e 6565 6473 5f77 6861 7420  tual_needs_what 
-000315a0: 3d3d 2077 732e 6e65 6564 735f 7768 6174  == ws.needs_what
-000315b0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-000315c0: 6572 7420 2877 732e 7374 6174 7573 203d  ert (ws.status =
-000315d0: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
-000315e0: 2920 3d3d 2028 7773 2069 6e20 7365 6c66  ) == (ws in self
-000315f0: 2e72 756e 6e69 6e67 290a 2020 2020 2020  .running).      
-00031600: 2020 2020 2020 666f 7220 6e61 6d65 2c20        for name, 
-00031610: 636f 756e 7420 696e 2077 732e 7461 736b  count in ws.task
-00031620: 5f70 7265 6669 785f 636f 756e 742e 6974  _prefix_count.it
-00031630: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-00031640: 2020 2020 2020 2074 6173 6b5f 7072 6566         task_pref
-00031650: 6978 5f63 6f75 6e74 735b 6e61 6d65 5d20  ix_counts[name] 
-00031660: 2b3d 2063 6f75 6e74 0a0a 2020 2020 2020  += count..      
-00031670: 2020 6173 7365 7274 2074 6173 6b5f 7072    assert task_pr
-00031680: 6566 6978 5f63 6f75 6e74 732e 6b65 7973  efix_counts.keys
-00031690: 2829 203d 3d20 7365 6c66 2e5f 7461 736b  () == self._task
-000316a0: 5f70 7265 6669 785f 636f 756e 745f 676c  _prefix_count_gl
-000316b0: 6f62 616c 2e6b 6579 7328 290a 2020 2020  obal.keys().    
-000316c0: 2020 2020 666f 7220 6e61 6d65 2c20 676c      for name, gl
-000316d0: 6f62 616c 5f63 6f75 6e74 2069 6e20 7365  obal_count in se
-000316e0: 6c66 2e5f 7461 736b 5f70 7265 6669 785f  lf._task_prefix_
-000316f0: 636f 756e 745f 676c 6f62 616c 2e69 7465  count_global.ite
-00031700: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-00031710: 2020 6173 7365 7274 2028 0a20 2020 2020    assert (.     
-00031720: 2020 2020 2020 2020 2020 2074 6173 6b5f             task_
-00031730: 7072 6566 6978 5f63 6f75 6e74 735b 6e61  prefix_counts[na
-00031740: 6d65 5d20 3d3d 2067 6c6f 6261 6c5f 636f  me] == global_co
-00031750: 756e 740a 2020 2020 2020 2020 2020 2020  unt.            
-00031760: 292c 2066 227b 6e61 6d65 7d3a 207b 7461  ), f"{name}: {ta
-00031770: 736b 5f70 7265 6669 785f 636f 756e 7473  sk_prefix_counts
-00031780: 5b6e 616d 655d 7d20 2877 7373 292c 207b  [name]} (wss), {
-00031790: 676c 6f62 616c 5f63 6f75 6e74 7d20 2867  global_count} (g
-000317a0: 6c6f 6261 6c29 220a 0a20 2020 2020 2020  lobal)"..       
-000317b0: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
-000317c0: 7275 6e6e 696e 673a 0a20 2020 2020 2020  running:.       
-000317d0: 2020 2020 2061 7373 6572 7420 7773 2e73       assert ws.s
-000317e0: 7461 7475 7320 3d3d 2053 7461 7475 732e  tatus == Status.
-000317f0: 7275 6e6e 696e 670a 2020 2020 2020 2020  running.        
-00031800: 2020 2020 6173 7365 7274 2077 732e 6164      assert ws.ad
-00031810: 6472 6573 7320 696e 2073 656c 662e 776f  dress in self.wo
-00031820: 726b 6572 730a 0a20 2020 2020 2020 2066  rkers..        f
-00031830: 6f72 206b 2c20 7473 2069 6e20 7365 6c66  or k, ts in self
-00031840: 2e74 6173 6b73 2e69 7465 6d73 2829 3a0a  .tasks.items():.
-00031850: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-00031860: 7274 2069 7369 6e73 7461 6e63 6528 7473  rt isinstance(ts
-00031870: 2c20 5461 736b 5374 6174 6529 2c20 2874  , TaskState), (t
-00031880: 7970 6528 7473 292c 2074 7329 0a20 2020  ype(ts), ts).   
-00031890: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-000318a0: 7473 2e6b 6579 203d 3d20 6b0a 2020 2020  ts.key == k.    
-000318b0: 2020 2020 2020 2020 6173 7365 7274 2062          assert b
-000318c0: 6f6f 6c28 7473 2069 6e20 7365 6c66 2e72  ool(ts in self.r
-000318d0: 6570 6c69 6361 7465 645f 7461 736b 7329  eplicated_tasks)
-000318e0: 203d 3d20 286c 656e 2874 732e 7768 6f5f   == (len(ts.who_
-000318f0: 6861 7320 6f72 2028 2929 203e 2031 290a  has or ()) > 1).
-00031900: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00031910: 2e76 616c 6964 6174 655f 6b65 7928 6b2c  .validate_key(k,
-00031920: 2074 7329 0a0a 2020 2020 2020 2020 666f   ts)..        fo
-00031930: 7220 7473 2069 6e20 7365 6c66 2e72 6570  r ts in self.rep
-00031940: 6c69 6361 7465 645f 7461 736b 733a 0a20  licated_tasks:. 
-00031950: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00031960: 7420 7473 2e73 7461 7465 203d 3d20 226d  t ts.state == "m
-00031970: 656d 6f72 7922 0a20 2020 2020 2020 2020  emory".         
-00031980: 2020 2061 7373 6572 7420 7473 2e6b 6579     assert ts.key
-00031990: 2069 6e20 7365 6c66 2e74 6173 6b73 0a0a   in self.tasks..
-000319a0: 2020 2020 2020 2020 666f 7220 632c 2063          for c, c
-000319b0: 7320 696e 2073 656c 662e 636c 6965 6e74  s in self.client
-000319c0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-000319d0: 2020 2020 2020 2023 2063 6c69 656e 743d         # client=
-000319e0: 4e6f 6e65 2069 7320 6f66 7465 6e20 7573  None is often us
-000319f0: 6564 2069 6e20 7465 7374 732e 2e2e 0a20  ed in tests.... 
-00031a00: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-00031a10: 7420 6320 6973 204e 6f6e 6520 6f72 2074  t c is None or t
-00031a20: 7970 6528 6329 203d 3d20 7374 722c 2028  ype(c) == str, (
-00031a30: 7479 7065 2863 292c 2063 290a 2020 2020  type(c), c).    
-00031a40: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-00031a50: 7970 6528 6373 2920 3d3d 2043 6c69 656e  ype(cs) == Clien
-00031a60: 7453 7461 7465 2c20 2874 7970 6528 6373  tState, (type(cs
-00031a70: 292c 2063 7329 0a20 2020 2020 2020 2020  ), cs).         
-00031a80: 2020 2061 7373 6572 7420 6373 2e63 6c69     assert cs.cli
-00031a90: 656e 745f 6b65 7920 3d3d 2063 0a0a 2020  ent_key == c..  
-00031aa0: 2020 2020 2020 6120 3d20 7b77 3a20 7773        a = {w: ws
-00031ab0: 2e6e 6279 7465 7320 666f 7220 772c 2077  .nbytes for w, w
-00031ac0: 7320 696e 2073 656c 662e 776f 726b 6572  s in self.worker
-00031ad0: 732e 6974 656d 7328 297d 0a20 2020 2020  s.items()}.     
-00031ae0: 2020 2062 203d 207b 0a20 2020 2020 2020     b = {.       
-00031af0: 2020 2020 2077 3a20 7375 6d28 7473 2e67       w: sum(ts.g
-00031b00: 6574 5f6e 6279 7465 7328 2920 666f 7220  et_nbytes() for 
-00031b10: 7473 2069 6e20 7773 2e68 6173 5f77 6861  ts in ws.has_wha
-00031b20: 7429 0a20 2020 2020 2020 2020 2020 2066  t).            f
-00031b30: 6f72 2077 2c20 7773 2069 6e20 7365 6c66  or w, ws in self
-00031b40: 2e77 6f72 6b65 7273 2e69 7465 6d73 2829  .workers.items()
-00031b50: 0a20 2020 2020 2020 207d 0a20 2020 2020  .        }.     
-00031b60: 2020 2061 7373 6572 7420 6120 3d3d 2062     assert a == b
-00031b70: 2c20 2861 2c20 6229 0a0a 2020 2020 2020  , (a, b)..      
-00031b80: 2020 6966 2073 656c 662e 7472 616e 7369    if self.transi
-00031b90: 7469 6f6e 5f63 6f75 6e74 6572 5f6d 6178  tion_counter_max
-00031ba0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00031bb0: 7365 7274 2073 656c 662e 7472 616e 7369  sert self.transi
-00031bc0: 7469 6f6e 5f63 6f75 6e74 6572 203c 2073  tion_counter < s
-00031bd0: 656c 662e 7472 616e 7369 7469 6f6e 5f63  elf.transition_c
-00031be0: 6f75 6e74 6572 5f6d 6178 0a0a 2020 2020  ounter_max..    
-00031bf0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00031c00: 2323 230a 2020 2020 2320 4d61 6e61 6765  ###.    # Manage
-00031c10: 204d 6573 7361 6765 7320 230a 2020 2020   Messages #.    
-00031c20: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00031c30: 2323 230a 0a20 2020 2064 6566 2072 6570  ###..    def rep
-00031c40: 6f72 7428 0a20 2020 2020 2020 2073 656c  ort(.        sel
-00031c50: 662c 206d 7367 3a20 6469 6374 2c20 7473  f, msg: dict, ts
-00031c60: 3a20 5461 736b 5374 6174 6520 7c20 4e6f  : TaskState | No
-00031c70: 6e65 203d 204e 6f6e 652c 2063 6c69 656e  ne = None, clien
-00031c80: 743a 2073 7472 207c 204e 6f6e 6520 3d20  t: str | None = 
-00031c90: 4e6f 6e65 0a20 2020 2029 202d 3e20 4e6f  None.    ) -> No
-00031ca0: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
-00031cb0: 2020 2020 2020 2020 5075 626c 6973 6820          Publish 
-00031cc0: 7570 6461 7465 7320 746f 2061 6c6c 206c  updates to all l
-00031cd0: 6973 7465 6e69 6e67 2051 7565 7565 7320  istening Queues 
-00031ce0: 616e 6420 436f 6d6d 730a 0a20 2020 2020  and Comms..     
-00031cf0: 2020 2049 6620 7468 6520 6d65 7373 6167     If the messag
-00031d00: 6520 636f 6e74 6169 6e73 2061 206b 6579  e contains a key
-00031d10: 2074 6865 6e20 7765 206f 6e6c 7920 7365   then we only se
-00031d20: 6e64 2074 6865 206d 6573 7361 6765 2074  nd the message t
-00031d30: 6f20 7468 6f73 650a 2020 2020 2020 2020  o those.        
-00031d40: 636f 6d6d 7320 7468 6174 2063 6172 6520  comms that care 
-00031d50: 6162 6f75 7420 7468 6520 6b65 792e 0a20  about the key.. 
-00031d60: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00031d70: 2020 2069 6620 7473 2069 7320 4e6f 6e65     if ts is None
-00031d80: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
-00031d90: 675f 6b65 7920 3d20 6d73 672e 6765 7428  g_key = msg.get(
-00031da0: 226b 6579 2229 0a20 2020 2020 2020 2020  "key").         
-00031db0: 2020 2069 6620 6d73 675f 6b65 7920 6973     if msg_key is
-00031dc0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00031dd0: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-00031de0: 7365 6c66 2e74 6173 6b73 2e67 6574 286d  self.tasks.get(m
-00031df0: 7367 5f6b 6579 290a 0a20 2020 2020 2020  sg_key)..       
-00031e00: 2069 6620 7473 2069 7320 4e6f 6e65 2061   if ts is None a
-00031e10: 6e64 2063 6c69 656e 7420 6973 204e 6f6e  nd client is Non
-00031e20: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00031e30: 204e 6f74 6966 7920 616c 6c20 636c 6965   Notify all clie
-00031e40: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
-00031e50: 636c 6965 6e74 5f6b 6579 7320 3d20 6c69  client_keys = li
-00031e60: 7374 2873 656c 662e 636c 6965 6e74 5f63  st(self.client_c
-00031e70: 6f6d 6d73 290a 2020 2020 2020 2020 656c  omms).        el
-00031e80: 6966 2074 7320 6973 204e 6f6e 653a 0a20  if ts is None:. 
-00031e90: 2020 2020 2020 2020 2020 2063 6c69 656e             clien
-00031ea0: 745f 6b65 7973 203d 205b 636c 6965 6e74  t_keys = [client
-00031eb0: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
-00031ec0: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
-00031ed0: 7469 6679 2063 6c69 656e 7473 2069 6e74  tify clients int
-00031ee0: 6572 6573 7465 6420 696e 206b 6579 2028  erested in key (
-00031ef0: 696e 636c 7564 696e 6720 6063 6c69 656e  including `clien
-00031f00: 7460 290a 2020 2020 2020 2020 2020 2020  t`).            
-00031f10: 2320 4e6f 7465 2074 6861 742c 2069 6620  # Note that, if 
-00031f20: 7265 706f 7274 2829 2077 6173 2063 616c  report() was cal
-00031f30: 6c65 6420 6279 2075 7064 6174 655f 6772  led by update_gr
-00031f40: 6170 6828 292c 2060 636c 6965 6e74 6020  aph(), `client` 
-00031f50: 776f 6e27 7420 6265 2069 6e0a 2020 2020  won't be in.    
-00031f60: 2020 2020 2020 2020 2320 7473 2e77 686f          # ts.who
-00031f70: 5f77 616e 7473 2079 6574 2e0a 2020 2020  _wants yet..    
-00031f80: 2020 2020 2020 2020 636c 6965 6e74 5f6b          client_k
-00031f90: 6579 7320 3d20 5b0a 2020 2020 2020 2020  eys = [.        
-00031fa0: 2020 2020 2020 2020 6373 2e63 6c69 656e          cs.clien
-00031fb0: 745f 6b65 7920 666f 7220 6373 2069 6e20  t_key for cs in 
-00031fc0: 7473 2e77 686f 5f77 616e 7473 206f 7220  ts.who_wants or 
-00031fd0: 2829 2069 6620 6373 2e63 6c69 656e 745f  () if cs.client_
-00031fe0: 6b65 7920 213d 2063 6c69 656e 740a 2020  key != client.  
-00031ff0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
-00032000: 2020 2020 2020 2020 6966 2063 6c69 656e          if clien
-00032010: 7420 6973 206e 6f74 204e 6f6e 653a 0a20  t is not None:. 
-00032020: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00032030: 6c69 656e 745f 6b65 7973 2e61 7070 656e  lient_keys.appen
-00032040: 6428 636c 6965 6e74 290a 0a20 2020 2020  d(client)..     
-00032050: 2020 2066 6f72 206b 2069 6e20 636c 6965     for k in clie
-00032060: 6e74 5f6b 6579 733a 0a20 2020 2020 2020  nt_keys:.       
-00032070: 2020 2020 2063 203d 2073 656c 662e 636c       c = self.cl
-00032080: 6965 6e74 5f63 6f6d 6d73 2e67 6574 286b  ient_comms.get(k
-00032090: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-000320a0: 2063 2069 7320 4e6f 6e65 3a0a 2020 2020   c is None:.    
-000320b0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-000320c0: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
-000320d0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-000320e0: 2020 2020 2020 632e 7365 6e64 286d 7367        c.send(msg
-000320f0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00032100: 2020 2320 6c6f 6767 6572 2e64 6562 7567    # logger.debug
-00032110: 2822 5363 6865 6475 6c65 7220 7365 6e64  ("Scheduler send
-00032120: 7320 6d65 7373 6167 6520 746f 2063 6c69  s message to cli
-00032130: 656e 7420 2573 3a20 2573 222c 206b 2c20  ent %s: %s", k, 
-00032140: 6d73 6729 0a20 2020 2020 2020 2020 2020  msg).           
-00032150: 2065 7863 6570 7420 436f 6d6d 436c 6f73   except CommClos
-00032160: 6564 4572 726f 723a 0a20 2020 2020 2020  edError:.       
-00032170: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00032180: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
-00032190: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
-000321a0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-000321b0: 6f67 6765 722e 6372 6974 6963 616c 280a  ogger.critical(.
-000321c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000321d0: 2020 2020 2020 2020 2243 6c6f 7365 6420          "Closed 
-000321e0: 636f 6d6d 2025 7220 7768 696c 6520 7472  comm %r while tr
-000321f0: 7969 6e67 2074 6f20 7772 6974 6520 2573  ying to write %s
-00032200: 222c 2063 2c20 6d73 672c 2065 7863 5f69  ", c, msg, exc_i
-00032210: 6e66 6f3d 5472 7565 0a20 2020 2020 2020  nfo=True.       
-00032220: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00032230: 2020 2020 6173 796e 6320 6465 6620 6164      async def ad
-00032240: 645f 636c 6965 6e74 280a 2020 2020 2020  d_client(.      
-00032250: 2020 7365 6c66 2c20 636f 6d6d 3a20 436f    self, comm: Co
-00032260: 6d6d 2c20 636c 6965 6e74 3a20 7374 722c  mm, client: str,
-00032270: 2076 6572 7369 6f6e 733a 2064 6963 745b   versions: dict[
-00032280: 7374 722c 2041 6e79 5d0a 2020 2020 2920  str, Any].    ) 
-00032290: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-000322a0: 2022 2222 4164 6420 636c 6965 6e74 2074   """Add client t
-000322b0: 6f20 6e65 7477 6f72 6b0a 0a20 2020 2020  o network..     
-000322c0: 2020 2057 6520 6c69 7374 656e 2074 6f20     We listen to 
-000322d0: 616c 6c20 6675 7475 7265 206d 6573 7361  all future messa
-000322e0: 6765 7320 6672 6f6d 2074 6869 7320 436f  ges from this Co
-000322f0: 6d6d 2e0a 2020 2020 2020 2020 2222 220a  mm..        """.
-00032300: 2020 2020 2020 2020 6173 7365 7274 2063          assert c
-00032310: 6c69 656e 7420 6973 206e 6f74 204e 6f6e  lient is not Non
-00032320: 650a 2020 2020 2020 2020 636f 6d6d 2e6e  e.        comm.n
-00032330: 616d 6520 3d20 2253 6368 6564 756c 6572  ame = "Scheduler
-00032340: 2d3e 436c 6965 6e74 220a 2020 2020 2020  ->Client".      
-00032350: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
-00032360: 6563 6569 7665 2063 6c69 656e 7420 636f  eceive client co
-00032370: 6e6e 6563 7469 6f6e 3a20 2573 222c 2063  nnection: %s", c
-00032380: 6c69 656e 7429 0a20 2020 2020 2020 2073  lient).        s
-00032390: 656c 662e 6c6f 675f 6576 656e 7428 5b22  elf.log_event(["
-000323a0: 616c 6c22 2c20 636c 6965 6e74 5d2c 207b  all", client], {
-000323b0: 2261 6374 696f 6e22 3a20 2261 6464 2d63  "action": "add-c
-000323c0: 6c69 656e 7422 2c20 2263 6c69 656e 7422  lient", "client"
-000323d0: 3a20 636c 6965 6e74 7d29 0a20 2020 2020  : client}).     
-000323e0: 2020 2073 656c 662e 636c 6965 6e74 735b     self.clients[
-000323f0: 636c 6965 6e74 5d20 3d20 436c 6965 6e74  client] = Client
-00032400: 5374 6174 6528 636c 6965 6e74 2c20 7665  State(client, ve
-00032410: 7273 696f 6e73 3d76 6572 7369 6f6e 7329  rsions=versions)
-00032420: 0a0a 2020 2020 2020 2020 666f 7220 706c  ..        for pl
-00032430: 7567 696e 2069 6e20 6c69 7374 2873 656c  ugin in list(sel
-00032440: 662e 706c 7567 696e 732e 7661 6c75 6573  f.plugins.values
-00032450: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
-00032460: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00032470: 2020 2020 2020 706c 7567 696e 2e61 6464        plugin.add
-00032480: 5f63 6c69 656e 7428 7363 6865 6475 6c65  _client(schedule
-00032490: 723d 7365 6c66 2c20 636c 6965 6e74 3d63  r=self, client=c
-000324a0: 6c69 656e 7429 0a20 2020 2020 2020 2020  lient).         
-000324b0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-000324c0: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-000324d0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000324e0: 2e65 7863 6570 7469 6f6e 2865 290a 0a20  .exception(e).. 
-000324f0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00032500: 2020 2020 2020 2020 6263 6f6d 6d20 3d20          bcomm = 
-00032510: 4261 7463 6865 6453 656e 6428 696e 7465  BatchedSend(inte
-00032520: 7276 616c 3d22 326d 7322 2c20 6c6f 6f70  rval="2ms", loop
-00032530: 3d73 656c 662e 6c6f 6f70 290a 2020 2020  =self.loop).    
-00032540: 2020 2020 2020 2020 6263 6f6d 6d2e 7374          bcomm.st
-00032550: 6172 7428 636f 6d6d 290a 2020 2020 2020  art(comm).      
-00032560: 2020 2020 2020 7365 6c66 2e63 6c69 656e        self.clien
-00032570: 745f 636f 6d6d 735b 636c 6965 6e74 5d20  t_comms[client] 
-00032580: 3d20 6263 6f6d 6d0a 2020 2020 2020 2020  = bcomm.        
-00032590: 2020 2020 6d73 6720 3d20 7b22 6f70 223a      msg = {"op":
-000325a0: 2022 7374 7265 616d 2d73 7461 7274 227d   "stream-start"}
-000325b0: 0a20 2020 2020 2020 2020 2020 2076 6572  .            ver
-000325c0: 7369 6f6e 5f77 6172 6e69 6e67 203d 2076  sion_warning = v
-000325d0: 6572 7369 6f6e 5f6d 6f64 756c 652e 6572  ersion_module.er
-000325e0: 726f 725f 6d65 7373 6167 6528 0a20 2020  ror_message(.   
-000325f0: 2020 2020 2020 2020 2020 2020 2076 6572               ver
-00032600: 7369 6f6e 5f6d 6f64 756c 652e 6765 745f  sion_module.get_
-00032610: 7665 7273 696f 6e73 2829 2c0a 2020 2020  versions(),.    
-00032620: 2020 2020 2020 2020 2020 2020 7b77 3a20              {w: 
-00032630: 7773 2e76 6572 7369 6f6e 7320 666f 7220  ws.versions for 
-00032640: 772c 2077 7320 696e 2073 656c 662e 776f  w, ws in self.wo
-00032650: 726b 6572 732e 6974 656d 7328 297d 2c0a  rkers.items()},.
-00032660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032670: 7665 7273 696f 6e73 2c0a 2020 2020 2020  versions,.      
-00032680: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00032690: 2020 2020 6d73 672e 7570 6461 7465 2876      msg.update(v
-000326a0: 6572 7369 6f6e 5f77 6172 6e69 6e67 290a  ersion_warning).
-000326b0: 2020 2020 2020 2020 2020 2020 6263 6f6d              bcom
-000326c0: 6d2e 7365 6e64 286d 7367 290a 0a20 2020  m.send(msg)..   
-000326d0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-000326e0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-000326f0: 6169 7420 7365 6c66 2e68 616e 646c 655f  ait self.handle_
-00032700: 7374 7265 616d 2863 6f6d 6d3d 636f 6d6d  stream(comm=comm
-00032710: 2c20 6578 7472 613d 7b22 636c 6965 6e74  , extra={"client
-00032720: 223a 2063 6c69 656e 747d 290a 2020 2020  ": client}).    
-00032730: 2020 2020 2020 2020 6669 6e61 6c6c 793a          finally:
-00032740: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032750: 2073 656c 662e 7265 6d6f 7665 5f63 6c69   self.remove_cli
-00032760: 656e 7428 636c 6965 6e74 3d63 6c69 656e  ent(client=clien
-00032770: 742c 2073 7469 6d75 6c75 735f 6964 3d66  t, stimulus_id=f
-00032780: 2272 656d 6f76 652d 636c 6965 6e74 2d7b  "remove-client-{
-00032790: 7469 6d65 2829 7d22 290a 2020 2020 2020  time()}").      
-000327a0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000327b0: 2e64 6562 7567 2822 4669 6e69 7368 6564  .debug("Finished
-000327c0: 2068 616e 646c 696e 6720 636c 6965 6e74   handling client
-000327d0: 2025 7322 2c20 636c 6965 6e74 290a 2020   %s", client).  
-000327e0: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
-000327f0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-00032800: 7420 636f 6d6d 2e63 6c6f 7365 6428 293a  t comm.closed():
-00032810: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032820: 2073 656c 662e 636c 6965 6e74 5f63 6f6d   self.client_com
-00032830: 6d73 5b63 6c69 656e 745d 2e73 656e 6428  ms[client].send(
-00032840: 7b22 6f70 223a 2022 7374 7265 616d 2d63  {"op": "stream-c
-00032850: 6c6f 7365 6422 7d29 0a20 2020 2020 2020  losed"}).       
-00032860: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00032870: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-00032880: 2069 735f 7079 7468 6f6e 5f73 6875 7474   is_python_shutt
-00032890: 696e 675f 646f 776e 2829 3a0a 2020 2020  ing_down():.    
-000328a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000328b0: 6177 6169 7420 7365 6c66 2e63 6c69 656e  await self.clien
-000328c0: 745f 636f 6d6d 735b 636c 6965 6e74 5d2e  t_comms[client].
-000328d0: 636c 6f73 6528 290a 2020 2020 2020 2020  close().        
-000328e0: 2020 2020 2020 2020 2020 2020 6465 6c20              del 
-000328f0: 7365 6c66 2e63 6c69 656e 745f 636f 6d6d  self.client_comm
-00032900: 735b 636c 6965 6e74 5d0a 2020 2020 2020  s[client].      
-00032910: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00032920: 2073 656c 662e 7374 6174 7573 203d 3d20   self.status == 
-00032930: 5374 6174 7573 2e72 756e 6e69 6e67 3a0a  Status.running:.
-00032940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00032950: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00032960: 6e66 6f28 2243 6c6f 7365 2063 6c69 656e  nfo("Close clien
-00032970: 7420 636f 6e6e 6563 7469 6f6e 3a20 2573  t connection: %s
-00032980: 222c 2063 6c69 656e 7429 0a20 2020 2020  ", client).     
-00032990: 2020 2020 2020 2065 7863 6570 7420 5479         except Ty
-000329a0: 7065 4572 726f 723a 2020 2320 636f 6d6d  peError:  # comm
-000329b0: 2062 6563 6f6d 6573 204e 6f6e 6520 6475   becomes None du
-000329c0: 7269 6e67 2047 430a 2020 2020 2020 2020  ring GC.        
-000329d0: 2020 2020 2020 2020 7061 7373 0a0a 2020          pass..  
-000329e0: 2020 6465 6620 7265 6d6f 7665 5f63 6c69    def remove_cli
-000329f0: 656e 7428 7365 6c66 2c20 636c 6965 6e74  ent(self, client
-00032a00: 3a20 7374 722c 2073 7469 6d75 6c75 735f  : str, stimulus_
-00032a10: 6964 3a20 7374 7220 7c20 4e6f 6e65 203d  id: str | None =
-00032a20: 204e 6f6e 6529 202d 3e20 4e6f 6e65 3a0a   None) -> None:.
-00032a30: 2020 2020 2020 2020 2222 2252 656d 6f76          """Remov
-00032a40: 6520 636c 6965 6e74 2066 726f 6d20 6e65  e client from ne
-00032a50: 7477 6f72 6b22 2222 0a20 2020 2020 2020  twork""".       
-00032a60: 2073 7469 6d75 6c75 735f 6964 203d 2073   stimulus_id = s
-00032a70: 7469 6d75 6c75 735f 6964 206f 7220 6622  timulus_id or f"
-00032a80: 7265 6d6f 7665 2d63 6c69 656e 742d 7b74  remove-client-{t
-00032a90: 696d 6528 297d 220a 2020 2020 2020 2020  ime()}".        
-00032aa0: 6966 2073 656c 662e 7374 6174 7573 203d  if self.status =
-00032ab0: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
-00032ac0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
-00032ad0: 6767 6572 2e69 6e66 6f28 2252 656d 6f76  gger.info("Remov
-00032ae0: 6520 636c 6965 6e74 2025 7322 2c20 636c  e client %s", cl
-00032af0: 6965 6e74 290a 2020 2020 2020 2020 7365  ient).        se
-00032b00: 6c66 2e6c 6f67 5f65 7665 6e74 285b 2261  lf.log_event(["a
-00032b10: 6c6c 222c 2063 6c69 656e 745d 2c20 7b22  ll", client], {"
-00032b20: 6163 7469 6f6e 223a 2022 7265 6d6f 7665  action": "remove
-00032b30: 2d63 6c69 656e 7422 2c20 2263 6c69 656e  -client", "clien
-00032b40: 7422 3a20 636c 6965 6e74 7d29 0a20 2020  t": client}).   
-00032b50: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-00032b60: 2020 2020 2020 6373 3a20 436c 6965 6e74        cs: Client
-00032b70: 5374 6174 6520 3d20 7365 6c66 2e63 6c69  State = self.cli
-00032b80: 656e 7473 5b63 6c69 656e 745d 0a20 2020  ents[client].   
-00032b90: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
-00032ba0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00032bb0: 2020 2320 5858 5820 6973 2074 6869 7320    # XXX is this 
-00032bc0: 6120 6c65 6769 7469 6d61 7465 2063 6f6e  a legitimate con
-00032bd0: 6469 7469 6f6e 3f0a 2020 2020 2020 2020  dition?.        
-00032be0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-00032bf0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00032c00: 2020 2073 656c 662e 636c 6965 6e74 5f72     self.client_r
-00032c10: 656c 6561 7365 735f 6b65 7973 280a 2020  eleases_keys(.  
-00032c20: 2020 2020 2020 2020 2020 2020 2020 6b65                ke
-00032c30: 7973 3d5b 7473 2e6b 6579 2066 6f72 2074  ys=[ts.key for t
-00032c40: 7320 696e 2063 732e 7761 6e74 735f 7768  s in cs.wants_wh
-00032c50: 6174 5d2c 0a20 2020 2020 2020 2020 2020  at],.           
-00032c60: 2020 2020 2063 6c69 656e 743d 6373 2e63       client=cs.c
-00032c70: 6c69 656e 745f 6b65 792c 0a20 2020 2020  lient_key,.     
-00032c80: 2020 2020 2020 2020 2020 2073 7469 6d75             stimu
-00032c90: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-00032ca0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00032cb0: 290a 2020 2020 2020 2020 2020 2020 6465  ).            de
-00032cc0: 6c20 7365 6c66 2e63 6c69 656e 7473 5b63  l self.clients[c
-00032cd0: 6c69 656e 745d 0a0a 2020 2020 2020 2020  lient]..        
-00032ce0: 2020 2020 666f 7220 706c 7567 696e 2069      for plugin i
-00032cf0: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
-00032d00: 696e 732e 7661 6c75 6573 2829 293a 0a20  ins.values()):. 
-00032d10: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00032d20: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00032d30: 2020 2020 2020 2020 706c 7567 696e 2e72          plugin.r
-00032d40: 656d 6f76 655f 636c 6965 6e74 2873 6368  emove_client(sch
-00032d50: 6564 756c 6572 3d73 656c 662c 2063 6c69  eduler=self, cli
-00032d60: 656e 743d 636c 6965 6e74 290a 2020 2020  ent=client).    
-00032d70: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00032d80: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
-00032d90: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00032da0: 2020 2020 2020 206c 6f67 6765 722e 6578         logger.ex
-00032db0: 6365 7074 696f 6e28 6529 0a0a 2020 2020  ception(e)..    
-00032dc0: 2020 2020 6173 796e 6320 6465 6620 7265      async def re
-00032dd0: 6d6f 7665 5f63 6c69 656e 745f 6672 6f6d  move_client_from
-00032de0: 5f65 7665 6e74 7328 2920 2d3e 204e 6f6e  _events() -> Non
-00032df0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-00032e00: 2049 6620 7468 6520 636c 6965 6e74 2069   If the client i
-00032e10: 736e 2774 2072 6567 6973 7465 7265 6420  sn't registered 
-00032e20: 616e 796d 6f72 6520 6166 7465 7220 7468  anymore after th
-00032e30: 6520 6465 6c61 792c 2072 656d 6f76 6520  e delay, remove 
-00032e40: 6672 6f6d 2065 7665 6e74 730a 2020 2020  from events.    
-00032e50: 2020 2020 2020 2020 6966 2063 6c69 656e          if clien
-00032e60: 7420 6e6f 7420 696e 2073 656c 662e 636c  t not in self.cl
-00032e70: 6965 6e74 7320 616e 6420 636c 6965 6e74  ients and client
-00032e80: 2069 6e20 7365 6c66 2e65 7665 6e74 733a   in self.events:
-00032e90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00032ea0: 2064 656c 2073 656c 662e 6576 656e 7473   del self.events
-00032eb0: 5b63 6c69 656e 745d 0a0a 2020 2020 2020  [client]..      
-00032ec0: 2020 636c 6561 6e75 705f 6465 6c61 7920    cleanup_delay 
-00032ed0: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
-00032ee0: 6128 0a20 2020 2020 2020 2020 2020 2064  a(.            d
-00032ef0: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
-00032f00: 6469 7374 7269 6275 7465 642e 7363 6865  distributed.sche
-00032f10: 6475 6c65 722e 6576 656e 7473 2d63 6c65  duler.events-cle
-00032f20: 616e 7570 2d64 656c 6179 2229 0a20 2020  anup-delay").   
-00032f30: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-00032f40: 6620 6e6f 7420 7365 6c66 2e5f 6f6e 676f  f not self._ongo
-00032f50: 696e 675f 6261 636b 6772 6f75 6e64 5f74  ing_background_t
-00032f60: 6173 6b73 2e63 6c6f 7365 643a 0a20 2020  asks.closed:.   
-00032f70: 2020 2020 2020 2020 2073 656c 662e 5f6f           self._o
-00032f80: 6e67 6f69 6e67 5f62 6163 6b67 726f 756e  ngoing_backgroun
-00032f90: 645f 7461 736b 732e 6361 6c6c 5f6c 6174  d_tasks.call_lat
-00032fa0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-00032fb0: 2020 2020 636c 6561 6e75 705f 6465 6c61      cleanup_dela
-00032fc0: 792c 2072 656d 6f76 655f 636c 6965 6e74  y, remove_client
-00032fd0: 5f66 726f 6d5f 6576 656e 7473 0a20 2020  _from_events.   
-00032fe0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00032ff0: 6465 6620 7365 6e64 5f74 6173 6b5f 746f  def send_task_to
-00033000: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
-00033010: 2073 656c 662c 2077 6f72 6b65 723a 2073   self, worker: s
-00033020: 7472 2c20 7473 3a20 5461 736b 5374 6174  tr, ts: TaskStat
-00033030: 652c 2064 7572 6174 696f 6e3a 2066 6c6f  e, duration: flo
-00033040: 6174 203d 202d 310a 2020 2020 2920 2d3e  at = -1.    ) ->
-00033050: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00033060: 2222 5365 6e64 2061 2073 696e 676c 6520  ""Send a single 
-00033070: 636f 6d70 7574 6174 696f 6e61 6c20 7461  computational ta
-00033080: 736b 2074 6f20 6120 776f 726b 6572 2222  sk to a worker""
-00033090: 220a 2020 2020 2020 2020 7472 793a 0a20  ".        try:. 
-000330a0: 2020 2020 2020 2020 2020 206d 7367 203d             msg =
-000330b0: 2073 656c 662e 5f74 6173 6b5f 746f 5f6d   self._task_to_m
-000330c0: 7367 2874 732c 2064 7572 6174 696f 6e29  sg(ts, duration)
-000330d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000330e0: 662e 776f 726b 6572 5f73 656e 6428 776f  f.worker_send(wo
-000330f0: 726b 6572 2c20 6d73 6729 0a20 2020 2020  rker, msg).     
-00033100: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-00033110: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
-00033120: 2020 2020 2020 6c6f 6767 6572 2e65 7863        logger.exc
-00033130: 6570 7469 6f6e 2865 290a 2020 2020 2020  eption(e).      
-00033140: 2020 2020 2020 6966 204c 4f47 5f50 4442        if LOG_PDB
-00033150: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00033160: 2020 696d 706f 7274 2070 6462 0a0a 2020    import pdb..  
-00033170: 2020 2020 2020 2020 2020 2020 2020 7064                pd
-00033180: 622e 7365 745f 7472 6163 6528 290a 2020  b.set_trace().  
-00033190: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
-000331a0: 0a20 2020 2064 6566 2068 616e 646c 655f  .    def handle_
-000331b0: 756e 6361 7567 6874 5f65 7272 6f72 2873  uncaught_error(s
-000331c0: 656c 662c 202a 2a6d 7367 3a20 416e 7929  elf, **msg: Any)
-000331d0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000331e0: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
-000331f0: 6f6e 2863 6c65 616e 5f65 7863 6570 7469  on(clean_excepti
-00033200: 6f6e 282a 2a6d 7367 295b 315d 290a 0a20  on(**msg)[1]).. 
-00033210: 2020 2064 6566 2068 616e 646c 655f 7461     def handle_ta
-00033220: 736b 5f66 696e 6973 6865 6428 0a20 2020  sk_finished(.   
-00033230: 2020 2020 2073 656c 662c 206b 6579 3a20       self, key: 
-00033240: 4b65 792c 2077 6f72 6b65 723a 2073 7472  Key, worker: str
-00033250: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-00033260: 7472 2c20 2a2a 6d73 673a 2041 6e79 0a20  tr, **msg: Any. 
-00033270: 2020 2029 202d 3e20 4e6f 6e65 3a0a 2020     ) -> None:.  
-00033280: 2020 2020 2020 6966 2077 6f72 6b65 7220        if worker 
-00033290: 6e6f 7420 696e 2073 656c 662e 776f 726b  not in self.work
-000332a0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-000332b0: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
-000332c0: 7365 6c66 2e76 616c 6964 6174 655f 6b65  self.validate_ke
-000332d0: 7928 6b65 7929 0a0a 2020 2020 2020 2020  y(key)..        
-000332e0: 723a 2074 7570 6c65 203d 2073 656c 662e  r: tuple = self.
-000332f0: 7374 696d 756c 7573 5f74 6173 6b5f 6669  stimulus_task_fi
-00033300: 6e69 7368 6564 280a 2020 2020 2020 2020  nished(.        
-00033310: 2020 2020 6b65 793d 6b65 792c 2077 6f72      key=key, wor
-00033320: 6b65 723d 776f 726b 6572 2c20 7374 696d  ker=worker, stim
-00033330: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
-00033340: 5f69 642c 202a 2a6d 7367 0a20 2020 2020  _id, **msg.     
-00033350: 2020 2029 0a20 2020 2020 2020 2072 6563     ).        rec
-00033360: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
-00033370: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
-00033380: 725f 6d73 6773 203d 2072 0a20 2020 2020  r_msgs = r.     
-00033390: 2020 2073 656c 662e 5f74 7261 6e73 6974     self._transit
-000333a0: 696f 6e73 2872 6563 6f6d 6d65 6e64 6174  ions(recommendat
-000333b0: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
-000333c0: 732c 2077 6f72 6b65 725f 6d73 6773 2c20  s, worker_msgs, 
-000333d0: 7374 696d 756c 7573 5f69 6429 0a20 2020  stimulus_id).   
-000333e0: 2020 2020 2073 656c 662e 7365 6e64 5f61       self.send_a
-000333f0: 6c6c 2863 6c69 656e 745f 6d73 6773 2c20  ll(client_msgs, 
-00033400: 776f 726b 6572 5f6d 7367 7329 0a0a 2020  worker_msgs)..  
-00033410: 2020 2020 2020 7365 6c66 2e73 7469 6d75        self.stimu
-00033420: 6c75 735f 7175 6575 655f 736c 6f74 735f  lus_queue_slots_
-00033430: 6d61 7962 655f 6f70 656e 6564 2873 7469  maybe_opened(sti
-00033440: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-00033450: 735f 6964 290a 0a20 2020 2064 6566 2068  s_id)..    def h
-00033460: 616e 646c 655f 7461 736b 5f65 7272 6564  andle_task_erred
-00033470: 2873 656c 662c 206b 6579 3a20 4b65 792c  (self, key: Key,
-00033480: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-00033490: 722c 202a 2a6d 7367 3a20 416e 7929 202d  r, **msg: Any) -
-000334a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-000334b0: 723a 2074 7570 6c65 203d 2073 656c 662e  r: tuple = self.
-000334c0: 7374 696d 756c 7573 5f74 6173 6b5f 6572  stimulus_task_er
-000334d0: 7265 6428 6b65 793d 6b65 792c 2073 7469  red(key=key, sti
-000334e0: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
-000334f0: 735f 6964 2c20 2a2a 6d73 6729 0a20 2020  s_id, **msg).   
-00033500: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
-00033510: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
-00033520: 732c 2077 6f72 6b65 725f 6d73 6773 203d  s, worker_msgs =
-00033530: 2072 0a20 2020 2020 2020 2073 656c 662e   r.        self.
-00033540: 5f74 7261 6e73 6974 696f 6e73 2872 6563  _transitions(rec
-00033550: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
-00033560: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
-00033570: 725f 6d73 6773 2c20 7374 696d 756c 7573  r_msgs, stimulus
-00033580: 5f69 6429 0a20 2020 2020 2020 2073 656c  _id).        sel
-00033590: 662e 7365 6e64 5f61 6c6c 2863 6c69 656e  f.send_all(clien
-000335a0: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-000335b0: 7367 7329 0a0a 2020 2020 2020 2020 7365  sgs)..        se
-000335c0: 6c66 2e73 7469 6d75 6c75 735f 7175 6575  lf.stimulus_queu
-000335d0: 655f 736c 6f74 735f 6d61 7962 655f 6f70  e_slots_maybe_op
-000335e0: 656e 6564 2873 7469 6d75 6c75 735f 6964  ened(stimulus_id
-000335f0: 3d73 7469 6d75 6c75 735f 6964 290a 0a20  =stimulus_id).. 
-00033600: 2020 2064 6566 2072 656c 6561 7365 5f77     def release_w
-00033610: 6f72 6b65 725f 6461 7461 2873 656c 662c  orker_data(self,
-00033620: 206b 6579 3a20 4b65 792c 2077 6f72 6b65   key: Key, worke
-00033630: 723a 2073 7472 2c20 7374 696d 756c 7573  r: str, stimulus
-00033640: 5f69 643a 2073 7472 2920 2d3e 204e 6f6e  _id: str) -> Non
-00033650: 653a 0a20 2020 2020 2020 2074 7320 3d20  e:.        ts = 
-00033660: 7365 6c66 2e74 6173 6b73 2e67 6574 286b  self.tasks.get(k
-00033670: 6579 290a 2020 2020 2020 2020 7773 203d  ey).        ws =
-00033680: 2073 656c 662e 776f 726b 6572 732e 6765   self.workers.ge
-00033690: 7428 776f 726b 6572 290a 2020 2020 2020  t(worker).      
-000336a0: 2020 6966 206e 6f74 2074 7320 6f72 206e    if not ts or n
-000336b0: 6f74 2077 7320 6f72 2077 7320 6e6f 7420  ot ws or ws not 
-000336c0: 696e 2028 7473 2e77 686f 5f68 6173 206f  in (ts.who_has o
-000336d0: 7220 2829 293a 0a20 2020 2020 2020 2020  r ()):.         
-000336e0: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-000336f0: 2020 2073 656c 662e 7265 6d6f 7665 5f72     self.remove_r
-00033700: 6570 6c69 6361 2874 732c 2077 7329 0a20  eplica(ts, ws). 
-00033710: 2020 2020 2020 2069 6620 6e6f 7420 7473         if not ts
-00033720: 2e77 686f 5f68 6173 3a0a 2020 2020 2020  .who_has:.      
-00033730: 2020 2020 2020 7365 6c66 2e74 7261 6e73        self.trans
-00033740: 6974 696f 6e73 287b 6b65 793a 2022 7265  itions({key: "re
-00033750: 6c65 6173 6564 227d 2c20 7374 696d 756c  leased"}, stimul
-00033760: 7573 5f69 6429 0a0a 2020 2020 6465 6620  us_id)..    def 
-00033770: 6861 6e64 6c65 5f6c 6f6e 675f 7275 6e6e  handle_long_runn
-00033780: 696e 6728 0a20 2020 2020 2020 2073 656c  ing(.        sel
-00033790: 662c 206b 6579 3a20 4b65 792c 2077 6f72  f, key: Key, wor
-000337a0: 6b65 723a 2073 7472 2c20 636f 6d70 7574  ker: str, comput
-000337b0: 655f 6475 7261 7469 6f6e 3a20 666c 6f61  e_duration: floa
-000337c0: 7420 7c20 4e6f 6e65 2c20 7374 696d 756c  t | None, stimul
-000337d0: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
-000337e0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000337f0: 2020 2222 2241 2074 6173 6b20 6861 7320    """A task has 
-00033800: 7365 6365 6465 6420 6672 6f6d 2074 6865  seceded from the
-00033810: 2074 6872 6561 6420 706f 6f6c 0a0a 2020   thread pool..  
-00033820: 2020 2020 2020 5765 2073 746f 7020 7468        We stop th
-00033830: 6520 7461 736b 2066 726f 6d20 6265 696e  e task from bein
-00033840: 6720 7374 6f6c 656e 2069 6e20 7468 6520  g stolen in the 
-00033850: 6675 7475 7265 2c20 616e 6420 6368 616e  future, and chan
-00033860: 6765 2074 6173 6b0a 2020 2020 2020 2020  ge task.        
-00033870: 6475 7261 7469 6f6e 2061 6363 6f75 6e74  duration account
-00033880: 696e 6720 6173 2069 6620 7468 6520 7461  ing as if the ta
-00033890: 736b 2068 6173 2073 746f 7070 6564 2e0a  sk has stopped..
-000338a0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000338b0: 2020 2020 6966 206b 6579 206e 6f74 2069      if key not i
-000338c0: 6e20 7365 6c66 2e74 6173 6b73 3a0a 2020  n self.tasks:.  
-000338d0: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-000338e0: 2e64 6562 7567 2822 536b 6970 7069 6e67  .debug("Skipping
-000338f0: 206c 6f6e 675f 7275 6e6e 696e 6720 7369   long_running si
-00033900: 6e63 6520 6b65 7920 2573 2077 6173 2061  nce key %s was a
-00033910: 6c72 6561 6479 2072 656c 6561 7365 6422  lready released"
-00033920: 2c20 6b65 7929 0a20 2020 2020 2020 2020  , key).         
-00033930: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-00033940: 2020 7473 203d 2073 656c 662e 7461 736b    ts = self.task
-00033950: 735b 6b65 795d 0a20 2020 2020 2020 2073  s[key].        s
-00033960: 7465 616c 203d 2073 656c 662e 6578 7465  teal = self.exte
-00033970: 6e73 696f 6e73 2e67 6574 2822 7374 6561  nsions.get("stea
-00033980: 6c69 6e67 2229 0a20 2020 2020 2020 2069  ling").        i
-00033990: 6620 7374 6561 6c20 6973 206e 6f74 204e  f steal is not N
-000339a0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-000339b0: 2073 7465 616c 2e72 656d 6f76 655f 6b65   steal.remove_ke
-000339c0: 795f 6672 6f6d 5f73 7465 616c 6162 6c65  y_from_stealable
-000339d0: 2874 7329 0a0a 2020 2020 2020 2020 7773  (ts)..        ws
-000339e0: 203d 2074 732e 7072 6f63 6573 7369 6e67   = ts.processing
-000339f0: 5f6f 6e0a 2020 2020 2020 2020 6966 2077  _on.        if w
-00033a00: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00033a10: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
-00033a20: 6275 6728 2252 6563 6569 7665 6420 6c6f  bug("Received lo
-00033a30: 6e67 2d72 756e 6e69 6e67 2073 6967 6e61  ng-running signa
-00033a40: 6c20 6672 6f6d 2064 7570 6c69 6361 7465  l from duplicate
-00033a50: 2074 6173 6b2e 2049 676e 6f72 696e 672e   task. Ignoring.
-00033a60: 2229 0a20 2020 2020 2020 2020 2020 2072  ").            r
-00033a70: 6574 7572 6e0a 0a20 2020 2020 2020 2069  eturn..        i
-00033a80: 6620 636f 6d70 7574 655f 6475 7261 7469  f compute_durati
-00033a90: 6f6e 2069 7320 6e6f 7420 4e6f 6e65 3a0a  on is not None:.
-00033aa0: 2020 2020 2020 2020 2020 2020 6f6c 645f              old_
-00033ab0: 6475 7261 7469 6f6e 203d 2074 732e 7072  duration = ts.pr
-00033ac0: 6566 6978 2e64 7572 6174 696f 6e5f 6176  efix.duration_av
-00033ad0: 6572 6167 650a 2020 2020 2020 2020 2020  erage.          
-00033ae0: 2020 6966 206f 6c64 5f64 7572 6174 696f    if old_duratio
-00033af0: 6e20 3c20 303a 0a20 2020 2020 2020 2020  n < 0:.         
-00033b00: 2020 2020 2020 2074 732e 7072 6566 6978         ts.prefix
-00033b10: 2e64 7572 6174 696f 6e5f 6176 6572 6167  .duration_averag
-00033b20: 6520 3d20 636f 6d70 7574 655f 6475 7261  e = compute_dura
-00033b30: 7469 6f6e 0a20 2020 2020 2020 2020 2020  tion.           
-00033b40: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00033b50: 2020 2020 2020 2074 732e 7072 6566 6978         ts.prefix
-00033b60: 2e64 7572 6174 696f 6e5f 6176 6572 6167  .duration_averag
-00033b70: 6520 3d20 286f 6c64 5f64 7572 6174 696f  e = (old_duratio
-00033b80: 6e20 2b20 636f 6d70 7574 655f 6475 7261  n + compute_dura
-00033b90: 7469 6f6e 2920 2f20 320a 0a20 2020 2020  tion) / 2..     
-00033ba0: 2020 2077 732e 6164 645f 746f 5f6c 6f6e     ws.add_to_lon
-00033bb0: 675f 7275 6e6e 696e 6728 7473 290a 2020  g_running(ts).  
-00033bc0: 2020 2020 2020 7365 6c66 2e63 6865 636b        self.check
-00033bd0: 5f69 646c 655f 7361 7475 7261 7465 6428  _idle_saturated(
-00033be0: 7773 290a 0a20 2020 2020 2020 2073 656c  ws)..        sel
-00033bf0: 662e 7374 696d 756c 7573 5f71 7565 7565  f.stimulus_queue
-00033c00: 5f73 6c6f 7473 5f6d 6179 6265 5f6f 7065  _slots_maybe_ope
-00033c10: 6e65 6428 7374 696d 756c 7573 5f69 643d  ned(stimulus_id=
-00033c20: 7374 696d 756c 7573 5f69 6429 0a0a 2020  stimulus_id)..  
-00033c30: 2020 6465 6620 6861 6e64 6c65 5f77 6f72    def handle_wor
-00033c40: 6b65 725f 7374 6174 7573 5f63 6861 6e67  ker_status_chang
-00033c50: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
-00033c60: 2073 7461 7475 733a 2073 7472 207c 2053   status: str | S
-00033c70: 7461 7475 732c 2077 6f72 6b65 723a 2073  tatus, worker: s
-00033c80: 7472 207c 2057 6f72 6b65 7253 7461 7465  tr | WorkerState
-00033c90: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-00033ca0: 7472 0a20 2020 2029 202d 3e20 4e6f 6e65  tr.    ) -> None
-00033cb0: 3a0a 2020 2020 2020 2020 7773 203d 2073  :.        ws = s
-00033cc0: 656c 662e 776f 726b 6572 732e 6765 7428  elf.workers.get(
-00033cd0: 776f 726b 6572 2920 6966 2069 7369 6e73  worker) if isins
-00033ce0: 7461 6e63 6528 776f 726b 6572 2c20 7374  tance(worker, st
-00033cf0: 7229 2065 6c73 6520 776f 726b 6572 0a20  r) else worker. 
-00033d00: 2020 2020 2020 2069 6620 6e6f 7420 7773         if not ws
-00033d10: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00033d20: 7475 726e 0a20 2020 2020 2020 2070 7265  turn.        pre
-00033d30: 765f 7374 6174 7573 203d 2077 732e 7374  v_status = ws.st
-00033d40: 6174 7573 0a20 2020 2020 2020 2077 732e  atus.        ws.
-00033d50: 7374 6174 7573 203d 2053 7461 7475 735b  status = Status[
-00033d60: 7374 6174 7573 5d20 6966 2069 7369 6e73  status] if isins
-00033d70: 7461 6e63 6528 7374 6174 7573 2c20 7374  tance(status, st
-00033d80: 7229 2065 6c73 6520 7374 6174 7573 0a20  r) else status. 
-00033d90: 2020 2020 2020 2069 6620 7773 2e73 7461         if ws.sta
-00033da0: 7475 7320 3d3d 2070 7265 765f 7374 6174  tus == prev_stat
-00033db0: 7573 3a0a 2020 2020 2020 2020 2020 2020  us:.            
-00033dc0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
-00033dd0: 7365 6c66 2e6c 6f67 5f65 7665 6e74 280a  self.log_event(.
-00033de0: 2020 2020 2020 2020 2020 2020 7773 2e61              ws.a
-00033df0: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
-00033e00: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00033e10: 2020 2020 2020 2261 6374 696f 6e22 3a20        "action": 
-00033e20: 2277 6f72 6b65 722d 7374 6174 7573 2d63  "worker-status-c
-00033e30: 6861 6e67 6522 2c0a 2020 2020 2020 2020  hange",.        
-00033e40: 2020 2020 2020 2020 2270 7265 762d 7374          "prev-st
-00033e50: 6174 7573 223a 2070 7265 765f 7374 6174  atus": prev_stat
-00033e60: 7573 2e6e 616d 652c 0a20 2020 2020 2020  us.name,.       
-00033e70: 2020 2020 2020 2020 2022 7374 6174 7573           "status
-00033e80: 223a 2077 732e 7374 6174 7573 2e6e 616d  ": ws.status.nam
-00033e90: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00033ea0: 2020 2022 7374 696d 756c 7573 5f69 6422     "stimulus_id"
-00033eb0: 3a20 7374 696d 756c 7573 5f69 642c 0a20  : stimulus_id,. 
-00033ec0: 2020 2020 2020 2020 2020 207d 2c0a 2020             },.  
-00033ed0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00033ee0: 6c6f 6767 6572 2e64 6562 7567 2866 2257  logger.debug(f"W
-00033ef0: 6f72 6b65 7220 7374 6174 7573 207b 7072  orker status {pr
-00033f00: 6576 5f73 7461 7475 732e 6e61 6d65 7d20  ev_status.name} 
-00033f10: 2d3e 207b 7374 6174 7573 7d20 2d20 7b77  -> {status} - {w
-00033f20: 737d 2229 0a0a 2020 2020 2020 2020 6966  s}")..        if
-00033f30: 2077 732e 7374 6174 7573 203d 3d20 5374   ws.status == St
-00033f40: 6174 7573 2e72 756e 6e69 6e67 3a0a 2020  atus.running:.  
-00033f50: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-00033f60: 756e 6e69 6e67 2e61 6464 2877 7329 0a20  unning.add(ws). 
-00033f70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00033f80: 6368 6563 6b5f 6964 6c65 5f73 6174 7572  check_idle_satur
-00033f90: 6174 6564 2877 7329 0a20 2020 2020 2020  ated(ws).       
-00033fa0: 2020 2020 2073 656c 662e 7472 616e 7369       self.transi
-00033fb0: 7469 6f6e 7328 0a20 2020 2020 2020 2020  tions(.         
-00033fc0: 2020 2020 2020 2073 656c 662e 6275 6c6b         self.bulk
-00033fd0: 5f73 6368 6564 756c 655f 756e 7275 6e6e  _schedule_unrunn
-00033fe0: 6162 6c65 5f61 6674 6572 5f61 6464 696e  able_after_addin
-00033ff0: 675f 776f 726b 6572 2877 7329 2c20 7374  g_worker(ws), st
-00034000: 696d 756c 7573 5f69 640a 2020 2020 2020  imulus_id.      
-00034010: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00034020: 2020 2020 7365 6c66 2e73 7469 6d75 6c75      self.stimulu
-00034030: 735f 7175 6575 655f 736c 6f74 735f 6d61  s_queue_slots_ma
-00034040: 7962 655f 6f70 656e 6564 2873 7469 6d75  ybe_opened(stimu
-00034050: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-00034060: 6964 290a 2020 2020 2020 2020 656c 7365  id).        else
-00034070: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00034080: 6c66 2e72 756e 6e69 6e67 2e64 6973 6361  lf.running.disca
-00034090: 7264 2877 7329 0a20 2020 2020 2020 2020  rd(ws).         
-000340a0: 2020 2073 656c 662e 6964 6c65 2e70 6f70     self.idle.pop
-000340b0: 2877 732e 6164 6472 6573 732c 204e 6f6e  (ws.address, Non
-000340c0: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
-000340d0: 656c 662e 6964 6c65 5f74 6173 6b5f 636f  elf.idle_task_co
-000340e0: 756e 742e 6469 7363 6172 6428 7773 290a  unt.discard(ws).
-000340f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00034100: 2e73 6174 7572 6174 6564 2e64 6973 6361  .saturated.disca
-00034110: 7264 2877 7329 0a0a 2020 2020 6465 6620  rd(ws)..    def 
-00034120: 6861 6e64 6c65 5f72 6571 7565 7374 5f72  handle_request_r
-00034130: 6566 7265 7368 5f77 686f 5f68 6173 280a  efresh_who_has(.
-00034140: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
-00034150: 7973 3a20 4974 6572 6162 6c65 5b4b 6579  ys: Iterable[Key
-00034160: 5d2c 2077 6f72 6b65 723a 2073 7472 2c20  ], worker: str, 
-00034170: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
-00034180: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-00034190: 2020 2020 2020 2020 2222 2252 6571 7565          """Reque
-000341a0: 7374 2066 726f 6d20 6120 576f 726b 6572  st from a Worker
-000341b0: 2074 6f20 7265 6672 6573 6820 7468 650a   to refresh the.
-000341c0: 2020 2020 2020 2020 7768 6f5f 6861 7320          who_has 
-000341d0: 666f 7220 736f 6d65 206b 6579 732e 204e  for some keys. N
-000341e0: 6f74 2074 6f20 6265 2063 6f6e 6675 7365  ot to be confuse
-000341f0: 6420 7769 7468 2073 6368 6564 756c 6572  d with scheduler
-00034200: 2e77 686f 5f68 6173 2c20 7768 6963 680a  .who_has, which.
-00034210: 2020 2020 2020 2020 6973 2061 2064 6564          is a ded
-00034220: 6963 6174 6564 2063 6f6d 6d20 5250 4320  icated comm RPC 
-00034230: 7265 7175 6573 7420 6672 6f6d 2061 2043  request from a C
-00034240: 6c69 656e 742e 0a20 2020 2020 2020 2022  lient..        "
-00034250: 2222 0a20 2020 2020 2020 2077 686f 5f68  "".        who_h
-00034260: 6173 203d 207b 7d0a 2020 2020 2020 2020  as = {}.        
-00034270: 6672 6565 5f6b 6579 7320 3d20 5b5d 0a20  free_keys = []. 
-00034280: 2020 2020 2020 2066 6f72 206b 6579 2069         for key i
-00034290: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
-000342a0: 2020 2020 6966 206b 6579 2069 6e20 7365      if key in se
-000342b0: 6c66 2e74 6173 6b73 3a0a 2020 2020 2020  lf.tasks:.      
-000342c0: 2020 2020 2020 2020 2020 7768 6f5f 6861            who_ha
-000342d0: 735b 6b65 795d 203d 205b 7773 2e61 6464  s[key] = [ws.add
-000342e0: 7265 7373 2066 6f72 2077 7320 696e 2073  ress for ws in s
-000342f0: 656c 662e 7461 736b 735b 6b65 795d 2e77  elf.tasks[key].w
-00034300: 686f 5f68 6173 206f 7220 2829 5d0a 2020  ho_has or ()].  
-00034310: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00034320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034330: 6672 6565 5f6b 6579 732e 6170 7065 6e64  free_keys.append
-00034340: 286b 6579 290a 0a20 2020 2020 2020 2069  (key)..        i
-00034350: 6620 7768 6f5f 6861 733a 0a20 2020 2020  f who_has:.     
-00034360: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
-00034370: 616d 5f63 6f6d 6d73 5b77 6f72 6b65 725d  am_comms[worker]
-00034380: 2e73 656e 6428 0a20 2020 2020 2020 2020  .send(.         
-00034390: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
-000343a0: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
-000343b0: 223a 2022 7265 6672 6573 682d 7768 6f2d  ": "refresh-who-
-000343c0: 6861 7322 2c0a 2020 2020 2020 2020 2020  has",.          
-000343d0: 2020 2020 2020 2020 2020 2277 686f 5f68            "who_h
-000343e0: 6173 223a 2077 686f 5f68 6173 2c0a 2020  as": who_has,.  
-000343f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034400: 2020 2273 7469 6d75 6c75 735f 6964 223a    "stimulus_id":
-00034410: 2073 7469 6d75 6c75 735f 6964 2c0a 2020   stimulus_id,.  
-00034420: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00034430: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00034440: 2020 2020 2020 6966 2066 7265 655f 6b65        if free_ke
-00034450: 7973 3a0a 2020 2020 2020 2020 2020 2020  ys:.            
-00034460: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-00034470: 735b 776f 726b 6572 5d2e 7365 6e64 280a  s[worker].send(.
-00034480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034490: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
-000344a0: 2020 2020 2020 226f 7022 3a20 2266 7265        "op": "fre
-000344b0: 652d 6b65 7973 222c 0a20 2020 2020 2020  e-keys",.       
-000344c0: 2020 2020 2020 2020 2020 2020 2022 6b65               "ke
-000344d0: 7973 223a 2066 7265 655f 6b65 7973 2c0a  ys": free_keys,.
-000344e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000344f0: 2020 2020 2273 7469 6d75 6c75 735f 6964      "stimulus_id
-00034500: 223a 2073 7469 6d75 6c75 735f 6964 2c0a  ": stimulus_id,.
-00034510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034520: 7d0a 2020 2020 2020 2020 2020 2020 290a  }.            ).
-00034530: 0a20 2020 2061 7379 6e63 2064 6566 2068  .    async def h
-00034540: 616e 646c 655f 776f 726b 6572 2873 656c  andle_worker(sel
-00034550: 662c 2063 6f6d 6d3a 2043 6f6d 6d2c 2077  f, comm: Comm, w
-00034560: 6f72 6b65 723a 2073 7472 2920 2d3e 204e  orker: str) -> N
-00034570: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00034580: 0a20 2020 2020 2020 204c 6973 7465 6e20  .        Listen 
-00034590: 746f 2072 6573 706f 6e73 6573 2066 726f  to responses fro
-000345a0: 6d20 6120 7369 6e67 6c65 2077 6f72 6b65  m a single worke
-000345b0: 720a 0a20 2020 2020 2020 2054 6869 7320  r..        This 
-000345c0: 6973 2074 6865 206d 6169 6e20 6c6f 6f70  is the main loop
-000345d0: 2066 6f72 2073 6368 6564 756c 6572 2d77   for scheduler-w
-000345e0: 6f72 6b65 7220 696e 7465 7261 6374 696f  orker interactio
-000345f0: 6e0a 0a20 2020 2020 2020 2053 6565 2041  n..        See A
-00034600: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-00034610: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
-00034620: 6564 756c 6572 2e68 616e 646c 655f 636c  eduler.handle_cl
-00034630: 6965 6e74 3a20 4571 7569 7661 6c65 6e74  ient: Equivalent
-00034640: 2063 6f72 6f75 7469 6e65 2066 6f72 2063   coroutine for c
-00034650: 6c69 656e 7473 0a20 2020 2020 2020 2022  lients.        "
-00034660: 2222 0a20 2020 2020 2020 2063 6f6d 6d2e  "".        comm.
-00034670: 6e61 6d65 203d 2022 5363 6865 6475 6c65  name = "Schedule
-00034680: 7220 636f 6e6e 6563 7469 6f6e 2074 6f20  r connection to 
-00034690: 776f 726b 6572 220a 2020 2020 2020 2020  worker".        
-000346a0: 776f 726b 6572 5f63 6f6d 6d20 3d20 7365  worker_comm = se
-000346b0: 6c66 2e73 7472 6561 6d5f 636f 6d6d 735b  lf.stream_comms[
-000346c0: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
-000346d0: 776f 726b 6572 5f63 6f6d 6d2e 7374 6172  worker_comm.star
-000346e0: 7428 636f 6d6d 290a 2020 2020 2020 2020  t(comm).        
-000346f0: 6c6f 6767 6572 2e69 6e66 6f28 2253 7461  logger.info("Sta
-00034700: 7274 696e 6720 776f 726b 6572 2063 6f6d  rting worker com
-00034710: 7075 7465 2073 7472 6561 6d2c 2025 7322  pute stream, %s"
-00034720: 2c20 776f 726b 6572 290a 2020 2020 2020  , worker).      
-00034730: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00034740: 2020 2061 7761 6974 2073 656c 662e 6861     await self.ha
-00034750: 6e64 6c65 5f73 7472 6561 6d28 636f 6d6d  ndle_stream(comm
-00034760: 3d63 6f6d 6d2c 2065 7874 7261 3d7b 2277  =comm, extra={"w
-00034770: 6f72 6b65 7222 3a20 776f 726b 6572 7d29  orker": worker})
-00034780: 0a20 2020 2020 2020 2066 696e 616c 6c79  .        finally
-00034790: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000347a0: 2077 6f72 6b65 7220 696e 2073 656c 662e   worker in self.
-000347b0: 7374 7265 616d 5f63 6f6d 6d73 3a0a 2020  stream_comms:.  
-000347c0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-000347d0: 726b 6572 5f63 6f6d 6d2e 6162 6f72 7428  rker_comm.abort(
-000347e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000347f0: 2020 6177 6169 7420 7365 6c66 2e72 656d    await self.rem
-00034800: 6f76 655f 776f 726b 6572 280a 2020 2020  ove_worker(.    
-00034810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00034820: 776f 726b 6572 2c20 7374 696d 756c 7573  worker, stimulus
-00034830: 5f69 643d 6622 6861 6e64 6c65 2d77 6f72  _id=f"handle-wor
-00034840: 6b65 722d 636c 6561 6e75 702d 7b74 696d  ker-cleanup-{tim
-00034850: 6528 297d 220a 2020 2020 2020 2020 2020  e()}".          
-00034860: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-00034870: 2061 6464 5f70 6c75 6769 6e28 0a20 2020   add_plugin(.   
-00034880: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00034890: 2020 2070 6c75 6769 6e3a 2053 6368 6564     plugin: Sched
-000348a0: 756c 6572 506c 7567 696e 2c0a 2020 2020  ulerPlugin,.    
-000348b0: 2020 2020 2a2c 0a20 2020 2020 2020 2069      *,.        i
-000348c0: 6465 6d70 6f74 656e 743a 2062 6f6f 6c20  dempotent: bool 
-000348d0: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-000348e0: 206e 616d 653a 2073 7472 207c 204e 6f6e   name: str | Non
-000348f0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00034900: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
-00034910: 0a20 2020 2029 202d 3e20 4e6f 6e65 3a0a  .    ) -> None:.
-00034920: 2020 2020 2020 2020 2222 2241 6464 2065          """Add e
-00034930: 7874 6572 6e61 6c20 706c 7567 696e 2074  xternal plugin t
-00034940: 6f20 7363 6865 6475 6c65 722e 0a0a 2020  o scheduler...  
-00034950: 2020 2020 2020 5365 6520 6874 7470 733a        See https:
-00034960: 2f2f 6469 7374 7269 6275 7465 642e 7265  //distributed.re
-00034970: 6164 7468 6564 6f63 732e 696f 2f65 6e2f  adthedocs.io/en/
-00034980: 6c61 7465 7374 2f70 6c75 6769 6e73 2e68  latest/plugins.h
-00034990: 746d 6c0a 0a20 2020 2020 2020 2050 6172  tml..        Par
-000349a0: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
-000349b0: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
-000349c0: 2020 2070 6c75 6769 6e20 3a20 5363 6865     plugin : Sche
-000349d0: 6475 6c65 7250 6c75 6769 6e0a 2020 2020  dulerPlugin.    
-000349e0: 2020 2020 2020 2020 5363 6865 6475 6c65          Schedule
-000349f0: 7250 6c75 6769 6e20 696e 7374 616e 6365  rPlugin instance
-00034a00: 2074 6f20 6164 640a 2020 2020 2020 2020   to add.        
-00034a10: 6964 656d 706f 7465 6e74 203a 2062 6f6f  idempotent : boo
-00034a20: 6c0a 2020 2020 2020 2020 2020 2020 4966  l.            If
-00034a30: 2074 7275 652c 2074 6865 2070 6c75 6769   true, the plugi
-00034a40: 6e20 6973 2061 7373 756d 6564 2074 6f20  n is assumed to 
-00034a50: 616c 7265 6164 7920 6578 6973 7420 616e  already exist an
-00034a60: 6420 6e6f 0a20 2020 2020 2020 2020 2020  d no.           
-00034a70: 2061 6374 696f 6e20 6973 2074 616b 656e   action is taken
-00034a80: 2e0a 2020 2020 2020 2020 6e61 6d65 203a  ..        name :
-00034a90: 2073 7472 0a20 2020 2020 2020 2020 2020   str.           
-00034aa0: 2041 206e 616d 6520 666f 7220 7468 6520   A name for the 
-00034ab0: 706c 7567 696e 2c20 6966 204e 6f6e 652c  plugin, if None,
-00034ac0: 2074 6865 206e 616d 6520 6174 7472 6962   the name attrib
-00034ad0: 7574 6520 6973 0a20 2020 2020 2020 2020  ute is.         
-00034ae0: 2020 2063 6865 636b 6564 206f 6e20 7468     checked on th
-00034af0: 6520 506c 7567 696e 2069 6e73 7461 6e63  e Plugin instanc
-00034b00: 6520 616e 6420 6765 6e65 7261 7465 6420  e and generated 
-00034b10: 6966 206e 6f74 0a20 2020 2020 2020 2020  if not.         
-00034b20: 2020 2064 6973 636f 7665 7265 642e 0a20     discovered.. 
-00034b30: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00034b40: 2020 2069 6620 6e61 6d65 2069 7320 4e6f     if name is No
-00034b50: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00034b60: 6e61 6d65 203d 205f 6765 745f 706c 7567  name = _get_plug
-00034b70: 696e 5f6e 616d 6528 706c 7567 696e 290a  in_name(plugin).
-00034b80: 0a20 2020 2020 2020 2069 6620 6e61 6d65  .        if name
-00034b90: 2069 6e20 7365 6c66 2e70 6c75 6769 6e73   in self.plugins
-00034ba0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00034bb0: 2069 6465 6d70 6f74 656e 743a 0a20 2020   idempotent:.   
-00034bc0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00034bd0: 7572 6e0a 2020 2020 2020 2020 2020 2020  urn.            
-00034be0: 7761 726e 696e 6773 2e77 6172 6e28 0a20  warnings.warn(. 
-00034bf0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00034c00: 2253 6368 6564 756c 6572 2061 6c72 6561  "Scheduler alrea
-00034c10: 6479 2063 6f6e 7461 696e 7320 6120 706c  dy contains a pl
-00034c20: 7567 696e 2077 6974 6820 6e61 6d65 207b  ugin with name {
-00034c30: 6e61 6d65 7d3b 206f 7665 7277 7269 7469  name}; overwriti
-00034c40: 6e67 2e22 2c0a 2020 2020 2020 2020 2020  ng.",.          
-00034c50: 2020 2020 2020 6361 7465 676f 7279 3d55        category=U
-00034c60: 7365 7257 6172 6e69 6e67 2c0a 2020 2020  serWarning,.    
-00034c70: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00034c80: 2020 2070 6172 616d 6574 6572 7320 3d20     parameters = 
-00034c90: 696e 7370 6563 742e 7369 676e 6174 7572  inspect.signatur
-00034ca0: 6528 706c 7567 696e 2e72 656d 6f76 655f  e(plugin.remove_
-00034cb0: 776f 726b 6572 292e 7061 7261 6d65 7465  worker).paramete
-00034cc0: 7273 0a20 2020 2020 2020 2069 6620 6e6f  rs.        if no
-00034cd0: 7420 616e 7928 702e 6b69 6e64 2069 7320  t any(p.kind is 
-00034ce0: 702e 5641 525f 4b45 5957 4f52 4420 666f  p.VAR_KEYWORD fo
-00034cf0: 7220 7020 696e 2070 6172 616d 6574 6572  r p in parameter
-00034d00: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
-00034d10: 2020 2020 2020 2020 2077 6172 6e69 6e67           warning
-00034d20: 732e 7761 726e 280a 2020 2020 2020 2020  s.warn(.        
-00034d30: 2020 2020 2020 2020 2254 6865 2073 6967          "The sig
-00034d40: 6e61 7475 7265 206f 6620 6053 6368 6564  nature of `Sched
-00034d50: 756c 6572 506c 7567 696e 2e72 656d 6f76  ulerPlugin.remov
-00034d60: 655f 776f 726b 6572 6020 6e6f 7720 7265  e_worker` now re
-00034d70: 7175 6972 6573 2060 2a2a 6b77 6172 6773  quires `**kwargs
-00034d80: 6020 220a 2020 2020 2020 2020 2020 2020  ` ".            
-00034d90: 2020 2020 2274 6f20 656e 7375 7265 2074      "to ensure t
-00034da0: 6861 7420 706c 7567 696e 7320 7265 6d61  hat plugins rema
-00034db0: 696e 2066 6f72 7761 7264 2d63 6f6d 7061  in forward-compa
-00034dc0: 7469 626c 652e 204e 6f74 2069 6e63 6c75  tible. Not inclu
-00034dd0: 6469 6e67 2022 0a20 2020 2020 2020 2020  ding ".         
-00034de0: 2020 2020 2020 2022 602a 2a6b 7761 7267         "`**kwarg
-00034df0: 7360 2069 6e20 7468 6520 7369 676e 6174  s` in the signat
-00034e00: 7572 6520 7769 6c6c 206e 6f20 6c6f 6e67  ure will no long
-00034e10: 6572 2062 6520 7375 7070 6f72 7465 6420  er be supported 
-00034e20: 696e 2066 7574 7572 6520 7665 7273 696f  in future versio
-00034e30: 6e73 2e22 2c0a 2020 2020 2020 2020 2020  ns.",.          
-00034e40: 2020 2020 2020 4675 7475 7265 5761 726e        FutureWarn
-00034e50: 696e 672c 0a20 2020 2020 2020 2020 2020  ing,.           
-00034e60: 2029 0a0a 2020 2020 2020 2020 7365 6c66   )..        self
-00034e70: 2e70 6c75 6769 6e73 5b6e 616d 655d 203d  .plugins[name] =
-00034e80: 2070 6c75 6769 6e0a 0a20 2020 2064 6566   plugin..    def
-00034e90: 2072 656d 6f76 655f 706c 7567 696e 2873   remove_plugin(s
-00034ea0: 656c 662c 206e 616d 653a 2073 7472 207c  elf, name: str |
-00034eb0: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
-00034ec0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00034ed0: 2222 5265 6d6f 7665 2065 7874 6572 6e61  ""Remove externa
-00034ee0: 6c20 706c 7567 696e 2066 726f 6d20 7363  l plugin from sc
-00034ef0: 6865 6475 6c65 720a 0a20 2020 2020 2020  heduler..       
-00034f00: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
-00034f10: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
-00034f20: 2020 2020 2020 206e 616d 6520 3a20 7374         name : st
-00034f30: 720a 2020 2020 2020 2020 2020 2020 4e61  r.            Na
-00034f40: 6d65 206f 6620 7468 6520 706c 7567 696e  me of the plugin
-00034f50: 2074 6f20 7265 6d6f 7665 0a20 2020 2020   to remove.     
-00034f60: 2020 2022 2222 0a20 2020 2020 2020 2061     """.        a
-00034f70: 7373 6572 7420 6e61 6d65 2069 7320 6e6f  ssert name is no
-00034f80: 7420 4e6f 6e65 0a0a 2020 2020 2020 2020  t None..        
-00034f90: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00034fa0: 2064 656c 2073 656c 662e 706c 7567 696e   del self.plugin
-00034fb0: 735b 6e61 6d65 5d0a 2020 2020 2020 2020  s[name].        
-00034fc0: 6578 6365 7074 204b 6579 4572 726f 723a  except KeyError:
-00034fd0: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
-00034fe0: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
-00034ff0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-00035000: 2243 6f75 6c64 206e 6f74 2066 696e 6420  "Could not find 
-00035010: 706c 7567 696e 207b 6e61 6d65 2172 7d20  plugin {name!r} 
-00035020: 616d 6f6e 6720 7468 6520 6375 7272 656e  among the curren
-00035030: 7420 7363 6865 6475 6c65 7220 706c 7567  t scheduler plug
-00035040: 696e 7322 0a20 2020 2020 2020 2020 2020  ins".           
-00035050: 2029 0a0a 2020 2020 6173 796e 6320 6465   )..    async de
-00035060: 6620 7265 6769 7374 6572 5f73 6368 6564  f register_sched
-00035070: 756c 6572 5f70 6c75 6769 6e28 0a20 2020  uler_plugin(.   
-00035080: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-00035090: 2020 2070 6c75 6769 6e3a 2062 7974 6573     plugin: bytes
-000350a0: 207c 2053 6368 6564 756c 6572 506c 7567   | SchedulerPlug
-000350b0: 696e 2c0a 2020 2020 2020 2020 6e61 6d65  in,.        name
-000350c0: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
-000350d0: 6f6e 652c 0a20 2020 2020 2020 2069 6465  one,.        ide
-000350e0: 6d70 6f74 656e 743a 2062 6f6f 6c20 7c20  mpotent: bool | 
-000350f0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-00035100: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
-00035110: 2020 2020 2222 2252 6567 6973 7465 7220      """Register 
-00035120: 6120 706c 7567 696e 206f 6e20 7468 6520  a plugin on the 
-00035130: 7363 6865 6475 6c65 722e 2222 220a 2020  scheduler.""".  
-00035140: 2020 2020 2020 6966 2069 6465 6d70 6f74        if idempot
-00035150: 656e 7420 6973 204e 6f6e 653a 0a20 2020  ent is None:.   
-00035160: 2020 2020 2020 2020 2077 6172 6e69 6e67           warning
-00035170: 732e 7761 726e 280a 2020 2020 2020 2020  s.warn(.        
-00035180: 2020 2020 2020 2020 2254 6865 2073 6967          "The sig
-00035190: 6e61 7475 7265 206f 6620 6053 6368 6564  nature of `Sched
-000351a0: 756c 6572 2e72 6567 6973 7465 725f 7363  uler.register_sc
-000351b0: 6865 6475 6c65 725f 706c 7567 696e 6020  heduler_plugin` 
-000351c0: 6e6f 7720 7265 7175 6972 6573 2022 0a20  now requires ". 
-000351d0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000351e0: 6069 6465 6d70 6f74 656e 7460 2e20 4e6f  `idempotent`. No
-000351f0: 7420 696e 636c 7564 696e 6720 6069 6465  t including `ide
-00035200: 6d70 6f74 656e 7460 2069 6e20 7468 6520  mpotent` in the 
-00035210: 7369 676e 6174 7572 6520 7769 6c6c 206e  signature will n
-00035220: 6f20 6c6f 6e67 6572 2022 0a20 2020 2020  o longer ".     
-00035230: 2020 2020 2020 2020 2020 2022 6265 2073             "be s
-00035240: 7570 706f 7274 6564 2069 6e20 6675 7475  upported in futu
-00035250: 7265 2076 6572 7369 6f6e 732e 222c 0a20  re versions.",. 
-00035260: 2020 2020 2020 2020 2020 2020 2020 2046                 F
-00035270: 7574 7572 6557 6172 6e69 6e67 2c0a 2020  utureWarning,.  
-00035280: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00035290: 2020 2020 2020 2020 6964 656d 706f 7465          idempote
-000352a0: 6e74 203d 2046 616c 7365 0a20 2020 2020  nt = False.     
-000352b0: 2020 2069 6620 6e6f 7420 6973 696e 7374     if not isinst
-000352c0: 616e 6365 2870 6c75 6769 6e2c 2053 6368  ance(plugin, Sch
-000352d0: 6564 756c 6572 506c 7567 696e 293a 0a20  edulerPlugin):. 
-000352e0: 2020 2020 2020 2020 2020 2070 6c75 6769             plugi
-000352f0: 6e20 3d20 6c6f 6164 7328 706c 7567 696e  n = loads(plugin
-00035300: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
-00035310: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-00035320: 706c 7567 696e 2c20 5363 6865 6475 6c65  plugin, Schedule
-00035330: 7250 6c75 6769 6e29 0a0a 2020 2020 2020  rPlugin)..      
-00035340: 2020 6966 206e 616d 6520 6973 204e 6f6e    if name is Non
-00035350: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
-00035360: 616d 6520 3d20 5f67 6574 5f70 6c75 6769  ame = _get_plugi
-00035370: 6e5f 6e61 6d65 2870 6c75 6769 6e29 0a0a  n_name(plugin)..
-00035380: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
-00035390: 696e 2073 656c 662e 706c 7567 696e 7320  in self.plugins 
-000353a0: 616e 6420 6964 656d 706f 7465 6e74 3a0a  and idempotent:.
-000353b0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000353c0: 726e 0a0a 2020 2020 2020 2020 6966 2068  rn..        if h
-000353d0: 6173 6174 7472 2870 6c75 6769 6e2c 2022  asattr(plugin, "
-000353e0: 7374 6172 7422 293a 0a20 2020 2020 2020  start"):.       
-000353f0: 2020 2020 2072 6573 756c 7420 3d20 706c       result = pl
-00035400: 7567 696e 2e73 7461 7274 2873 656c 6629  ugin.start(self)
-00035410: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00035420: 696e 7370 6563 742e 6973 6177 6169 7461  inspect.isawaita
-00035430: 626c 6528 7265 7375 6c74 293a 0a20 2020  ble(result):.   
-00035440: 2020 2020 2020 2020 2020 2020 2061 7761               awa
-00035450: 6974 2072 6573 756c 740a 0a20 2020 2020  it result..     
-00035460: 2020 2073 656c 662e 6164 645f 706c 7567     self.add_plug
-00035470: 696e 2870 6c75 6769 6e2c 206e 616d 653d  in(plugin, name=
-00035480: 6e61 6d65 2c20 6964 656d 706f 7465 6e74  name, idempotent
-00035490: 3d69 6465 6d70 6f74 656e 7429 0a0a 2020  =idempotent)..  
-000354a0: 2020 6173 796e 6320 6465 6620 756e 7265    async def unre
-000354b0: 6769 7374 6572 5f73 6368 6564 756c 6572  gister_scheduler
-000354c0: 5f70 6c75 6769 6e28 7365 6c66 2c20 6e61  _plugin(self, na
-000354d0: 6d65 3a20 7374 7229 202d 3e20 4e6f 6e65  me: str) -> None
-000354e0: 3a0a 2020 2020 2020 2020 2222 2255 6e72  :.        """Unr
-000354f0: 6567 6973 7465 7220 6120 706c 7567 696e  egister a plugin
-00035500: 206f 6e20 7468 6520 7363 6865 6475 6c65   on the schedule
-00035510: 722e 2222 220a 2020 2020 2020 2020 7365  r.""".        se
-00035520: 6c66 2e72 656d 6f76 655f 706c 7567 696e  lf.remove_plugin
-00035530: 286e 616d 6529 0a0a 2020 2020 6465 6620  (name)..    def 
-00035540: 776f 726b 6572 5f73 656e 6428 7365 6c66  worker_send(self
-00035550: 2c20 776f 726b 6572 3a20 7374 722c 206d  , worker: str, m
-00035560: 7367 3a20 6469 6374 5b73 7472 2c20 416e  sg: dict[str, An
-00035570: 795d 2920 2d3e 204e 6f6e 653a 0a20 2020  y]) -> None:.   
-00035580: 2020 2020 2022 2222 5365 6e64 206d 6573       """Send mes
-00035590: 7361 6765 2074 6f20 776f 726b 6572 0a0a  sage to worker..
-000355a0: 2020 2020 2020 2020 5468 6973 2061 6c73          This als
-000355b0: 6f20 6861 6e64 6c65 7320 636f 6e6e 6563  o handles connec
-000355c0: 7469 6f6e 2066 6169 6c75 7265 7320 6279  tion failures by
-000355d0: 2061 6464 696e 6720 6120 6361 6c6c 6261   adding a callba
-000355e0: 636b 2074 6f20 7265 6d6f 7665 0a20 2020  ck to remove.   
-000355f0: 2020 2020 2074 6865 2077 6f72 6b65 7220       the worker 
-00035600: 6f6e 2074 6865 206e 6578 7420 6379 636c  on the next cycl
-00035610: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
-00035620: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00035630: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
-00035640: 6561 6d5f 636f 6d6d 735b 776f 726b 6572  eam_comms[worker
-00035650: 5d2e 7365 6e64 286d 7367 290a 2020 2020  ].send(msg).    
-00035660: 2020 2020 6578 6365 7074 2028 436f 6d6d      except (Comm
-00035670: 436c 6f73 6564 4572 726f 722c 2041 7474  ClosedError, Att
-00035680: 7269 6275 7465 4572 726f 7229 3a0a 2020  ributeError):.  
-00035690: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-000356a0: 6f6e 676f 696e 675f 6261 636b 6772 6f75  ongoing_backgrou
-000356b0: 6e64 5f74 6173 6b73 2e63 616c 6c5f 736f  nd_tasks.call_so
-000356c0: 6f6e 280a 2020 2020 2020 2020 2020 2020  on(.            
-000356d0: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
-000356e0: 776f 726b 6572 2c20 2023 2074 7970 653a  worker,  # type:
-000356f0: 2069 676e 6f72 655b 6172 672d 7479 7065   ignore[arg-type
-00035700: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00035710: 2020 6164 6472 6573 733d 776f 726b 6572    address=worker
-00035720: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00035730: 2020 7374 696d 756c 7573 5f69 643d 6622    stimulus_id=f"
-00035740: 776f 726b 6572 2d73 656e 642d 636f 6d6d  worker-send-comm
-00035750: 2d66 6169 6c2d 7b74 696d 6528 297d 222c  -fail-{time()}",
-00035760: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00035770: 2020 2020 6465 6620 636c 6965 6e74 5f73      def client_s
-00035780: 656e 6428 7365 6c66 2c20 636c 6965 6e74  end(self, client
-00035790: 2c20 6d73 6729 3a0a 2020 2020 2020 2020  , msg):.        
-000357a0: 2222 2253 656e 6420 6d65 7373 6167 6520  """Send message 
-000357b0: 746f 2063 6c69 656e 7422 2222 0a20 2020  to client""".   
-000357c0: 2020 2020 2063 203d 2073 656c 662e 636c       c = self.cl
-000357d0: 6965 6e74 5f63 6f6d 6d73 2e67 6574 2863  ient_comms.get(c
-000357e0: 6c69 656e 7429 0a20 2020 2020 2020 2069  lient).        i
-000357f0: 6620 6320 6973 204e 6f6e 653a 0a20 2020  f c is None:.   
-00035800: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00035810: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00035820: 2020 2020 2020 2020 2063 2e73 656e 6428           c.send(
-00035830: 6d73 6729 0a20 2020 2020 2020 2065 7863  msg).        exc
-00035840: 6570 7420 436f 6d6d 436c 6f73 6564 4572  ept CommClosedEr
-00035850: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
-00035860: 2069 6620 7365 6c66 2e73 7461 7475 7320   if self.status 
-00035870: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
-00035880: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-00035890: 2020 206c 6f67 6765 722e 6372 6974 6963     logger.critic
-000358a0: 616c 280a 2020 2020 2020 2020 2020 2020  al(.            
-000358b0: 2020 2020 2020 2020 2243 6c6f 7365 6420          "Closed 
-000358c0: 636f 6d6d 2025 7220 7768 696c 6520 7472  comm %r while tr
-000358d0: 7969 6e67 2074 6f20 7772 6974 6520 2573  ying to write %s
-000358e0: 222c 2063 2c20 6d73 672c 2065 7863 5f69  ", c, msg, exc_i
-000358f0: 6e66 6f3d 5472 7565 0a20 2020 2020 2020  nfo=True.       
-00035900: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00035910: 6465 6620 7365 6e64 5f61 6c6c 2873 656c  def send_all(sel
-00035920: 662c 2063 6c69 656e 745f 6d73 6773 3a20  f, client_msgs: 
-00035930: 4d73 6773 2c20 776f 726b 6572 5f6d 7367  Msgs, worker_msg
-00035940: 733a 204d 7367 7329 202d 3e20 4e6f 6e65  s: Msgs) -> None
-00035950: 3a0a 2020 2020 2020 2020 2222 2253 656e  :.        """Sen
-00035960: 6420 6d65 7373 6167 6573 2074 6f20 636c  d messages to cl
-00035970: 6965 6e74 2061 6e64 2077 6f72 6b65 7273  ient and workers
-00035980: 2222 220a 0a20 2020 2020 2020 2066 6f72  """..        for
-00035990: 2063 6c69 656e 742c 206d 7367 7320 696e   client, msgs in
-000359a0: 2063 6c69 656e 745f 6d73 6773 2e69 7465   client_msgs.ite
-000359b0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-000359c0: 2020 6320 3d20 7365 6c66 2e63 6c69 656e    c = self.clien
-000359d0: 745f 636f 6d6d 732e 6765 7428 636c 6965  t_comms.get(clie
-000359e0: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-000359f0: 6966 2063 2069 7320 4e6f 6e65 3a0a 2020  if c is None:.  
-00035a00: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00035a10: 6e74 696e 7565 0a20 2020 2020 2020 2020  ntinue.         
-00035a20: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-00035a30: 2020 2020 2020 2020 632e 7365 6e64 282a          c.send(*
-00035a40: 6d73 6773 290a 2020 2020 2020 2020 2020  msgs).          
-00035a50: 2020 6578 6365 7074 2043 6f6d 6d43 6c6f    except CommClo
-00035a60: 7365 6445 7272 6f72 3a0a 2020 2020 2020  sedError:.      
-00035a70: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00035a80: 662e 7374 6174 7573 203d 3d20 5374 6174  f.status == Stat
-00035a90: 7573 2e72 756e 6e69 6e67 3a0a 2020 2020  us.running:.    
-00035aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035ab0: 6c6f 6767 6572 2e63 7269 7469 6361 6c28  logger.critical(
-00035ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035ad0: 2020 2020 2020 2020 2022 436c 6f73 6564           "Closed
-00035ae0: 2063 6f6d 6d20 2572 2077 6869 6c65 2074   comm %r while t
-00035af0: 7279 696e 6720 746f 2077 7269 7465 2025  rying to write %
-00035b00: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00035b10: 2020 2020 2020 2020 2020 2020 632c 0a20              c,. 
-00035b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035b30: 2020 2020 2020 206d 7367 732c 0a20 2020         msgs,.   
+0002eeb0: 2020 2320 4465 7072 6563 6174 6564 2028    # Deprecated (
+0002eec0: 7365 6520 6164 645f 706c 7567 696e 290a  see add_plugin).
+0002eed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002eee0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+0002eef0: 2070 6c75 6769 6e2e 7265 6d6f 7665 5f77   plugin.remove_w
+0002ef00: 6f72 6b65 7228 7363 6865 6475 6c65 723d  orker(scheduler=
+0002ef10: 7365 6c66 2c20 776f 726b 6572 3d61 6464  self, worker=add
+0002ef20: 7265 7373 2920 2023 2074 7970 653a 2069  ress)  # type: i
+0002ef30: 676e 6f72 650a 2020 2020 2020 2020 2020  gnore.          
+0002ef40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0002ef50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002ef60: 2020 2020 2020 2020 7261 6973 650a 2020          raise.  
+0002ef70: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002ef80: 2069 6e73 7065 6374 2e69 7361 7761 6974   inspect.isawait
+0002ef90: 6162 6c65 2872 6573 756c 7429 3a0a 2020  able(result):.  
+0002efa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002efb0: 2020 6177 6169 7461 626c 6573 2e61 7070    awaitables.app
+0002efc0: 656e 6428 7265 7375 6c74 290a 2020 2020  end(result).    
+0002efd0: 2020 2020 2020 2020 6578 6365 7074 2045          except E
+0002efe0: 7863 6570 7469 6f6e 2061 7320 653a 0a20  xception as e:. 
+0002eff0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0002f000: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
+0002f010: 6529 0a0a 2020 2020 2020 2020 706c 7567  e)..        plug
+0002f020: 696e 5f6d 7367 7320 3d20 6177 6169 7420  in_msgs = await 
+0002f030: 6173 796e 6369 6f2e 6761 7468 6572 282a  asyncio.gather(*
+0002f040: 6177 6169 7461 626c 6573 2c20 7265 7475  awaitables, retu
+0002f050: 726e 5f65 7863 6570 7469 6f6e 733d 5472  rn_exceptions=Tr
+0002f060: 7565 290a 2020 2020 2020 2020 706c 7567  ue).        plug
+0002f070: 696e 735f 6578 6365 7074 696f 6e73 203d  ins_exceptions =
+0002f080: 205b 6d73 6720 666f 7220 6d73 6720 696e   [msg for msg in
+0002f090: 2070 6c75 6769 6e5f 6d73 6773 2069 6620   plugin_msgs if 
+0002f0a0: 6973 696e 7374 616e 6365 286d 7367 2c20  isinstance(msg, 
+0002f0b0: 4578 6365 7074 696f 6e29 5d0a 2020 2020  Exception)].    
+0002f0c0: 2020 2020 666f 7220 6578 6320 696e 2070      for exc in p
+0002f0d0: 6c75 6769 6e73 5f65 7863 6570 7469 6f6e  lugins_exception
+0002f0e0: 733a 0a20 2020 2020 2020 2020 2020 206c  s:.            l
+0002f0f0: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
+0002f100: 6578 632c 2065 7863 5f69 6e66 6f3d 6578  exc, exc_info=ex
+0002f110: 6329 0a0a 2020 2020 2020 2020 6966 206e  c)..        if n
+0002f120: 6f74 2073 656c 662e 776f 726b 6572 733a  ot self.workers:
+0002f130: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+0002f140: 6765 722e 696e 666f 2822 4c6f 7374 2061  ger.info("Lost a
+0002f150: 6c6c 2077 6f72 6b65 7273 2229 0a0a 2020  ll workers")..  
+0002f160: 2020 2020 2020 666f 7220 7720 696e 2073        for w in s
+0002f170: 656c 662e 776f 726b 6572 733a 0a20 2020  elf.workers:.   
+0002f180: 2020 2020 2020 2020 2073 656c 662e 6261           self.ba
+0002f190: 6e64 7769 6474 685f 776f 726b 6572 732e  ndwidth_workers.
+0002f1a0: 706f 7028 2861 6464 7265 7373 2c20 7729  pop((address, w)
+0002f1b0: 2c20 4e6f 6e65 290a 2020 2020 2020 2020  , None).        
+0002f1c0: 2020 2020 7365 6c66 2e62 616e 6477 6964      self.bandwid
+0002f1d0: 7468 5f77 6f72 6b65 7273 2e70 6f70 2828  th_workers.pop((
+0002f1e0: 772c 2061 6464 7265 7373 292c 204e 6f6e  w, address), Non
+0002f1f0: 6529 0a0a 2020 2020 2020 2020 6173 796e  e)..        asyn
+0002f200: 6320 6465 6620 7265 6d6f 7665 5f77 6f72  c def remove_wor
+0002f210: 6b65 725f 6672 6f6d 5f65 7665 6e74 7328  ker_from_events(
+0002f220: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0002f230: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
+0002f240: 776f 726b 6572 2069 736e 2774 2072 6567  worker isn't reg
+0002f250: 6973 7465 7265 6420 616e 796d 6f72 6520  istered anymore 
+0002f260: 6166 7465 7220 7468 6520 6465 6c61 792c  after the delay,
+0002f270: 2072 656d 6f76 6520 6672 6f6d 2065 7665   remove from eve
+0002f280: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
+0002f290: 6966 2061 6464 7265 7373 206e 6f74 2069  if address not i
+0002f2a0: 6e20 7365 6c66 2e77 6f72 6b65 7273 2061  n self.workers a
+0002f2b0: 6e64 2061 6464 7265 7373 2069 6e20 7365  nd address in se
+0002f2c0: 6c66 2e65 7665 6e74 733a 0a20 2020 2020  lf.events:.     
+0002f2d0: 2020 2020 2020 2020 2020 2064 656c 2073             del s
+0002f2e0: 656c 662e 6576 656e 7473 5b61 6464 7265  elf.events[addre
+0002f2f0: 7373 5d0a 0a20 2020 2020 2020 2063 6c65  ss]..        cle
+0002f300: 616e 7570 5f64 656c 6179 203d 2070 6172  anup_delay = par
+0002f310: 7365 5f74 696d 6564 656c 7461 280a 2020  se_timedelta(.  
+0002f320: 2020 2020 2020 2020 2020 6461 736b 2e63            dask.c
+0002f330: 6f6e 6669 672e 6765 7428 2264 6973 7472  onfig.get("distr
+0002f340: 6962 7574 6564 2e73 6368 6564 756c 6572  ibuted.scheduler
+0002f350: 2e65 7665 6e74 732d 636c 6561 6e75 702d  .events-cleanup-
+0002f360: 6465 6c61 7922 290a 2020 2020 2020 2020  delay").        
+0002f370: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0002f380: 5f6f 6e67 6f69 6e67 5f62 6163 6b67 726f  _ongoing_backgro
+0002f390: 756e 645f 7461 736b 732e 6361 6c6c 5f6c  und_tasks.call_l
+0002f3a0: 6174 6572 280a 2020 2020 2020 2020 2020  ater(.          
+0002f3b0: 2020 636c 6561 6e75 705f 6465 6c61 792c    cleanup_delay,
+0002f3c0: 2072 656d 6f76 655f 776f 726b 6572 5f66   remove_worker_f
+0002f3d0: 726f 6d5f 6576 656e 7473 0a20 2020 2020  rom_events.     
+0002f3e0: 2020 2029 0a20 2020 2020 2020 206c 6f67     ).        log
+0002f3f0: 6765 722e 6465 6275 6728 2252 656d 6f76  ger.debug("Remov
+0002f400: 6564 2077 6f72 6b65 7220 2573 222c 2077  ed worker %s", w
+0002f410: 7329 0a0a 2020 2020 2020 2020 666f 7220  s)..        for 
+0002f420: 7720 696e 2073 656c 662e 776f 726b 6572  w in self.worker
+0002f430: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+0002f440: 656c 662e 776f 726b 6572 5f73 656e 6428  elf.worker_send(
+0002f450: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f460: 2077 2c0a 2020 2020 2020 2020 2020 2020   w,.            
+0002f470: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
+0002f480: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
+0002f490: 2272 656d 6f76 652d 776f 726b 6572 222c  "remove-worker",
+0002f4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002f4b0: 2020 2020 2022 776f 726b 6572 223a 2061       "worker": a
+0002f4c0: 6464 7265 7373 2c0a 2020 2020 2020 2020  ddress,.        
+0002f4d0: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+0002f4e0: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
+0002f4f0: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+0002f500: 2020 2020 2020 2020 7d2c 0a20 2020 2020          },.     
+0002f510: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0002f520: 2020 7265 7475 726e 2022 4f4b 220a 0a20    return "OK".. 
+0002f530: 2020 2064 6566 2073 7469 6d75 6c75 735f     def stimulus_
+0002f540: 6361 6e63 656c 280a 2020 2020 2020 2020  cancel(.        
+0002f550: 7365 6c66 2c20 6b65 7973 3a20 436f 6c6c  self, keys: Coll
+0002f560: 6563 7469 6f6e 5b4b 6579 5d2c 2063 6c69  ection[Key], cli
+0002f570: 656e 743a 2073 7472 2c20 666f 7263 653a  ent: str, force:
+0002f580: 2062 6f6f 6c20 3d20 4661 6c73 650a 2020   bool = False.  
+0002f590: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+0002f5a0: 2020 2020 2022 2222 5374 6f70 2065 7865       """Stop exe
+0002f5b0: 6375 7469 6f6e 206f 6e20 6120 6c69 7374  cution on a list
+0002f5c0: 206f 6620 6b65 7973 2222 220a 2020 2020   of keys""".    
+0002f5d0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+0002f5e0: 2243 6c69 656e 7420 2573 2072 6571 7565  "Client %s reque
+0002f5f0: 7374 7320 746f 2063 616e 6365 6c20 2564  sts to cancel %d
+0002f600: 206b 6579 7322 2c20 636c 6965 6e74 2c20   keys", client, 
+0002f610: 6c65 6e28 6b65 7973 2929 0a20 2020 2020  len(keys)).     
+0002f620: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+0002f630: 7428 636c 6965 6e74 2c20 7b22 6163 7469  t(client, {"acti
+0002f640: 6f6e 223a 2022 6361 6e63 656c 222c 2022  on": "cancel", "
+0002f650: 636f 756e 7422 3a20 6c65 6e28 6b65 7973  count": len(keys
+0002f660: 292c 2022 666f 7263 6522 3a20 666f 7263  ), "force": forc
+0002f670: 657d 290a 2020 2020 2020 2020 6373 203d  e}).        cs =
+0002f680: 2073 656c 662e 636c 6965 6e74 732e 6765   self.clients.ge
+0002f690: 7428 636c 6965 6e74 290a 2020 2020 2020  t(client).      
+0002f6a0: 2020 6966 206e 6f74 2063 733a 0a20 2020    if not cs:.   
+0002f6b0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0002f6c0: 0a20 2020 2020 2020 2063 616e 6365 6c6c  .        cancell
+0002f6d0: 6564 5f6b 6579 7320 3d20 5b5d 0a20 2020  ed_keys = [].   
+0002f6e0: 2020 2020 2063 6c69 656e 7473 203d 205b       clients = [
+0002f6f0: 5d0a 2020 2020 2020 2020 666f 7220 6b65  ].        for ke
+0002f700: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
+0002f710: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+0002f720: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
+0002f730: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0002f740: 6f74 2074 733a 0a20 2020 2020 2020 2020  ot ts:.         
+0002f750: 2020 2020 2020 2063 6f6e 7469 6e75 650a         continue.
+0002f760: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0002f770: 666f 7263 6520 6f72 2074 732e 7768 6f5f  force or ts.who_
+0002f780: 7761 6e74 7320 3d3d 207b 6373 7d3a 2020  wants == {cs}:  
+0002f790: 2320 6e6f 206f 6e65 2065 6c73 6520 7761  # no one else wa
+0002f7a0: 6e74 7320 7468 6973 206b 6579 0a20 2020  nts this key.   
+0002f7b0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002f7c0: 7473 2e64 6570 656e 6465 6e74 733a 0a20  ts.dependents:. 
+0002f7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f7e0: 2020 2073 656c 662e 7374 696d 756c 7573     self.stimulus
+0002f7f0: 5f63 616e 6365 6c28 0a20 2020 2020 2020  _cancel(.       
+0002f800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002f810: 205b 6474 732e 6b65 7920 666f 7220 6474   [dts.key for dt
+0002f820: 7320 696e 2074 732e 6465 7065 6e64 656e  s in ts.dependen
+0002f830: 7473 5d2c 2063 6c69 656e 742c 2066 6f72  ts], client, for
+0002f840: 6365 3d66 6f72 6365 0a20 2020 2020 2020  ce=force.       
+0002f850: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0002f860: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0002f870: 6f67 6765 722e 696e 666f 2822 5363 6865  ogger.info("Sche
+0002f880: 6475 6c65 7220 6361 6e63 656c 7320 6b65  duler cancels ke
+0002f890: 7920 2573 2e20 2046 6f72 6365 3d25 7322  y %s.  Force=%s"
+0002f8a0: 2c20 6b65 792c 2066 6f72 6365 290a 2020  , key, force).  
+0002f8b0: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+0002f8c0: 6e63 656c 6c65 645f 6b65 7973 2e61 7070  ncelled_keys.app
+0002f8d0: 656e 6428 6b65 7929 0a20 2020 2020 2020  end(key).       
+0002f8e0: 2020 2020 2061 7373 6572 7420 7473 2e77       assert ts.w
+0002f8f0: 686f 5f77 616e 7473 0a20 2020 2020 2020  ho_wants.       
+0002f900: 2020 2020 2063 6c69 656e 7473 2e65 7874       clients.ext
+0002f910: 656e 6428 6c69 7374 2874 732e 7768 6f5f  end(list(ts.who_
+0002f920: 7761 6e74 7329 2069 6620 666f 7263 6520  wants) if force 
+0002f930: 656c 7365 205b 6373 5d29 0a20 2020 2020  else [cs]).     
+0002f940: 2020 2066 6f72 2063 7320 696e 2063 6c69     for cs in cli
+0002f950: 656e 7473 3a0a 2020 2020 2020 2020 2020  ents:.          
+0002f960: 2020 7365 6c66 2e63 6c69 656e 745f 7265    self.client_re
+0002f970: 6c65 6173 6573 5f6b 6579 7328 0a20 2020  leases_keys(.   
+0002f980: 2020 2020 2020 2020 2020 2020 206b 6579               key
+0002f990: 733d 6361 6e63 656c 6c65 645f 6b65 7973  s=cancelled_keys
+0002f9a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0002f9b0: 2020 636c 6965 6e74 3d63 732e 636c 6965    client=cs.clie
+0002f9c0: 6e74 5f6b 6579 2c0a 2020 2020 2020 2020  nt_key,.        
+0002f9d0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+0002f9e0: 5f69 643d 6622 6361 6e63 656c 2d6b 6579  _id=f"cancel-key
+0002f9f0: 2d7b 7469 6d65 2829 7d22 2c0a 2020 2020  -{time()}",.    
+0002fa00: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0002fa10: 2020 7365 6c66 2e72 6570 6f72 7428 7b22    self.report({"
+0002fa20: 6f70 223a 2022 6361 6e63 656c 6c65 642d  op": "cancelled-
+0002fa30: 6b65 7973 222c 2022 6b65 7973 223a 2063  keys", "keys": c
+0002fa40: 616e 6365 6c6c 6564 5f6b 6579 737d 290a  ancelled_keys}).
+0002fa50: 0a20 2020 2064 6566 2063 6c69 656e 745f  .    def client_
+0002fa60: 6465 7369 7265 735f 6b65 7973 2873 656c  desires_keys(sel
+0002fa70: 662c 206b 6579 733a 2043 6f6c 6c65 6374  f, keys: Collect
+0002fa80: 696f 6e5b 4b65 795d 2c20 636c 6965 6e74  ion[Key], client
+0002fa90: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
+0002faa0: 2020 2020 2020 2020 6373 203d 2073 656c          cs = sel
+0002fab0: 662e 636c 6965 6e74 732e 6765 7428 636c  f.clients.get(cl
+0002fac0: 6965 6e74 290a 2020 2020 2020 2020 6966  ient).        if
+0002fad0: 2063 7320 6973 204e 6f6e 653a 0a20 2020   cs is None:.   
+0002fae0: 2020 2020 2020 2020 2023 2046 6f72 2070           # For p
+0002faf0: 7562 6c69 7368 2c20 7175 6575 6573 2065  ublish, queues e
+0002fb00: 7463 2e0a 2020 2020 2020 2020 2020 2020  tc..            
+0002fb10: 7365 6c66 2e63 6c69 656e 7473 5b63 6c69  self.clients[cli
+0002fb20: 656e 745d 203d 2063 7320 3d20 436c 6965  ent] = cs = Clie
+0002fb30: 6e74 5374 6174 6528 636c 6965 6e74 290a  ntState(client).
+0002fb40: 0a20 2020 2020 2020 2066 6f72 206b 2069  .        for k i
+0002fb50: 6e20 6b65 7973 3a0a 2020 2020 2020 2020  n keys:.        
+0002fb60: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+0002fb70: 736b 732e 6765 7428 6b29 0a20 2020 2020  sks.get(k).     
+0002fb80: 2020 2020 2020 2069 6620 7473 2069 7320         if ts is 
+0002fb90: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0002fba0: 2020 2020 2020 2320 466f 7220 7075 626c        # For publ
+0002fbb0: 6973 682c 2071 7565 7565 7320 6574 632e  ish, queues etc.
+0002fbc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002fbd0: 2074 7320 3d20 7365 6c66 2e6e 6577 5f74   ts = self.new_t
+0002fbe0: 6173 6b28 6b2c 204e 6f6e 652c 2022 7265  ask(k, None, "re
+0002fbf0: 6c65 6173 6564 2229 0a20 2020 2020 2020  leased").       
+0002fc00: 2020 2020 2069 6620 7473 2e77 686f 5f77       if ts.who_w
+0002fc10: 616e 7473 2069 7320 4e6f 6e65 3a0a 2020  ants is None:.  
+0002fc20: 2020 2020 2020 2020 2020 2020 2020 7473                ts
+0002fc30: 2e77 686f 5f77 616e 7473 203d 2073 6574  .who_wants = set
+0002fc40: 2829 0a20 2020 2020 2020 2020 2020 2074  ().            t
+0002fc50: 732e 7768 6f5f 7761 6e74 732e 6164 6428  s.who_wants.add(
+0002fc60: 6373 290a 2020 2020 2020 2020 2020 2020  cs).            
+0002fc70: 6373 2e77 616e 7473 5f77 6861 742e 6164  cs.wants_what.ad
+0002fc80: 6428 7473 290a 0a20 2020 2020 2020 2020  d(ts)..         
+0002fc90: 2020 2069 6620 7473 2e73 7461 7465 2069     if ts.state i
+0002fca0: 6e20 2822 6d65 6d6f 7279 222c 2022 6572  n ("memory", "er
+0002fcb0: 7265 6422 293a 0a20 2020 2020 2020 2020  red"):.         
+0002fcc0: 2020 2020 2020 2073 656c 662e 7265 706f         self.repo
+0002fcd0: 7274 5f6f 6e5f 6b65 7928 7473 3d74 732c  rt_on_key(ts=ts,
+0002fce0: 2063 6c69 656e 743d 636c 6965 6e74 290a   client=client).
+0002fcf0: 0a20 2020 2064 6566 2063 6c69 656e 745f  .    def client_
+0002fd00: 7265 6c65 6173 6573 5f6b 6579 7328 0a20  releases_keys(. 
+0002fd10: 2020 2020 2020 2073 656c 662c 206b 6579         self, key
+0002fd20: 733a 2043 6f6c 6c65 6374 696f 6e5b 4b65  s: Collection[Ke
+0002fd30: 795d 2c20 636c 6965 6e74 3a20 7374 722c  y], client: str,
+0002fd40: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+0002fd50: 7220 7c20 4e6f 6e65 203d 204e 6f6e 650a  r | None = None.
+0002fd60: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+0002fd70: 2020 2020 2020 2022 2222 5265 6d6f 7665         """Remove
+0002fd80: 206b 6579 7320 6672 6f6d 2063 6c69 656e   keys from clien
+0002fd90: 7420 6465 7369 7265 6420 6c69 7374 2222  t desired list""
+0002fda0: 220a 2020 2020 2020 2020 7374 696d 756c  ".        stimul
+0002fdb0: 7573 5f69 6420 3d20 7374 696d 756c 7573  us_id = stimulus
+0002fdc0: 5f69 6420 6f72 2066 2263 6c69 656e 742d  _id or f"client-
+0002fdd0: 7265 6c65 6173 6573 2d6b 6579 732d 7b74  releases-keys-{t
+0002fde0: 696d 6528 297d 220a 2020 2020 2020 2020  ime()}".        
+0002fdf0: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
+0002fe00: 6528 6b65 7973 2c20 6c69 7374 293a 0a20  e(keys, list):. 
+0002fe10: 2020 2020 2020 2020 2020 206b 6579 7320             keys 
+0002fe20: 3d20 6c69 7374 286b 6579 7329 0a20 2020  = list(keys).   
+0002fe30: 2020 2020 2063 7320 3d20 7365 6c66 2e63       cs = self.c
+0002fe40: 6c69 656e 7473 5b63 6c69 656e 745d 0a20  lients[client]. 
+0002fe50: 2020 2020 2020 2072 6563 6f6d 6d65 6e64         recommend
+0002fe60: 6174 696f 6e73 3a20 5265 6373 203d 207b  ations: Recs = {
+0002fe70: 7d0a 0a20 2020 2020 2020 2073 656c 662e  }..        self.
+0002fe80: 5f63 6c69 656e 745f 7265 6c65 6173 6573  _client_releases
+0002fe90: 5f6b 6579 7328 6b65 7973 3d6b 6579 732c  _keys(keys=keys,
+0002fea0: 2063 733d 6373 2c20 7265 636f 6d6d 656e   cs=cs, recommen
+0002feb0: 6461 7469 6f6e 733d 7265 636f 6d6d 656e  dations=recommen
+0002fec0: 6461 7469 6f6e 7329 0a20 2020 2020 2020  dations).       
+0002fed0: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
+0002fee0: 7328 7265 636f 6d6d 656e 6461 7469 6f6e  s(recommendation
+0002fef0: 732c 2073 7469 6d75 6c75 735f 6964 290a  s, stimulus_id).
+0002ff00: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+0002ff10: 696d 756c 7573 5f71 7565 7565 5f73 6c6f  imulus_queue_slo
+0002ff20: 7473 5f6d 6179 6265 5f6f 7065 6e65 6428  ts_maybe_opened(
+0002ff30: 7374 696d 756c 7573 5f69 643d 7374 696d  stimulus_id=stim
+0002ff40: 756c 7573 5f69 6429 0a0a 2020 2020 6465  ulus_id)..    de
+0002ff50: 6620 636c 6965 6e74 5f68 6561 7274 6265  f client_heartbe
+0002ff60: 6174 2873 656c 662c 2063 6c69 656e 743a  at(self, client:
+0002ff70: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
+0002ff80: 2020 2020 2020 2022 2222 4861 6e64 6c65         """Handle
+0002ff90: 2068 6561 7274 6265 6174 7320 6672 6f6d   heartbeats from
+0002ffa0: 2043 6c69 656e 7422 2222 0a20 2020 2020   Client""".     
+0002ffb0: 2020 2063 7320 3d20 7365 6c66 2e63 6c69     cs = self.cli
+0002ffc0: 656e 7473 5b63 6c69 656e 745d 0a20 2020  ents[client].   
+0002ffd0: 2020 2020 2063 732e 6c61 7374 5f73 6565       cs.last_see
+0002ffe0: 6e20 3d20 7469 6d65 2829 0a0a 2020 2020  n = time()..    
+0002fff0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00030000: 2323 230a 2020 2020 2320 5461 736b 2056  ###.    # Task V
+00030010: 616c 6964 6174 696f 6e20 230a 2020 2020  alidation #.    
+00030020: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00030030: 2323 230a 0a20 2020 2064 6566 2076 616c  ###..    def val
+00030040: 6964 6174 655f 7265 6c65 6173 6564 2873  idate_released(s
+00030050: 656c 662c 206b 6579 3a20 4b65 7929 202d  elf, key: Key) -
+00030060: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00030070: 7473 203d 2073 656c 662e 7461 736b 735b  ts = self.tasks[
+00030080: 6b65 795d 0a20 2020 2020 2020 2061 7373  key].        ass
+00030090: 6572 7420 7473 2e73 7461 7465 203d 3d20  ert ts.state == 
+000300a0: 2272 656c 6561 7365 6422 0a20 2020 2020  "released".     
+000300b0: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+000300c0: 2e77 6169 7465 7273 0a20 2020 2020 2020  .waiters.       
+000300d0: 2061 7373 6572 7420 6e6f 7420 7473 2e77   assert not ts.w
+000300e0: 6169 7469 6e67 5f6f 6e0a 2020 2020 2020  aiting_on.      
+000300f0: 2020 6173 7365 7274 206e 6f74 2074 732e    assert not ts.
+00030100: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+00030110: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
+00030120: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+00030130: 2020 2020 6173 7365 7274 206e 6f74 2061      assert not a
+00030140: 6e79 285b 7473 2069 6e20 2864 7473 2e77  ny([ts in (dts.w
+00030150: 6169 7465 7273 206f 7220 2829 2920 666f  aiters or ()) fo
+00030160: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+00030170: 6e64 656e 6369 6573 5d29 0a20 2020 2020  ndencies]).     
+00030180: 2020 2061 7373 6572 7420 7473 206e 6f74     assert ts not
+00030190: 2069 6e20 7365 6c66 2e75 6e72 756e 6e61   in self.unrunna
+000301a0: 626c 650a 2020 2020 2020 2020 6173 7365  ble.        asse
+000301b0: 7274 2074 7320 6e6f 7420 696e 2073 656c  rt ts not in sel
+000301c0: 662e 7175 6575 6564 0a0a 2020 2020 6465  f.queued..    de
+000301d0: 6620 7661 6c69 6461 7465 5f77 6169 7469  f validate_waiti
+000301e0: 6e67 2873 656c 662c 206b 6579 3a20 4b65  ng(self, key: Ke
+000301f0: 7929 202d 3e20 4e6f 6e65 3a0a 2020 2020  y) -> None:.    
+00030200: 2020 2020 7473 203d 2073 656c 662e 7461      ts = self.ta
+00030210: 736b 735b 6b65 795d 0a20 2020 2020 2020  sks[key].       
+00030220: 2061 7373 6572 7420 7473 2e77 6169 7469   assert ts.waiti
+00030230: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
+00030240: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
+00030250: 6861 730a 2020 2020 2020 2020 6173 7365  has.        asse
+00030260: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
+00030270: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+00030280: 6173 7365 7274 2074 7320 6e6f 7420 696e  assert ts not in
+00030290: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
+000302a0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000302b0: 7473 206e 6f74 2069 6e20 7365 6c66 2e71  ts not in self.q
+000302c0: 7565 7565 640a 2020 2020 2020 2020 666f  ueued.        fo
+000302d0: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
+000302e0: 6e64 656e 6369 6573 3a0a 2020 2020 2020  ndencies:.      
+000302f0: 2020 2020 2020 2320 5765 2061 7265 2077        # We are w
+00030300: 6169 7469 6e67 206f 6e20 6120 6465 7065  aiting on a depe
+00030310: 6e64 656e 6379 2069 6666 2069 7427 7320  ndency iff it's 
+00030320: 6e6f 7420 7374 6f72 6564 0a20 2020 2020  not stored.     
+00030330: 2020 2020 2020 2061 7373 6572 7420 626f         assert bo
+00030340: 6f6c 2864 7473 2e77 686f 5f68 6173 2920  ol(dts.who_has) 
+00030350: 213d 2028 6474 7320 696e 2028 7473 2e77  != (dts in (ts.w
+00030360: 6169 7469 6e67 5f6f 6e20 6f72 2028 2929  aiting_on or ())
+00030370: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00030380: 7365 7274 2074 7320 696e 2028 6474 732e  sert ts in (dts.
+00030390: 7761 6974 6572 7320 6f72 2028 2929 2020  waiters or ())  
+000303a0: 2320 5858 5820 6576 656e 2069 6620 6474  # XXX even if dt
+000303b0: 732e 5f77 686f 5f68 6173 3f0a 0a20 2020  s._who_has?..   
+000303c0: 2064 6566 2076 616c 6964 6174 655f 7175   def validate_qu
+000303d0: 6575 6564 2873 656c 662c 206b 6579 3a20  eued(self, key: 
+000303e0: 4b65 7929 202d 3e20 4e6f 6e65 3a0a 2020  Key) -> None:.  
+000303f0: 2020 2020 2020 7473 203d 2073 656c 662e        ts = self.
+00030400: 7461 736b 735b 6b65 795d 0a20 2020 2020  tasks[key].     
+00030410: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
+00030420: 7365 6c66 2e71 7565 7565 640a 2020 2020  self.queued.    
+00030430: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00030440: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+00030450: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+00030460: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
+00030470: 2020 2061 7373 6572 7420 6e6f 7420 7473     assert not ts
+00030480: 2e70 726f 6365 7373 696e 675f 6f6e 0a20  .processing_on. 
+00030490: 2020 2020 2020 2061 7373 6572 7420 6e6f         assert no
+000304a0: 7420 280a 2020 2020 2020 2020 2020 2020  t (.            
+000304b0: 7473 2e77 6f72 6b65 725f 7265 7374 7269  ts.worker_restri
+000304c0: 6374 696f 6e73 206f 7220 7473 2e68 6f73  ctions or ts.hos
+000304d0: 745f 7265 7374 7269 6374 696f 6e73 206f  t_restrictions o
+000304e0: 7220 7473 2e72 6573 6f75 7263 655f 7265  r ts.resource_re
+000304f0: 7374 7269 6374 696f 6e73 0a20 2020 2020  strictions.     
+00030500: 2020 2029 0a20 2020 2020 2020 2066 6f72     ).        for
+00030510: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+00030520: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+00030530: 2020 2020 2061 7373 6572 7420 6474 732e       assert dts.
+00030540: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+00030550: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+00030560: 2028 6474 732e 7761 6974 6572 7320 6f72   (dts.waiters or
+00030570: 2028 2929 0a0a 2020 2020 6465 6620 7661   ())..    def va
+00030580: 6c69 6461 7465 5f70 726f 6365 7373 696e  lidate_processin
+00030590: 6728 7365 6c66 2c20 6b65 793a 204b 6579  g(self, key: Key
+000305a0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+000305b0: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+000305c0: 6b73 5b6b 6579 5d0a 2020 2020 2020 2020  ks[key].        
+000305d0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+000305e0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+000305f0: 2077 7320 3d20 7473 2e70 726f 6365 7373   ws = ts.process
+00030600: 696e 675f 6f6e 0a20 2020 2020 2020 2061  ing_on.        a
+00030610: 7373 6572 7420 7773 0a20 2020 2020 2020  ssert ws.       
+00030620: 2061 7373 6572 7420 7473 2069 6e20 7773   assert ts in ws
+00030630: 2e70 726f 6365 7373 696e 670a 2020 2020  .processing.    
+00030640: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+00030650: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
+00030660: 2020 6173 7365 7274 2074 7320 6e6f 7420    assert ts not 
+00030670: 696e 2073 656c 662e 7175 6575 6564 0a20  in self.queued. 
+00030680: 2020 2020 2020 2066 6f72 2064 7473 2069         for dts i
+00030690: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
+000306a0: 733a 0a20 2020 2020 2020 2020 2020 2061  s:.            a
+000306b0: 7373 6572 7420 6474 732e 7768 6f5f 6861  ssert dts.who_ha
+000306c0: 7320 6f72 2028 290a 2020 2020 2020 2020  s or ().        
+000306d0: 2020 2020 6173 7365 7274 2074 7320 696e      assert ts in
+000306e0: 2028 6474 732e 7761 6974 6572 7320 6f72   (dts.waiters or
+000306f0: 2028 2929 0a0a 2020 2020 6465 6620 7661   ())..    def va
+00030700: 6c69 6461 7465 5f6d 656d 6f72 7928 7365  lidate_memory(se
+00030710: 6c66 2c20 6b65 793a 204b 6579 2920 2d3e  lf, key: Key) ->
+00030720: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
+00030730: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
+00030740: 6579 5d0a 2020 2020 2020 2020 6173 7365  ey].        asse
+00030750: 7274 2074 732e 7768 6f5f 6861 730a 2020  rt ts.who_has.  
+00030760: 2020 2020 2020 6173 7365 7274 2062 6f6f        assert boo
+00030770: 6c28 7473 2069 6e20 7365 6c66 2e72 6570  l(ts in self.rep
+00030780: 6c69 6361 7465 645f 7461 736b 7329 203d  licated_tasks) =
+00030790: 3d20 286c 656e 2874 732e 7768 6f5f 6861  = (len(ts.who_ha
+000307a0: 7329 203e 2031 290a 2020 2020 2020 2020  s) > 1).        
+000307b0: 6173 7365 7274 206e 6f74 2074 732e 7072  assert not ts.pr
+000307c0: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+000307d0: 2020 2020 6173 7365 7274 206e 6f74 2074      assert not t
+000307e0: 732e 7761 6974 696e 675f 6f6e 0a20 2020  s.waiting_on.   
+000307f0: 2020 2020 2061 7373 6572 7420 7473 206e       assert ts n
+00030800: 6f74 2069 6e20 7365 6c66 2e75 6e72 756e  ot in self.unrun
+00030810: 6e61 626c 650a 2020 2020 2020 2020 6173  nable.        as
+00030820: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+00030830: 656c 662e 7175 6575 6564 0a20 2020 2020  elf.queued.     
+00030840: 2020 2066 6f72 2064 7473 2069 6e20 7473     for dts in ts
+00030850: 2e64 6570 656e 6465 6e74 733a 0a20 2020  .dependents:.   
+00030860: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00030870: 2864 7473 2069 6e20 2874 732e 7761 6974  (dts in (ts.wait
+00030880: 6572 7320 6f72 2028 2929 2920 3d3d 2028  ers or ())) == (
+00030890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000308a0: 2064 7473 2e73 7461 7465 2069 6e20 2822   dts.state in ("
+000308b0: 7761 6974 696e 6722 2c20 2271 7565 7565  waiting", "queue
+000308c0: 6422 2c20 2270 726f 6365 7373 696e 6722  d", "processing"
+000308d0: 2c20 226e 6f2d 776f 726b 6572 2229 0a20  , "no-worker"). 
+000308e0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+000308f0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
+00030900: 7473 206e 6f74 2069 6e20 2864 7473 2e77  ts not in (dts.w
+00030910: 6169 7469 6e67 5f6f 6e20 6f72 2028 2929  aiting_on or ())
+00030920: 0a0a 2020 2020 6465 6620 7661 6c69 6461  ..    def valida
+00030930: 7465 5f6e 6f5f 776f 726b 6572 2873 656c  te_no_worker(sel
+00030940: 662c 206b 6579 3a20 4b65 7929 202d 3e20  f, key: Key) -> 
+00030950: 4e6f 6e65 3a0a 2020 2020 2020 2020 7473  None:.        ts
+00030960: 203d 2073 656c 662e 7461 736b 735b 6b65   = self.tasks[ke
+00030970: 795d 0a20 2020 2020 2020 2061 7373 6572  y].        asser
+00030980: 7420 7473 2069 6e20 7365 6c66 2e75 6e72  t ts in self.unr
+00030990: 756e 6e61 626c 650a 2020 2020 2020 2020  unnable.        
+000309a0: 6173 7365 7274 206e 6f74 2074 732e 7761  assert not ts.wa
+000309b0: 6974 696e 675f 6f6e 0a20 2020 2020 2020  iting_on.       
+000309c0: 2061 7373 6572 7420 7473 2069 6e20 7365   assert ts in se
+000309d0: 6c66 2e75 6e72 756e 6e61 626c 650a 2020  lf.unrunnable.  
+000309e0: 2020 2020 2020 6173 7365 7274 206e 6f74        assert not
+000309f0: 2074 732e 7072 6f63 6573 7369 6e67 5f6f   ts.processing_o
+00030a00: 6e0a 2020 2020 2020 2020 6173 7365 7274  n.        assert
+00030a10: 206e 6f74 2074 732e 7768 6f5f 6861 730a   not ts.who_has.
+00030a20: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
+00030a30: 7320 6e6f 7420 696e 2073 656c 662e 7175  s not in self.qu
+00030a40: 6575 6564 0a20 2020 2020 2020 2066 6f72  eued.        for
+00030a50: 2064 7473 2069 6e20 7473 2e64 6570 656e   dts in ts.depen
+00030a60: 6465 6e63 6965 733a 0a20 2020 2020 2020  dencies:.       
+00030a70: 2020 2020 2061 7373 6572 7420 6474 732e       assert dts.
+00030a80: 7768 6f5f 6861 730a 0a20 2020 2064 6566  who_has..    def
+00030a90: 2076 616c 6964 6174 655f 6572 7265 6428   validate_erred(
+00030aa0: 7365 6c66 2c20 6b65 793a 204b 6579 2920  self, key: Key) 
+00030ab0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00030ac0: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+00030ad0: 5b6b 6579 5d0a 2020 2020 2020 2020 6173  [key].        as
+00030ae0: 7365 7274 2074 732e 6578 6365 7074 696f  sert ts.exceptio
+00030af0: 6e5f 626c 616d 650a 2020 2020 2020 2020  n_blame.        
+00030b00: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
+00030b10: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
+00030b20: 7365 7274 2074 7320 6e6f 7420 696e 2073  sert ts not in s
+00030b30: 656c 662e 7175 6575 6564 0a0a 2020 2020  elf.queued..    
+00030b40: 6465 6620 7661 6c69 6461 7465 5f6b 6579  def validate_key
+00030b50: 2873 656c 662c 206b 6579 3a20 4b65 792c  (self, key: Key,
+00030b60: 2074 733a 2054 6173 6b53 7461 7465 207c   ts: TaskState |
+00030b70: 204e 6f6e 6520 3d20 4e6f 6e65 2920 2d3e   None = None) ->
+00030b80: 204e 6f6e 653a 0a20 2020 2020 2020 2074   None:.        t
+00030b90: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00030ba0: 6966 2074 7320 6973 204e 6f6e 653a 0a20  if ts is None:. 
+00030bb0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00030bc0: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
+00030bd0: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
+00030be0: 2020 2020 6966 2074 7320 6973 204e 6f6e      if ts is Non
+00030bf0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00030c00: 2020 206c 6f67 6765 722e 6465 6275 6728     logger.debug(
+00030c10: 224b 6579 206c 6f73 743a 2025 7322 2c20  "Key lost: %s", 
+00030c20: 6b65 7929 0a20 2020 2020 2020 2020 2020  key).           
+00030c30: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00030c40: 2020 2020 2020 2074 732e 7661 6c69 6461         ts.valida
+00030c50: 7465 2829 0a20 2020 2020 2020 2020 2020  te().           
+00030c60: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00030c70: 2020 2020 2020 2020 2020 2020 2020 6675                fu
+00030c80: 6e63 203d 2067 6574 6174 7472 2873 656c  nc = getattr(sel
+00030c90: 662c 2022 7661 6c69 6461 7465 5f22 202b  f, "validate_" +
+00030ca0: 2074 732e 7374 6174 652e 7265 706c 6163   ts.state.replac
+00030cb0: 6528 222d 222c 2022 5f22 2929 0a20 2020  e("-", "_")).   
+00030cc0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00030cd0: 6570 7420 4174 7472 6962 7574 6545 7272  ept AttributeErr
+00030ce0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00030cf0: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
+00030d00: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+00030d10: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00030d20: 656c 662e 7661 6c69 6461 7465 5f25 7320  elf.validate_%s 
+00030d30: 6e6f 7420 666f 756e 6422 2c20 7473 2e73  not found", ts.s
+00030d40: 7461 7465 2e72 6570 6c61 6365 2822 2d22  tate.replace("-"
+00030d50: 2c20 225f 2229 0a20 2020 2020 2020 2020  , "_").         
+00030d60: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00030d70: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+00030d80: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00030d90: 2020 2020 2020 2066 756e 6328 6b65 7929         func(key)
+00030da0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00030db0: 4578 6365 7074 696f 6e20 6173 2065 3a0a  Exception as e:.
+00030dc0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+00030dd0: 6572 2e65 7863 6570 7469 6f6e 2865 290a  er.exception(e).
+00030de0: 2020 2020 2020 2020 2020 2020 6966 204c              if L
+00030df0: 4f47 5f50 4442 3a0a 2020 2020 2020 2020  OG_PDB:.        
+00030e00: 2020 2020 2020 2020 696d 706f 7274 2070          import p
+00030e10: 6462 0a0a 2020 2020 2020 2020 2020 2020  db..            
+00030e20: 2020 2020 7064 622e 7365 745f 7472 6163      pdb.set_trac
+00030e30: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+00030e40: 7261 6973 650a 0a20 2020 2064 6566 2076  raise..    def v
+00030e50: 616c 6964 6174 655f 7374 6174 6528 7365  alidate_state(se
+00030e60: 6c66 2c20 616c 6c6f 775f 6f76 6572 6c61  lf, allow_overla
+00030e70: 703a 2062 6f6f 6c20 3d20 4661 6c73 6529  p: bool = False)
+00030e80: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00030e90: 2020 7661 6c69 6461 7465 5f73 7461 7465    validate_state
+00030ea0: 2873 656c 662e 7461 736b 732c 2073 656c  (self.tasks, sel
+00030eb0: 662e 776f 726b 6572 732c 2073 656c 662e  f.workers, self.
+00030ec0: 636c 6965 6e74 7329 0a0a 2020 2020 2020  clients)..      
+00030ed0: 2020 6966 206e 6f74 2028 7365 7428 7365    if not (set(se
+00030ee0: 6c66 2e77 6f72 6b65 7273 2920 3d3d 2073  lf.workers) == s
+00030ef0: 6574 2873 656c 662e 7374 7265 616d 5f63  et(self.stream_c
+00030f00: 6f6d 6d73 2929 3a0a 2020 2020 2020 2020  omms)):.        
+00030f10: 2020 2020 7261 6973 6520 5661 6c75 6545      raise ValueE
+00030f20: 7272 6f72 2822 576f 726b 6572 7320 6e6f  rror("Workers no
+00030f30: 7420 7468 6520 7361 6d65 2069 6e20 616c  t the same in al
+00030f40: 6c20 636f 6c6c 6563 7469 6f6e 7322 290a  l collections").
+00030f50: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00030f60: 7365 6c66 2e72 756e 6e69 6e67 2e69 7373  self.running.iss
+00030f70: 7570 6572 7365 7428 7365 6c66 2e69 646c  uperset(self.idl
+00030f80: 652e 7661 6c75 6573 2829 292c 2028 0a20  e.values()), (. 
+00030f90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00030fa0: 7275 6e6e 696e 672e 636f 7079 2829 2c0a  running.copy(),.
+00030fb0: 2020 2020 2020 2020 2020 2020 7365 7428              set(
+00030fc0: 7365 6c66 2e69 646c 652e 7661 6c75 6573  self.idle.values
+00030fd0: 2829 292c 0a20 2020 2020 2020 2029 0a20  ()),.        ). 
+00030fe0: 2020 2020 2020 2061 7373 6572 7420 7365         assert se
+00030ff0: 6c66 2e72 756e 6e69 6e67 2e69 7373 7570  lf.running.issup
+00031000: 6572 7365 7428 7365 6c66 2e69 646c 655f  erset(self.idle_
+00031010: 7461 736b 5f63 6f75 6e74 292c 2028 0a20  task_count), (. 
+00031020: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00031030: 7275 6e6e 696e 672e 636f 7079 2829 2c0a  running.copy(),.
+00031040: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00031050: 2e69 646c 655f 7461 736b 5f63 6f75 6e74  .idle_task_count
+00031060: 2e63 6f70 7928 292c 0a20 2020 2020 2020  .copy(),.       
+00031070: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
+00031080: 7420 7365 6c66 2e72 756e 6e69 6e67 2e69  t self.running.i
+00031090: 7373 7570 6572 7365 7428 7365 6c66 2e73  ssuperset(self.s
+000310a0: 6174 7572 6174 6564 292c 2028 0a20 2020  aturated), (.   
+000310b0: 2020 2020 2020 2020 2073 656c 662e 7275           self.ru
+000310c0: 6e6e 696e 672e 636f 7079 2829 2c0a 2020  nning.copy(),.  
+000310d0: 2020 2020 2020 2020 2020 7365 6c66 2e73            self.s
+000310e0: 6174 7572 6174 6564 2e63 6f70 7928 292c  aturated.copy(),
+000310f0: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+00031100: 2020 2061 7373 6572 7420 7365 6c66 2e73     assert self.s
+00031110: 6174 7572 6174 6564 2e69 7364 6973 6a6f  aturated.isdisjo
+00031120: 696e 7428 7365 6c66 2e69 646c 652e 7661  int(self.idle.va
+00031130: 6c75 6573 2829 292c 2028 0a20 2020 2020  lues()), (.     
+00031140: 2020 2020 2020 2073 656c 662e 7361 7475         self.satu
+00031150: 7261 7465 642e 636f 7079 2829 2c0a 2020  rated.copy(),.  
+00031160: 2020 2020 2020 2020 2020 7365 7428 7365            set(se
+00031170: 6c66 2e69 646c 652e 7661 6c75 6573 2829  lf.idle.values()
+00031180: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
+00031190: 2020 2020 2020 7461 736b 5f70 7265 6669        task_prefi
+000311a0: 785f 636f 756e 7473 3a20 6465 6661 756c  x_counts: defaul
+000311b0: 7464 6963 745b 7374 722c 2069 6e74 5d20  tdict[str, int] 
+000311c0: 3d20 6465 6661 756c 7464 6963 7428 696e  = defaultdict(in
+000311d0: 7429 0a20 2020 2020 2020 2066 6f72 2077  t).        for w
+000311e0: 2c20 7773 2069 6e20 7365 6c66 2e77 6f72  , ws in self.wor
+000311f0: 6b65 7273 2e69 7465 6d73 2829 3a0a 2020  kers.items():.  
+00031200: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00031210: 2069 7369 6e73 7461 6e63 6528 772c 2073   isinstance(w, s
+00031220: 7472 292c 2028 7479 7065 2877 292c 2077  tr), (type(w), w
+00031230: 290a 2020 2020 2020 2020 2020 2020 6173  ).            as
+00031240: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00031250: 7773 2c20 576f 726b 6572 5374 6174 6529  ws, WorkerState)
+00031260: 2c20 2874 7970 6528 7773 292c 2077 7329  , (type(ws), ws)
+00031270: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00031280: 6572 7420 7773 2e61 6464 7265 7373 203d  ert ws.address =
+00031290: 3d20 770a 0a20 2020 2020 2020 2020 2020  = w..           
+000312a0: 2069 6620 7773 2e73 7461 7475 7320 3d3d   if ws.status ==
+000312b0: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
+000312c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000312d0: 2061 7373 6572 7420 7773 2069 6e20 7365   assert ws in se
+000312e0: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
+000312f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00031300: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+00031310: 6572 7420 7773 206e 6f74 2069 6e20 7365  ert ws not in se
+00031320: 6c66 2e72 756e 6e69 6e67 0a20 2020 2020  lf.running.     
+00031330: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00031340: 7420 7773 2e61 6464 7265 7373 206e 6f74  t ws.address not
+00031350: 2069 6e20 7365 6c66 2e69 646c 650a 2020   in self.idle.  
+00031360: 2020 2020 2020 2020 2020 2020 2020 6173                as
+00031370: 7365 7274 2077 7320 6e6f 7420 696e 2073  sert ws not in s
+00031380: 656c 662e 7361 7475 7261 7465 640a 0a20  elf.saturated.. 
+00031390: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000313a0: 7420 7773 2e6c 6f6e 675f 7275 6e6e 696e  t ws.long_runnin
+000313b0: 672e 6973 7375 6273 6574 2877 732e 7072  g.issubset(ws.pr
+000313c0: 6f63 6573 7369 6e67 290a 2020 2020 2020  ocessing).      
+000313d0: 2020 2020 2020 6966 206e 6f74 2077 732e        if not ws.
+000313e0: 7072 6f63 6573 7369 6e67 3a0a 2020 2020  processing:.    
+000313f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00031400: 7274 206e 6f74 2077 732e 6f63 6375 7061  rt not ws.occupa
+00031410: 6e63 790a 2020 2020 2020 2020 2020 2020  ncy.            
+00031420: 2020 2020 6966 2077 732e 7374 6174 7573      if ws.status
+00031430: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+00031440: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+00031450: 2020 2020 2020 2020 6173 7365 7274 2077          assert w
+00031460: 732e 6164 6472 6573 7320 696e 2073 656c  s.address in sel
+00031470: 662e 6964 6c65 0a20 2020 2020 2020 2020  f.idle.         
+00031480: 2020 2061 7373 6572 7420 6e6f 7420 7773     assert not ws
+00031490: 2e6e 6565 6473 5f77 6861 742e 6b65 7973  .needs_what.keys
+000314a0: 2829 2026 2077 732e 6861 735f 7768 6174  () & ws.has_what
+000314b0: 0a20 2020 2020 2020 2020 2020 2061 6374  .            act
+000314c0: 7561 6c5f 6e65 6564 735f 7768 6174 3a20  ual_needs_what: 
+000314d0: 6465 6661 756c 7464 6963 745b 5461 736b  defaultdict[Task
+000314e0: 5374 6174 652c 2069 6e74 5d20 3d20 6465  State, int] = de
+000314f0: 6661 756c 7464 6963 7428 696e 7429 0a20  faultdict(int). 
+00031500: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+00031510: 7320 696e 2077 732e 7072 6f63 6573 7369  s in ws.processi
+00031520: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+00031530: 2020 2020 666f 7220 7473 7320 696e 2074      for tss in t
+00031540: 732e 6465 7065 6e64 656e 6369 6573 3a0a  s.dependencies:.
+00031550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031560: 2020 2020 6966 2074 7373 206e 6f74 2069      if tss not i
+00031570: 6e20 7773 2e68 6173 5f77 6861 743a 0a20  n ws.has_what:. 
+00031580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031590: 2020 2020 2020 2061 6374 7561 6c5f 6e65         actual_ne
+000315a0: 6564 735f 7768 6174 5b74 7373 5d20 2b3d  eds_what[tss] +=
+000315b0: 2031 0a20 2020 2020 2020 2020 2020 2061   1.            a
+000315c0: 7373 6572 7420 6163 7475 616c 5f6e 6565  ssert actual_nee
+000315d0: 6473 5f77 6861 7420 3d3d 2077 732e 6e65  ds_what == ws.ne
+000315e0: 6564 735f 7768 6174 0a20 2020 2020 2020  eds_what.       
+000315f0: 2020 2020 2061 7373 6572 7420 2877 732e       assert (ws.
+00031600: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+00031610: 2e72 756e 6e69 6e67 2920 3d3d 2028 7773  .running) == (ws
+00031620: 2069 6e20 7365 6c66 2e72 756e 6e69 6e67   in self.running
+00031630: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00031640: 7220 6e61 6d65 2c20 636f 756e 7420 696e  r name, count in
+00031650: 2077 732e 7461 736b 5f70 7265 6669 785f   ws.task_prefix_
+00031660: 636f 756e 742e 6974 656d 7328 293a 0a20  count.items():. 
+00031670: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00031680: 6173 6b5f 7072 6566 6978 5f63 6f75 6e74  ask_prefix_count
+00031690: 735b 6e61 6d65 5d20 2b3d 2063 6f75 6e74  s[name] += count
+000316a0: 0a0a 2020 2020 2020 2020 6173 7365 7274  ..        assert
+000316b0: 2074 6173 6b5f 7072 6566 6978 5f63 6f75   task_prefix_cou
+000316c0: 6e74 732e 6b65 7973 2829 203d 3d20 7365  nts.keys() == se
+000316d0: 6c66 2e5f 7461 736b 5f70 7265 6669 785f  lf._task_prefix_
+000316e0: 636f 756e 745f 676c 6f62 616c 2e6b 6579  count_global.key
+000316f0: 7328 290a 2020 2020 2020 2020 666f 7220  s().        for 
+00031700: 6e61 6d65 2c20 676c 6f62 616c 5f63 6f75  name, global_cou
+00031710: 6e74 2069 6e20 7365 6c66 2e5f 7461 736b  nt in self._task
+00031720: 5f70 7265 6669 785f 636f 756e 745f 676c  _prefix_count_gl
+00031730: 6f62 616c 2e69 7465 6d73 2829 3a0a 2020  obal.items():.  
+00031740: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+00031750: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
+00031760: 2020 2074 6173 6b5f 7072 6566 6978 5f63     task_prefix_c
+00031770: 6f75 6e74 735b 6e61 6d65 5d20 3d3d 2067  ounts[name] == g
+00031780: 6c6f 6261 6c5f 636f 756e 740a 2020 2020  lobal_count.    
+00031790: 2020 2020 2020 2020 292c 2066 227b 6e61          ), f"{na
+000317a0: 6d65 7d3a 207b 7461 736b 5f70 7265 6669  me}: {task_prefi
+000317b0: 785f 636f 756e 7473 5b6e 616d 655d 7d20  x_counts[name]} 
+000317c0: 2877 7373 292c 207b 676c 6f62 616c 5f63  (wss), {global_c
+000317d0: 6f75 6e74 7d20 2867 6c6f 6261 6c29 220a  ount} (global)".
+000317e0: 0a20 2020 2020 2020 2066 6f72 2077 7320  .        for ws 
+000317f0: 696e 2073 656c 662e 7275 6e6e 696e 673a  in self.running:
+00031800: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00031810: 6572 7420 7773 2e73 7461 7475 7320 3d3d  ert ws.status ==
+00031820: 2053 7461 7475 732e 7275 6e6e 696e 670a   Status.running.
+00031830: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00031840: 7274 2077 732e 6164 6472 6573 7320 696e  rt ws.address in
+00031850: 2073 656c 662e 776f 726b 6572 730a 0a20   self.workers.. 
+00031860: 2020 2020 2020 2066 6f72 206b 2c20 7473         for k, ts
+00031870: 2069 6e20 7365 6c66 2e74 6173 6b73 2e69   in self.tasks.i
+00031880: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+00031890: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+000318a0: 7461 6e63 6528 7473 2c20 5461 736b 5374  tance(ts, TaskSt
+000318b0: 6174 6529 2c20 2874 7970 6528 7473 292c  ate), (type(ts),
+000318c0: 2074 7329 0a20 2020 2020 2020 2020 2020   ts).           
+000318d0: 2061 7373 6572 7420 7473 2e6b 6579 203d   assert ts.key =
+000318e0: 3d20 6b0a 2020 2020 2020 2020 2020 2020  = k.            
+000318f0: 6173 7365 7274 2062 6f6f 6c28 7473 2069  assert bool(ts i
+00031900: 6e20 7365 6c66 2e72 6570 6c69 6361 7465  n self.replicate
+00031910: 645f 7461 736b 7329 203d 3d20 286c 656e  d_tasks) == (len
+00031920: 2874 732e 7768 6f5f 6861 7320 6f72 2028  (ts.who_has or (
+00031930: 2929 203e 2031 290a 2020 2020 2020 2020  )) > 1).        
+00031940: 2020 2020 7365 6c66 2e76 616c 6964 6174      self.validat
+00031950: 655f 6b65 7928 6b2c 2074 7329 0a0a 2020  e_key(k, ts)..  
+00031960: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
+00031970: 7365 6c66 2e72 6570 6c69 6361 7465 645f  self.replicated_
+00031980: 7461 736b 733a 0a20 2020 2020 2020 2020  tasks:.         
+00031990: 2020 2061 7373 6572 7420 7473 2e73 7461     assert ts.sta
+000319a0: 7465 203d 3d20 226d 656d 6f72 7922 0a20  te == "memory". 
+000319b0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000319c0: 7420 7473 2e6b 6579 2069 6e20 7365 6c66  t ts.key in self
+000319d0: 2e74 6173 6b73 0a0a 2020 2020 2020 2020  .tasks..        
+000319e0: 666f 7220 632c 2063 7320 696e 2073 656c  for c, cs in sel
+000319f0: 662e 636c 6965 6e74 732e 6974 656d 7328  f.clients.items(
+00031a00: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+00031a10: 2063 6c69 656e 743d 4e6f 6e65 2069 7320   client=None is 
+00031a20: 6f66 7465 6e20 7573 6564 2069 6e20 7465  often used in te
+00031a30: 7374 732e 2e2e 0a20 2020 2020 2020 2020  sts....         
+00031a40: 2020 2061 7373 6572 7420 6320 6973 204e     assert c is N
+00031a50: 6f6e 6520 6f72 2074 7970 6528 6329 203d  one or type(c) =
+00031a60: 3d20 7374 722c 2028 7479 7065 2863 292c  = str, (type(c),
+00031a70: 2063 290a 2020 2020 2020 2020 2020 2020   c).            
+00031a80: 6173 7365 7274 2074 7970 6528 6373 2920  assert type(cs) 
+00031a90: 3d3d 2043 6c69 656e 7453 7461 7465 2c20  == ClientState, 
+00031aa0: 2874 7970 6528 6373 292c 2063 7329 0a20  (type(cs), cs). 
+00031ab0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00031ac0: 7420 6373 2e63 6c69 656e 745f 6b65 7920  t cs.client_key 
+00031ad0: 3d3d 2063 0a0a 2020 2020 2020 2020 6120  == c..        a 
+00031ae0: 3d20 7b77 3a20 7773 2e6e 6279 7465 7320  = {w: ws.nbytes 
+00031af0: 666f 7220 772c 2077 7320 696e 2073 656c  for w, ws in sel
+00031b00: 662e 776f 726b 6572 732e 6974 656d 7328  f.workers.items(
+00031b10: 297d 0a20 2020 2020 2020 2062 203d 207b  )}.        b = {
+00031b20: 0a20 2020 2020 2020 2020 2020 2077 3a20  .            w: 
+00031b30: 7375 6d28 7473 2e67 6574 5f6e 6279 7465  sum(ts.get_nbyte
+00031b40: 7328 2920 666f 7220 7473 2069 6e20 7773  s() for ts in ws
+00031b50: 2e68 6173 5f77 6861 7429 0a20 2020 2020  .has_what).     
+00031b60: 2020 2020 2020 2066 6f72 2077 2c20 7773         for w, ws
+00031b70: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+00031b80: 2e69 7465 6d73 2829 0a20 2020 2020 2020  .items().       
+00031b90: 207d 0a20 2020 2020 2020 2061 7373 6572   }.        asser
+00031ba0: 7420 6120 3d3d 2062 2c20 2861 2c20 6229  t a == b, (a, b)
+00031bb0: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
+00031bc0: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
+00031bd0: 6e74 6572 5f6d 6178 3a0a 2020 2020 2020  nter_max:.      
+00031be0: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+00031bf0: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
+00031c00: 6e74 6572 203c 2073 656c 662e 7472 616e  nter < self.tran
+00031c10: 7369 7469 6f6e 5f63 6f75 6e74 6572 5f6d  sition_counter_m
+00031c20: 6178 0a0a 2020 2020 2323 2323 2323 2323  ax..    ########
+00031c30: 2323 2323 2323 2323 2323 230a 2020 2020  ###########.    
+00031c40: 2320 4d61 6e61 6765 204d 6573 7361 6765  # Manage Message
+00031c50: 7320 230a 2020 2020 2323 2323 2323 2323  s #.    ########
+00031c60: 2323 2323 2323 2323 2323 230a 0a20 2020  ###########..   
+00031c70: 2064 6566 2072 6570 6f72 7428 0a20 2020   def report(.   
+00031c80: 2020 2020 2073 656c 662c 206d 7367 3a20       self, msg: 
+00031c90: 6469 6374 2c20 7473 3a20 5461 736b 5374  dict, ts: TaskSt
+00031ca0: 6174 6520 7c20 4e6f 6e65 203d 204e 6f6e  ate | None = Non
+00031cb0: 652c 2063 6c69 656e 743a 2073 7472 207c  e, client: str |
+00031cc0: 204e 6f6e 6520 3d20 4e6f 6e65 0a20 2020   None = None.   
+00031cd0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+00031ce0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00031cf0: 5075 626c 6973 6820 7570 6461 7465 7320  Publish updates 
+00031d00: 746f 2061 6c6c 206c 6973 7465 6e69 6e67  to all listening
+00031d10: 2051 7565 7565 7320 616e 6420 436f 6d6d   Queues and Comm
+00031d20: 730a 0a20 2020 2020 2020 2049 6620 7468  s..        If th
+00031d30: 6520 6d65 7373 6167 6520 636f 6e74 6169  e message contai
+00031d40: 6e73 2061 206b 6579 2074 6865 6e20 7765  ns a key then we
+00031d50: 206f 6e6c 7920 7365 6e64 2074 6865 206d   only send the m
+00031d60: 6573 7361 6765 2074 6f20 7468 6f73 650a  essage to those.
+00031d70: 2020 2020 2020 2020 636f 6d6d 7320 7468          comms th
+00031d80: 6174 2063 6172 6520 6162 6f75 7420 7468  at care about th
+00031d90: 6520 6b65 792e 0a20 2020 2020 2020 2022  e key..        "
+00031da0: 2222 0a20 2020 2020 2020 2069 6620 7473  "".        if ts
+00031db0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00031dc0: 2020 2020 2020 6d73 675f 6b65 7920 3d20        msg_key = 
+00031dd0: 6d73 672e 6765 7428 226b 6579 2229 0a20  msg.get("key"). 
+00031de0: 2020 2020 2020 2020 2020 2069 6620 6d73             if ms
+00031df0: 675f 6b65 7920 6973 206e 6f74 204e 6f6e  g_key is not Non
+00031e00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00031e10: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+00031e20: 6b73 2e67 6574 286d 7367 5f6b 6579 290a  ks.get(msg_key).
+00031e30: 0a20 2020 2020 2020 2069 6620 7473 2069  .        if ts i
+00031e40: 7320 4e6f 6e65 2061 6e64 2063 6c69 656e  s None and clien
+00031e50: 7420 6973 204e 6f6e 653a 0a20 2020 2020  t is None:.     
+00031e60: 2020 2020 2020 2023 204e 6f74 6966 7920         # Notify 
+00031e70: 616c 6c20 636c 6965 6e74 730a 2020 2020  all clients.    
+00031e80: 2020 2020 2020 2020 636c 6965 6e74 5f6b          client_k
+00031e90: 6579 7320 3d20 6c69 7374 2873 656c 662e  eys = list(self.
+00031ea0: 636c 6965 6e74 5f63 6f6d 6d73 290a 2020  client_comms).  
+00031eb0: 2020 2020 2020 656c 6966 2074 7320 6973        elif ts is
+00031ec0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00031ed0: 2020 2063 6c69 656e 745f 6b65 7973 203d     client_keys =
+00031ee0: 205b 636c 6965 6e74 5d0a 2020 2020 2020   [client].      
+00031ef0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00031f00: 2020 2020 2320 4e6f 7469 6679 2063 6c69      # Notify cli
+00031f10: 656e 7473 2069 6e74 6572 6573 7465 6420  ents interested 
+00031f20: 696e 206b 6579 2028 696e 636c 7564 696e  in key (includin
+00031f30: 6720 6063 6c69 656e 7460 290a 2020 2020  g `client`).    
+00031f40: 2020 2020 2020 2020 2320 4e6f 7465 2074          # Note t
+00031f50: 6861 742c 2069 6620 7265 706f 7274 2829  hat, if report()
+00031f60: 2077 6173 2063 616c 6c65 6420 6279 2075   was called by u
+00031f70: 7064 6174 655f 6772 6170 6828 292c 2060  pdate_graph(), `
+00031f80: 636c 6965 6e74 6020 776f 6e27 7420 6265  client` won't be
+00031f90: 2069 6e0a 2020 2020 2020 2020 2020 2020   in.            
+00031fa0: 2320 7473 2e77 686f 5f77 616e 7473 2079  # ts.who_wants y
+00031fb0: 6574 2e0a 2020 2020 2020 2020 2020 2020  et..            
+00031fc0: 636c 6965 6e74 5f6b 6579 7320 3d20 5b0a  client_keys = [.
+00031fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00031fe0: 6373 2e63 6c69 656e 745f 6b65 7920 666f  cs.client_key fo
+00031ff0: 7220 6373 2069 6e20 7473 2e77 686f 5f77  r cs in ts.who_w
+00032000: 616e 7473 206f 7220 2829 2069 6620 6373  ants or () if cs
+00032010: 2e63 6c69 656e 745f 6b65 7920 213d 2063  .client_key != c
+00032020: 6c69 656e 740a 2020 2020 2020 2020 2020  lient.          
+00032030: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
+00032040: 6966 2063 6c69 656e 7420 6973 206e 6f74  if client is not
+00032050: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+00032060: 2020 2020 2020 2063 6c69 656e 745f 6b65         client_ke
+00032070: 7973 2e61 7070 656e 6428 636c 6965 6e74  ys.append(client
+00032080: 290a 0a20 2020 2020 2020 2066 6f72 206b  )..        for k
+00032090: 2069 6e20 636c 6965 6e74 5f6b 6579 733a   in client_keys:
+000320a0: 0a20 2020 2020 2020 2020 2020 2063 203d  .            c =
+000320b0: 2073 656c 662e 636c 6965 6e74 5f63 6f6d   self.client_com
+000320c0: 6d73 2e67 6574 286b 290a 2020 2020 2020  ms.get(k).      
+000320d0: 2020 2020 2020 6966 2063 2069 7320 4e6f        if c is No
+000320e0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000320f0: 2020 2020 636f 6e74 696e 7565 0a20 2020      continue.   
+00032100: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+00032110: 2020 2020 2020 2020 2020 2020 2020 632e                c.
+00032120: 7365 6e64 286d 7367 290a 2020 2020 2020  send(msg).      
+00032130: 2020 2020 2020 2020 2020 2320 6c6f 6767            # logg
+00032140: 6572 2e64 6562 7567 2822 5363 6865 6475  er.debug("Schedu
+00032150: 6c65 7220 7365 6e64 7320 6d65 7373 6167  ler sends messag
+00032160: 6520 746f 2063 6c69 656e 7420 2573 3a20  e to client %s: 
+00032170: 2573 222c 206b 2c20 6d73 6729 0a20 2020  %s", k, msg).   
+00032180: 2020 2020 2020 2020 2065 7863 6570 7420           except 
+00032190: 436f 6d6d 436c 6f73 6564 4572 726f 723a  CommClosedError:
+000321a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000321b0: 2069 6620 7365 6c66 2e73 7461 7475 7320   if self.status 
+000321c0: 3d3d 2053 7461 7475 732e 7275 6e6e 696e  == Status.runnin
+000321d0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
+000321e0: 2020 2020 2020 206c 6f67 6765 722e 6372         logger.cr
+000321f0: 6974 6963 616c 280a 2020 2020 2020 2020  itical(.        
+00032200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032210: 2243 6c6f 7365 6420 636f 6d6d 2025 7220  "Closed comm %r 
+00032220: 7768 696c 6520 7472 7969 6e67 2074 6f20  while trying to 
+00032230: 7772 6974 6520 2573 222c 2063 2c20 6d73  write %s", c, ms
+00032240: 672c 2065 7863 5f69 6e66 6f3d 5472 7565  g, exc_info=True
+00032250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00032260: 2020 2020 2029 0a0a 2020 2020 6173 796e       )..    asyn
+00032270: 6320 6465 6620 6164 645f 636c 6965 6e74  c def add_client
+00032280: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
+00032290: 636f 6d6d 3a20 436f 6d6d 2c20 636c 6965  comm: Comm, clie
+000322a0: 6e74 3a20 7374 722c 2076 6572 7369 6f6e  nt: str, version
+000322b0: 733a 2064 6963 745b 7374 722c 2041 6e79  s: dict[str, Any
+000322c0: 5d0a 2020 2020 2920 2d3e 204e 6f6e 653a  ].    ) -> None:
+000322d0: 0a20 2020 2020 2020 2022 2222 4164 6420  .        """Add 
+000322e0: 636c 6965 6e74 2074 6f20 6e65 7477 6f72  client to networ
+000322f0: 6b0a 0a20 2020 2020 2020 2057 6520 6c69  k..        We li
+00032300: 7374 656e 2074 6f20 616c 6c20 6675 7475  sten to all futu
+00032310: 7265 206d 6573 7361 6765 7320 6672 6f6d  re messages from
+00032320: 2074 6869 7320 436f 6d6d 2e0a 2020 2020   this Comm..    
+00032330: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00032340: 6173 7365 7274 2063 6c69 656e 7420 6973  assert client is
+00032350: 206e 6f74 204e 6f6e 650a 2020 2020 2020   not None.      
+00032360: 2020 636f 6d6d 2e6e 616d 6520 3d20 2253    comm.name = "S
+00032370: 6368 6564 756c 6572 2d3e 436c 6965 6e74  cheduler->Client
+00032380: 220a 2020 2020 2020 2020 6c6f 6767 6572  ".        logger
+00032390: 2e69 6e66 6f28 2252 6563 6569 7665 2063  .info("Receive c
+000323a0: 6c69 656e 7420 636f 6e6e 6563 7469 6f6e  lient connection
+000323b0: 3a20 2573 222c 2063 6c69 656e 7429 0a20  : %s", client). 
+000323c0: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
+000323d0: 6576 656e 7428 5b22 616c 6c22 2c20 636c  event(["all", cl
+000323e0: 6965 6e74 5d2c 207b 2261 6374 696f 6e22  ient], {"action"
+000323f0: 3a20 2261 6464 2d63 6c69 656e 7422 2c20  : "add-client", 
+00032400: 2263 6c69 656e 7422 3a20 636c 6965 6e74  "client": client
+00032410: 7d29 0a20 2020 2020 2020 2073 656c 662e  }).        self.
+00032420: 636c 6965 6e74 735b 636c 6965 6e74 5d20  clients[client] 
+00032430: 3d20 436c 6965 6e74 5374 6174 6528 636c  = ClientState(cl
+00032440: 6965 6e74 2c20 7665 7273 696f 6e73 3d76  ient, versions=v
+00032450: 6572 7369 6f6e 7329 0a0a 2020 2020 2020  ersions)..      
+00032460: 2020 666f 7220 706c 7567 696e 2069 6e20    for plugin in 
+00032470: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
+00032480: 732e 7661 6c75 6573 2829 293a 0a20 2020  s.values()):.   
+00032490: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+000324a0: 2020 2020 2020 2020 2020 2020 2020 706c                pl
+000324b0: 7567 696e 2e61 6464 5f63 6c69 656e 7428  ugin.add_client(
+000324c0: 7363 6865 6475 6c65 723d 7365 6c66 2c20  scheduler=self, 
+000324d0: 636c 6965 6e74 3d63 6c69 656e 7429 0a20  client=client). 
+000324e0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+000324f0: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00032500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00032510: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+00032520: 6f6e 2865 290a 0a20 2020 2020 2020 2074  on(e)..        t
+00032530: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00032540: 6263 6f6d 6d20 3d20 4261 7463 6865 6453  bcomm = BatchedS
+00032550: 656e 6428 696e 7465 7276 616c 3d22 326d  end(interval="2m
+00032560: 7322 2c20 6c6f 6f70 3d73 656c 662e 6c6f  s", loop=self.lo
+00032570: 6f70 290a 2020 2020 2020 2020 2020 2020  op).            
+00032580: 6263 6f6d 6d2e 7374 6172 7428 636f 6d6d  bcomm.start(comm
+00032590: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+000325a0: 6c66 2e63 6c69 656e 745f 636f 6d6d 735b  lf.client_comms[
+000325b0: 636c 6965 6e74 5d20 3d20 6263 6f6d 6d0a  client] = bcomm.
+000325c0: 2020 2020 2020 2020 2020 2020 6d73 6720              msg 
+000325d0: 3d20 7b22 6f70 223a 2022 7374 7265 616d  = {"op": "stream
+000325e0: 2d73 7461 7274 227d 0a20 2020 2020 2020  -start"}.       
+000325f0: 2020 2020 2076 6572 7369 6f6e 5f77 6172       version_war
+00032600: 6e69 6e67 203d 2076 6572 7369 6f6e 5f6d  ning = version_m
+00032610: 6f64 756c 652e 6572 726f 725f 6d65 7373  odule.error_mess
+00032620: 6167 6528 0a20 2020 2020 2020 2020 2020  age(.           
+00032630: 2020 2020 2076 6572 7369 6f6e 5f6d 6f64       version_mod
+00032640: 756c 652e 6765 745f 7665 7273 696f 6e73  ule.get_versions
+00032650: 2829 2c0a 2020 2020 2020 2020 2020 2020  (),.            
+00032660: 2020 2020 7b77 3a20 7773 2e76 6572 7369      {w: ws.versi
+00032670: 6f6e 7320 666f 7220 772c 2077 7320 696e  ons for w, ws in
+00032680: 2073 656c 662e 776f 726b 6572 732e 6974   self.workers.it
+00032690: 656d 7328 297d 2c0a 2020 2020 2020 2020  ems()},.        
+000326a0: 2020 2020 2020 2020 7665 7273 696f 6e73          versions
+000326b0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+000326c0: 2020 2020 2020 2020 2020 2020 6d73 672e              msg.
+000326d0: 7570 6461 7465 2876 6572 7369 6f6e 5f77  update(version_w
+000326e0: 6172 6e69 6e67 290a 2020 2020 2020 2020  arning).        
+000326f0: 2020 2020 6263 6f6d 6d2e 7365 6e64 286d      bcomm.send(m
+00032700: 7367 290a 0a20 2020 2020 2020 2020 2020  sg)..           
+00032710: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00032720: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+00032730: 2e68 616e 646c 655f 7374 7265 616d 2863  .handle_stream(c
+00032740: 6f6d 6d3d 636f 6d6d 2c20 6578 7472 613d  omm=comm, extra=
+00032750: 7b22 636c 6965 6e74 223a 2063 6c69 656e  {"client": clien
+00032760: 747d 290a 2020 2020 2020 2020 2020 2020  t}).            
+00032770: 6669 6e61 6c6c 793a 0a20 2020 2020 2020  finally:.       
+00032780: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+00032790: 6d6f 7665 5f63 6c69 656e 7428 636c 6965  move_client(clie
+000327a0: 6e74 3d63 6c69 656e 742c 2073 7469 6d75  nt=client, stimu
+000327b0: 6c75 735f 6964 3d66 2272 656d 6f76 652d  lus_id=f"remove-
+000327c0: 636c 6965 6e74 2d7b 7469 6d65 2829 7d22  client-{time()}"
+000327d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000327e0: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+000327f0: 4669 6e69 7368 6564 2068 616e 646c 696e  Finished handlin
+00032800: 6720 636c 6965 6e74 2025 7322 2c20 636c  g client %s", cl
+00032810: 6965 6e74 290a 2020 2020 2020 2020 6669  ient).        fi
+00032820: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
+00032830: 2020 2069 6620 6e6f 7420 636f 6d6d 2e63     if not comm.c
+00032840: 6c6f 7365 6428 293a 0a20 2020 2020 2020  losed():.       
+00032850: 2020 2020 2020 2020 2073 656c 662e 636c           self.cl
+00032860: 6965 6e74 5f63 6f6d 6d73 5b63 6c69 656e  ient_comms[clien
+00032870: 745d 2e73 656e 6428 7b22 6f70 223a 2022  t].send({"op": "
+00032880: 7374 7265 616d 2d63 6c6f 7365 6422 7d29  stream-closed"})
+00032890: 0a20 2020 2020 2020 2020 2020 2074 7279  .            try
+000328a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000328b0: 2020 6966 206e 6f74 2069 735f 7079 7468    if not is_pyth
+000328c0: 6f6e 5f73 6875 7474 696e 675f 646f 776e  on_shutting_down
+000328d0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000328e0: 2020 2020 2020 2020 6177 6169 7420 7365          await se
+000328f0: 6c66 2e63 6c69 656e 745f 636f 6d6d 735b  lf.client_comms[
+00032900: 636c 6965 6e74 5d2e 636c 6f73 6528 290a  client].close().
+00032910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032920: 2020 2020 6465 6c20 7365 6c66 2e63 6c69      del self.cli
+00032930: 656e 745f 636f 6d6d 735b 636c 6965 6e74  ent_comms[client
+00032940: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00032950: 2020 2020 2020 6966 2073 656c 662e 7374        if self.st
+00032960: 6174 7573 203d 3d20 5374 6174 7573 2e72  atus == Status.r
+00032970: 756e 6e69 6e67 3a0a 2020 2020 2020 2020  unning:.        
+00032980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032990: 6c6f 6767 6572 2e69 6e66 6f28 2243 6c6f  logger.info("Clo
+000329a0: 7365 2063 6c69 656e 7420 636f 6e6e 6563  se client connec
+000329b0: 7469 6f6e 3a20 2573 222c 2063 6c69 656e  tion: %s", clien
+000329c0: 7429 0a20 2020 2020 2020 2020 2020 2065  t).            e
+000329d0: 7863 6570 7420 5479 7065 4572 726f 723a  xcept TypeError:
+000329e0: 2020 2320 636f 6d6d 2062 6563 6f6d 6573    # comm becomes
+000329f0: 204e 6f6e 6520 6475 7269 6e67 2047 430a   None during GC.
+00032a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032a10: 7061 7373 0a0a 2020 2020 6465 6620 7265  pass..    def re
+00032a20: 6d6f 7665 5f63 6c69 656e 7428 7365 6c66  move_client(self
+00032a30: 2c20 636c 6965 6e74 3a20 7374 722c 2073  , client: str, s
+00032a40: 7469 6d75 6c75 735f 6964 3a20 7374 7220  timulus_id: str 
+00032a50: 7c20 4e6f 6e65 203d 204e 6f6e 6529 202d  | None = None) -
+00032a60: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00032a70: 2222 2252 656d 6f76 6520 636c 6965 6e74  """Remove client
+00032a80: 2066 726f 6d20 6e65 7477 6f72 6b22 2222   from network"""
+00032a90: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
+00032aa0: 735f 6964 203d 2073 7469 6d75 6c75 735f  s_id = stimulus_
+00032ab0: 6964 206f 7220 6622 7265 6d6f 7665 2d63  id or f"remove-c
+00032ac0: 6c69 656e 742d 7b74 696d 6528 297d 220a  lient-{time()}".
+00032ad0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00032ae0: 7374 6174 7573 203d 3d20 5374 6174 7573  status == Status
+00032af0: 2e72 756e 6e69 6e67 3a0a 2020 2020 2020  .running:.      
+00032b00: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
+00032b10: 6f28 2252 656d 6f76 6520 636c 6965 6e74  o("Remove client
+00032b20: 2025 7322 2c20 636c 6965 6e74 290a 2020   %s", client).  
+00032b30: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+00032b40: 7665 6e74 285b 2261 6c6c 222c 2063 6c69  vent(["all", cli
+00032b50: 656e 745d 2c20 7b22 6163 7469 6f6e 223a  ent], {"action":
+00032b60: 2022 7265 6d6f 7665 2d63 6c69 656e 7422   "remove-client"
+00032b70: 2c20 2263 6c69 656e 7422 3a20 636c 6965  , "client": clie
+00032b80: 6e74 7d29 0a20 2020 2020 2020 2074 7279  nt}).        try
+00032b90: 3a0a 2020 2020 2020 2020 2020 2020 6373  :.            cs
+00032ba0: 3a20 436c 6965 6e74 5374 6174 6520 3d20  : ClientState = 
+00032bb0: 7365 6c66 2e63 6c69 656e 7473 5b63 6c69  self.clients[cli
+00032bc0: 656e 745d 0a20 2020 2020 2020 2065 7863  ent].        exc
+00032bd0: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
+00032be0: 2020 2020 2020 2020 2020 2320 5858 5820            # XXX 
+00032bf0: 6973 2074 6869 7320 6120 6c65 6769 7469  is this a legiti
+00032c00: 6d61 7465 2063 6f6e 6469 7469 6f6e 3f0a  mate condition?.
+00032c10: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+00032c20: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00032c30: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00032c40: 636c 6965 6e74 5f72 656c 6561 7365 735f  client_releases_
+00032c50: 6b65 7973 280a 2020 2020 2020 2020 2020  keys(.          
+00032c60: 2020 2020 2020 6b65 7973 3d5b 7473 2e6b        keys=[ts.k
+00032c70: 6579 2066 6f72 2074 7320 696e 2063 732e  ey for ts in cs.
+00032c80: 7761 6e74 735f 7768 6174 5d2c 0a20 2020  wants_what],.   
+00032c90: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+00032ca0: 656e 743d 6373 2e63 6c69 656e 745f 6b65  ent=cs.client_ke
+00032cb0: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+00032cc0: 2020 2073 7469 6d75 6c75 735f 6964 3d73     stimulus_id=s
+00032cd0: 7469 6d75 6c75 735f 6964 2c0a 2020 2020  timulus_id,.    
+00032ce0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00032cf0: 2020 2020 2020 6465 6c20 7365 6c66 2e63        del self.c
+00032d00: 6c69 656e 7473 5b63 6c69 656e 745d 0a0a  lients[client]..
+00032d10: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00032d20: 706c 7567 696e 2069 6e20 6c69 7374 2873  plugin in list(s
+00032d30: 656c 662e 706c 7567 696e 732e 7661 6c75  elf.plugins.valu
+00032d40: 6573 2829 293a 0a20 2020 2020 2020 2020  es()):.         
+00032d50: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+00032d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00032d70: 706c 7567 696e 2e72 656d 6f76 655f 636c  plugin.remove_cl
+00032d80: 6965 6e74 2873 6368 6564 756c 6572 3d73  ient(scheduler=s
+00032d90: 656c 662c 2063 6c69 656e 743d 636c 6965  elf, client=clie
+00032da0: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
+00032db0: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00032dc0: 7469 6f6e 2061 7320 653a 0a20 2020 2020  tion as e:.     
+00032dd0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00032de0: 6f67 6765 722e 6578 6365 7074 696f 6e28  ogger.exception(
+00032df0: 6529 0a0a 2020 2020 2020 2020 6173 796e  e)..        asyn
+00032e00: 6320 6465 6620 7265 6d6f 7665 5f63 6c69  c def remove_cli
+00032e10: 656e 745f 6672 6f6d 5f65 7665 6e74 7328  ent_from_events(
+00032e20: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00032e30: 2020 2020 2020 2023 2049 6620 7468 6520         # If the 
+00032e40: 636c 6965 6e74 2069 736e 2774 2072 6567  client isn't reg
+00032e50: 6973 7465 7265 6420 616e 796d 6f72 6520  istered anymore 
+00032e60: 6166 7465 7220 7468 6520 6465 6c61 792c  after the delay,
+00032e70: 2072 656d 6f76 6520 6672 6f6d 2065 7665   remove from eve
+00032e80: 6e74 730a 2020 2020 2020 2020 2020 2020  nts.            
+00032e90: 6966 2063 6c69 656e 7420 6e6f 7420 696e  if client not in
+00032ea0: 2073 656c 662e 636c 6965 6e74 7320 616e   self.clients an
+00032eb0: 6420 636c 6965 6e74 2069 6e20 7365 6c66  d client in self
+00032ec0: 2e65 7665 6e74 733a 0a20 2020 2020 2020  .events:.       
+00032ed0: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
+00032ee0: 662e 6576 656e 7473 5b63 6c69 656e 745d  f.events[client]
+00032ef0: 0a0a 2020 2020 2020 2020 636c 6561 6e75  ..        cleanu
+00032f00: 705f 6465 6c61 7920 3d20 7061 7273 655f  p_delay = parse_
+00032f10: 7469 6d65 6465 6c74 6128 0a20 2020 2020  timedelta(.     
+00032f20: 2020 2020 2020 2064 6173 6b2e 636f 6e66         dask.conf
+00032f30: 6967 2e67 6574 2822 6469 7374 7269 6275  ig.get("distribu
+00032f40: 7465 642e 7363 6865 6475 6c65 722e 6576  ted.scheduler.ev
+00032f50: 656e 7473 2d63 6c65 616e 7570 2d64 656c  ents-cleanup-del
+00032f60: 6179 2229 0a20 2020 2020 2020 2029 0a20  ay").        ). 
+00032f70: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00032f80: 6c66 2e5f 6f6e 676f 696e 675f 6261 636b  lf._ongoing_back
+00032f90: 6772 6f75 6e64 5f74 6173 6b73 2e63 6c6f  ground_tasks.clo
+00032fa0: 7365 643a 0a20 2020 2020 2020 2020 2020  sed:.           
+00032fb0: 2073 656c 662e 5f6f 6e67 6f69 6e67 5f62   self._ongoing_b
+00032fc0: 6163 6b67 726f 756e 645f 7461 736b 732e  ackground_tasks.
+00032fd0: 6361 6c6c 5f6c 6174 6572 280a 2020 2020  call_later(.    
+00032fe0: 2020 2020 2020 2020 2020 2020 636c 6561              clea
+00032ff0: 6e75 705f 6465 6c61 792c 2072 656d 6f76  nup_delay, remov
+00033000: 655f 636c 6965 6e74 5f66 726f 6d5f 6576  e_client_from_ev
+00033010: 656e 7473 0a20 2020 2020 2020 2020 2020  ents.           
+00033020: 2029 0a0a 2020 2020 6465 6620 7365 6e64   )..    def send
+00033030: 5f74 6173 6b5f 746f 5f77 6f72 6b65 7228  _task_to_worker(
+00033040: 0a20 2020 2020 2020 2073 656c 662c 2077  .        self, w
+00033050: 6f72 6b65 723a 2073 7472 2c20 7473 3a20  orker: str, ts: 
+00033060: 5461 736b 5374 6174 652c 2064 7572 6174  TaskState, durat
+00033070: 696f 6e3a 2066 6c6f 6174 203d 202d 310a  ion: float = -1.
+00033080: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
+00033090: 2020 2020 2020 2022 2222 5365 6e64 2061         """Send a
+000330a0: 2073 696e 676c 6520 636f 6d70 7574 6174   single computat
+000330b0: 696f 6e61 6c20 7461 736b 2074 6f20 6120  ional task to a 
+000330c0: 776f 726b 6572 2222 220a 2020 2020 2020  worker""".      
+000330d0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000330e0: 2020 206d 7367 203d 2073 656c 662e 5f74     msg = self._t
+000330f0: 6173 6b5f 746f 5f6d 7367 2874 732c 2064  ask_to_msg(ts, d
+00033100: 7572 6174 696f 6e29 0a20 2020 2020 2020  uration).       
+00033110: 2020 2020 2073 656c 662e 776f 726b 6572       self.worker
+00033120: 5f73 656e 6428 776f 726b 6572 2c20 6d73  _send(worker, ms
+00033130: 6729 0a20 2020 2020 2020 2065 7863 6570  g).        excep
+00033140: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00033150: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+00033160: 6767 6572 2e65 7863 6570 7469 6f6e 2865  gger.exception(e
+00033170: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00033180: 204c 4f47 5f50 4442 3a0a 2020 2020 2020   LOG_PDB:.      
+00033190: 2020 2020 2020 2020 2020 696d 706f 7274            import
+000331a0: 2070 6462 0a0a 2020 2020 2020 2020 2020   pdb..          
+000331b0: 2020 2020 2020 7064 622e 7365 745f 7472        pdb.set_tr
+000331c0: 6163 6528 290a 2020 2020 2020 2020 2020  ace().          
+000331d0: 2020 7261 6973 650a 0a20 2020 2064 6566    raise..    def
+000331e0: 2068 616e 646c 655f 756e 6361 7567 6874   handle_uncaught
+000331f0: 5f65 7272 6f72 2873 656c 662c 202a 2a6d  _error(self, **m
+00033200: 7367 3a20 416e 7929 202d 3e20 4e6f 6e65  sg: Any) -> None
+00033210: 3a0a 2020 2020 2020 2020 6c6f 6767 6572  :.        logger
+00033220: 2e65 7863 6570 7469 6f6e 2863 6c65 616e  .exception(clean
+00033230: 5f65 7863 6570 7469 6f6e 282a 2a6d 7367  _exception(**msg
+00033240: 295b 315d 290a 0a20 2020 2064 6566 2068  )[1])..    def h
+00033250: 616e 646c 655f 7461 736b 5f66 696e 6973  andle_task_finis
+00033260: 6865 6428 0a20 2020 2020 2020 2073 656c  hed(.        sel
+00033270: 662c 206b 6579 3a20 4b65 792c 2077 6f72  f, key: Key, wor
+00033280: 6b65 723a 2073 7472 2c20 7374 696d 756c  ker: str, stimul
+00033290: 7573 5f69 643a 2073 7472 2c20 2a2a 6d73  us_id: str, **ms
+000332a0: 673a 2041 6e79 0a20 2020 2029 202d 3e20  g: Any.    ) -> 
+000332b0: 4e6f 6e65 3a0a 2020 2020 2020 2020 6966  None:.        if
+000332c0: 2077 6f72 6b65 7220 6e6f 7420 696e 2073   worker not in s
+000332d0: 656c 662e 776f 726b 6572 733a 0a20 2020  elf.workers:.   
+000332e0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+000332f0: 2020 2020 2020 2020 7365 6c66 2e76 616c          self.val
+00033300: 6964 6174 655f 6b65 7928 6b65 7929 0a0a  idate_key(key)..
+00033310: 2020 2020 2020 2020 723a 2074 7570 6c65          r: tuple
+00033320: 203d 2073 656c 662e 7374 696d 756c 7573   = self.stimulus
+00033330: 5f74 6173 6b5f 6669 6e69 7368 6564 280a  _task_finished(.
+00033340: 2020 2020 2020 2020 2020 2020 6b65 793d              key=
+00033350: 6b65 792c 2077 6f72 6b65 723d 776f 726b  key, worker=work
+00033360: 6572 2c20 7374 696d 756c 7573 5f69 643d  er, stimulus_id=
+00033370: 7374 696d 756c 7573 5f69 642c 202a 2a6d  stimulus_id, **m
+00033380: 7367 0a20 2020 2020 2020 2029 0a20 2020  sg.        ).   
+00033390: 2020 2020 2072 6563 6f6d 6d65 6e64 6174       recommendat
+000333a0: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+000333b0: 732c 2077 6f72 6b65 725f 6d73 6773 203d  s, worker_msgs =
+000333c0: 2072 0a20 2020 2020 2020 2073 656c 662e   r.        self.
+000333d0: 5f74 7261 6e73 6974 696f 6e73 2872 6563  _transitions(rec
+000333e0: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
+000333f0: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
+00033400: 725f 6d73 6773 2c20 7374 696d 756c 7573  r_msgs, stimulus
+00033410: 5f69 6429 0a20 2020 2020 2020 2073 656c  _id).        sel
+00033420: 662e 7365 6e64 5f61 6c6c 2863 6c69 656e  f.send_all(clien
+00033430: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
+00033440: 7367 7329 0a0a 2020 2020 2020 2020 7365  sgs)..        se
+00033450: 6c66 2e73 7469 6d75 6c75 735f 7175 6575  lf.stimulus_queu
+00033460: 655f 736c 6f74 735f 6d61 7962 655f 6f70  e_slots_maybe_op
+00033470: 656e 6564 2873 7469 6d75 6c75 735f 6964  ened(stimulus_id
+00033480: 3d73 7469 6d75 6c75 735f 6964 290a 0a20  =stimulus_id).. 
+00033490: 2020 2064 6566 2068 616e 646c 655f 7461     def handle_ta
+000334a0: 736b 5f65 7272 6564 2873 656c 662c 206b  sk_erred(self, k
+000334b0: 6579 3a20 4b65 792c 2073 7469 6d75 6c75  ey: Key, stimulu
+000334c0: 735f 6964 3a20 7374 722c 202a 2a6d 7367  s_id: str, **msg
+000334d0: 3a20 416e 7929 202d 3e20 4e6f 6e65 3a0a  : Any) -> None:.
+000334e0: 2020 2020 2020 2020 723a 2074 7570 6c65          r: tuple
+000334f0: 203d 2073 656c 662e 7374 696d 756c 7573   = self.stimulus
+00033500: 5f74 6173 6b5f 6572 7265 6428 6b65 793d  _task_erred(key=
+00033510: 6b65 792c 2073 7469 6d75 6c75 735f 6964  key, stimulus_id
+00033520: 3d73 7469 6d75 6c75 735f 6964 2c20 2a2a  =stimulus_id, **
+00033530: 6d73 6729 0a20 2020 2020 2020 2072 6563  msg).        rec
+00033540: 6f6d 6d65 6e64 6174 696f 6e73 2c20 636c  ommendations, cl
+00033550: 6965 6e74 5f6d 7367 732c 2077 6f72 6b65  ient_msgs, worke
+00033560: 725f 6d73 6773 203d 2072 0a20 2020 2020  r_msgs = r.     
+00033570: 2020 2073 656c 662e 5f74 7261 6e73 6974     self._transit
+00033580: 696f 6e73 2872 6563 6f6d 6d65 6e64 6174  ions(recommendat
+00033590: 696f 6e73 2c20 636c 6965 6e74 5f6d 7367  ions, client_msg
+000335a0: 732c 2077 6f72 6b65 725f 6d73 6773 2c20  s, worker_msgs, 
+000335b0: 7374 696d 756c 7573 5f69 6429 0a20 2020  stimulus_id).   
+000335c0: 2020 2020 2073 656c 662e 7365 6e64 5f61       self.send_a
+000335d0: 6c6c 2863 6c69 656e 745f 6d73 6773 2c20  ll(client_msgs, 
+000335e0: 776f 726b 6572 5f6d 7367 7329 0a0a 2020  worker_msgs)..  
+000335f0: 2020 2020 2020 7365 6c66 2e73 7469 6d75        self.stimu
+00033600: 6c75 735f 7175 6575 655f 736c 6f74 735f  lus_queue_slots_
+00033610: 6d61 7962 655f 6f70 656e 6564 2873 7469  maybe_opened(sti
+00033620: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
+00033630: 735f 6964 290a 0a20 2020 2064 6566 2072  s_id)..    def r
+00033640: 656c 6561 7365 5f77 6f72 6b65 725f 6461  elease_worker_da
+00033650: 7461 2873 656c 662c 206b 6579 3a20 4b65  ta(self, key: Ke
+00033660: 792c 2077 6f72 6b65 723a 2073 7472 2c20  y, worker: str, 
+00033670: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+00033680: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00033690: 2020 2074 7320 3d20 7365 6c66 2e74 6173     ts = self.tas
+000336a0: 6b73 2e67 6574 286b 6579 290a 2020 2020  ks.get(key).    
+000336b0: 2020 2020 7773 203d 2073 656c 662e 776f      ws = self.wo
+000336c0: 726b 6572 732e 6765 7428 776f 726b 6572  rkers.get(worker
+000336d0: 290a 2020 2020 2020 2020 6966 206e 6f74  ).        if not
+000336e0: 2074 7320 6f72 206e 6f74 2077 7320 6f72   ts or not ws or
+000336f0: 2077 7320 6e6f 7420 696e 2028 7473 2e77   ws not in (ts.w
+00033700: 686f 5f68 6173 206f 7220 2829 293a 0a20  ho_has or ()):. 
+00033710: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00033720: 6e0a 0a20 2020 2020 2020 2073 656c 662e  n..        self.
+00033730: 7265 6d6f 7665 5f72 6570 6c69 6361 2874  remove_replica(t
+00033740: 732c 2077 7329 0a20 2020 2020 2020 2069  s, ws).        i
+00033750: 6620 6e6f 7420 7473 2e77 686f 5f68 6173  f not ts.who_has
+00033760: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+00033770: 6c66 2e74 7261 6e73 6974 696f 6e73 287b  lf.transitions({
+00033780: 6b65 793a 2022 7265 6c65 6173 6564 227d  key: "released"}
+00033790: 2c20 7374 696d 756c 7573 5f69 6429 0a0a  , stimulus_id)..
+000337a0: 2020 2020 6465 6620 6861 6e64 6c65 5f6c      def handle_l
+000337b0: 6f6e 675f 7275 6e6e 696e 6728 0a20 2020  ong_running(.   
+000337c0: 2020 2020 2073 656c 662c 206b 6579 3a20       self, key: 
+000337d0: 4b65 792c 2077 6f72 6b65 723a 2073 7472  Key, worker: str
+000337e0: 2c20 636f 6d70 7574 655f 6475 7261 7469  , compute_durati
+000337f0: 6f6e 3a20 666c 6f61 7420 7c20 4e6f 6e65  on: float | None
+00033800: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
+00033810: 7472 0a20 2020 2029 202d 3e20 4e6f 6e65  tr.    ) -> None
+00033820: 3a0a 2020 2020 2020 2020 2222 2241 2074  :.        """A t
+00033830: 6173 6b20 6861 7320 7365 6365 6465 6420  ask has seceded 
+00033840: 6672 6f6d 2074 6865 2074 6872 6561 6420  from the thread 
+00033850: 706f 6f6c 0a0a 2020 2020 2020 2020 5765  pool..        We
+00033860: 2073 746f 7020 7468 6520 7461 736b 2066   stop the task f
+00033870: 726f 6d20 6265 696e 6720 7374 6f6c 656e  rom being stolen
+00033880: 2069 6e20 7468 6520 6675 7475 7265 2c20   in the future, 
+00033890: 616e 6420 6368 616e 6765 2074 6173 6b0a  and change task.
+000338a0: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
+000338b0: 2061 6363 6f75 6e74 696e 6720 6173 2069   accounting as i
+000338c0: 6620 7468 6520 7461 736b 2068 6173 2073  f the task has s
+000338d0: 746f 7070 6564 2e0a 2020 2020 2020 2020  topped..        
+000338e0: 2222 220a 2020 2020 2020 2020 6966 206b  """.        if k
+000338f0: 6579 206e 6f74 2069 6e20 7365 6c66 2e74  ey not in self.t
+00033900: 6173 6b73 3a0a 2020 2020 2020 2020 2020  asks:.          
+00033910: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
+00033920: 536b 6970 7069 6e67 206c 6f6e 675f 7275  Skipping long_ru
+00033930: 6e6e 696e 6720 7369 6e63 6520 6b65 7920  nning since key 
+00033940: 2573 2077 6173 2061 6c72 6561 6479 2072  %s was already r
+00033950: 656c 6561 7365 6422 2c20 6b65 7929 0a20  eleased", key). 
+00033960: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00033970: 6e0a 2020 2020 2020 2020 7473 203d 2073  n.        ts = s
+00033980: 656c 662e 7461 736b 735b 6b65 795d 0a20  elf.tasks[key]. 
+00033990: 2020 2020 2020 2073 7465 616c 203d 2073         steal = s
+000339a0: 656c 662e 6578 7465 6e73 696f 6e73 2e67  elf.extensions.g
+000339b0: 6574 2822 7374 6561 6c69 6e67 2229 0a20  et("stealing"). 
+000339c0: 2020 2020 2020 2069 6620 7374 6561 6c20         if steal 
+000339d0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+000339e0: 2020 2020 2020 2020 2073 7465 616c 2e72           steal.r
+000339f0: 656d 6f76 655f 6b65 795f 6672 6f6d 5f73  emove_key_from_s
+00033a00: 7465 616c 6162 6c65 2874 7329 0a0a 2020  tealable(ts)..  
+00033a10: 2020 2020 2020 7773 203d 2074 732e 7072        ws = ts.pr
+00033a20: 6f63 6573 7369 6e67 5f6f 6e0a 2020 2020  ocessing_on.    
+00033a30: 2020 2020 6966 2077 7320 6973 204e 6f6e      if ws is Non
+00033a40: 653a 0a20 2020 2020 2020 2020 2020 206c  e:.            l
+00033a50: 6f67 6765 722e 6465 6275 6728 2252 6563  ogger.debug("Rec
+00033a60: 6569 7665 6420 6c6f 6e67 2d72 756e 6e69  eived long-runni
+00033a70: 6e67 2073 6967 6e61 6c20 6672 6f6d 2064  ng signal from d
+00033a80: 7570 6c69 6361 7465 2074 6173 6b2e 2049  uplicate task. I
+00033a90: 676e 6f72 696e 672e 2229 0a20 2020 2020  gnoring.").     
+00033aa0: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00033ab0: 2020 2020 2020 2069 6620 636f 6d70 7574         if comput
+00033ac0: 655f 6475 7261 7469 6f6e 2069 7320 6e6f  e_duration is no
+00033ad0: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
+00033ae0: 2020 2020 6f6c 645f 6475 7261 7469 6f6e      old_duration
+00033af0: 203d 2074 732e 7072 6566 6978 2e64 7572   = ts.prefix.dur
+00033b00: 6174 696f 6e5f 6176 6572 6167 650a 2020  ation_average.  
+00033b10: 2020 2020 2020 2020 2020 6966 206f 6c64            if old
+00033b20: 5f64 7572 6174 696f 6e20 3c20 303a 0a20  _duration < 0:. 
+00033b30: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00033b40: 732e 7072 6566 6978 2e64 7572 6174 696f  s.prefix.duratio
+00033b50: 6e5f 6176 6572 6167 6520 3d20 636f 6d70  n_average = comp
+00033b60: 7574 655f 6475 7261 7469 6f6e 0a20 2020  ute_duration.   
+00033b70: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00033b80: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00033b90: 732e 7072 6566 6978 2e64 7572 6174 696f  s.prefix.duratio
+00033ba0: 6e5f 6176 6572 6167 6520 3d20 286f 6c64  n_average = (old
+00033bb0: 5f64 7572 6174 696f 6e20 2b20 636f 6d70  _duration + comp
+00033bc0: 7574 655f 6475 7261 7469 6f6e 2920 2f20  ute_duration) / 
+00033bd0: 320a 0a20 2020 2020 2020 2077 732e 6164  2..        ws.ad
+00033be0: 645f 746f 5f6c 6f6e 675f 7275 6e6e 696e  d_to_long_runnin
+00033bf0: 6728 7473 290a 2020 2020 2020 2020 7365  g(ts).        se
+00033c00: 6c66 2e63 6865 636b 5f69 646c 655f 7361  lf.check_idle_sa
+00033c10: 7475 7261 7465 6428 7773 290a 0a20 2020  turated(ws)..   
+00033c20: 2020 2020 2073 656c 662e 7374 696d 756c       self.stimul
+00033c30: 7573 5f71 7565 7565 5f73 6c6f 7473 5f6d  us_queue_slots_m
+00033c40: 6179 6265 5f6f 7065 6e65 6428 7374 696d  aybe_opened(stim
+00033c50: 756c 7573 5f69 643d 7374 696d 756c 7573  ulus_id=stimulus
+00033c60: 5f69 6429 0a0a 2020 2020 6465 6620 6861  _id)..    def ha
+00033c70: 6e64 6c65 5f77 6f72 6b65 725f 7374 6174  ndle_worker_stat
+00033c80: 7573 5f63 6861 6e67 6528 0a20 2020 2020  us_change(.     
+00033c90: 2020 2073 656c 662c 2073 7461 7475 733a     self, status:
+00033ca0: 2073 7472 207c 2053 7461 7475 732c 2077   str | Status, w
+00033cb0: 6f72 6b65 723a 2073 7472 207c 2057 6f72  orker: str | Wor
+00033cc0: 6b65 7253 7461 7465 2c20 7374 696d 756c  kerState, stimul
+00033cd0: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
+00033ce0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00033cf0: 2020 7773 203d 2073 656c 662e 776f 726b    ws = self.work
+00033d00: 6572 732e 6765 7428 776f 726b 6572 2920  ers.get(worker) 
+00033d10: 6966 2069 7369 6e73 7461 6e63 6528 776f  if isinstance(wo
+00033d20: 726b 6572 2c20 7374 7229 2065 6c73 6520  rker, str) else 
+00033d30: 776f 726b 6572 0a20 2020 2020 2020 2069  worker.        i
+00033d40: 6620 6e6f 7420 7773 3a0a 2020 2020 2020  f not ws:.      
+00033d50: 2020 2020 2020 7265 7475 726e 0a20 2020        return.   
+00033d60: 2020 2020 2070 7265 765f 7374 6174 7573       prev_status
+00033d70: 203d 2077 732e 7374 6174 7573 0a20 2020   = ws.status.   
+00033d80: 2020 2020 2077 732e 7374 6174 7573 203d       ws.status =
+00033d90: 2053 7461 7475 735b 7374 6174 7573 5d20   Status[status] 
+00033da0: 6966 2069 7369 6e73 7461 6e63 6528 7374  if isinstance(st
+00033db0: 6174 7573 2c20 7374 7229 2065 6c73 6520  atus, str) else 
+00033dc0: 7374 6174 7573 0a20 2020 2020 2020 2069  status.        i
+00033dd0: 6620 7773 2e73 7461 7475 7320 3d3d 2070  f ws.status == p
+00033de0: 7265 765f 7374 6174 7573 3a0a 2020 2020  rev_status:.    
+00033df0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+00033e00: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+00033e10: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
+00033e20: 2020 2020 7773 2e61 6464 7265 7373 2c0a      ws.address,.
+00033e30: 2020 2020 2020 2020 2020 2020 7b0a 2020              {.  
+00033e40: 2020 2020 2020 2020 2020 2020 2020 2261                "a
+00033e50: 6374 696f 6e22 3a20 2277 6f72 6b65 722d  ction": "worker-
+00033e60: 7374 6174 7573 2d63 6861 6e67 6522 2c0a  status-change",.
+00033e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00033e80: 2270 7265 762d 7374 6174 7573 223a 2070  "prev-status": p
+00033e90: 7265 765f 7374 6174 7573 2e6e 616d 652c  rev_status.name,
+00033ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00033eb0: 2022 7374 6174 7573 223a 2077 732e 7374   "status": ws.st
+00033ec0: 6174 7573 2e6e 616d 652c 0a20 2020 2020  atus.name,.     
+00033ed0: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
+00033ee0: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
+00033ef0: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
+00033f00: 2020 207d 2c0a 2020 2020 2020 2020 290a     },.        ).
+00033f10: 2020 2020 2020 2020 6c6f 6767 6572 2e64          logger.d
+00033f20: 6562 7567 2866 2257 6f72 6b65 7220 7374  ebug(f"Worker st
+00033f30: 6174 7573 207b 7072 6576 5f73 7461 7475  atus {prev_statu
+00033f40: 732e 6e61 6d65 7d20 2d3e 207b 7374 6174  s.name} -> {stat
+00033f50: 7573 7d20 2d20 7b77 737d 2229 0a0a 2020  us} - {ws}")..  
+00033f60: 2020 2020 2020 6966 2077 732e 7374 6174        if ws.stat
+00033f70: 7573 203d 3d20 5374 6174 7573 2e72 756e  us == Status.run
+00033f80: 6e69 6e67 3a0a 2020 2020 2020 2020 2020  ning:.          
+00033f90: 2020 7365 6c66 2e72 756e 6e69 6e67 2e61    self.running.a
+00033fa0: 6464 2877 7329 0a20 2020 2020 2020 2020  dd(ws).         
+00033fb0: 2020 2073 656c 662e 6368 6563 6b5f 6964     self.check_id
+00033fc0: 6c65 5f73 6174 7572 6174 6564 2877 7329  le_saturated(ws)
+00033fd0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00033fe0: 662e 7472 616e 7369 7469 6f6e 7328 0a20  f.transitions(. 
+00033ff0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00034000: 656c 662e 6275 6c6b 5f73 6368 6564 756c  elf.bulk_schedul
+00034010: 655f 756e 7275 6e6e 6162 6c65 5f61 6674  e_unrunnable_aft
+00034020: 6572 5f61 6464 696e 675f 776f 726b 6572  er_adding_worker
+00034030: 2877 7329 2c20 7374 696d 756c 7573 5f69  (ws), stimulus_i
+00034040: 640a 2020 2020 2020 2020 2020 2020 290a  d.            ).
+00034050: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00034060: 2e73 7469 6d75 6c75 735f 7175 6575 655f  .stimulus_queue_
+00034070: 736c 6f74 735f 6d61 7962 655f 6f70 656e  slots_maybe_open
+00034080: 6564 2873 7469 6d75 6c75 735f 6964 3d73  ed(stimulus_id=s
+00034090: 7469 6d75 6c75 735f 6964 290a 2020 2020  timulus_id).    
+000340a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000340b0: 2020 2020 2020 7365 6c66 2e72 756e 6e69        self.runni
+000340c0: 6e67 2e64 6973 6361 7264 2877 7329 0a20  ng.discard(ws). 
+000340d0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000340e0: 6964 6c65 2e70 6f70 2877 732e 6164 6472  idle.pop(ws.addr
+000340f0: 6573 732c 204e 6f6e 6529 0a20 2020 2020  ess, None).     
+00034100: 2020 2020 2020 2073 656c 662e 6964 6c65         self.idle
+00034110: 5f74 6173 6b5f 636f 756e 742e 6469 7363  _task_count.disc
+00034120: 6172 6428 7773 290a 2020 2020 2020 2020  ard(ws).        
+00034130: 2020 2020 7365 6c66 2e73 6174 7572 6174      self.saturat
+00034140: 6564 2e64 6973 6361 7264 2877 7329 0a0a  ed.discard(ws)..
+00034150: 2020 2020 6465 6620 6861 6e64 6c65 5f72      def handle_r
+00034160: 6571 7565 7374 5f72 6566 7265 7368 5f77  equest_refresh_w
+00034170: 686f 5f68 6173 280a 2020 2020 2020 2020  ho_has(.        
+00034180: 7365 6c66 2c20 6b65 7973 3a20 4974 6572  self, keys: Iter
+00034190: 6162 6c65 5b4b 6579 5d2c 2077 6f72 6b65  able[Key], worke
+000341a0: 723a 2073 7472 2c20 7374 696d 756c 7573  r: str, stimulus
+000341b0: 5f69 643a 2073 7472 0a20 2020 2029 202d  _id: str.    ) -
+000341c0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000341d0: 2222 2252 6571 7565 7374 2066 726f 6d20  """Request from 
+000341e0: 6120 576f 726b 6572 2074 6f20 7265 6672  a Worker to refr
+000341f0: 6573 6820 7468 650a 2020 2020 2020 2020  esh the.        
+00034200: 7768 6f5f 6861 7320 666f 7220 736f 6d65  who_has for some
+00034210: 206b 6579 732e 204e 6f74 2074 6f20 6265   keys. Not to be
+00034220: 2063 6f6e 6675 7365 6420 7769 7468 2073   confused with s
+00034230: 6368 6564 756c 6572 2e77 686f 5f68 6173  cheduler.who_has
+00034240: 2c20 7768 6963 680a 2020 2020 2020 2020  , which.        
+00034250: 6973 2061 2064 6564 6963 6174 6564 2063  is a dedicated c
+00034260: 6f6d 6d20 5250 4320 7265 7175 6573 7420  omm RPC request 
+00034270: 6672 6f6d 2061 2043 6c69 656e 742e 0a20  from a Client.. 
+00034280: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00034290: 2020 2077 686f 5f68 6173 203d 207b 7d0a     who_has = {}.
+000342a0: 2020 2020 2020 2020 6672 6565 5f6b 6579          free_key
+000342b0: 7320 3d20 5b5d 0a20 2020 2020 2020 2066  s = [].        f
+000342c0: 6f72 206b 6579 2069 6e20 6b65 7973 3a0a  or key in keys:.
+000342d0: 2020 2020 2020 2020 2020 2020 6966 206b              if k
+000342e0: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
+000342f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00034300: 2020 7768 6f5f 6861 735b 6b65 795d 203d    who_has[key] =
+00034310: 205b 7773 2e61 6464 7265 7373 2066 6f72   [ws.address for
+00034320: 2077 7320 696e 2073 656c 662e 7461 736b   ws in self.task
+00034330: 735b 6b65 795d 2e77 686f 5f68 6173 206f  s[key].who_has o
+00034340: 7220 2829 5d0a 2020 2020 2020 2020 2020  r ()].          
+00034350: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00034360: 2020 2020 2020 2020 6672 6565 5f6b 6579          free_key
+00034370: 732e 6170 7065 6e64 286b 6579 290a 0a20  s.append(key).. 
+00034380: 2020 2020 2020 2069 6620 7768 6f5f 6861         if who_ha
+00034390: 733a 0a20 2020 2020 2020 2020 2020 2073  s:.            s
+000343a0: 656c 662e 7374 7265 616d 5f63 6f6d 6d73  elf.stream_comms
+000343b0: 5b77 6f72 6b65 725d 2e73 656e 6428 0a20  [worker].send(. 
+000343c0: 2020 2020 2020 2020 2020 2020 2020 207b                 {
+000343d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000343e0: 2020 2020 2022 6f70 223a 2022 7265 6672       "op": "refr
+000343f0: 6573 682d 7768 6f2d 6861 7322 2c0a 2020  esh-who-has",.  
+00034400: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034410: 2020 2277 686f 5f68 6173 223a 2077 686f    "who_has": who
+00034420: 5f68 6173 2c0a 2020 2020 2020 2020 2020  _has,.          
+00034430: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
+00034440: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
+00034450: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
+00034460: 2020 2020 2020 7d0a 2020 2020 2020 2020        }.        
+00034470: 2020 2020 290a 2020 2020 2020 2020 6966      ).        if
+00034480: 2066 7265 655f 6b65 7973 3a0a 2020 2020   free_keys:.    
+00034490: 2020 2020 2020 2020 7365 6c66 2e73 7472          self.str
+000344a0: 6561 6d5f 636f 6d6d 735b 776f 726b 6572  eam_comms[worker
+000344b0: 5d2e 7365 6e64 280a 2020 2020 2020 2020  ].send(.        
+000344c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+000344d0: 2020 2020 2020 2020 2020 2020 2020 226f                "o
+000344e0: 7022 3a20 2266 7265 652d 6b65 7973 222c  p": "free-keys",
+000344f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00034500: 2020 2020 2022 6b65 7973 223a 2066 7265       "keys": fre
+00034510: 655f 6b65 7973 2c0a 2020 2020 2020 2020  e_keys,.        
+00034520: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+00034530: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
+00034540: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+00034550: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+00034560: 2020 2020 2020 290a 0a20 2020 2061 7379        )..    asy
+00034570: 6e63 2064 6566 2068 616e 646c 655f 776f  nc def handle_wo
+00034580: 726b 6572 2873 656c 662c 2063 6f6d 6d3a  rker(self, comm:
+00034590: 2043 6f6d 6d2c 2077 6f72 6b65 723a 2073   Comm, worker: s
+000345a0: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
+000345b0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000345c0: 204c 6973 7465 6e20 746f 2072 6573 706f   Listen to respo
+000345d0: 6e73 6573 2066 726f 6d20 6120 7369 6e67  nses from a sing
+000345e0: 6c65 2077 6f72 6b65 720a 0a20 2020 2020  le worker..     
+000345f0: 2020 2054 6869 7320 6973 2074 6865 206d     This is the m
+00034600: 6169 6e20 6c6f 6f70 2066 6f72 2073 6368  ain loop for sch
+00034610: 6564 756c 6572 2d77 6f72 6b65 7220 696e  eduler-worker in
+00034620: 7465 7261 6374 696f 6e0a 0a20 2020 2020  teraction..     
+00034630: 2020 2053 6565 2041 6c73 6f0a 2020 2020     See Also.    
+00034640: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+00034650: 2020 2020 2053 6368 6564 756c 6572 2e68       Scheduler.h
+00034660: 616e 646c 655f 636c 6965 6e74 3a20 4571  andle_client: Eq
+00034670: 7569 7661 6c65 6e74 2063 6f72 6f75 7469  uivalent corouti
+00034680: 6e65 2066 6f72 2063 6c69 656e 7473 0a20  ne for clients. 
+00034690: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+000346a0: 2020 2063 6f6d 6d2e 6e61 6d65 203d 2022     comm.name = "
+000346b0: 5363 6865 6475 6c65 7220 636f 6e6e 6563  Scheduler connec
+000346c0: 7469 6f6e 2074 6f20 776f 726b 6572 220a  tion to worker".
+000346d0: 2020 2020 2020 2020 776f 726b 6572 5f63          worker_c
+000346e0: 6f6d 6d20 3d20 7365 6c66 2e73 7472 6561  omm = self.strea
+000346f0: 6d5f 636f 6d6d 735b 776f 726b 6572 5d0a  m_comms[worker].
+00034700: 2020 2020 2020 2020 776f 726b 6572 5f63          worker_c
+00034710: 6f6d 6d2e 7374 6172 7428 636f 6d6d 290a  omm.start(comm).
+00034720: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00034730: 6e66 6f28 2253 7461 7274 696e 6720 776f  nfo("Starting wo
+00034740: 726b 6572 2063 6f6d 7075 7465 2073 7472  rker compute str
+00034750: 6561 6d2c 2025 7322 2c20 776f 726b 6572  eam, %s", worker
+00034760: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+00034770: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00034780: 2073 656c 662e 6861 6e64 6c65 5f73 7472   self.handle_str
+00034790: 6561 6d28 636f 6d6d 3d63 6f6d 6d2c 2065  eam(comm=comm, e
+000347a0: 7874 7261 3d7b 2277 6f72 6b65 7222 3a20  xtra={"worker": 
+000347b0: 776f 726b 6572 7d29 0a20 2020 2020 2020  worker}).       
+000347c0: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
+000347d0: 2020 2020 2020 6966 2077 6f72 6b65 7220        if worker 
+000347e0: 696e 2073 656c 662e 7374 7265 616d 5f63  in self.stream_c
+000347f0: 6f6d 6d73 3a0a 2020 2020 2020 2020 2020  omms:.          
+00034800: 2020 2020 2020 776f 726b 6572 5f63 6f6d        worker_com
+00034810: 6d2e 6162 6f72 7428 290a 2020 2020 2020  m.abort().      
+00034820: 2020 2020 2020 2020 2020 6177 6169 7420            await 
+00034830: 7365 6c66 2e72 656d 6f76 655f 776f 726b  self.remove_work
+00034840: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+00034850: 2020 2020 2020 2020 776f 726b 6572 2c20          worker, 
+00034860: 7374 696d 756c 7573 5f69 643d 6622 6861  stimulus_id=f"ha
+00034870: 6e64 6c65 2d77 6f72 6b65 722d 636c 6561  ndle-worker-clea
+00034880: 6e75 702d 7b74 696d 6528 297d 220a 2020  nup-{time()}".  
+00034890: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+000348a0: 0a20 2020 2064 6566 2061 6464 5f70 6c75  .    def add_plu
+000348b0: 6769 6e28 0a20 2020 2020 2020 2073 656c  gin(.        sel
+000348c0: 662c 0a20 2020 2020 2020 2070 6c75 6769  f,.        plugi
+000348d0: 6e3a 2053 6368 6564 756c 6572 506c 7567  n: SchedulerPlug
+000348e0: 696e 2c0a 2020 2020 2020 2020 2a2c 0a20  in,.        *,. 
+000348f0: 2020 2020 2020 2069 6465 6d70 6f74 656e         idempoten
+00034900: 743a 2062 6f6f 6c20 3d20 4661 6c73 652c  t: bool = False,
+00034910: 0a20 2020 2020 2020 206e 616d 653a 2073  .        name: s
+00034920: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+00034930: 2c0a 2020 2020 2020 2020 2a2a 6b77 6172  ,.        **kwar
+00034940: 6773 3a20 416e 792c 0a20 2020 2029 202d  gs: Any,.    ) -
+00034950: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00034960: 2222 2241 6464 2065 7874 6572 6e61 6c20  """Add external 
+00034970: 706c 7567 696e 2074 6f20 7363 6865 6475  plugin to schedu
+00034980: 6c65 722e 0a0a 2020 2020 2020 2020 5365  ler...        Se
+00034990: 6520 6874 7470 733a 2f2f 6469 7374 7269  e https://distri
+000349a0: 6275 7465 642e 7265 6164 7468 6564 6f63  buted.readthedoc
+000349b0: 732e 696f 2f65 6e2f 6c61 7465 7374 2f70  s.io/en/latest/p
+000349c0: 6c75 6769 6e73 2e68 746d 6c0a 0a20 2020  lugins.html..   
+000349d0: 2020 2020 2050 6172 616d 6574 6572 730a       Parameters.
+000349e0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+000349f0: 2d2d 0a20 2020 2020 2020 2070 6c75 6769  --.        plugi
+00034a00: 6e20 3a20 5363 6865 6475 6c65 7250 6c75  n : SchedulerPlu
+00034a10: 6769 6e0a 2020 2020 2020 2020 2020 2020  gin.            
+00034a20: 5363 6865 6475 6c65 7250 6c75 6769 6e20  SchedulerPlugin 
+00034a30: 696e 7374 616e 6365 2074 6f20 6164 640a  instance to add.
+00034a40: 2020 2020 2020 2020 6964 656d 706f 7465          idempote
+00034a50: 6e74 203a 2062 6f6f 6c0a 2020 2020 2020  nt : bool.      
+00034a60: 2020 2020 2020 4966 2074 7275 652c 2074        If true, t
+00034a70: 6865 2070 6c75 6769 6e20 6973 2061 7373  he plugin is ass
+00034a80: 756d 6564 2074 6f20 616c 7265 6164 7920  umed to already 
+00034a90: 6578 6973 7420 616e 6420 6e6f 0a20 2020  exist and no.   
+00034aa0: 2020 2020 2020 2020 2061 6374 696f 6e20           action 
+00034ab0: 6973 2074 616b 656e 2e0a 2020 2020 2020  is taken..      
+00034ac0: 2020 6e61 6d65 203a 2073 7472 0a20 2020    name : str.   
+00034ad0: 2020 2020 2020 2020 2041 206e 616d 6520           A name 
+00034ae0: 666f 7220 7468 6520 706c 7567 696e 2c20  for the plugin, 
+00034af0: 6966 204e 6f6e 652c 2074 6865 206e 616d  if None, the nam
+00034b00: 6520 6174 7472 6962 7574 6520 6973 0a20  e attribute is. 
+00034b10: 2020 2020 2020 2020 2020 2063 6865 636b             check
+00034b20: 6564 206f 6e20 7468 6520 506c 7567 696e  ed on the Plugin
+00034b30: 2069 6e73 7461 6e63 6520 616e 6420 6765   instance and ge
+00034b40: 6e65 7261 7465 6420 6966 206e 6f74 0a20  nerated if not. 
+00034b50: 2020 2020 2020 2020 2020 2064 6973 636f             disco
+00034b60: 7665 7265 642e 0a20 2020 2020 2020 2022  vered..        "
+00034b70: 2222 0a20 2020 2020 2020 2069 6620 6e61  "".        if na
+00034b80: 6d65 2069 7320 4e6f 6e65 3a0a 2020 2020  me is None:.    
+00034b90: 2020 2020 2020 2020 6e61 6d65 203d 205f          name = _
+00034ba0: 6765 745f 706c 7567 696e 5f6e 616d 6528  get_plugin_name(
+00034bb0: 706c 7567 696e 290a 0a20 2020 2020 2020  plugin)..       
+00034bc0: 2069 6620 6e61 6d65 2069 6e20 7365 6c66   if name in self
+00034bd0: 2e70 6c75 6769 6e73 3a0a 2020 2020 2020  .plugins:.      
+00034be0: 2020 2020 2020 6966 2069 6465 6d70 6f74        if idempot
+00034bf0: 656e 743a 0a20 2020 2020 2020 2020 2020  ent:.           
+00034c00: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00034c10: 2020 2020 2020 2020 7761 726e 696e 6773          warnings
+00034c20: 2e77 6172 6e28 0a20 2020 2020 2020 2020  .warn(.         
+00034c30: 2020 2020 2020 2066 2253 6368 6564 756c         f"Schedul
+00034c40: 6572 2061 6c72 6561 6479 2063 6f6e 7461  er already conta
+00034c50: 696e 7320 6120 706c 7567 696e 2077 6974  ins a plugin wit
+00034c60: 6820 6e61 6d65 207b 6e61 6d65 7d3b 206f  h name {name}; o
+00034c70: 7665 7277 7269 7469 6e67 2e22 2c0a 2020  verwriting.",.  
+00034c80: 2020 2020 2020 2020 2020 2020 2020 6361                ca
+00034c90: 7465 676f 7279 3d55 7365 7257 6172 6e69  tegory=UserWarni
+00034ca0: 6e67 2c0a 2020 2020 2020 2020 2020 2020  ng,.            
+00034cb0: 290a 0a20 2020 2020 2020 2070 6172 616d  )..        param
+00034cc0: 6574 6572 7320 3d20 696e 7370 6563 742e  eters = inspect.
+00034cd0: 7369 676e 6174 7572 6528 706c 7567 696e  signature(plugin
+00034ce0: 2e72 656d 6f76 655f 776f 726b 6572 292e  .remove_worker).
+00034cf0: 7061 7261 6d65 7465 7273 0a20 2020 2020  parameters.     
+00034d00: 2020 2069 6620 6e6f 7420 616e 7928 702e     if not any(p.
+00034d10: 6b69 6e64 2069 7320 702e 5641 525f 4b45  kind is p.VAR_KE
+00034d20: 5957 4f52 4420 666f 7220 7020 696e 2070  YWORD for p in p
+00034d30: 6172 616d 6574 6572 732e 7661 6c75 6573  arameters.values
+00034d40: 2829 293a 0a20 2020 2020 2020 2020 2020  ()):.           
+00034d50: 2077 6172 6e69 6e67 732e 7761 726e 280a   warnings.warn(.
+00034d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00034d70: 2254 6865 2073 6967 6e61 7475 7265 206f  "The signature o
+00034d80: 6620 6053 6368 6564 756c 6572 506c 7567  f `SchedulerPlug
+00034d90: 696e 2e72 656d 6f76 655f 776f 726b 6572  in.remove_worker
+00034da0: 6020 6e6f 7720 7265 7175 6972 6573 2060  ` now requires `
+00034db0: 2a2a 6b77 6172 6773 6020 220a 2020 2020  **kwargs` ".    
+00034dc0: 2020 2020 2020 2020 2020 2020 2274 6f20              "to 
+00034dd0: 656e 7375 7265 2074 6861 7420 706c 7567  ensure that plug
+00034de0: 696e 7320 7265 6d61 696e 2066 6f72 7761  ins remain forwa
+00034df0: 7264 2d63 6f6d 7061 7469 626c 652e 204e  rd-compatible. N
+00034e00: 6f74 2069 6e63 6c75 6469 6e67 2022 0a20  ot including ". 
+00034e10: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00034e20: 602a 2a6b 7761 7267 7360 2069 6e20 7468  `**kwargs` in th
+00034e30: 6520 7369 676e 6174 7572 6520 7769 6c6c  e signature will
+00034e40: 206e 6f20 6c6f 6e67 6572 2062 6520 7375   no longer be su
+00034e50: 7070 6f72 7465 6420 696e 2066 7574 7572  pported in futur
+00034e60: 6520 7665 7273 696f 6e73 2e22 2c0a 2020  e versions.",.  
+00034e70: 2020 2020 2020 2020 2020 2020 2020 4675                Fu
+00034e80: 7475 7265 5761 726e 696e 672c 0a20 2020  tureWarning,.   
+00034e90: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00034ea0: 2020 2020 7365 6c66 2e70 6c75 6769 6e73      self.plugins
+00034eb0: 5b6e 616d 655d 203d 2070 6c75 6769 6e0a  [name] = plugin.
+00034ec0: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
+00034ed0: 706c 7567 696e 2873 656c 662c 206e 616d  plugin(self, nam
+00034ee0: 653a 2073 7472 207c 204e 6f6e 6520 3d20  e: str | None = 
+00034ef0: 4e6f 6e65 2920 2d3e 204e 6f6e 653a 0a20  None) -> None:. 
+00034f00: 2020 2020 2020 2022 2222 5265 6d6f 7665         """Remove
+00034f10: 2065 7874 6572 6e61 6c20 706c 7567 696e   external plugin
+00034f20: 2066 726f 6d20 7363 6865 6475 6c65 720a   from scheduler.
+00034f30: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+00034f40: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+00034f50: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 206e  ------.        n
+00034f60: 616d 6520 3a20 7374 720a 2020 2020 2020  ame : str.      
+00034f70: 2020 2020 2020 4e61 6d65 206f 6620 7468        Name of th
+00034f80: 6520 706c 7567 696e 2074 6f20 7265 6d6f  e plugin to remo
+00034f90: 7665 0a20 2020 2020 2020 2022 2222 0a20  ve.        """. 
+00034fa0: 2020 2020 2020 2061 7373 6572 7420 6e61         assert na
+00034fb0: 6d65 2069 7320 6e6f 7420 4e6f 6e65 0a0a  me is not None..
+00034fc0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00034fd0: 2020 2020 2020 2020 2064 656c 2073 656c           del sel
+00034fe0: 662e 706c 7567 696e 735b 6e61 6d65 5d0a  f.plugins[name].
+00034ff0: 2020 2020 2020 2020 6578 6365 7074 204b          except K
+00035000: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
+00035010: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00035020: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
+00035030: 2020 2020 2020 2066 2243 6f75 6c64 206e         f"Could n
+00035040: 6f74 2066 696e 6420 706c 7567 696e 207b  ot find plugin {
+00035050: 6e61 6d65 2172 7d20 616d 6f6e 6720 7468  name!r} among th
+00035060: 6520 6375 7272 656e 7420 7363 6865 6475  e current schedu
+00035070: 6c65 7220 706c 7567 696e 7322 0a20 2020  ler plugins".   
+00035080: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00035090: 6173 796e 6320 6465 6620 7265 6769 7374  async def regist
+000350a0: 6572 5f73 6368 6564 756c 6572 5f70 6c75  er_scheduler_plu
+000350b0: 6769 6e28 0a20 2020 2020 2020 2073 656c  gin(.        sel
+000350c0: 662c 0a20 2020 2020 2020 2070 6c75 6769  f,.        plugi
+000350d0: 6e3a 2062 7974 6573 207c 2053 6368 6564  n: bytes | Sched
+000350e0: 756c 6572 506c 7567 696e 2c0a 2020 2020  ulerPlugin,.    
+000350f0: 2020 2020 6e61 6d65 3a20 7374 7220 7c20      name: str | 
+00035100: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+00035110: 2020 2020 2069 6465 6d70 6f74 656e 743a       idempotent:
+00035120: 2062 6f6f 6c20 7c20 4e6f 6e65 203d 204e   bool | None = N
+00035130: 6f6e 652c 0a20 2020 2029 202d 3e20 4e6f  one,.    ) -> No
+00035140: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
+00035150: 6567 6973 7465 7220 6120 706c 7567 696e  egister a plugin
+00035160: 206f 6e20 7468 6520 7363 6865 6475 6c65   on the schedule
+00035170: 722e 2222 220a 2020 2020 2020 2020 6966  r.""".        if
+00035180: 2069 6465 6d70 6f74 656e 7420 6973 204e   idempotent is N
+00035190: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+000351a0: 2077 6172 6e69 6e67 732e 7761 726e 280a   warnings.warn(.
+000351b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000351c0: 2254 6865 2073 6967 6e61 7475 7265 206f  "The signature o
+000351d0: 6620 6053 6368 6564 756c 6572 2e72 6567  f `Scheduler.reg
+000351e0: 6973 7465 725f 7363 6865 6475 6c65 725f  ister_scheduler_
+000351f0: 706c 7567 696e 6020 6e6f 7720 7265 7175  plugin` now requ
+00035200: 6972 6573 2022 0a20 2020 2020 2020 2020  ires ".         
+00035210: 2020 2020 2020 2022 6069 6465 6d70 6f74         "`idempot
+00035220: 656e 7460 2e20 4e6f 7420 696e 636c 7564  ent`. Not includ
+00035230: 696e 6720 6069 6465 6d70 6f74 656e 7460  ing `idempotent`
+00035240: 2069 6e20 7468 6520 7369 676e 6174 7572   in the signatur
+00035250: 6520 7769 6c6c 206e 6f20 6c6f 6e67 6572  e will no longer
+00035260: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00035270: 2020 2022 6265 2073 7570 706f 7274 6564     "be supported
+00035280: 2069 6e20 6675 7475 7265 2076 6572 7369   in future versi
+00035290: 6f6e 732e 222c 0a20 2020 2020 2020 2020  ons.",.         
+000352a0: 2020 2020 2020 2046 7574 7572 6557 6172         FutureWar
+000352b0: 6e69 6e67 2c0a 2020 2020 2020 2020 2020  ning,.          
+000352c0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+000352d0: 6964 656d 706f 7465 6e74 203d 2046 616c  idempotent = Fal
+000352e0: 7365 0a20 2020 2020 2020 2069 6620 6e6f  se.        if no
+000352f0: 7420 6973 696e 7374 616e 6365 2870 6c75  t isinstance(plu
+00035300: 6769 6e2c 2053 6368 6564 756c 6572 506c  gin, SchedulerPl
+00035310: 7567 696e 293a 0a20 2020 2020 2020 2020  ugin):.         
+00035320: 2020 2070 6c75 6769 6e20 3d20 6c6f 6164     plugin = load
+00035330: 7328 706c 7567 696e 290a 2020 2020 2020  s(plugin).      
+00035340: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+00035350: 6e73 7461 6e63 6528 706c 7567 696e 2c20  nstance(plugin, 
+00035360: 5363 6865 6475 6c65 7250 6c75 6769 6e29  SchedulerPlugin)
+00035370: 0a0a 2020 2020 2020 2020 6966 206e 616d  ..        if nam
+00035380: 6520 6973 204e 6f6e 653a 0a20 2020 2020  e is None:.     
+00035390: 2020 2020 2020 206e 616d 6520 3d20 5f67         name = _g
+000353a0: 6574 5f70 6c75 6769 6e5f 6e61 6d65 2870  et_plugin_name(p
+000353b0: 6c75 6769 6e29 0a0a 2020 2020 2020 2020  lugin)..        
+000353c0: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
+000353d0: 706c 7567 696e 7320 616e 6420 6964 656d  plugins and idem
+000353e0: 706f 7465 6e74 3a0a 2020 2020 2020 2020  potent:.        
+000353f0: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+00035400: 2020 2020 6966 2068 6173 6174 7472 2870      if hasattr(p
+00035410: 6c75 6769 6e2c 2022 7374 6172 7422 293a  lugin, "start"):
+00035420: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00035430: 756c 7420 3d20 706c 7567 696e 2e73 7461  ult = plugin.sta
+00035440: 7274 2873 656c 6629 0a20 2020 2020 2020  rt(self).       
+00035450: 2020 2020 2069 6620 696e 7370 6563 742e       if inspect.
+00035460: 6973 6177 6169 7461 626c 6528 7265 7375  isawaitable(resu
+00035470: 6c74 293a 0a20 2020 2020 2020 2020 2020  lt):.           
+00035480: 2020 2020 2061 7761 6974 2072 6573 756c       await resul
+00035490: 740a 0a20 2020 2020 2020 2073 656c 662e  t..        self.
+000354a0: 6164 645f 706c 7567 696e 2870 6c75 6769  add_plugin(plugi
+000354b0: 6e2c 206e 616d 653d 6e61 6d65 2c20 6964  n, name=name, id
+000354c0: 656d 706f 7465 6e74 3d69 6465 6d70 6f74  empotent=idempot
+000354d0: 656e 7429 0a0a 2020 2020 6173 796e 6320  ent)..    async 
+000354e0: 6465 6620 756e 7265 6769 7374 6572 5f73  def unregister_s
+000354f0: 6368 6564 756c 6572 5f70 6c75 6769 6e28  cheduler_plugin(
+00035500: 7365 6c66 2c20 6e61 6d65 3a20 7374 7229  self, name: str)
+00035510: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00035520: 2020 2222 2255 6e72 6567 6973 7465 7220    """Unregister 
+00035530: 6120 706c 7567 696e 206f 6e20 7468 6520  a plugin on the 
+00035540: 7363 6865 6475 6c65 722e 2222 220a 2020  scheduler.""".  
+00035550: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
+00035560: 655f 706c 7567 696e 286e 616d 6529 0a0a  e_plugin(name)..
+00035570: 2020 2020 6465 6620 776f 726b 6572 5f73      def worker_s
+00035580: 656e 6428 7365 6c66 2c20 776f 726b 6572  end(self, worker
+00035590: 3a20 7374 722c 206d 7367 3a20 6469 6374  : str, msg: dict
+000355a0: 5b73 7472 2c20 416e 795d 2920 2d3e 204e  [str, Any]) -> N
+000355b0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+000355c0: 5365 6e64 206d 6573 7361 6765 2074 6f20  Send message to 
+000355d0: 776f 726b 6572 0a0a 2020 2020 2020 2020  worker..        
+000355e0: 5468 6973 2061 6c73 6f20 6861 6e64 6c65  This also handle
+000355f0: 7320 636f 6e6e 6563 7469 6f6e 2066 6169  s connection fai
+00035600: 6c75 7265 7320 6279 2061 6464 696e 6720  lures by adding 
+00035610: 6120 6361 6c6c 6261 636b 2074 6f20 7265  a callback to re
+00035620: 6d6f 7665 0a20 2020 2020 2020 2074 6865  move.        the
+00035630: 2077 6f72 6b65 7220 6f6e 2074 6865 206e   worker on the n
+00035640: 6578 7420 6379 636c 652e 0a20 2020 2020  ext cycle..     
+00035650: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
+00035660: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00035670: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
+00035680: 735b 776f 726b 6572 5d2e 7365 6e64 286d  s[worker].send(m
+00035690: 7367 290a 2020 2020 2020 2020 6578 6365  sg).        exce
+000356a0: 7074 2028 436f 6d6d 436c 6f73 6564 4572  pt (CommClosedEr
+000356b0: 726f 722c 2041 7474 7269 6275 7465 4572  ror, AttributeEr
+000356c0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000356d0: 2020 7365 6c66 2e5f 6f6e 676f 696e 675f    self._ongoing_
+000356e0: 6261 636b 6772 6f75 6e64 5f74 6173 6b73  background_tasks
+000356f0: 2e63 616c 6c5f 736f 6f6e 280a 2020 2020  .call_soon(.    
+00035700: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00035710: 2e72 656d 6f76 655f 776f 726b 6572 2c20  .remove_worker, 
+00035720: 2023 2074 7970 653a 2069 676e 6f72 655b   # type: ignore[
+00035730: 6172 672d 7479 7065 5d0a 2020 2020 2020  arg-type].      
+00035740: 2020 2020 2020 2020 2020 6164 6472 6573            addres
+00035750: 733d 776f 726b 6572 2c0a 2020 2020 2020  s=worker,.      
+00035760: 2020 2020 2020 2020 2020 7374 696d 756c            stimul
+00035770: 7573 5f69 643d 6622 776f 726b 6572 2d73  us_id=f"worker-s
+00035780: 656e 642d 636f 6d6d 2d66 6169 6c2d 7b74  end-comm-fail-{t
+00035790: 696d 6528 297d 222c 0a20 2020 2020 2020  ime()}",.       
+000357a0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+000357b0: 636c 6965 6e74 5f73 656e 6428 7365 6c66  client_send(self
+000357c0: 2c20 636c 6965 6e74 2c20 6d73 6729 3a0a  , client, msg):.
+000357d0: 2020 2020 2020 2020 2222 2253 656e 6420          """Send 
+000357e0: 6d65 7373 6167 6520 746f 2063 6c69 656e  message to clien
+000357f0: 7422 2222 0a20 2020 2020 2020 2063 203d  t""".        c =
+00035800: 2073 656c 662e 636c 6965 6e74 5f63 6f6d   self.client_com
+00035810: 6d73 2e67 6574 2863 6c69 656e 7429 0a20  ms.get(client). 
+00035820: 2020 2020 2020 2069 6620 6320 6973 204e         if c is N
+00035830: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00035840: 2072 6574 7572 6e0a 2020 2020 2020 2020   return.        
+00035850: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00035860: 2063 2e73 656e 6428 6d73 6729 0a20 2020   c.send(msg).   
+00035870: 2020 2020 2065 7863 6570 7420 436f 6d6d       except Comm
+00035880: 436c 6f73 6564 4572 726f 723a 0a20 2020  ClosedError:.   
+00035890: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+000358a0: 2e73 7461 7475 7320 3d3d 2053 7461 7475  .status == Statu
+000358b0: 732e 7275 6e6e 696e 673a 0a20 2020 2020  s.running:.     
+000358c0: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+000358d0: 722e 6372 6974 6963 616c 280a 2020 2020  r.critical(.    
+000358e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000358f0: 2243 6c6f 7365 6420 636f 6d6d 2025 7220  "Closed comm %r 
+00035900: 7768 696c 6520 7472 7969 6e67 2074 6f20  while trying to 
+00035910: 7772 6974 6520 2573 222c 2063 2c20 6d73  write %s", c, ms
+00035920: 672c 2065 7863 5f69 6e66 6f3d 5472 7565  g, exc_info=True
+00035930: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00035940: 2029 0a0a 2020 2020 6465 6620 7365 6e64   )..    def send
+00035950: 5f61 6c6c 2873 656c 662c 2063 6c69 656e  _all(self, clien
+00035960: 745f 6d73 6773 3a20 4d73 6773 2c20 776f  t_msgs: Msgs, wo
+00035970: 726b 6572 5f6d 7367 733a 204d 7367 7329  rker_msgs: Msgs)
+00035980: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00035990: 2020 2222 2253 656e 6420 6d65 7373 6167    """Send messag
+000359a0: 6573 2074 6f20 636c 6965 6e74 2061 6e64  es to client and
+000359b0: 2077 6f72 6b65 7273 2222 220a 0a20 2020   workers"""..   
+000359c0: 2020 2020 2066 6f72 2063 6c69 656e 742c       for client,
+000359d0: 206d 7367 7320 696e 2063 6c69 656e 745f   msgs in client_
+000359e0: 6d73 6773 2e69 7465 6d73 2829 3a0a 2020  msgs.items():.  
+000359f0: 2020 2020 2020 2020 2020 6320 3d20 7365            c = se
+00035a00: 6c66 2e63 6c69 656e 745f 636f 6d6d 732e  lf.client_comms.
+00035a10: 6765 7428 636c 6965 6e74 290a 2020 2020  get(client).    
+00035a20: 2020 2020 2020 2020 6966 2063 2069 7320          if c is 
+00035a30: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00035a40: 2020 2020 2020 636f 6e74 696e 7565 0a20        continue. 
+00035a50: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00035a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035a70: 632e 7365 6e64 282a 6d73 6773 290a 2020  c.send(*msgs).  
+00035a80: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00035a90: 2043 6f6d 6d43 6c6f 7365 6445 7272 6f72   CommClosedError
+00035aa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00035ab0: 2020 6966 2073 656c 662e 7374 6174 7573    if self.status
+00035ac0: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+00035ad0: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+00035ae0: 2020 2020 2020 2020 6c6f 6767 6572 2e63          logger.c
+00035af0: 7269 7469 6361 6c28 0a20 2020 2020 2020  ritical(.       
+00035b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035b10: 2022 436c 6f73 6564 2063 6f6d 6d20 2572   "Closed comm %r
+00035b20: 2077 6869 6c65 2074 7279 696e 6720 746f   while trying to
+00035b30: 2077 7269 7465 2025 7322 2c0a 2020 2020   write %s",.    
 00035b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00035b50: 2020 2020 2065 7863 5f69 6e66 6f3d 5472       exc_info=Tr
-00035b60: 7565 2c0a 2020 2020 2020 2020 2020 2020  ue,.            
-00035b70: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00035b80: 2020 2066 6f72 2077 6f72 6b65 722c 206d     for worker, m
-00035b90: 7367 7320 696e 2077 6f72 6b65 725f 6d73  sgs in worker_ms
-00035ba0: 6773 2e69 7465 6d73 2829 3a0a 2020 2020  gs.items():.    
-00035bb0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00035bc0: 2020 2020 2020 2020 2020 2020 2077 203d               w =
-00035bd0: 2073 656c 662e 7374 7265 616d 5f63 6f6d   self.stream_com
-00035be0: 6d73 5b77 6f72 6b65 725d 0a20 2020 2020  ms[worker].     
-00035bf0: 2020 2020 2020 2020 2020 2077 2e73 656e             w.sen
-00035c00: 6428 2a6d 7367 7329 0a20 2020 2020 2020  d(*msgs).       
-00035c10: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
-00035c20: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-00035c30: 2020 2020 2020 2320 776f 726b 6572 2061        # worker a
-00035c40: 6c72 6561 6479 2067 6f6e 650a 2020 2020  lready gone.    
-00035c50: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-00035c60: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-00035c70: 6570 7420 2843 6f6d 6d43 6c6f 7365 6445  ept (CommClosedE
-00035c80: 7272 6f72 2c20 4174 7472 6962 7574 6545  rror, AttributeE
-00035c90: 7272 6f72 293a 0a20 2020 2020 2020 2020  rror):.         
-00035ca0: 2020 2020 2020 2073 656c 662e 5f6f 6e67         self._ong
-00035cb0: 6f69 6e67 5f62 6163 6b67 726f 756e 645f  oing_background_
-00035cc0: 7461 736b 732e 6361 6c6c 5f73 6f6f 6e28  tasks.call_soon(
-00035cd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00035ce0: 2020 2020 2073 656c 662e 7265 6d6f 7665       self.remove
-00035cf0: 5f77 6f72 6b65 722c 2020 2320 7479 7065  _worker,  # type
-00035d00: 3a20 6967 6e6f 7265 5b61 7267 2d74 7970  : ignore[arg-typ
-00035d10: 655d 0a20 2020 2020 2020 2020 2020 2020  e].             
-00035d20: 2020 2020 2020 2061 6464 7265 7373 3d77         address=w
-00035d30: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
-00035d40: 2020 2020 2020 2020 2020 2073 7469 6d75             stimu
-00035d50: 6c75 735f 6964 3d66 2273 656e 642d 616c  lus_id=f"send-al
-00035d60: 6c2d 636f 6d6d 2d66 6169 6c2d 7b74 696d  l-comm-fail-{tim
-00035d70: 6528 297d 222c 0a20 2020 2020 2020 2020  e()}",.         
-00035d80: 2020 2020 2020 2029 0a0a 2020 2020 2323         )..    ##
-00035d90: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00035da0: 2323 2323 2323 2323 2323 0a20 2020 2023  ##########.    #
-00035db0: 204c 6573 7320 636f 6d6d 6f6e 2069 6e74   Less common int
-00035dc0: 6572 6163 7469 6f6e 7320 230a 2020 2020  eractions #.    
+00035b50: 2020 2020 632c 0a20 2020 2020 2020 2020      c,.         
+00035b60: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00035b70: 7367 732c 0a20 2020 2020 2020 2020 2020  sgs,.           
+00035b80: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+00035b90: 5f69 6e66 6f3d 5472 7565 2c0a 2020 2020  _info=True,.    
+00035ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035bb0: 290a 0a20 2020 2020 2020 2066 6f72 2077  )..        for w
+00035bc0: 6f72 6b65 722c 206d 7367 7320 696e 2077  orker, msgs in w
+00035bd0: 6f72 6b65 725f 6d73 6773 2e69 7465 6d73  orker_msgs.items
+00035be0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00035bf0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00035c00: 2020 2020 2077 203d 2073 656c 662e 7374       w = self.st
+00035c10: 7265 616d 5f63 6f6d 6d73 5b77 6f72 6b65  ream_comms[worke
+00035c20: 725d 0a20 2020 2020 2020 2020 2020 2020  r].             
+00035c30: 2020 2077 2e73 656e 6428 2a6d 7367 7329     w.send(*msgs)
+00035c40: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00035c50: 6570 7420 4b65 7945 7272 6f72 3a0a 2020  ept KeyError:.  
+00035c60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00035c70: 776f 726b 6572 2061 6c72 6561 6479 2067  worker already g
+00035c80: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00035c90: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
+00035ca0: 2020 2020 2065 7863 6570 7420 2843 6f6d       except (Com
+00035cb0: 6d43 6c6f 7365 6445 7272 6f72 2c20 4174  mClosedError, At
+00035cc0: 7472 6962 7574 6545 7272 6f72 293a 0a20  tributeError):. 
+00035cd0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00035ce0: 656c 662e 5f6f 6e67 6f69 6e67 5f62 6163  elf._ongoing_bac
+00035cf0: 6b67 726f 756e 645f 7461 736b 732e 6361  kground_tasks.ca
+00035d00: 6c6c 5f73 6f6f 6e28 0a20 2020 2020 2020  ll_soon(.       
+00035d10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00035d20: 662e 7265 6d6f 7665 5f77 6f72 6b65 722c  f.remove_worker,
+00035d30: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+00035d40: 5b61 7267 2d74 7970 655d 0a20 2020 2020  [arg-type].     
+00035d50: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00035d60: 6464 7265 7373 3d77 6f72 6b65 722c 0a20  ddress=worker,. 
+00035d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00035d80: 2020 2073 7469 6d75 6c75 735f 6964 3d66     stimulus_id=f
+00035d90: 2273 656e 642d 616c 6c2d 636f 6d6d 2d66  "send-all-comm-f
+00035da0: 6169 6c2d 7b74 696d 6528 297d 222c 0a20  ail-{time()}",. 
+00035db0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00035dc0: 0a0a 2020 2020 2323 2323 2323 2323 2323  ..    ##########
 00035dd0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00035de0: 2323 2323 2323 2323 2323 2323 0a0a 2020  ############..  
-00035df0: 2020 6173 796e 6320 6465 6620 7363 6174    async def scat
-00035e00: 7465 7228 0a20 2020 2020 2020 2073 656c  ter(.        sel
-00035e10: 662c 0a20 2020 2020 2020 2063 6f6d 6d3d  f,.        comm=
-00035e20: 4e6f 6e65 2c0a 2020 2020 2020 2020 6461  None,.        da
-00035e30: 7461 3d4e 6f6e 652c 0a20 2020 2020 2020  ta=None,.       
-00035e40: 2077 6f72 6b65 7273 3d4e 6f6e 652c 0a20   workers=None,. 
-00035e50: 2020 2020 2020 2063 6c69 656e 743d 4e6f         client=No
-00035e60: 6e65 2c0a 2020 2020 2020 2020 6272 6f61  ne,.        broa
-00035e70: 6463 6173 743d 4661 6c73 652c 0a20 2020  dcast=False,.   
-00035e80: 2020 2020 2074 696d 656f 7574 3d32 2c0a       timeout=2,.
-00035e90: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
-00035ea0: 2222 5365 6e64 2064 6174 6120 6f75 7420  ""Send data out 
-00035eb0: 746f 2077 6f72 6b65 7273 0a0a 2020 2020  to workers..    
-00035ec0: 2020 2020 5365 6520 616c 736f 0a20 2020      See also.   
-00035ed0: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
-00035ee0: 2020 2020 2020 5363 6865 6475 6c65 722e        Scheduler.
-00035ef0: 6272 6f61 6463 6173 743a 0a20 2020 2020  broadcast:.     
-00035f00: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
-00035f10: 7461 7274 203d 2074 696d 6528 290a 2020  tart = time().  
-00035f20: 2020 2020 2020 7768 696c 6520 5472 7565        while True
-00035f30: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00035f40: 2077 6f72 6b65 7273 2069 7320 4e6f 6e65   workers is None
-00035f50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00035f60: 2020 7773 7320 3d20 7365 6c66 2e72 756e    wss = self.run
-00035f70: 6e69 6e67 0a20 2020 2020 2020 2020 2020  ning.           
-00035f80: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00035f90: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-00035fa0: 205b 7365 6c66 2e63 6f65 7263 655f 6164   [self.coerce_ad
-00035fb0: 6472 6573 7328 7729 2066 6f72 2077 2069  dress(w) for w i
-00035fc0: 6e20 776f 726b 6572 735d 0a20 2020 2020  n workers].     
-00035fd0: 2020 2020 2020 2020 2020 2077 7373 203d             wss =
-00035fe0: 207b 7365 6c66 2e77 6f72 6b65 7273 5b77   {self.workers[w
-00035ff0: 5d20 666f 7220 7720 696e 2077 6f72 6b65  ] for w in worke
-00036000: 7273 7d0a 2020 2020 2020 2020 2020 2020  rs}.            
-00036010: 2020 2020 7773 7320 3d20 7b77 7320 666f      wss = {ws fo
-00036020: 7220 7773 2069 6e20 7773 7320 6966 2077  r ws in wss if w
-00036030: 732e 7374 6174 7573 203d 3d20 5374 6174  s.status == Stat
-00036040: 7573 2e72 756e 6e69 6e67 7d0a 0a20 2020  us.running}..   
-00036050: 2020 2020 2020 2020 2069 6620 7773 733a           if wss:
-00036060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00036070: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
-00036080: 2020 2069 6620 7469 6d65 2829 203e 2073     if time() > s
-00036090: 7461 7274 202b 2074 696d 656f 7574 3a0a  tart + timeout:.
-000360a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000360b0: 7261 6973 6520 5469 6d65 6f75 7445 7272  raise TimeoutErr
-000360c0: 6f72 2822 4e6f 2076 616c 6964 2077 6f72  or("No valid wor
-000360d0: 6b65 7273 2066 6f75 6e64 2229 0a20 2020  kers found").   
-000360e0: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-000360f0: 7379 6e63 696f 2e73 6c65 6570 2830 2e31  syncio.sleep(0.1
-00036100: 290a 0a20 2020 2020 2020 206e 7468 7265  )..        nthre
-00036110: 6164 7320 3d20 7b77 732e 6164 6472 6573  ads = {ws.addres
-00036120: 733a 2077 732e 6e74 6872 6561 6473 2066  s: ws.nthreads f
-00036130: 6f72 2077 7320 696e 2077 7373 7d0a 0a20  or ws in wss}.. 
-00036140: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-00036150: 696e 7374 616e 6365 2864 6174 612c 2064  instance(data, d
-00036160: 6963 7429 0a0a 2020 2020 2020 2020 6b65  ict)..        ke
-00036170: 7973 2c20 7768 6f5f 6861 732c 206e 6279  ys, who_has, nby
-00036180: 7465 7320 3d20 6177 6169 7420 7363 6174  tes = await scat
-00036190: 7465 725f 746f 5f77 6f72 6b65 7273 286e  ter_to_workers(n
-000361a0: 7468 7265 6164 732c 2064 6174 612c 2072  threads, data, r
-000361b0: 7063 3d73 656c 662e 7270 6329 0a0a 2020  pc=self.rpc)..  
-000361c0: 2020 2020 2020 7365 6c66 2e75 7064 6174        self.updat
-000361d0: 655f 6461 7461 2877 686f 5f68 6173 3d77  e_data(who_has=w
-000361e0: 686f 5f68 6173 2c20 6e62 7974 6573 3d6e  ho_has, nbytes=n
-000361f0: 6279 7465 732c 2063 6c69 656e 743d 636c  bytes, client=cl
-00036200: 6965 6e74 290a 0a20 2020 2020 2020 2069  ient)..        i
-00036210: 6620 6272 6f61 6463 6173 743a 0a20 2020  f broadcast:.   
-00036220: 2020 2020 2020 2020 206e 203d 206c 656e           n = len
-00036230: 286e 7468 7265 6164 7329 2069 6620 6272  (nthreads) if br
-00036240: 6f61 6463 6173 7420 6973 2054 7275 6520  oadcast is True 
-00036250: 656c 7365 2062 726f 6164 6361 7374 0a20  else broadcast. 
-00036260: 2020 2020 2020 2020 2020 2061 7761 6974             await
-00036270: 2073 656c 662e 7265 706c 6963 6174 6528   self.replicate(
-00036280: 6b65 7973 3d6b 6579 732c 2077 6f72 6b65  keys=keys, worke
-00036290: 7273 3d77 6f72 6b65 7273 2c20 6e3d 6e29  rs=workers, n=n)
-000362a0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
-000362b0: 6f67 5f65 7665 6e74 280a 2020 2020 2020  og_event(.      
-000362c0: 2020 2020 2020 5b63 6c69 656e 742c 2022        [client, "
-000362d0: 616c 6c22 5d2c 207b 2261 6374 696f 6e22  all"], {"action"
-000362e0: 3a20 2273 6361 7474 6572 222c 2022 636c  : "scatter", "cl
-000362f0: 6965 6e74 223a 2063 6c69 656e 742c 2022  ient": client, "
-00036300: 636f 756e 7422 3a20 6c65 6e28 6461 7461  count": len(data
-00036310: 297d 0a20 2020 2020 2020 2029 0a20 2020  )}.        ).   
-00036320: 2020 2020 2072 6574 7572 6e20 6b65 7973       return keys
-00036330: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00036340: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-00036350: 7365 6c66 2c20 6b65 7973 3a20 436f 6c6c  self, keys: Coll
-00036360: 6563 7469 6f6e 5b4b 6579 5d2c 2073 6572  ection[Key], ser
-00036370: 6961 6c69 7a65 7273 3a20 6c69 7374 5b73  ializers: list[s
-00036380: 7472 5d20 7c20 4e6f 6e65 203d 204e 6f6e  tr] | None = Non
-00036390: 650a 2020 2020 2920 2d3e 2064 6963 745b  e.    ) -> dict[
-000363a0: 4b65 792c 206f 626a 6563 745d 3a0a 2020  Key, object]:.  
-000363b0: 2020 2020 2020 2222 2243 6f6c 6c65 6374        """Collect
-000363c0: 2064 6174 6120 6672 6f6d 2077 6f72 6b65   data from worke
-000363d0: 7273 2074 6f20 7468 6520 7363 6865 6475  rs to the schedu
-000363e0: 6c65 7222 2222 0a20 2020 2020 2020 2064  ler""".        d
-000363f0: 6174 6120 3d20 7b7d 0a20 2020 2020 2020  ata = {}.       
-00036400: 206d 6973 7369 6e67 5f6b 6579 7320 3d20   missing_keys = 
-00036410: 6c69 7374 286b 6579 7329 0a20 2020 2020  list(keys).     
-00036420: 2020 2066 6169 6c65 645f 6b65 7973 3a20     failed_keys: 
-00036430: 6c69 7374 5b4b 6579 5d20 3d20 5b5d 0a20  list[Key] = []. 
-00036440: 2020 2020 2020 206d 6973 7369 6e67 5f77         missing_w
-00036450: 6f72 6b65 7273 3a20 7365 745b 7374 725d  orkers: set[str]
-00036460: 203d 2073 6574 2829 0a0a 2020 2020 2020   = set()..      
-00036470: 2020 7768 696c 6520 6d69 7373 696e 675f    while missing_
-00036480: 6b65 7973 3a0a 2020 2020 2020 2020 2020  keys:.          
-00036490: 2020 7768 6f5f 6861 7320 3d20 7b7d 0a20    who_has = {}. 
-000364a0: 2020 2020 2020 2020 2020 2066 6f72 206b             for k
-000364b0: 6579 2c20 776f 726b 6572 7320 696e 2073  ey, workers in s
-000364c0: 656c 662e 6765 745f 7768 6f5f 6861 7328  elf.get_who_has(
-000364d0: 6d69 7373 696e 675f 6b65 7973 292e 6974  missing_keys).it
-000364e0: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-000364f0: 2020 2020 2020 2076 616c 6964 5f77 6f72         valid_wor
-00036500: 6b65 7273 203d 2073 6574 2877 6f72 6b65  kers = set(worke
-00036510: 7273 2920 2d20 6d69 7373 696e 675f 776f  rs) - missing_wo
-00036520: 726b 6572 730a 2020 2020 2020 2020 2020  rkers.          
-00036530: 2020 2020 2020 6966 2076 616c 6964 5f77        if valid_w
-00036540: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-00036550: 2020 2020 2020 2020 2020 2020 7768 6f5f              who_
-00036560: 6861 735b 6b65 795d 203d 2076 616c 6964  has[key] = valid
-00036570: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
-00036580: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00036590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000365a0: 2020 2066 6169 6c65 645f 6b65 7973 2e61     failed_keys.a
-000365b0: 7070 656e 6428 6b65 7929 0a0a 2020 2020  ppend(key)..    
-000365c0: 2020 2020 2020 2020 280a 2020 2020 2020          (.      
-000365d0: 2020 2020 2020 2020 2020 6e65 775f 6461            new_da
-000365e0: 7461 2c0a 2020 2020 2020 2020 2020 2020  ta,.            
-000365f0: 2020 2020 6d69 7373 696e 675f 6b65 7973      missing_keys
-00036600: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00036610: 2020 6e65 775f 6661 696c 6564 5f6b 6579    new_failed_key
-00036620: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
-00036630: 2020 206e 6577 5f6d 6973 7369 6e67 5f77     new_missing_w
-00036640: 6f72 6b65 7273 2c0a 2020 2020 2020 2020  orkers,.        
-00036650: 2020 2020 2920 3d20 6177 6169 7420 6761      ) = await ga
-00036660: 7468 6572 5f66 726f 6d5f 776f 726b 6572  ther_from_worker
-00036670: 7328 0a20 2020 2020 2020 2020 2020 2020  s(.             
-00036680: 2020 2077 686f 5f68 6173 2c20 7270 633d     who_has, rpc=
-00036690: 7365 6c66 2e72 7063 2c20 7365 7269 616c  self.rpc, serial
-000366a0: 697a 6572 733d 7365 7269 616c 697a 6572  izers=serializer
-000366b0: 730a 2020 2020 2020 2020 2020 2020 290a  s.            ).
-000366c0: 2020 2020 2020 2020 2020 2020 6461 7461              data
-000366d0: 2e75 7064 6174 6528 6e65 775f 6461 7461  .update(new_data
-000366e0: 290a 2020 2020 2020 2020 2020 2020 6661  ).            fa
-000366f0: 696c 6564 5f6b 6579 7320 2b3d 206e 6577  iled_keys += new
-00036700: 5f66 6169 6c65 645f 6b65 7973 0a20 2020  _failed_keys.   
-00036710: 2020 2020 2020 2020 206d 6973 7369 6e67           missing
-00036720: 5f77 6f72 6b65 7273 2e75 7064 6174 6528  _workers.update(
-00036730: 6e65 775f 6d69 7373 696e 675f 776f 726b  new_missing_work
-00036740: 6572 7329 0a0a 2020 2020 2020 2020 7365  ers)..        se
-00036750: 6c66 2e6c 6f67 5f65 7665 6e74 2822 616c  lf.log_event("al
-00036760: 6c22 2c20 7b22 6163 7469 6f6e 223a 2022  l", {"action": "
-00036770: 6761 7468 6572 222c 2022 636f 756e 7422  gather", "count"
-00036780: 3a20 6c65 6e28 6b65 7973 297d 290a 0a20  : len(keys)}).. 
-00036790: 2020 2020 2020 2069 6620 6e6f 7420 6661         if not fa
-000367a0: 696c 6564 5f6b 6579 733a 0a20 2020 2020  iled_keys:.     
-000367b0: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
-000367c0: 7374 6174 7573 223a 2022 4f4b 222c 2022  status": "OK", "
-000367d0: 6461 7461 223a 2064 6174 617d 0a0a 2020  data": data}..  
-000367e0: 2020 2020 2020 6661 696c 6564 5f73 7461        failed_sta
-000367f0: 7465 7320 3d20 7b0a 2020 2020 2020 2020  tes = {.        
-00036800: 2020 2020 6b65 793a 2073 656c 662e 7461      key: self.ta
-00036810: 736b 735b 6b65 795d 2e73 7461 7465 2069  sks[key].state i
-00036820: 6620 6b65 7920 696e 2073 656c 662e 7461  f key in self.ta
-00036830: 736b 7320 656c 7365 2022 666f 7267 6f74  sks else "forgot
-00036840: 7465 6e22 0a20 2020 2020 2020 2020 2020  ten".           
-00036850: 2066 6f72 206b 6579 2069 6e20 6661 696c   for key in fail
-00036860: 6564 5f6b 6579 730a 2020 2020 2020 2020  ed_keys.        
-00036870: 7d0a 2020 2020 2020 2020 6c6f 6767 6572  }.        logger
-00036880: 2e65 7272 6f72 2822 436f 756c 646e 2774  .error("Couldn't
-00036890: 2067 6174 6865 7220 6b65 7973 3a20 2573   gather keys: %s
-000368a0: 222c 2066 6169 6c65 645f 7374 6174 6573  ", failed_states
-000368b0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-000368c0: 207b 2273 7461 7475 7322 3a20 2265 7272   {"status": "err
-000368d0: 6f72 222c 2022 6b65 7973 223a 206c 6973  or", "keys": lis
-000368e0: 7428 6661 696c 6564 5f6b 6579 7329 7d0a  t(failed_keys)}.
-000368f0: 0a20 2020 2040 6c6f 675f 6572 726f 7273  .    @log_errors
-00036900: 0a20 2020 2061 7379 6e63 2064 6566 2072  .    async def r
-00036910: 6573 7461 7274 2873 656c 662c 2063 6c69  estart(self, cli
-00036920: 656e 743d 4e6f 6e65 2c20 7469 6d65 6f75  ent=None, timeou
-00036930: 743d 3330 2c20 7761 6974 5f66 6f72 5f77  t=30, wait_for_w
-00036940: 6f72 6b65 7273 3d54 7275 6529 3a0a 2020  orkers=True):.  
-00036950: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00036960: 2020 5265 7374 6172 7420 616c 6c20 776f    Restart all wo
-00036970: 726b 6572 732e 2052 6573 6574 206c 6f63  rkers. Reset loc
-00036980: 616c 2073 7461 7465 2e20 4f70 7469 6f6e  al state. Option
-00036990: 616c 6c79 2077 6169 7420 666f 7220 776f  ally wait for wo
-000369a0: 726b 6572 7320 746f 2072 6574 7572 6e2e  rkers to return.
-000369b0: 0a0a 2020 2020 2020 2020 576f 726b 6572  ..        Worker
-000369c0: 7320 7769 7468 6f75 7420 6e61 6e6e 6965  s without nannie
-000369d0: 7320 6172 6520 7368 7574 2064 6f77 6e2c  s are shut down,
-000369e0: 2068 6f70 696e 6720 616e 2065 7874 6572   hoping an exter
-000369f0: 6e61 6c20 6465 706c 6f79 6d65 6e74 2073  nal deployment s
-00036a00: 7973 7465 6d0a 2020 2020 2020 2020 7769  ystem.        wi
-00036a10: 6c6c 2072 6573 7461 7274 2074 6865 6d2e  ll restart them.
-00036a20: 2054 6865 7265 666f 7265 2c20 6966 206e   Therefore, if n
-00036a30: 6f74 2075 7369 6e67 206e 616e 6e69 6573  ot using nannies
-00036a40: 2061 6e64 2079 6f75 7220 6465 706c 6f79   and your deploy
-00036a50: 6d65 6e74 2073 7973 7465 6d0a 2020 2020  ment system.    
-00036a60: 2020 2020 646f 6573 206e 6f74 2061 7574      does not aut
-00036a70: 6f6d 6174 6963 616c 6c79 2072 6573 7461  omatically resta
-00036a80: 7274 2077 6f72 6b65 7273 2c20 6060 7265  rt workers, ``re
-00036a90: 7374 6172 7460 6020 7769 6c6c 206a 7573  start`` will jus
-00036aa0: 7420 7368 7574 2064 6f77 6e20 616c 6c0a  t shut down all.
-00036ab0: 2020 2020 2020 2020 776f 726b 6572 732c          workers,
-00036ac0: 2074 6865 6e20 7469 6d65 206f 7574 210a   then time out!.
-00036ad0: 0a20 2020 2020 2020 2041 6674 6572 2060  .        After `
-00036ae0: 6072 6573 7461 7274 6060 2c20 616c 6c20  `restart``, all 
-00036af0: 636f 6e6e 6563 7465 6420 776f 726b 6572  connected worker
-00036b00: 7320 6172 6520 6e65 772c 2072 6567 6172  s are new, regar
-00036b10: 646c 6573 7320 6f66 2077 6865 7468 6572  dless of whether
-00036b20: 2060 6054 696d 656f 7574 4572 726f 7260   ``TimeoutError`
-00036b30: 600a 2020 2020 2020 2020 7761 7320 7261  `.        was ra
-00036b40: 6973 6564 2e20 416e 7920 776f 726b 6572  ised. Any worker
-00036b50: 7320 7468 6174 2066 6169 6c65 6420 746f  s that failed to
-00036b60: 2073 6875 7420 646f 776e 2069 6e20 7469   shut down in ti
-00036b70: 6d65 2061 7265 2072 656d 6f76 6564 2c20  me are removed, 
-00036b80: 616e 640a 2020 2020 2020 2020 6d61 7920  and.        may 
-00036b90: 6f72 206d 6179 206e 6f74 2073 6875 7420  or may not shut 
-00036ba0: 646f 776e 206f 6e20 7468 6569 7220 6f77  down on their ow
-00036bb0: 6e20 696e 2074 6865 2066 7574 7572 652e  n in the future.
-00036bc0: 0a0a 2020 2020 2020 2020 5061 7261 6d65  ..        Parame
-00036bd0: 7465 7273 0a20 2020 2020 2020 202d 2d2d  ters.        ---
-00036be0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
-00036bf0: 7469 6d65 6f75 743a 0a20 2020 2020 2020  timeout:.       
-00036c00: 2020 2020 2048 6f77 206c 6f6e 6720 746f       How long to
-00036c10: 2077 6169 7420 666f 7220 776f 726b 6572   wait for worker
-00036c20: 7320 746f 2073 6875 7420 646f 776e 2061  s to shut down a
-00036c30: 6e64 2063 6f6d 6520 6261 636b 2c20 6966  nd come back, if
-00036c40: 2060 6077 6169 745f 666f 725f 776f 726b   ``wait_for_work
-00036c50: 6572 7360 600a 2020 2020 2020 2020 2020  ers``.          
-00036c60: 2020 6973 2054 7275 652c 206f 7468 6572    is True, other
-00036c70: 7769 7365 206a 7573 7420 686f 7720 6c6f  wise just how lo
-00036c80: 6e67 2074 6f20 7761 6974 2066 6f72 2077  ng to wait for w
-00036c90: 6f72 6b65 7273 2074 6f20 7368 7574 2064  orkers to shut d
-00036ca0: 6f77 6e2e 0a20 2020 2020 2020 2020 2020  own..           
-00036cb0: 2052 6169 7365 7320 6060 6173 796e 6369   Raises ``asynci
-00036cc0: 6f2e 5469 6d65 6f75 7445 7272 6f72 6060  o.TimeoutError``
-00036cd0: 2069 6620 7468 6973 2069 7320 6578 6365   if this is exce
-00036ce0: 6564 6564 2e0a 2020 2020 2020 2020 7761  eded..        wa
-00036cf0: 6974 5f66 6f72 5f77 6f72 6b65 7273 3a0a  it_for_workers:.
-00036d00: 2020 2020 2020 2020 2020 2020 5768 6574              Whet
-00036d10: 6865 7220 746f 2077 6169 7420 666f 7220  her to wait for 
-00036d20: 616c 6c20 776f 726b 6572 7320 746f 2072  all workers to r
-00036d30: 6563 6f6e 6e65 6374 2c20 6f72 206a 7573  econnect, or jus
-00036d40: 7420 666f 7220 7468 656d 2074 6f20 7368  t for them to sh
-00036d50: 7574 2064 6f77 6e0a 2020 2020 2020 2020  ut down.        
-00036d60: 2020 2020 2864 6566 6175 6c74 2054 7275      (default Tru
-00036d70: 6529 2e20 5573 6520 6060 7265 7374 6172  e). Use ``restar
-00036d80: 7428 7761 6974 5f66 6f72 5f77 6f72 6b65  t(wait_for_worke
-00036d90: 7273 3d46 616c 7365 2960 6020 636f 6d62  rs=False)`` comb
-00036da0: 696e 6564 2077 6974 680a 2020 2020 2020  ined with.      
-00036db0: 2020 2020 2020 3a6d 6574 683a 6043 6c69        :meth:`Cli
-00036dc0: 656e 742e 7761 6974 5f66 6f72 5f77 6f72  ent.wait_for_wor
-00036dd0: 6b65 7273 6020 666f 7220 6772 616e 756c  kers` for granul
-00036de0: 6172 2063 6f6e 7472 6f6c 206f 7665 7220  ar control over 
-00036df0: 686f 7720 6d61 6e79 2077 6f72 6b65 7273  how many workers
-00036e00: 2074 6f0a 2020 2020 2020 2020 2020 2020   to.            
-00036e10: 7761 6974 2066 6f72 2e0a 0a20 2020 2020  wait for...     
-00036e20: 2020 2053 6565 2061 6c73 6f0a 2020 2020     See also.    
-00036e30: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
-00036e40: 2020 2020 2043 6c69 656e 742e 7265 7374       Client.rest
-00036e50: 6172 740a 2020 2020 2020 2020 436c 6965  art.        Clie
-00036e60: 6e74 2e72 6573 7461 7274 5f77 6f72 6b65  nt.restart_worke
-00036e70: 7273 0a20 2020 2020 2020 2022 2222 0a20  rs.        """. 
-00036e80: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
-00036e90: 6964 203d 2066 2272 6573 7461 7274 2d7b  id = f"restart-{
-00036ea0: 7469 6d65 2829 7d22 0a0a 2020 2020 2020  time()}"..      
-00036eb0: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
-00036ec0: 6573 7461 7274 696e 6720 776f 726b 6572  estarting worker
-00036ed0: 7320 616e 6420 7265 6c65 6173 696e 6720  s and releasing 
-00036ee0: 616c 6c20 6b65 7973 2e22 290a 2020 2020  all keys.").    
-00036ef0: 2020 2020 666f 7220 6373 2069 6e20 7365      for cs in se
-00036f00: 6c66 2e63 6c69 656e 7473 2e76 616c 7565  lf.clients.value
-00036f10: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00036f20: 2073 656c 662e 636c 6965 6e74 5f72 656c   self.client_rel
-00036f30: 6561 7365 735f 6b65 7973 280a 2020 2020  eases_keys(.    
-00036f40: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-00036f50: 3d5b 7473 2e6b 6579 2066 6f72 2074 7320  =[ts.key for ts 
-00036f60: 696e 2063 732e 7761 6e74 735f 7768 6174  in cs.wants_what
-00036f70: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-00036f80: 2020 2063 6c69 656e 743d 6373 2e63 6c69     client=cs.cli
-00036f90: 656e 745f 6b65 792c 0a20 2020 2020 2020  ent_key,.       
-00036fa0: 2020 2020 2020 2020 2073 7469 6d75 6c75           stimulu
-00036fb0: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
-00036fc0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00036fd0: 0a20 2020 2020 2020 2073 656c 662e 5f63  .        self._c
-00036fe0: 6c65 6172 5f74 6173 6b5f 7374 6174 6528  lear_task_state(
-00036ff0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00037000: 206e 6f74 2073 656c 662e 7461 736b 730a   not self.tasks.
-00037010: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
-00037020: 6f72 7428 7b22 6f70 223a 2022 7265 7374  ort({"op": "rest
-00037030: 6172 7422 7d29 0a0a 2020 2020 2020 2020  art"})..        
-00037040: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
-00037050: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
-00037060: 7661 6c75 6573 2829 293a 0a20 2020 2020  values()):.     
-00037070: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00037080: 2020 2020 2020 2020 2020 2020 706c 7567              plug
-00037090: 696e 2e72 6573 7461 7274 2873 656c 6629  in.restart(self)
-000370a0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-000370b0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
-000370c0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
-000370d0: 2020 2020 6c6f 6767 6572 2e65 7863 6570      logger.excep
-000370e0: 7469 6f6e 2865 290a 0a20 2020 2020 2020  tion(e)..       
-000370f0: 206e 5f77 6f72 6b65 7273 203d 206c 656e   n_workers = len
-00037100: 2873 656c 662e 776f 726b 6572 7329 0a20  (self.workers). 
-00037110: 2020 2020 2020 206e 616e 6e79 5f77 6f72         nanny_wor
-00037120: 6b65 7273 203d 207b 0a20 2020 2020 2020  kers = {.       
-00037130: 2020 2020 2061 6464 723a 2077 732e 6e61       addr: ws.na
-00037140: 6e6e 7920 666f 7220 6164 6472 2c20 7773  nny for addr, ws
-00037150: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-00037160: 2e69 7465 6d73 2829 2069 6620 7773 2e6e  .items() if ws.n
-00037170: 616e 6e79 0a20 2020 2020 2020 207d 0a20  anny.        }. 
-00037180: 2020 2020 2020 2023 2043 6c6f 7365 206e         # Close n
-00037190: 6f6e 2d4e 616e 6e79 2077 6f72 6b65 7273  on-Nanny workers
-000371a0: 2e20 5765 2068 6176 6520 6e6f 2077 6179  . We have no way
-000371b0: 2074 6f20 7265 7374 6172 7420 7468 656d   to restart them
-000371c0: 2c20 736f 2077 6520 6a75 7374 206c 6574  , so we just let
-000371d0: 2074 6865 6d20 676f 2c0a 2020 2020 2020   them go,.      
-000371e0: 2020 2320 616e 6420 6173 7375 6d65 2061    # and assume a
-000371f0: 2064 6570 6c6f 796d 656e 7420 7379 7374   deployment syst
-00037200: 656d 2069 7320 676f 696e 6720 746f 2072  em is going to r
-00037210: 6573 7461 7274 2074 6865 6d20 666f 7220  estart them for 
-00037220: 7573 2e0a 2020 2020 2020 2020 6177 6169  us..        awai
-00037230: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-00037240: 280a 2020 2020 2020 2020 2020 2020 2a28  (.            *(
-00037250: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037260: 2073 656c 662e 7265 6d6f 7665 5f77 6f72   self.remove_wor
-00037270: 6b65 7228 6164 6472 6573 733d 6164 6472  ker(address=addr
-00037280: 2c20 7374 696d 756c 7573 5f69 643d 7374  , stimulus_id=st
-00037290: 696d 756c 7573 5f69 6429 0a20 2020 2020  imulus_id).     
-000372a0: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
-000372b0: 6464 7220 696e 2073 656c 662e 776f 726b  ddr in self.work
-000372c0: 6572 730a 2020 2020 2020 2020 2020 2020  ers.            
-000372d0: 2020 2020 6966 2061 6464 7220 6e6f 7420      if addr not 
-000372e0: 696e 206e 616e 6e79 5f77 6f72 6b65 7273  in nanny_workers
-000372f0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00037300: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00037310: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-00037320: 5365 6e64 206b 696c 6c20 7369 676e 616c  Send kill signal
-00037330: 2074 6f20 6e61 6e6e 6965 733a 2025 7322   to nannies: %s"
-00037340: 2c20 6e61 6e6e 795f 776f 726b 6572 7329  , nanny_workers)
-00037350: 0a20 2020 2020 2020 2061 7379 6e63 2077  .        async w
-00037360: 6974 6820 636f 6e74 6578 746c 6962 2e41  ith contextlib.A
-00037370: 7379 6e63 4578 6974 5374 6163 6b28 2920  syncExitStack() 
-00037380: 6173 2073 7461 636b 3a0a 2020 2020 2020  as stack:.      
-00037390: 2020 2020 2020 6e61 6e6e 6965 7320 3d20        nannies = 
-000373a0: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-000373b0: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
-000373c0: 2020 2020 2020 2a28 0a20 2020 2020 2020        *(.       
-000373d0: 2020 2020 2020 2020 2020 2020 2073 7461               sta
-000373e0: 636b 2e65 6e74 6572 5f61 7379 6e63 5f63  ck.enter_async_c
-000373f0: 6f6e 7465 7874 280a 2020 2020 2020 2020  ontext(.        
-00037400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037410: 7270 6328 6e61 6e6e 795f 6164 6472 6573  rpc(nanny_addres
-00037420: 732c 2063 6f6e 6e65 6374 696f 6e5f 6172  s, connection_ar
-00037430: 6773 3d73 656c 662e 636f 6e6e 6563 7469  gs=self.connecti
-00037440: 6f6e 5f61 7267 7329 0a20 2020 2020 2020  on_args).       
-00037450: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00037460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037470: 2020 2066 6f72 206e 616e 6e79 5f61 6464     for nanny_add
-00037480: 7265 7373 2069 6e20 6e61 6e6e 795f 776f  ress in nanny_wo
-00037490: 726b 6572 732e 7661 6c75 6573 2829 0a20  rkers.values(). 
-000374a0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000374b0: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-000374c0: 2020 2020 2020 2020 2020 2020 7374 6172              star
-000374d0: 7420 3d20 6d6f 6e6f 746f 6e69 6328 290a  t = monotonic().
-000374e0: 2020 2020 2020 2020 2020 2020 7265 7370              resp
-000374f0: 7320 3d20 6177 6169 7420 6173 796e 6369  s = await asynci
-00037500: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
-00037510: 2020 2020 2020 2020 2020 2a28 0a20 2020            *(.   
-00037520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037530: 2077 6169 745f 666f 7228 0a20 2020 2020   wait_for(.     
-00037540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037550: 2020 2023 2046 4958 4d45 2064 6f65 7320     # FIXME does 
-00037560: 6e6f 7420 7261 6973 6520 6966 2074 6865  not raise if the
-00037570: 2070 726f 6365 7373 2066 6169 6c73 2074   process fails t
-00037580: 6f20 7368 7574 2064 6f77 6e2c 0a20 2020  o shut down,.   
-00037590: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000375a0: 2020 2020 2023 2073 6565 2068 7474 7073       # see https
-000375b0: 3a2f 2f67 6974 6875 622e 636f 6d2f 6461  ://github.com/da
-000375c0: 736b 2f64 6973 7472 6962 7574 6564 2f70  sk/distributed/p
-000375d0: 756c 6c2f 3634 3237 2f66 696c 6573 2372  ull/6427/files#r
-000375e0: 3839 3439 3137 3432 340a 2020 2020 2020  894917424.      
-000375f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037600: 2020 2320 4e4f 5445 3a20 4e61 6e6e 7920    # NOTE: Nanny 
-00037610: 7769 6c6c 2061 7574 6f6d 6174 6963 616c  will automatical
-00037620: 6c79 2072 6573 7461 7274 2077 6f72 6b65  ly restart worke
-00037630: 7220 7072 6f63 6573 7320 7768 656e 2069  r process when i
-00037640: 7427 7320 6b69 6c6c 6564 0a20 2020 2020  t's killed.     
-00037650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037660: 2020 206e 616e 6e79 2e6b 696c 6c28 0a20     nanny.kill(. 
-00037670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037680: 2020 2020 2020 2020 2020 2072 6561 736f             reaso
-00037690: 6e3d 2273 6368 6564 756c 6572 2d72 6573  n="scheduler-res
-000376a0: 7461 7274 222c 0a20 2020 2020 2020 2020  tart",.         
-000376b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000376c0: 2020 2074 696d 656f 7574 3d74 696d 656f     timeout=timeo
-000376d0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
-000376e0: 2020 2020 2020 2020 2020 2020 292c 0a20              ),. 
-000376f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037700: 2020 2020 2020 2074 696d 656f 7574 2c0a         timeout,.
-00037710: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037720: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00037730: 2020 2020 2020 2020 2020 666f 7220 6e61            for na
-00037740: 6e6e 7920 696e 206e 616e 6e69 6573 0a20  nny in nannies. 
-00037750: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00037760: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00037770: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
-00037780: 6f6e 733d 5472 7565 2c0a 2020 2020 2020  ons=True,.      
-00037790: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000377a0: 2020 2020 2320 4e4f 5445 3a20 7468 6520      # NOTE: the 
-000377b0: 6057 6f72 6b65 7253 7461 7465 6020 656e  `WorkerState` en
-000377c0: 7472 6965 7320 666f 7220 7468 6573 6520  tries for these 
-000377d0: 776f 726b 6572 7320 7769 6c6c 2062 6520  workers will be 
-000377e0: 7265 6d6f 7665 640a 2020 2020 2020 2020  removed.        
-000377f0: 2020 2020 2320 6e61 7475 7261 6c6c 7920      # naturally 
-00037800: 7768 656e 2074 6865 7920 6469 7363 6f6e  when they discon
-00037810: 6e65 6374 2066 726f 6d20 7468 6520 7363  nect from the sc
-00037820: 6865 6475 6c65 722e 0a0a 2020 2020 2020  heduler...      
-00037830: 2020 2020 2020 2320 5265 6d6f 7665 2061        # Remove a
-00037840: 6e79 2077 6f72 6b65 7273 2074 6861 7420  ny workers that 
-00037850: 6661 696c 6564 2074 6f20 7368 7574 2064  failed to shut d
-00037860: 6f77 6e2c 2073 6f20 7765 2063 616e 2067  own, so we can g
-00037870: 7561 7261 6e74 6565 0a20 2020 2020 2020  uarantee.       
-00037880: 2020 2020 2023 2074 6861 7420 6166 7465       # that afte
-00037890: 7220 6072 6573 7461 7274 602c 2074 6865  r `restart`, the
-000378a0: 7265 2061 7265 206e 6f20 6f6c 6420 776f  re are no old wo
-000378b0: 726b 6572 7320 6172 6f75 6e64 2e0a 2020  rkers around..  
-000378c0: 2020 2020 2020 2020 2020 6261 645f 6e61            bad_na
-000378d0: 6e6e 6965 7320 3d20 5b0a 2020 2020 2020  nnies = [.      
-000378e0: 2020 2020 2020 2020 2020 6164 6472 2066            addr f
-000378f0: 6f72 2061 6464 722c 2072 6573 7020 696e  or addr, resp in
-00037900: 207a 6970 286e 616e 6e79 5f77 6f72 6b65   zip(nanny_worke
-00037910: 7273 2c20 7265 7370 7329 2069 6620 7265  rs, resps) if re
-00037920: 7370 2069 7320 6e6f 7420 4e6f 6e65 0a20  sp is not None. 
-00037930: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-00037940: 2020 2020 2020 2020 2069 6620 6261 645f           if bad_
-00037950: 6e61 6e6e 6965 733a 0a20 2020 2020 2020  nannies:.       
-00037960: 2020 2020 2020 2020 2061 7761 6974 2061           await a
-00037970: 7379 6e63 696f 2e67 6174 6865 7228 0a20  syncio.gather(. 
-00037980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037990: 2020 202a 280a 2020 2020 2020 2020 2020     *(.          
-000379a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000379b0: 6c66 2e72 656d 6f76 655f 776f 726b 6572  lf.remove_worker
-000379c0: 2861 6464 722c 2073 7469 6d75 6c75 735f  (addr, stimulus_
-000379d0: 6964 3d73 7469 6d75 6c75 735f 6964 290a  id=stimulus_id).
-000379e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000379f0: 2020 2020 2020 2020 666f 7220 6164 6472          for addr
-00037a00: 2069 6e20 6261 645f 6e61 6e6e 6965 730a   in bad_nannies.
-00037a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037a20: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00037a30: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-00037a40: 2020 2020 2020 2020 2072 6169 7365 2054           raise T
-00037a50: 696d 656f 7574 4572 726f 7228 0a20 2020  imeoutError(.   
-00037a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037a70: 2066 227b 6c65 6e28 6261 645f 6e61 6e6e   f"{len(bad_nann
-00037a80: 6965 7329 7d2f 7b6c 656e 286e 616e 6e69  ies)}/{len(nanni
-00037a90: 6573 297d 206e 616e 6e79 2077 6f72 6b65  es)} nanny worke
-00037aa0: 7228 7329 2064 6964 206e 6f74 2073 6875  r(s) did not shu
-00037ab0: 7420 646f 776e 2077 6974 6869 6e20 7b74  t down within {t
-00037ac0: 696d 656f 7574 7d73 220a 2020 2020 2020  imeout}s".      
-00037ad0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00037ae0: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
-00037af0: 656e 7428 5b63 6c69 656e 742c 2022 616c  ent([client, "al
-00037b00: 6c22 5d2c 207b 2261 6374 696f 6e22 3a20  l"], {"action": 
-00037b10: 2272 6573 7461 7274 222c 2022 636c 6965  "restart", "clie
-00037b20: 6e74 223a 2063 6c69 656e 747d 290a 0a20  nt": client}).. 
-00037b30: 2020 2020 2020 2069 6620 7761 6974 5f66         if wait_f
-00037b40: 6f72 5f77 6f72 6b65 7273 3a0a 2020 2020  or_workers:.    
-00037b50: 2020 2020 2020 2020 7768 696c 6520 6c65          while le
-00037b60: 6e28 7365 6c66 2e77 6f72 6b65 7273 2920  n(self.workers) 
-00037b70: 3c20 6e5f 776f 726b 6572 733a 0a20 2020  < n_workers:.   
-00037b80: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-00037b90: 4f54 453a 2069 6620 6e65 7720 2875 6e72  OTE: if new (unr
-00037ba0: 656c 6174 6564 2920 776f 726b 6572 7320  elated) workers 
-00037bb0: 6a6f 696e 2077 6869 6c65 2077 6527 7265  join while we're
-00037bc0: 2077 6169 7469 6e67 2c20 7765 206d 6179   waiting, we may
-00037bd0: 2072 6574 7572 6e20 6265 666f 7265 0a20   return before. 
-00037be0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00037bf0: 206f 7572 2073 6875 742d 646f 776e 2077   our shut-down w
-00037c00: 6f72 6b65 7273 2068 6176 6520 636f 6d65  orkers have come
-00037c10: 2062 6163 6b20 7570 2e20 5468 6174 2773   back up. That's
-00037c20: 2066 696e 653b 2077 6f72 6b65 7273 2061   fine; workers a
-00037c30: 7265 2069 6e74 6572 6368 616e 6765 6162  re interchangeab
-00037c40: 6c65 2e0a 2020 2020 2020 2020 2020 2020  le..            
-00037c50: 2020 2020 6966 206d 6f6e 6f74 6f6e 6963      if monotonic
-00037c60: 2829 203c 2073 7461 7274 202b 2074 696d  () < start + tim
-00037c70: 656f 7574 3a0a 2020 2020 2020 2020 2020  eout:.          
-00037c80: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-00037c90: 6173 796e 6369 6f2e 736c 6565 7028 302e  asyncio.sleep(0.
-00037ca0: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-00037cb0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00037cc0: 2020 2020 2020 2020 2020 2020 206d 7367               msg
-00037cd0: 203d 2028 0a20 2020 2020 2020 2020 2020   = (.           
-00037ce0: 2020 2020 2020 2020 2020 2020 2066 2257               f"W
-00037cf0: 6169 7465 6420 666f 7220 7b6e 5f77 6f72  aited for {n_wor
-00037d00: 6b65 7273 7d20 776f 726b 6572 2873 2920  kers} worker(s) 
-00037d10: 746f 2072 6563 6f6e 6e65 6374 2061 6674  to reconnect aft
-00037d20: 6572 2072 6573 7461 7274 696e 672c 2022  er restarting, "
+00035de0: 2323 0a20 2020 2023 204c 6573 7320 636f  ##.    # Less co
+00035df0: 6d6d 6f6e 2069 6e74 6572 6163 7469 6f6e  mmon interaction
+00035e00: 7320 230a 2020 2020 2323 2323 2323 2323  s #.    ########
+00035e10: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00035e20: 2323 2323 0a0a 2020 2020 6173 796e 6320  ####..    async 
+00035e30: 6465 6620 7363 6174 7465 7228 0a20 2020  def scatter(.   
+00035e40: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00035e50: 2020 2063 6f6d 6d3d 4e6f 6e65 2c0a 2020     comm=None,.  
+00035e60: 2020 2020 2020 6461 7461 3d4e 6f6e 652c        data=None,
+00035e70: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
+00035e80: 3d4e 6f6e 652c 0a20 2020 2020 2020 2063  =None,.        c
+00035e90: 6c69 656e 743d 4e6f 6e65 2c0a 2020 2020  lient=None,.    
+00035ea0: 2020 2020 6272 6f61 6463 6173 743d 4661      broadcast=Fa
+00035eb0: 6c73 652c 0a20 2020 2020 2020 2074 696d  lse,.        tim
+00035ec0: 656f 7574 3d32 2c0a 2020 2020 293a 0a20  eout=2,.    ):. 
+00035ed0: 2020 2020 2020 2022 2222 5365 6e64 2064         """Send d
+00035ee0: 6174 6120 6f75 7420 746f 2077 6f72 6b65  ata out to worke
+00035ef0: 7273 0a0a 2020 2020 2020 2020 5365 6520  rs..        See 
+00035f00: 616c 736f 0a20 2020 2020 2020 202d 2d2d  also.        ---
+00035f10: 2d2d 2d2d 2d0a 2020 2020 2020 2020 5363  -----.        Sc
+00035f20: 6865 6475 6c65 722e 6272 6f61 6463 6173  heduler.broadcas
+00035f30: 743a 0a20 2020 2020 2020 2022 2222 0a20  t:.        """. 
+00035f40: 2020 2020 2020 2073 7461 7274 203d 2074         start = t
+00035f50: 696d 6528 290a 2020 2020 2020 2020 7768  ime().        wh
+00035f60: 696c 6520 5472 7565 3a0a 2020 2020 2020  ile True:.      
+00035f70: 2020 2020 2020 6966 2077 6f72 6b65 7273        if workers
+00035f80: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+00035f90: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
+00035fa0: 7365 6c66 2e72 756e 6e69 6e67 0a20 2020  self.running.   
+00035fb0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00035fc0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00035fd0: 6f72 6b65 7273 203d 205b 7365 6c66 2e63  orkers = [self.c
+00035fe0: 6f65 7263 655f 6164 6472 6573 7328 7729  oerce_address(w)
+00035ff0: 2066 6f72 2077 2069 6e20 776f 726b 6572   for w in worker
+00036000: 735d 0a20 2020 2020 2020 2020 2020 2020  s].             
+00036010: 2020 2077 7373 203d 207b 7365 6c66 2e77     wss = {self.w
+00036020: 6f72 6b65 7273 5b77 5d20 666f 7220 7720  orkers[w] for w 
+00036030: 696e 2077 6f72 6b65 7273 7d0a 2020 2020  in workers}.    
+00036040: 2020 2020 2020 2020 2020 2020 7773 7320              wss 
+00036050: 3d20 7b77 7320 666f 7220 7773 2069 6e20  = {ws for ws in 
+00036060: 7773 7320 6966 2077 732e 7374 6174 7573  wss if ws.status
+00036070: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+00036080: 6e67 7d0a 0a20 2020 2020 2020 2020 2020  ng}..           
+00036090: 2069 6620 7773 733a 0a20 2020 2020 2020   if wss:.       
+000360a0: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+000360b0: 2020 2020 2020 2020 2020 2069 6620 7469             if ti
+000360c0: 6d65 2829 203e 2073 7461 7274 202b 2074  me() > start + t
+000360d0: 696d 656f 7574 3a0a 2020 2020 2020 2020  imeout:.        
+000360e0: 2020 2020 2020 2020 7261 6973 6520 5469          raise Ti
+000360f0: 6d65 6f75 7445 7272 6f72 2822 4e6f 2076  meoutError("No v
+00036100: 616c 6964 2077 6f72 6b65 7273 2066 6f75  alid workers fou
+00036110: 6e64 2229 0a20 2020 2020 2020 2020 2020  nd").           
+00036120: 2061 7761 6974 2061 7379 6e63 696f 2e73   await asyncio.s
+00036130: 6c65 6570 2830 2e31 290a 0a20 2020 2020  leep(0.1)..     
+00036140: 2020 206e 7468 7265 6164 7320 3d20 7b77     nthreads = {w
+00036150: 732e 6164 6472 6573 733a 2077 732e 6e74  s.address: ws.nt
+00036160: 6872 6561 6473 2066 6f72 2077 7320 696e  hreads for ws in
+00036170: 2077 7373 7d0a 0a20 2020 2020 2020 2061   wss}..        a
+00036180: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00036190: 2864 6174 612c 2064 6963 7429 0a0a 2020  (data, dict)..  
+000361a0: 2020 2020 2020 6b65 7973 2c20 7768 6f5f        keys, who_
+000361b0: 6861 732c 206e 6279 7465 7320 3d20 6177  has, nbytes = aw
+000361c0: 6169 7420 7363 6174 7465 725f 746f 5f77  ait scatter_to_w
+000361d0: 6f72 6b65 7273 286e 7468 7265 6164 732c  orkers(nthreads,
+000361e0: 2064 6174 612c 2072 7063 3d73 656c 662e   data, rpc=self.
+000361f0: 7270 6329 0a0a 2020 2020 2020 2020 7365  rpc)..        se
+00036200: 6c66 2e75 7064 6174 655f 6461 7461 2877  lf.update_data(w
+00036210: 686f 5f68 6173 3d77 686f 5f68 6173 2c20  ho_has=who_has, 
+00036220: 6e62 7974 6573 3d6e 6279 7465 732c 2063  nbytes=nbytes, c
+00036230: 6c69 656e 743d 636c 6965 6e74 290a 0a20  lient=client).. 
+00036240: 2020 2020 2020 2069 6620 6272 6f61 6463         if broadc
+00036250: 6173 743a 0a20 2020 2020 2020 2020 2020  ast:.           
+00036260: 206e 203d 206c 656e 286e 7468 7265 6164   n = len(nthread
+00036270: 7329 2069 6620 6272 6f61 6463 6173 7420  s) if broadcast 
+00036280: 6973 2054 7275 6520 656c 7365 2062 726f  is True else bro
+00036290: 6164 6361 7374 0a20 2020 2020 2020 2020  adcast.         
+000362a0: 2020 2061 7761 6974 2073 656c 662e 7265     await self.re
+000362b0: 706c 6963 6174 6528 6b65 7973 3d6b 6579  plicate(keys=key
+000362c0: 732c 2077 6f72 6b65 7273 3d77 6f72 6b65  s, workers=worke
+000362d0: 7273 2c20 6e3d 6e29 0a0a 2020 2020 2020  rs, n=n)..      
+000362e0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
+000362f0: 280a 2020 2020 2020 2020 2020 2020 5b63  (.            [c
+00036300: 6c69 656e 742c 2022 616c 6c22 5d2c 207b  lient, "all"], {
+00036310: 2261 6374 696f 6e22 3a20 2273 6361 7474  "action": "scatt
+00036320: 6572 222c 2022 636c 6965 6e74 223a 2063  er", "client": c
+00036330: 6c69 656e 742c 2022 636f 756e 7422 3a20  lient, "count": 
+00036340: 6c65 6e28 6461 7461 297d 0a20 2020 2020  len(data)}.     
+00036350: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+00036360: 7572 6e20 6b65 7973 0a0a 2020 2020 6173  urn keys..    as
+00036370: 796e 6320 6465 6620 6761 7468 6572 280a  ync def gather(.
+00036380: 2020 2020 2020 2020 7365 6c66 2c20 6b65          self, ke
+00036390: 7973 3a20 436f 6c6c 6563 7469 6f6e 5b4b  ys: Collection[K
+000363a0: 6579 5d2c 2073 6572 6961 6c69 7a65 7273  ey], serializers
+000363b0: 3a20 6c69 7374 5b73 7472 5d20 7c20 4e6f  : list[str] | No
+000363c0: 6e65 203d 204e 6f6e 650a 2020 2020 2920  ne = None.    ) 
+000363d0: 2d3e 2064 6963 745b 4b65 792c 206f 626a  -> dict[Key, obj
+000363e0: 6563 745d 3a0a 2020 2020 2020 2020 2222  ect]:.        ""
+000363f0: 2243 6f6c 6c65 6374 2064 6174 6120 6672  "Collect data fr
+00036400: 6f6d 2077 6f72 6b65 7273 2074 6f20 7468  om workers to th
+00036410: 6520 7363 6865 6475 6c65 7222 2222 0a20  e scheduler""". 
+00036420: 2020 2020 2020 2064 6174 6120 3d20 7b7d         data = {}
+00036430: 0a20 2020 2020 2020 206d 6973 7369 6e67  .        missing
+00036440: 5f6b 6579 7320 3d20 6c69 7374 286b 6579  _keys = list(key
+00036450: 7329 0a20 2020 2020 2020 2066 6169 6c65  s).        faile
+00036460: 645f 6b65 7973 3a20 6c69 7374 5b4b 6579  d_keys: list[Key
+00036470: 5d20 3d20 5b5d 0a20 2020 2020 2020 206d  ] = [].        m
+00036480: 6973 7369 6e67 5f77 6f72 6b65 7273 3a20  issing_workers: 
+00036490: 7365 745b 7374 725d 203d 2073 6574 2829  set[str] = set()
+000364a0: 0a0a 2020 2020 2020 2020 7768 696c 6520  ..        while 
+000364b0: 6d69 7373 696e 675f 6b65 7973 3a0a 2020  missing_keys:.  
+000364c0: 2020 2020 2020 2020 2020 7768 6f5f 6861            who_ha
+000364d0: 7320 3d20 7b7d 0a20 2020 2020 2020 2020  s = {}.         
+000364e0: 2020 2066 6f72 206b 6579 2c20 776f 726b     for key, work
+000364f0: 6572 7320 696e 2073 656c 662e 6765 745f  ers in self.get_
+00036500: 7768 6f5f 6861 7328 6d69 7373 696e 675f  who_has(missing_
+00036510: 6b65 7973 292e 6974 656d 7328 293a 0a20  keys).items():. 
+00036520: 2020 2020 2020 2020 2020 2020 2020 2076                 v
+00036530: 616c 6964 5f77 6f72 6b65 7273 203d 2073  alid_workers = s
+00036540: 6574 2877 6f72 6b65 7273 2920 2d20 6d69  et(workers) - mi
+00036550: 7373 696e 675f 776f 726b 6572 730a 2020  ssing_workers.  
+00036560: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00036570: 2076 616c 6964 5f77 6f72 6b65 7273 3a0a   valid_workers:.
+00036580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00036590: 2020 2020 7768 6f5f 6861 735b 6b65 795d      who_has[key]
+000365a0: 203d 2076 616c 6964 5f77 6f72 6b65 7273   = valid_workers
+000365b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000365c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000365d0: 2020 2020 2020 2020 2020 2066 6169 6c65             faile
+000365e0: 645f 6b65 7973 2e61 7070 656e 6428 6b65  d_keys.append(ke
+000365f0: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
+00036600: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00036610: 2020 6e65 775f 6461 7461 2c0a 2020 2020    new_data,.    
+00036620: 2020 2020 2020 2020 2020 2020 6d69 7373              miss
+00036630: 696e 675f 6b65 7973 2c0a 2020 2020 2020  ing_keys,.      
+00036640: 2020 2020 2020 2020 2020 6e65 775f 6661            new_fa
+00036650: 696c 6564 5f6b 6579 732c 0a20 2020 2020  iled_keys,.     
+00036660: 2020 2020 2020 2020 2020 206e 6577 5f6d             new_m
+00036670: 6973 7369 6e67 5f77 6f72 6b65 7273 2c0a  issing_workers,.
+00036680: 2020 2020 2020 2020 2020 2020 2920 3d20              ) = 
+00036690: 6177 6169 7420 6761 7468 6572 5f66 726f  await gather_fro
+000366a0: 6d5f 776f 726b 6572 7328 0a20 2020 2020  m_workers(.     
+000366b0: 2020 2020 2020 2020 2020 2077 686f 5f68             who_h
+000366c0: 6173 2c20 7270 633d 7365 6c66 2e72 7063  as, rpc=self.rpc
+000366d0: 2c20 7365 7269 616c 697a 6572 733d 7365  , serializers=se
+000366e0: 7269 616c 697a 6572 730a 2020 2020 2020  rializers.      
+000366f0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00036700: 2020 2020 6461 7461 2e75 7064 6174 6528      data.update(
+00036710: 6e65 775f 6461 7461 290a 2020 2020 2020  new_data).      
+00036720: 2020 2020 2020 6661 696c 6564 5f6b 6579        failed_key
+00036730: 7320 2b3d 206e 6577 5f66 6169 6c65 645f  s += new_failed_
+00036740: 6b65 7973 0a20 2020 2020 2020 2020 2020  keys.           
+00036750: 206d 6973 7369 6e67 5f77 6f72 6b65 7273   missing_workers
+00036760: 2e75 7064 6174 6528 6e65 775f 6d69 7373  .update(new_miss
+00036770: 696e 675f 776f 726b 6572 7329 0a0a 2020  ing_workers)..  
+00036780: 2020 2020 2020 7365 6c66 2e6c 6f67 5f65        self.log_e
+00036790: 7665 6e74 2822 616c 6c22 2c20 7b22 6163  vent("all", {"ac
+000367a0: 7469 6f6e 223a 2022 6761 7468 6572 222c  tion": "gather",
+000367b0: 2022 636f 756e 7422 3a20 6c65 6e28 6b65   "count": len(ke
+000367c0: 7973 297d 290a 0a20 2020 2020 2020 2069  ys)})..        i
+000367d0: 6620 6e6f 7420 6661 696c 6564 5f6b 6579  f not failed_key
+000367e0: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+000367f0: 6574 7572 6e20 7b22 7374 6174 7573 223a  eturn {"status":
+00036800: 2022 4f4b 222c 2022 6461 7461 223a 2064   "OK", "data": d
+00036810: 6174 617d 0a0a 2020 2020 2020 2020 6661  ata}..        fa
+00036820: 696c 6564 5f73 7461 7465 7320 3d20 7b0a  iled_states = {.
+00036830: 2020 2020 2020 2020 2020 2020 6b65 793a              key:
+00036840: 2073 656c 662e 7461 736b 735b 6b65 795d   self.tasks[key]
+00036850: 2e73 7461 7465 2069 6620 6b65 7920 696e  .state if key in
+00036860: 2073 656c 662e 7461 736b 7320 656c 7365   self.tasks else
+00036870: 2022 666f 7267 6f74 7465 6e22 0a20 2020   "forgotten".   
+00036880: 2020 2020 2020 2020 2066 6f72 206b 6579           for key
+00036890: 2069 6e20 6661 696c 6564 5f6b 6579 730a   in failed_keys.
+000368a0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
+000368b0: 2020 6c6f 6767 6572 2e65 7272 6f72 2822    logger.error("
+000368c0: 436f 756c 646e 2774 2067 6174 6865 7220  Couldn't gather 
+000368d0: 6b65 7973 3a20 2573 222c 2066 6169 6c65  keys: %s", faile
+000368e0: 645f 7374 6174 6573 290a 2020 2020 2020  d_states).      
+000368f0: 2020 7265 7475 726e 207b 2273 7461 7475    return {"statu
+00036900: 7322 3a20 2265 7272 6f72 222c 2022 6b65  s": "error", "ke
+00036910: 7973 223a 206c 6973 7428 6661 696c 6564  ys": list(failed
+00036920: 5f6b 6579 7329 7d0a 0a20 2020 2040 6c6f  _keys)}..    @lo
+00036930: 675f 6572 726f 7273 0a20 2020 2061 7379  g_errors.    asy
+00036940: 6e63 2064 6566 2072 6573 7461 7274 280a  nc def restart(.
+00036950: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00036960: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
+00036970: 2063 6c69 656e 743a 2073 7472 207c 204e   client: str | N
+00036980: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+00036990: 2020 2020 7469 6d65 6f75 743a 2066 6c6f      timeout: flo
+000369a0: 6174 203d 2033 302c 0a20 2020 2020 2020  at = 30,.       
+000369b0: 2077 6169 745f 666f 725f 776f 726b 6572   wait_for_worker
+000369c0: 733a 2062 6f6f 6c20 3d20 5472 7565 2c0a  s: bool = True,.
+000369d0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
+000369e0: 5f69 643a 2073 7472 2c0a 2020 2020 2920  _id: str,.    ) 
+000369f0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+00036a00: 2022 2222 466f 7267 6574 2061 6c6c 2074   """Forget all t
+00036a10: 6173 6b73 2061 6e64 2063 616c 6c20 7265  asks and call re
+00036a20: 7374 6172 745f 776f 726b 6572 7320 6f6e  start_workers on
+00036a30: 2061 6c6c 2077 6f72 6b65 7273 2e0a 0a20   all workers... 
+00036a40: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
+00036a50: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+00036a60: 2d2d 2d2d 0a20 2020 2020 2020 2074 696d  ----.        tim
+00036a70: 656f 7574 3a0a 2020 2020 2020 2020 2020  eout:.          
+00036a80: 2020 5365 6520 7265 7374 6172 745f 776f    See restart_wo
+00036a90: 726b 6572 730a 2020 2020 2020 2020 7761  rkers.        wa
+00036aa0: 6974 5f66 6f72 5f77 6f72 6b65 7273 3a0a  it_for_workers:.
+00036ab0: 2020 2020 2020 2020 2020 2020 5365 6520              See 
+00036ac0: 7265 7374 6172 745f 776f 726b 6572 730a  restart_workers.
+00036ad0: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
+00036ae0: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
+00036af0: 2d2d 0a20 2020 2020 2020 2043 6c69 656e  --.        Clien
+00036b00: 742e 7265 7374 6172 740a 2020 2020 2020  t.restart.      
+00036b10: 2020 436c 6965 6e74 2e72 6573 7461 7274    Client.restart
+00036b20: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+00036b30: 2053 6368 6564 756c 6572 2e72 6573 7461   Scheduler.resta
+00036b40: 7274 5f77 6f72 6b65 7273 0a20 2020 2020  rt_workers.     
+00036b50: 2020 2022 2222 0a20 2020 2020 2020 206c     """.        l
+00036b60: 6f67 6765 722e 696e 666f 2866 2252 6573  ogger.info(f"Res
+00036b70: 7461 7274 696e 6720 776f 726b 6572 7320  tarting workers 
+00036b80: 616e 6420 7265 6c65 6173 696e 6720 616c  and releasing al
+00036b90: 6c20 6b65 7973 2028 7b73 7469 6d75 6c75  l keys ({stimulu
+00036ba0: 735f 6964 3d7d 2922 290a 2020 2020 2020  s_id=})").      
+00036bb0: 2020 666f 7220 6373 2069 6e20 7365 6c66    for cs in self
+00036bc0: 2e63 6c69 656e 7473 2e76 616c 7565 7328  .clients.values(
+00036bd0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00036be0: 656c 662e 636c 6965 6e74 5f72 656c 6561  elf.client_relea
+00036bf0: 7365 735f 6b65 7973 280a 2020 2020 2020  ses_keys(.      
+00036c00: 2020 2020 2020 2020 2020 6b65 7973 3d5b            keys=[
+00036c10: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
+00036c20: 2063 732e 7761 6e74 735f 7768 6174 5d2c   cs.wants_what],
+00036c30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00036c40: 2063 6c69 656e 743d 6373 2e63 6c69 656e   client=cs.clien
+00036c50: 745f 6b65 792c 0a20 2020 2020 2020 2020  t_key,.         
+00036c60: 2020 2020 2020 2073 7469 6d75 6c75 735f         stimulus_
+00036c70: 6964 3d73 7469 6d75 6c75 735f 6964 2c0a  id=stimulus_id,.
+00036c80: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+00036c90: 2020 2020 2020 2073 656c 662e 5f63 6c65         self._cle
+00036ca0: 6172 5f74 6173 6b5f 7374 6174 6528 290a  ar_task_state().
+00036cb0: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
+00036cc0: 6f74 2073 656c 662e 7461 736b 730a 2020  ot self.tasks.  
+00036cd0: 2020 2020 2020 7365 6c66 2e72 6570 6f72        self.repor
+00036ce0: 7428 7b22 6f70 223a 2022 7265 7374 6172  t({"op": "restar
+00036cf0: 7422 7d29 0a0a 2020 2020 2020 2020 666f  t"})..        fo
+00036d00: 7220 706c 7567 696e 2069 6e20 6c69 7374  r plugin in list
+00036d10: 2873 656c 662e 706c 7567 696e 732e 7661  (self.plugins.va
+00036d20: 6c75 6573 2829 293a 0a20 2020 2020 2020  lues()):.       
+00036d30: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00036d40: 2020 2020 2020 2020 2020 706c 7567 696e            plugin
+00036d50: 2e72 6573 7461 7274 2873 656c 6629 0a20  .restart(self). 
+00036d60: 2020 2020 2020 2020 2020 2065 7863 6570             excep
+00036d70: 7420 4578 6365 7074 696f 6e20 6173 2065  t Exception as e
+00036d80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00036d90: 2020 6c6f 6767 6572 2e65 7863 6570 7469    logger.excepti
+00036da0: 6f6e 2865 290a 0a20 2020 2020 2020 2061  on(e)..        a
+00036db0: 7761 6974 2073 656c 662e 7265 7374 6172  wait self.restar
+00036dc0: 745f 776f 726b 6572 7328 0a20 2020 2020  t_workers(.     
+00036dd0: 2020 2020 2020 2063 6c69 656e 743d 636c         client=cl
+00036de0: 6965 6e74 2c0a 2020 2020 2020 2020 2020  ient,.          
+00036df0: 2020 7469 6d65 6f75 743d 7469 6d65 6f75    timeout=timeou
+00036e00: 742c 0a20 2020 2020 2020 2020 2020 2077  t,.            w
+00036e10: 6169 745f 666f 725f 776f 726b 6572 733d  ait_for_workers=
+00036e20: 7761 6974 5f66 6f72 5f77 6f72 6b65 7273  wait_for_workers
+00036e30: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
+00036e40: 696d 756c 7573 5f69 643d 7374 696d 756c  imulus_id=stimul
+00036e50: 7573 5f69 642c 0a20 2020 2020 2020 2029  us_id,.        )
+00036e60: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
+00036e70: 730a 2020 2020 6173 796e 6320 6465 6620  s.    async def 
+00036e80: 7265 7374 6172 745f 776f 726b 6572 7328  restart_workers(
+00036e90: 0a20 2020 2020 2020 2073 656c 662c 0a20  .        self,. 
+00036ea0: 2020 2020 2020 2077 6f72 6b65 7273 3a20         workers: 
+00036eb0: 6c69 7374 5b73 7472 5d20 7c20 4e6f 6e65  list[str] | None
+00036ec0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+00036ed0: 202a 2c0a 2020 2020 2020 2020 636c 6965   *,.        clie
+00036ee0: 6e74 3a20 7374 7220 7c20 4e6f 6e65 203d  nt: str | None =
+00036ef0: 204e 6f6e 652c 0a20 2020 2020 2020 2074   None,.        t
+00036f00: 696d 656f 7574 3a20 666c 6f61 7420 3d20  imeout: float = 
+00036f10: 3330 2c0a 2020 2020 2020 2020 7761 6974  30,.        wait
+00036f20: 5f66 6f72 5f77 6f72 6b65 7273 3a20 626f  _for_workers: bo
+00036f30: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
+00036f40: 2020 206f 6e5f 6572 726f 723a 204c 6974     on_error: Lit
+00036f50: 6572 616c 5b22 7261 6973 6522 2c20 2272  eral["raise", "r
+00036f60: 6574 7572 6e22 5d20 3d20 2272 6169 7365  eturn"] = "raise
+00036f70: 222c 0a20 2020 2020 2020 2073 7469 6d75  ",.        stimu
+00036f80: 6c75 735f 6964 3a20 7374 722c 0a20 2020  lus_id: str,.   
+00036f90: 2029 202d 3e20 6469 6374 5b73 7472 2c20   ) -> dict[str, 
+00036fa0: 4c69 7465 7261 6c5b 224f 4b22 2c20 2272  Literal["OK", "r
+00036fb0: 656d 6f76 6564 222c 2022 7469 6d65 6420  emoved", "timed 
+00036fc0: 6f75 7422 5d5d 3a0a 2020 2020 2020 2020  out"]]:.        
+00036fd0: 2222 2252 6573 7461 7274 2073 656c 6563  """Restart selec
+00036fe0: 7465 6420 776f 726b 6572 732e 204f 7074  ted workers. Opt
+00036ff0: 696f 6e61 6c6c 7920 7761 6974 2066 6f72  ionally wait for
+00037000: 2077 6f72 6b65 7273 2074 6f20 7265 7475   workers to retu
+00037010: 726e 2e0a 0a20 2020 2020 2020 2057 6f72  rn...        Wor
+00037020: 6b65 7273 2077 6974 686f 7574 206e 616e  kers without nan
+00037030: 6e69 6573 2061 7265 2073 6875 7420 646f  nies are shut do
+00037040: 776e 2c20 686f 7069 6e67 2061 6e20 6578  wn, hoping an ex
+00037050: 7465 726e 616c 2064 6570 6c6f 796d 656e  ternal deploymen
+00037060: 7420 7379 7374 656d 0a20 2020 2020 2020  t system.       
+00037070: 2077 696c 6c20 7265 7374 6172 7420 7468   will restart th
+00037080: 656d 2e20 5468 6572 6566 6f72 652c 2069  em. Therefore, i
+00037090: 6620 6e6f 7420 7573 696e 6720 6e61 6e6e  f not using nann
+000370a0: 6965 7320 616e 6420 796f 7572 2064 6570  ies and your dep
+000370b0: 6c6f 796d 656e 7420 7379 7374 656d 0a20  loyment system. 
+000370c0: 2020 2020 2020 2064 6f65 7320 6e6f 7420         does not 
+000370d0: 6175 746f 6d61 7469 6361 6c6c 7920 7265  automatically re
+000370e0: 7374 6172 7420 776f 726b 6572 732c 2060  start workers, `
+000370f0: 6072 6573 7461 7274 6060 2077 696c 6c20  `restart`` will 
+00037100: 6a75 7374 2073 6875 7420 646f 776e 2061  just shut down a
+00037110: 6c6c 0a20 2020 2020 2020 2077 6f72 6b65  ll.        worke
+00037120: 7273 2c20 7468 656e 2074 696d 6520 6f75  rs, then time ou
+00037130: 7421 0a0a 2020 2020 2020 2020 4166 7465  t!..        Afte
+00037140: 7220 6060 7265 7374 6172 7460 602c 2061  r ``restart``, a
+00037150: 6c6c 2063 6f6e 6e65 6374 6564 2077 6f72  ll connected wor
+00037160: 6b65 7273 2061 7265 206e 6577 2c20 7265  kers are new, re
+00037170: 6761 7264 6c65 7373 206f 6620 7768 6574  gardless of whet
+00037180: 6865 720a 2020 2020 2020 2020 6060 5469  her.        ``Ti
+00037190: 6d65 6f75 7445 7272 6f72 6060 2077 6173  meoutError`` was
+000371a0: 2072 6169 7365 642e 2041 6e79 2077 6f72   raised. Any wor
+000371b0: 6b65 7273 2074 6861 7420 6661 696c 6564  kers that failed
+000371c0: 2074 6f20 7368 7574 2064 6f77 6e20 696e   to shut down in
+000371d0: 2074 696d 6520 6172 650a 2020 2020 2020   time are.      
+000371e0: 2020 7265 6d6f 7665 642c 2061 6e64 206d    removed, and m
+000371f0: 6179 206f 7220 6d61 7920 6e6f 7420 7368  ay or may not sh
+00037200: 7574 2064 6f77 6e20 6f6e 2074 6865 6972  ut down on their
+00037210: 206f 776e 2069 6e20 7468 6520 6675 7475   own in the futu
+00037220: 7265 2e0a 0a20 2020 2020 2020 2050 6172  re...        Par
+00037230: 616d 6574 6572 730a 2020 2020 2020 2020  ameters.        
+00037240: 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020  ----------.     
+00037250: 2020 2077 6f72 6b65 7273 3a0a 2020 2020     workers:.    
+00037260: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
+00037270: 776f 726b 6572 2061 6464 7265 7373 6573  worker addresses
+00037280: 2074 6f20 7265 7374 6172 742e 2049 6620   to restart. If 
+00037290: 6f6d 6974 7465 642c 2072 6573 7461 7274  omitted, restart
+000372a0: 2061 6c6c 2077 6f72 6b65 7273 2e0a 2020   all workers..  
+000372b0: 2020 2020 2020 7469 6d65 6f75 743a 0a20        timeout:. 
+000372c0: 2020 2020 2020 2020 2020 2048 6f77 206c             How l
+000372d0: 6f6e 6720 746f 2077 6169 7420 666f 7220  ong to wait for 
+000372e0: 776f 726b 6572 7320 746f 2073 6875 7420  workers to shut 
+000372f0: 646f 776e 2061 6e64 2063 6f6d 6520 6261  down and come ba
+00037300: 636b 2c20 6966 2060 6077 6169 745f 666f  ck, if ``wait_fo
+00037310: 725f 776f 726b 6572 7360 600a 2020 2020  r_workers``.    
+00037320: 2020 2020 2020 2020 6973 2054 7275 652c          is True,
+00037330: 206f 7468 6572 7769 7365 206a 7573 7420   otherwise just 
+00037340: 686f 7720 6c6f 6e67 2074 6f20 7761 6974  how long to wait
+00037350: 2066 6f72 2077 6f72 6b65 7273 2074 6f20   for workers to 
+00037360: 7368 7574 2064 6f77 6e2e 0a20 2020 2020  shut down..     
+00037370: 2020 2020 2020 2052 6169 7365 7320 6060         Raises ``
+00037380: 6173 796e 6369 6f2e 5469 6d65 6f75 7445  asyncio.TimeoutE
+00037390: 7272 6f72 6060 2069 6620 7468 6973 2069  rror`` if this i
+000373a0: 7320 6578 6365 6564 6564 2e0a 2020 2020  s exceeded..    
+000373b0: 2020 2020 7761 6974 5f66 6f72 5f77 6f72      wait_for_wor
+000373c0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+000373d0: 2020 5768 6574 6865 7220 746f 2077 6169    Whether to wai
+000373e0: 7420 666f 7220 616c 6c20 776f 726b 6572  t for all worker
+000373f0: 7320 746f 2072 6563 6f6e 6e65 6374 2c20  s to reconnect, 
+00037400: 6f72 206a 7573 7420 666f 7220 7468 656d  or just for them
+00037410: 2074 6f20 7368 7574 2064 6f77 6e0a 2020   to shut down.  
+00037420: 2020 2020 2020 2020 2020 2864 6566 6175            (defau
+00037430: 6c74 2054 7275 6529 2e20 5573 6520 6060  lt True). Use ``
+00037440: 7265 7374 6172 7428 7761 6974 5f66 6f72  restart(wait_for
+00037450: 5f77 6f72 6b65 7273 3d46 616c 7365 2960  _workers=False)`
+00037460: 6020 636f 6d62 696e 6564 2077 6974 680a  ` combined with.
+00037470: 2020 2020 2020 2020 2020 2020 3a6d 6574              :met
+00037480: 683a 6043 6c69 656e 742e 7761 6974 5f66  h:`Client.wait_f
+00037490: 6f72 5f77 6f72 6b65 7273 6020 666f 7220  or_workers` for 
+000374a0: 6772 616e 756c 6172 2063 6f6e 7472 6f6c  granular control
+000374b0: 206f 7665 7220 686f 7720 6d61 6e79 2077   over how many w
+000374c0: 6f72 6b65 7273 2074 6f0a 2020 2020 2020  orkers to.      
+000374d0: 2020 2020 2020 7761 6974 2066 6f72 2e0a        wait for..
+000374e0: 2020 2020 2020 2020 6f6e 5f65 7272 6f72          on_error
+000374f0: 3a0a 2020 2020 2020 2020 2020 2020 4966  :.            If
+00037500: 2027 7261 6973 6527 2028 7468 6520 6465   'raise' (the de
+00037510: 6661 756c 7429 2c20 7261 6973 6520 6966  fault), raise if
+00037520: 2061 6e79 206e 616e 6e79 2074 696d 6573   any nanny times
+00037530: 206f 7574 2077 6869 6c65 2072 6573 7461   out while resta
+00037540: 7274 696e 6720 7468 650a 2020 2020 2020  rting the.      
+00037550: 2020 2020 2020 776f 726b 6572 2e20 4966        worker. If
+00037560: 2027 7265 7475 726e 272c 2072 6574 7572   'return', retur
+00037570: 6e20 6572 726f 7220 6d65 7373 6167 6573  n error messages
+00037580: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+00037590: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
+000375a0: 2d2d 0a20 2020 2020 2020 207b 776f 726b  --.        {work
+000375b0: 6572 2061 6464 7265 7373 3a20 224f 4b22  er address: "OK"
+000375c0: 2c20 226e 6f20 6e61 6e6e 7922 2c20 6f72  , "no nanny", or
+000375d0: 2022 7469 6d65 6420 6f75 7422 206f 7220   "timed out" or 
+000375e0: 6572 726f 7220 6d65 7373 6167 657d 0a0a  error message}..
+000375f0: 2020 2020 2020 2020 5365 6520 616c 736f          See also
+00037600: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+00037610: 2d0a 2020 2020 2020 2020 436c 6965 6e74  -.        Client
+00037620: 2e72 6573 7461 7274 0a20 2020 2020 2020  .restart.       
+00037630: 2043 6c69 656e 742e 7265 7374 6172 745f   Client.restart_
+00037640: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
+00037650: 5363 6865 6475 6c65 722e 7265 7374 6172  Scheduler.restar
+00037660: 740a 2020 2020 2020 2020 2222 220a 2020  t.        """.  
+00037670: 2020 2020 2020 6e5f 776f 726b 6572 7320        n_workers 
+00037680: 3d20 6c65 6e28 7365 6c66 2e77 6f72 6b65  = len(self.worke
+00037690: 7273 290a 2020 2020 2020 2020 6966 2077  rs).        if w
+000376a0: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
+000376b0: 2020 2020 2020 2020 2020 2020 776f 726b              work
+000376c0: 6572 7320 3d20 6c69 7374 2873 656c 662e  ers = list(self.
+000376d0: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
+000376e0: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
+000376f0: 2866 2252 6573 7461 7274 696e 6720 616c  (f"Restarting al
+00037700: 6c20 776f 726b 6572 7320 287b 7374 696d  l workers ({stim
+00037710: 756c 7573 5f69 643d 7d22 290a 2020 2020  ulus_id=}").    
+00037720: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00037730: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+00037740: 6c69 7374 2873 6574 2877 6f72 6b65 7273  list(set(workers
+00037750: 292e 696e 7465 7273 6563 7469 6f6e 2873  ).intersection(s
+00037760: 656c 662e 776f 726b 6572 7329 290a 2020  elf.workers)).  
+00037770: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00037780: 2e69 6e66 6f28 6622 5265 7374 6172 7469  .info(f"Restarti
+00037790: 6e67 207b 6c65 6e28 776f 726b 6572 7329  ng {len(workers)
+000377a0: 7d20 776f 726b 6572 733a 207b 776f 726b  } workers: {work
+000377b0: 6572 737d 2028 7b73 7469 6d75 6c75 735f  ers} ({stimulus_
+000377c0: 6964 3d7d 2229 0a0a 2020 2020 2020 2020  id=}")..        
+000377d0: 6e61 6e6e 795f 776f 726b 6572 7320 3d20  nanny_workers = 
+000377e0: 7b0a 2020 2020 2020 2020 2020 2020 6164  {.            ad
+000377f0: 6472 3a20 7365 6c66 2e77 6f72 6b65 7273  dr: self.workers
+00037800: 5b61 6464 725d 2e6e 616e 6e79 0a20 2020  [addr].nanny.   
+00037810: 2020 2020 2020 2020 2066 6f72 2061 6464           for add
+00037820: 7220 696e 2077 6f72 6b65 7273 0a20 2020  r in workers.   
+00037830: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00037840: 2e77 6f72 6b65 7273 5b61 6464 725d 2e6e  .workers[addr].n
+00037850: 616e 6e79 0a20 2020 2020 2020 207d 0a20  anny.        }. 
+00037860: 2020 2020 2020 2023 2043 6c6f 7365 206e         # Close n
+00037870: 6f6e 2d4e 616e 6e79 2077 6f72 6b65 7273  on-Nanny workers
+00037880: 2e20 5765 2068 6176 6520 6e6f 2077 6179  . We have no way
+00037890: 2074 6f20 7265 7374 6172 7420 7468 656d   to restart them
+000378a0: 2c20 736f 2077 6520 6a75 7374 206c 6574  , so we just let
+000378b0: 2074 6865 6d0a 2020 2020 2020 2020 2320   them.        # 
+000378c0: 676f 2c20 616e 6420 6173 7375 6d65 2061  go, and assume a
+000378d0: 2064 6570 6c6f 796d 656e 7420 7379 7374   deployment syst
+000378e0: 656d 2069 7320 676f 696e 6720 746f 2072  em is going to r
+000378f0: 6573 7461 7274 2074 6865 6d20 666f 7220  estart them for 
+00037900: 7573 2e0a 2020 2020 2020 2020 6e6f 5f6e  us..        no_n
+00037910: 616e 6e79 5f77 6f72 6b65 7273 203d 205b  anny_workers = [
+00037920: 6164 6472 2066 6f72 2061 6464 7220 696e  addr for addr in
+00037930: 2077 6f72 6b65 7273 2069 6620 6164 6472   workers if addr
+00037940: 206e 6f74 2069 6e20 6e61 6e6e 795f 776f   not in nanny_wo
+00037950: 726b 6572 735d 0a20 2020 2020 2020 2069  rkers].        i
+00037960: 6620 6e6f 5f6e 616e 6e79 5f77 6f72 6b65  f no_nanny_worke
+00037970: 7273 3a0a 2020 2020 2020 2020 2020 2020  rs:.            
+00037980: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
+00037990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000379a0: 6622 576f 726b 6572 7320 7b6e 6f5f 6e61  f"Workers {no_na
+000379b0: 6e6e 795f 776f 726b 6572 737d 2064 6f20  nny_workers} do 
+000379c0: 6e6f 7420 7573 6520 6120 6e61 6e6e 7920  not use a nanny 
+000379d0: 616e 6420 7769 6c6c 2062 6520 7465 726d  and will be term
+000379e0: 696e 6174 6564 2022 0a20 2020 2020 2020  inated ".       
+000379f0: 2020 2020 2020 2020 2022 7769 7468 6f75           "withou
+00037a00: 7420 7265 7374 6172 7469 6e67 2074 6865  t restarting the
+00037a10: 6d22 0a20 2020 2020 2020 2020 2020 2029  m".            )
+00037a20: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
+00037a30: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
+00037a40: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00037a50: 2020 202a 280a 2020 2020 2020 2020 2020     *(.          
+00037a60: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00037a70: 656d 6f76 655f 776f 726b 6572 2861 6464  emove_worker(add
+00037a80: 7265 7373 3d61 6464 722c 2073 7469 6d75  ress=addr, stimu
+00037a90: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
+00037aa0: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
+00037ab0: 2020 2020 2020 2020 666f 7220 6164 6472          for addr
+00037ac0: 2069 6e20 6e6f 5f6e 616e 6e79 5f77 6f72   in no_nanny_wor
+00037ad0: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
+00037ae0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00037af0: 2020 2029 0a20 2020 2020 2020 206f 7574     ).        out
+00037b00: 3a20 6469 6374 5b73 7472 2c20 4c69 7465  : dict[str, Lite
+00037b10: 7261 6c5b 224f 4b22 2c20 2272 656d 6f76  ral["OK", "remov
+00037b20: 6564 222c 2022 7469 6d65 6420 6f75 7422  ed", "timed out"
+00037b30: 5d5d 0a20 2020 2020 2020 206f 7574 203d  ]].        out =
+00037b40: 207b 6164 6472 3a20 2272 656d 6f76 6564   {addr: "removed
+00037b50: 2220 666f 7220 6164 6472 2069 6e20 6e6f  " for addr in no
+00037b60: 5f6e 616e 6e79 5f77 6f72 6b65 7273 7d0a  _nanny_workers}.
+00037b70: 2020 2020 2020 2020 6465 6164 6c69 6e65          deadline
+00037b80: 203d 2044 6561 646c 696e 652e 6166 7465   = Deadline.afte
+00037b90: 7228 7469 6d65 6f75 7429 0a0a 2020 2020  r(timeout)..    
+00037ba0: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+00037bb0: 2822 5365 6e64 206b 696c 6c20 7369 676e  ("Send kill sign
+00037bc0: 616c 2074 6f20 6e61 6e6e 6965 733a 2025  al to nannies: %
+00037bd0: 7322 2c20 6e61 6e6e 795f 776f 726b 6572  s", nanny_worker
+00037be0: 7329 0a20 2020 2020 2020 2061 7379 6e63  s).        async
+00037bf0: 2077 6974 6820 636f 6e74 6578 746c 6962   with contextlib
+00037c00: 2e41 7379 6e63 4578 6974 5374 6163 6b28  .AsyncExitStack(
+00037c10: 2920 6173 2073 7461 636b 3a0a 2020 2020  ) as stack:.    
+00037c20: 2020 2020 2020 2020 6e61 6e6e 6965 7320          nannies 
+00037c30: 3d20 6177 6169 7420 6173 796e 6369 6f2e  = await asyncio.
+00037c40: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
+00037c50: 2020 2020 2020 2020 2a28 0a20 2020 2020          *(.     
+00037c60: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00037c70: 7461 636b 2e65 6e74 6572 5f61 7379 6e63  tack.enter_async
+00037c80: 5f63 6f6e 7465 7874 280a 2020 2020 2020  _context(.      
+00037c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037ca0: 2020 7270 6328 6e61 6e6e 795f 6164 6472    rpc(nanny_addr
+00037cb0: 6573 732c 2063 6f6e 6e65 6374 696f 6e5f  ess, connection_
+00037cc0: 6172 6773 3d73 656c 662e 636f 6e6e 6563  args=self.connec
+00037cd0: 7469 6f6e 5f61 7267 7329 0a20 2020 2020  tion_args).     
+00037ce0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00037cf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00037d00: 2020 2020 2066 6f72 206e 616e 6e79 5f61       for nanny_a
+00037d10: 6464 7265 7373 2069 6e20 6e61 6e6e 795f  ddress in nanny_
+00037d20: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
 00037d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00037d40: 2020 2020 2020 2020 2066 2262 7574 2061           f"but a
-00037d50: 6674 6572 207b 7469 6d65 6f75 747d 732c  fter {timeout}s,
-00037d60: 206f 6e6c 7920 7b6c 656e 2873 656c 662e   only {len(self.
-00037d70: 776f 726b 6572 7329 7d20 6861 7665 2072  workers)} have r
-00037d80: 6574 7572 6e65 642e 2022 0a20 2020 2020  eturned. ".     
+00037d40: 2029 0a20 2020 2020 2020 2020 2020 2029   ).            )
+00037d50: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
+00037d60: 7073 203d 2061 7761 6974 2061 7379 6e63  ps = await async
+00037d70: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
+00037d80: 2020 2020 2020 2020 2020 202a 280a 2020             *(.  
 00037d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037da0: 2020 2022 436f 6e73 6964 6572 2061 206c     "Consider a l
-00037db0: 6f6e 6765 7220 7469 6d65 6f75 742c 206f  onger timeout, o
-00037dc0: 7220 6077 6169 745f 666f 725f 776f 726b  r `wait_for_work
-00037dd0: 6572 733d 4661 6c73 6560 2e22 0a20 2020  ers=False`.".   
-00037de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037df0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-00037e00: 2020 2020 2020 2020 6966 2028 6e5f 6e61          if (n_na
-00037e10: 6e6e 7920 3a3d 206c 656e 286e 616e 6e79  nny := len(nanny
-00037e20: 5f77 6f72 6b65 7273 2929 203c 206e 5f77  _workers)) < n_w
-00037e30: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-00037e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037e50: 6d73 6720 2b3d 2028 0a20 2020 2020 2020  msg += (.       
+00037da0: 2020 7761 6974 5f66 6f72 280a 2020 2020    wait_for(.    
+00037db0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037dc0: 2020 2020 2320 4649 584d 4520 646f 6573      # FIXME does
+00037dd0: 206e 6f74 2072 6169 7365 2069 6620 7468   not raise if th
+00037de0: 6520 7072 6f63 6573 7320 6661 696c 7320  e process fails 
+00037df0: 746f 2073 6875 7420 646f 776e 2c0a 2020  to shut down,.  
+00037e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037e10: 2020 2020 2020 2320 7365 6520 6874 7470        # see http
+00037e20: 733a 2f2f 6769 7468 7562 2e63 6f6d 2f64  s://github.com/d
+00037e30: 6173 6b2f 6469 7374 7269 6275 7465 642f  ask/distributed/
+00037e40: 7075 6c6c 2f36 3432 372f 6669 6c65 7323  pull/6427/files#
+00037e50: 7238 3934 3931 3734 3234 0a20 2020 2020  r894917424.     
 00037e60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037e70: 2020 2020 2066 2220 5468 6520 7b6e 5f77       f" The {n_w
-00037e80: 6f72 6b65 7273 202d 206e 5f6e 616e 6e79  orkers - n_nanny
-00037e90: 7d20 776f 726b 6572 2873 2920 6e6f 7420  } worker(s) not 
-00037ea0: 7573 696e 6720 4e61 6e6e 6965 7320 7765  using Nannies we
-00037eb0: 7265 206a 7573 7420 7368 7574 2022 0a20  re just shut ". 
+00037e70: 2020 2023 204e 4f54 453a 204e 616e 6e79     # NOTE: Nanny
+00037e80: 2077 696c 6c20 6175 746f 6d61 7469 6361   will automatica
+00037e90: 6c6c 7920 7265 7374 6172 7420 776f 726b  lly restart work
+00037ea0: 6572 2070 726f 6365 7373 2077 6865 6e20  er process when 
+00037eb0: 6974 2773 206b 696c 6c65 640a 2020 2020  it's killed.    
 00037ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037ed0: 2020 2020 2020 2020 2020 2022 646f 776e             "down
-00037ee0: 2069 6e73 7465 6164 206f 6620 7265 7374   instead of rest
-00037ef0: 6172 7465 6420 2872 6573 7461 7274 2069  arted (restart i
-00037f00: 7320 6f6e 6c79 2070 6f73 7369 626c 6520  s only possible 
-00037f10: 7769 7468 204e 616e 6e69 6573 292e 2049  with Nannies). I
-00037f20: 6620 220a 2020 2020 2020 2020 2020 2020  f ".            
-00037f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037f40: 2279 6f75 7220 6465 706c 6f79 6d65 6e74  "your deployment
-00037f50: 2073 7973 7465 6d20 646f 6573 206e 6f74   system does not
-00037f60: 2061 7574 6f6d 6174 6963 616c 6c79 2072   automatically r
-00037f70: 652d 6c61 756e 6368 2074 6572 6d69 6e61  e-launch termina
-00037f80: 7465 6420 220a 2020 2020 2020 2020 2020  ted ".          
-00037f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00037fa0: 2020 2270 726f 6365 7373 6573 2c20 7468    "processes, th
-00037fb0: 656e 2074 686f 7365 2077 6f72 6b65 7273  en those workers
-00037fc0: 2077 696c 6c20 6e65 7665 7220 636f 6d65   will never come
-00037fd0: 2062 6163 6b2c 2061 6e64 2060 436c 6965   back, and `Clie
-00037fe0: 6e74 2e72 6573 7461 7274 6020 220a 2020  nt.restart` ".  
-00037ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038000: 2020 2020 2020 2020 2020 2277 696c 6c20            "will 
-00038010: 616c 7761 7973 2074 696d 6520 6f75 742e  always time out.
-00038020: 2044 6f20 6e6f 7420 7573 6520 6043 6c69   Do not use `Cli
-00038030: 656e 742e 7265 7374 6172 7460 2069 6e20  ent.restart` in 
-00038040: 7468 6174 2063 6173 652e 220a 2020 2020  that case.".    
-00038050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038060: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00038070: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-00038080: 5469 6d65 6f75 7445 7272 6f72 286d 7367  TimeoutError(msg
-00038090: 2920 6672 6f6d 204e 6f6e 650a 2020 2020  ) from None.    
-000380a0: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
-000380b0: 2252 6573 7461 7274 696e 6720 6669 6e69  "Restarting fini
-000380c0: 7368 6564 2e22 290a 0a20 2020 2061 7379  shed.")..    asy
-000380d0: 6e63 2064 6566 2062 726f 6164 6361 7374  nc def broadcast
-000380e0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-000380f0: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-00038100: 2020 206d 7367 3a20 6469 6374 2c0a 2020     msg: dict,.  
-00038110: 2020 2020 2020 776f 726b 6572 733a 2043        workers: C
-00038120: 6f6c 6c65 6374 696f 6e5b 7374 725d 207c  ollection[str] |
-00038130: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00038140: 2020 2020 2020 686f 7374 733a 2043 6f6c        hosts: Col
-00038150: 6c65 6374 696f 6e5b 7374 725d 207c 204e  lection[str] | N
-00038160: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
-00038170: 2020 2020 6e61 6e6e 793a 2062 6f6f 6c20      nanny: bool 
-00038180: 3d20 4661 6c73 652c 0a20 2020 2020 2020  = False,.       
-00038190: 2073 6572 6961 6c69 7a65 7273 3a20 416e   serializers: An
-000381a0: 7920 3d20 4e6f 6e65 2c0a 2020 2020 2020  y = None,.      
-000381b0: 2020 6f6e 5f65 7272 6f72 3a20 4c69 7465    on_error: Lite
-000381c0: 7261 6c5b 2272 6169 7365 222c 2022 7265  ral["raise", "re
-000381d0: 7475 726e 222c 2022 7265 7475 726e 5f70  turn", "return_p
-000381e0: 6963 6b6c 6522 2c20 2269 676e 6f72 6522  ickle", "ignore"
-000381f0: 5d20 3d20 2272 6169 7365 222c 0a20 2020  ] = "raise",.   
-00038200: 2029 202d 3e20 6469 6374 5b73 7472 2c20   ) -> dict[str, 
-00038210: 416e 795d 3a0a 2020 2020 2020 2020 2222  Any]:.        ""
-00038220: 2242 726f 6164 6361 7374 206d 6573 7361  "Broadcast messa
-00038230: 6765 2074 6f20 776f 726b 6572 732c 2072  ge to workers, r
-00038240: 6574 7572 6e20 616c 6c20 7265 7375 6c74  eturn all result
-00038250: 7322 2222 0a20 2020 2020 2020 2069 6620  s""".        if 
-00038260: 776f 726b 6572 7320 6973 204e 6f6e 653a  workers is None:
-00038270: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00038280: 686f 7374 7320 6973 204e 6f6e 653a 0a20  hosts is None:. 
-00038290: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-000382a0: 6f72 6b65 7273 203d 206c 6973 7428 7365  orkers = list(se
-000382b0: 6c66 2e77 6f72 6b65 7273 290a 2020 2020  lf.workers).    
-000382c0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-000382d0: 2020 2020 2020 2020 2020 2020 2020 776f                wo
-000382e0: 726b 6572 7320 3d20 5b5d 0a20 2020 2020  rkers = [].     
-000382f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00038300: 2020 2020 2077 6f72 6b65 7273 203d 206c       workers = l
-00038310: 6973 7428 776f 726b 6572 7329 0a20 2020  ist(workers).   
-00038320: 2020 2020 2069 6620 686f 7374 7320 6973       if hosts is
-00038330: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00038340: 2020 2020 2020 2066 6f72 2068 6f73 7420         for host 
-00038350: 696e 2068 6f73 7473 3a0a 2020 2020 2020  in hosts:.      
-00038360: 2020 2020 2020 2020 2020 6468 203d 2073            dh = s
-00038370: 656c 662e 686f 7374 5f69 6e66 6f2e 6765  elf.host_info.ge
-00038380: 7428 686f 7374 290a 2020 2020 2020 2020  t(host).        
-00038390: 2020 2020 2020 2020 6966 2064 6820 6973          if dh is
-000383a0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-000383b0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-000383c0: 6f72 6b65 7273 2e65 7874 656e 6428 6468  orkers.extend(dh
-000383d0: 5b22 6164 6472 6573 7365 7322 5d29 0a0a  ["addresses"])..
-000383e0: 2020 2020 2020 2020 6966 206e 616e 6e79          if nanny
-000383f0: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
-00038400: 6472 6573 7365 7320 3d20 5b6e 2066 6f72  dresses = [n for
-00038410: 2077 2069 6e20 776f 726b 6572 7320 6966   w in workers if
-00038420: 2028 6e20 3a3d 2073 656c 662e 776f 726b   (n := self.work
-00038430: 6572 735b 775d 2e6e 616e 6e79 2920 6973  ers[w].nanny) is
-00038440: 206e 6f74 204e 6f6e 655d 0a20 2020 2020   not None].     
-00038450: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00038460: 2020 2020 2061 6464 7265 7373 6573 203d       addresses =
-00038470: 2077 6f72 6b65 7273 0a0a 2020 2020 2020   workers..      
-00038480: 2020 4552 524f 5220 3d20 6f62 6a65 6374    ERROR = object
-00038490: 2829 0a0a 2020 2020 2020 2020 6173 796e  ()..        asyn
-000384a0: 6320 6465 6620 7365 6e64 5f6d 6573 7361  c def send_messa
-000384b0: 6765 2861 6464 7229 3a0a 2020 2020 2020  ge(addr):.      
-000384c0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000384d0: 2020 2020 2020 2020 2020 2063 6f6d 6d20             comm 
-000384e0: 3d20 6177 6169 7420 7365 6c66 2e72 7063  = await self.rpc
-000384f0: 2e63 6f6e 6e65 6374 2861 6464 7229 0a20  .connect(addr). 
-00038500: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00038510: 6f6d 6d2e 6e61 6d65 203d 2022 5363 6865  omm.name = "Sche
-00038520: 6475 6c65 7220 4272 6f61 6463 6173 7422  duler Broadcast"
-00038530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00038540: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00038550: 2020 2020 2020 2020 2020 7265 7370 203d            resp =
-00038560: 2061 7761 6974 2073 656e 645f 7265 6376   await send_recv
-00038570: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00038580: 2020 2020 2020 2020 2020 636f 6d6d 2c20            comm, 
-00038590: 636c 6f73 653d 5472 7565 2c20 7365 7269  close=True, seri
-000385a0: 616c 697a 6572 733d 7365 7269 616c 697a  alizers=serializ
-000385b0: 6572 732c 202a 2a6d 7367 0a20 2020 2020  ers, **msg.     
-000385c0: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-000385d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000385e0: 2066 696e 616c 6c79 3a0a 2020 2020 2020   finally:.      
-000385f0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00038600: 6c66 2e72 7063 2e72 6575 7365 2861 6464  lf.rpc.reuse(add
-00038610: 722c 2063 6f6d 6d29 0a20 2020 2020 2020  r, comm).       
-00038620: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00038630: 7265 7370 0a20 2020 2020 2020 2020 2020  resp.           
-00038640: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
-00038650: 6e20 6173 2065 3a0a 2020 2020 2020 2020  n as e:.        
-00038660: 2020 2020 2020 2020 6c6f 6767 6572 2e65          logger.e
-00038670: 7272 6f72 2866 2262 726f 6164 6361 7374  rror(f"broadcast
-00038680: 2074 6f20 7b61 6464 727d 2066 6169 6c65   to {addr} faile
-00038690: 643a 207b 652e 5f5f 636c 6173 735f 5f2e  d: {e.__class__.
-000386a0: 5f5f 6e61 6d65 5f5f 7d3a 207b 657d 2229  __name__}: {e}")
-000386b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000386c0: 2069 6620 6f6e 5f65 7272 6f72 203d 3d20   if on_error == 
-000386d0: 2272 6169 7365 223a 0a20 2020 2020 2020  "raise":.       
-000386e0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-000386f0: 7365 0a20 2020 2020 2020 2020 2020 2020  se.             
-00038700: 2020 2065 6c69 6620 6f6e 5f65 7272 6f72     elif on_error
-00038710: 203d 3d20 2272 6574 7572 6e22 3a0a 2020   == "return":.  
-00038720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038730: 2020 7265 7475 726e 2065 0a20 2020 2020    return e.     
-00038740: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00038750: 6f6e 5f65 7272 6f72 203d 3d20 2272 6574  on_error == "ret
-00038760: 7572 6e5f 7069 636b 6c65 223a 0a20 2020  urn_pickle":.   
-00038770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038780: 2072 6574 7572 6e20 6475 6d70 7328 6529   return dumps(e)
-00038790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000387a0: 2065 6c69 6620 6f6e 5f65 7272 6f72 203d   elif on_error =
-000387b0: 3d20 2269 676e 6f72 6522 3a0a 2020 2020  = "ignore":.    
-000387c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000387d0: 7265 7475 726e 2045 5252 4f52 0a20 2020  return ERROR.   
-000387e0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-000387f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00038800: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00038810: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
-00038820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038830: 2022 6f6e 5f65 7272 6f72 206d 7573 7420   "on_error must 
-00038840: 6265 2027 7261 6973 6527 2c20 2772 6574  be 'raise', 'ret
-00038850: 7572 6e27 2c20 2772 6574 7572 6e5f 7069  urn', 'return_pi
-00038860: 636b 6c65 272c 2022 0a20 2020 2020 2020  ckle', ".       
-00038870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038880: 2066 226f 7220 2769 676e 6f72 6527 3b20   f"or 'ignore'; 
-00038890: 676f 7420 7b6f 6e5f 6572 726f 7221 727d  got {on_error!r}
-000388a0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-000388b0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-000388c0: 2072 6573 756c 7473 203d 2061 7761 6974   results = await
-000388d0: 2041 6c6c 285b 7365 6e64 5f6d 6573 7361   All([send_messa
-000388e0: 6765 2861 6464 7265 7373 2920 666f 7220  ge(address) for 
-000388f0: 6164 6472 6573 7320 696e 2061 6464 7265  address in addre
-00038900: 7373 6573 5d29 0a20 2020 2020 2020 2072  sses]).        r
-00038910: 6574 7572 6e20 7b6b 3a20 7620 666f 7220  eturn {k: v for 
-00038920: 6b2c 2076 2069 6e20 7a69 7028 776f 726b  k, v in zip(work
-00038930: 6572 732c 2072 6573 756c 7473 2920 6966  ers, results) if
-00038940: 2076 2069 7320 6e6f 7420 4552 524f 527d   v is not ERROR}
-00038950: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00038960: 7072 6f78 7928 0a20 2020 2020 2020 2073  proxy(.        s
-00038970: 656c 662c 0a20 2020 2020 2020 206d 7367  elf,.        msg
-00038980: 3a20 6469 6374 2c0a 2020 2020 2020 2020  : dict,.        
-00038990: 776f 726b 6572 3a20 7374 722c 0a20 2020  worker: str,.   
-000389a0: 2020 2020 2073 6572 6961 6c69 7a65 7273       serializers
-000389b0: 3a20 416e 7920 3d20 4e6f 6e65 2c0a 2020  : Any = None,.  
-000389c0: 2020 2920 2d3e 2041 6e79 3a0a 2020 2020    ) -> Any:.    
-000389d0: 2020 2020 2222 2250 726f 7879 2061 2063      """Proxy a c
-000389e0: 6f6d 6d75 6e69 6361 7469 6f6e 2074 6872  ommunication thr
-000389f0: 6f75 6768 2074 6865 2073 6368 6564 756c  ough the schedul
-00038a00: 6572 2074 6f20 736f 6d65 206f 7468 6572  er to some other
-00038a10: 2077 6f72 6b65 7222 2222 0a20 2020 2020   worker""".     
-00038a20: 2020 2064 203d 2061 7761 6974 2073 656c     d = await sel
-00038a30: 662e 6272 6f61 6463 6173 7428 6d73 673d  f.broadcast(msg=
-00038a40: 6d73 672c 2077 6f72 6b65 7273 3d5b 776f  msg, workers=[wo
-00038a50: 726b 6572 5d2c 2073 6572 6961 6c69 7a65  rker], serialize
-00038a60: 7273 3d73 6572 6961 6c69 7a65 7273 290a  rs=serializers).
-00038a70: 2020 2020 2020 2020 7265 7475 726e 2064          return d
-00038a80: 5b77 6f72 6b65 725d 0a0a 2020 2020 6173  [worker]..    as
-00038a90: 796e 6320 6465 6620 6761 7468 6572 5f6f  ync def gather_o
-00038aa0: 6e5f 776f 726b 6572 280a 2020 2020 2020  n_worker(.      
-00038ab0: 2020 7365 6c66 2c20 776f 726b 6572 5f61    self, worker_a
-00038ac0: 6464 7265 7373 3a20 7374 722c 2077 686f  ddress: str, who
-00038ad0: 5f68 6173 3a20 6469 6374 5b4b 6579 2c20  _has: dict[Key, 
-00038ae0: 6c69 7374 5b73 7472 5d5d 0a20 2020 2029  list[str]].    )
-00038af0: 202d 3e20 7365 743a 0a20 2020 2020 2020   -> set:.       
-00038b00: 2022 2222 5065 6572 2d74 6f2d 7065 6572   """Peer-to-peer
-00038b10: 2063 6f70 7920 6f66 206b 6579 7320 6672   copy of keys fr
-00038b20: 6f6d 206d 756c 7469 706c 6520 776f 726b  om multiple work
-00038b30: 6572 7320 746f 2061 2073 696e 676c 6520  ers to a single 
-00038b40: 776f 726b 6572 0a0a 2020 2020 2020 2020  worker..        
-00038b50: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
-00038b60: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
-00038b70: 2020 2020 2020 776f 726b 6572 5f61 6464        worker_add
-00038b80: 7265 7373 3a20 7374 720a 2020 2020 2020  ress: str.      
-00038b90: 2020 2020 2020 5265 6369 7069 656e 7420        Recipient 
-00038ba0: 776f 726b 6572 2061 6464 7265 7373 2074  worker address t
-00038bb0: 6f20 636f 7079 206b 6579 7320 746f 0a20  o copy keys to. 
-00038bc0: 2020 2020 2020 2077 686f 5f68 6173 3a20         who_has: 
-00038bd0: 6469 6374 5b4b 6579 2c20 6c69 7374 5b73  dict[Key, list[s
-00038be0: 7472 5d5d 0a20 2020 2020 2020 2020 2020  tr]].           
-00038bf0: 207b 6b65 793a 205b 7365 6e64 6572 2061   {key: [sender a
-00038c00: 6464 7265 7373 2c20 7365 6e64 6572 2061  ddress, sender a
-00038c10: 6464 7265 7373 2c20 2e2e 2e5d 2c20 6b65  ddress, ...], ke
-00038c20: 793a 202e 2e2e 7d0a 0a20 2020 2020 2020  y: ...}..       
-00038c30: 2052 6574 7572 6e73 0a20 2020 2020 2020   Returns.       
-00038c40: 202d 2d2d 2d2d 2d2d 0a20 2020 2020 2020   -------.       
-00038c50: 2072 6574 7572 6e73 3a0a 2020 2020 2020   returns:.      
-00038c60: 2020 2020 2020 7365 7420 6f66 206b 6579        set of key
-00038c70: 7320 7468 6174 2066 6169 6c65 6420 746f  s that failed to
-00038c80: 2062 6520 636f 7069 6564 0a20 2020 2020   be copied.     
-00038c90: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
-00038ca0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00038cb0: 7265 7375 6c74 203d 2061 7761 6974 2072  result = await r
-00038cc0: 6574 7279 5f6f 7065 7261 7469 6f6e 280a  etry_operation(.
-00038cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038ce0: 7365 6c66 2e72 7063 2861 6464 723d 776f  self.rpc(addr=wo
-00038cf0: 726b 6572 5f61 6464 7265 7373 292e 6761  rker_address).ga
-00038d00: 7468 6572 2c20 7768 6f5f 6861 733d 7768  ther, who_has=wh
-00038d10: 6f5f 6861 730a 2020 2020 2020 2020 2020  o_has.          
-00038d20: 2020 290a 2020 2020 2020 2020 6578 6365    ).        exce
-00038d30: 7074 204f 5345 7272 6f72 2061 7320 653a  pt OSError as e:
-00038d40: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00038d50: 6869 7320 6361 6e20 6861 7070 656e 2065  his can happen e
-00038d60: 2e67 2e20 6966 2074 6865 2077 6f72 6b65  .g. if the worke
-00038d70: 7220 6973 2067 6f69 6e67 2074 6872 6f75  r is going throu
-00038d80: 6768 2063 6f6e 7472 6f6c 6c65 6420 7368  gh controlled sh
-00038d90: 7574 646f 776e 3b0a 2020 2020 2020 2020  utdown;.        
-00038da0: 2020 2020 2320 6974 2064 6f65 736e 2774      # it doesn't
-00038db0: 206e 6563 6573 7361 7269 6c79 206d 6561   necessarily mea
-00038dc0: 6e20 7468 6174 2069 7420 7765 6e74 2075  n that it went u
-00038dd0: 6e65 7870 6563 7465 646c 7920 6d69 7373  nexpectedly miss
-00038de0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-00038df0: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
-00038e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00038e10: 6622 436f 6d6d 756e 6963 6174 696f 6e20  f"Communication 
-00038e20: 7769 7468 2077 6f72 6b65 7220 7b77 6f72  with worker {wor
-00038e30: 6b65 725f 6164 6472 6573 737d 2066 6169  ker_address} fai
-00038e40: 6c65 6420 6475 7269 6e67 2022 0a20 2020  led during ".   
-00038e50: 2020 2020 2020 2020 2020 2020 2066 2272               f"r
-00038e60: 6570 6c69 6361 7469 6f6e 3a20 7b65 2e5f  eplication: {e._
-00038e70: 5f63 6c61 7373 5f5f 2e5f 5f6e 616d 655f  _class__.__name_
-00038e80: 5f7d 3a20 7b65 7d22 0a20 2020 2020 2020  _}: {e}".       
-00038e90: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00038ea0: 2020 2072 6574 7572 6e20 7365 7428 7768     return set(wh
-00038eb0: 6f5f 6861 7329 0a0a 2020 2020 2020 2020  o_has)..        
-00038ec0: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
-00038ed0: 732e 6765 7428 776f 726b 6572 5f61 6464  s.get(worker_add
-00038ee0: 7265 7373 290a 0a20 2020 2020 2020 2069  ress)..        i
-00038ef0: 6620 6e6f 7420 7773 3a0a 2020 2020 2020  f not ws:.      
-00038f00: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
-00038f10: 6e69 6e67 2866 2257 6f72 6b65 7220 7b77  ning(f"Worker {w
-00038f20: 6f72 6b65 725f 6164 6472 6573 737d 206c  orker_address} l
-00038f30: 6f73 7420 6475 7269 6e67 2072 6570 6c69  ost during repli
-00038f40: 6361 7469 6f6e 2229 0a20 2020 2020 2020  cation").       
-00038f50: 2020 2020 2072 6574 7572 6e20 7365 7428       return set(
-00038f60: 7768 6f5f 6861 7329 0a20 2020 2020 2020  who_has).       
-00038f70: 2065 6c69 6620 7265 7375 6c74 5b22 7374   elif result["st
-00038f80: 6174 7573 225d 203d 3d20 224f 4b22 3a0a  atus"] == "OK":.
-00038f90: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-00038fa0: 5f66 6169 6c65 6420 3d20 7365 7428 290a  _failed = set().
-00038fb0: 2020 2020 2020 2020 2020 2020 6b65 7973              keys
-00038fc0: 5f6f 6b3a 2053 6574 203d 2077 686f 5f68  _ok: Set = who_h
-00038fd0: 6173 2e6b 6579 7328 290a 2020 2020 2020  as.keys().      
-00038fe0: 2020 656c 6966 2072 6573 756c 745b 2273    elif result["s
-00038ff0: 7461 7475 7322 5d20 3d3d 2022 7061 7274  tatus"] == "part
-00039000: 6961 6c2d 6661 696c 223a 0a20 2020 2020  ial-fail":.     
-00039010: 2020 2020 2020 206b 6579 735f 6661 696c         keys_fail
-00039020: 6564 203d 2073 6574 2872 6573 756c 745b  ed = set(result[
-00039030: 226b 6579 7322 5d29 0a20 2020 2020 2020  "keys"]).       
-00039040: 2020 2020 206b 6579 735f 6f6b 203d 2077       keys_ok = w
-00039050: 686f 5f68 6173 2e6b 6579 7328 2920 2d20  ho_has.keys() - 
-00039060: 6b65 7973 5f66 6169 6c65 640a 2020 2020  keys_failed.    
-00039070: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
-00039080: 6172 6e69 6e67 280a 2020 2020 2020 2020  arning(.        
-00039090: 2020 2020 2020 2020 6622 576f 726b 6572          f"Worker
-000390a0: 207b 776f 726b 6572 5f61 6464 7265 7373   {worker_address
-000390b0: 7d20 6661 696c 6564 2074 6f20 6163 7175  } failed to acqu
-000390c0: 6972 6520 6b65 7973 3a20 7b72 6573 756c  ire keys: {resul
-000390d0: 745b 276b 6579 7327 5d7d 220a 2020 2020  t['keys']}".    
-000390e0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-000390f0: 2020 656c 7365 3a20 2023 2070 7261 676d    else:  # pragm
-00039100: 613a 206e 6f63 6f76 6572 0a20 2020 2020  a: nocover.     
-00039110: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00039120: 7565 4572 726f 7228 6622 556e 6578 7065  ueError(f"Unexpe
-00039130: 6374 6564 206d 6573 7361 6765 2066 726f  cted message fro
-00039140: 6d20 7b77 6f72 6b65 725f 6164 6472 6573  m {worker_addres
-00039150: 737d 3a20 7b72 6573 756c 747d 2229 0a0a  s}: {result}")..
-00039160: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-00039170: 696e 206b 6579 735f 6f6b 3a0a 2020 2020  in keys_ok:.    
-00039180: 2020 2020 2020 2020 7473 203d 2073 656c          ts = sel
-00039190: 662e 7461 736b 732e 6765 7428 6b65 7929  f.tasks.get(key)
-000391a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000391b0: 7473 2069 7320 4e6f 6e65 206f 7220 7473  ts is None or ts
-000391c0: 2e73 7461 7465 2021 3d20 226d 656d 6f72  .state != "memor
-000391d0: 7922 3a0a 2020 2020 2020 2020 2020 2020  y":.            
-000391e0: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
-000391f0: 6e67 2866 224b 6579 206c 6f73 7420 6475  ng(f"Key lost du
-00039200: 7269 6e67 2072 6570 6c69 6361 7469 6f6e  ring replication
-00039210: 3a20 7b6b 6579 7d22 290a 2020 2020 2020  : {key}").      
-00039220: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
-00039230: 7565 0a20 2020 2020 2020 2020 2020 2073  ue.            s
-00039240: 656c 662e 6164 645f 7265 706c 6963 6128  elf.add_replica(
-00039250: 7473 2c20 7773 290a 0a20 2020 2020 2020  ts, ws)..       
-00039260: 2072 6574 7572 6e20 6b65 7973 5f66 6169   return keys_fai
-00039270: 6c65 640a 0a20 2020 2061 7379 6e63 2064  led..    async d
-00039280: 6566 2064 656c 6574 655f 776f 726b 6572  ef delete_worker
-00039290: 5f64 6174 6128 0a20 2020 2020 2020 2073  _data(.        s
-000392a0: 656c 662c 2077 6f72 6b65 725f 6164 6472  elf, worker_addr
-000392b0: 6573 733a 2073 7472 2c20 6b65 7973 3a20  ess: str, keys: 
-000392c0: 436f 6c6c 6563 7469 6f6e 5b4b 6579 5d2c  Collection[Key],
-000392d0: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
-000392e0: 720a 2020 2020 2920 2d3e 204e 6f6e 653a  r.    ) -> None:
-000392f0: 0a20 2020 2020 2020 2022 2222 4465 6c65  .        """Dele
-00039300: 7465 2064 6174 6120 6672 6f6d 2061 2077  te data from a w
-00039310: 6f72 6b65 7220 616e 6420 7570 6461 7465  orker and update
-00039320: 2074 6865 2063 6f72 7265 7370 6f6e 6469   the correspondi
-00039330: 6e67 2077 6f72 6b65 722f 7461 736b 2073  ng worker/task s
-00039340: 7461 7465 730a 0a20 2020 2020 2020 2050  tates..        P
-00039350: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
-00039360: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00039370: 2020 2020 2077 6f72 6b65 725f 6164 6472       worker_addr
-00039380: 6573 733a 2073 7472 0a20 2020 2020 2020  ess: str.       
-00039390: 2020 2020 2057 6f72 6b65 7220 6164 6472       Worker addr
-000393a0: 6573 7320 746f 2064 656c 6574 6520 6b65  ess to delete ke
-000393b0: 7973 2066 726f 6d0a 2020 2020 2020 2020  ys from.        
-000393c0: 6b65 7973 3a20 6c69 7374 5b4b 6579 5d0a  keys: list[Key].
-000393d0: 2020 2020 2020 2020 2020 2020 4c69 7374              List
-000393e0: 206f 6620 6b65 7973 2074 6f20 6465 6c65   of keys to dele
-000393f0: 7465 206f 6e20 7468 6520 7370 6563 6966  te on the specif
-00039400: 6965 6420 776f 726b 6572 0a20 2020 2020  ied worker.     
-00039410: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
-00039420: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00039430: 6177 6169 7420 7265 7472 795f 6f70 6572  await retry_oper
-00039440: 6174 696f 6e28 0a20 2020 2020 2020 2020  ation(.         
-00039450: 2020 2020 2020 2073 656c 662e 7270 6328         self.rpc(
-00039460: 6164 6472 3d77 6f72 6b65 725f 6164 6472  addr=worker_addr
-00039470: 6573 7329 2e66 7265 655f 6b65 7973 2c0a  ess).free_keys,.
+00037ed0: 2020 2020 6e61 6e6e 792e 6b69 6c6c 2872      nanny.kill(r
+00037ee0: 6561 736f 6e3d 7374 696d 756c 7573 5f69  eason=stimulus_i
+00037ef0: 642c 2074 696d 656f 7574 3d74 696d 656f  d, timeout=timeo
+00037f00: 7574 292c 0a20 2020 2020 2020 2020 2020  ut),.           
+00037f10: 2020 2020 2020 2020 2020 2020 2074 696d               tim
+00037f20: 656f 7574 2c0a 2020 2020 2020 2020 2020  eout,.          
+00037f30: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00037f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00037f50: 666f 7220 6e61 6e6e 7920 696e 206e 616e  for nanny in nan
+00037f60: 6e69 6573 0a20 2020 2020 2020 2020 2020  nies.           
+00037f70: 2020 2020 2029 2c0a 2020 2020 2020 2020       ),.        
+00037f80: 2020 2020 2020 2020 7265 7475 726e 5f65          return_e
+00037f90: 7863 6570 7469 6f6e 733d 5472 7565 2c0a  xceptions=True,.
+00037fa0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00037fb0: 2020 2020 2020 2020 2020 2320 4e4f 5445            # NOTE
+00037fc0: 3a20 7468 6520 6057 6f72 6b65 7253 7461  : the `WorkerSta
+00037fd0: 7465 6020 656e 7472 6965 7320 666f 7220  te` entries for 
+00037fe0: 7468 6573 6520 776f 726b 6572 7320 7769  these workers wi
+00037ff0: 6c6c 2062 6520 7265 6d6f 7665 640a 2020  ll be removed.  
+00038000: 2020 2020 2020 2020 2020 2320 6e61 7475            # natu
+00038010: 7261 6c6c 7920 7768 656e 2074 6865 7920  rally when they 
+00038020: 6469 7363 6f6e 6e65 6374 2066 726f 6d20  disconnect from 
+00038030: 7468 6520 7363 6865 6475 6c65 722e 0a0a  the scheduler...
+00038040: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+00038050: 6d6f 7665 2061 6e79 2077 6f72 6b65 7273  move any workers
+00038060: 2074 6861 7420 6661 696c 6564 2074 6f20   that failed to 
+00038070: 7368 7574 2064 6f77 6e2c 2073 6f20 7765  shut down, so we
+00038080: 2063 616e 2067 7561 7261 6e74 6565 0a20   can guarantee. 
+00038090: 2020 2020 2020 2020 2020 2023 2074 6861             # tha
+000380a0: 7420 6166 7465 7220 6072 6573 7461 7274  t after `restart
+000380b0: 602c 2074 6865 7265 2061 7265 206e 6f20  `, there are no 
+000380c0: 6f6c 6420 776f 726b 6572 7320 6172 6f75  old workers arou
+000380d0: 6e64 2e0a 2020 2020 2020 2020 2020 2020  nd..            
+000380e0: 6261 645f 6e61 6e6e 6965 7320 3d20 7365  bad_nannies = se
+000380f0: 7428 290a 2020 2020 2020 2020 2020 2020  t().            
+00038100: 666f 7220 6164 6472 2c20 7265 7370 2069  for addr, resp i
+00038110: 6e20 7a69 7028 6e61 6e6e 795f 776f 726b  n zip(nanny_work
+00038120: 6572 732c 2072 6573 7073 293a 0a20 2020  ers, resps):.   
+00038130: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00038140: 7265 7370 2069 7320 4e6f 6e65 3a0a 2020  resp is None:.  
+00038150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038160: 2020 6f75 745b 6164 6472 5d20 3d20 224f    out[addr] = "O
+00038170: 4b22 0a20 2020 2020 2020 2020 2020 2020  K".             
+00038180: 2020 2065 6c69 6620 6973 696e 7374 616e     elif isinstan
+00038190: 6365 2872 6573 702c 2028 4f53 4572 726f  ce(resp, (OSErro
+000381a0: 722c 2054 696d 656f 7574 4572 726f 7229  r, TimeoutError)
+000381b0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000381c0: 2020 2020 2020 2062 6164 5f6e 616e 6e69         bad_nanni
+000381d0: 6573 2e61 6464 2861 6464 7229 0a20 2020  es.add(addr).   
+000381e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000381f0: 206f 7574 5b61 6464 725d 203d 2022 7469   out[addr] = "ti
+00038200: 6d65 6420 6f75 7422 0a20 2020 2020 2020  med out".       
+00038210: 2020 2020 2020 2020 2065 6c73 653a 2020           else:  
+00038220: 2320 7072 6167 6d61 3a20 6e6f 636f 7665  # pragma: nocove
+00038230: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+00038240: 2020 2020 2020 7261 6973 6520 7265 7370        raise resp
+00038250: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00038260: 2062 6164 5f6e 616e 6e69 6573 3a0a 2020   bad_nannies:.  
+00038270: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00038280: 6767 6572 2e65 7272 6f72 280a 2020 2020  gger.error(.    
+00038290: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000382a0: 6622 576f 726b 6572 7320 7b6c 6973 7428  f"Workers {list(
+000382b0: 6261 645f 6e61 6e6e 6965 7329 7d20 6469  bad_nannies)} di
+000382c0: 6420 6e6f 7420 7368 7574 2064 6f77 6e20  d not shut down 
+000382d0: 7769 7468 696e 207b 7469 6d65 6f75 747d  within {timeout}
+000382e0: 733b 2022 0a20 2020 2020 2020 2020 2020  s; ".           
+000382f0: 2020 2020 2020 2020 2022 666f 7263 6520           "force 
+00038300: 636c 6f73 696e 6722 0a20 2020 2020 2020  closing".       
+00038310: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00038320: 2020 2020 2020 2020 2020 2061 7761 6974             await
+00038330: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
+00038340: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038350: 2020 2020 202a 280a 2020 2020 2020 2020       *(.        
+00038360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038370: 7365 6c66 2e72 656d 6f76 655f 776f 726b  self.remove_work
+00038380: 6572 2861 6464 722c 2073 7469 6d75 6c75  er(addr, stimulu
+00038390: 735f 6964 3d73 7469 6d75 6c75 735f 6964  s_id=stimulus_id
+000383a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000383b0: 2020 2020 2020 2020 2020 666f 7220 6164            for ad
+000383c0: 6472 2069 6e20 6261 645f 6e61 6e6e 6965  dr in bad_nannie
+000383d0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000383e0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000383f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00038400: 2020 2020 2020 2020 2020 6966 206f 6e5f            if on_
+00038410: 6572 726f 7220 3d3d 2022 7261 6973 6522  error == "raise"
+00038420: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00038430: 2020 2020 2020 7261 6973 6520 5469 6d65        raise Time
+00038440: 6f75 7445 7272 6f72 280a 2020 2020 2020  outError(.      
+00038450: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038460: 2020 6622 7b6c 656e 2862 6164 5f6e 616e    f"{len(bad_nan
+00038470: 6e69 6573 297d 2f7b 6c65 6e28 6e61 6e6e  nies)}/{len(nann
+00038480: 6965 7329 7d20 6e61 6e6e 7920 776f 726b  ies)} nanny work
+00038490: 6572 2873 2920 6469 6420 6e6f 7420 220a  er(s) did not ".
+000384a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000384b0: 2020 2020 2020 2020 6622 7368 7574 2064          f"shut d
+000384c0: 6f77 6e20 7769 7468 696e 207b 7469 6d65  own within {time
+000384d0: 6f75 747d 733a 207b 6261 645f 6e61 6e6e  out}s: {bad_nann
+000384e0: 6965 737d 220a 2020 2020 2020 2020 2020  ies}".          
+000384f0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+00038500: 2020 2020 2069 6620 636c 6965 6e74 3a0a       if client:.
+00038510: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00038520: 2e6c 6f67 5f65 7665 6e74 2863 6c69 656e  .log_event(clien
+00038530: 742c 207b 2261 6374 696f 6e22 3a20 2272  t, {"action": "r
+00038540: 6573 7461 7274 2d77 6f72 6b65 7273 222c  estart-workers",
+00038550: 2022 776f 726b 6572 7322 3a20 776f 726b   "workers": work
+00038560: 6572 737d 290a 2020 2020 2020 2020 7365  ers}).        se
+00038570: 6c66 2e6c 6f67 5f65 7665 6e74 280a 2020  lf.log_event(.  
+00038580: 2020 2020 2020 2020 2020 2261 6c6c 222c            "all",
+00038590: 207b 2261 6374 696f 6e22 3a20 2272 6573   {"action": "res
+000385a0: 7461 7274 2d77 6f72 6b65 7273 222c 2022  tart-workers", "
+000385b0: 776f 726b 6572 7322 3a20 776f 726b 6572  workers": worker
+000385c0: 732c 2022 636c 6965 6e74 223a 2063 6c69  s, "client": cli
+000385d0: 656e 747d 0a20 2020 2020 2020 2029 0a0a  ent}.        )..
+000385e0: 2020 2020 2020 2020 6966 206e 6f74 2077          if not w
+000385f0: 6169 745f 666f 725f 776f 726b 6572 733a  ait_for_workers:
+00038600: 0a20 2020 2020 2020 2020 2020 206c 6f67  .            log
+00038610: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
+00038620: 2020 2020 2020 2020 2020 2257 6f72 6b65            "Worke
+00038630: 7273 2072 6573 7461 7274 2066 696e 6973  rs restart finis
+00038640: 6865 6420 2864 6964 206e 6f74 2077 6169  hed (did not wai
+00038650: 7420 666f 7220 6e65 7720 776f 726b 6572  t for new worker
+00038660: 7329 2022 0a20 2020 2020 2020 2020 2020  s) ".           
+00038670: 2020 2020 2066 2228 7b73 7469 6d75 6c75       f"({stimulu
+00038680: 735f 6964 3d7d 220a 2020 2020 2020 2020  s_id=}".        
+00038690: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+000386a0: 2020 7265 7475 726e 206f 7574 0a0a 2020    return out..  
+000386b0: 2020 2020 2020 2320 4e4f 5445 3a20 6966        # NOTE: if
+000386c0: 206e 6577 2028 756e 7265 6c61 7465 6429   new (unrelated)
+000386d0: 2077 6f72 6b65 7273 206a 6f69 6e20 7768   workers join wh
+000386e0: 696c 6520 7765 2772 6520 7761 6974 696e  ile we're waitin
+000386f0: 672c 2077 6520 6d61 7920 7265 7475 726e  g, we may return
+00038700: 0a20 2020 2020 2020 2023 2062 6566 6f72  .        # befor
+00038710: 6520 6f75 7220 7368 7574 2d64 6f77 6e20  e our shut-down 
+00038720: 776f 726b 6572 7320 6861 7665 2063 6f6d  workers have com
+00038730: 6520 6261 636b 2075 702e 2054 6861 7427  e back up. That'
+00038740: 7320 6669 6e65 3b20 776f 726b 6572 7320  s fine; workers 
+00038750: 6172 650a 2020 2020 2020 2020 2320 696e  are.        # in
+00038760: 7465 7263 6861 6e67 6561 626c 652e 0a20  terchangeable.. 
+00038770: 2020 2020 2020 2077 6869 6c65 206e 6f74         while not
+00038780: 2064 6561 646c 696e 652e 6578 7069 7265   deadline.expire
+00038790: 6420 616e 6420 6c65 6e28 7365 6c66 2e77  d and len(self.w
+000387a0: 6f72 6b65 7273 2920 3c20 6e5f 776f 726b  orkers) < n_work
+000387b0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
+000387c0: 2061 7761 6974 2061 7379 6e63 696f 2e73   await asyncio.s
+000387d0: 6c65 6570 2830 2e32 290a 0a20 2020 2020  leep(0.2)..     
+000387e0: 2020 2069 6620 6c65 6e28 7365 6c66 2e77     if len(self.w
+000387f0: 6f72 6b65 7273 2920 3e3d 206e 5f77 6f72  orkers) >= n_wor
+00038800: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
+00038810: 2020 6c6f 6767 6572 2e69 6e66 6f28 6622    logger.info(f"
+00038820: 576f 726b 6572 7320 7265 7374 6172 7420  Workers restart 
+00038830: 6669 6e69 7368 6564 2028 7b73 7469 6d75  finished ({stimu
+00038840: 6c75 735f 6964 3d7d 2229 0a20 2020 2020  lus_id=}").     
+00038850: 2020 2020 2020 2072 6574 7572 6e20 6f75         return ou
+00038860: 740a 0a20 2020 2020 2020 206d 7367 203d  t..        msg =
+00038870: 2028 0a20 2020 2020 2020 2020 2020 2066   (.            f
+00038880: 2257 6169 7465 6420 666f 7220 7b6c 656e  "Waited for {len
+00038890: 2877 6f72 6b65 7273 297d 2077 6f72 6b65  (workers)} worke
+000388a0: 7228 7329 2074 6f20 7265 636f 6e6e 6563  r(s) to reconnec
+000388b0: 7420 6166 7465 7220 7265 7374 6172 7469  t after restarti
+000388c0: 6e67 2062 7574 2c20 220a 2020 2020 2020  ng but, ".      
+000388d0: 2020 2020 2020 6622 6166 7465 7220 7b74        f"after {t
+000388e0: 696d 656f 7574 7d73 2c20 7b6e 5f77 6f72  imeout}s, {n_wor
+000388f0: 6b65 7273 202d 206c 656e 2873 656c 662e  kers - len(self.
+00038900: 776f 726b 6572 7329 7d20 6861 7665 206e  workers)} have n
+00038910: 6f74 2072 6574 7572 6e65 642e 2022 0a20  ot returned. ". 
+00038920: 2020 2020 2020 2020 2020 2022 436f 6e73             "Cons
+00038930: 6964 6572 2061 206c 6f6e 6765 7220 7469  ider a longer ti
+00038940: 6d65 6f75 742c 206f 7220 6077 6169 745f  meout, or `wait_
+00038950: 666f 725f 776f 726b 6572 733d 4661 6c73  for_workers=Fals
+00038960: 6560 2e22 0a20 2020 2020 2020 2029 0a20  e`.".        ). 
+00038970: 2020 2020 2020 2069 6620 6e6f 5f6e 616e         if no_nan
+00038980: 6e79 5f77 6f72 6b65 7273 3a0a 2020 2020  ny_workers:.    
+00038990: 2020 2020 2020 2020 6d73 6720 2b3d 2028          msg += (
+000389a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000389b0: 2066 2220 5468 6520 7b6c 656e 286e 6f5f   f" The {len(no_
+000389c0: 6e61 6e6e 795f 776f 726b 6572 7329 7d20  nanny_workers)} 
+000389d0: 776f 726b 6572 2873 2920 6e6f 7420 7573  worker(s) not us
+000389e0: 696e 6720 4e61 6e6e 6965 7320 7765 7265  ing Nannies were
+000389f0: 206a 7573 7420 7368 7574 2022 0a20 2020   just shut ".   
+00038a00: 2020 2020 2020 2020 2020 2020 2022 646f               "do
+00038a10: 776e 2069 6e73 7465 6164 206f 6620 7265  wn instead of re
+00038a20: 7374 6172 7465 6420 2872 6573 7461 7274  started (restart
+00038a30: 2069 7320 6f6e 6c79 2070 6f73 7369 626c   is only possibl
+00038a40: 6520 7769 7468 204e 616e 6e69 6573 292e  e with Nannies).
+00038a50: 2049 6620 220a 2020 2020 2020 2020 2020   If ".          
+00038a60: 2020 2020 2020 2279 6f75 7220 6465 706c        "your depl
+00038a70: 6f79 6d65 6e74 2073 7973 7465 6d20 646f  oyment system do
+00038a80: 6573 206e 6f74 2061 7574 6f6d 6174 6963  es not automatic
+00038a90: 616c 6c79 2072 652d 6c61 756e 6368 2074  ally re-launch t
+00038aa0: 6572 6d69 6e61 7465 6420 220a 2020 2020  erminated ".    
+00038ab0: 2020 2020 2020 2020 2020 2020 2270 726f              "pro
+00038ac0: 6365 7373 6573 2c20 7468 656e 2074 686f  cesses, then tho
+00038ad0: 7365 2077 6f72 6b65 7273 2077 696c 6c20  se workers will 
+00038ae0: 6e65 7665 7220 636f 6d65 2062 6163 6b2c  never come back,
+00038af0: 2061 6e64 2060 436c 6965 6e74 2e72 6573   and `Client.res
+00038b00: 7461 7274 6020 220a 2020 2020 2020 2020  tart` ".        
+00038b10: 2020 2020 2020 2020 2277 696c 6c20 616c          "will al
+00038b20: 7761 7973 2074 696d 6520 6f75 742e 2044  ways time out. D
+00038b30: 6f20 6e6f 7420 7573 6520 6043 6c69 656e  o not use `Clien
+00038b40: 742e 7265 7374 6172 7460 2069 6e20 7468  t.restart` in th
+00038b50: 6174 2063 6173 652e 220a 2020 2020 2020  at case.".      
+00038b60: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00038b70: 2069 6620 6f6e 5f65 7272 6f72 203d 3d20   if on_error == 
+00038b80: 2272 6169 7365 223a 0a20 2020 2020 2020  "raise":.       
+00038b90: 2020 2020 2072 6169 7365 2054 696d 656f       raise Timeo
+00038ba0: 7574 4572 726f 7228 6d73 6729 0a20 2020  utError(msg).   
+00038bb0: 2020 2020 206c 6f67 6765 722e 6572 726f       logger.erro
+00038bc0: 7228 6622 7b6d 7367 7d20 287b 7374 696d  r(f"{msg} ({stim
+00038bd0: 756c 7573 5f69 643d 7d29 2229 0a0a 2020  ulus_id=})")..  
+00038be0: 2020 2020 2020 6e65 775f 6e61 6e6e 6965        new_nannie
+00038bf0: 7320 3d20 7b77 732e 6e61 6e6e 7920 666f  s = {ws.nanny fo
+00038c00: 7220 7773 2069 6e20 7365 6c66 2e77 6f72  r ws in self.wor
+00038c10: 6b65 7273 2e76 616c 7565 7328 2920 6966  kers.values() if
+00038c20: 2077 732e 6e61 6e6e 797d 0a20 2020 2020   ws.nanny}.     
+00038c30: 2020 2066 6f72 2077 6f72 6b65 725f 6164     for worker_ad
+00038c40: 6472 2c20 6e61 6e6e 795f 6164 6472 2069  dr, nanny_addr i
+00038c50: 6e20 6e61 6e6e 795f 776f 726b 6572 732e  n nanny_workers.
+00038c60: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00038c70: 2020 2020 2069 6620 6e61 6e6e 795f 6164       if nanny_ad
+00038c80: 6472 206e 6f74 2069 6e20 6e65 775f 6e61  dr not in new_na
+00038c90: 6e6e 6965 733a 0a20 2020 2020 2020 2020  nnies:.         
+00038ca0: 2020 2020 2020 206f 7574 5b77 6f72 6b65         out[worke
+00038cb0: 725f 6164 6472 5d20 3d20 2274 696d 6564  r_addr] = "timed
+00038cc0: 206f 7574 220a 0a20 2020 2020 2020 2072   out"..        r
+00038cd0: 6574 7572 6e20 6f75 740a 0a20 2020 2061  eturn out..    a
+00038ce0: 7379 6e63 2064 6566 2062 726f 6164 6361  sync def broadca
+00038cf0: 7374 280a 2020 2020 2020 2020 7365 6c66  st(.        self
+00038d00: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+00038d10: 2020 2020 206d 7367 3a20 6469 6374 2c0a       msg: dict,.
+00038d20: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
+00038d30: 2043 6f6c 6c65 6374 696f 6e5b 7374 725d   Collection[str]
+00038d40: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00038d50: 2020 2020 2020 2020 686f 7374 733a 2043          hosts: C
+00038d60: 6f6c 6c65 6374 696f 6e5b 7374 725d 207c  ollection[str] |
+00038d70: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00038d80: 2020 2020 2020 6e61 6e6e 793a 2062 6f6f        nanny: boo
+00038d90: 6c20 3d20 4661 6c73 652c 0a20 2020 2020  l = False,.     
+00038da0: 2020 2073 6572 6961 6c69 7a65 7273 3a20     serializers: 
+00038db0: 416e 7920 3d20 4e6f 6e65 2c0a 2020 2020  Any = None,.    
+00038dc0: 2020 2020 6f6e 5f65 7272 6f72 3a20 4c69      on_error: Li
+00038dd0: 7465 7261 6c5b 2272 6169 7365 222c 2022  teral["raise", "
+00038de0: 7265 7475 726e 222c 2022 7265 7475 726e  return", "return
+00038df0: 5f70 6963 6b6c 6522 2c20 2269 676e 6f72  _pickle", "ignor
+00038e00: 6522 5d20 3d20 2272 6169 7365 222c 0a20  e"] = "raise",. 
+00038e10: 2020 2029 202d 3e20 6469 6374 5b73 7472     ) -> dict[str
+00038e20: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
+00038e30: 2222 2242 726f 6164 6361 7374 206d 6573  """Broadcast mes
+00038e40: 7361 6765 2074 6f20 776f 726b 6572 732c  sage to workers,
+00038e50: 2072 6574 7572 6e20 616c 6c20 7265 7375   return all resu
+00038e60: 6c74 7322 2222 0a20 2020 2020 2020 2069  lts""".        i
+00038e70: 6620 776f 726b 6572 7320 6973 204e 6f6e  f workers is Non
+00038e80: 653a 0a20 2020 2020 2020 2020 2020 2069  e:.            i
+00038e90: 6620 686f 7374 7320 6973 204e 6f6e 653a  f hosts is None:
+00038ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00038eb0: 2077 6f72 6b65 7273 203d 206c 6973 7428   workers = list(
+00038ec0: 7365 6c66 2e77 6f72 6b65 7273 290a 2020  self.workers).  
+00038ed0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00038ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038ef0: 776f 726b 6572 7320 3d20 5b5d 0a20 2020  workers = [].   
+00038f00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00038f10: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
+00038f20: 206c 6973 7428 776f 726b 6572 7329 0a20   list(workers). 
+00038f30: 2020 2020 2020 2069 6620 686f 7374 7320         if hosts 
+00038f40: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00038f50: 2020 2020 2020 2020 2066 6f72 2068 6f73           for hos
+00038f60: 7420 696e 2068 6f73 7473 3a0a 2020 2020  t in hosts:.    
+00038f70: 2020 2020 2020 2020 2020 2020 6468 203d              dh =
+00038f80: 2073 656c 662e 686f 7374 5f69 6e66 6f2e   self.host_info.
+00038f90: 6765 7428 686f 7374 290a 2020 2020 2020  get(host).      
+00038fa0: 2020 2020 2020 2020 2020 6966 2064 6820            if dh 
+00038fb0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00038fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00038fd0: 2077 6f72 6b65 7273 2e65 7874 656e 6428   workers.extend(
+00038fe0: 6468 5b22 6164 6472 6573 7365 7322 5d29  dh["addresses"])
+00038ff0: 0a0a 2020 2020 2020 2020 6966 206e 616e  ..        if nan
+00039000: 6e79 3a0a 2020 2020 2020 2020 2020 2020  ny:.            
+00039010: 6164 6472 6573 7365 7320 3d20 5b6e 2066  addresses = [n f
+00039020: 6f72 2077 2069 6e20 776f 726b 6572 7320  or w in workers 
+00039030: 6966 2028 6e20 3a3d 2073 656c 662e 776f  if (n := self.wo
+00039040: 726b 6572 735b 775d 2e6e 616e 6e79 2920  rkers[w].nanny) 
+00039050: 6973 206e 6f74 204e 6f6e 655d 0a20 2020  is not None].   
+00039060: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00039070: 2020 2020 2020 2061 6464 7265 7373 6573         addresses
+00039080: 203d 2077 6f72 6b65 7273 0a0a 2020 2020   = workers..    
+00039090: 2020 2020 4552 524f 5220 3d20 6f62 6a65      ERROR = obje
+000390a0: 6374 2829 0a0a 2020 2020 2020 2020 6173  ct()..        as
+000390b0: 796e 6320 6465 6620 7365 6e64 5f6d 6573  ync def send_mes
+000390c0: 7361 6765 2861 6464 7229 3a0a 2020 2020  sage(addr):.    
+000390d0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000390e0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
+000390f0: 6d20 3d20 6177 6169 7420 7365 6c66 2e72  m = await self.r
+00039100: 7063 2e63 6f6e 6e65 6374 2861 6464 7229  pc.connect(addr)
+00039110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00039120: 2063 6f6d 6d2e 6e61 6d65 203d 2022 5363   comm.name = "Sc
+00039130: 6865 6475 6c65 7220 4272 6f61 6463 6173  heduler Broadcas
+00039140: 7422 0a20 2020 2020 2020 2020 2020 2020  t".             
+00039150: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00039160: 2020 2020 2020 2020 2020 2020 7265 7370              resp
+00039170: 203d 2061 7761 6974 2073 656e 645f 7265   = await send_re
+00039180: 6376 280a 2020 2020 2020 2020 2020 2020  cv(.            
+00039190: 2020 2020 2020 2020 2020 2020 636f 6d6d              comm
+000391a0: 2c20 636c 6f73 653d 5472 7565 2c20 7365  , close=True, se
+000391b0: 7269 616c 697a 6572 733d 7365 7269 616c  rializers=serial
+000391c0: 697a 6572 732c 202a 2a6d 7367 0a20 2020  izers, **msg.   
+000391d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000391e0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+000391f0: 2020 2066 696e 616c 6c79 3a0a 2020 2020     finally:.    
+00039200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039210: 7365 6c66 2e72 7063 2e72 6575 7365 2861  self.rpc.reuse(a
+00039220: 6464 722c 2063 6f6d 6d29 0a20 2020 2020  ddr, comm).     
+00039230: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00039240: 6e20 7265 7370 0a20 2020 2020 2020 2020  n resp.         
+00039250: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
+00039260: 696f 6e20 6173 2065 3a0a 2020 2020 2020  ion as e:.      
+00039270: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00039280: 2e65 7272 6f72 2866 2262 726f 6164 6361  .error(f"broadca
+00039290: 7374 2074 6f20 7b61 6464 727d 2066 6169  st to {addr} fai
+000392a0: 6c65 643a 207b 652e 5f5f 636c 6173 735f  led: {e.__class_
+000392b0: 5f2e 5f5f 6e61 6d65 5f5f 7d3a 207b 657d  _.__name__}: {e}
+000392c0: 2229 0a20 2020 2020 2020 2020 2020 2020  ").             
+000392d0: 2020 2069 6620 6f6e 5f65 7272 6f72 203d     if on_error =
+000392e0: 3d20 2272 6169 7365 223a 0a20 2020 2020  = "raise":.     
+000392f0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00039300: 6169 7365 0a20 2020 2020 2020 2020 2020  aise.           
+00039310: 2020 2020 2065 6c69 6620 6f6e 5f65 7272       elif on_err
+00039320: 6f72 203d 3d20 2272 6574 7572 6e22 3a0a  or == "return":.
+00039330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039340: 2020 2020 7265 7475 726e 2065 0a20 2020      return e.   
+00039350: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00039360: 6620 6f6e 5f65 7272 6f72 203d 3d20 2272  f on_error == "r
+00039370: 6574 7572 6e5f 7069 636b 6c65 223a 0a20  eturn_pickle":. 
+00039380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039390: 2020 2072 6574 7572 6e20 6475 6d70 7328     return dumps(
+000393a0: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+000393b0: 2020 2065 6c69 6620 6f6e 5f65 7272 6f72     elif on_error
+000393c0: 203d 3d20 2269 676e 6f72 6522 3a0a 2020   == "ignore":.  
+000393d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000393e0: 2020 7265 7475 726e 2045 5252 4f52 0a20    return ERROR. 
+000393f0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00039400: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00039410: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00039420: 616c 7565 4572 726f 7228 0a20 2020 2020  alueError(.     
+00039430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00039440: 2020 2022 6f6e 5f65 7272 6f72 206d 7573     "on_error mus
+00039450: 7420 6265 2027 7261 6973 6527 2c20 2772  t be 'raise', 'r
+00039460: 6574 7572 6e27 2c20 2772 6574 7572 6e5f  eturn', 'return_
+00039470: 7069 636b 6c65 272c 2022 0a20 2020 2020  pickle', ".     
 00039480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00039490: 6b65 7973 3d6c 6973 7428 6b65 7973 292c  keys=list(keys),
-000394a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000394b0: 2073 7469 6d75 6c75 735f 6964 3d66 2264   stimulus_id=f"d
-000394c0: 656c 6574 652d 6461 7461 2d7b 7469 6d65  elete-data-{time
-000394d0: 2829 7d22 2c0a 2020 2020 2020 2020 2020  ()}",.          
-000394e0: 2020 290a 2020 2020 2020 2020 6578 6365    ).        exce
-000394f0: 7074 204f 5345 7272 6f72 2061 7320 653a  pt OSError as e:
-00039500: 0a20 2020 2020 2020 2020 2020 2023 2054  .            # T
-00039510: 6869 7320 6361 6e20 6861 7070 656e 2065  his can happen e
-00039520: 2e67 2e20 6966 2074 6865 2077 6f72 6b65  .g. if the worke
-00039530: 7220 6973 2067 6f69 6e67 2074 6872 6f75  r is going throu
-00039540: 6768 2063 6f6e 7472 6f6c 6c65 6420 7368  gh controlled sh
-00039550: 7574 646f 776e 3b0a 2020 2020 2020 2020  utdown;.        
-00039560: 2020 2020 2320 6974 2064 6f65 736e 2774      # it doesn't
-00039570: 206e 6563 6573 7361 7269 6c79 206d 6561   necessarily mea
-00039580: 6e20 7468 6174 2069 7420 7765 6e74 2075  n that it went u
-00039590: 6e65 7870 6563 7465 646c 7920 6d69 7373  nexpectedly miss
-000395a0: 696e 670a 2020 2020 2020 2020 2020 2020  ing.            
-000395b0: 6c6f 6767 6572 2e77 6172 6e69 6e67 280a  logger.warning(.
-000395c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000395d0: 6622 436f 6d6d 756e 6963 6174 696f 6e20  f"Communication 
-000395e0: 7769 7468 2077 6f72 6b65 7220 7b77 6f72  with worker {wor
-000395f0: 6b65 725f 6164 6472 6573 737d 2066 6169  ker_address} fai
-00039600: 6c65 6420 6475 7269 6e67 2022 0a20 2020  led during ".   
-00039610: 2020 2020 2020 2020 2020 2020 2066 2272               f"r
-00039620: 6570 6c69 6361 7469 6f6e 3a20 7b65 2e5f  eplication: {e._
-00039630: 5f63 6c61 7373 5f5f 2e5f 5f6e 616d 655f  _class__.__name_
-00039640: 5f7d 3a20 7b65 7d22 0a20 2020 2020 2020  _}: {e}".       
-00039650: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00039660: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
-00039670: 2020 2077 7320 3d20 7365 6c66 2e77 6f72     ws = self.wor
-00039680: 6b65 7273 2e67 6574 2877 6f72 6b65 725f  kers.get(worker_
-00039690: 6164 6472 6573 7329 0a20 2020 2020 2020  address).       
-000396a0: 2069 6620 6e6f 7420 7773 3a0a 2020 2020   if not ws:.    
-000396b0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-000396c0: 2020 2020 2020 2020 666f 7220 6b65 7920          for key 
-000396d0: 696e 206b 6579 733a 0a20 2020 2020 2020  in keys:.       
-000396e0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-000396f0: 6173 6b73 2e67 6574 286b 6579 290a 2020  asks.get(key).  
-00039700: 2020 2020 2020 2020 2020 6966 2074 7320            if ts 
-00039710: 6973 206e 6f74 204e 6f6e 6520 616e 6420  is not None and 
-00039720: 7773 2069 6e20 2874 732e 7768 6f5f 6861  ws in (ts.who_ha
-00039730: 7320 6f72 2028 2929 3a0a 2020 2020 2020  s or ()):.      
-00039740: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00039750: 2074 732e 7374 6174 6520 3d3d 2022 6d65   ts.state == "me
-00039760: 6d6f 7279 220a 2020 2020 2020 2020 2020  mory".          
-00039770: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
-00039780: 655f 7265 706c 6963 6128 7473 2c20 7773  e_replica(ts, ws
-00039790: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000397a0: 2020 6966 206e 6f74 2074 732e 7768 6f5f    if not ts.who_
-000397b0: 6861 733a 0a20 2020 2020 2020 2020 2020  has:.           
-000397c0: 2020 2020 2020 2020 2023 204c 6173 7420           # Last 
-000397d0: 636f 7079 2064 656c 6574 6564 0a20 2020  copy deleted.   
-000397e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000397f0: 2073 656c 662e 7472 616e 7369 7469 6f6e   self.transition
-00039800: 7328 7b6b 6579 3a20 2272 656c 6561 7365  s({key: "release
-00039810: 6422 7d2c 2073 7469 6d75 6c75 735f 6964  d"}, stimulus_id
-00039820: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-00039830: 6c6f 675f 6576 656e 7428 7773 2e61 6464  log_event(ws.add
-00039840: 7265 7373 2c20 7b22 6163 7469 6f6e 223a  ress, {"action":
-00039850: 2022 7265 6d6f 7665 2d77 6f72 6b65 722d   "remove-worker-
-00039860: 6461 7461 222c 2022 6b65 7973 223a 206b  data", "keys": k
-00039870: 6579 737d 290a 0a20 2020 2040 6c6f 675f  eys})..    @log_
-00039880: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
-00039890: 2064 6566 2072 6562 616c 616e 6365 280a   def rebalance(.
-000398a0: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-000398b0: 2020 2020 2020 6b65 7973 3a20 4974 6572        keys: Iter
-000398c0: 6162 6c65 5b4b 6579 5d20 7c20 4e6f 6e65  able[Key] | None
-000398d0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-000398e0: 2077 6f72 6b65 7273 3a20 4974 6572 6162   workers: Iterab
-000398f0: 6c65 5b73 7472 5d20 7c20 4e6f 6e65 203d  le[str] | None =
-00039900: 204e 6f6e 652c 0a20 2020 2020 2020 2073   None,.        s
-00039910: 7469 6d75 6c75 735f 6964 3a20 7374 7220  timulus_id: str 
-00039920: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00039930: 2020 2029 202d 3e20 6469 6374 3a0a 2020     ) -> dict:.  
-00039940: 2020 2020 2020 2222 2252 6562 616c 616e        """Rebalan
-00039950: 6365 206b 6579 7320 736f 2074 6861 7420  ce keys so that 
-00039960: 6561 6368 2077 6f72 6b65 7220 656e 6473  each worker ends
-00039970: 2075 7020 7769 7468 2072 6f75 6768 6c79   up with roughly
-00039980: 2074 6865 2073 616d 6520 7072 6f63 6573   the same proces
-00039990: 730a 2020 2020 2020 2020 6d65 6d6f 7279  s.        memory
-000399a0: 2028 6d61 6e61 6765 642b 756e 6d61 6e61   (managed+unmana
-000399b0: 6765 6429 2e0a 0a20 2020 2020 2020 202e  ged)...        .
-000399c0: 2e20 7761 726e 696e 673a 3a0a 2020 2020  . warning::.    
-000399d0: 2020 2020 2020 2054 6869 7320 6f70 6572         This oper
-000399e0: 6174 696f 6e20 6973 2067 656e 6572 616c  ation is general
-000399f0: 6c79 206e 6f74 2077 656c 6c20 7465 7374  ly not well test
-00039a00: 6564 2061 6761 696e 7374 206e 6f72 6d61  ed against norma
-00039a10: 6c20 6f70 6572 6174 696f 6e20 6f66 2074  l operation of t
-00039a20: 6865 0a20 2020 2020 2020 2020 2020 7363  he.           sc
-00039a30: 6865 6475 6c65 722e 2049 7420 6973 206e  heduler. It is n
-00039a40: 6f74 2072 6563 6f6d 6d65 6e64 6564 2074  ot recommended t
-00039a50: 6f20 7573 6520 6974 2077 6869 6c65 2077  o use it while w
-00039a60: 6169 7469 6e67 206f 6e20 636f 6d70 7574  aiting on comput
-00039a70: 6174 696f 6e73 2e0a 0a20 2020 2020 2020  ations...       
-00039a80: 202a 2a41 6c67 6f72 6974 686d 2a2a 0a0a   **Algorithm**..
-00039a90: 2020 2020 2020 2020 232e 2046 696e 6420          #. Find 
-00039aa0: 7468 6520 6d65 616e 206f 6363 7570 616e  the mean occupan
-00039ab0: 6379 206f 6620 7468 6520 636c 7573 7465  cy of the cluste
-00039ac0: 722c 2064 6566 696e 6564 2061 7320 6461  r, defined as da
-00039ad0: 7461 206d 616e 6167 6564 2062 7920 6461  ta managed by da
-00039ae0: 736b 202b 0a20 2020 2020 2020 2020 2020  sk +.           
-00039af0: 756e 6d61 6e61 6765 6420 7072 6f63 6573  unmanaged proces
-00039b00: 7320 6d65 6d6f 7279 2074 6861 7420 6861  s memory that ha
-00039b10: 7320 6265 656e 2074 6865 7265 2066 6f72  s been there for
-00039b20: 2061 7420 6c65 6173 7420 3330 2073 6563   at least 30 sec
-00039b30: 6f6e 6473 0a20 2020 2020 2020 2020 2020  onds.           
-00039b40: 2860 6064 6973 7472 6962 7574 6564 2e77  (``distributed.w
-00039b50: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6563  orker.memory.rec
-00039b60: 656e 742d 746f 2d6f 6c64 2d74 696d 6560  ent-to-old-time`
-00039b70: 6029 2e0a 2020 2020 2020 2020 2020 2054  `)..           T
-00039b80: 6869 7320 6c65 7473 2075 7320 6967 6e6f  his lets us igno
-00039b90: 7265 2074 656d 706f 7261 7279 2073 7069  re temporary spi
-00039ba0: 6b65 7320 6361 7573 6564 2062 7920 7461  kes caused by ta
-00039bb0: 736b 2068 6561 7020 7573 6167 652e 0a0a  sk heap usage...
-00039bc0: 2020 2020 2020 2020 2020 2041 6c74 6572             Alter
-00039bd0: 6e61 7469 7665 6c79 2c20 796f 7520 6d61  natively, you ma
-00039be0: 7920 6368 616e 6765 2068 6f77 206d 656d  y change how mem
-00039bf0: 6f72 7920 6973 206d 6561 7375 7265 6420  ory is measured 
-00039c00: 626f 7468 2066 6f72 2074 6865 2069 6e64  both for the ind
-00039c10: 6976 6964 7561 6c0a 2020 2020 2020 2020  ividual.        
-00039c20: 2020 2077 6f72 6b65 7273 2061 7320 7765     workers as we
-00039c30: 6c6c 2061 7320 746f 2063 616c 6375 6c61  ll as to calcula
-00039c40: 7465 2074 6865 206d 6561 6e20 7468 726f  te the mean thro
-00039c50: 7567 680a 2020 2020 2020 2020 2020 2060  ugh.           `
-00039c60: 6064 6973 7472 6962 7574 6564 2e77 6f72  `distributed.wor
-00039c70: 6b65 722e 6d65 6d6f 7279 2e72 6562 616c  ker.memory.rebal
-00039c80: 616e 6365 2e6d 6561 7375 7265 6060 2e20  ance.measure``. 
-00039c90: 4e61 6d65 6c79 2c20 7468 6973 2063 616e  Namely, this can
-00039ca0: 2062 6520 7573 6566 756c 0a20 2020 2020   be useful.     
-00039cb0: 2020 2020 2020 746f 2064 6973 7265 6761        to disrega
-00039cc0: 7264 2069 6e61 6363 7572 6174 6520 4f53  rd inaccurate OS
-00039cd0: 206d 656d 6f72 7920 6d65 6173 7572 656d   memory measurem
-00039ce0: 656e 7473 2e0a 0a20 2020 2020 2020 2023  ents...        #
-00039cf0: 2e20 4469 7363 6172 6420 776f 726b 6572  . Discard worker
-00039d00: 7320 7768 6f73 6520 6f63 6375 7061 6e63  s whose occupanc
-00039d10: 7920 6973 2077 6974 6869 6e20 3525 206f  y is within 5% o
-00039d20: 6620 7468 6520 6d65 616e 2063 6c75 7374  f the mean clust
-00039d30: 6572 206f 6363 7570 616e 6379 0a20 2020  er occupancy.   
-00039d40: 2020 2020 2020 2020 2860 6064 6973 7472          (``distr
-00039d50: 6962 7574 6564 2e77 6f72 6b65 722e 6d65  ibuted.worker.me
-00039d60: 6d6f 7279 2e72 6562 616c 616e 6365 2e73  mory.rebalance.s
-00039d70: 656e 6465 722d 7265 6369 7069 656e 742d  ender-recipient-
-00039d80: 6761 7060 6020 2f20 3229 2e0a 2020 2020  gap`` / 2)..    
-00039d90: 2020 2020 2020 2054 6869 7320 6865 6c70         This help
-00039da0: 7320 6176 6f69 6420 6461 7461 2066 726f  s avoid data fro
-00039db0: 6d20 626f 756e 6369 6e67 2061 726f 756e  m bouncing aroun
-00039dc0: 6420 7468 6520 636c 7573 7465 7220 7265  d the cluster re
-00039dd0: 7065 6174 6564 6c79 2e0a 2020 2020 2020  peatedly..      
-00039de0: 2020 232e 2057 6f72 6b65 7273 2061 626f    #. Workers abo
-00039df0: 7665 2074 6865 206d 6561 6e20 6172 6520  ve the mean are 
-00039e00: 7365 6e64 6572 733b 2074 686f 7365 2062  senders; those b
-00039e10: 656c 6f77 2061 7265 2072 6563 6970 6965  elow are recipie
-00039e20: 6e74 732e 0a20 2020 2020 2020 2023 2e20  nts..        #. 
-00039e30: 4469 7363 6172 6420 7365 6e64 6572 7320  Discard senders 
-00039e40: 7768 6f73 6520 6162 736f 6c75 7465 206f  whose absolute o
-00039e50: 6363 7570 616e 6379 2069 7320 6265 6c6f  ccupancy is belo
-00039e60: 7720 3330 250a 2020 2020 2020 2020 2020  w 30%.          
-00039e70: 2028 6060 6469 7374 7269 6275 7465 642e   (``distributed.
-00039e80: 776f 726b 6572 2e6d 656d 6f72 792e 7265  worker.memory.re
-00039e90: 6261 6c61 6e63 652e 7365 6e64 6572 2d6d  balance.sender-m
-00039ea0: 696e 6060 292e 2049 6e20 6f74 6865 7220  in``). In other 
-00039eb0: 776f 7264 732c 206e 6f20 6461 7461 0a20  words, no data. 
-00039ec0: 2020 2020 2020 2020 2020 6973 206d 6f76            is mov
-00039ed0: 6564 2072 6567 6172 646c 6573 7320 6f66  ed regardless of
-00039ee0: 2069 6d62 616c 616e 6369 6e67 2061 7320   imbalancing as 
-00039ef0: 6c6f 6e67 2061 7320 616c 6c20 776f 726b  long as all work
-00039f00: 6572 7320 6172 6520 6265 6c6f 7720 3330  ers are below 30
-00039f10: 252e 0a20 2020 2020 2020 2023 2e20 4469  %..        #. Di
-00039f20: 7363 6172 6420 7265 6369 7069 656e 7473  scard recipients
-00039f30: 2077 686f 7365 2061 6273 6f6c 7574 6520   whose absolute 
-00039f40: 6f63 6375 7061 6e63 7920 6973 2061 626f  occupancy is abo
-00039f50: 7665 2036 3025 0a20 2020 2020 2020 2020  ve 60%.         
-00039f60: 2020 2860 6064 6973 7472 6962 7574 6564    (``distributed
-00039f70: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
-00039f80: 6562 616c 616e 6365 2e72 6563 6970 6965  ebalance.recipie
-00039f90: 6e74 2d6d 6178 6060 292e 0a20 2020 2020  nt-max``)..     
-00039fa0: 2020 2020 2020 4e6f 7465 2074 6861 7420        Note that 
-00039fb0: 7468 6973 2074 6872 6573 686f 6c64 2062  this threshold b
-00039fc0: 7920 6465 6661 756c 7420 6973 2074 6865  y default is the
-00039fd0: 2073 616d 6520 6173 0a20 2020 2020 2020   same as.       
-00039fe0: 2020 2020 6060 6469 7374 7269 6275 7465      ``distribute
-00039ff0: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
-0003a000: 7461 7267 6574 6060 2074 6f20 7072 6576  target`` to prev
-0003a010: 656e 7420 776f 726b 6572 7320 6672 6f6d  ent workers from
-0003a020: 2061 6363 6570 7469 6e67 2064 6174 610a   accepting data.
-0003a030: 2020 2020 2020 2020 2020 2061 6e64 2069             and i
-0003a040: 6d6d 6564 6961 7465 6c79 2073 7069 6c6c  mmediately spill
-0003a050: 696e 6720 6974 206f 7574 2074 6f20 6469  ing it out to di
-0003a060: 736b 2e0a 2020 2020 2020 2020 232e 2049  sk..        #. I
-0003a070: 7465 7261 7469 7665 6c79 2070 6963 6b20  teratively pick 
-0003a080: 7468 6520 7365 6e64 6572 2061 6e64 2072  the sender and r
-0003a090: 6563 6970 6965 6e74 2074 6861 7420 6172  ecipient that ar
-0003a0a0: 6520 6661 7274 6865 7374 2066 726f 6d20  e farthest from 
-0003a0b0: 7468 6520 6d65 616e 2061 6e64 0a20 2020  the mean and.   
-0003a0c0: 2020 2020 2020 2020 6d6f 7665 2074 6865          move the
-0003a0d0: 202a 6c65 6173 7420 7265 6365 6e74 6c79   *least recently
-0003a0e0: 2069 6e73 6572 7465 642a 206b 6579 2062   inserted* key b
-0003a0f0: 6574 7765 656e 2074 6865 2074 776f 2c20  etween the two, 
-0003a100: 756e 7469 6c20 6569 7468 6572 2061 6c6c  until either all
-0003a110: 0a20 2020 2020 2020 2020 2020 7365 6e64  .           send
-0003a120: 6572 7320 6f72 2061 6c6c 2072 6563 6970  ers or all recip
-0003a130: 6965 6e74 7320 6661 6c6c 2077 6974 6869  ients fall withi
-0003a140: 6e20 3525 206f 6620 7468 6520 6d65 616e  n 5% of the mean
-0003a150: 2e0a 0a20 2020 2020 2020 2020 2020 4120  ...           A 
-0003a160: 7265 6369 7069 656e 7420 7769 6c6c 2062  recipient will b
-0003a170: 6520 736b 6970 7065 6420 6966 2069 7420  e skipped if it 
-0003a180: 616c 7265 6164 7920 6861 7320 6120 636f  already has a co
-0003a190: 7079 206f 6620 7468 6520 6461 7461 2e20  py of the data. 
-0003a1a0: 496e 206f 7468 6572 0a20 2020 2020 2020  In other.       
-0003a1b0: 2020 2020 776f 7264 732c 2074 6869 7320      words, this 
-0003a1c0: 6d65 7468 6f64 2064 6f65 7320 6e6f 7420  method does not 
-0003a1d0: 6465 6772 6164 6520 7265 706c 6963 6174  degrade replicat
-0003a1e0: 696f 6e2e 0a20 2020 2020 2020 2020 2020  ion..           
-0003a1f0: 4120 6b65 7920 7769 6c6c 2062 6520 736b  A key will be sk
-0003a200: 6970 7065 6420 6966 2074 6865 7265 2061  ipped if there a
-0003a210: 7265 206e 6f20 7265 6369 7069 656e 7473  re no recipients
-0003a220: 2061 7661 696c 6162 6c65 2077 6974 6820   available with 
-0003a230: 656e 6f75 6768 206d 656d 6f72 790a 2020  enough memory.  
-0003a240: 2020 2020 2020 2020 2074 6f20 6163 6365           to acce
-0003a250: 7074 2074 6865 206b 6579 2061 6e64 2074  pt the key and t
-0003a260: 6861 7420 646f 6e27 7420 616c 7265 6164  hat don't alread
-0003a270: 7920 686f 6c64 2061 2063 6f70 792e 0a0a  y hold a copy...
-0003a280: 2020 2020 2020 2020 5468 6520 6c65 6173          The leas
-0003a290: 7420 7265 6365 6e74 6c79 2069 6e73 6572  t recently inser
-0003a2a0: 7464 2028 4c52 4929 2070 6f6c 6963 7920  td (LRI) policy 
-0003a2b0: 6973 2061 2067 7265 6564 7920 6368 6f69  is a greedy choi
-0003a2c0: 6365 2077 6974 6820 7468 6520 6164 7661  ce with the adva
-0003a2d0: 6e74 6167 6520 6f66 0a20 2020 2020 2020  ntage of.       
-0003a2e0: 2062 6569 6e67 204f 2831 292c 2074 7269   being O(1), tri
-0003a2f0: 7669 616c 2074 6f20 696d 706c 656d 656e  vial to implemen
-0003a300: 7420 2869 7420 7265 6c69 6573 206f 6e20  t (it relies on 
-0003a310: 7079 7468 6f6e 2064 6963 7420 696e 7365  python dict inse
-0003a320: 7274 696f 6e2d 736f 7274 696e 6729 0a20  rtion-sorting). 
-0003a330: 2020 2020 2020 2061 6e64 2068 6f70 6566         and hopef
-0003a340: 756c 6c79 2067 6f6f 6420 656e 6f75 6768  ully good enough
-0003a350: 2069 6e20 6d6f 7374 2063 6173 6573 2e20   in most cases. 
-0003a360: 4469 7363 6172 6465 6420 616c 7465 726e  Discarded altern
-0003a370: 6174 6976 6520 706f 6c69 6369 6573 2077  ative policies w
-0003a380: 6572 653a 0a0a 2020 2020 2020 2020 2d20  ere:..        - 
-0003a390: 4c61 7267 6573 7420 6669 7273 742e 204f  Largest first. O
-0003a3a0: 286e 2a6c 6f67 286e 2929 2073 6176 6520  (n*log(n)) save 
-0003a3b0: 666f 7220 6e6f 6e2d 7472 6976 6961 6c20  for non-trivial 
-0003a3c0: 6164 6469 7469 6f6e 616c 2064 6174 6120  additional data 
-0003a3d0: 7374 7275 6374 7572 6573 2061 6e64 0a20  structures and. 
-0003a3e0: 2020 2020 2020 2020 2072 6973 6b73 2063           risks c
-0003a3f0: 6175 7369 6e67 2074 6865 206c 6172 6765  ausing the large
-0003a400: 7374 2063 6875 6e6b 7320 6f66 2064 6174  st chunks of dat
-0003a410: 6120 746f 2072 6570 6561 7465 646c 7920  a to repeatedly 
-0003a420: 6d6f 7665 2061 726f 756e 6420 7468 650a  move around the.
-0003a430: 2020 2020 2020 2020 2020 636c 7573 7465            cluste
-0003a440: 7220 6c69 6b65 2070 696e 6261 6c6c 732e  r like pinballs.
-0003a450: 0a20 2020 2020 2020 202d 204c 6561 7374  .        - Least
-0003a460: 2072 6563 656e 746c 7920 7573 6564 2028   recently used (
-0003a470: 4c52 5529 2e20 5468 6973 2069 6e66 6f72  LRU). This infor
-0003a480: 6d61 7469 6f6e 2069 7320 6375 7272 656e  mation is curren
-0003a490: 746c 7920 6176 6169 6c61 626c 6520 6f6e  tly available on
-0003a4a0: 2074 6865 0a20 2020 2020 2020 2020 2077   the.          w
-0003a4b0: 6f72 6b65 7273 206f 6e6c 7920 616e 6420  orkers only and 
-0003a4c0: 6e6f 7420 7472 6976 6961 6c20 746f 2072  not trivial to r
-0003a4d0: 6570 6c69 6361 7465 206f 6e20 7468 6520  eplicate on the 
-0003a4e0: 7363 6865 6475 6c65 723b 2074 7261 6e73  scheduler; trans
-0003a4f0: 6d69 7474 696e 6720 6974 0a20 2020 2020  mitting it.     
-0003a500: 2020 2020 206f 7665 7220 7468 6520 6e65       over the ne
-0003a510: 7477 6f72 6b20 776f 756c 6420 6265 2076  twork would be v
-0003a520: 6572 7920 6578 7065 6e73 6976 652e 2041  ery expensive. A
-0003a530: 6c73 6f2c 206e 6f74 6520 7468 6174 2064  lso, note that d
-0003a540: 6173 6b20 7769 6c6c 2067 6f20 6f75 7420  ask will go out 
-0003a550: 6f66 0a20 2020 2020 2020 2020 2069 7473  of.          its
-0003a560: 2077 6179 2074 6f20 6d69 6e69 6d69 7365   way to minimise
-0003a570: 2074 6865 2061 6d6f 756e 7420 6f66 2074   the amount of t
-0003a580: 696d 6520 696e 7465 726d 6564 6961 7465  ime intermediate
-0003a590: 206b 6579 7320 6172 6520 6865 6c64 2069   keys are held i
-0003a5a0: 6e20 6d65 6d6f 7279 2c0a 2020 2020 2020  n memory,.      
-0003a5b0: 2020 2020 736f 2069 6e20 7375 6368 2061      so in such a
-0003a5c0: 2063 6173 6520 4c52 4920 6973 2061 2063   case LRI is a c
-0003a5d0: 6c6f 7365 2061 7070 726f 7869 6d61 7469  lose approximati
-0003a5e0: 6f6e 206f 6620 4c52 552e 0a0a 2020 2020  on of LRU...    
-0003a5f0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0003a600: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
-0003a610: 2d0a 2020 2020 2020 2020 6b65 7973 3a20  -.        keys: 
-0003a620: 6f70 7469 6f6e 616c 0a20 2020 2020 2020  optional.       
-0003a630: 2020 2020 2061 6c6c 6f77 6c69 7374 206f       allowlist o
-0003a640: 6620 6461 736b 206b 6579 7320 7468 6174  f dask keys that
-0003a650: 2073 686f 756c 6420 6265 2063 6f6e 7369   should be consi
-0003a660: 6465 7265 6420 666f 7220 6d6f 7669 6e67  dered for moving
-0003a670: 2e20 416c 6c20 6f74 6865 7220 6b65 7973  . All other keys
-0003a680: 0a20 2020 2020 2020 2020 2020 2077 696c  .            wil
-0003a690: 6c20 6265 2069 676e 6f72 6564 2e20 4e6f  l be ignored. No
-0003a6a0: 7465 2074 6861 7420 7468 6973 206f 6666  te that this off
-0003a6b0: 6572 7320 6e6f 2067 7561 7261 6e74 6565  ers no guarantee
-0003a6c0: 2074 6861 7420 6120 6b65 7920 7769 6c6c   that a key will
-0003a6d0: 2061 6374 7561 6c6c 790a 2020 2020 2020   actually.      
-0003a6e0: 2020 2020 2020 6265 206d 6f76 6564 2028        be moved (
-0003a6f0: 652e 672e 2062 6563 6175 7365 2069 7420  e.g. because it 
-0003a700: 6973 2075 6e6e 6563 6573 7361 7279 206f  is unnecessary o
-0003a710: 7220 6265 6361 7573 6520 7468 6572 6520  r because there 
-0003a720: 6172 6520 6e6f 2076 6961 626c 650a 2020  are no viable.  
-0003a730: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
-0003a740: 656e 7420 776f 726b 6572 7320 666f 7220  ent workers for 
-0003a750: 6974 292e 0a20 2020 2020 2020 2077 6f72  it)..        wor
-0003a760: 6b65 7273 3a20 6f70 7469 6f6e 616c 0a20  kers: optional. 
-0003a770: 2020 2020 2020 2020 2020 2061 6c6c 6f77             allow
-0003a780: 6c69 7374 206f 6620 776f 726b 6572 7320  list of workers 
-0003a790: 6164 6472 6573 7365 7320 746f 2062 6520  addresses to be 
-0003a7a0: 636f 6e73 6964 6572 6564 2061 7320 7365  considered as se
-0003a7b0: 6e64 6572 7320 6f72 2072 6563 6970 6965  nders or recipie
-0003a7c0: 6e74 732e 0a20 2020 2020 2020 2020 2020  nts..           
-0003a7d0: 2041 6c6c 206f 7468 6572 2077 6f72 6b65   All other worke
-0003a7e0: 7273 2077 696c 6c20 6265 2069 676e 6f72  rs will be ignor
-0003a7f0: 6564 2e20 5468 6520 6d65 616e 2063 6c75  ed. The mean clu
-0003a800: 7374 6572 206f 6363 7570 616e 6379 2077  ster occupancy w
-0003a810: 696c 6c20 6265 0a20 2020 2020 2020 2020  ill be.         
-0003a820: 2020 2063 616c 6375 6c61 7465 6420 6f6e     calculated on
-0003a830: 6c79 2075 7369 6e67 2074 6865 2061 6c6c  ly using the all
-0003a840: 6f77 6564 2077 6f72 6b65 7273 2e0a 2020  owed workers..  
-0003a850: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0003a860: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-0003a870: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
-0003a880: 2272 6562 616c 616e 6365 2d7b 7469 6d65  "rebalance-{time
-0003a890: 2829 7d22 0a0a 2020 2020 2020 2020 7773  ()}"..        ws
-0003a8a0: 733a 2043 6f6c 6c65 6374 696f 6e5b 576f  s: Collection[Wo
-0003a8b0: 726b 6572 5374 6174 655d 0a20 2020 2020  rkerState].     
-0003a8c0: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
-0003a8d0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-0003a8e0: 2020 2020 2020 2077 7373 203d 205b 7365         wss = [se
-0003a8f0: 6c66 2e77 6f72 6b65 7273 5b77 5d20 666f  lf.workers[w] fo
-0003a900: 7220 7720 696e 2077 6f72 6b65 7273 5d0a  r w in workers].
-0003a910: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-0003a920: 2020 2020 2020 2020 2020 7773 7320 3d20            wss = 
-0003a930: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-0003a940: 7565 7328 290a 2020 2020 2020 2020 6966  ues().        if
-0003a950: 206e 6f74 2077 7373 3a0a 2020 2020 2020   not wss:.      
-0003a960: 2020 2020 2020 7265 7475 726e 207b 2273        return {"s
-0003a970: 7461 7475 7322 3a20 224f 4b22 7d0a 0a20  tatus": "OK"}.. 
-0003a980: 2020 2020 2020 2069 6620 6b65 7973 2069         if keys i
-0003a990: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-0003a9a0: 2020 2020 2020 2020 6966 206e 6f74 2069          if not i
-0003a9b0: 7369 6e73 7461 6e63 6528 6b65 7973 2c20  sinstance(keys, 
-0003a9c0: 5365 7429 3a0a 2020 2020 2020 2020 2020  Set):.          
-0003a9d0: 2020 2020 2020 6b65 7973 203d 2073 6574        keys = set
-0003a9e0: 286b 6579 7329 2020 2320 756e 6c65 7373  (keys)  # unless
-0003a9f0: 2061 6c72 6561 6479 2061 2073 6574 2d6c   already a set-l
-0003aa00: 696b 650a 2020 2020 2020 2020 2020 2020  ike.            
-0003aa10: 6966 206e 6f74 206b 6579 733a 0a20 2020  if not keys:.   
-0003aa20: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0003aa30: 7572 6e20 7b22 7374 6174 7573 223a 2022  urn {"status": "
-0003aa40: 4f4b 227d 0a20 2020 2020 2020 2020 2020  OK"}.           
-0003aa50: 206d 6973 7369 6e67 5f64 6174 6120 3d20   missing_data = 
-0003aa60: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-0003aa70: 2020 6b20 666f 7220 6b20 696e 206b 6579    k for k in key
-0003aa80: 7320 6966 206b 206e 6f74 2069 6e20 7365  s if k not in se
-0003aa90: 6c66 2e74 6173 6b73 206f 7220 6e6f 7420  lf.tasks or not 
-0003aaa0: 7365 6c66 2e74 6173 6b73 5b6b 5d2e 7768  self.tasks[k].wh
-0003aab0: 6f5f 6861 730a 2020 2020 2020 2020 2020  o_has.          
-0003aac0: 2020 5d0a 2020 2020 2020 2020 2020 2020    ].            
-0003aad0: 6966 206d 6973 7369 6e67 5f64 6174 613a  if missing_data:
-0003aae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003aaf0: 2072 6574 7572 6e20 7b22 7374 6174 7573   return {"status
-0003ab00: 223a 2022 7061 7274 6961 6c2d 6661 696c  ": "partial-fail
-0003ab10: 222c 2022 6b65 7973 223a 206d 6973 7369  ", "keys": missi
-0003ab20: 6e67 5f64 6174 617d 0a0a 2020 2020 2020  ng_data}..      
-0003ab30: 2020 6d73 6773 203d 2073 656c 662e 5f72    msgs = self._r
-0003ab40: 6562 616c 616e 6365 5f66 696e 645f 6d73  ebalance_find_ms
-0003ab50: 6773 286b 6579 732c 2077 7373 290a 2020  gs(keys, wss).  
-0003ab60: 2020 2020 2020 6966 206e 6f74 206d 7367        if not msg
-0003ab70: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
-0003ab80: 6574 7572 6e20 7b22 7374 6174 7573 223a  eturn {"status":
-0003ab90: 2022 4f4b 227d 0a0a 2020 2020 2020 2020   "OK"}..        
-0003aba0: 2320 446f 776e 6772 6164 6520 7265 656e  # Downgrade reen
-0003abb0: 7472 616e 7420 6c6f 636b 2074 6f20 6e6f  trant lock to no
-0003abc0: 6e2d 7265 656e 7472 616e 740a 2020 2020  n-reentrant.    
-0003abd0: 2020 2020 6173 796e 6320 7769 7468 2073      async with s
-0003abe0: 656c 662e 5f72 6570 6c69 6361 5f6c 6f63  elf._replica_loc
-0003abf0: 6b28 2822 7265 6261 6c61 6e63 6522 2c20  k(("rebalance", 
-0003ac00: 6f62 6a65 6374 2829 2929 3a0a 2020 2020  object())):.    
-0003ac10: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
-0003ac20: 2061 7761 6974 2073 656c 662e 5f72 6562   await self._reb
-0003ac30: 616c 616e 6365 5f6d 6f76 655f 6461 7461  alance_move_data
-0003ac40: 286d 7367 732c 2073 7469 6d75 6c75 735f  (msgs, stimulus_
-0003ac50: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
-0003ac60: 6966 2072 6573 756c 745b 2273 7461 7475  if result["statu
-0003ac70: 7322 5d20 3d3d 2022 7061 7274 6961 6c2d  s"] == "partial-
-0003ac80: 6661 696c 2220 616e 6420 6b65 7973 2069  fail" and keys i
-0003ac90: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
-0003aca0: 2020 2020 2020 2020 2320 4f6e 6c79 2072          # Only r
-0003acb0: 6574 7572 6e20 6661 696c 6564 206b 6579  eturn failed key
-0003acc0: 7320 6966 2074 6865 2063 6c69 656e 7420  s if the client 
-0003acd0: 6578 706c 6963 6974 6c79 2061 736b 6564  explicitly asked
-0003ace0: 2066 6f72 2074 6865 6d0a 2020 2020 2020   for them.      
-0003acf0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
-0003ad00: 203d 207b 2273 7461 7475 7322 3a20 224f   = {"status": "O
-0003ad10: 4b22 7d0a 2020 2020 2020 2020 2020 2020  K"}.            
-0003ad20: 7265 7475 726e 2072 6573 756c 740a 0a20  return result.. 
-0003ad30: 2020 2064 6566 205f 7265 6261 6c61 6e63     def _rebalanc
-0003ad40: 655f 6669 6e64 5f6d 7367 7328 0a20 2020  e_find_msgs(.   
-0003ad50: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0003ad60: 2020 206b 6579 733a 2053 6574 5b48 6173     keys: Set[Has
-0003ad70: 6861 626c 655d 207c 204e 6f6e 652c 0a20  hable] | None,. 
-0003ad80: 2020 2020 2020 2077 6f72 6b65 7273 3a20         workers: 
-0003ad90: 4974 6572 6162 6c65 5b57 6f72 6b65 7253  Iterable[WorkerS
-0003ada0: 7461 7465 5d2c 0a20 2020 2029 202d 3e20  tate],.    ) -> 
-0003adb0: 6c69 7374 5b74 7570 6c65 5b57 6f72 6b65  list[tuple[Worke
-0003adc0: 7253 7461 7465 2c20 576f 726b 6572 5374  rState, WorkerSt
-0003add0: 6174 652c 2054 6173 6b53 7461 7465 5d5d  ate, TaskState]]
-0003ade0: 3a0a 2020 2020 2020 2020 2222 2249 6465  :.        """Ide
-0003adf0: 6e74 6966 7920 776f 726b 6572 7320 7468  ntify workers th
-0003ae00: 6174 206e 6565 6420 746f 206c 6f73 6520  at need to lose 
-0003ae10: 6b65 7973 2061 6e64 2074 686f 7365 2074  keys and those t
-0003ae20: 6861 7420 6361 6e20 7265 6365 6976 6520  hat can receive 
-0003ae30: 7468 656d 2c0a 2020 2020 2020 2020 746f  them,.        to
-0003ae40: 6765 7468 6572 2077 6974 6820 686f 7720  gether with how 
-0003ae50: 6d61 6e79 2062 7974 6573 2065 6163 6820  many bytes each 
-0003ae60: 6e65 6564 7320 746f 206c 6f73 652f 7265  needs to lose/re
-0003ae70: 6365 6976 652e 2054 6865 6e2c 2070 6169  ceive. Then, pai
-0003ae80: 7220 6120 7365 6e64 6572 0a20 2020 2020  r a sender.     
-0003ae90: 2020 2077 6f72 6b65 7220 7769 7468 2061     worker with a
-0003aea0: 2072 6563 6970 6965 6e74 2077 6f72 6b65   recipient worke
-0003aeb0: 7220 666f 7220 6561 6368 206b 6579 2c20  r for each key, 
-0003aec0: 756e 7469 6c20 7468 6520 636c 7573 7465  until the cluste
-0003aed0: 7220 6973 2072 6562 616c 616e 6365 642e  r is rebalanced.
-0003aee0: 0a0a 2020 2020 2020 2020 5468 6973 206d  ..        This m
-0003aef0: 6574 686f 6420 6f6e 6c79 2064 6566 696e  ethod only defin
-0003af00: 6573 2074 6865 2077 6f72 6b20 746f 2062  es the work to b
-0003af10: 6520 7065 7266 6f72 6d65 643b 2069 7420  e performed; it 
-0003af20: 646f 6573 206e 6f74 2073 7461 7274 2061  does not start a
-0003af30: 6e79 206e 6574 776f 726b 0a20 2020 2020  ny network.     
-0003af40: 2020 2074 7261 6e73 6665 7273 2069 7473     transfers its
-0003af50: 656c 662e 0a0a 2020 2020 2020 2020 5468  elf...        Th
-0003af60: 6520 6269 672d 4f20 636f 6d70 6c65 7869  e big-O complexi
-0003af70: 7479 2069 7320 4f28 7774 202b 206b 652a  ty is O(wt + ke*
-0003af80: 6c6f 6728 7765 2929 2c20 7768 6572 650a  log(we)), where.
-0003af90: 0a20 2020 2020 2020 202d 2077 7420 6973  .        - wt is
-0003afa0: 2074 6865 2074 6f74 616c 206e 756d 6265   the total numbe
-0003afb0: 7220 6f66 2077 6f72 6b65 7273 206f 6e20  r of workers on 
-0003afc0: 7468 6520 636c 7573 7465 7220 286f 7220  the cluster (or 
-0003afd0: 7468 6520 6e75 6d62 6572 206f 6620 616c  the number of al
-0003afe0: 6c6f 7765 640a 2020 2020 2020 2020 2020  lowed.          
-0003aff0: 776f 726b 6572 732c 2069 6620 6578 706c  workers, if expl
-0003b000: 6963 6974 6c79 2073 7461 7465 6420 6279  icitly stated by
-0003b010: 2074 6865 2075 7365 7229 0a20 2020 2020   the user).     
-0003b020: 2020 202d 2077 6520 6973 2074 6865 206e     - we is the n
-0003b030: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
-0003b040: 2074 6861 7420 6172 6520 656c 6967 6962   that are eligib
-0003b050: 6c65 2074 6f20 6265 2073 656e 6465 7273  le to be senders
-0003b060: 206f 7220 7265 6369 7069 656e 7473 0a20   or recipients. 
-0003b070: 2020 2020 2020 202d 206b 7420 6973 2074         - kt is t
-0003b080: 6865 2074 6f74 616c 206e 756d 6265 7220  he total number 
-0003b090: 6f66 206b 6579 7320 6f6e 2074 6865 2063  of keys on the c
-0003b0a0: 6c75 7374 6572 2028 6f72 206f 6e20 7468  luster (or on th
-0003b0b0: 6520 616c 6c6f 7765 6420 776f 726b 6572  e allowed worker
-0003b0c0: 7329 0a20 2020 2020 2020 202d 206b 6520  s).        - ke 
-0003b0d0: 6973 2074 6865 206e 756d 6265 7220 6f66  is the number of
-0003b0e0: 206b 6579 7320 7468 6174 206e 6565 6420   keys that need 
-0003b0f0: 746f 2062 6520 6d6f 7665 6420 696e 206f  to be moved in o
-0003b100: 7264 6572 2074 6f20 6163 6869 6576 6520  rder to achieve 
-0003b110: 6120 6261 6c61 6e63 6564 0a20 2020 2020  a balanced.     
-0003b120: 2020 2020 2063 6c75 7374 6572 0a0a 2020       cluster..  
-0003b130: 2020 2020 2020 5468 6572 6520 6973 2061        There is a
-0003b140: 2064 6567 656e 6572 6174 6520 6564 6765   degenerate edge
-0003b150: 2063 6173 6520 4f28 7774 202b 206b 742a   case O(wt + kt*
-0003b160: 6c6f 6728 7765 2929 2077 6865 6e20 6b74  log(we)) when kt
-0003b170: 2069 7320 6d75 6368 2067 7265 6174 6572   is much greater
-0003b180: 2074 6861 6e0a 2020 2020 2020 2020 7468   than.        th
-0003b190: 6520 6e75 6d62 6572 206f 6620 616c 6c6f  e number of allo
-0003b1a0: 7765 6420 6b65 7973 2c20 6f72 2077 6865  wed keys, or whe
-0003b1b0: 6e20 6d6f 7374 206b 6579 7320 6172 6520  n most keys are 
-0003b1c0: 7265 706c 6963 6174 6564 206f 7220 6361  replicated or ca
-0003b1d0: 6e6e 6f74 2062 650a 2020 2020 2020 2020  nnot be.        
-0003b1e0: 6d6f 7665 6420 666f 7220 736f 6d65 206f  moved for some o
-0003b1f0: 7468 6572 2072 6561 736f 6e2e 0a0a 2020  ther reason...  
-0003b200: 2020 2020 2020 5265 7475 726e 7320 6c69        Returns li
-0003b210: 7374 206f 6620 7475 706c 6573 2074 6f20  st of tuples to 
-0003b220: 6665 6564 2069 6e74 6f20 5f72 6562 616c  feed into _rebal
-0003b230: 616e 6365 5f6d 6f76 655f 6461 7461 3a0a  ance_move_data:.
-0003b240: 0a20 2020 2020 2020 202d 2073 656e 6465  .        - sende
-0003b250: 7220 776f 726b 6572 0a20 2020 2020 2020  r worker.       
-0003b260: 202d 2072 6563 6970 6965 6e74 2077 6f72   - recipient wor
-0003b270: 6b65 720a 2020 2020 2020 2020 2d20 7461  ker.        - ta
-0003b280: 736b 2074 6f20 6265 2074 7261 6e73 6665  sk to be transfe
-0003b290: 7272 6564 0a20 2020 2020 2020 2022 2222  rred.        """
-0003b2a0: 0a20 2020 2020 2020 2023 2048 6561 7073  .        # Heaps
-0003b2b0: 206f 6620 776f 726b 6572 732c 206d 616e   of workers, man
-0003b2c0: 6167 6564 2062 7920 7468 6520 6865 6170  aged by the heap
-0003b2d0: 7120 6d6f 6475 6c65 2c20 7468 6174 206e  q module, that n
-0003b2e0: 6565 6420 746f 2073 656e 642f 7265 6365  eed to send/rece
-0003b2f0: 6976 6520 6461 7461 2c0a 2020 2020 2020  ive data,.      
-0003b300: 2020 2320 7769 7468 2068 6f77 206d 616e    # with how man
-0003b310: 7920 6279 7465 7320 6561 6368 206e 6565  y bytes each nee
-0003b320: 6473 2074 6f20 7365 6e64 2f72 6563 6569  ds to send/recei
-0003b330: 7665 2e0a 2020 2020 2020 2020 230a 2020  ve..        #.  
-0003b340: 2020 2020 2020 2320 4561 6368 2065 6c65        # Each ele
-0003b350: 6d65 6e74 206f 6620 7468 6520 6865 6170  ment of the heap
-0003b360: 2069 7320 6120 7475 706c 6520 636f 6e73   is a tuple cons
-0003b370: 7472 7563 7465 6420 6173 2066 6f6c 6c6f  tructed as follo
-0003b380: 7773 3a0a 2020 2020 2020 2020 2320 2d20  ws:.        # - 
-0003b390: 736e 645f 6279 7465 735f 6d61 782f 7265  snd_bytes_max/re
-0003b3a0: 635f 6279 7465 735f 6d61 783a 206d 6178  c_bytes_max: max
-0003b3b0: 696d 756d 206e 756d 6265 7220 6f66 2062  imum number of b
-0003b3c0: 7974 6573 2074 6f20 7365 6e64 206f 7220  ytes to send or 
-0003b3d0: 7265 6365 6976 652e 0a20 2020 2020 2020  receive..       
-0003b3e0: 2023 2020 2054 6869 7320 6e75 6d62 6572   #   This number
-0003b3f0: 2069 7320 6e65 6761 7469 7665 2c20 736f   is negative, so
-0003b400: 2074 6861 7420 7468 6520 776f 726b 6572   that the worker
-0003b410: 7320 6661 7274 6865 7374 2066 726f 6d20  s farthest from 
-0003b420: 7468 6520 636c 7573 7465 7220 6d65 616e  the cluster mean
-0003b430: 0a20 2020 2020 2020 2023 2020 2061 7265  .        #   are
-0003b440: 2061 7420 7468 6520 746f 7020 6f66 2074   at the top of t
-0003b450: 6865 2073 6d61 6c6c 6573 742d 6669 7273  he smallest-firs
-0003b460: 7420 6865 6170 732e 0a20 2020 2020 2020  t heaps..       
-0003b470: 2023 202d 2073 6e64 5f62 7974 6573 5f6d   # - snd_bytes_m
-0003b480: 696e 2f72 6563 5f62 7974 6573 5f6d 696e  in/rec_bytes_min
-0003b490: 3a20 6d69 6e69 6d75 6d20 6e75 6d62 6572  : minimum number
-0003b4a0: 206f 6620 6279 7465 7320 6166 7465 7220   of bytes after 
-0003b4b0: 7365 6e64 696e 672f 7265 6365 6976 696e  sending/receivin
-0003b4c0: 670a 2020 2020 2020 2020 2320 2020 7768  g.        #   wh
-0003b4d0: 6963 6820 7468 6520 776f 726b 6572 2073  ich the worker s
-0003b4e0: 686f 756c 6420 6e6f 7420 6265 2063 6f6e  hould not be con
-0003b4f0: 7369 6465 7265 6420 616e 796d 6f72 652e  sidered anymore.
-0003b500: 2054 6869 7320 6973 2061 6c73 6f20 6e65   This is also ne
-0003b510: 6761 7469 7665 2e0a 2020 2020 2020 2020  gative..        
-0003b520: 2320 2d20 6172 6269 7472 6172 7920 756e  # - arbitrary un
-0003b530: 6971 7565 206e 756d 6265 722c 2074 6865  ique number, the
-0003b540: 7265 206a 7573 7420 746f 2074 6f20 6d61  re just to to ma
-0003b550: 6b65 2073 7572 6520 7468 6174 2057 6f72  ke sure that Wor
-0003b560: 6b65 7253 7461 7465 206f 626a 6563 7473  kerState objects
-0003b570: 0a20 2020 2020 2020 2023 2020 2061 7265  .        #   are
-0003b580: 206e 6576 6572 2075 7365 6420 666f 7220   never used for 
-0003b590: 736f 7274 696e 6720 696e 2074 6865 2075  sorting in the u
-0003b5a0: 6e6c 696b 656c 7920 6576 656e 7420 7468  nlikely event th
-0003b5b0: 6174 2074 776f 2070 726f 6365 7373 6573  at two processes
-0003b5c0: 2068 6176 650a 2020 2020 2020 2020 2320   have.        # 
-0003b5d0: 2020 6578 6163 746c 7920 7468 6520 7361    exactly the sa
-0003b5e0: 6d65 206e 756d 6265 7220 6f66 2062 7974  me number of byt
-0003b5f0: 6573 2061 6c6c 6f63 6174 6564 2e0a 2020  es allocated..  
-0003b600: 2020 2020 2020 2320 2d20 576f 726b 6572        # - Worker
-0003b610: 5374 6174 650a 2020 2020 2020 2020 2320  State.        # 
-0003b620: 2d20 6974 6572 6174 6f72 206f 6620 616c  - iterator of al
-0003b630: 6c20 7461 736b 7320 696e 206d 656d 6f72  l tasks in memor
-0003b640: 7920 6f6e 2074 6865 2077 6f72 6b65 7220  y on the worker 
-0003b650: 2873 656e 6465 7273 206f 6e6c 7929 2c20  (senders only), 
-0003b660: 696e 7365 7274 696f 6e0a 2020 2020 2020  insertion.      
-0003b670: 2020 2320 2020 736f 7274 6564 2028 6c65    #   sorted (le
-0003b680: 6173 7420 7265 6365 6e74 6c79 2069 6e73  ast recently ins
-0003b690: 6572 7465 6420 6669 7273 7429 2e0a 2020  erted first)..  
-0003b6a0: 2020 2020 2020 2320 2020 4e6f 7465 2074        #   Note t
-0003b6b0: 6861 7420 7468 6973 2069 7465 7261 746f  hat this iterato
-0003b6c0: 7220 7769 6c6c 2074 7970 6963 616c 6c79  r will typically
-0003b6d0: 202a 6e6f 742a 2062 6520 6578 6861 7573   *not* be exhaus
-0003b6e0: 7465 642e 2049 7420 7769 6c6c 206f 6e6c  ted. It will onl
-0003b6f0: 7920 6265 0a20 2020 2020 2020 2023 2020  y be.        #  
-0003b700: 2065 7868 6175 7374 6564 2069 662c 2061   exhausted if, a
-0003b710: 6674 6572 206d 6f76 696e 6720 6177 6179  fter moving away
-0003b720: 2066 726f 6d20 7468 6520 776f 726b 6572   from the worker
-0003b730: 2061 6c6c 206b 6579 7320 7468 6174 2063   all keys that c
-0003b740: 616e 2062 6520 6d6f 7665 642c 0a20 2020  an be moved,.   
-0003b750: 2020 2020 2023 2020 2069 7320 696e 7375       #   is insu
-0003b760: 6666 6963 6965 6e74 2074 6f20 6472 6f70  fficient to drop
-0003b770: 2073 6e64 5f62 7974 6573 5f6d 696e 2061   snd_bytes_min a
-0003b780: 626f 7665 2030 2e0a 2020 2020 2020 2020  bove 0..        
-0003b790: 7365 6e64 6572 733a 206c 6973 745b 7475  senders: list[tu
-0003b7a0: 706c 655b 696e 742c 2069 6e74 2c20 696e  ple[int, int, in
-0003b7b0: 742c 2057 6f72 6b65 7253 7461 7465 2c20  t, WorkerState, 
-0003b7c0: 4974 6572 6174 6f72 5b54 6173 6b53 7461  Iterator[TaskSta
-0003b7d0: 7465 5d5d 5d20 3d20 5b5d 0a20 2020 2020  te]]] = [].     
-0003b7e0: 2020 2072 6563 6970 6965 6e74 733a 206c     recipients: l
-0003b7f0: 6973 745b 7475 706c 655b 696e 742c 2069  ist[tuple[int, i
-0003b800: 6e74 2c20 696e 742c 2057 6f72 6b65 7253  nt, int, WorkerS
-0003b810: 7461 7465 5d5d 203d 205b 5d0a 0a20 2020  tate]] = []..   
-0003b820: 2020 2020 2023 204f 7574 7075 743a 205b       # Output: [
-0003b830: 2873 656e 6465 722c 2072 6563 6970 6965  (sender, recipie
-0003b840: 6e74 2c20 7461 736b 292c 202e 2e2e 5d0a  nt, task), ...].
-0003b850: 2020 2020 2020 2020 6d73 6773 3a20 6c69          msgs: li
-0003b860: 7374 5b74 7570 6c65 5b57 6f72 6b65 7253  st[tuple[WorkerS
-0003b870: 7461 7465 2c20 576f 726b 6572 5374 6174  tate, WorkerStat
-0003b880: 652c 2054 6173 6b53 7461 7465 5d5d 203d  e, TaskState]] =
-0003b890: 205b 5d0a 0a20 2020 2020 2020 2023 2042   []..        # B
-0003b8a0: 7920 6465 6661 756c 742c 2074 6869 7320  y default, this 
-0003b8b0: 6973 2074 6865 206f 7074 696d 6973 7469  is the optimisti
-0003b8c0: 6320 6d65 6d6f 7279 2c20 6d65 616e 696e  c memory, meanin
-0003b8d0: 6720 746f 7461 6c20 7072 6f63 6573 7320  g total process 
-0003b8e0: 6d65 6d6f 7279 206d 696e 7573 0a20 2020  memory minus.   
-0003b8f0: 2020 2020 2023 2075 6e6d 616e 6167 6564       # unmanaged
-0003b900: 206d 656d 6f72 7920 7468 6174 2061 7070   memory that app
-0003b910: 6561 7265 6420 6f76 6572 2074 6865 206c  eared over the l
-0003b920: 6173 7420 3330 2073 6563 6f6e 6473 0a20  ast 30 seconds. 
-0003b930: 2020 2020 2020 2023 2028 6469 7374 7269         # (distri
-0003b940: 6275 7465 642e 776f 726b 6572 2e6d 656d  buted.worker.mem
-0003b950: 6f72 792e 7265 6365 6e74 2d74 6f2d 6f6c  ory.recent-to-ol
-0003b960: 642d 7469 6d65 292e 0a20 2020 2020 2020  d-time)..       
-0003b970: 2023 2054 6869 7320 6c65 7473 2075 7320   # This lets us 
-0003b980: 6967 6e6f 7265 2074 656d 706f 7261 7279  ignore temporary
-0003b990: 2073 7069 6b65 7320 6361 7573 6564 2062   spikes caused b
-0003b9a0: 7920 7461 736b 2068 6561 7020 7573 6167  y task heap usag
-0003b9b0: 652e 0a20 2020 2020 2020 206d 656d 6f72  e..        memor
-0003b9c0: 795f 6279 5f77 6f72 6b65 7220 3d20 5b0a  y_by_worker = [.
-0003b9d0: 2020 2020 2020 2020 2020 2020 2877 732c              (ws,
-0003b9e0: 2067 6574 6174 7472 2877 732e 6d65 6d6f   getattr(ws.memo
-0003b9f0: 7279 2c20 7365 6c66 2e4d 454d 4f52 595f  ry, self.MEMORY_
-0003ba00: 5245 4241 4c41 4e43 455f 4d45 4153 5552  REBALANCE_MEASUR
-0003ba10: 4529 2920 666f 7220 7773 2069 6e20 776f  E)) for ws in wo
-0003ba20: 726b 6572 730a 2020 2020 2020 2020 5d0a  rkers.        ].
-0003ba30: 2020 2020 2020 2020 6d65 616e 5f6d 656d          mean_mem
-0003ba40: 6f72 7920 3d20 7375 6d28 6d20 666f 7220  ory = sum(m for 
-0003ba50: 5f2c 206d 2069 6e20 6d65 6d6f 7279 5f62  _, m in memory_b
-0003ba60: 795f 776f 726b 6572 2920 2f2f 206c 656e  y_worker) // len
-0003ba70: 286d 656d 6f72 795f 6279 5f77 6f72 6b65  (memory_by_worke
-0003ba80: 7229 0a0a 2020 2020 2020 2020 666f 7220  r)..        for 
-0003ba90: 7773 2c20 7773 5f6d 656d 6f72 7920 696e  ws, ws_memory in
-0003baa0: 206d 656d 6f72 795f 6279 5f77 6f72 6b65   memory_by_worke
-0003bab0: 723a 0a20 2020 2020 2020 2020 2020 2069  r:.            i
-0003bac0: 6620 7773 2e6d 656d 6f72 795f 6c69 6d69  f ws.memory_limi
-0003bad0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
-0003bae0: 2020 2068 616c 665f 6761 7020 3d20 696e     half_gap = in
-0003baf0: 7428 7365 6c66 2e4d 454d 4f52 595f 5245  t(self.MEMORY_RE
-0003bb00: 4241 4c41 4e43 455f 4841 4c46 5f47 4150  BALANCE_HALF_GAP
-0003bb10: 202a 2077 732e 6d65 6d6f 7279 5f6c 696d   * ws.memory_lim
-0003bb20: 6974 290a 2020 2020 2020 2020 2020 2020  it).            
-0003bb30: 2020 2020 7365 6e64 6572 5f6d 696e 203d      sender_min =
-0003bb40: 2073 656c 662e 4d45 4d4f 5259 5f52 4542   self.MEMORY_REB
-0003bb50: 414c 414e 4345 5f53 454e 4445 525f 4d49  ALANCE_SENDER_MI
-0003bb60: 4e20 2a20 7773 2e6d 656d 6f72 795f 6c69  N * ws.memory_li
-0003bb70: 6d69 740a 2020 2020 2020 2020 2020 2020  mit.            
-0003bb80: 2020 2020 7265 6369 7069 656e 745f 6d61      recipient_ma
-0003bb90: 7820 3d20 7365 6c66 2e4d 454d 4f52 595f  x = self.MEMORY_
-0003bba0: 5245 4241 4c41 4e43 455f 5245 4349 5049  REBALANCE_RECIPI
-0003bbb0: 454e 545f 4d41 5820 2a20 7773 2e6d 656d  ENT_MAX * ws.mem
-0003bbc0: 6f72 795f 6c69 6d69 740a 2020 2020 2020  ory_limit.      
-0003bbd0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0003bbe0: 2020 2020 2020 2020 2020 2020 6861 6c66              half
-0003bbf0: 5f67 6170 203d 2030 0a20 2020 2020 2020  _gap = 0.       
-0003bc00: 2020 2020 2020 2020 2073 656e 6465 725f           sender_
-0003bc10: 6d69 6e20 3d20 302e 300a 2020 2020 2020  min = 0.0.      
-0003bc20: 2020 2020 2020 2020 2020 7265 6369 7069            recipi
-0003bc30: 656e 745f 6d61 7820 3d20 6d61 7468 2e69  ent_max = math.i
-0003bc40: 6e66 0a0a 2020 2020 2020 2020 2020 2020  nf..            
-0003bc50: 6966 2028 0a20 2020 2020 2020 2020 2020  if (.           
-0003bc60: 2020 2020 2077 732e 5f68 6173 5f77 6861       ws._has_wha
-0003bc70: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
-0003bc80: 2020 616e 6420 7773 5f6d 656d 6f72 7920    and ws_memory 
-0003bc90: 3e3d 206d 6561 6e5f 6d65 6d6f 7279 202b  >= mean_memory +
-0003bca0: 2068 616c 665f 6761 700a 2020 2020 2020   half_gap.      
-0003bcb0: 2020 2020 2020 2020 2020 616e 6420 7773            and ws
-0003bcc0: 5f6d 656d 6f72 7920 3e3d 2073 656e 6465  _memory >= sende
-0003bcd0: 725f 6d69 6e0a 2020 2020 2020 2020 2020  r_min.          
-0003bce0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-0003bcf0: 2020 2020 2023 2054 6869 7320 6d61 7920       # This may 
-0003bd00: 7365 6e64 2074 6865 2077 6f72 6b65 7220  send the worker 
-0003bd10: 6265 6c6f 7720 7365 6e64 6572 5f6d 696e  below sender_min
-0003bd20: 2028 6279 2064 6573 6967 6e29 0a20 2020   (by design).   
-0003bd30: 2020 2020 2020 2020 2020 2020 2073 6e64               snd
-0003bd40: 5f62 7974 6573 5f6d 6178 203d 206d 6561  _bytes_max = mea
-0003bd50: 6e5f 6d65 6d6f 7279 202d 2077 735f 6d65  n_memory - ws_me
-0003bd60: 6d6f 7279 2020 2320 6e65 6761 7469 7665  mory  # negative
-0003bd70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003bd80: 2073 6e64 5f62 7974 6573 5f6d 696e 203d   snd_bytes_min =
-0003bd90: 2073 6e64 5f62 7974 6573 5f6d 6178 202b   snd_bytes_max +
-0003bda0: 2068 616c 665f 6761 7020 2023 206e 6567   half_gap  # neg
-0003bdb0: 6174 6976 650a 2020 2020 2020 2020 2020  ative.          
-0003bdc0: 2020 2020 2020 2320 5365 6520 6465 6669        # See defi
-0003bdd0: 6e69 7469 6f6e 206f 6620 7365 6e64 6572  nition of sender
-0003bde0: 7320 6162 6f76 650a 2020 2020 2020 2020  s above.        
-0003bdf0: 2020 2020 2020 2020 7365 6e64 6572 732e          senders.
-0003be00: 6170 7065 6e64 280a 2020 2020 2020 2020  append(.        
-0003be10: 2020 2020 2020 2020 2020 2020 2873 6e64              (snd
-0003be20: 5f62 7974 6573 5f6d 6178 2c20 736e 645f  _bytes_max, snd_
-0003be30: 6279 7465 735f 6d69 6e2c 2069 6428 7773  bytes_min, id(ws
-0003be40: 292c 2077 732c 2069 7465 7228 7773 2e5f  ), ws, iter(ws._
-0003be50: 6861 735f 7768 6174 2929 0a20 2020 2020  has_what)).     
-0003be60: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0003be70: 2020 2020 2020 2020 2065 6c69 6620 7773           elif ws
-0003be80: 5f6d 656d 6f72 7920 3c20 6d65 616e 5f6d  _memory < mean_m
-0003be90: 656d 6f72 7920 2d20 6861 6c66 5f67 6170  emory - half_gap
-0003bea0: 2061 6e64 2077 735f 6d65 6d6f 7279 203c   and ws_memory <
-0003beb0: 2072 6563 6970 6965 6e74 5f6d 6178 3a0a   recipient_max:.
-0003bec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003bed0: 2320 5468 6973 206d 6179 2073 656e 6420  # This may send 
-0003bee0: 7468 6520 776f 726b 6572 2061 626f 7665  the worker above
-0003bef0: 2072 6563 6970 6965 6e74 5f6d 6178 2028   recipient_max (
-0003bf00: 6279 2064 6573 6967 6e29 0a20 2020 2020  by design).     
-0003bf10: 2020 2020 2020 2020 2020 2072 6563 5f62             rec_b
-0003bf20: 7974 6573 5f6d 6178 203d 2077 735f 6d65  ytes_max = ws_me
-0003bf30: 6d6f 7279 202d 206d 6561 6e5f 6d65 6d6f  mory - mean_memo
-0003bf40: 7279 2020 2320 6e65 6761 7469 7665 0a20  ry  # negative. 
-0003bf50: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-0003bf60: 6563 5f62 7974 6573 5f6d 696e 203d 2072  ec_bytes_min = r
-0003bf70: 6563 5f62 7974 6573 5f6d 6178 202b 2068  ec_bytes_max + h
-0003bf80: 616c 665f 6761 7020 2023 206e 6567 6174  alf_gap  # negat
-0003bf90: 6976 650a 2020 2020 2020 2020 2020 2020  ive.            
-0003bfa0: 2020 2020 2320 5365 6520 6465 6669 6e69      # See defini
-0003bfb0: 7469 6f6e 206f 6620 7265 6369 7069 656e  tion of recipien
-0003bfc0: 7473 2061 626f 7665 0a20 2020 2020 2020  ts above.       
-0003bfd0: 2020 2020 2020 2020 2072 6563 6970 6965           recipie
-0003bfe0: 6e74 732e 6170 7065 6e64 2828 7265 635f  nts.append((rec_
-0003bff0: 6279 7465 735f 6d61 782c 2072 6563 5f62  bytes_max, rec_b
-0003c000: 7974 6573 5f6d 696e 2c20 6964 2877 7329  ytes_min, id(ws)
-0003c010: 2c20 7773 2929 0a0a 2020 2020 2020 2020  , ws))..        
-0003c020: 2320 4661 7374 2065 7869 7420 696e 2063  # Fast exit in c
-0003c030: 6173 6520 6e6f 2074 7261 6e73 6665 7273  ase no transfers
-0003c040: 2061 7265 206e 6563 6573 7361 7279 206f   are necessary o
-0003c050: 7220 706f 7373 6962 6c65 0a20 2020 2020  r possible.     
-0003c060: 2020 2069 6620 6e6f 7420 7365 6e64 6572     if not sender
-0003c070: 7320 6f72 206e 6f74 2072 6563 6970 6965  s or not recipie
-0003c080: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
-0003c090: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-0003c0a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c0b0: 2022 616c 6c22 2c0a 2020 2020 2020 2020   "all",.        
-0003c0c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
-0003c0d0: 2020 2020 2020 2020 2020 2020 2020 2261                "a
-0003c0e0: 6374 696f 6e22 3a20 2272 6562 616c 616e  ction": "rebalan
-0003c0f0: 6365 222c 0a20 2020 2020 2020 2020 2020  ce",.           
-0003c100: 2020 2020 2020 2020 2022 7365 6e64 6572           "sender
-0003c110: 7322 3a20 6c65 6e28 7365 6e64 6572 7329  s": len(senders)
-0003c120: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0003c130: 2020 2020 2020 2272 6563 6970 6965 6e74        "recipient
-0003c140: 7322 3a20 6c65 6e28 7265 6369 7069 656e  s": len(recipien
-0003c150: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
-0003c160: 2020 2020 2020 2020 2022 6d6f 7665 645f           "moved_
-0003c170: 6b65 7973 223a 2030 2c0a 2020 2020 2020  keys": 0,.      
-0003c180: 2020 2020 2020 2020 2020 7d2c 0a20 2020            },.   
-0003c190: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0003c1a0: 2020 2020 2020 2072 6574 7572 6e20 5b5d         return []
-0003c1b0: 0a0a 2020 2020 2020 2020 6865 6170 712e  ..        heapq.
-0003c1c0: 6865 6170 6966 7928 7365 6e64 6572 7329  heapify(senders)
-0003c1d0: 0a20 2020 2020 2020 2068 6561 7071 2e68  .        heapq.h
-0003c1e0: 6561 7069 6679 2872 6563 6970 6965 6e74  eapify(recipient
-0003c1f0: 7329 0a0a 2020 2020 2020 2020 7768 696c  s)..        whil
-0003c200: 6520 7365 6e64 6572 7320 616e 6420 7265  e senders and re
-0003c210: 6369 7069 656e 7473 3a0a 2020 2020 2020  cipients:.      
-0003c220: 2020 2020 2020 736e 645f 6279 7465 735f        snd_bytes_
-0003c230: 6d61 782c 2073 6e64 5f62 7974 6573 5f6d  max, snd_bytes_m
-0003c240: 696e 2c20 5f2c 2073 6e64 5f77 732c 2074  in, _, snd_ws, t
-0003c250: 735f 6974 6572 203d 2073 656e 6465 7273  s_iter = senders
-0003c260: 5b30 5d0a 0a20 2020 2020 2020 2020 2020  [0]..           
-0003c270: 2023 2049 7465 7261 7465 2074 6872 6f75   # Iterate throu
-0003c280: 6768 2074 6173 6b73 2069 6e20 6d65 6d6f  gh tasks in memo
-0003c290: 7279 2c20 6c65 6173 7420 7265 6365 6e74  ry, least recent
-0003c2a0: 6c79 2069 6e73 6572 7465 6420 6669 7273  ly inserted firs
-0003c2b0: 740a 2020 2020 2020 2020 2020 2020 666f  t.            fo
-0003c2c0: 7220 7473 2069 6e20 7473 5f69 7465 723a  r ts in ts_iter:
-0003c2d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c2e0: 2069 6620 6b65 7973 2069 7320 6e6f 7420   if keys is not 
-0003c2f0: 4e6f 6e65 2061 6e64 2074 732e 6b65 7920  None and ts.key 
-0003c300: 6e6f 7420 696e 206b 6579 733a 0a20 2020  not in keys:.   
-0003c310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c320: 2063 6f6e 7469 6e75 650a 2020 2020 2020   continue.      
-0003c330: 2020 2020 2020 2020 2020 6e62 7974 6573            nbytes
-0003c340: 203d 2074 732e 6e62 7974 6573 0a20 2020   = ts.nbytes.   
-0003c350: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0003c360: 6e62 7974 6573 202b 2073 6e64 5f62 7974  nbytes + snd_byt
-0003c370: 6573 5f6d 6178 203e 2030 3a0a 2020 2020  es_max > 0:.    
-0003c380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c390: 2320 4d6f 7669 6e67 2074 6869 7320 7461  # Moving this ta
-0003c3a0: 736b 2077 6f75 6c64 2063 6175 7365 2074  sk would cause t
-0003c3b0: 6865 2073 656e 6465 7220 746f 2067 6f20  he sender to go 
-0003c3c0: 6265 6c6f 7720 6d65 616e 2061 6e64 0a20  below mean and. 
-0003c3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c3e0: 2020 2023 2070 6f74 656e 7469 616c 6c79     # potentially
-0003c3f0: 2072 6973 6b20 6265 636f 6d69 6e67 2061   risk becoming a
-0003c400: 2072 6563 6970 6965 6e74 2c20 7768 6963   recipient, whic
-0003c410: 6820 776f 756c 6420 6361 7573 6520 7461  h would cause ta
-0003c420: 736b 7320 746f 0a20 2020 2020 2020 2020  sks to.         
-0003c430: 2020 2020 2020 2020 2020 2023 2062 6f75             # bou
-0003c440: 6e63 6520 6172 6f75 6e64 2e20 4d6f 7665  nce around. Move
-0003c450: 206f 6e20 746f 2074 6865 206e 6578 7420   on to the next 
-0003c460: 7461 736b 206f 6620 7468 6520 7361 6d65  task of the same
-0003c470: 2073 656e 6465 722e 0a20 2020 2020 2020   sender..       
-0003c480: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0003c490: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
-0003c4a0: 2020 2020 2020 2023 2046 696e 6420 7468         # Find th
-0003c4b0: 6520 7265 6369 7069 656e 742c 2066 6172  e recipient, far
-0003c4c0: 7468 6573 7420 6672 6f6d 2074 6865 206d  thest from the m
-0003c4d0: 6561 6e2c 2077 6869 6368 0a20 2020 2020  ean, which.     
-0003c4e0: 2020 2020 2020 2020 2020 2023 2031 2e20             # 1. 
-0003c4f0: 6861 7320 656e 6f75 6768 2061 7661 696c  has enough avail
-0003c500: 6162 6c65 2052 414d 2066 6f72 2074 6869  able RAM for thi
-0003c510: 7320 7461 736b 2c20 616e 640a 2020 2020  s task, and.    
-0003c520: 2020 2020 2020 2020 2020 2020 2320 322e              # 2.
-0003c530: 2064 6f65 736e 2774 2068 6f6c 6420 6120   doesn't hold a 
-0003c540: 636f 7079 206f 6620 7468 6973 2074 6173  copy of this tas
-0003c550: 6b20 616c 7265 6164 790a 2020 2020 2020  k already.      
-0003c560: 2020 2020 2020 2020 2020 2320 5468 6572            # Ther
-0003c570: 6520 6d61 7920 6e6f 7420 6265 2061 6e79  e may not be any
-0003c580: 2074 6861 7420 7361 7469 7366 6965 7320   that satisfies 
-0003c590: 7468 6573 6520 636f 6e64 6974 696f 6e73  these conditions
-0003c5a0: 3b20 696e 2074 6869 7320 6361 7365 0a20  ; in this case. 
-0003c5b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0003c5c0: 2074 6869 7320 7461 736b 2077 6f6e 2774   this task won't
-0003c5d0: 2062 6520 6d6f 7665 642e 0a20 2020 2020   be moved..     
-0003c5e0: 2020 2020 2020 2020 2020 2073 6b69 7070             skipp
-0003c5f0: 6564 5f72 6563 6970 6965 6e74 7320 3d20  ed_recipients = 
-0003c600: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
-0003c610: 2020 2075 7365 5f72 6563 6970 6965 6e74     use_recipient
-0003c620: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0003c630: 2020 2020 2020 2020 2077 6869 6c65 2072           while r
-0003c640: 6563 6970 6965 6e74 7320 616e 6420 6e6f  ecipients and no
-0003c650: 7420 7573 655f 7265 6369 7069 656e 743a  t use_recipient:
-0003c660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003c670: 2020 2020 2072 6563 5f62 7974 6573 5f6d       rec_bytes_m
-0003c680: 6178 2c20 7265 635f 6279 7465 735f 6d69  ax, rec_bytes_mi
-0003c690: 6e2c 205f 2c20 7265 635f 7773 203d 2072  n, _, rec_ws = r
-0003c6a0: 6563 6970 6965 6e74 735b 305d 0a20 2020  ecipients[0].   
-0003c6b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c6c0: 2069 6620 6e62 7974 6573 202b 2072 6563   if nbytes + rec
-0003c6d0: 5f62 7974 6573 5f6d 6178 203e 2030 3a0a  _bytes_max > 0:.
-0003c6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c6f0: 2020 2020 2020 2020 2320 7265 6369 7069          # recipi
-0003c700: 656e 7473 2061 7265 2073 6f72 7465 6420  ents are sorted 
-0003c710: 6279 2072 6563 5f62 7974 6573 5f6d 6178  by rec_bytes_max
-0003c720: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003c730: 2020 2020 2020 2020 2020 2320 5468 6520            # The 
-0003c740: 6e65 7874 206f 6e65 7320 7769 6c6c 2062  next ones will b
-0003c750: 6520 776f 7273 653b 206e 6f20 7265 6173  e worse; no reas
-0003c760: 6f6e 2074 6f20 636f 6e74 696e 7565 2069  on to continue i
-0003c770: 7465 7261 7469 6e67 0a20 2020 2020 2020  terating.       
-0003c780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c790: 2062 7265 616b 0a20 2020 2020 2020 2020   break.         
-0003c7a0: 2020 2020 2020 2020 2020 2075 7365 5f72             use_r
-0003c7b0: 6563 6970 6965 6e74 203d 2074 7320 6e6f  ecipient = ts no
-0003c7c0: 7420 696e 2072 6563 5f77 732e 5f68 6173  t in rec_ws._has
-0003c7d0: 5f77 6861 740a 2020 2020 2020 2020 2020  _what.          
-0003c7e0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0003c7f0: 2075 7365 5f72 6563 6970 6965 6e74 3a0a   use_recipient:.
-0003c800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c810: 2020 2020 2020 2020 736b 6970 7065 645f          skipped_
-0003c820: 7265 6369 7069 656e 7473 2e61 7070 656e  recipients.appen
-0003c830: 6428 6865 6170 712e 6865 6170 706f 7028  d(heapq.heappop(
-0003c840: 7265 6369 7069 656e 7473 2929 0a0a 2020  recipients))..  
-0003c850: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0003c860: 7220 7265 6369 7069 656e 7420 696e 2073  r recipient in s
-0003c870: 6b69 7070 6564 5f72 6563 6970 6965 6e74  kipped_recipient
-0003c880: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
-0003c890: 2020 2020 2020 2068 6561 7071 2e68 6561         heapq.hea
-0003c8a0: 7070 7573 6828 7265 6369 7069 656e 7473  ppush(recipients
-0003c8b0: 2c20 7265 6369 7069 656e 7429 0a0a 2020  , recipient)..  
-0003c8c0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-0003c8d0: 206e 6f74 2075 7365 5f72 6563 6970 6965   not use_recipie
-0003c8e0: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
-0003c8f0: 2020 2020 2020 2020 2320 5468 6973 2074          # This t
-0003c900: 6173 6b20 6861 7320 6e6f 2072 6563 6970  ask has no recip
-0003c910: 6965 6e74 7320 6176 6169 6c61 626c 652e  ients available.
-0003c920: 204c 6561 7665 2069 7420 6f6e 2074 6865   Leave it on the
-0003c930: 2073 656e 6465 7220 616e 640a 2020 2020   sender and.    
-0003c940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c950: 2320 6d6f 7665 206f 6e20 746f 2074 6865  # move on to the
-0003c960: 206e 6578 7420 7461 736b 206f 6620 7468   next task of th
-0003c970: 6520 7361 6d65 2073 656e 6465 722e 0a20  e same sender.. 
-0003c980: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003c990: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
-0003c9a0: 2020 2020 2020 2020 2020 2020 2023 2053               # S
-0003c9b0: 6368 6564 756c 6520 7461 736b 2066 6f72  chedule task for
-0003c9c0: 2074 7261 6e73 6665 7220 6672 6f6d 2073   transfer from s
-0003c9d0: 656e 6465 7220 746f 2072 6563 6970 6965  ender to recipie
-0003c9e0: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
-0003c9f0: 2020 206d 7367 732e 6170 7065 6e64 2828     msgs.append((
-0003ca00: 736e 645f 7773 2c20 7265 635f 7773 2c20  snd_ws, rec_ws, 
-0003ca10: 7473 2929 0a0a 2020 2020 2020 2020 2020  ts))..          
-0003ca20: 2020 2020 2020 2320 2a5f 6279 7465 735f        # *_bytes_
-0003ca30: 6d61 782f 6d69 6e20 6172 6520 616c 6c20  max/min are all 
-0003ca40: 6e65 6761 7469 7665 2066 6f72 2068 6561  negative for hea
-0003ca50: 7020 736f 7274 696e 670a 2020 2020 2020  p sorting.      
-0003ca60: 2020 2020 2020 2020 2020 736e 645f 6279            snd_by
-0003ca70: 7465 735f 6d61 7820 2b3d 206e 6279 7465  tes_max += nbyte
-0003ca80: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0003ca90: 2020 736e 645f 6279 7465 735f 6d69 6e20    snd_bytes_min 
-0003caa0: 2b3d 206e 6279 7465 730a 2020 2020 2020  += nbytes.      
-0003cab0: 2020 2020 2020 2020 2020 7265 635f 6279            rec_by
-0003cac0: 7465 735f 6d61 7820 2b3d 206e 6279 7465  tes_max += nbyte
-0003cad0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0003cae0: 2020 7265 635f 6279 7465 735f 6d69 6e20    rec_bytes_min 
-0003caf0: 2b3d 206e 6279 7465 730a 0a20 2020 2020  += nbytes..     
-0003cb00: 2020 2020 2020 2020 2020 2023 2053 746f             # Sto
-0003cb10: 7020 6974 6572 6174 696e 6720 6f6e 2074  p iterating on t
-0003cb20: 6865 2074 6173 6b73 206f 6620 7468 6973  he tasks of this
-0003cb30: 2073 656e 6465 7220 666f 7220 6e6f 7720   sender for now 
-0003cb40: 616e 642c 2069 6620 6974 2073 7469 6c6c  and, if it still
-0003cb50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003cb60: 2023 2068 6173 2062 7974 6573 2074 6f20   # has bytes to 
-0003cb70: 6c6f 7365 2c20 7075 7368 2069 7420 6261  lose, push it ba
-0003cb80: 636b 2069 6e74 6f20 7468 6520 7365 6e64  ck into the send
-0003cb90: 6572 7320 6865 6170 3b20 6974 206d 6179  ers heap; it may
-0003cba0: 206f 7220 6d61 790a 2020 2020 2020 2020   or may.        
-0003cbb0: 2020 2020 2020 2020 2320 6e6f 7420 636f          # not co
-0003cbc0: 6d65 2062 6163 6b20 6f6e 2074 6f70 2061  me back on top a
-0003cbd0: 6761 696e 2e0a 2020 2020 2020 2020 2020  gain..          
-0003cbe0: 2020 2020 2020 6966 2073 6e64 5f62 7974        if snd_byt
-0003cbf0: 6573 5f6d 696e 203c 2030 3a0a 2020 2020  es_min < 0:.    
-0003cc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cc10: 2320 5365 6520 6465 6669 6e69 7469 6f6e  # See definition
-0003cc20: 206f 6620 7365 6e64 6572 7320 6162 6f76   of senders abov
-0003cc30: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0003cc40: 2020 2020 2020 6865 6170 712e 6865 6170        heapq.heap
-0003cc50: 7265 706c 6163 6528 0a20 2020 2020 2020  replace(.       
-0003cc60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cc70: 2073 656e 6465 7273 2c0a 2020 2020 2020   senders,.      
-0003cc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cc90: 2020 2873 6e64 5f62 7974 6573 5f6d 6178    (snd_bytes_max
-0003cca0: 2c20 736e 645f 6279 7465 735f 6d69 6e2c  , snd_bytes_min,
-0003ccb0: 2069 6428 736e 645f 7773 292c 2073 6e64   id(snd_ws), snd
-0003ccc0: 5f77 732c 2074 735f 6974 6572 292c 0a20  _ws, ts_iter),. 
-0003ccd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cce0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0003ccf0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0003cd00: 2020 2020 2020 2020 2020 2020 2020 2068                 h
-0003cd10: 6561 7071 2e68 6561 7070 6f70 2873 656e  eapq.heappop(sen
-0003cd20: 6465 7273 290a 0a20 2020 2020 2020 2020  ders)..         
-0003cd30: 2020 2020 2020 2023 2049 6620 7265 6369         # If reci
-0003cd40: 7069 656e 7420 7374 696c 6c20 6861 7320  pient still has 
-0003cd50: 6279 7465 7320 746f 2067 6169 6e2c 2070  bytes to gain, p
-0003cd60: 7573 6820 6974 2062 6163 6b20 696e 746f  ush it back into
-0003cd70: 2074 6865 2072 6563 6970 6965 6e74 730a   the recipients.
-0003cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003cd90: 2320 6865 6170 3b20 6974 206d 6179 206f  # heap; it may o
-0003cda0: 7220 6d61 7920 6e6f 7420 636f 6d65 2062  r may not come b
-0003cdb0: 6163 6b20 6f6e 2074 6f70 2061 6761 696e  ack on top again
-0003cdc0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0003cdd0: 2020 6966 2072 6563 5f62 7974 6573 5f6d    if rec_bytes_m
-0003cde0: 696e 203c 2030 3a0a 2020 2020 2020 2020  in < 0:.        
-0003cdf0: 2020 2020 2020 2020 2020 2020 2320 5365              # Se
-0003ce00: 6520 6465 6669 6e69 7469 6f6e 206f 6620  e definition of 
-0003ce10: 7265 6369 7069 656e 7473 2061 626f 7665  recipients above
-0003ce20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003ce30: 2020 2020 2068 6561 7071 2e68 6561 7072       heapq.heapr
-0003ce40: 6570 6c61 6365 280a 2020 2020 2020 2020  eplace(.        
-0003ce50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ce60: 7265 6369 7069 656e 7473 2c0a 2020 2020  recipients,.    
-0003ce70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003ce80: 2020 2020 2872 6563 5f62 7974 6573 5f6d      (rec_bytes_m
-0003ce90: 6178 2c20 7265 635f 6279 7465 735f 6d69  ax, rec_bytes_mi
-0003cea0: 6e2c 2069 6428 7265 635f 7773 292c 2072  n, id(rec_ws), r
-0003ceb0: 6563 5f77 7329 2c0a 2020 2020 2020 2020  ec_ws),.        
-0003cec0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0003ced0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0003cee0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003cef0: 2020 2020 2020 2020 6865 6170 712e 6865          heapq.he
-0003cf00: 6170 706f 7028 7265 6369 7069 656e 7473  appop(recipients
-0003cf10: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0003cf20: 2020 2023 204d 6f76 6520 746f 206e 6578     # Move to nex
-0003cf30: 7420 7365 6e64 6572 2077 6974 6820 7468  t sender with th
-0003cf40: 6520 6d6f 7374 2064 6174 6120 746f 206c  e most data to l
-0003cf50: 6f73 652e 0a20 2020 2020 2020 2020 2020  ose..           
-0003cf60: 2020 2020 2023 2049 7420 6d61 7920 6f72       # It may or
-0003cf70: 206d 6179 206e 6f74 2062 6520 7468 6520   may not be the 
-0003cf80: 7361 6d65 2073 656e 6465 7220 6167 6169  same sender agai
-0003cf90: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
-0003cfa0: 2020 2062 7265 616b 0a0a 2020 2020 2020     break..      
-0003cfb0: 2020 2020 2020 656c 7365 3a20 2023 2066        else:  # f
-0003cfc0: 6f72 2074 7320 696e 2074 735f 6974 6572  or ts in ts_iter
-0003cfd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003cfe0: 2023 2045 7868 6175 7374 6564 2074 6173   # Exhausted tas
-0003cff0: 6b73 206f 6e20 7468 6973 2073 656e 6465  ks on this sende
-0003d000: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
-0003d010: 2020 6865 6170 712e 6865 6170 706f 7028    heapq.heappop(
-0003d020: 7365 6e64 6572 7329 0a0a 2020 2020 2020  senders)..      
-0003d030: 2020 7265 7475 726e 206d 7367 730a 0a20    return msgs.. 
-0003d040: 2020 2061 7379 6e63 2064 6566 205f 7265     async def _re
-0003d050: 6261 6c61 6e63 655f 6d6f 7665 5f64 6174  balance_move_dat
-0003d060: 6128 0a20 2020 2020 2020 2073 656c 662c  a(.        self,
-0003d070: 206d 7367 733a 206c 6973 745b 7475 706c   msgs: list[tupl
-0003d080: 655b 576f 726b 6572 5374 6174 652c 2057  e[WorkerState, W
-0003d090: 6f72 6b65 7253 7461 7465 2c20 5461 736b  orkerState, Task
-0003d0a0: 5374 6174 655d 5d2c 2073 7469 6d75 6c75  State]], stimulu
-0003d0b0: 735f 6964 3a20 7374 720a 2020 2020 2920  s_id: str.    ) 
-0003d0c0: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
-0003d0d0: 2022 2222 5065 7266 6f72 6d20 7468 6520   """Perform the 
-0003d0e0: 6163 7475 616c 2074 7261 6e73 6665 7220  actual transfer 
-0003d0f0: 6f66 2064 6174 6120 6163 726f 7373 2074  of data across t
-0003d100: 6865 206e 6574 776f 726b 2069 6e20 7265  he network in re
-0003d110: 6261 6c61 6e63 6528 292e 0a20 2020 2020  balance()..     
-0003d120: 2020 2054 616b 6573 2069 6e20 696e 7075     Takes in inpu
-0003d130: 7420 7468 6520 6f75 7470 7574 206f 6620  t the output of 
-0003d140: 5f72 6562 616c 616e 6365 5f66 696e 645f  _rebalance_find_
-0003d150: 6d73 6773 2829 2c20 7468 6174 2069 7320  msgs(), that is 
-0003d160: 6120 6c69 7374 206f 6620 7475 706c 6573  a list of tuples
-0003d170: 3a0a 0a20 2020 2020 2020 202d 2073 656e  :..        - sen
-0003d180: 6465 7220 776f 726b 6572 0a20 2020 2020  der worker.     
-0003d190: 2020 202d 2072 6563 6970 6965 6e74 2077     - recipient w
-0003d1a0: 6f72 6b65 720a 2020 2020 2020 2020 2d20  orker.        - 
-0003d1b0: 7461 736b 2074 6f20 6265 2074 7261 6e73  task to be trans
-0003d1c0: 6665 7272 6564 0a0a 2020 2020 2020 2020  ferred..        
-0003d1d0: 4649 584d 4520 7468 6973 206d 6574 686f  FIXME this metho
-0003d1e0: 6420 6973 206e 6f74 2072 6f62 7573 7420  d is not robust 
-0003d1f0: 7768 656e 2074 6865 2063 6c75 7374 6572  when the cluster
-0003d200: 2069 7320 6e6f 7420 6964 6c65 2e0a 2020   is not idle..  
-0003d210: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0003d220: 2020 2320 7b72 6563 6970 6965 6e74 2061    # {recipient a
-0003d230: 6464 7265 7373 3a20 7b6b 6579 3a20 5b73  ddress: {key: [s
-0003d240: 656e 6465 7220 6164 6472 6573 732c 202e  ender address, .
-0003d250: 2e2e 5d7d 7d0a 2020 2020 2020 2020 746f  ..]}}.        to
-0003d260: 5f72 6563 6970 6965 6e74 733a 2064 6566  _recipients: def
-0003d270: 6175 6c74 6469 6374 5b73 7472 2c20 6465  aultdict[str, de
-0003d280: 6661 756c 7464 6963 745b 4b65 792c 206c  faultdict[Key, l
-0003d290: 6973 745b 7374 725d 5d5d 203d 2064 6566  ist[str]]] = def
-0003d2a0: 6175 6c74 6469 6374 280a 2020 2020 2020  aultdict(.      
-0003d2b0: 2020 2020 2020 6c61 6d62 6461 3a20 6465        lambda: de
-0003d2c0: 6661 756c 7464 6963 7428 6c69 7374 290a  faultdict(list).
-0003d2d0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-0003d2e0: 2020 666f 7220 736e 645f 7773 2c20 7265    for snd_ws, re
-0003d2f0: 635f 7773 2c20 7473 2069 6e20 6d73 6773  c_ws, ts in msgs
-0003d300: 3a0a 2020 2020 2020 2020 2020 2020 746f  :.            to
-0003d310: 5f72 6563 6970 6965 6e74 735b 7265 635f  _recipients[rec_
-0003d320: 7773 2e61 6464 7265 7373 5d5b 7473 2e6b  ws.address][ts.k
-0003d330: 6579 5d2e 6170 7065 6e64 2873 6e64 5f77  ey].append(snd_w
-0003d340: 732e 6164 6472 6573 7329 0a20 2020 2020  s.address).     
-0003d350: 2020 2066 6169 6c65 645f 6b65 7973 5f62     failed_keys_b
-0003d360: 795f 7265 6369 7069 656e 7420 3d20 6469  y_recipient = di
-0003d370: 6374 280a 2020 2020 2020 2020 2020 2020  ct(.            
-0003d380: 7a69 7028 0a20 2020 2020 2020 2020 2020  zip(.           
-0003d390: 2020 2020 2074 6f5f 7265 6369 7069 656e       to_recipien
-0003d3a0: 7473 2c0a 2020 2020 2020 2020 2020 2020  ts,.            
-0003d3b0: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
-0003d3c0: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
-0003d3d0: 2020 2020 2020 2020 2020 2020 2020 2a28                *(
-0003d3e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003d3f0: 2020 2020 2020 2020 2023 204e 6f74 653a           # Note:
-0003d400: 2074 6869 7320 6e65 7665 7220 7261 6973   this never rais
-0003d410: 6573 2065 7863 6570 7469 6f6e 730a 2020  es exceptions.  
-0003d420: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d430: 2020 2020 2020 7365 6c66 2e67 6174 6865        self.gathe
-0003d440: 725f 6f6e 5f77 6f72 6b65 7228 772c 2077  r_on_worker(w, w
-0003d450: 686f 5f68 6173 290a 2020 2020 2020 2020  ho_has).        
+00039490: 2020 2066 226f 7220 2769 676e 6f72 6527     f"or 'ignore'
+000394a0: 3b20 676f 7420 7b6f 6e5f 6572 726f 7221  ; got {on_error!
+000394b0: 727d 220a 2020 2020 2020 2020 2020 2020  r}".            
+000394c0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+000394d0: 2020 2072 6573 756c 7473 203d 2061 7761     results = awa
+000394e0: 6974 2041 6c6c 285b 7365 6e64 5f6d 6573  it All([send_mes
+000394f0: 7361 6765 2861 6464 7265 7373 2920 666f  sage(address) fo
+00039500: 7220 6164 6472 6573 7320 696e 2061 6464  r address in add
+00039510: 7265 7373 6573 5d29 0a20 2020 2020 2020  resses]).       
+00039520: 2072 6574 7572 6e20 7b6b 3a20 7620 666f   return {k: v fo
+00039530: 7220 6b2c 2076 2069 6e20 7a69 7028 776f  r k, v in zip(wo
+00039540: 726b 6572 732c 2072 6573 756c 7473 2920  rkers, results) 
+00039550: 6966 2076 2069 7320 6e6f 7420 4552 524f  if v is not ERRO
+00039560: 527d 0a0a 2020 2020 6173 796e 6320 6465  R}..    async de
+00039570: 6620 7072 6f78 7928 0a20 2020 2020 2020  f proxy(.       
+00039580: 2073 656c 662c 0a20 2020 2020 2020 206d   self,.        m
+00039590: 7367 3a20 6469 6374 2c0a 2020 2020 2020  sg: dict,.      
+000395a0: 2020 776f 726b 6572 3a20 7374 722c 0a20    worker: str,. 
+000395b0: 2020 2020 2020 2073 6572 6961 6c69 7a65         serialize
+000395c0: 7273 3a20 416e 7920 3d20 4e6f 6e65 2c0a  rs: Any = None,.
+000395d0: 2020 2020 2920 2d3e 2041 6e79 3a0a 2020      ) -> Any:.  
+000395e0: 2020 2020 2020 2222 2250 726f 7879 2061        """Proxy a
+000395f0: 2063 6f6d 6d75 6e69 6361 7469 6f6e 2074   communication t
+00039600: 6872 6f75 6768 2074 6865 2073 6368 6564  hrough the sched
+00039610: 756c 6572 2074 6f20 736f 6d65 206f 7468  uler to some oth
+00039620: 6572 2077 6f72 6b65 7222 2222 0a20 2020  er worker""".   
+00039630: 2020 2020 2064 203d 2061 7761 6974 2073       d = await s
+00039640: 656c 662e 6272 6f61 6463 6173 7428 6d73  elf.broadcast(ms
+00039650: 673d 6d73 672c 2077 6f72 6b65 7273 3d5b  g=msg, workers=[
+00039660: 776f 726b 6572 5d2c 2073 6572 6961 6c69  worker], seriali
+00039670: 7a65 7273 3d73 6572 6961 6c69 7a65 7273  zers=serializers
+00039680: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00039690: 2064 5b77 6f72 6b65 725d 0a0a 2020 2020   d[worker]..    
+000396a0: 6173 796e 6320 6465 6620 6761 7468 6572  async def gather
+000396b0: 5f6f 6e5f 776f 726b 6572 280a 2020 2020  _on_worker(.    
+000396c0: 2020 2020 7365 6c66 2c20 776f 726b 6572      self, worker
+000396d0: 5f61 6464 7265 7373 3a20 7374 722c 2077  _address: str, w
+000396e0: 686f 5f68 6173 3a20 6469 6374 5b4b 6579  ho_has: dict[Key
+000396f0: 2c20 6c69 7374 5b73 7472 5d5d 0a20 2020  , list[str]].   
+00039700: 2029 202d 3e20 7365 743a 0a20 2020 2020   ) -> set:.     
+00039710: 2020 2022 2222 5065 6572 2d74 6f2d 7065     """Peer-to-pe
+00039720: 6572 2063 6f70 7920 6f66 206b 6579 7320  er copy of keys 
+00039730: 6672 6f6d 206d 756c 7469 706c 6520 776f  from multiple wo
+00039740: 726b 6572 7320 746f 2061 2073 696e 676c  rkers to a singl
+00039750: 6520 776f 726b 6572 0a0a 2020 2020 2020  e worker..      
+00039760: 2020 5061 7261 6d65 7465 7273 0a20 2020    Parameters.   
+00039770: 2020 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a       ----------.
+00039780: 2020 2020 2020 2020 776f 726b 6572 5f61          worker_a
+00039790: 6464 7265 7373 3a20 7374 720a 2020 2020  ddress: str.    
+000397a0: 2020 2020 2020 2020 5265 6369 7069 656e          Recipien
+000397b0: 7420 776f 726b 6572 2061 6464 7265 7373  t worker address
+000397c0: 2074 6f20 636f 7079 206b 6579 7320 746f   to copy keys to
+000397d0: 0a20 2020 2020 2020 2077 686f 5f68 6173  .        who_has
+000397e0: 3a20 6469 6374 5b4b 6579 2c20 6c69 7374  : dict[Key, list
+000397f0: 5b73 7472 5d5d 0a20 2020 2020 2020 2020  [str]].         
+00039800: 2020 207b 6b65 793a 205b 7365 6e64 6572     {key: [sender
+00039810: 2061 6464 7265 7373 2c20 7365 6e64 6572   address, sender
+00039820: 2061 6464 7265 7373 2c20 2e2e 2e5d 2c20   address, ...], 
+00039830: 6b65 793a 202e 2e2e 7d0a 0a20 2020 2020  key: ...}..     
+00039840: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
+00039850: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+00039860: 2020 2072 6574 7572 6e73 3a0a 2020 2020     returns:.    
+00039870: 2020 2020 2020 2020 7365 7420 6f66 206b          set of k
+00039880: 6579 7320 7468 6174 2066 6169 6c65 6420  eys that failed 
+00039890: 746f 2062 6520 636f 7069 6564 0a20 2020  to be copied.   
+000398a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+000398b0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+000398c0: 2020 7265 7375 6c74 203d 2061 7761 6974    result = await
+000398d0: 2072 6574 7279 5f6f 7065 7261 7469 6f6e   retry_operation
+000398e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000398f0: 2020 7365 6c66 2e72 7063 2861 6464 723d    self.rpc(addr=
+00039900: 776f 726b 6572 5f61 6464 7265 7373 292e  worker_address).
+00039910: 6761 7468 6572 2c20 7768 6f5f 6861 733d  gather, who_has=
+00039920: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+00039930: 2020 2020 290a 2020 2020 2020 2020 6578      ).        ex
+00039940: 6365 7074 204f 5345 7272 6f72 2061 7320  cept OSError as 
+00039950: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+00039960: 2054 6869 7320 6361 6e20 6861 7070 656e   This can happen
+00039970: 2065 2e67 2e20 6966 2074 6865 2077 6f72   e.g. if the wor
+00039980: 6b65 7220 6973 2067 6f69 6e67 2074 6872  ker is going thr
+00039990: 6f75 6768 2063 6f6e 7472 6f6c 6c65 6420  ough controlled 
+000399a0: 7368 7574 646f 776e 3b0a 2020 2020 2020  shutdown;.      
+000399b0: 2020 2020 2020 2320 6974 2064 6f65 736e        # it doesn
+000399c0: 2774 206e 6563 6573 7361 7269 6c79 206d  't necessarily m
+000399d0: 6561 6e20 7468 6174 2069 7420 7765 6e74  ean that it went
+000399e0: 2075 6e65 7870 6563 7465 646c 7920 6d69   unexpectedly mi
+000399f0: 7373 696e 670a 2020 2020 2020 2020 2020  ssing.          
+00039a00: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+00039a10: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+00039a20: 2020 6622 436f 6d6d 756e 6963 6174 696f    f"Communicatio
+00039a30: 6e20 7769 7468 2077 6f72 6b65 7220 7b77  n with worker {w
+00039a40: 6f72 6b65 725f 6164 6472 6573 737d 2066  orker_address} f
+00039a50: 6169 6c65 6420 6475 7269 6e67 2022 0a20  ailed during ". 
+00039a60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00039a70: 2272 6570 6c69 6361 7469 6f6e 3a20 7b65  "replication: {e
+00039a80: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
+00039a90: 655f 5f7d 3a20 7b65 7d22 0a20 2020 2020  e__}: {e}".     
+00039aa0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00039ab0: 2020 2020 2072 6574 7572 6e20 7365 7428       return set(
+00039ac0: 7768 6f5f 6861 7329 0a0a 2020 2020 2020  who_has)..      
+00039ad0: 2020 7773 203d 2073 656c 662e 776f 726b    ws = self.work
+00039ae0: 6572 732e 6765 7428 776f 726b 6572 5f61  ers.get(worker_a
+00039af0: 6464 7265 7373 290a 0a20 2020 2020 2020  ddress)..       
+00039b00: 2069 6620 6e6f 7420 7773 3a0a 2020 2020   if not ws:.    
+00039b10: 2020 2020 2020 2020 6c6f 6767 6572 2e77          logger.w
+00039b20: 6172 6e69 6e67 2866 2257 6f72 6b65 7220  arning(f"Worker 
+00039b30: 7b77 6f72 6b65 725f 6164 6472 6573 737d  {worker_address}
+00039b40: 206c 6f73 7420 6475 7269 6e67 2072 6570   lost during rep
+00039b50: 6c69 6361 7469 6f6e 2229 0a20 2020 2020  lication").     
+00039b60: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00039b70: 7428 7768 6f5f 6861 7329 0a20 2020 2020  t(who_has).     
+00039b80: 2020 2065 6c69 6620 7265 7375 6c74 5b22     elif result["
+00039b90: 7374 6174 7573 225d 203d 3d20 224f 4b22  status"] == "OK"
+00039ba0: 3a0a 2020 2020 2020 2020 2020 2020 6b65  :.            ke
+00039bb0: 7973 5f66 6169 6c65 6420 3d20 7365 7428  ys_failed = set(
+00039bc0: 290a 2020 2020 2020 2020 2020 2020 6b65  ).            ke
+00039bd0: 7973 5f6f 6b3a 2053 6574 203d 2077 686f  ys_ok: Set = who
+00039be0: 5f68 6173 2e6b 6579 7328 290a 2020 2020  _has.keys().    
+00039bf0: 2020 2020 656c 6966 2072 6573 756c 745b      elif result[
+00039c00: 2273 7461 7475 7322 5d20 3d3d 2022 7061  "status"] == "pa
+00039c10: 7274 6961 6c2d 6661 696c 223a 0a20 2020  rtial-fail":.   
+00039c20: 2020 2020 2020 2020 206b 6579 735f 6661           keys_fa
+00039c30: 696c 6564 203d 2073 6574 2872 6573 756c  iled = set(resul
+00039c40: 745b 226b 6579 7322 5d29 0a20 2020 2020  t["keys"]).     
+00039c50: 2020 2020 2020 206b 6579 735f 6f6b 203d         keys_ok =
+00039c60: 2077 686f 5f68 6173 2e6b 6579 7328 2920   who_has.keys() 
+00039c70: 2d20 6b65 7973 5f66 6169 6c65 640a 2020  - keys_failed.  
+00039c80: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
+00039c90: 2e77 6172 6e69 6e67 280a 2020 2020 2020  .warning(.      
+00039ca0: 2020 2020 2020 2020 2020 6622 576f 726b            f"Work
+00039cb0: 6572 207b 776f 726b 6572 5f61 6464 7265  er {worker_addre
+00039cc0: 7373 7d20 6661 696c 6564 2074 6f20 6163  ss} failed to ac
+00039cd0: 7175 6972 6520 6b65 7973 3a20 7b72 6573  quire keys: {res
+00039ce0: 756c 745b 276b 6579 7327 5d7d 220a 2020  ult['keys']}".  
+00039cf0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
+00039d00: 2020 2020 656c 7365 3a20 2023 2070 7261      else:  # pra
+00039d10: 676d 613a 206e 6f63 6f76 6572 0a20 2020  gma: nocover.   
+00039d20: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
+00039d30: 616c 7565 4572 726f 7228 6622 556e 6578  alueError(f"Unex
+00039d40: 7065 6374 6564 206d 6573 7361 6765 2066  pected message f
+00039d50: 726f 6d20 7b77 6f72 6b65 725f 6164 6472  rom {worker_addr
+00039d60: 6573 737d 3a20 7b72 6573 756c 747d 2229  ess}: {result}")
+00039d70: 0a0a 2020 2020 2020 2020 666f 7220 6b65  ..        for ke
+00039d80: 7920 696e 206b 6579 735f 6f6b 3a0a 2020  y in keys_ok:.  
+00039d90: 2020 2020 2020 2020 2020 7473 203d 2073            ts = s
+00039da0: 656c 662e 7461 736b 732e 6765 7428 6b65  elf.tasks.get(ke
+00039db0: 7929 0a20 2020 2020 2020 2020 2020 2069  y).            i
+00039dc0: 6620 7473 2069 7320 4e6f 6e65 206f 7220  f ts is None or 
+00039dd0: 7473 2e73 7461 7465 2021 3d20 226d 656d  ts.state != "mem
+00039de0: 6f72 7922 3a0a 2020 2020 2020 2020 2020  ory":.          
+00039df0: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+00039e00: 6e69 6e67 2866 224b 6579 206c 6f73 7420  ning(f"Key lost 
+00039e10: 6475 7269 6e67 2072 6570 6c69 6361 7469  during replicati
+00039e20: 6f6e 3a20 7b6b 6579 7d22 290a 2020 2020  on: {key}").    
+00039e30: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00039e40: 696e 7565 0a20 2020 2020 2020 2020 2020  inue.           
+00039e50: 2073 656c 662e 6164 645f 7265 706c 6963   self.add_replic
+00039e60: 6128 7473 2c20 7773 290a 0a20 2020 2020  a(ts, ws)..     
+00039e70: 2020 2072 6574 7572 6e20 6b65 7973 5f66     return keys_f
+00039e80: 6169 6c65 640a 0a20 2020 2061 7379 6e63  ailed..    async
+00039e90: 2064 6566 2064 656c 6574 655f 776f 726b   def delete_work
+00039ea0: 6572 5f64 6174 6128 0a20 2020 2020 2020  er_data(.       
+00039eb0: 2073 656c 662c 2077 6f72 6b65 725f 6164   self, worker_ad
+00039ec0: 6472 6573 733a 2073 7472 2c20 6b65 7973  dress: str, keys
+00039ed0: 3a20 436f 6c6c 6563 7469 6f6e 5b4b 6579  : Collection[Key
+00039ee0: 5d2c 2073 7469 6d75 6c75 735f 6964 3a20  ], stimulus_id: 
+00039ef0: 7374 720a 2020 2020 2920 2d3e 204e 6f6e  str.    ) -> Non
+00039f00: 653a 0a20 2020 2020 2020 2022 2222 4465  e:.        """De
+00039f10: 6c65 7465 2064 6174 6120 6672 6f6d 2061  lete data from a
+00039f20: 2077 6f72 6b65 7220 616e 6420 7570 6461   worker and upda
+00039f30: 7465 2074 6865 2063 6f72 7265 7370 6f6e  te the correspon
+00039f40: 6469 6e67 2077 6f72 6b65 722f 7461 736b  ding worker/task
+00039f50: 2073 7461 7465 730a 0a20 2020 2020 2020   states..       
+00039f60: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+00039f70: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+00039f80: 2020 2020 2020 2077 6f72 6b65 725f 6164         worker_ad
+00039f90: 6472 6573 733a 2073 7472 0a20 2020 2020  dress: str.     
+00039fa0: 2020 2020 2020 2057 6f72 6b65 7220 6164         Worker ad
+00039fb0: 6472 6573 7320 746f 2064 656c 6574 6520  dress to delete 
+00039fc0: 6b65 7973 2066 726f 6d0a 2020 2020 2020  keys from.      
+00039fd0: 2020 6b65 7973 3a20 6c69 7374 5b4b 6579    keys: list[Key
+00039fe0: 5d0a 2020 2020 2020 2020 2020 2020 4c69  ].            Li
+00039ff0: 7374 206f 6620 6b65 7973 2074 6f20 6465  st of keys to de
+0003a000: 6c65 7465 206f 6e20 7468 6520 7370 6563  lete on the spec
+0003a010: 6966 6965 6420 776f 726b 6572 0a20 2020  ified worker.   
+0003a020: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0003a030: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0003a040: 2020 6177 6169 7420 7265 7472 795f 6f70    await retry_op
+0003a050: 6572 6174 696f 6e28 0a20 2020 2020 2020  eration(.       
+0003a060: 2020 2020 2020 2020 2073 656c 662e 7270           self.rp
+0003a070: 6328 6164 6472 3d77 6f72 6b65 725f 6164  c(addr=worker_ad
+0003a080: 6472 6573 7329 2e66 7265 655f 6b65 7973  dress).free_keys
+0003a090: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0003a0a0: 2020 6b65 7973 3d6c 6973 7428 6b65 7973    keys=list(keys
+0003a0b0: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0003a0c0: 2020 2073 7469 6d75 6c75 735f 6964 3d66     stimulus_id=f
+0003a0d0: 2264 656c 6574 652d 6461 7461 2d7b 7469  "delete-data-{ti
+0003a0e0: 6d65 2829 7d22 2c0a 2020 2020 2020 2020  me()}",.        
+0003a0f0: 2020 2020 290a 2020 2020 2020 2020 6578      ).        ex
+0003a100: 6365 7074 204f 5345 7272 6f72 2061 7320  cept OSError as 
+0003a110: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
+0003a120: 2054 6869 7320 6361 6e20 6861 7070 656e   This can happen
+0003a130: 2065 2e67 2e20 6966 2074 6865 2077 6f72   e.g. if the wor
+0003a140: 6b65 7220 6973 2067 6f69 6e67 2074 6872  ker is going thr
+0003a150: 6f75 6768 2063 6f6e 7472 6f6c 6c65 6420  ough controlled 
+0003a160: 7368 7574 646f 776e 3b0a 2020 2020 2020  shutdown;.      
+0003a170: 2020 2020 2020 2320 6974 2064 6f65 736e        # it doesn
+0003a180: 2774 206e 6563 6573 7361 7269 6c79 206d  't necessarily m
+0003a190: 6561 6e20 7468 6174 2069 7420 7765 6e74  ean that it went
+0003a1a0: 2075 6e65 7870 6563 7465 646c 7920 6d69   unexpectedly mi
+0003a1b0: 7373 696e 670a 2020 2020 2020 2020 2020  ssing.          
+0003a1c0: 2020 6c6f 6767 6572 2e77 6172 6e69 6e67    logger.warning
+0003a1d0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0003a1e0: 2020 6622 436f 6d6d 756e 6963 6174 696f    f"Communicatio
+0003a1f0: 6e20 7769 7468 2077 6f72 6b65 7220 7b77  n with worker {w
+0003a200: 6f72 6b65 725f 6164 6472 6573 737d 2066  orker_address} f
+0003a210: 6169 6c65 6420 6475 7269 6e67 2022 0a20  ailed during ". 
+0003a220: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0003a230: 2272 6570 6c69 6361 7469 6f6e 3a20 7b65  "replication: {e
+0003a240: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
+0003a250: 655f 5f7d 3a20 7b65 7d22 0a20 2020 2020  e__}: {e}".     
+0003a260: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0003a270: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
+0003a280: 2020 2020 2077 7320 3d20 7365 6c66 2e77       ws = self.w
+0003a290: 6f72 6b65 7273 2e67 6574 2877 6f72 6b65  orkers.get(worke
+0003a2a0: 725f 6164 6472 6573 7329 0a20 2020 2020  r_address).     
+0003a2b0: 2020 2069 6620 6e6f 7420 7773 3a0a 2020     if not ws:.  
+0003a2c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0003a2d0: 0a0a 2020 2020 2020 2020 666f 7220 6b65  ..        for ke
+0003a2e0: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
+0003a2f0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+0003a300: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
+0003a310: 2020 2020 2020 2020 2020 2020 6966 2074              if t
+0003a320: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
+0003a330: 6420 7773 2069 6e20 2874 732e 7768 6f5f  d ws in (ts.who_
+0003a340: 6861 7320 6f72 2028 2929 3a0a 2020 2020  has or ()):.    
+0003a350: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0003a360: 7274 2074 732e 7374 6174 6520 3d3d 2022  rt ts.state == "
+0003a370: 6d65 6d6f 7279 220a 2020 2020 2020 2020  memory".        
+0003a380: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
+0003a390: 6f76 655f 7265 706c 6963 6128 7473 2c20  ove_replica(ts, 
+0003a3a0: 7773 290a 2020 2020 2020 2020 2020 2020  ws).            
+0003a3b0: 2020 2020 6966 206e 6f74 2074 732e 7768      if not ts.wh
+0003a3c0: 6f5f 6861 733a 0a20 2020 2020 2020 2020  o_has:.         
+0003a3d0: 2020 2020 2020 2020 2020 2023 204c 6173             # Las
+0003a3e0: 7420 636f 7079 2064 656c 6574 6564 0a20  t copy deleted. 
+0003a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003a400: 2020 2073 656c 662e 7472 616e 7369 7469     self.transiti
+0003a410: 6f6e 7328 7b6b 6579 3a20 2272 656c 6561  ons({key: "relea
+0003a420: 7365 6422 7d2c 2073 7469 6d75 6c75 735f  sed"}, stimulus_
+0003a430: 6964 290a 0a20 2020 2020 2020 2073 656c  id)..        sel
+0003a440: 662e 6c6f 675f 6576 656e 7428 7773 2e61  f.log_event(ws.a
+0003a450: 6464 7265 7373 2c20 7b22 6163 7469 6f6e  ddress, {"action
+0003a460: 223a 2022 7265 6d6f 7665 2d77 6f72 6b65  ": "remove-worke
+0003a470: 722d 6461 7461 222c 2022 6b65 7973 223a  r-data", "keys":
+0003a480: 206b 6579 737d 290a 0a20 2020 2040 6c6f   keys})..    @lo
+0003a490: 675f 6572 726f 7273 0a20 2020 2061 7379  g_errors.    asy
+0003a4a0: 6e63 2064 6566 2072 6562 616c 616e 6365  nc def rebalance
+0003a4b0: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+0003a4c0: 2020 2020 2020 2020 6b65 7973 3a20 4974          keys: It
+0003a4d0: 6572 6162 6c65 5b4b 6579 5d20 7c20 4e6f  erable[Key] | No
+0003a4e0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+0003a4f0: 2020 2077 6f72 6b65 7273 3a20 4974 6572     workers: Iter
+0003a500: 6162 6c65 5b73 7472 5d20 7c20 4e6f 6e65  able[str] | None
+0003a510: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
+0003a520: 2073 7469 6d75 6c75 735f 6964 3a20 7374   stimulus_id: st
+0003a530: 7220 7c20 4e6f 6e65 203d 204e 6f6e 652c  r | None = None,
+0003a540: 0a20 2020 2029 202d 3e20 6469 6374 3a0a  .    ) -> dict:.
+0003a550: 2020 2020 2020 2020 2222 2252 6562 616c          """Rebal
+0003a560: 616e 6365 206b 6579 7320 736f 2074 6861  ance keys so tha
+0003a570: 7420 6561 6368 2077 6f72 6b65 7220 656e  t each worker en
+0003a580: 6473 2075 7020 7769 7468 2072 6f75 6768  ds up with rough
+0003a590: 6c79 2074 6865 2073 616d 6520 7072 6f63  ly the same proc
+0003a5a0: 6573 730a 2020 2020 2020 2020 6d65 6d6f  ess.        memo
+0003a5b0: 7279 2028 6d61 6e61 6765 642b 756e 6d61  ry (managed+unma
+0003a5c0: 6e61 6765 6429 2e0a 0a20 2020 2020 2020  naged)...       
+0003a5d0: 202e 2e20 7761 726e 696e 673a 3a0a 2020   .. warning::.  
+0003a5e0: 2020 2020 2020 2020 2054 6869 7320 6f70           This op
+0003a5f0: 6572 6174 696f 6e20 6973 2067 656e 6572  eration is gener
+0003a600: 616c 6c79 206e 6f74 2077 656c 6c20 7465  ally not well te
+0003a610: 7374 6564 2061 6761 696e 7374 206e 6f72  sted against nor
+0003a620: 6d61 6c20 6f70 6572 6174 696f 6e20 6f66  mal operation of
+0003a630: 2074 6865 0a20 2020 2020 2020 2020 2020   the.           
+0003a640: 7363 6865 6475 6c65 722e 2049 7420 6973  scheduler. It is
+0003a650: 206e 6f74 2072 6563 6f6d 6d65 6e64 6564   not recommended
+0003a660: 2074 6f20 7573 6520 6974 2077 6869 6c65   to use it while
+0003a670: 2077 6169 7469 6e67 206f 6e20 636f 6d70   waiting on comp
+0003a680: 7574 6174 696f 6e73 2e0a 0a20 2020 2020  utations...     
+0003a690: 2020 202a 2a41 6c67 6f72 6974 686d 2a2a     **Algorithm**
+0003a6a0: 0a0a 2020 2020 2020 2020 232e 2046 696e  ..        #. Fin
+0003a6b0: 6420 7468 6520 6d65 616e 206f 6363 7570  d the mean occup
+0003a6c0: 616e 6379 206f 6620 7468 6520 636c 7573  ancy of the clus
+0003a6d0: 7465 722c 2064 6566 696e 6564 2061 7320  ter, defined as 
+0003a6e0: 6461 7461 206d 616e 6167 6564 2062 7920  data managed by 
+0003a6f0: 6461 736b 202b 0a20 2020 2020 2020 2020  dask +.         
+0003a700: 2020 756e 6d61 6e61 6765 6420 7072 6f63    unmanaged proc
+0003a710: 6573 7320 6d65 6d6f 7279 2074 6861 7420  ess memory that 
+0003a720: 6861 7320 6265 656e 2074 6865 7265 2066  has been there f
+0003a730: 6f72 2061 7420 6c65 6173 7420 3330 2073  or at least 30 s
+0003a740: 6563 6f6e 6473 0a20 2020 2020 2020 2020  econds.         
+0003a750: 2020 2860 6064 6973 7472 6962 7574 6564    (``distributed
+0003a760: 2e77 6f72 6b65 722e 6d65 6d6f 7279 2e72  .worker.memory.r
+0003a770: 6563 656e 742d 746f 2d6f 6c64 2d74 696d  ecent-to-old-tim
+0003a780: 6560 6029 2e0a 2020 2020 2020 2020 2020  e``)..          
+0003a790: 2054 6869 7320 6c65 7473 2075 7320 6967   This lets us ig
+0003a7a0: 6e6f 7265 2074 656d 706f 7261 7279 2073  nore temporary s
+0003a7b0: 7069 6b65 7320 6361 7573 6564 2062 7920  pikes caused by 
+0003a7c0: 7461 736b 2068 6561 7020 7573 6167 652e  task heap usage.
+0003a7d0: 0a0a 2020 2020 2020 2020 2020 2041 6c74  ..           Alt
+0003a7e0: 6572 6e61 7469 7665 6c79 2c20 796f 7520  ernatively, you 
+0003a7f0: 6d61 7920 6368 616e 6765 2068 6f77 206d  may change how m
+0003a800: 656d 6f72 7920 6973 206d 6561 7375 7265  emory is measure
+0003a810: 6420 626f 7468 2066 6f72 2074 6865 2069  d both for the i
+0003a820: 6e64 6976 6964 7561 6c0a 2020 2020 2020  ndividual.      
+0003a830: 2020 2020 2077 6f72 6b65 7273 2061 7320       workers as 
+0003a840: 7765 6c6c 2061 7320 746f 2063 616c 6375  well as to calcu
+0003a850: 6c61 7465 2074 6865 206d 6561 6e20 7468  late the mean th
+0003a860: 726f 7567 680a 2020 2020 2020 2020 2020  rough.          
+0003a870: 2060 6064 6973 7472 6962 7574 6564 2e77   ``distributed.w
+0003a880: 6f72 6b65 722e 6d65 6d6f 7279 2e72 6562  orker.memory.reb
+0003a890: 616c 616e 6365 2e6d 6561 7375 7265 6060  alance.measure``
+0003a8a0: 2e20 4e61 6d65 6c79 2c20 7468 6973 2063  . Namely, this c
+0003a8b0: 616e 2062 6520 7573 6566 756c 0a20 2020  an be useful.   
+0003a8c0: 2020 2020 2020 2020 746f 2064 6973 7265          to disre
+0003a8d0: 6761 7264 2069 6e61 6363 7572 6174 6520  gard inaccurate 
+0003a8e0: 4f53 206d 656d 6f72 7920 6d65 6173 7572  OS memory measur
+0003a8f0: 656d 656e 7473 2e0a 0a20 2020 2020 2020  ements...       
+0003a900: 2023 2e20 4469 7363 6172 6420 776f 726b   #. Discard work
+0003a910: 6572 7320 7768 6f73 6520 6f63 6375 7061  ers whose occupa
+0003a920: 6e63 7920 6973 2077 6974 6869 6e20 3525  ncy is within 5%
+0003a930: 206f 6620 7468 6520 6d65 616e 2063 6c75   of the mean clu
+0003a940: 7374 6572 206f 6363 7570 616e 6379 0a20  ster occupancy. 
+0003a950: 2020 2020 2020 2020 2020 2860 6064 6973            (``dis
+0003a960: 7472 6962 7574 6564 2e77 6f72 6b65 722e  tributed.worker.
+0003a970: 6d65 6d6f 7279 2e72 6562 616c 616e 6365  memory.rebalance
+0003a980: 2e73 656e 6465 722d 7265 6369 7069 656e  .sender-recipien
+0003a990: 742d 6761 7060 6020 2f20 3229 2e0a 2020  t-gap`` / 2)..  
+0003a9a0: 2020 2020 2020 2020 2054 6869 7320 6865           This he
+0003a9b0: 6c70 7320 6176 6f69 6420 6461 7461 2066  lps avoid data f
+0003a9c0: 726f 6d20 626f 756e 6369 6e67 2061 726f  rom bouncing aro
+0003a9d0: 756e 6420 7468 6520 636c 7573 7465 7220  und the cluster 
+0003a9e0: 7265 7065 6174 6564 6c79 2e0a 2020 2020  repeatedly..    
+0003a9f0: 2020 2020 232e 2057 6f72 6b65 7273 2061      #. Workers a
+0003aa00: 626f 7665 2074 6865 206d 6561 6e20 6172  bove the mean ar
+0003aa10: 6520 7365 6e64 6572 733b 2074 686f 7365  e senders; those
+0003aa20: 2062 656c 6f77 2061 7265 2072 6563 6970   below are recip
+0003aa30: 6965 6e74 732e 0a20 2020 2020 2020 2023  ients..        #
+0003aa40: 2e20 4469 7363 6172 6420 7365 6e64 6572  . Discard sender
+0003aa50: 7320 7768 6f73 6520 6162 736f 6c75 7465  s whose absolute
+0003aa60: 206f 6363 7570 616e 6379 2069 7320 6265   occupancy is be
+0003aa70: 6c6f 7720 3330 250a 2020 2020 2020 2020  low 30%.        
+0003aa80: 2020 2028 6060 6469 7374 7269 6275 7465     (``distribute
+0003aa90: 642e 776f 726b 6572 2e6d 656d 6f72 792e  d.worker.memory.
+0003aaa0: 7265 6261 6c61 6e63 652e 7365 6e64 6572  rebalance.sender
+0003aab0: 2d6d 696e 6060 292e 2049 6e20 6f74 6865  -min``). In othe
+0003aac0: 7220 776f 7264 732c 206e 6f20 6461 7461  r words, no data
+0003aad0: 0a20 2020 2020 2020 2020 2020 6973 206d  .           is m
+0003aae0: 6f76 6564 2072 6567 6172 646c 6573 7320  oved regardless 
+0003aaf0: 6f66 2069 6d62 616c 616e 6369 6e67 2061  of imbalancing a
+0003ab00: 7320 6c6f 6e67 2061 7320 616c 6c20 776f  s long as all wo
+0003ab10: 726b 6572 7320 6172 6520 6265 6c6f 7720  rkers are below 
+0003ab20: 3330 252e 0a20 2020 2020 2020 2023 2e20  30%..        #. 
+0003ab30: 4469 7363 6172 6420 7265 6369 7069 656e  Discard recipien
+0003ab40: 7473 2077 686f 7365 2061 6273 6f6c 7574  ts whose absolut
+0003ab50: 6520 6f63 6375 7061 6e63 7920 6973 2061  e occupancy is a
+0003ab60: 626f 7665 2036 3025 0a20 2020 2020 2020  bove 60%.       
+0003ab70: 2020 2020 2860 6064 6973 7472 6962 7574      (``distribut
+0003ab80: 6564 2e77 6f72 6b65 722e 6d65 6d6f 7279  ed.worker.memory
+0003ab90: 2e72 6562 616c 616e 6365 2e72 6563 6970  .rebalance.recip
+0003aba0: 6965 6e74 2d6d 6178 6060 292e 0a20 2020  ient-max``)..   
+0003abb0: 2020 2020 2020 2020 4e6f 7465 2074 6861          Note tha
+0003abc0: 7420 7468 6973 2074 6872 6573 686f 6c64  t this threshold
+0003abd0: 2062 7920 6465 6661 756c 7420 6973 2074   by default is t
+0003abe0: 6865 2073 616d 6520 6173 0a20 2020 2020  he same as.     
+0003abf0: 2020 2020 2020 6060 6469 7374 7269 6275        ``distribu
+0003ac00: 7465 642e 776f 726b 6572 2e6d 656d 6f72  ted.worker.memor
+0003ac10: 792e 7461 7267 6574 6060 2074 6f20 7072  y.target`` to pr
+0003ac20: 6576 656e 7420 776f 726b 6572 7320 6672  event workers fr
+0003ac30: 6f6d 2061 6363 6570 7469 6e67 2064 6174  om accepting dat
+0003ac40: 610a 2020 2020 2020 2020 2020 2061 6e64  a.           and
+0003ac50: 2069 6d6d 6564 6961 7465 6c79 2073 7069   immediately spi
+0003ac60: 6c6c 696e 6720 6974 206f 7574 2074 6f20  lling it out to 
+0003ac70: 6469 736b 2e0a 2020 2020 2020 2020 232e  disk..        #.
+0003ac80: 2049 7465 7261 7469 7665 6c79 2070 6963   Iteratively pic
+0003ac90: 6b20 7468 6520 7365 6e64 6572 2061 6e64  k the sender and
+0003aca0: 2072 6563 6970 6965 6e74 2074 6861 7420   recipient that 
+0003acb0: 6172 6520 6661 7274 6865 7374 2066 726f  are farthest fro
+0003acc0: 6d20 7468 6520 6d65 616e 2061 6e64 0a20  m the mean and. 
+0003acd0: 2020 2020 2020 2020 2020 6d6f 7665 2074            move t
+0003ace0: 6865 202a 6c65 6173 7420 7265 6365 6e74  he *least recent
+0003acf0: 6c79 2069 6e73 6572 7465 642a 206b 6579  ly inserted* key
+0003ad00: 2062 6574 7765 656e 2074 6865 2074 776f   between the two
+0003ad10: 2c20 756e 7469 6c20 6569 7468 6572 2061  , until either a
+0003ad20: 6c6c 0a20 2020 2020 2020 2020 2020 7365  ll.           se
+0003ad30: 6e64 6572 7320 6f72 2061 6c6c 2072 6563  nders or all rec
+0003ad40: 6970 6965 6e74 7320 6661 6c6c 2077 6974  ipients fall wit
+0003ad50: 6869 6e20 3525 206f 6620 7468 6520 6d65  hin 5% of the me
+0003ad60: 616e 2e0a 0a20 2020 2020 2020 2020 2020  an...           
+0003ad70: 4120 7265 6369 7069 656e 7420 7769 6c6c  A recipient will
+0003ad80: 2062 6520 736b 6970 7065 6420 6966 2069   be skipped if i
+0003ad90: 7420 616c 7265 6164 7920 6861 7320 6120  t already has a 
+0003ada0: 636f 7079 206f 6620 7468 6520 6461 7461  copy of the data
+0003adb0: 2e20 496e 206f 7468 6572 0a20 2020 2020  . In other.     
+0003adc0: 2020 2020 2020 776f 7264 732c 2074 6869        words, thi
+0003add0: 7320 6d65 7468 6f64 2064 6f65 7320 6e6f  s method does no
+0003ade0: 7420 6465 6772 6164 6520 7265 706c 6963  t degrade replic
+0003adf0: 6174 696f 6e2e 0a20 2020 2020 2020 2020  ation..         
+0003ae00: 2020 4120 6b65 7920 7769 6c6c 2062 6520    A key will be 
+0003ae10: 736b 6970 7065 6420 6966 2074 6865 7265  skipped if there
+0003ae20: 2061 7265 206e 6f20 7265 6369 7069 656e   are no recipien
+0003ae30: 7473 2061 7661 696c 6162 6c65 2077 6974  ts available wit
+0003ae40: 6820 656e 6f75 6768 206d 656d 6f72 790a  h enough memory.
+0003ae50: 2020 2020 2020 2020 2020 2074 6f20 6163             to ac
+0003ae60: 6365 7074 2074 6865 206b 6579 2061 6e64  cept the key and
+0003ae70: 2074 6861 7420 646f 6e27 7420 616c 7265   that don't alre
+0003ae80: 6164 7920 686f 6c64 2061 2063 6f70 792e  ady hold a copy.
+0003ae90: 0a0a 2020 2020 2020 2020 5468 6520 6c65  ..        The le
+0003aea0: 6173 7420 7265 6365 6e74 6c79 2069 6e73  ast recently ins
+0003aeb0: 6572 7464 2028 4c52 4929 2070 6f6c 6963  ertd (LRI) polic
+0003aec0: 7920 6973 2061 2067 7265 6564 7920 6368  y is a greedy ch
+0003aed0: 6f69 6365 2077 6974 6820 7468 6520 6164  oice with the ad
+0003aee0: 7661 6e74 6167 6520 6f66 0a20 2020 2020  vantage of.     
+0003aef0: 2020 2062 6569 6e67 204f 2831 292c 2074     being O(1), t
+0003af00: 7269 7669 616c 2074 6f20 696d 706c 656d  rivial to implem
+0003af10: 656e 7420 2869 7420 7265 6c69 6573 206f  ent (it relies o
+0003af20: 6e20 7079 7468 6f6e 2064 6963 7420 696e  n python dict in
+0003af30: 7365 7274 696f 6e2d 736f 7274 696e 6729  sertion-sorting)
+0003af40: 0a20 2020 2020 2020 2061 6e64 2068 6f70  .        and hop
+0003af50: 6566 756c 6c79 2067 6f6f 6420 656e 6f75  efully good enou
+0003af60: 6768 2069 6e20 6d6f 7374 2063 6173 6573  gh in most cases
+0003af70: 2e20 4469 7363 6172 6465 6420 616c 7465  . Discarded alte
+0003af80: 726e 6174 6976 6520 706f 6c69 6369 6573  rnative policies
+0003af90: 2077 6572 653a 0a0a 2020 2020 2020 2020   were:..        
+0003afa0: 2d20 4c61 7267 6573 7420 6669 7273 742e  - Largest first.
+0003afb0: 204f 286e 2a6c 6f67 286e 2929 2073 6176   O(n*log(n)) sav
+0003afc0: 6520 666f 7220 6e6f 6e2d 7472 6976 6961  e for non-trivia
+0003afd0: 6c20 6164 6469 7469 6f6e 616c 2064 6174  l additional dat
+0003afe0: 6120 7374 7275 6374 7572 6573 2061 6e64  a structures and
+0003aff0: 0a20 2020 2020 2020 2020 2072 6973 6b73  .          risks
+0003b000: 2063 6175 7369 6e67 2074 6865 206c 6172   causing the lar
+0003b010: 6765 7374 2063 6875 6e6b 7320 6f66 2064  gest chunks of d
+0003b020: 6174 6120 746f 2072 6570 6561 7465 646c  ata to repeatedl
+0003b030: 7920 6d6f 7665 2061 726f 756e 6420 7468  y move around th
+0003b040: 650a 2020 2020 2020 2020 2020 636c 7573  e.          clus
+0003b050: 7465 7220 6c69 6b65 2070 696e 6261 6c6c  ter like pinball
+0003b060: 732e 0a20 2020 2020 2020 202d 204c 6561  s..        - Lea
+0003b070: 7374 2072 6563 656e 746c 7920 7573 6564  st recently used
+0003b080: 2028 4c52 5529 2e20 5468 6973 2069 6e66   (LRU). This inf
+0003b090: 6f72 6d61 7469 6f6e 2069 7320 6375 7272  ormation is curr
+0003b0a0: 656e 746c 7920 6176 6169 6c61 626c 6520  ently available 
+0003b0b0: 6f6e 2074 6865 0a20 2020 2020 2020 2020  on the.         
+0003b0c0: 2077 6f72 6b65 7273 206f 6e6c 7920 616e   workers only an
+0003b0d0: 6420 6e6f 7420 7472 6976 6961 6c20 746f  d not trivial to
+0003b0e0: 2072 6570 6c69 6361 7465 206f 6e20 7468   replicate on th
+0003b0f0: 6520 7363 6865 6475 6c65 723b 2074 7261  e scheduler; tra
+0003b100: 6e73 6d69 7474 696e 6720 6974 0a20 2020  nsmitting it.   
+0003b110: 2020 2020 2020 206f 7665 7220 7468 6520         over the 
+0003b120: 6e65 7477 6f72 6b20 776f 756c 6420 6265  network would be
+0003b130: 2076 6572 7920 6578 7065 6e73 6976 652e   very expensive.
+0003b140: 2041 6c73 6f2c 206e 6f74 6520 7468 6174   Also, note that
+0003b150: 2064 6173 6b20 7769 6c6c 2067 6f20 6f75   dask will go ou
+0003b160: 7420 6f66 0a20 2020 2020 2020 2020 2069  t of.          i
+0003b170: 7473 2077 6179 2074 6f20 6d69 6e69 6d69  ts way to minimi
+0003b180: 7365 2074 6865 2061 6d6f 756e 7420 6f66  se the amount of
+0003b190: 2074 696d 6520 696e 7465 726d 6564 6961   time intermedia
+0003b1a0: 7465 206b 6579 7320 6172 6520 6865 6c64  te keys are held
+0003b1b0: 2069 6e20 6d65 6d6f 7279 2c0a 2020 2020   in memory,.    
+0003b1c0: 2020 2020 2020 736f 2069 6e20 7375 6368        so in such
+0003b1d0: 2061 2063 6173 6520 4c52 4920 6973 2061   a case LRI is a
+0003b1e0: 2063 6c6f 7365 2061 7070 726f 7869 6d61   close approxima
+0003b1f0: 7469 6f6e 206f 6620 4c52 552e 0a0a 2020  tion of LRU...  
+0003b200: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
+0003b210: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0003b220: 2d2d 2d0a 2020 2020 2020 2020 6b65 7973  ---.        keys
+0003b230: 3a20 6f70 7469 6f6e 616c 0a20 2020 2020  : optional.     
+0003b240: 2020 2020 2020 2061 6c6c 6f77 6c69 7374         allowlist
+0003b250: 206f 6620 6461 736b 206b 6579 7320 7468   of dask keys th
+0003b260: 6174 2073 686f 756c 6420 6265 2063 6f6e  at should be con
+0003b270: 7369 6465 7265 6420 666f 7220 6d6f 7669  sidered for movi
+0003b280: 6e67 2e20 416c 6c20 6f74 6865 7220 6b65  ng. All other ke
+0003b290: 7973 0a20 2020 2020 2020 2020 2020 2077  ys.            w
+0003b2a0: 696c 6c20 6265 2069 676e 6f72 6564 2e20  ill be ignored. 
+0003b2b0: 4e6f 7465 2074 6861 7420 7468 6973 206f  Note that this o
+0003b2c0: 6666 6572 7320 6e6f 2067 7561 7261 6e74  ffers no guarant
+0003b2d0: 6565 2074 6861 7420 6120 6b65 7920 7769  ee that a key wi
+0003b2e0: 6c6c 2061 6374 7561 6c6c 790a 2020 2020  ll actually.    
+0003b2f0: 2020 2020 2020 2020 6265 206d 6f76 6564          be moved
+0003b300: 2028 652e 672e 2062 6563 6175 7365 2069   (e.g. because i
+0003b310: 7420 6973 2075 6e6e 6563 6573 7361 7279  t is unnecessary
+0003b320: 206f 7220 6265 6361 7573 6520 7468 6572   or because ther
+0003b330: 6520 6172 6520 6e6f 2076 6961 626c 650a  e are no viable.
+0003b340: 2020 2020 2020 2020 2020 2020 7265 6369              reci
+0003b350: 7069 656e 7420 776f 726b 6572 7320 666f  pient workers fo
+0003b360: 7220 6974 292e 0a20 2020 2020 2020 2077  r it)..        w
+0003b370: 6f72 6b65 7273 3a20 6f70 7469 6f6e 616c  orkers: optional
+0003b380: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+0003b390: 6f77 6c69 7374 206f 6620 776f 726b 6572  owlist of worker
+0003b3a0: 7320 6164 6472 6573 7365 7320 746f 2062  s addresses to b
+0003b3b0: 6520 636f 6e73 6964 6572 6564 2061 7320  e considered as 
+0003b3c0: 7365 6e64 6572 7320 6f72 2072 6563 6970  senders or recip
+0003b3d0: 6965 6e74 732e 0a20 2020 2020 2020 2020  ients..         
+0003b3e0: 2020 2041 6c6c 206f 7468 6572 2077 6f72     All other wor
+0003b3f0: 6b65 7273 2077 696c 6c20 6265 2069 676e  kers will be ign
+0003b400: 6f72 6564 2e20 5468 6520 6d65 616e 2063  ored. The mean c
+0003b410: 6c75 7374 6572 206f 6363 7570 616e 6379  luster occupancy
+0003b420: 2077 696c 6c20 6265 0a20 2020 2020 2020   will be.       
+0003b430: 2020 2020 2063 616c 6375 6c61 7465 6420       calculated 
+0003b440: 6f6e 6c79 2075 7369 6e67 2074 6865 2061  only using the a
+0003b450: 6c6c 6f77 6564 2077 6f72 6b65 7273 2e0a  llowed workers..
+0003b460: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0003b470: 2020 2020 7374 696d 756c 7573 5f69 6420      stimulus_id 
+0003b480: 3d20 7374 696d 756c 7573 5f69 6420 6f72  = stimulus_id or
+0003b490: 2066 2272 6562 616c 616e 6365 2d7b 7469   f"rebalance-{ti
+0003b4a0: 6d65 2829 7d22 0a0a 2020 2020 2020 2020  me()}"..        
+0003b4b0: 7773 733a 2043 6f6c 6c65 6374 696f 6e5b  wss: Collection[
+0003b4c0: 576f 726b 6572 5374 6174 655d 0a20 2020  WorkerState].   
+0003b4d0: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
+0003b4e0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+0003b4f0: 2020 2020 2020 2020 2077 7373 203d 205b           wss = [
+0003b500: 7365 6c66 2e77 6f72 6b65 7273 5b77 5d20  self.workers[w] 
+0003b510: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
+0003b520: 5d0a 2020 2020 2020 2020 656c 7365 3a0a  ].        else:.
+0003b530: 2020 2020 2020 2020 2020 2020 7773 7320              wss 
+0003b540: 3d20 7365 6c66 2e77 6f72 6b65 7273 2e76  = self.workers.v
+0003b550: 616c 7565 7328 290a 2020 2020 2020 2020  alues().        
+0003b560: 6966 206e 6f74 2077 7373 3a0a 2020 2020  if not wss:.    
+0003b570: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0003b580: 2273 7461 7475 7322 3a20 224f 4b22 7d0a  "status": "OK"}.
+0003b590: 0a20 2020 2020 2020 2069 6620 6b65 7973  .        if keys
+0003b5a0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+0003b5b0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+0003b5c0: 2069 7369 6e73 7461 6e63 6528 6b65 7973   isinstance(keys
+0003b5d0: 2c20 5365 7429 3a0a 2020 2020 2020 2020  , Set):.        
+0003b5e0: 2020 2020 2020 2020 6b65 7973 203d 2073          keys = s
+0003b5f0: 6574 286b 6579 7329 2020 2320 756e 6c65  et(keys)  # unle
+0003b600: 7373 2061 6c72 6561 6479 2061 2073 6574  ss already a set
+0003b610: 2d6c 696b 650a 2020 2020 2020 2020 2020  -like.          
+0003b620: 2020 6966 206e 6f74 206b 6579 733a 0a20    if not keys:. 
+0003b630: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0003b640: 6574 7572 6e20 7b22 7374 6174 7573 223a  eturn {"status":
+0003b650: 2022 4f4b 227d 0a20 2020 2020 2020 2020   "OK"}.         
+0003b660: 2020 206d 6973 7369 6e67 5f64 6174 6120     missing_data 
+0003b670: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+0003b680: 2020 2020 6b20 666f 7220 6b20 696e 206b      k for k in k
+0003b690: 6579 7320 6966 206b 206e 6f74 2069 6e20  eys if k not in 
+0003b6a0: 7365 6c66 2e74 6173 6b73 206f 7220 6e6f  self.tasks or no
+0003b6b0: 7420 7365 6c66 2e74 6173 6b73 5b6b 5d2e  t self.tasks[k].
+0003b6c0: 7768 6f5f 6861 730a 2020 2020 2020 2020  who_has.        
+0003b6d0: 2020 2020 5d0a 2020 2020 2020 2020 2020      ].          
+0003b6e0: 2020 6966 206d 6973 7369 6e67 5f64 6174    if missing_dat
+0003b6f0: 613a 0a20 2020 2020 2020 2020 2020 2020  a:.             
+0003b700: 2020 2072 6574 7572 6e20 7b22 7374 6174     return {"stat
+0003b710: 7573 223a 2022 7061 7274 6961 6c2d 6661  us": "partial-fa
+0003b720: 696c 222c 2022 6b65 7973 223a 206d 6973  il", "keys": mis
+0003b730: 7369 6e67 5f64 6174 617d 0a0a 2020 2020  sing_data}..    
+0003b740: 2020 2020 6d73 6773 203d 2073 656c 662e      msgs = self.
+0003b750: 5f72 6562 616c 616e 6365 5f66 696e 645f  _rebalance_find_
+0003b760: 6d73 6773 286b 6579 732c 2077 7373 290a  msgs(keys, wss).
+0003b770: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
+0003b780: 7367 733a 0a20 2020 2020 2020 2020 2020  sgs:.           
+0003b790: 2072 6574 7572 6e20 7b22 7374 6174 7573   return {"status
+0003b7a0: 223a 2022 4f4b 227d 0a0a 2020 2020 2020  ": "OK"}..      
+0003b7b0: 2020 2320 446f 776e 6772 6164 6520 7265    # Downgrade re
+0003b7c0: 656e 7472 616e 7420 6c6f 636b 2074 6f20  entrant lock to 
+0003b7d0: 6e6f 6e2d 7265 656e 7472 616e 740a 2020  non-reentrant.  
+0003b7e0: 2020 2020 2020 6173 796e 6320 7769 7468        async with
+0003b7f0: 2073 656c 662e 5f72 6570 6c69 6361 5f6c   self._replica_l
+0003b800: 6f63 6b28 2822 7265 6261 6c61 6e63 6522  ock(("rebalance"
+0003b810: 2c20 6f62 6a65 6374 2829 2929 3a0a 2020  , object())):.  
+0003b820: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+0003b830: 203d 2061 7761 6974 2073 656c 662e 5f72   = await self._r
+0003b840: 6562 616c 616e 6365 5f6d 6f76 655f 6461  ebalance_move_da
+0003b850: 7461 286d 7367 732c 2073 7469 6d75 6c75  ta(msgs, stimulu
+0003b860: 735f 6964 290a 2020 2020 2020 2020 2020  s_id).          
+0003b870: 2020 6966 2072 6573 756c 745b 2273 7461    if result["sta
+0003b880: 7475 7322 5d20 3d3d 2022 7061 7274 6961  tus"] == "partia
+0003b890: 6c2d 6661 696c 2220 616e 6420 6b65 7973  l-fail" and keys
+0003b8a0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
+0003b8b0: 2020 2020 2020 2020 2020 2320 4f6e 6c79            # Only
+0003b8c0: 2072 6574 7572 6e20 6661 696c 6564 206b   return failed k
+0003b8d0: 6579 7320 6966 2074 6865 2063 6c69 656e  eys if the clien
+0003b8e0: 7420 6578 706c 6963 6974 6c79 2061 736b  t explicitly ask
+0003b8f0: 6564 2066 6f72 2074 6865 6d0a 2020 2020  ed for them.    
+0003b900: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+0003b910: 6c74 203d 207b 2273 7461 7475 7322 3a20  lt = {"status": 
+0003b920: 224f 4b22 7d0a 2020 2020 2020 2020 2020  "OK"}.          
+0003b930: 2020 7265 7475 726e 2072 6573 756c 740a    return result.
+0003b940: 0a20 2020 2064 6566 205f 7265 6261 6c61  .    def _rebala
+0003b950: 6e63 655f 6669 6e64 5f6d 7367 7328 0a20  nce_find_msgs(. 
+0003b960: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0003b970: 2020 2020 206b 6579 733a 2053 6574 5b48       keys: Set[H
+0003b980: 6173 6861 626c 655d 207c 204e 6f6e 652c  ashable] | None,
+0003b990: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
+0003b9a0: 3a20 4974 6572 6162 6c65 5b57 6f72 6b65  : Iterable[Worke
+0003b9b0: 7253 7461 7465 5d2c 0a20 2020 2029 202d  rState],.    ) -
+0003b9c0: 3e20 6c69 7374 5b74 7570 6c65 5b57 6f72  > list[tuple[Wor
+0003b9d0: 6b65 7253 7461 7465 2c20 576f 726b 6572  kerState, Worker
+0003b9e0: 5374 6174 652c 2054 6173 6b53 7461 7465  State, TaskState
+0003b9f0: 5d5d 3a0a 2020 2020 2020 2020 2222 2249  ]]:.        """I
+0003ba00: 6465 6e74 6966 7920 776f 726b 6572 7320  dentify workers 
+0003ba10: 7468 6174 206e 6565 6420 746f 206c 6f73  that need to los
+0003ba20: 6520 6b65 7973 2061 6e64 2074 686f 7365  e keys and those
+0003ba30: 2074 6861 7420 6361 6e20 7265 6365 6976   that can receiv
+0003ba40: 6520 7468 656d 2c0a 2020 2020 2020 2020  e them,.        
+0003ba50: 746f 6765 7468 6572 2077 6974 6820 686f  together with ho
+0003ba60: 7720 6d61 6e79 2062 7974 6573 2065 6163  w many bytes eac
+0003ba70: 6820 6e65 6564 7320 746f 206c 6f73 652f  h needs to lose/
+0003ba80: 7265 6365 6976 652e 2054 6865 6e2c 2070  receive. Then, p
+0003ba90: 6169 7220 6120 7365 6e64 6572 0a20 2020  air a sender.   
+0003baa0: 2020 2020 2077 6f72 6b65 7220 7769 7468       worker with
+0003bab0: 2061 2072 6563 6970 6965 6e74 2077 6f72   a recipient wor
+0003bac0: 6b65 7220 666f 7220 6561 6368 206b 6579  ker for each key
+0003bad0: 2c20 756e 7469 6c20 7468 6520 636c 7573  , until the clus
+0003bae0: 7465 7220 6973 2072 6562 616c 616e 6365  ter is rebalance
+0003baf0: 642e 0a0a 2020 2020 2020 2020 5468 6973  d...        This
+0003bb00: 206d 6574 686f 6420 6f6e 6c79 2064 6566   method only def
+0003bb10: 696e 6573 2074 6865 2077 6f72 6b20 746f  ines the work to
+0003bb20: 2062 6520 7065 7266 6f72 6d65 643b 2069   be performed; i
+0003bb30: 7420 646f 6573 206e 6f74 2073 7461 7274  t does not start
+0003bb40: 2061 6e79 206e 6574 776f 726b 0a20 2020   any network.   
+0003bb50: 2020 2020 2074 7261 6e73 6665 7273 2069       transfers i
+0003bb60: 7473 656c 662e 0a0a 2020 2020 2020 2020  tself...        
+0003bb70: 5468 6520 6269 672d 4f20 636f 6d70 6c65  The big-O comple
+0003bb80: 7869 7479 2069 7320 4f28 7774 202b 206b  xity is O(wt + k
+0003bb90: 652a 6c6f 6728 7765 2929 2c20 7768 6572  e*log(we)), wher
+0003bba0: 650a 0a20 2020 2020 2020 202d 2077 7420  e..        - wt 
+0003bbb0: 6973 2074 6865 2074 6f74 616c 206e 756d  is the total num
+0003bbc0: 6265 7220 6f66 2077 6f72 6b65 7273 206f  ber of workers o
+0003bbd0: 6e20 7468 6520 636c 7573 7465 7220 286f  n the cluster (o
+0003bbe0: 7220 7468 6520 6e75 6d62 6572 206f 6620  r the number of 
+0003bbf0: 616c 6c6f 7765 640a 2020 2020 2020 2020  allowed.        
+0003bc00: 2020 776f 726b 6572 732c 2069 6620 6578    workers, if ex
+0003bc10: 706c 6963 6974 6c79 2073 7461 7465 6420  plicitly stated 
+0003bc20: 6279 2074 6865 2075 7365 7229 0a20 2020  by the user).   
+0003bc30: 2020 2020 202d 2077 6520 6973 2074 6865       - we is the
+0003bc40: 206e 756d 6265 7220 6f66 2077 6f72 6b65   number of worke
+0003bc50: 7273 2074 6861 7420 6172 6520 656c 6967  rs that are elig
+0003bc60: 6962 6c65 2074 6f20 6265 2073 656e 6465  ible to be sende
+0003bc70: 7273 206f 7220 7265 6369 7069 656e 7473  rs or recipients
+0003bc80: 0a20 2020 2020 2020 202d 206b 7420 6973  .        - kt is
+0003bc90: 2074 6865 2074 6f74 616c 206e 756d 6265   the total numbe
+0003bca0: 7220 6f66 206b 6579 7320 6f6e 2074 6865  r of keys on the
+0003bcb0: 2063 6c75 7374 6572 2028 6f72 206f 6e20   cluster (or on 
+0003bcc0: 7468 6520 616c 6c6f 7765 6420 776f 726b  the allowed work
+0003bcd0: 6572 7329 0a20 2020 2020 2020 202d 206b  ers).        - k
+0003bce0: 6520 6973 2074 6865 206e 756d 6265 7220  e is the number 
+0003bcf0: 6f66 206b 6579 7320 7468 6174 206e 6565  of keys that nee
+0003bd00: 6420 746f 2062 6520 6d6f 7665 6420 696e  d to be moved in
+0003bd10: 206f 7264 6572 2074 6f20 6163 6869 6576   order to achiev
+0003bd20: 6520 6120 6261 6c61 6e63 6564 0a20 2020  e a balanced.   
+0003bd30: 2020 2020 2020 2063 6c75 7374 6572 0a0a         cluster..
+0003bd40: 2020 2020 2020 2020 5468 6572 6520 6973          There is
+0003bd50: 2061 2064 6567 656e 6572 6174 6520 6564   a degenerate ed
+0003bd60: 6765 2063 6173 6520 4f28 7774 202b 206b  ge case O(wt + k
+0003bd70: 742a 6c6f 6728 7765 2929 2077 6865 6e20  t*log(we)) when 
+0003bd80: 6b74 2069 7320 6d75 6368 2067 7265 6174  kt is much great
+0003bd90: 6572 2074 6861 6e0a 2020 2020 2020 2020  er than.        
+0003bda0: 7468 6520 6e75 6d62 6572 206f 6620 616c  the number of al
+0003bdb0: 6c6f 7765 6420 6b65 7973 2c20 6f72 2077  lowed keys, or w
+0003bdc0: 6865 6e20 6d6f 7374 206b 6579 7320 6172  hen most keys ar
+0003bdd0: 6520 7265 706c 6963 6174 6564 206f 7220  e replicated or 
+0003bde0: 6361 6e6e 6f74 2062 650a 2020 2020 2020  cannot be.      
+0003bdf0: 2020 6d6f 7665 6420 666f 7220 736f 6d65    moved for some
+0003be00: 206f 7468 6572 2072 6561 736f 6e2e 0a0a   other reason...
+0003be10: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
+0003be20: 6c69 7374 206f 6620 7475 706c 6573 2074  list of tuples t
+0003be30: 6f20 6665 6564 2069 6e74 6f20 5f72 6562  o feed into _reb
+0003be40: 616c 616e 6365 5f6d 6f76 655f 6461 7461  alance_move_data
+0003be50: 3a0a 0a20 2020 2020 2020 202d 2073 656e  :..        - sen
+0003be60: 6465 7220 776f 726b 6572 0a20 2020 2020  der worker.     
+0003be70: 2020 202d 2072 6563 6970 6965 6e74 2077     - recipient w
+0003be80: 6f72 6b65 720a 2020 2020 2020 2020 2d20  orker.        - 
+0003be90: 7461 736b 2074 6f20 6265 2074 7261 6e73  task to be trans
+0003bea0: 6665 7272 6564 0a20 2020 2020 2020 2022  ferred.        "
+0003beb0: 2222 0a20 2020 2020 2020 2023 2048 6561  "".        # Hea
+0003bec0: 7073 206f 6620 776f 726b 6572 732c 206d  ps of workers, m
+0003bed0: 616e 6167 6564 2062 7920 7468 6520 6865  anaged by the he
+0003bee0: 6170 7120 6d6f 6475 6c65 2c20 7468 6174  apq module, that
+0003bef0: 206e 6565 6420 746f 2073 656e 642f 7265   need to send/re
+0003bf00: 6365 6976 6520 6461 7461 2c0a 2020 2020  ceive data,.    
+0003bf10: 2020 2020 2320 7769 7468 2068 6f77 206d      # with how m
+0003bf20: 616e 7920 6279 7465 7320 6561 6368 206e  any bytes each n
+0003bf30: 6565 6473 2074 6f20 7365 6e64 2f72 6563  eeds to send/rec
+0003bf40: 6569 7665 2e0a 2020 2020 2020 2020 230a  eive..        #.
+0003bf50: 2020 2020 2020 2020 2320 4561 6368 2065          # Each e
+0003bf60: 6c65 6d65 6e74 206f 6620 7468 6520 6865  lement of the he
+0003bf70: 6170 2069 7320 6120 7475 706c 6520 636f  ap is a tuple co
+0003bf80: 6e73 7472 7563 7465 6420 6173 2066 6f6c  nstructed as fol
+0003bf90: 6c6f 7773 3a0a 2020 2020 2020 2020 2320  lows:.        # 
+0003bfa0: 2d20 736e 645f 6279 7465 735f 6d61 782f  - snd_bytes_max/
+0003bfb0: 7265 635f 6279 7465 735f 6d61 783a 206d  rec_bytes_max: m
+0003bfc0: 6178 696d 756d 206e 756d 6265 7220 6f66  aximum number of
+0003bfd0: 2062 7974 6573 2074 6f20 7365 6e64 206f   bytes to send o
+0003bfe0: 7220 7265 6365 6976 652e 0a20 2020 2020  r receive..     
+0003bff0: 2020 2023 2020 2054 6869 7320 6e75 6d62     #   This numb
+0003c000: 6572 2069 7320 6e65 6761 7469 7665 2c20  er is negative, 
+0003c010: 736f 2074 6861 7420 7468 6520 776f 726b  so that the work
+0003c020: 6572 7320 6661 7274 6865 7374 2066 726f  ers farthest fro
+0003c030: 6d20 7468 6520 636c 7573 7465 7220 6d65  m the cluster me
+0003c040: 616e 0a20 2020 2020 2020 2023 2020 2061  an.        #   a
+0003c050: 7265 2061 7420 7468 6520 746f 7020 6f66  re at the top of
+0003c060: 2074 6865 2073 6d61 6c6c 6573 742d 6669   the smallest-fi
+0003c070: 7273 7420 6865 6170 732e 0a20 2020 2020  rst heaps..     
+0003c080: 2020 2023 202d 2073 6e64 5f62 7974 6573     # - snd_bytes
+0003c090: 5f6d 696e 2f72 6563 5f62 7974 6573 5f6d  _min/rec_bytes_m
+0003c0a0: 696e 3a20 6d69 6e69 6d75 6d20 6e75 6d62  in: minimum numb
+0003c0b0: 6572 206f 6620 6279 7465 7320 6166 7465  er of bytes afte
+0003c0c0: 7220 7365 6e64 696e 672f 7265 6365 6976  r sending/receiv
+0003c0d0: 696e 670a 2020 2020 2020 2020 2320 2020  ing.        #   
+0003c0e0: 7768 6963 6820 7468 6520 776f 726b 6572  which the worker
+0003c0f0: 2073 686f 756c 6420 6e6f 7420 6265 2063   should not be c
+0003c100: 6f6e 7369 6465 7265 6420 616e 796d 6f72  onsidered anymor
+0003c110: 652e 2054 6869 7320 6973 2061 6c73 6f20  e. This is also 
+0003c120: 6e65 6761 7469 7665 2e0a 2020 2020 2020  negative..      
+0003c130: 2020 2320 2d20 6172 6269 7472 6172 7920    # - arbitrary 
+0003c140: 756e 6971 7565 206e 756d 6265 722c 2074  unique number, t
+0003c150: 6865 7265 206a 7573 7420 746f 2074 6f20  here just to to 
+0003c160: 6d61 6b65 2073 7572 6520 7468 6174 2057  make sure that W
+0003c170: 6f72 6b65 7253 7461 7465 206f 626a 6563  orkerState objec
+0003c180: 7473 0a20 2020 2020 2020 2023 2020 2061  ts.        #   a
+0003c190: 7265 206e 6576 6572 2075 7365 6420 666f  re never used fo
+0003c1a0: 7220 736f 7274 696e 6720 696e 2074 6865  r sorting in the
+0003c1b0: 2075 6e6c 696b 656c 7920 6576 656e 7420   unlikely event 
+0003c1c0: 7468 6174 2074 776f 2070 726f 6365 7373  that two process
+0003c1d0: 6573 2068 6176 650a 2020 2020 2020 2020  es have.        
+0003c1e0: 2320 2020 6578 6163 746c 7920 7468 6520  #   exactly the 
+0003c1f0: 7361 6d65 206e 756d 6265 7220 6f66 2062  same number of b
+0003c200: 7974 6573 2061 6c6c 6f63 6174 6564 2e0a  ytes allocated..
+0003c210: 2020 2020 2020 2020 2320 2d20 576f 726b          # - Work
+0003c220: 6572 5374 6174 650a 2020 2020 2020 2020  erState.        
+0003c230: 2320 2d20 6974 6572 6174 6f72 206f 6620  # - iterator of 
+0003c240: 616c 6c20 7461 736b 7320 696e 206d 656d  all tasks in mem
+0003c250: 6f72 7920 6f6e 2074 6865 2077 6f72 6b65  ory on the worke
+0003c260: 7220 2873 656e 6465 7273 206f 6e6c 7929  r (senders only)
+0003c270: 2c20 696e 7365 7274 696f 6e0a 2020 2020  , insertion.    
+0003c280: 2020 2020 2320 2020 736f 7274 6564 2028      #   sorted (
+0003c290: 6c65 6173 7420 7265 6365 6e74 6c79 2069  least recently i
+0003c2a0: 6e73 6572 7465 6420 6669 7273 7429 2e0a  nserted first)..
+0003c2b0: 2020 2020 2020 2020 2320 2020 4e6f 7465          #   Note
+0003c2c0: 2074 6861 7420 7468 6973 2069 7465 7261   that this itera
+0003c2d0: 746f 7220 7769 6c6c 2074 7970 6963 616c  tor will typical
+0003c2e0: 6c79 202a 6e6f 742a 2062 6520 6578 6861  ly *not* be exha
+0003c2f0: 7573 7465 642e 2049 7420 7769 6c6c 206f  usted. It will o
+0003c300: 6e6c 7920 6265 0a20 2020 2020 2020 2023  nly be.        #
+0003c310: 2020 2065 7868 6175 7374 6564 2069 662c     exhausted if,
+0003c320: 2061 6674 6572 206d 6f76 696e 6720 6177   after moving aw
+0003c330: 6179 2066 726f 6d20 7468 6520 776f 726b  ay from the work
+0003c340: 6572 2061 6c6c 206b 6579 7320 7468 6174  er all keys that
+0003c350: 2063 616e 2062 6520 6d6f 7665 642c 0a20   can be moved,. 
+0003c360: 2020 2020 2020 2023 2020 2069 7320 696e         #   is in
+0003c370: 7375 6666 6963 6965 6e74 2074 6f20 6472  sufficient to dr
+0003c380: 6f70 2073 6e64 5f62 7974 6573 5f6d 696e  op snd_bytes_min
+0003c390: 2061 626f 7665 2030 2e0a 2020 2020 2020   above 0..      
+0003c3a0: 2020 7365 6e64 6572 733a 206c 6973 745b    senders: list[
+0003c3b0: 7475 706c 655b 696e 742c 2069 6e74 2c20  tuple[int, int, 
+0003c3c0: 696e 742c 2057 6f72 6b65 7253 7461 7465  int, WorkerState
+0003c3d0: 2c20 4974 6572 6174 6f72 5b54 6173 6b53  , Iterator[TaskS
+0003c3e0: 7461 7465 5d5d 5d20 3d20 5b5d 0a20 2020  tate]]] = [].   
+0003c3f0: 2020 2020 2072 6563 6970 6965 6e74 733a       recipients:
+0003c400: 206c 6973 745b 7475 706c 655b 696e 742c   list[tuple[int,
+0003c410: 2069 6e74 2c20 696e 742c 2057 6f72 6b65   int, int, Worke
+0003c420: 7253 7461 7465 5d5d 203d 205b 5d0a 0a20  rState]] = [].. 
+0003c430: 2020 2020 2020 2023 204f 7574 7075 743a         # Output:
+0003c440: 205b 2873 656e 6465 722c 2072 6563 6970   [(sender, recip
+0003c450: 6965 6e74 2c20 7461 736b 292c 202e 2e2e  ient, task), ...
+0003c460: 5d0a 2020 2020 2020 2020 6d73 6773 3a20  ].        msgs: 
+0003c470: 6c69 7374 5b74 7570 6c65 5b57 6f72 6b65  list[tuple[Worke
+0003c480: 7253 7461 7465 2c20 576f 726b 6572 5374  rState, WorkerSt
+0003c490: 6174 652c 2054 6173 6b53 7461 7465 5d5d  ate, TaskState]]
+0003c4a0: 203d 205b 5d0a 0a20 2020 2020 2020 2023   = []..        #
+0003c4b0: 2042 7920 6465 6661 756c 742c 2074 6869   By default, thi
+0003c4c0: 7320 6973 2074 6865 206f 7074 696d 6973  s is the optimis
+0003c4d0: 7469 6320 6d65 6d6f 7279 2c20 6d65 616e  tic memory, mean
+0003c4e0: 696e 6720 746f 7461 6c20 7072 6f63 6573  ing total proces
+0003c4f0: 7320 6d65 6d6f 7279 206d 696e 7573 0a20  s memory minus. 
+0003c500: 2020 2020 2020 2023 2075 6e6d 616e 6167         # unmanag
+0003c510: 6564 206d 656d 6f72 7920 7468 6174 2061  ed memory that a
+0003c520: 7070 6561 7265 6420 6f76 6572 2074 6865  ppeared over the
+0003c530: 206c 6173 7420 3330 2073 6563 6f6e 6473   last 30 seconds
+0003c540: 0a20 2020 2020 2020 2023 2028 6469 7374  .        # (dist
+0003c550: 7269 6275 7465 642e 776f 726b 6572 2e6d  ributed.worker.m
+0003c560: 656d 6f72 792e 7265 6365 6e74 2d74 6f2d  emory.recent-to-
+0003c570: 6f6c 642d 7469 6d65 292e 0a20 2020 2020  old-time)..     
+0003c580: 2020 2023 2054 6869 7320 6c65 7473 2075     # This lets u
+0003c590: 7320 6967 6e6f 7265 2074 656d 706f 7261  s ignore tempora
+0003c5a0: 7279 2073 7069 6b65 7320 6361 7573 6564  ry spikes caused
+0003c5b0: 2062 7920 7461 736b 2068 6561 7020 7573   by task heap us
+0003c5c0: 6167 652e 0a20 2020 2020 2020 206d 656d  age..        mem
+0003c5d0: 6f72 795f 6279 5f77 6f72 6b65 7220 3d20  ory_by_worker = 
+0003c5e0: 5b0a 2020 2020 2020 2020 2020 2020 2877  [.            (w
+0003c5f0: 732c 2067 6574 6174 7472 2877 732e 6d65  s, getattr(ws.me
+0003c600: 6d6f 7279 2c20 7365 6c66 2e4d 454d 4f52  mory, self.MEMOR
+0003c610: 595f 5245 4241 4c41 4e43 455f 4d45 4153  Y_REBALANCE_MEAS
+0003c620: 5552 4529 2920 666f 7220 7773 2069 6e20  URE)) for ws in 
+0003c630: 776f 726b 6572 730a 2020 2020 2020 2020  workers.        
+0003c640: 5d0a 2020 2020 2020 2020 6d65 616e 5f6d  ].        mean_m
+0003c650: 656d 6f72 7920 3d20 7375 6d28 6d20 666f  emory = sum(m fo
+0003c660: 7220 5f2c 206d 2069 6e20 6d65 6d6f 7279  r _, m in memory
+0003c670: 5f62 795f 776f 726b 6572 2920 2f2f 206c  _by_worker) // l
+0003c680: 656e 286d 656d 6f72 795f 6279 5f77 6f72  en(memory_by_wor
+0003c690: 6b65 7229 0a0a 2020 2020 2020 2020 666f  ker)..        fo
+0003c6a0: 7220 7773 2c20 7773 5f6d 656d 6f72 7920  r ws, ws_memory 
+0003c6b0: 696e 206d 656d 6f72 795f 6279 5f77 6f72  in memory_by_wor
+0003c6c0: 6b65 723a 0a20 2020 2020 2020 2020 2020  ker:.           
+0003c6d0: 2069 6620 7773 2e6d 656d 6f72 795f 6c69   if ws.memory_li
+0003c6e0: 6d69 743a 0a20 2020 2020 2020 2020 2020  mit:.           
+0003c6f0: 2020 2020 2068 616c 665f 6761 7020 3d20       half_gap = 
+0003c700: 696e 7428 7365 6c66 2e4d 454d 4f52 595f  int(self.MEMORY_
+0003c710: 5245 4241 4c41 4e43 455f 4841 4c46 5f47  REBALANCE_HALF_G
+0003c720: 4150 202a 2077 732e 6d65 6d6f 7279 5f6c  AP * ws.memory_l
+0003c730: 696d 6974 290a 2020 2020 2020 2020 2020  imit).          
+0003c740: 2020 2020 2020 7365 6e64 6572 5f6d 696e        sender_min
+0003c750: 203d 2073 656c 662e 4d45 4d4f 5259 5f52   = self.MEMORY_R
+0003c760: 4542 414c 414e 4345 5f53 454e 4445 525f  EBALANCE_SENDER_
+0003c770: 4d49 4e20 2a20 7773 2e6d 656d 6f72 795f  MIN * ws.memory_
+0003c780: 6c69 6d69 740a 2020 2020 2020 2020 2020  limit.          
+0003c790: 2020 2020 2020 7265 6369 7069 656e 745f        recipient_
+0003c7a0: 6d61 7820 3d20 7365 6c66 2e4d 454d 4f52  max = self.MEMOR
+0003c7b0: 595f 5245 4241 4c41 4e43 455f 5245 4349  Y_REBALANCE_RECI
+0003c7c0: 5049 454e 545f 4d41 5820 2a20 7773 2e6d  PIENT_MAX * ws.m
+0003c7d0: 656d 6f72 795f 6c69 6d69 740a 2020 2020  emory_limit.    
+0003c7e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0003c7f0: 2020 2020 2020 2020 2020 2020 2020 6861                ha
+0003c800: 6c66 5f67 6170 203d 2030 0a20 2020 2020  lf_gap = 0.     
+0003c810: 2020 2020 2020 2020 2020 2073 656e 6465             sende
+0003c820: 725f 6d69 6e20 3d20 302e 300a 2020 2020  r_min = 0.0.    
+0003c830: 2020 2020 2020 2020 2020 2020 7265 6369              reci
+0003c840: 7069 656e 745f 6d61 7820 3d20 6d61 7468  pient_max = math
+0003c850: 2e69 6e66 0a0a 2020 2020 2020 2020 2020  .inf..          
+0003c860: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
+0003c870: 2020 2020 2020 2077 732e 5f68 6173 5f77         ws._has_w
+0003c880: 6861 740a 2020 2020 2020 2020 2020 2020  hat.            
+0003c890: 2020 2020 616e 6420 7773 5f6d 656d 6f72      and ws_memor
+0003c8a0: 7920 3e3d 206d 6561 6e5f 6d65 6d6f 7279  y >= mean_memory
+0003c8b0: 202b 2068 616c 665f 6761 700a 2020 2020   + half_gap.    
+0003c8c0: 2020 2020 2020 2020 2020 2020 616e 6420              and 
+0003c8d0: 7773 5f6d 656d 6f72 7920 3e3d 2073 656e  ws_memory >= sen
+0003c8e0: 6465 725f 6d69 6e0a 2020 2020 2020 2020  der_min.        
+0003c8f0: 2020 2020 293a 0a20 2020 2020 2020 2020      ):.         
+0003c900: 2020 2020 2020 2023 2054 6869 7320 6d61         # This ma
+0003c910: 7920 7365 6e64 2074 6865 2077 6f72 6b65  y send the worke
+0003c920: 7220 6265 6c6f 7720 7365 6e64 6572 5f6d  r below sender_m
+0003c930: 696e 2028 6279 2064 6573 6967 6e29 0a20  in (by design). 
+0003c940: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0003c950: 6e64 5f62 7974 6573 5f6d 6178 203d 206d  nd_bytes_max = m
+0003c960: 6561 6e5f 6d65 6d6f 7279 202d 2077 735f  ean_memory - ws_
+0003c970: 6d65 6d6f 7279 2020 2320 6e65 6761 7469  memory  # negati
+0003c980: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
+0003c990: 2020 2073 6e64 5f62 7974 6573 5f6d 696e     snd_bytes_min
+0003c9a0: 203d 2073 6e64 5f62 7974 6573 5f6d 6178   = snd_bytes_max
+0003c9b0: 202b 2068 616c 665f 6761 7020 2023 206e   + half_gap  # n
+0003c9c0: 6567 6174 6976 650a 2020 2020 2020 2020  egative.        
+0003c9d0: 2020 2020 2020 2020 2320 5365 6520 6465          # See de
+0003c9e0: 6669 6e69 7469 6f6e 206f 6620 7365 6e64  finition of send
+0003c9f0: 6572 7320 6162 6f76 650a 2020 2020 2020  ers above.      
+0003ca00: 2020 2020 2020 2020 2020 7365 6e64 6572            sender
+0003ca10: 732e 6170 7065 6e64 280a 2020 2020 2020  s.append(.      
+0003ca20: 2020 2020 2020 2020 2020 2020 2020 2873                (s
+0003ca30: 6e64 5f62 7974 6573 5f6d 6178 2c20 736e  nd_bytes_max, sn
+0003ca40: 645f 6279 7465 735f 6d69 6e2c 2069 6428  d_bytes_min, id(
+0003ca50: 7773 292c 2077 732c 2069 7465 7228 7773  ws), ws, iter(ws
+0003ca60: 2e5f 6861 735f 7768 6174 2929 0a20 2020  ._has_what)).   
+0003ca70: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
+0003ca80: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0003ca90: 7773 5f6d 656d 6f72 7920 3c20 6d65 616e  ws_memory < mean
+0003caa0: 5f6d 656d 6f72 7920 2d20 6861 6c66 5f67  _memory - half_g
+0003cab0: 6170 2061 6e64 2077 735f 6d65 6d6f 7279  ap and ws_memory
+0003cac0: 203c 2072 6563 6970 6965 6e74 5f6d 6178   < recipient_max
+0003cad0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003cae0: 2020 2320 5468 6973 206d 6179 2073 656e    # This may sen
+0003caf0: 6420 7468 6520 776f 726b 6572 2061 626f  d the worker abo
+0003cb00: 7665 2072 6563 6970 6965 6e74 5f6d 6178  ve recipient_max
+0003cb10: 2028 6279 2064 6573 6967 6e29 0a20 2020   (by design).   
+0003cb20: 2020 2020 2020 2020 2020 2020 2072 6563               rec
+0003cb30: 5f62 7974 6573 5f6d 6178 203d 2077 735f  _bytes_max = ws_
+0003cb40: 6d65 6d6f 7279 202d 206d 6561 6e5f 6d65  memory - mean_me
+0003cb50: 6d6f 7279 2020 2320 6e65 6761 7469 7665  mory  # negative
+0003cb60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003cb70: 2072 6563 5f62 7974 6573 5f6d 696e 203d   rec_bytes_min =
+0003cb80: 2072 6563 5f62 7974 6573 5f6d 6178 202b   rec_bytes_max +
+0003cb90: 2068 616c 665f 6761 7020 2023 206e 6567   half_gap  # neg
+0003cba0: 6174 6976 650a 2020 2020 2020 2020 2020  ative.          
+0003cbb0: 2020 2020 2020 2320 5365 6520 6465 6669        # See defi
+0003cbc0: 6e69 7469 6f6e 206f 6620 7265 6369 7069  nition of recipi
+0003cbd0: 656e 7473 2061 626f 7665 0a20 2020 2020  ents above.     
+0003cbe0: 2020 2020 2020 2020 2020 2072 6563 6970             recip
+0003cbf0: 6965 6e74 732e 6170 7065 6e64 2828 7265  ients.append((re
+0003cc00: 635f 6279 7465 735f 6d61 782c 2072 6563  c_bytes_max, rec
+0003cc10: 5f62 7974 6573 5f6d 696e 2c20 6964 2877  _bytes_min, id(w
+0003cc20: 7329 2c20 7773 2929 0a0a 2020 2020 2020  s), ws))..      
+0003cc30: 2020 2320 4661 7374 2065 7869 7420 696e    # Fast exit in
+0003cc40: 2063 6173 6520 6e6f 2074 7261 6e73 6665   case no transfe
+0003cc50: 7273 2061 7265 206e 6563 6573 7361 7279  rs are necessary
+0003cc60: 206f 7220 706f 7373 6962 6c65 0a20 2020   or possible.   
+0003cc70: 2020 2020 2069 6620 6e6f 7420 7365 6e64       if not send
+0003cc80: 6572 7320 6f72 206e 6f74 2072 6563 6970  ers or not recip
+0003cc90: 6965 6e74 733a 0a20 2020 2020 2020 2020  ients:.         
+0003cca0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+0003ccb0: 7428 0a20 2020 2020 2020 2020 2020 2020  t(.             
+0003ccc0: 2020 2022 616c 6c22 2c0a 2020 2020 2020     "all",.      
+0003ccd0: 2020 2020 2020 2020 2020 7b0a 2020 2020            {.    
+0003cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ccf0: 2261 6374 696f 6e22 3a20 2272 6562 616c  "action": "rebal
+0003cd00: 616e 6365 222c 0a20 2020 2020 2020 2020  ance",.         
+0003cd10: 2020 2020 2020 2020 2020 2022 7365 6e64             "send
+0003cd20: 6572 7322 3a20 6c65 6e28 7365 6e64 6572  ers": len(sender
+0003cd30: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+0003cd40: 2020 2020 2020 2020 2272 6563 6970 6965          "recipie
+0003cd50: 6e74 7322 3a20 6c65 6e28 7265 6369 7069  nts": len(recipi
+0003cd60: 656e 7473 292c 0a20 2020 2020 2020 2020  ents),.         
+0003cd70: 2020 2020 2020 2020 2020 2022 6d6f 7665             "move
+0003cd80: 645f 6b65 7973 223a 2030 2c0a 2020 2020  d_keys": 0,.    
+0003cd90: 2020 2020 2020 2020 2020 2020 7d2c 0a20              },. 
+0003cda0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0003cdb0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0003cdc0: 5b5d 0a0a 2020 2020 2020 2020 6865 6170  []..        heap
+0003cdd0: 712e 6865 6170 6966 7928 7365 6e64 6572  q.heapify(sender
+0003cde0: 7329 0a20 2020 2020 2020 2068 6561 7071  s).        heapq
+0003cdf0: 2e68 6561 7069 6679 2872 6563 6970 6965  .heapify(recipie
+0003ce00: 6e74 7329 0a0a 2020 2020 2020 2020 7768  nts)..        wh
+0003ce10: 696c 6520 7365 6e64 6572 7320 616e 6420  ile senders and 
+0003ce20: 7265 6369 7069 656e 7473 3a0a 2020 2020  recipients:.    
+0003ce30: 2020 2020 2020 2020 736e 645f 6279 7465          snd_byte
+0003ce40: 735f 6d61 782c 2073 6e64 5f62 7974 6573  s_max, snd_bytes
+0003ce50: 5f6d 696e 2c20 5f2c 2073 6e64 5f77 732c  _min, _, snd_ws,
+0003ce60: 2074 735f 6974 6572 203d 2073 656e 6465   ts_iter = sende
+0003ce70: 7273 5b30 5d0a 0a20 2020 2020 2020 2020  rs[0]..         
+0003ce80: 2020 2023 2049 7465 7261 7465 2074 6872     # Iterate thr
+0003ce90: 6f75 6768 2074 6173 6b73 2069 6e20 6d65  ough tasks in me
+0003cea0: 6d6f 7279 2c20 6c65 6173 7420 7265 6365  mory, least rece
+0003ceb0: 6e74 6c79 2069 6e73 6572 7465 6420 6669  ntly inserted fi
+0003cec0: 7273 740a 2020 2020 2020 2020 2020 2020  rst.            
+0003ced0: 666f 7220 7473 2069 6e20 7473 5f69 7465  for ts in ts_ite
+0003cee0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0003cef0: 2020 2069 6620 6b65 7973 2069 7320 6e6f     if keys is no
+0003cf00: 7420 4e6f 6e65 2061 6e64 2074 732e 6b65  t None and ts.ke
+0003cf10: 7920 6e6f 7420 696e 206b 6579 733a 0a20  y not in keys:. 
+0003cf20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cf30: 2020 2063 6f6e 7469 6e75 650a 2020 2020     continue.    
+0003cf40: 2020 2020 2020 2020 2020 2020 6e62 7974              nbyt
+0003cf50: 6573 203d 2074 732e 6e62 7974 6573 0a20  es = ts.nbytes. 
+0003cf60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0003cf70: 6620 6e62 7974 6573 202b 2073 6e64 5f62  f nbytes + snd_b
+0003cf80: 7974 6573 5f6d 6178 203e 2030 3a0a 2020  ytes_max > 0:.  
+0003cf90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003cfa0: 2020 2320 4d6f 7669 6e67 2074 6869 7320    # Moving this 
+0003cfb0: 7461 736b 2077 6f75 6c64 2063 6175 7365  task would cause
+0003cfc0: 2074 6865 2073 656e 6465 7220 746f 2067   the sender to g
+0003cfd0: 6f20 6265 6c6f 7720 6d65 616e 2061 6e64  o below mean and
+0003cfe0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003cff0: 2020 2020 2023 2070 6f74 656e 7469 616c       # potential
+0003d000: 6c79 2072 6973 6b20 6265 636f 6d69 6e67  ly risk becoming
+0003d010: 2061 2072 6563 6970 6965 6e74 2c20 7768   a recipient, wh
+0003d020: 6963 6820 776f 756c 6420 6361 7573 6520  ich would cause 
+0003d030: 7461 736b 7320 746f 0a20 2020 2020 2020  tasks to.       
+0003d040: 2020 2020 2020 2020 2020 2020 2023 2062               # b
+0003d050: 6f75 6e63 6520 6172 6f75 6e64 2e20 4d6f  ounce around. Mo
+0003d060: 7665 206f 6e20 746f 2074 6865 206e 6578  ve on to the nex
+0003d070: 7420 7461 736b 206f 6620 7468 6520 7361  t task of the sa
+0003d080: 6d65 2073 656e 6465 722e 0a20 2020 2020  me sender..     
+0003d090: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0003d0a0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+0003d0b0: 2020 2020 2020 2020 2023 2046 696e 6420           # Find 
+0003d0c0: 7468 6520 7265 6369 7069 656e 742c 2066  the recipient, f
+0003d0d0: 6172 7468 6573 7420 6672 6f6d 2074 6865  arthest from the
+0003d0e0: 206d 6561 6e2c 2077 6869 6368 0a20 2020   mean, which.   
+0003d0f0: 2020 2020 2020 2020 2020 2020 2023 2031               # 1
+0003d100: 2e20 6861 7320 656e 6f75 6768 2061 7661  . has enough ava
+0003d110: 696c 6162 6c65 2052 414d 2066 6f72 2074  ilable RAM for t
+0003d120: 6869 7320 7461 736b 2c20 616e 640a 2020  his task, and.  
+0003d130: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003d140: 322e 2064 6f65 736e 2774 2068 6f6c 6420  2. doesn't hold 
+0003d150: 6120 636f 7079 206f 6620 7468 6973 2074  a copy of this t
+0003d160: 6173 6b20 616c 7265 6164 790a 2020 2020  ask already.    
+0003d170: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+0003d180: 6572 6520 6d61 7920 6e6f 7420 6265 2061  ere may not be a
+0003d190: 6e79 2074 6861 7420 7361 7469 7366 6965  ny that satisfie
+0003d1a0: 7320 7468 6573 6520 636f 6e64 6974 696f  s these conditio
+0003d1b0: 6e73 3b20 696e 2074 6869 7320 6361 7365  ns; in this case
+0003d1c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d1d0: 2023 2074 6869 7320 7461 736b 2077 6f6e   # this task won
+0003d1e0: 2774 2062 6520 6d6f 7665 642e 0a20 2020  't be moved..   
+0003d1f0: 2020 2020 2020 2020 2020 2020 2073 6b69               ski
+0003d200: 7070 6564 5f72 6563 6970 6965 6e74 7320  pped_recipients 
+0003d210: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+0003d220: 2020 2020 2075 7365 5f72 6563 6970 6965       use_recipie
+0003d230: 6e74 203d 2046 616c 7365 0a20 2020 2020  nt = False.     
+0003d240: 2020 2020 2020 2020 2020 2077 6869 6c65             while
+0003d250: 2072 6563 6970 6965 6e74 7320 616e 6420   recipients and 
+0003d260: 6e6f 7420 7573 655f 7265 6369 7069 656e  not use_recipien
+0003d270: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+0003d280: 2020 2020 2020 2072 6563 5f62 7974 6573         rec_bytes
+0003d290: 5f6d 6178 2c20 7265 635f 6279 7465 735f  _max, rec_bytes_
+0003d2a0: 6d69 6e2c 205f 2c20 7265 635f 7773 203d  min, _, rec_ws =
+0003d2b0: 2072 6563 6970 6965 6e74 735b 305d 0a20   recipients[0]. 
+0003d2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d2d0: 2020 2069 6620 6e62 7974 6573 202b 2072     if nbytes + r
+0003d2e0: 6563 5f62 7974 6573 5f6d 6178 203e 2030  ec_bytes_max > 0
+0003d2f0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003d300: 2020 2020 2020 2020 2020 2320 7265 6369            # reci
+0003d310: 7069 656e 7473 2061 7265 2073 6f72 7465  pients are sorte
+0003d320: 6420 6279 2072 6563 5f62 7974 6573 5f6d  d by rec_bytes_m
+0003d330: 6178 2e0a 2020 2020 2020 2020 2020 2020  ax..            
+0003d340: 2020 2020 2020 2020 2020 2020 2320 5468              # Th
+0003d350: 6520 6e65 7874 206f 6e65 7320 7769 6c6c  e next ones will
+0003d360: 2062 6520 776f 7273 653b 206e 6f20 7265   be worse; no re
+0003d370: 6173 6f6e 2074 6f20 636f 6e74 696e 7565  ason to continue
+0003d380: 2069 7465 7261 7469 6e67 0a20 2020 2020   iterating.     
+0003d390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d3a0: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
+0003d3b0: 2020 2020 2020 2020 2020 2020 2075 7365               use
+0003d3c0: 5f72 6563 6970 6965 6e74 203d 2074 7320  _recipient = ts 
+0003d3d0: 6e6f 7420 696e 2072 6563 5f77 732e 5f68  not in rec_ws._h
+0003d3e0: 6173 5f77 6861 740a 2020 2020 2020 2020  as_what.        
+0003d3f0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+0003d400: 6f74 2075 7365 5f72 6563 6970 6965 6e74  ot use_recipient
+0003d410: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003d420: 2020 2020 2020 2020 2020 736b 6970 7065            skippe
+0003d430: 645f 7265 6369 7069 656e 7473 2e61 7070  d_recipients.app
+0003d440: 656e 6428 6865 6170 712e 6865 6170 706f  end(heapq.heappo
+0003d450: 7028 7265 6369 7069 656e 7473 2929 0a0a  p(recipients))..
 0003d460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d470: 666f 7220 772c 2077 686f 5f68 6173 2069  for w, who_has i
-0003d480: 6e20 746f 5f72 6563 6970 6965 6e74 732e  n to_recipients.
-0003d490: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
-0003d4a0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-0003d4b0: 2020 2020 2020 2020 2020 2020 2020 292c                ),
-0003d4c0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-0003d4d0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0003d4e0: 2020 746f 5f73 656e 6465 7273 203d 2064    to_senders = d
-0003d4f0: 6566 6175 6c74 6469 6374 286c 6973 7429  efaultdict(list)
-0003d500: 0a20 2020 2020 2020 2066 6f72 2073 6e64  .        for snd
-0003d510: 5f77 732c 2072 6563 5f77 732c 2074 7320  _ws, rec_ws, ts 
-0003d520: 696e 206d 7367 733a 0a20 2020 2020 2020  in msgs:.       
-0003d530: 2020 2020 2069 6620 7473 2e6b 6579 206e       if ts.key n
-0003d540: 6f74 2069 6e20 6661 696c 6564 5f6b 6579  ot in failed_key
-0003d550: 735f 6279 5f72 6563 6970 6965 6e74 5b72  s_by_recipient[r
-0003d560: 6563 5f77 732e 6164 6472 6573 735d 3a0a  ec_ws.address]:.
-0003d570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003d580: 746f 5f73 656e 6465 7273 5b73 6e64 5f77  to_senders[snd_w
-0003d590: 732e 6164 6472 6573 735d 2e61 7070 656e  s.address].appen
-0003d5a0: 6428 7473 2e6b 6579 290a 0a20 2020 2020  d(ts.key)..     
-0003d5b0: 2020 2023 204e 6f74 653a 2074 6869 7320     # Note: this 
-0003d5c0: 6e65 7665 7220 7261 6973 6573 2065 7863  never raises exc
-0003d5d0: 6570 7469 6f6e 730a 2020 2020 2020 2020  eptions.        
-0003d5e0: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
-0003d5f0: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
-0003d600: 2020 2a28 7365 6c66 2e64 656c 6574 655f    *(self.delete_
-0003d610: 776f 726b 6572 5f64 6174 6128 722c 2076  worker_data(r, v
-0003d620: 2c20 7374 696d 756c 7573 5f69 6429 2066  , stimulus_id) f
-0003d630: 6f72 2072 2c20 7620 696e 2074 6f5f 7365  or r, v in to_se
-0003d640: 6e64 6572 732e 6974 656d 7328 2929 0a20  nders.items()). 
-0003d650: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0003d660: 2020 666f 7220 722c 2076 2069 6e20 746f    for r, v in to
-0003d670: 5f72 6563 6970 6965 6e74 732e 6974 656d  _recipients.item
-0003d680: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0003d690: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
-0003d6a0: 722c 207b 2261 6374 696f 6e22 3a20 2272  r, {"action": "r
-0003d6b0: 6562 616c 616e 6365 222c 2022 7768 6f5f  ebalance", "who_
-0003d6c0: 6861 7322 3a20 767d 290a 2020 2020 2020  has": v}).      
-0003d6d0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-0003d6e0: 280a 2020 2020 2020 2020 2020 2020 2261  (.            "a
-0003d6f0: 6c6c 222c 0a20 2020 2020 2020 2020 2020  ll",.           
-0003d700: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0003d710: 2020 2022 6163 7469 6f6e 223a 2022 7265     "action": "re
-0003d720: 6261 6c61 6e63 6522 2c0a 2020 2020 2020  balance",.      
-0003d730: 2020 2020 2020 2020 2020 2273 656e 6465            "sende
-0003d740: 7273 223a 2076 616c 6d61 7028 6c65 6e2c  rs": valmap(len,
-0003d750: 2074 6f5f 7365 6e64 6572 7329 2c0a 2020   to_senders),.  
-0003d760: 2020 2020 2020 2020 2020 2020 2020 2272                "r
-0003d770: 6563 6970 6965 6e74 7322 3a20 7661 6c6d  ecipients": valm
-0003d780: 6170 286c 656e 2c20 746f 5f72 6563 6970  ap(len, to_recip
-0003d790: 6965 6e74 7329 2c0a 2020 2020 2020 2020  ients),.        
-0003d7a0: 2020 2020 2020 2020 226d 6f76 6564 5f6b          "moved_k
-0003d7b0: 6579 7322 3a20 6c65 6e28 6d73 6773 292c  eys": len(msgs),
-0003d7c0: 0a20 2020 2020 2020 2020 2020 207d 2c0a  .            },.
-0003d7d0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-0003d7e0: 2020 206d 6973 7369 6e67 5f6b 6579 7320     missing_keys 
-0003d7f0: 3d20 7b6b 2066 6f72 2072 2069 6e20 6661  = {k for r in fa
-0003d800: 696c 6564 5f6b 6579 735f 6279 5f72 6563  iled_keys_by_rec
-0003d810: 6970 6965 6e74 2e76 616c 7565 7328 2920  ipient.values() 
-0003d820: 666f 7220 6b20 696e 2072 7d0a 2020 2020  for k in r}.    
-0003d830: 2020 2020 6966 206d 6973 7369 6e67 5f6b      if missing_k
-0003d840: 6579 733a 0a20 2020 2020 2020 2020 2020  eys:.           
-0003d850: 2072 6574 7572 6e20 7b22 7374 6174 7573   return {"status
-0003d860: 223a 2022 7061 7274 6961 6c2d 6661 696c  ": "partial-fail
-0003d870: 222c 2022 6b65 7973 223a 206c 6973 7428  ", "keys": list(
-0003d880: 6d69 7373 696e 675f 6b65 7973 297d 0a20  missing_keys)}. 
-0003d890: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0003d8a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0003d8b0: 7b22 7374 6174 7573 223a 2022 4f4b 227d  {"status": "OK"}
-0003d8c0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-0003d8d0: 7265 706c 6963 6174 6528 0a20 2020 2020  replicate(.     
-0003d8e0: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0003d8f0: 2063 6f6d 6d3d 4e6f 6e65 2c0a 2020 2020   comm=None,.    
-0003d900: 2020 2020 6b65 7973 3d4e 6f6e 652c 0a20      keys=None,. 
-0003d910: 2020 2020 2020 206e 3d4e 6f6e 652c 0a20         n=None,. 
-0003d920: 2020 2020 2020 2077 6f72 6b65 7273 3d4e         workers=N
-0003d930: 6f6e 652c 0a20 2020 2020 2020 2062 7261  one,.        bra
-0003d940: 6e63 6869 6e67 5f66 6163 746f 723d 322c  nching_factor=2,
-0003d950: 0a20 2020 2020 2020 2064 656c 6574 653d  .        delete=
-0003d960: 5472 7565 2c0a 2020 2020 2020 2020 7374  True,.        st
-0003d970: 696d 756c 7573 5f69 643d 4e6f 6e65 2c0a  imulus_id=None,.
-0003d980: 2020 2020 293a 0a20 2020 2020 2020 2022      ):.        "
-0003d990: 2222 5265 706c 6963 6174 6520 6461 7461  ""Replicate data
-0003d9a0: 2074 6872 6f75 6768 6f75 7420 636c 7573   throughout clus
-0003d9b0: 7465 720a 0a20 2020 2020 2020 2054 6869  ter..        Thi
-0003d9c0: 7320 7065 7266 6f72 6d73 2061 2074 7265  s performs a tre
-0003d9d0: 6520 636f 7079 206f 6620 7468 6520 6461  e copy of the da
-0003d9e0: 7461 2074 6872 6f75 6768 6f75 7420 7468  ta throughout th
-0003d9f0: 6520 6e65 7477 6f72 6b0a 2020 2020 2020  e network.      
-0003da00: 2020 696e 6469 7669 6475 616c 6c79 206f    individually o
-0003da10: 6e20 6561 6368 2070 6965 6365 206f 6620  n each piece of 
-0003da20: 6461 7461 2e0a 0a20 2020 2020 2020 2050  data...        P
-0003da30: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
-0003da40: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-0003da50: 2020 2020 206b 6579 733a 2049 7465 7261       keys: Itera
-0003da60: 626c 650a 2020 2020 2020 2020 2020 2020  ble.            
-0003da70: 6c69 7374 206f 6620 6b65 7973 2074 6f20  list of keys to 
-0003da80: 7265 706c 6963 6174 650a 2020 2020 2020  replicate.      
-0003da90: 2020 6e3a 2069 6e74 0a20 2020 2020 2020    n: int.       
-0003daa0: 2020 2020 204e 756d 6265 7220 6f66 2072       Number of r
-0003dab0: 6570 6c69 6361 7469 6f6e 7320 7765 2065  eplications we e
-0003dac0: 7870 6563 7420 746f 2073 6565 2077 6974  xpect to see wit
-0003dad0: 6869 6e20 7468 6520 636c 7573 7465 720a  hin the cluster.
-0003dae0: 2020 2020 2020 2020 6272 616e 6368 696e          branchin
-0003daf0: 675f 6661 6374 6f72 3a20 696e 742c 206f  g_factor: int, o
-0003db00: 7074 696f 6e61 6c0a 2020 2020 2020 2020  ptional.        
-0003db10: 2020 2020 5468 6520 6e75 6d62 6572 206f      The number o
-0003db20: 6620 776f 726b 6572 7320 7468 6174 2063  f workers that c
-0003db30: 616e 2063 6f70 7920 6461 7461 2069 6e20  an copy data in 
-0003db40: 6561 6368 2067 656e 6572 6174 696f 6e2e  each generation.
-0003db50: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
-0003db60: 206c 6172 6765 7220 7468 6520 6272 616e   larger the bran
-0003db70: 6368 696e 6720 6661 6374 6f72 2c20 7468  ching factor, th
-0003db80: 6520 6d6f 7265 2064 6174 6120 7765 2063  e more data we c
-0003db90: 6f70 7920 696e 0a20 2020 2020 2020 2020  opy in.         
-0003dba0: 2020 2061 2073 696e 676c 6520 7374 6570     a single step
-0003dbb0: 2c20 6275 7420 7468 6520 6d6f 7265 2061  , but the more a
-0003dbc0: 2067 6976 656e 2077 6f72 6b65 7220 7269   given worker ri
-0003dbd0: 736b 7320 6265 696e 670a 2020 2020 2020  sks being.      
-0003dbe0: 2020 2020 2020 7377 616d 7065 6420 6279        swamped by
-0003dbf0: 2064 6174 6120 7265 7175 6573 7473 2e0a   data requests..
-0003dc00: 0a20 2020 2020 2020 2053 6565 2061 6c73  .        See als
-0003dc10: 6f0a 2020 2020 2020 2020 2d2d 2d2d 2d2d  o.        ------
-0003dc20: 2d2d 0a20 2020 2020 2020 2053 6368 6564  --.        Sched
-0003dc30: 756c 6572 2e72 6562 616c 616e 6365 0a20  uler.rebalance. 
-0003dc40: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0003dc50: 2020 2073 7469 6d75 6c75 735f 6964 203d     stimulus_id =
-0003dc60: 2073 7469 6d75 6c75 735f 6964 206f 7220   stimulus_id or 
-0003dc70: 6622 7265 706c 6963 6174 652d 7b74 696d  f"replicate-{tim
-0003dc80: 6528 297d 220a 2020 2020 2020 2020 6173  e()}".        as
-0003dc90: 7365 7274 2062 7261 6e63 6869 6e67 5f66  sert branching_f
-0003dca0: 6163 746f 7220 3e20 300a 2020 2020 2020  actor > 0.      
-0003dcb0: 2020 2320 446f 776e 6772 6164 6520 7265    # Downgrade re
-0003dcc0: 656e 7472 616e 7420 6c6f 636b 2074 6f20  entrant lock to 
-0003dcd0: 6e6f 6e2d 7265 656e 7472 616e 740a 2020  non-reentrant.  
-0003dce0: 2020 2020 2020 6173 796e 6320 7769 7468        async with
-0003dcf0: 2073 656c 662e 5f72 6570 6c69 6361 5f6c   self._replica_l
-0003dd00: 6f63 6b28 2822 7265 706c 6963 6174 6522  ock(("replicate"
-0003dd10: 2c20 6f62 6a65 6374 2829 2929 3a0a 2020  , object())):.  
-0003dd20: 2020 2020 2020 2020 2020 6966 2077 6f72            if wor
-0003dd30: 6b65 7273 2069 7320 6e6f 7420 4e6f 6e65  kers is not None
-0003dd40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003dd50: 2020 776f 726b 6572 7320 3d20 7b73 656c    workers = {sel
-0003dd60: 662e 776f 726b 6572 735b 775d 2066 6f72  f.workers[w] for
-0003dd70: 2077 2069 6e20 7365 6c66 2e77 6f72 6b65   w in self.worke
-0003dd80: 7273 5f6c 6973 7428 776f 726b 6572 7329  rs_list(workers)
-0003dd90: 7d0a 2020 2020 2020 2020 2020 2020 2020  }.              
-0003dda0: 2020 776f 726b 6572 7320 3d20 7b77 7320    workers = {ws 
-0003ddb0: 666f 7220 7773 2069 6e20 776f 726b 6572  for ws in worker
-0003ddc0: 7320 6966 2077 732e 7374 6174 7573 203d  s if ws.status =
-0003ddd0: 3d20 5374 6174 7573 2e72 756e 6e69 6e67  = Status.running
-0003dde0: 7d0a 2020 2020 2020 2020 2020 2020 656c  }.            el
-0003ddf0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0003de00: 2020 2020 776f 726b 6572 7320 3d20 7365      workers = se
-0003de10: 6c66 2e72 756e 6e69 6e67 0a0a 2020 2020  lf.running..    
-0003de20: 2020 2020 2020 2020 6966 206e 2069 7320          if n is 
-0003de30: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
-0003de40: 2020 2020 2020 6e20 3d20 6c65 6e28 776f        n = len(wo
-0003de50: 726b 6572 7329 0a20 2020 2020 2020 2020  rkers).         
-0003de60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0003de70: 2020 2020 2020 2020 206e 203d 206d 696e           n = min
-0003de80: 286e 2c20 6c65 6e28 776f 726b 6572 7329  (n, len(workers)
-0003de90: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-0003dea0: 206e 203d 3d20 303a 0a20 2020 2020 2020   n == 0:.       
-0003deb0: 2020 2020 2020 2020 2072 6169 7365 2056           raise V
-0003dec0: 616c 7565 4572 726f 7228 2243 616e 206e  alueError("Can n
-0003ded0: 6f74 2075 7365 2072 6570 6c69 6361 7465  ot use replicate
-0003dee0: 2074 6f20 6465 6c65 7465 2064 6174 6122   to delete data"
-0003def0: 290a 0a20 2020 2020 2020 2020 2020 2074  )..            t
-0003df00: 6173 6b73 203d 207b 7365 6c66 2e74 6173  asks = {self.tas
-0003df10: 6b73 5b6b 5d20 666f 7220 6b20 696e 206b  ks[k] for k in k
-0003df20: 6579 737d 0a20 2020 2020 2020 2020 2020  eys}.           
-0003df30: 206d 6973 7369 6e67 5f64 6174 6120 3d20   missing_data = 
-0003df40: 5b74 732e 6b65 7920 666f 7220 7473 2069  [ts.key for ts i
-0003df50: 6e20 7461 736b 7320 6966 206e 6f74 2074  n tasks if not t
-0003df60: 732e 7768 6f5f 6861 735d 0a20 2020 2020  s.who_has].     
-0003df70: 2020 2020 2020 2069 6620 6d69 7373 696e         if missin
-0003df80: 675f 6461 7461 3a0a 2020 2020 2020 2020  g_data:.        
-0003df90: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0003dfa0: 2273 7461 7475 7322 3a20 2270 6172 7469  "status": "parti
-0003dfb0: 616c 2d66 6169 6c22 2c20 226b 6579 7322  al-fail", "keys"
-0003dfc0: 3a20 6d69 7373 696e 675f 6461 7461 7d0a  : missing_data}.
-0003dfd0: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
-0003dfe0: 656c 6574 6520 6578 7472 616e 656f 7573  elete extraneous
-0003dff0: 2064 6174 610a 2020 2020 2020 2020 2020   data.          
-0003e000: 2020 6966 2064 656c 6574 653a 0a20 2020    if delete:.   
-0003e010: 2020 2020 2020 2020 2020 2020 2064 656c               del
-0003e020: 5f77 6f72 6b65 725f 7461 736b 7320 3d20  _worker_tasks = 
-0003e030: 6465 6661 756c 7464 6963 7428 7365 7429  defaultdict(set)
-0003e040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e050: 2066 6f72 2074 7320 696e 2074 6173 6b73   for ts in tasks
-0003e060: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003e070: 2020 2020 2020 6465 6c5f 6361 6e64 6964        del_candid
-0003e080: 6174 6573 203d 2074 7570 6c65 2874 732e  ates = tuple(ts.
-0003e090: 7768 6f5f 6861 7320 2620 776f 726b 6572  who_has & worker
-0003e0a0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0003e0b0: 2020 2020 2020 2069 6620 6c65 6e28 6465         if len(de
-0003e0c0: 6c5f 6361 6e64 6964 6174 6573 2920 3e20  l_candidates) > 
-0003e0d0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
-0003e0e0: 2020 2020 2020 2020 2020 2066 6f72 2077             for w
-0003e0f0: 7320 696e 2072 616e 646f 6d2e 7361 6d70  s in random.samp
-0003e100: 6c65 280a 2020 2020 2020 2020 2020 2020  le(.            
-0003e110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e120: 6465 6c5f 6361 6e64 6964 6174 6573 2c20  del_candidates, 
-0003e130: 6c65 6e28 6465 6c5f 6361 6e64 6964 6174  len(del_candidat
-0003e140: 6573 2920 2d20 6e0a 2020 2020 2020 2020  es) - n.        
-0003e150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e160: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003e170: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0003e180: 656c 5f77 6f72 6b65 725f 7461 736b 735b  el_worker_tasks[
-0003e190: 7773 5d2e 6164 6428 7473 290a 0a20 2020  ws].add(ts)..   
-0003e1a0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-0003e1b0: 6f74 653a 2074 6869 7320 6e65 7665 7220  ote: this never 
-0003e1c0: 7261 6973 6573 2065 7863 6570 7469 6f6e  raises exception
-0003e1d0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-0003e1e0: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
-0003e1f0: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
-0003e200: 2020 2020 2020 2020 2020 2020 2a5b 0a20              *[. 
-0003e210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e220: 2020 2020 2020 2073 656c 662e 6465 6c65         self.dele
-0003e230: 7465 5f77 6f72 6b65 725f 6461 7461 280a  te_worker_data(.
-0003e240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e250: 2020 2020 2020 2020 2020 2020 7773 2e61              ws.a
-0003e260: 6464 7265 7373 2c20 5b74 2e6b 6579 2066  ddress, [t.key f
-0003e270: 6f72 2074 2069 6e20 7461 736b 735d 2c20  or t in tasks], 
-0003e280: 7374 696d 756c 7573 5f69 640a 2020 2020  stimulus_id.    
-0003e290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e2a0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0003e2b0: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-0003e2c0: 7220 7773 2c20 7461 736b 7320 696e 2064  r ws, tasks in d
-0003e2d0: 656c 5f77 6f72 6b65 725f 7461 736b 732e  el_worker_tasks.
-0003e2e0: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
-0003e2f0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
-0003e300: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-0003e310: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-0003e320: 6f70 7920 6e6f 742d 7965 742d 6669 6c6c  opy not-yet-fill
-0003e330: 6564 2064 6174 610a 2020 2020 2020 2020  ed data.        
-0003e340: 2020 2020 7768 696c 6520 7461 736b 733a      while tasks:
-0003e350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e360: 2067 6174 6865 7273 203d 2064 6566 6175   gathers = defau
-0003e370: 6c74 6469 6374 2864 6963 7429 0a20 2020  ltdict(dict).   
-0003e380: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0003e390: 2074 7320 696e 206c 6973 7428 7461 736b   ts in list(task
-0003e3a0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0003e3b0: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
-0003e3c0: 6174 6520 3d3d 2022 666f 7267 6f74 7465  ate == "forgotte
-0003e3d0: 6e22 3a0a 2020 2020 2020 2020 2020 2020  n":.            
-0003e3e0: 2020 2020 2020 2020 2020 2020 2320 7461              # ta
-0003e3f0: 736b 2069 7320 6e6f 206c 6f6e 6765 7220  sk is no longer 
-0003e400: 6e65 6564 6564 2062 7920 616e 7920 636c  needed by any cl
-0003e410: 6965 6e74 206f 7220 6465 7065 6e64 656e  ient or dependen
-0003e420: 7420 7461 736b 0a20 2020 2020 2020 2020  t task.         
-0003e430: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-0003e440: 6173 6b73 2e72 656d 6f76 6528 7473 290a  asks.remove(ts).
-0003e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e460: 2020 2020 2020 2020 636f 6e74 696e 7565          continue
-0003e470: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e480: 2020 2020 2061 7373 6572 7420 7473 2e77       assert ts.w
-0003e490: 686f 5f68 6173 2069 7320 6e6f 7420 4e6f  ho_has is not No
-0003e4a0: 6e65 0a20 2020 2020 2020 2020 2020 2020  ne.             
-0003e4b0: 2020 2020 2020 206e 5f6d 6973 7369 6e67         n_missing
-0003e4c0: 203d 206e 202d 206c 656e 2874 732e 7768   = n - len(ts.wh
-0003e4d0: 6f5f 6861 7320 2620 776f 726b 6572 7329  o_has & workers)
-0003e4e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e4f0: 2020 2020 2069 6620 6e5f 6d69 7373 696e       if n_missin
-0003e500: 6720 3c3d 2030 3a0a 2020 2020 2020 2020  g <= 0:.        
-0003e510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e520: 2320 416c 7265 6164 7920 7265 706c 6963  # Already replic
-0003e530: 6174 6564 2065 6e6f 7567 680a 2020 2020  ated enough.    
-0003e540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e550: 2020 2020 7461 736b 732e 7265 6d6f 7665      tasks.remove
-0003e560: 2874 7329 0a20 2020 2020 2020 2020 2020  (ts).           
-0003e570: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-0003e580: 7469 6e75 650a 0a20 2020 2020 2020 2020  tinue..         
-0003e590: 2020 2020 2020 2020 2020 2063 6f75 6e74             count
-0003e5a0: 203d 206d 696e 286e 5f6d 6973 7369 6e67   = min(n_missing
-0003e5b0: 2c20 6272 616e 6368 696e 675f 6661 6374  , branching_fact
-0003e5c0: 6f72 202a 206c 656e 2874 732e 7768 6f5f  or * len(ts.who_
-0003e5d0: 6861 7329 290a 2020 2020 2020 2020 2020  has)).          
-0003e5e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0003e5f0: 2063 6f75 6e74 203e 2030 0a0a 2020 2020   count > 0..    
-0003e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e610: 666f 7220 7773 2069 6e20 7261 6e64 6f6d  for ws in random
-0003e620: 2e73 616d 706c 6528 7475 706c 6528 776f  .sample(tuple(wo
-0003e630: 726b 6572 7320 2d20 7473 2e77 686f 5f68  rkers - ts.who_h
-0003e640: 6173 292c 2063 6f75 6e74 293a 0a20 2020  as), count):.   
-0003e650: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e660: 2020 2020 2067 6174 6865 7273 5b77 732e       gathers[ws.
-0003e670: 6164 6472 6573 735d 5b74 732e 6b65 795d  address][ts.key]
-0003e680: 203d 205b 0a20 2020 2020 2020 2020 2020   = [.           
-0003e690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e6a0: 2077 7773 2e61 6464 7265 7373 2066 6f72   wws.address for
-0003e6b0: 2077 7773 2069 6e20 7473 2e77 686f 5f68   wws in ts.who_h
-0003e6c0: 6173 0a20 2020 2020 2020 2020 2020 2020  as.             
-0003e6d0: 2020 2020 2020 2020 2020 205d 0a0a 2020             ]..  
-0003e6e0: 2020 2020 2020 2020 2020 2020 2020 6177                aw
-0003e6f0: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
-0003e700: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
-0003e710: 2020 2020 2020 2020 2a28 0a20 2020 2020          *(.     
-0003e720: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e730: 2020 2023 204e 6f74 653a 2074 6869 7320     # Note: this 
-0003e740: 6e65 7665 7220 7261 6973 6573 2065 7863  never raises exc
-0003e750: 6570 7469 6f6e 730a 2020 2020 2020 2020  eptions.        
-0003e760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e770: 7365 6c66 2e67 6174 6865 725f 6f6e 5f77  self.gather_on_w
-0003e780: 6f72 6b65 7228 772c 2077 686f 5f68 6173  orker(w, who_has
-0003e790: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003e7a0: 2020 2020 2020 2020 2020 666f 7220 772c            for w,
-0003e7b0: 2077 686f 5f68 6173 2069 6e20 6761 7468   who_has in gath
-0003e7c0: 6572 732e 6974 656d 7328 290a 2020 2020  ers.items().    
-0003e7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e7e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0003e7f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0003e800: 2020 2020 666f 7220 722c 2076 2069 6e20      for r, v in 
-0003e810: 6761 7468 6572 732e 6974 656d 7328 293a  gathers.items():
-0003e820: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e830: 2020 2020 2073 656c 662e 6c6f 675f 6576       self.log_ev
-0003e840: 656e 7428 722c 207b 2261 6374 696f 6e22  ent(r, {"action"
-0003e850: 3a20 2272 6570 6c69 6361 7465 2d61 6464  : "replicate-add
-0003e860: 222c 2022 7768 6f5f 6861 7322 3a20 767d  ", "who_has": v}
-0003e870: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
-0003e880: 656c 662e 6c6f 675f 6576 656e 7428 0a20  elf.log_event(. 
-0003e890: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-0003e8a0: 616c 6c22 2c0a 2020 2020 2020 2020 2020  all",.          
-0003e8b0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
-0003e8c0: 2020 2020 2020 2020 2020 2020 2261 6374              "act
-0003e8d0: 696f 6e22 3a20 2272 6570 6c69 6361 7465  ion": "replicate
-0003e8e0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-0003e8f0: 2020 2020 2020 2022 776f 726b 6572 7322         "workers"
-0003e900: 3a20 6c69 7374 2877 6f72 6b65 7273 292c  : list(workers),
-0003e910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0003e920: 2020 2020 2022 6b65 792d 636f 756e 7422       "key-count"
-0003e930: 3a20 6c65 6e28 6b65 7973 292c 0a20 2020  : len(keys),.   
-0003e940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0003e950: 2022 6272 616e 6368 696e 672d 6661 6374   "branching-fact
-0003e960: 6f72 223a 2062 7261 6e63 6869 6e67 5f66  or": branching_f
-0003e970: 6163 746f 722c 0a20 2020 2020 2020 2020  actor,.         
-0003e980: 2020 2020 2020 207d 2c0a 2020 2020 2020         },.      
-0003e990: 2020 2020 2020 290a 0a20 2020 2040 6c6f        )..    @lo
-0003e9a0: 675f 6572 726f 7273 0a20 2020 2064 6566  g_errors.    def
-0003e9b0: 2077 6f72 6b65 7273 5f74 6f5f 636c 6f73   workers_to_clos
-0003e9c0: 6528 0a20 2020 2020 2020 2073 656c 662c  e(.        self,
-0003e9d0: 0a20 2020 2020 2020 206d 656d 6f72 795f  .        memory_
-0003e9e0: 7261 7469 6f3a 2069 6e74 207c 2066 6c6f  ratio: int | flo
-0003e9f0: 6174 207c 204e 6f6e 6520 3d20 4e6f 6e65  at | None = None
-0003ea00: 2c0a 2020 2020 2020 2020 6e3a 2069 6e74  ,.        n: int
-0003ea10: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0003ea20: 2020 2020 2020 2020 6b65 793a 2043 616c          key: Cal
-0003ea30: 6c61 626c 655b 5b57 6f72 6b65 7253 7461  lable[[WorkerSta
-0003ea40: 7465 5d2c 2048 6173 6861 626c 655d 207c  te], Hashable] |
-0003ea50: 2062 7974 6573 207c 204e 6f6e 6520 3d20   bytes | None = 
-0003ea60: 4e6f 6e65 2c0a 2020 2020 2020 2020 6d69  None,.        mi
-0003ea70: 6e69 6d75 6d3a 2069 6e74 207c 204e 6f6e  nimum: int | Non
-0003ea80: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-0003ea90: 2020 7461 7267 6574 3a20 696e 7420 7c20    target: int | 
-0003eaa0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-0003eab0: 2020 2020 2061 7474 7269 6275 7465 3a20       attribute: 
-0003eac0: 7374 7220 3d20 2261 6464 7265 7373 222c  str = "address",
-0003ead0: 0a20 2020 2029 202d 3e20 6c69 7374 5b73  .    ) -> list[s
-0003eae0: 7472 5d3a 0a20 2020 2020 2020 2022 2222  tr]:.        """
-0003eaf0: 0a20 2020 2020 2020 2046 696e 6420 776f  .        Find wo
-0003eb00: 726b 6572 7320 7468 6174 2077 6520 6361  rkers that we ca
-0003eb10: 6e20 636c 6f73 6520 7769 7468 206c 6f77  n close with low
-0003eb20: 2063 6f73 740a 0a20 2020 2020 2020 2054   cost..        T
-0003eb30: 6869 7320 7265 7475 726e 7320 6120 6c69  his returns a li
-0003eb40: 7374 206f 6620 776f 726b 6572 7320 7468  st of workers th
-0003eb50: 6174 2061 7265 2067 6f6f 6420 6361 6e64  at are good cand
-0003eb60: 6964 6174 6573 2074 6f20 7265 7469 7265  idates to retire
-0003eb70: 2e0a 2020 2020 2020 2020 5468 6573 6520  ..        These 
-0003eb80: 776f 726b 6572 7320 6172 6520 6e6f 7420  workers are not 
-0003eb90: 7275 6e6e 696e 6720 616e 7974 6869 6e67  running anything
-0003eba0: 2061 6e64 2061 7265 2073 746f 7269 6e67   and are storing
-0003ebb0: 0a20 2020 2020 2020 2072 656c 6174 6976  .        relativ
-0003ebc0: 656c 7920 6c69 7474 6c65 2064 6174 6120  ely little data 
-0003ebd0: 7265 6c61 7469 7665 2074 6f20 7468 6569  relative to thei
-0003ebe0: 7220 7065 6572 732e 2020 4966 2061 6c6c  r peers.  If all
-0003ebf0: 2077 6f72 6b65 7273 2061 7265 0a20 2020   workers are.   
-0003ec00: 2020 2020 2069 646c 6520 7468 656e 2077       idle then w
-0003ec10: 6520 7374 696c 6c20 6d61 696e 7461 696e  e still maintain
-0003ec20: 2065 6e6f 7567 6820 776f 726b 6572 7320   enough workers 
-0003ec30: 746f 2068 6176 6520 656e 6f75 6768 2052  to have enough R
-0003ec40: 414d 2074 6f20 7374 6f72 650a 2020 2020  AM to store.    
-0003ec50: 2020 2020 6f75 7220 6461 7461 2c20 7769      our data, wi
-0003ec60: 7468 2061 2063 6f6d 666f 7274 6162 6c65  th a comfortable
-0003ec70: 2062 7566 6665 722e 0a0a 2020 2020 2020   buffer...      
-0003ec80: 2020 5468 6973 2069 7320 666f 7220 7573    This is for us
-0003ec90: 6520 7769 7468 2073 7973 7465 6d73 206c  e with systems l
-0003eca0: 696b 6520 6060 6469 7374 7269 6275 7465  ike ``distribute
-0003ecb0: 642e 6465 706c 6f79 2e61 6461 7074 6976  d.deploy.adaptiv
-0003ecc0: 6560 602e 0a0a 2020 2020 2020 2020 5061  e``...        Pa
-0003ecd0: 7261 6d65 7465 7273 0a20 2020 2020 2020  rameters.       
-0003ece0: 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020 2020   ----------.    
-0003ecf0: 2020 2020 6d65 6d6f 7279 5f72 6174 696f      memory_ratio
-0003ed00: 203a 204e 756d 6265 720a 2020 2020 2020   : Number.      
-0003ed10: 2020 2020 2020 416d 6f75 6e74 206f 6620        Amount of 
-0003ed20: 6578 7472 6120 7370 6163 6520 7765 2077  extra space we w
-0003ed30: 616e 7420 746f 2068 6176 6520 666f 7220  ant to have for 
-0003ed40: 6f75 7220 7374 6f72 6564 2064 6174 612e  our stored data.
-0003ed50: 0a20 2020 2020 2020 2020 2020 2044 6566  .            Def
-0003ed60: 6175 6c74 7320 746f 2032 2c20 6f72 2074  aults to 2, or t
-0003ed70: 6861 7420 7765 2077 616e 7420 746f 2068  hat we want to h
-0003ed80: 6176 6520 7477 6963 6520 6173 206d 7563  ave twice as muc
-0003ed90: 6820 6d65 6d6f 7279 2061 7320 7765 0a20  h memory as we. 
-0003eda0: 2020 2020 2020 2020 2020 2063 7572 7265             curre
-0003edb0: 6e74 6c79 2068 6176 6520 6461 7461 2e0a  ntly have data..
-0003edc0: 2020 2020 2020 2020 6e20 3a20 696e 740a          n : int.
-0003edd0: 2020 2020 2020 2020 2020 2020 4e75 6d62              Numb
-0003ede0: 6572 206f 6620 776f 726b 6572 7320 746f  er of workers to
-0003edf0: 2063 6c6f 7365 0a20 2020 2020 2020 206d   close.        m
-0003ee00: 696e 696d 756d 203a 2069 6e74 0a20 2020  inimum : int.   
-0003ee10: 2020 2020 2020 2020 204d 696e 696d 756d           Minimum
-0003ee20: 206e 756d 6265 7220 6f66 2077 6f72 6b65   number of worke
-0003ee30: 7273 2074 6f20 6b65 6570 2061 726f 756e  rs to keep aroun
-0003ee40: 640a 2020 2020 2020 2020 6b65 7920 3a20  d.        key : 
-0003ee50: 4361 6c6c 6162 6c65 2857 6f72 6b65 7253  Callable(WorkerS
-0003ee60: 7461 7465 290a 2020 2020 2020 2020 2020  tate).          
-0003ee70: 2020 416e 206f 7074 696f 6e61 6c20 6361    An optional ca
-0003ee80: 6c6c 6162 6c65 206d 6170 7069 6e67 2061  llable mapping a
-0003ee90: 2057 6f72 6b65 7253 7461 7465 206f 626a   WorkerState obj
-0003eea0: 6563 7420 746f 2061 2067 726f 7570 0a20  ect to a group. 
-0003eeb0: 2020 2020 2020 2020 2020 2061 6666 696c             affil
-0003eec0: 6961 7469 6f6e 2e20 4772 6f75 7073 2077  iation. Groups w
-0003eed0: 696c 6c20 6265 2063 6c6f 7365 6420 746f  ill be closed to
-0003eee0: 6765 7468 6572 2e20 5468 6973 2069 7320  gether. This is 
-0003eef0: 7573 6566 756c 2077 6865 6e0a 2020 2020  useful when.    
-0003ef00: 2020 2020 2020 2020 636c 6f73 696e 6720          closing 
-0003ef10: 776f 726b 6572 7320 6d75 7374 2062 6520  workers must be 
-0003ef20: 646f 6e65 2063 6f6c 6c65 6374 6976 656c  done collectivel
-0003ef30: 792c 2073 7563 6820 6173 2062 7920 686f  y, such as by ho
-0003ef40: 7374 6e61 6d65 2e0a 2020 2020 2020 2020  stname..        
-0003ef50: 7461 7267 6574 203a 2069 6e74 0a20 2020  target : int.   
-0003ef60: 2020 2020 2020 2020 2054 6172 6765 7420           Target 
-0003ef70: 6e75 6d62 6572 206f 6620 776f 726b 6572  number of worker
-0003ef80: 7320 746f 2068 6176 6520 6166 7465 7220  s to have after 
-0003ef90: 7765 2063 6c6f 7365 0a20 2020 2020 2020  we close.       
-0003efa0: 2061 7474 7269 6275 7465 203a 2073 7472   attribute : str
-0003efb0: 0a20 2020 2020 2020 2020 2020 2054 6865  .            The
-0003efc0: 2061 7474 7269 6275 7465 206f 6620 7468   attribute of th
-0003efd0: 6520 576f 726b 6572 5374 6174 6520 6f62  e WorkerState ob
-0003efe0: 6a65 6374 2074 6f20 7265 7475 726e 2c20  ject to return, 
-0003eff0: 6c69 6b65 2022 6164 6472 6573 7322 0a20  like "address". 
-0003f000: 2020 2020 2020 2020 2020 206f 7220 226e             or "n
-0003f010: 616d 6522 2e20 2044 6566 6175 6c74 7320  ame".  Defaults 
-0003f020: 746f 2022 6164 6472 6573 7322 2e0a 0a20  to "address"... 
-0003f030: 2020 2020 2020 2045 7861 6d70 6c65 730a         Examples.
-0003f040: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
-0003f050: 0a20 2020 2020 2020 203e 3e3e 2073 6368  .        >>> sch
-0003f060: 6564 756c 6572 2e77 6f72 6b65 7273 5f74  eduler.workers_t
-0003f070: 6f5f 636c 6f73 6528 290a 2020 2020 2020  o_close().      
-0003f080: 2020 5b27 7463 703a 2f2f 3139 322e 3136    ['tcp://192.16
-0003f090: 382e 302e 313a 3132 3334 272c 2027 7463  8.0.1:1234', 'tc
-0003f0a0: 703a 2f2f 3139 322e 3136 382e 302e 323a  p://192.168.0.2:
-0003f0b0: 3132 3334 275d 0a0a 2020 2020 2020 2020  1234']..        
-0003f0c0: 4772 6f75 7020 776f 726b 6572 7320 6279  Group workers by
-0003f0d0: 2068 6f73 746e 616d 6520 7072 696f 7220   hostname prior 
-0003f0e0: 746f 2063 6c6f 7369 6e67 0a0a 2020 2020  to closing..    
-0003f0f0: 2020 2020 3e3e 3e20 7363 6865 6475 6c65      >>> schedule
-0003f100: 722e 776f 726b 6572 735f 746f 5f63 6c6f  r.workers_to_clo
-0003f110: 7365 286b 6579 3d6c 616d 6264 6120 7773  se(key=lambda ws
-0003f120: 3a20 7773 2e68 6f73 7429 0a20 2020 2020  : ws.host).     
-0003f130: 2020 205b 2774 6370 3a2f 2f31 3932 2e31     ['tcp://192.1
-0003f140: 3638 2e30 2e31 3a31 3233 3427 2c20 2774  68.0.1:1234', 't
-0003f150: 6370 3a2f 2f31 3932 2e31 3638 2e30 2e31  cp://192.168.0.1
-0003f160: 3a34 3536 3727 5d0a 0a20 2020 2020 2020  :4567']..       
-0003f170: 2052 656d 6f76 6520 7477 6f20 776f 726b   Remove two work
-0003f180: 6572 730a 0a20 2020 2020 2020 203e 3e3e  ers..        >>>
-0003f190: 2073 6368 6564 756c 6572 2e77 6f72 6b65   scheduler.worke
-0003f1a0: 7273 5f74 6f5f 636c 6f73 6528 6e3d 3229  rs_to_close(n=2)
-0003f1b0: 0a0a 2020 2020 2020 2020 4b65 6570 2065  ..        Keep e
-0003f1c0: 6e6f 7567 6820 776f 726b 6572 7320 746f  nough workers to
-0003f1d0: 2068 6176 6520 7477 6963 6520 6173 206d   have twice as m
-0003f1e0: 7563 6820 6d65 6d6f 7279 2061 7320 7765  uch memory as we
-0003f1f0: 2077 6520 6e65 6564 2e0a 0a20 2020 2020   we need...     
-0003f200: 2020 203e 3e3e 2073 6368 6564 756c 6572     >>> scheduler
-0003f210: 2e77 6f72 6b65 7273 5f74 6f5f 636c 6f73  .workers_to_clos
-0003f220: 6528 6d65 6d6f 7279 5f72 6174 696f 3d32  e(memory_ratio=2
-0003f230: 290a 0a20 2020 2020 2020 2052 6574 7572  )..        Retur
-0003f240: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
-0003f250: 2d2d 0a20 2020 2020 2020 2074 6f5f 636c  --.        to_cl
-0003f260: 6f73 653a 206c 6973 7420 6f66 2077 6f72  ose: list of wor
-0003f270: 6b65 7220 6164 6472 6573 7365 7320 7468  ker addresses th
-0003f280: 6174 2061 7265 204f 4b20 746f 2063 6c6f  at are OK to clo
-0003f290: 7365 0a0a 2020 2020 2020 2020 5365 6520  se..        See 
-0003f2a0: 416c 736f 0a20 2020 2020 2020 202d 2d2d  Also.        ---
-0003f2b0: 2d2d 2d2d 2d0a 2020 2020 2020 2020 5363  -----.        Sc
-0003f2c0: 6865 6475 6c65 722e 7265 7469 7265 5f77  heduler.retire_w
-0003f2d0: 6f72 6b65 7273 0a20 2020 2020 2020 2022  orkers.        "
-0003f2e0: 2222 0a20 2020 2020 2020 2069 6620 7461  "".        if ta
-0003f2f0: 7267 6574 2069 7320 6e6f 7420 4e6f 6e65  rget is not None
-0003f300: 2061 6e64 206e 2069 7320 4e6f 6e65 3a0a   and n is None:.
-0003f310: 2020 2020 2020 2020 2020 2020 6e20 3d20              n = 
-0003f320: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
-0003f330: 2920 2d20 7461 7267 6574 0a20 2020 2020  ) - target.     
-0003f340: 2020 2069 6620 6e20 6973 206e 6f74 204e     if n is not N
-0003f350: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0003f360: 2069 6620 6e20 3c20 303a 0a20 2020 2020   if n < 0:.     
-0003f370: 2020 2020 2020 2020 2020 206e 203d 2030             n = 0
-0003f380: 0a20 2020 2020 2020 2020 2020 2074 6172  .            tar
-0003f390: 6765 7420 3d20 6c65 6e28 7365 6c66 2e77  get = len(self.w
-0003f3a0: 6f72 6b65 7273 2920 2d20 6e0a 0a20 2020  orkers) - n..   
-0003f3b0: 2020 2020 2069 6620 6e20 6973 204e 6f6e       if n is Non
-0003f3c0: 6520 616e 6420 6d65 6d6f 7279 5f72 6174  e and memory_rat
-0003f3d0: 696f 2069 7320 4e6f 6e65 3a0a 2020 2020  io is None:.    
-0003f3e0: 2020 2020 2020 2020 6d65 6d6f 7279 5f72          memory_r
-0003f3f0: 6174 696f 203d 2032 0a0a 2020 2020 2020  atio = 2..      
-0003f400: 2020 6966 206e 6f74 206e 2061 6e64 2061    if not n and a
-0003f410: 6c6c 285b 7773 2e70 726f 6365 7373 696e  ll([ws.processin
-0003f420: 6720 666f 7220 7773 2069 6e20 7365 6c66  g for ws in self
-0003f430: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-0003f440: 295d 293a 0a20 2020 2020 2020 2020 2020  )]):.           
-0003f450: 2072 6574 7572 6e20 5b5d 0a0a 2020 2020   return []..    
-0003f460: 2020 2020 6966 206b 6579 2069 7320 4e6f      if key is No
-0003f470: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-0003f480: 6b65 7920 3d20 6f70 6572 6174 6f72 2e61  key = operator.a
-0003f490: 7474 7267 6574 7465 7228 2261 6464 7265  ttrgetter("addre
-0003f4a0: 7373 2229 0a20 2020 2020 2020 2069 6620  ss").        if 
-0003f4b0: 6973 696e 7374 616e 6365 286b 6579 2c20  isinstance(key, 
-0003f4c0: 6279 7465 7329 3a0a 2020 2020 2020 2020  bytes):.        
-0003f4d0: 2020 2020 6b65 7920 3d20 7069 636b 6c65      key = pickle
-0003f4e0: 2e6c 6f61 6473 286b 6579 290a 0a20 2020  .loads(key)..   
-0003f4f0: 2020 2020 2023 204c 6f6e 6720 7275 6e6e       # Long runn
-0003f500: 696e 6720 7461 736b 7320 7479 7069 6361  ing tasks typica
-0003f510: 6c6c 7920 7573 6520 6120 776f 726b 6572  lly use a worker
-0003f520: 5f63 6c69 656e 7420 746f 2073 6368 6564  _client to sched
-0003f530: 756c 650a 2020 2020 2020 2020 2320 6f74  ule.        # ot
-0003f540: 6865 7220 7461 736b 732e 2057 6520 7368  her tasks. We sh
-0003f550: 6f75 6c64 206e 6576 6572 2073 6875 7420  ould never shut 
-0003f560: 646f 776e 2074 6865 2077 6f72 6b65 7220  down the worker 
-0003f570: 7468 6579 2772 650a 2020 2020 2020 2020  they're.        
-0003f580: 2320 7275 6e6e 696e 6720 6f6e 2c20 6173  # running on, as
-0003f590: 2069 7420 776f 756c 6420 6361 7573 6520   it would cause 
-0003f5a0: 7468 656d 2074 6f20 7265 7374 6172 7420  them to restart 
-0003f5b0: 6672 6f6d 2073 6372 6174 6368 0a20 2020  from scratch.   
-0003f5c0: 2020 2020 2023 2073 6f6d 6577 6865 7265       # somewhere
-0003f5d0: 2065 6c73 652e 0a20 2020 2020 2020 2076   else..        v
-0003f5e0: 616c 6964 5f77 6f72 6b65 7273 203d 205b  alid_workers = [
-0003f5f0: 7773 2066 6f72 2077 7320 696e 2073 656c  ws for ws in sel
-0003f600: 662e 776f 726b 6572 732e 7661 6c75 6573  f.workers.values
-0003f610: 2829 2069 6620 6e6f 7420 7773 2e6c 6f6e  () if not ws.lon
-0003f620: 675f 7275 6e6e 696e 675d 0a20 2020 2020  g_running].     
-0003f630: 2020 2067 726f 7570 7320 3d20 6772 6f75     groups = grou
-0003f640: 7062 7928 6b65 792c 2076 616c 6964 5f77  pby(key, valid_w
-0003f650: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
-0003f660: 206c 696d 6974 5f62 7974 6573 203d 207b   limit_bytes = {
-0003f670: 6b3a 2073 756d 2877 732e 6d65 6d6f 7279  k: sum(ws.memory
-0003f680: 5f6c 696d 6974 2066 6f72 2077 7320 696e  _limit for ws in
-0003f690: 2076 2920 666f 7220 6b2c 2076 2069 6e20   v) for k, v in 
-0003f6a0: 6772 6f75 7073 2e69 7465 6d73 2829 7d0a  groups.items()}.
-0003f6b0: 2020 2020 2020 2020 6772 6f75 705f 6279          group_by
-0003f6c0: 7465 7320 3d20 7b6b 3a20 7375 6d28 7773  tes = {k: sum(ws
-0003f6d0: 2e6e 6279 7465 7320 666f 7220 7773 2069  .nbytes for ws i
-0003f6e0: 6e20 7629 2066 6f72 206b 2c20 7620 696e  n v) for k, v in
-0003f6f0: 2067 726f 7570 732e 6974 656d 7328 297d   groups.items()}
-0003f700: 0a0a 2020 2020 2020 2020 6c69 6d69 7420  ..        limit 
-0003f710: 3d20 7375 6d28 6c69 6d69 745f 6279 7465  = sum(limit_byte
-0003f720: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
-0003f730: 2020 2020 746f 7461 6c20 3d20 7375 6d28      total = sum(
-0003f740: 6772 6f75 705f 6279 7465 732e 7661 6c75  group_bytes.valu
-0003f750: 6573 2829 290a 0a20 2020 2020 2020 2064  es())..        d
-0003f760: 6566 205f 6b65 7928 6772 6f75 7029 3a0a  ef _key(group):.
-0003f770: 2020 2020 2020 2020 2020 2020 6973 5f69              is_i
-0003f780: 646c 6520 3d20 6e6f 7420 616e 7928 5b77  dle = not any([w
-0003f790: 7773 2e70 726f 6365 7373 696e 6720 666f  ws.processing fo
-0003f7a0: 7220 7777 7320 696e 2067 726f 7570 735b  r wws in groups[
-0003f7b0: 6772 6f75 705d 5d29 0a20 2020 2020 2020  group]]).       
-0003f7c0: 2020 2020 2062 7974 6573 203d 202d 6772       bytes = -gr
-0003f7d0: 6f75 705f 6279 7465 735b 6772 6f75 705d  oup_bytes[group]
-0003f7e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0003f7f0: 7572 6e20 6973 5f69 646c 652c 2062 7974  urn is_idle, byt
-0003f800: 6573 0a0a 2020 2020 2020 2020 6964 6c65  es..        idle
-0003f810: 203d 2073 6f72 7465 6428 6772 6f75 7073   = sorted(groups
-0003f820: 2c20 6b65 793d 5f6b 6579 290a 0a20 2020  , key=_key)..   
-0003f830: 2020 2020 2074 6f5f 636c 6f73 6520 3d20       to_close = 
-0003f840: 5b5d 0a20 2020 2020 2020 206e 5f72 656d  [].        n_rem
-0003f850: 6169 6e20 3d20 6c65 6e28 7365 6c66 2e77  ain = len(self.w
-0003f860: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
-0003f870: 2077 6869 6c65 2069 646c 653a 0a20 2020   while idle:.   
-0003f880: 2020 2020 2020 2020 2067 726f 7570 203d           group =
-0003f890: 2069 646c 652e 706f 7028 290a 2020 2020   idle.pop().    
-0003f8a0: 2020 2020 2020 2020 6966 206e 2069 7320          if n is 
-0003f8b0: 4e6f 6e65 2061 6e64 2061 6e79 285b 7773  None and any([ws
-0003f8c0: 2e70 726f 6365 7373 696e 6720 666f 7220  .processing for 
-0003f8d0: 7773 2069 6e20 6772 6f75 7073 5b67 726f  ws in groups[gro
-0003f8e0: 7570 5d5d 293a 0a20 2020 2020 2020 2020  up]]):.         
-0003f8f0: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
-0003f900: 2020 2020 2020 2020 2020 6966 206d 696e            if min
-0003f910: 696d 756d 2061 6e64 206e 5f72 656d 6169  imum and n_remai
-0003f920: 6e20 2d20 6c65 6e28 6772 6f75 7073 5b67  n - len(groups[g
-0003f930: 726f 7570 5d29 203c 206d 696e 696d 756d  roup]) < minimum
-0003f940: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0003f950: 2020 6272 6561 6b0a 0a20 2020 2020 2020    break..       
-0003f960: 2020 2020 206c 696d 6974 202d 3d20 6c69       limit -= li
-0003f970: 6d69 745f 6279 7465 735b 6772 6f75 705d  mit_bytes[group]
-0003f980: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0003f990: 2028 6e20 6973 206e 6f74 204e 6f6e 6520   (n is not None 
-0003f9a0: 616e 6420 6e5f 7265 6d61 696e 202d 206c  and n_remain - l
-0003f9b0: 656e 2867 726f 7570 735b 6772 6f75 705d  en(groups[group]
-0003f9c0: 2920 3e3d 2028 7461 7267 6574 206f 7220  ) >= (target or 
-0003f9d0: 3029 2920 6f72 2028 0a20 2020 2020 2020  0)) or (.       
-0003f9e0: 2020 2020 2020 2020 206d 656d 6f72 795f           memory_
-0003f9f0: 7261 7469 6f20 6973 206e 6f74 204e 6f6e  ratio is not Non
-0003fa00: 6520 616e 6420 6c69 6d69 7420 3e3d 206d  e and limit >= m
-0003fa10: 656d 6f72 795f 7261 7469 6f20 2a20 746f  emory_ratio * to
-0003fa20: 7461 6c0a 2020 2020 2020 2020 2020 2020  tal.            
-0003fa30: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-0003fa40: 2020 2074 6f5f 636c 6f73 652e 6170 7065     to_close.appe
-0003fa50: 6e64 2867 726f 7570 290a 2020 2020 2020  nd(group).      
-0003fa60: 2020 2020 2020 2020 2020 6e5f 7265 6d61            n_rema
-0003fa70: 696e 202d 3d20 6c65 6e28 6772 6f75 7073  in -= len(groups
-0003fa80: 5b67 726f 7570 5d29 0a0a 2020 2020 2020  [group])..      
-0003fa90: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0003faa0: 2020 2020 2020 2020 2020 2020 6272 6561              brea
-0003fab0: 6b0a 0a20 2020 2020 2020 2072 6573 756c  k..        resul
-0003fac0: 7420 3d20 5b67 6574 6174 7472 2877 732c  t = [getattr(ws,
-0003fad0: 2061 7474 7269 6275 7465 2920 666f 7220   attribute) for 
-0003fae0: 6720 696e 2074 6f5f 636c 6f73 6520 666f  g in to_close fo
-0003faf0: 7220 7773 2069 6e20 6772 6f75 7073 5b67  r ws in groups[g
-0003fb00: 5d5d 0a20 2020 2020 2020 2069 6620 7265  ]].        if re
-0003fb10: 7375 6c74 3a0a 2020 2020 2020 2020 2020  sult:.          
-0003fb20: 2020 6c6f 6767 6572 2e64 6562 7567 2822    logger.debug("
-0003fb30: 5375 6767 6573 7420 636c 6f73 696e 6720  Suggest closing 
-0003fb40: 776f 726b 6572 733a 2025 7322 2c20 7265  workers: %s", re
-0003fb50: 7375 6c74 290a 0a20 2020 2020 2020 2072  sult)..        r
-0003fb60: 6574 7572 6e20 7265 7375 6c74 0a0a 2020  eturn result..  
-0003fb70: 2020 406f 7665 726c 6f61 640a 2020 2020    @overload.    
-0003fb80: 6173 796e 6320 6465 6620 7265 7469 7265  async def retire
-0003fb90: 5f77 6f72 6b65 7273 280a 2020 2020 2020  _workers(.      
-0003fba0: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
-0003fbb0: 776f 726b 6572 733a 206c 6973 745b 7374  workers: list[st
-0003fbc0: 725d 2c0a 2020 2020 2020 2020 2a2c 0a20  r],.        *,. 
-0003fbd0: 2020 2020 2020 2063 6c6f 7365 5f77 6f72         close_wor
-0003fbe0: 6b65 7273 3a20 626f 6f6c 203d 2046 616c  kers: bool = Fal
-0003fbf0: 7365 2c0a 2020 2020 2020 2020 7265 6d6f  se,.        remo
-0003fc00: 7665 3a20 626f 6f6c 203d 2054 7275 652c  ve: bool = True,
-0003fc10: 0a20 2020 2020 2020 2073 7469 6d75 6c75  .        stimulu
-0003fc20: 735f 6964 3a20 7374 7220 7c20 4e6f 6e65  s_id: str | None
-0003fc30: 203d 204e 6f6e 652c 0a20 2020 2029 202d   = None,.    ) -
-0003fc40: 3e20 6469 6374 5b73 7472 2c20 416e 795d  > dict[str, Any]
-0003fc50: 3a0a 2020 2020 2020 2020 2e2e 2e0a 0a20  :.        ..... 
-0003fc60: 2020 2040 6f76 6572 6c6f 6164 0a20 2020     @overload.   
-0003fc70: 2061 7379 6e63 2064 6566 2072 6574 6972   async def retir
-0003fc80: 655f 776f 726b 6572 7328 0a20 2020 2020  e_workers(.     
-0003fc90: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-0003fca0: 202a 2c0a 2020 2020 2020 2020 6e61 6d65   *,.        name
-0003fcb0: 733a 206c 6973 742c 0a20 2020 2020 2020  s: list,.       
-0003fcc0: 2063 6c6f 7365 5f77 6f72 6b65 7273 3a20   close_workers: 
-0003fcd0: 626f 6f6c 203d 2046 616c 7365 2c0a 2020  bool = False,.  
-0003fce0: 2020 2020 2020 7265 6d6f 7665 3a20 626f        remove: bo
-0003fcf0: 6f6c 203d 2054 7275 652c 0a20 2020 2020  ol = True,.     
-0003fd00: 2020 2073 7469 6d75 6c75 735f 6964 3a20     stimulus_id: 
-0003fd10: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-0003fd20: 652c 0a20 2020 2029 202d 3e20 6469 6374  e,.    ) -> dict
-0003fd30: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
-0003fd40: 2020 2020 2e2e 2e0a 0a20 2020 2040 6f76      .....    @ov
-0003fd50: 6572 6c6f 6164 0a20 2020 2061 7379 6e63  erload.    async
-0003fd60: 2064 6566 2072 6574 6972 655f 776f 726b   def retire_work
-0003fd70: 6572 7328 0a20 2020 2020 2020 2073 656c  ers(.        sel
-0003fd80: 662c 0a20 2020 2020 2020 202a 2c0a 2020  f,.        *,.  
-0003fd90: 2020 2020 2020 636c 6f73 655f 776f 726b        close_work
-0003fda0: 6572 733a 2062 6f6f 6c20 3d20 4661 6c73  ers: bool = Fals
-0003fdb0: 652c 0a20 2020 2020 2020 2072 656d 6f76  e,.        remov
-0003fdc0: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
-0003fdd0: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-0003fde0: 5f69 643a 2073 7472 207c 204e 6f6e 6520  _id: str | None 
-0003fdf0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-0003fe00: 2320 5061 7261 6d65 7465 7273 2066 6f72  # Parameters for
-0003fe10: 2077 6f72 6b65 7273 5f74 6f5f 636c 6f73   workers_to_clos
-0003fe20: 6528 290a 2020 2020 2020 2020 6d65 6d6f  e().        memo
-0003fe30: 7279 5f72 6174 696f 3a20 696e 7420 7c20  ry_ratio: int | 
-0003fe40: 666c 6f61 7420 7c20 4e6f 6e65 203d 204e  float | None = N
-0003fe50: 6f6e 652c 0a20 2020 2020 2020 206e 3a20  one,.        n: 
-0003fe60: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
-0003fe70: 652c 0a20 2020 2020 2020 206b 6579 3a20  e,.        key: 
-0003fe80: 4361 6c6c 6162 6c65 5b5b 576f 726b 6572  Callable[[Worker
-0003fe90: 5374 6174 655d 2c20 4861 7368 6162 6c65  State], Hashable
-0003fea0: 5d20 7c20 6279 7465 7320 7c20 4e6f 6e65  ] | bytes | None
-0003feb0: 203d 204e 6f6e 652c 0a20 2020 2020 2020   = None,.       
-0003fec0: 206d 696e 696d 756d 3a20 696e 7420 7c20   minimum: int | 
-0003fed0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
-0003fee0: 2020 2020 2074 6172 6765 743a 2069 6e74       target: int
-0003fef0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0003ff00: 2020 2020 2020 2020 6174 7472 6962 7574          attribut
-0003ff10: 653a 2073 7472 203d 2022 6164 6472 6573  e: str = "addres
-0003ff20: 7322 2c0a 2020 2020 2920 2d3e 2064 6963  s",.    ) -> dic
-0003ff30: 745b 7374 722c 2041 6e79 5d3a 0a20 2020  t[str, Any]:.   
-0003ff40: 2020 2020 202e 2e2e 0a0a 2020 2020 406c       .....    @l
-0003ff50: 6f67 5f65 7272 6f72 730a 2020 2020 6173  og_errors.    as
-0003ff60: 796e 6320 6465 6620 7265 7469 7265 5f77  ync def retire_w
-0003ff70: 6f72 6b65 7273 280a 2020 2020 2020 2020  orkers(.        
-0003ff80: 7365 6c66 2c0a 2020 2020 2020 2020 776f  self,.        wo
-0003ff90: 726b 6572 733a 206c 6973 745b 7374 725d  rkers: list[str]
-0003ffa0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-0003ffb0: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
-0003ffc0: 2020 206e 616d 6573 3a20 6c69 7374 207c     names: list |
-0003ffd0: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-0003ffe0: 2020 2020 2020 636c 6f73 655f 776f 726b        close_work
-0003fff0: 6572 733a 2062 6f6f 6c20 3d20 4661 6c73  ers: bool = Fals
-00040000: 652c 0a20 2020 2020 2020 2072 656d 6f76  e,.        remov
-00040010: 653a 2062 6f6f 6c20 3d20 5472 7565 2c0a  e: bool = True,.
-00040020: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-00040030: 5f69 643a 2073 7472 207c 204e 6f6e 6520  _id: str | None 
-00040040: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00040050: 2a2a 6b77 6172 6773 3a20 416e 792c 0a20  **kwargs: Any,. 
-00040060: 2020 2029 202d 3e20 6469 6374 5b73 7472     ) -> dict[str
-00040070: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
-00040080: 2222 2247 7261 6365 6675 6c6c 7920 7265  """Gracefully re
-00040090: 7469 7265 2077 6f72 6b65 7273 2066 726f  tire workers fro
-000400a0: 6d20 636c 7573 7465 722e 2041 6e79 206b  m cluster. Any k
-000400b0: 6579 2074 6861 7420 6973 2069 6e20 6d65  ey that is in me
-000400c0: 6d6f 7279 2065 7863 6c75 7369 7665 6c79  mory exclusively
-000400d0: 0a20 2020 2020 2020 206f 6e20 7468 6520  .        on the 
-000400e0: 7265 7469 7265 6420 776f 726b 6572 7320  retired workers 
-000400f0: 6973 2072 6570 6c69 6361 7465 6420 736f  is replicated so
-00040100: 6d65 7768 6572 6520 656c 7365 2e0a 0a20  mewhere else... 
-00040110: 2020 2020 2020 2050 6172 616d 6574 6572         Parameter
-00040120: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
-00040130: 2d2d 2d2d 0a20 2020 2020 2020 2077 6f72  ----.        wor
-00040140: 6b65 7273 3a20 6c69 7374 5b73 7472 5d20  kers: list[str] 
-00040150: 286f 7074 696f 6e61 6c29 0a20 2020 2020  (optional).     
-00040160: 2020 2020 2020 204c 6973 7420 6f66 2077         List of w
-00040170: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
-00040180: 746f 2072 6574 6972 652e 0a20 2020 2020  to retire..     
-00040190: 2020 206e 616d 6573 3a20 6c69 7374 2028     names: list (
-000401a0: 6f70 7469 6f6e 616c 290a 2020 2020 2020  optional).      
-000401b0: 2020 2020 2020 4c69 7374 206f 6620 776f        List of wo
-000401c0: 726b 6572 206e 616d 6573 2074 6f20 7265  rker names to re
-000401d0: 7469 7265 2e0a 2020 2020 2020 2020 2020  tire..          
-000401e0: 2020 4d75 7475 616c 6c79 2065 7863 6c75    Mutually exclu
-000401f0: 7369 7665 2077 6974 6820 6060 776f 726b  sive with ``work
-00040200: 6572 7360 602e 0a20 2020 2020 2020 2020  ers``..         
-00040210: 2020 2049 6620 6e65 6974 6865 7220 6060     If neither ``
-00040220: 776f 726b 6572 7360 6020 6e6f 7220 6060  workers`` nor ``
-00040230: 6e61 6d65 7360 6020 6172 6520 7072 6f76  names`` are prov
-00040240: 6964 6564 2c20 7765 2063 616c 6c0a 2020  ided, we call.  
-00040250: 2020 2020 2020 2020 2020 6060 776f 726b            ``work
-00040260: 6572 735f 746f 5f63 6c6f 7365 6060 2077  ers_to_close`` w
-00040270: 6869 6368 2066 696e 6473 2061 2067 6f6f  hich finds a goo
-00040280: 6420 7365 742e 0a20 2020 2020 2020 2063  d set..        c
-00040290: 6c6f 7365 5f77 6f72 6b65 7273 3a20 626f  lose_workers: bo
-000402a0: 6f6c 2028 6465 6661 756c 7473 2074 6f20  ol (defaults to 
-000402b0: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
-000402c0: 2020 2057 6865 7468 6572 2074 6f20 6163     Whether to ac
-000402d0: 7475 616c 6c79 2063 6c6f 7365 2074 6865  tually close the
-000402e0: 2077 6f72 6b65 7220 6578 706c 6963 6974   worker explicit
-000402f0: 6c79 2066 726f 6d20 6865 7265 2e0a 2020  ly from here..  
-00040300: 2020 2020 2020 2020 2020 4f74 6865 7277            Otherw
-00040310: 6973 652c 2077 6520 6578 7065 6374 2073  ise, we expect s
-00040320: 6f6d 6520 6578 7465 726e 616c 206a 6f62  ome external job
-00040330: 2073 6368 6564 756c 6572 2074 6f20 6669   scheduler to fi
-00040340: 6e69 7368 206f 6666 2074 6865 2077 6f72  nish off the wor
-00040350: 6b65 722e 0a20 2020 2020 2020 2072 656d  ker..        rem
-00040360: 6f76 653a 2062 6f6f 6c20 2864 6566 6175  ove: bool (defau
-00040370: 6c74 7320 746f 2054 7275 6529 0a20 2020  lts to True).   
-00040380: 2020 2020 2020 2020 2057 6865 7468 6572           Whether
-00040390: 2074 6f20 7265 6d6f 7665 2074 6865 2077   to remove the w
-000403a0: 6f72 6b65 7220 6d65 7461 6461 7461 2069  orker metadata i
-000403b0: 6d6d 6564 6961 7465 6c79 206f 7220 656c  mmediately or el
-000403c0: 7365 2077 6169 7420 666f 7220 7468 650a  se wait for the.
-000403d0: 2020 2020 2020 2020 2020 2020 776f 726b              work
-000403e0: 6572 2074 6f20 636f 6e74 6163 7420 7573  er to contact us
-000403f0: 2e0a 0a20 2020 2020 2020 2020 2020 2049  ...            I
-00040400: 6620 636c 6f73 655f 776f 726b 6572 733d  f close_workers=
-00040410: 4661 6c73 6520 616e 6420 7265 6d6f 7665  False and remove
-00040420: 3d46 616c 7365 2c20 7468 6973 206d 6574  =False, this met
-00040430: 686f 6420 6a75 7374 2066 6c75 7368 6573  hod just flushes
-00040440: 2074 6865 2074 6173 6b73 0a20 2020 2020   the tasks.     
-00040450: 2020 2020 2020 2069 6e20 6d65 6d6f 7279         in memory
-00040460: 206f 7574 206f 6620 7468 6520 776f 726b   out of the work
-00040470: 6572 7320 616e 6420 7468 656e 2072 6574  ers and then ret
-00040480: 7572 6e73 2e0a 2020 2020 2020 2020 2020  urns..          
-00040490: 2020 4966 2063 6c6f 7365 5f77 6f72 6b65    If close_worke
-000404a0: 7273 3d54 7275 6520 616e 6420 7265 6d6f  rs=True and remo
-000404b0: 7665 3d46 616c 7365 2c20 7468 6973 206d  ve=False, this m
-000404c0: 6574 686f 6420 7769 6c6c 2072 6574 7572  ethod will retur
-000404d0: 6e20 7768 696c 6520 7468 650a 2020 2020  n while the.    
-000404e0: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-000404f0: 6172 6520 7374 696c 6c20 696e 2074 6865  are still in the
-00040500: 2063 6c75 7374 6572 2c20 616c 7468 6f75   cluster, althou
-00040510: 6768 2074 6865 7920 776f 6e27 7420 6163  gh they won't ac
-00040520: 6365 7074 206e 6577 2074 6173 6b73 2e0a  cept new tasks..
-00040530: 2020 2020 2020 2020 2020 2020 4966 2063              If c
-00040540: 6c6f 7365 5f77 6f72 6b65 7273 3d46 616c  lose_workers=Fal
-00040550: 7365 206f 7220 666f 7220 7768 6174 6576  se or for whatev
-00040560: 6572 2072 6561 736f 6e20 6120 776f 726b  er reason a work
-00040570: 6572 2064 6f65 736e 2774 2061 6363 6570  er doesn't accep
-00040580: 7420 7468 650a 2020 2020 2020 2020 2020  t the.          
-00040590: 2020 636c 6f73 6520 636f 6d6d 616e 642c    close command,
-000405a0: 2069 7420 7769 6c6c 2062 6520 6c65 6674   it will be left
-000405b0: 2070 6572 6d61 6e65 6e74 6c79 2075 6e61   permanently una
-000405c0: 626c 6520 746f 2061 6363 6570 7420 6e65  ble to accept ne
-000405d0: 7720 7461 736b 7320 616e 640a 2020 2020  w tasks and.    
-000405e0: 2020 2020 2020 2020 6974 2069 7320 6578          it is ex
-000405f0: 7065 6374 6564 2074 6f20 6265 2063 6c6f  pected to be clo
-00040600: 7365 6420 696e 2073 6f6d 6520 6f74 6865  sed in some othe
-00040610: 7220 7761 792e 0a0a 2020 2020 2020 2020  r way...        
-00040620: 2a2a 6b77 6172 6773 3a20 6469 6374 0a20  **kwargs: dict. 
-00040630: 2020 2020 2020 2020 2020 2045 7874 7261             Extra
-00040640: 206f 7074 696f 6e73 2074 6f20 7061 7373   options to pass
-00040650: 2074 6f20 776f 726b 6572 735f 746f 5f63   to workers_to_c
-00040660: 6c6f 7365 2074 6f20 6465 7465 726d 696e  lose to determin
-00040670: 6520 7768 6963 680a 2020 2020 2020 2020  e which.        
-00040680: 2020 2020 776f 726b 6572 7320 7765 2073      workers we s
-00040690: 686f 756c 6420 6472 6f70 2e20 4f6e 6c79  hould drop. Only
-000406a0: 2061 6363 6570 7465 6420 6966 2060 6077   accepted if ``w
-000406b0: 6f72 6b65 7273 6060 2061 6e64 2060 606e  orkers`` and ``n
-000406c0: 616d 6573 6060 2061 7265 0a20 2020 2020  ames`` are.     
-000406d0: 2020 2020 2020 206f 6d69 7474 6564 2e0a         omitted..
-000406e0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-000406f0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
-00040700: 0a20 2020 2020 2020 2044 6963 7469 6f6e  .        Diction
-00040710: 6172 7920 6d61 7070 696e 6720 776f 726b  ary mapping work
-00040720: 6572 2049 442f 6164 6472 6573 7320 746f  er ID/address to
-00040730: 2064 6963 7469 6f6e 6172 7920 6f66 2069   dictionary of i
-00040740: 6e66 6f72 6d61 7469 6f6e 2061 626f 7574  nformation about
-00040750: 0a20 2020 2020 2020 2074 6861 7420 776f  .        that wo
-00040760: 726b 6572 2066 6f72 2065 6163 6820 7265  rker for each re
-00040770: 7469 7265 6420 776f 726b 6572 2e0a 0a20  tired worker... 
-00040780: 2020 2020 2020 2049 6620 7468 6572 6520         If there 
-00040790: 6172 6520 6b65 7973 2074 6861 7420 6578  are keys that ex
-000407a0: 6973 7420 696e 206d 656d 6f72 7920 6f6e  ist in memory on
-000407b0: 6c79 206f 6e20 7468 6520 776f 726b 6572  ly on the worker
-000407c0: 7320 6265 696e 6720 7265 7469 7265 6420  s being retired 
-000407d0: 616e 6420 6974 0a20 2020 2020 2020 2077  and it.        w
-000407e0: 6173 2069 6d70 6f73 7369 626c 6520 746f  as impossible to
-000407f0: 2072 6570 6c69 6361 7465 2074 6865 6d20   replicate them 
-00040800: 736f 6d65 7768 6572 6520 656c 7365 2028  somewhere else (
-00040810: 652e 672e 2062 6563 6175 7365 2074 6865  e.g. because the
-00040820: 7265 2061 7265 6e27 740a 2020 2020 2020  re aren't.      
-00040830: 2020 616e 7920 6f74 6865 7220 7275 6e6e    any other runn
-00040840: 696e 6720 776f 726b 6572 7329 2c20 7468  ing workers), th
-00040850: 6520 776f 726b 6572 7320 686f 6c64 696e  e workers holdin
-00040860: 6720 7375 6368 206b 6579 7320 776f 6e27  g such keys won'
-00040870: 7420 6265 2072 6574 6972 6564 2061 6e64  t be retired and
-00040880: 0a20 2020 2020 2020 2077 6f6e 2774 2061  .        won't a
-00040890: 7070 6561 7220 696e 2074 6865 2072 6574  ppear in the ret
-000408a0: 7572 6e65 6420 6469 6374 2e0a 0a20 2020  urned dict...   
-000408b0: 2020 2020 2053 6565 2041 6c73 6f0a 2020       See Also.  
-000408c0: 2020 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20        --------. 
-000408d0: 2020 2020 2020 2053 6368 6564 756c 6572         Scheduler
-000408e0: 2e77 6f72 6b65 7273 5f74 6f5f 636c 6f73  .workers_to_clos
-000408f0: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
-00040900: 2020 2020 2020 6966 206e 616d 6573 2069        if names i
-00040910: 7320 6e6f 7420 4e6f 6e65 2061 6e64 2077  s not None and w
-00040920: 6f72 6b65 7273 2069 7320 6e6f 7420 4e6f  orkers is not No
-00040930: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-00040940: 7261 6973 6520 5479 7065 4572 726f 7228  raise TypeError(
-00040950: 226e 616d 6573 2061 6e64 2077 6f72 6b65  "names and worke
-00040960: 7273 2061 7265 206d 7574 7561 6c6c 7920  rs are mutually 
-00040970: 6578 636c 7573 6976 6522 290a 2020 2020  exclusive").    
-00040980: 2020 2020 6966 2028 6e61 6d65 7320 6973      if (names is
-00040990: 206e 6f74 204e 6f6e 6520 6f72 2077 6f72   not None or wor
-000409a0: 6b65 7273 2069 7320 6e6f 7420 4e6f 6e65  kers is not None
-000409b0: 2920 616e 6420 6b77 6172 6773 3a0a 2020  ) and kwargs:.  
-000409c0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000409d0: 5479 7065 4572 726f 7228 0a20 2020 2020  TypeError(.     
-000409e0: 2020 2020 2020 2020 2020 2022 5061 7261             "Para
-000409f0: 6d65 7465 7273 2066 6f72 2077 6f72 6b65  meters for worke
-00040a00: 7273 5f74 6f5f 636c 6f73 6528 2920 6172  rs_to_close() ar
-00040a10: 6520 6d75 7475 616c 6c79 2065 7863 6c75  e mutually exclu
-00040a20: 7369 7665 2077 6974 6820 220a 2020 2020  sive with ".    
-00040a30: 2020 2020 2020 2020 2020 2020 6622 6e61              f"na
-00040a40: 6d65 7320 616e 6420 776f 726b 6572 733a  mes and workers:
-00040a50: 207b 6b77 6172 6773 7d22 0a20 2020 2020   {kwargs}".     
-00040a60: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00040a70: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-00040a80: 7374 696d 756c 7573 5f69 6420 6f72 2066  stimulus_id or f
-00040a90: 2272 6574 6972 652d 776f 726b 6572 732d  "retire-workers-
-00040aa0: 7b74 696d 6528 297d 220a 2020 2020 2020  {time()}".      
-00040ab0: 2020 2320 5468 6973 206c 6f63 6b20 6d61    # This lock ma
-00040ac0: 6b65 7320 7265 7469 7265 5f77 6f72 6b65  kes retire_worke
-00040ad0: 7273 2c20 7265 6261 6c61 6e63 652c 2061  rs, rebalance, a
-00040ae0: 6e64 2072 6570 6c69 6361 7465 206d 7574  nd replicate mut
-00040af0: 7561 6c6c 790a 2020 2020 2020 2020 2320  ually.        # 
-00040b00: 6578 636c 7573 6976 6520 616e 6420 7769  exclusive and wi
-00040b10: 6c6c 206e 6f20 6c6f 6e67 6572 2062 6520  ll no longer be 
-00040b20: 6e65 6365 7373 6172 7920 6f6e 6365 2072  necessary once r
-00040b30: 6562 616c 616e 6365 2061 6e64 2072 6570  ebalance and rep
-00040b40: 6c69 6361 7465 2061 7265 0a20 2020 2020  licate are.     
-00040b50: 2020 2023 206d 6967 7261 7465 6420 746f     # migrated to
-00040b60: 2074 6865 2041 6374 6976 6520 4d65 6d6f   the Active Memo
-00040b70: 7279 204d 616e 6167 6572 2e0a 2020 2020  ry Manager..    
-00040b80: 2020 2020 2320 486f 7765 7665 722c 2069      # However, i
-00040b90: 7420 616c 6c6f 7773 206d 756c 7469 706c  t allows multipl
-00040ba0: 6520 696e 7374 616e 6365 7320 6f66 2072  e instances of r
-00040bb0: 6574 6972 655f 776f 726b 6572 7320 746f  etire_workers to
-00040bc0: 2072 756e 2069 6e20 7061 7261 6c6c 656c   run in parallel
-00040bd0: 2e0a 2020 2020 2020 2020 6173 796e 6320  ..        async 
-00040be0: 7769 7468 2073 656c 662e 5f72 6570 6c69  with self._repli
-00040bf0: 6361 5f6c 6f63 6b28 2272 6574 6972 652d  ca_lock("retire-
-00040c00: 776f 726b 6572 7322 293a 0a20 2020 2020  workers"):.     
-00040c10: 2020 2020 2020 2069 6620 6e61 6d65 7320         if names 
-00040c20: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00040c30: 2020 2020 2020 2020 2020 2020 206c 6f67               log
-00040c40: 6765 722e 696e 666f 2822 5265 7469 7265  ger.info("Retire
-00040c50: 2077 6f72 6b65 7220 6e61 6d65 7320 2573   worker names %s
-00040c60: 222c 206e 616d 6573 290a 2020 2020 2020  ", names).      
-00040c70: 2020 2020 2020 2020 2020 2320 5375 7070            # Supp
-00040c80: 6f72 7420 6361 7365 7320 7768 6572 6520  ort cases where 
-00040c90: 6e61 6d65 7320 6172 6520 7061 7373 6564  names are passed
-00040ca0: 2074 6872 6f75 6768 2061 2043 4c49 2061   through a CLI a
-00040cb0: 6e64 2062 6563 6f6d 6520 7374 7269 6e67  nd become string
-00040cc0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
-00040cd0: 2020 6e61 6d65 735f 7365 7420 3d20 7b73    names_set = {s
-00040ce0: 7472 286e 616d 6529 2066 6f72 206e 616d  tr(name) for nam
-00040cf0: 6520 696e 206e 616d 6573 7d0a 2020 2020  e in names}.    
-00040d00: 2020 2020 2020 2020 2020 2020 7773 7320              wss 
-00040d10: 3d20 7b77 7320 666f 7220 7773 2069 6e20  = {ws for ws in 
-00040d20: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-00040d30: 7565 7328 2920 6966 2073 7472 2877 732e  ues() if str(ws.
-00040d40: 6e61 6d65 2920 696e 206e 616d 6573 5f73  name) in names_s
-00040d50: 6574 7d0a 2020 2020 2020 2020 2020 2020  et}.            
-00040d60: 656c 6966 2077 6f72 6b65 7273 2069 7320  elif workers is 
-00040d70: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00040d80: 2020 2020 2020 2020 2020 6c6f 6767 6572            logger
-00040d90: 2e69 6e66 6f28 2252 6574 6972 6520 776f  .info("Retire wo
-00040da0: 726b 6572 2061 6464 7265 7373 6573 2025  rker addresses %
-00040db0: 7322 2c20 776f 726b 6572 7329 0a20 2020  s", workers).   
-00040dc0: 2020 2020 2020 2020 2020 2020 2077 7373               wss
-00040dd0: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00040de0: 2020 2020 2020 2020 2073 656c 662e 776f           self.wo
-00040df0: 726b 6572 735b 6164 6472 6573 735d 0a20  rkers[address]. 
-00040e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00040e10: 2020 2066 6f72 2061 6464 7265 7373 2069     for address i
-00040e20: 6e20 776f 726b 6572 730a 2020 2020 2020  n workers.      
-00040e30: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00040e40: 2061 6464 7265 7373 2069 6e20 7365 6c66   address in self
-00040e50: 2e77 6f72 6b65 7273 0a20 2020 2020 2020  .workers.       
-00040e60: 2020 2020 2020 2020 207d 0a20 2020 2020           }.     
-00040e70: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00040e80: 2020 2020 2020 2020 2020 2020 2077 7373               wss
-00040e90: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
-00040ea0: 2020 2020 2020 2020 2073 656c 662e 776f           self.wo
-00040eb0: 726b 6572 735b 6164 6472 6573 735d 2066  rkers[address] f
-00040ec0: 6f72 2061 6464 7265 7373 2069 6e20 7365  or address in se
-00040ed0: 6c66 2e77 6f72 6b65 7273 5f74 6f5f 636c  lf.workers_to_cl
-00040ee0: 6f73 6528 2a2a 6b77 6172 6773 290a 2020  ose(**kwargs).  
-00040ef0: 2020 2020 2020 2020 2020 2020 2020 7d0a                }.
-00040f00: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00040f10: 6f74 2077 7373 3a0a 2020 2020 2020 2020  ot wss:.        
-00040f20: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-00040f30: 7d0a 0a20 2020 2020 2020 2020 2020 2073  }..            s
-00040f40: 746f 705f 616d 6d20 3d20 4661 6c73 650a  top_amm = False.
-00040f50: 2020 2020 2020 2020 2020 2020 616d 6d3a              amm:
-00040f60: 2041 6374 6976 654d 656d 6f72 794d 616e   ActiveMemoryMan
-00040f70: 6167 6572 4578 7465 6e73 696f 6e20 7c20  agerExtension | 
-00040f80: 4e6f 6e65 203d 2073 656c 662e 6578 7465  None = self.exte
-00040f90: 6e73 696f 6e73 2e67 6574 2822 616d 6d22  nsions.get("amm"
-00040fa0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
-00040fb0: 206e 6f74 2061 6d6d 206f 7220 6e6f 7420   not amm or not 
-00040fc0: 616d 6d2e 7275 6e6e 696e 673a 0a20 2020  amm.running:.   
-00040fd0: 2020 2020 2020 2020 2020 2020 2061 6d6d               amm
-00040fe0: 203d 2041 6374 6976 654d 656d 6f72 794d   = ActiveMemoryM
-00040ff0: 616e 6167 6572 4578 7465 6e73 696f 6e28  anagerExtension(
-00041000: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041010: 2020 2020 2073 656c 662c 2070 6f6c 6963       self, polic
-00041020: 6965 733d 7365 7428 292c 2072 6567 6973  ies=set(), regis
-00041030: 7465 723d 4661 6c73 652c 2073 7461 7274  ter=False, start
-00041040: 3d54 7275 652c 2069 6e74 6572 7661 6c3d  =True, interval=
-00041050: 322e 300a 2020 2020 2020 2020 2020 2020  2.0.            
-00041060: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-00041070: 2020 2020 2020 7374 6f70 5f61 6d6d 203d        stop_amm =
-00041080: 2054 7275 650a 0a20 2020 2020 2020 2020   True..         
-00041090: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-000410a0: 2020 2020 2020 2020 636f 726f 7320 3d20          coros = 
-000410b0: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
-000410c0: 2020 2066 6f72 2077 7320 696e 2077 7373     for ws in wss
-000410d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000410e0: 2020 2020 2020 6c6f 6767 6572 2e69 6e66        logger.inf
-000410f0: 6f28 6622 5265 7469 7269 6e67 2077 6f72  o(f"Retiring wor
-00041100: 6b65 7220 7b77 732e 6164 6472 6573 7321  ker {ws.address!
-00041110: 727d 2028 7b73 7469 6d75 6c75 735f 6964  r} ({stimulus_id
-00041120: 3d21 727d 2922 290a 0a20 2020 2020 2020  =!r})")..       
-00041130: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
-00041140: 6963 7920 3d20 5265 7469 7265 576f 726b  icy = RetireWork
-00041150: 6572 2877 732e 6164 6472 6573 7329 0a20  er(ws.address). 
-00041160: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041170: 2020 2061 6d6d 2e61 6464 5f70 6f6c 6963     amm.add_polic
-00041180: 7928 706f 6c69 6379 290a 0a20 2020 2020  y(policy)..     
-00041190: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-000411a0: 2043 6861 6e67 6520 576f 726b 6572 2e73   Change Worker.s
-000411b0: 7461 7475 7320 746f 2063 6c6f 7369 6e67  tatus to closing
-000411c0: 5f67 7261 6365 6675 6c6c 792e 2049 6d6d  _gracefully. Imm
-000411d0: 6564 6961 7465 6c79 2073 6574 0a20 2020  ediately set.   
-000411e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000411f0: 2023 2074 6865 2073 616d 6520 6f6e 2074   # the same on t
-00041200: 6865 2073 6368 6564 756c 6572 2074 6f20  he scheduler to 
-00041210: 7072 6576 656e 7420 7261 6365 2063 6f6e  prevent race con
-00041220: 6469 7469 6f6e 732e 0a20 2020 2020 2020  ditions..       
-00041230: 2020 2020 2020 2020 2020 2020 2070 7265               pre
-00041240: 765f 7374 6174 7573 203d 2077 732e 7374  v_status = ws.st
-00041250: 6174 7573 0a20 2020 2020 2020 2020 2020  atus.           
-00041260: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
-00041270: 6e64 6c65 5f77 6f72 6b65 725f 7374 6174  ndle_worker_stat
-00041280: 7573 5f63 6861 6e67 6528 0a20 2020 2020  us_change(.     
-00041290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000412a0: 2020 2053 7461 7475 732e 636c 6f73 696e     Status.closin
-000412b0: 675f 6772 6163 6566 756c 6c79 2c20 7773  g_gracefully, ws
-000412c0: 2c20 7374 696d 756c 7573 5f69 640a 2020  , stimulus_id.  
-000412d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000412e0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-000412f0: 2020 2020 2020 2020 2320 4649 584d 453a          # FIXME:
-00041300: 2057 6520 7368 6f75 6c64 2073 656e 6420   We should send 
-00041310: 6120 6d65 7373 6167 6520 746f 2074 6865  a message to the
-00041320: 206e 616e 6e79 2066 6972 7374 3b0a 2020   nanny first;.  
-00041330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041340: 2020 2320 6576 656e 7475 616c 6c79 2077    # eventually w
-00041350: 6f72 6b65 7273 2077 6f6e 2774 2062 6520  orkers won't be 
-00041360: 6162 6c65 2074 6f20 636c 6f73 6520 7468  able to close th
-00041370: 6569 7220 6f77 6e20 6e61 6e6e 6965 732e  eir own nannies.
-00041380: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041390: 2020 2020 2073 656c 662e 7374 7265 616d       self.stream
-000413a0: 5f63 6f6d 6d73 5b77 732e 6164 6472 6573  _comms[ws.addres
-000413b0: 735d 2e73 656e 6428 0a20 2020 2020 2020  s].send(.       
-000413c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000413d0: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-000413e0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-000413f0: 6f70 223a 2022 776f 726b 6572 2d73 7461  op": "worker-sta
-00041400: 7475 732d 6368 616e 6765 222c 0a20 2020  tus-change",.   
-00041410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041420: 2020 2020 2020 2020 2022 7374 6174 7573           "status
-00041430: 223a 2077 732e 7374 6174 7573 2e6e 616d  ": ws.status.nam
-00041440: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-00041450: 2020 2020 2020 2020 2020 2020 2020 2022                 "
-00041460: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
-00041470: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
-00041480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041490: 2020 207d 0a20 2020 2020 2020 2020 2020     }.           
-000414a0: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-000414b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000414c0: 636f 726f 732e 6170 7065 6e64 280a 2020  coros.append(.  
-000414d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000414e0: 2020 2020 2020 7365 6c66 2e5f 7472 6163        self._trac
-000414f0: 6b5f 7265 7469 7265 5f77 6f72 6b65 7228  k_retire_worker(
-00041500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041510: 2020 2020 2020 2020 2020 2020 2077 732c               ws,
-00041520: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041530: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
-00041540: 6963 792c 0a20 2020 2020 2020 2020 2020  icy,.           
-00041550: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041560: 2070 7265 765f 7374 6174 7573 3d70 7265   prev_status=pre
-00041570: 765f 7374 6174 7573 2c0a 2020 2020 2020  v_status,.      
-00041580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041590: 2020 2020 2020 636c 6f73 653d 636c 6f73        close=clos
-000415a0: 655f 776f 726b 6572 732c 0a20 2020 2020  e_workers,.     
-000415b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000415c0: 2020 2020 2020 2072 656d 6f76 653d 7265         remove=re
-000415d0: 6d6f 7665 2c0a 2020 2020 2020 2020 2020  move,.          
-000415e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000415f0: 2020 7374 696d 756c 7573 5f69 643d 7374    stimulus_id=st
-00041600: 696d 756c 7573 5f69 642c 0a20 2020 2020  imulus_id,.     
-00041610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041620: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00041630: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
-00041640: 2020 2020 2020 2020 2020 2020 2320 4769              # Gi
-00041650: 7665 2074 6865 2041 4d4d 2061 206b 6963  ve the AMM a kic
-00041660: 6b2c 2069 6e20 6164 6469 7469 6f6e 2074  k, in addition t
-00041670: 6f20 6974 7320 7065 7269 6f64 6963 2072  o its periodic r
-00041680: 756e 6e69 6e67 2e20 5468 6973 2069 730a  unning. This is.
-00041690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000416a0: 2320 746f 2061 766f 6964 2075 6e6e 6563  # to avoid unnec
-000416b0: 6573 7361 7269 6c79 2077 6169 7469 6e67  essarily waiting
-000416c0: 2066 6f72 2061 2070 6f74 656e 7469 616c   for a potential
-000416d0: 6c79 2061 7262 6974 7261 7269 6c79 206c  ly arbitrarily l
-000416e0: 6f6e 670a 2020 2020 2020 2020 2020 2020  ong.            
-000416f0: 2020 2020 2320 7469 6d65 2028 6465 7065      # time (depe
-00041700: 6e64 696e 6720 6f6e 2069 6e74 6572 7661  nding on interva
-00041710: 6c20 7365 7474 696e 6773 290a 2020 2020  l settings).    
-00041720: 2020 2020 2020 2020 2020 2020 616d 6d2e              amm.
-00041730: 7275 6e5f 6f6e 6365 2829 0a0a 2020 2020  run_once()..    
-00041740: 2020 2020 2020 2020 2020 2020 776f 726b              work
-00041750: 6572 735f 696e 666f 5f6f 6b20 3d20 7b7d  ers_info_ok = {}
-00041760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00041770: 2077 6f72 6b65 7273 5f69 6e66 6f5f 6162   workers_info_ab
-00041780: 6f72 7420 3d20 7b7d 0a20 2020 2020 2020  ort = {}.       
-00041790: 2020 2020 2020 2020 2066 6f72 2061 6464           for add
-000417a0: 722c 2072 6573 756c 742c 2069 6e66 6f20  r, result, info 
-000417b0: 696e 2061 7761 6974 2061 7379 6e63 696f  in await asyncio
-000417c0: 2e67 6174 6865 7228 2a63 6f72 6f73 293a  .gather(*coros):
-000417d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000417e0: 2020 2020 2069 6620 7265 7375 6c74 203d       if result =
-000417f0: 3d20 224f 4b22 3a0a 2020 2020 2020 2020  = "OK":.        
-00041800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041810: 776f 726b 6572 735f 696e 666f 5f6f 6b5b  workers_info_ok[
-00041820: 6164 6472 5d20 3d20 696e 666f 0a20 2020  addr] = info.   
-00041830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00041840: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00041850: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00041860: 6f72 6b65 7273 5f69 6e66 6f5f 6162 6f72  orkers_info_abor
-00041870: 745b 6164 6472 5d20 3d20 696e 666f 0a0a  t[addr] = info..
-00041880: 2020 2020 2020 2020 2020 2020 6669 6e61              fina
-00041890: 6c6c 793a 0a20 2020 2020 2020 2020 2020  lly:.           
-000418a0: 2020 2020 2069 6620 7374 6f70 5f61 6d6d       if stop_amm
-000418b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000418c0: 2020 2020 2020 616d 6d2e 7374 6f70 2829        amm.stop()
-000418d0: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
-000418e0: 6f67 5f65 7665 6e74 280a 2020 2020 2020  og_event(.      
-000418f0: 2020 2020 2020 2261 6c6c 222c 0a20 2020        "all",.   
-00041900: 2020 2020 2020 2020 207b 0a20 2020 2020           {.     
-00041910: 2020 2020 2020 2020 2020 2022 6163 7469             "acti
-00041920: 6f6e 223a 2022 7265 7469 7265 2d77 6f72  on": "retire-wor
-00041930: 6b65 7273 222c 0a20 2020 2020 2020 2020  kers",.         
-00041940: 2020 2020 2020 2022 7265 7469 7265 6422         "retired"
-00041950: 3a20 776f 726b 6572 735f 696e 666f 5f6f  : workers_info_o
-00041960: 6b2c 0a20 2020 2020 2020 2020 2020 2020  k,.             
-00041970: 2020 2022 636f 756c 642d 6e6f 742d 7265     "could-not-re
-00041980: 7469 7265 223a 2077 6f72 6b65 7273 5f69  tire": workers_i
-00041990: 6e66 6f5f 6162 6f72 742c 0a20 2020 2020  nfo_abort,.     
-000419a0: 2020 2020 2020 2020 2020 2022 7374 696d             "stim
-000419b0: 756c 7573 5f69 6422 3a20 7374 696d 756c  ulus_id": stimul
-000419c0: 7573 5f69 642c 0a20 2020 2020 2020 2020  us_id,.         
-000419d0: 2020 207d 2c0a 2020 2020 2020 2020 290a     },.        ).
-000419e0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-000419f0: 5f65 7665 6e74 280a 2020 2020 2020 2020  _event(.        
-00041a00: 2020 2020 6c69 7374 2877 6f72 6b65 7273      list(workers
-00041a10: 5f69 6e66 6f5f 6f6b 292c 0a20 2020 2020  _info_ok),.     
-00041a20: 2020 2020 2020 207b 2261 6374 696f 6e22         {"action"
-00041a30: 3a20 2272 6574 6972 6564 222c 2022 7374  : "retired", "st
-00041a40: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
-00041a50: 756c 7573 5f69 647d 2c0a 2020 2020 2020  ulus_id},.      
-00041a60: 2020 290a 2020 2020 2020 2020 7365 6c66    ).        self
-00041a70: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
-00041a80: 2020 2020 2020 2020 6c69 7374 2877 6f72          list(wor
-00041a90: 6b65 7273 5f69 6e66 6f5f 6162 6f72 7429  kers_info_abort)
-00041aa0: 2c0a 2020 2020 2020 2020 2020 2020 7b22  ,.            {"
-00041ab0: 6163 7469 6f6e 223a 2022 636f 756c 642d  action": "could-
-00041ac0: 6e6f 742d 7265 7469 7265 222c 2022 7374  not-retire", "st
-00041ad0: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
-00041ae0: 756c 7573 5f69 647d 2c0a 2020 2020 2020  ulus_id},.      
-00041af0: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-00041b00: 7572 6e20 776f 726b 6572 735f 696e 666f  urn workers_info
-00041b10: 5f6f 6b0a 0a20 2020 2061 7379 6e63 2064  _ok..    async d
-00041b20: 6566 205f 7472 6163 6b5f 7265 7469 7265  ef _track_retire
-00041b30: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
-00041b40: 2073 656c 662c 0a20 2020 2020 2020 2077   self,.        w
-00041b50: 733a 2057 6f72 6b65 7253 7461 7465 2c0a  s: WorkerState,.
-00041b60: 2020 2020 2020 2020 706f 6c69 6379 3a20          policy: 
-00041b70: 5265 7469 7265 576f 726b 6572 2c0a 2020  RetireWorker,.  
-00041b80: 2020 2020 2020 7072 6576 5f73 7461 7475        prev_statu
-00041b90: 733a 2053 7461 7475 732c 0a20 2020 2020  s: Status,.     
-00041ba0: 2020 2063 6c6f 7365 3a20 626f 6f6c 2c0a     close: bool,.
-00041bb0: 2020 2020 2020 2020 7265 6d6f 7665 3a20          remove: 
-00041bc0: 626f 6f6c 2c0a 2020 2020 2020 2020 7374  bool,.        st
-00041bd0: 696d 756c 7573 5f69 643a 2073 7472 2c0a  imulus_id: str,.
-00041be0: 2020 2020 2920 2d3e 2074 7570 6c65 5b73      ) -> tuple[s
-00041bf0: 7472 2c20 4c69 7465 7261 6c5b 224f 4b22  tr, Literal["OK"
-00041c00: 2c20 226e 6f2d 7265 6369 7069 656e 7473  , "no-recipients
-00041c10: 225d 2c20 6469 6374 5d3a 0a20 2020 2020  "], dict]:.     
-00041c20: 2020 2077 6869 6c65 206e 6f74 2070 6f6c     while not pol
-00041c30: 6963 792e 646f 6e65 2829 3a0a 2020 2020  icy.done():.    
-00041c40: 2020 2020 2020 2020 2320 536c 6565 7020          # Sleep 
-00041c50: 302e 3031 7320 7768 656e 2074 6865 7265  0.01s when there
-00041c60: 2061 7265 2034 2074 6173 6b73 206f 7220   are 4 tasks or 
-00041c70: 6c65 7373 0a20 2020 2020 2020 2020 2020  less.           
-00041c80: 2023 2053 6c65 6570 2030 2e35 7320 7768   # Sleep 0.5s wh
-00041c90: 656e 2074 6865 7265 2061 7265 2032 3030  en there are 200
-00041ca0: 206f 7220 6d6f 7265 0a20 2020 2020 2020   or more.       
-00041cb0: 2020 2020 2070 6f6c 6c5f 696e 7465 7276       poll_interv
-00041cc0: 616c 203d 206d 6178 2830 2e30 312c 206d  al = max(0.01, m
-00041cd0: 696e 2830 2e35 2c20 6c65 6e28 7773 2e68  in(0.5, len(ws.h
-00041ce0: 6173 5f77 6861 7429 202f 2034 3030 2929  as_what) / 400))
-00041cf0: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00041d00: 6974 2061 7379 6e63 696f 2e73 6c65 6570  it asyncio.sleep
-00041d10: 2870 6f6c 6c5f 696e 7465 7276 616c 290a  (poll_interval).
-00041d20: 0a20 2020 2020 2020 2069 6620 706f 6c69  .        if poli
-00041d30: 6379 2e6e 6f5f 7265 6369 7069 656e 7473  cy.no_recipients
-00041d40: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00041d50: 4162 6f72 7420 7265 7469 7265 6d65 6e74  Abort retirement
-00041d60: 2e20 5468 6973 2074 696d 6520 7765 2064  . This time we d
-00041d70: 6f6e 2774 206e 6565 6420 746f 2077 6f72  on't need to wor
-00041d80: 7279 2061 626f 7574 2072 6163 650a 2020  ry about race.  
-00041d90: 2020 2020 2020 2020 2020 2320 636f 6e64            # cond
-00041da0: 6974 696f 6e73 2061 6e64 2077 6520 6361  itions and we ca
-00041db0: 6e20 7761 6974 2066 6f72 2061 2073 6368  n wait for a sch
-00041dc0: 6564 756c 6572 2d3e 776f 726b 6572 2d3e  eduler->worker->
-00041dd0: 7363 6865 6475 6c65 720a 2020 2020 2020  scheduler.      
-00041de0: 2020 2020 2020 2320 726f 756e 642d 7472        # round-tr
-00041df0: 6970 2e0a 2020 2020 2020 2020 2020 2020  ip..            
-00041e00: 7365 6c66 2e73 7472 6561 6d5f 636f 6d6d  self.stream_comm
-00041e10: 735b 7773 2e61 6464 7265 7373 5d2e 7365  s[ws.address].se
-00041e20: 6e64 280a 2020 2020 2020 2020 2020 2020  nd(.            
-00041e30: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-00041e40: 2020 2020 2020 2020 2020 226f 7022 3a20            "op": 
-00041e50: 2277 6f72 6b65 722d 7374 6174 7573 2d63  "worker-status-c
-00041e60: 6861 6e67 6522 2c0a 2020 2020 2020 2020  hange",.        
-00041e70: 2020 2020 2020 2020 2020 2020 2273 7461              "sta
-00041e80: 7475 7322 3a20 7072 6576 5f73 7461 7475  tus": prev_statu
-00041e90: 732e 6e61 6d65 2c0a 2020 2020 2020 2020  s.name,.        
-00041ea0: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
-00041eb0: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
-00041ec0: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
-00041ed0: 2020 2020 2020 2020 7d0a 2020 2020 2020          }.      
-00041ee0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-00041ef0: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
-00041f00: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
-00041f10: 2020 2020 6622 436f 756c 6420 6e6f 7420      f"Could not 
-00041f20: 7265 7469 7265 2077 6f72 6b65 7220 7b77  retire worker {w
-00041f30: 732e 6164 6472 6573 7321 727d 3a20 756e  s.address!r}: un
-00041f40: 6971 7565 2064 6174 6120 636f 756c 6420  ique data could 
-00041f50: 6e6f 7420 6265 2022 0a20 2020 2020 2020  not be ".       
-00041f60: 2020 2020 2020 2020 2066 226d 6f76 6564           f"moved
-00041f70: 2074 6f20 616e 7920 6f74 6865 7220 776f   to any other wo
-00041f80: 726b 6572 2028 7b73 7469 6d75 6c75 735f  rker ({stimulus_
-00041f90: 6964 3d21 727d 2922 0a20 2020 2020 2020  id=!r})".       
-00041fa0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00041fb0: 2020 2072 6574 7572 6e20 7773 2e61 6464     return ws.add
-00041fc0: 7265 7373 2c20 226e 6f2d 7265 6369 7069  ress, "no-recipi
-00041fd0: 656e 7473 222c 2077 732e 6964 656e 7469  ents", ws.identi
-00041fe0: 7479 2829 0a0a 2020 2020 2020 2020 6c6f  ty()..        lo
-00041ff0: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
-00042000: 2020 2020 2020 2020 6622 416c 6c20 756e          f"All un
-00042010: 6971 7565 206b 6579 7320 6f6e 2077 6f72  ique keys on wor
-00042020: 6b65 7220 7b77 732e 6164 6472 6573 7321  ker {ws.address!
-00042030: 727d 2068 6176 6520 6265 656e 2072 6570  r} have been rep
-00042040: 6c69 6361 7465 6420 656c 7365 7768 6572  licated elsewher
-00042050: 6522 0a20 2020 2020 2020 2029 0a0a 2020  e".        )..  
-00042060: 2020 2020 2020 6966 2072 656d 6f76 653a        if remove:
-00042070: 0a20 2020 2020 2020 2020 2020 2061 7761  .            awa
-00042080: 6974 2073 656c 662e 7265 6d6f 7665 5f77  it self.remove_w
-00042090: 6f72 6b65 7228 0a20 2020 2020 2020 2020  orker(.         
-000420a0: 2020 2020 2020 2077 732e 6164 6472 6573         ws.addres
-000420b0: 732c 2073 6166 653d 5472 7565 2c20 636c  s, safe=True, cl
-000420c0: 6f73 653d 636c 6f73 652c 2073 7469 6d75  ose=close, stimu
-000420d0: 6c75 735f 6964 3d73 7469 6d75 6c75 735f  lus_id=stimulus_
-000420e0: 6964 0a20 2020 2020 2020 2020 2020 2029  id.            )
-000420f0: 0a20 2020 2020 2020 2065 6c69 6620 636c  .        elif cl
-00042100: 6f73 653a 0a20 2020 2020 2020 2020 2020  ose:.           
-00042110: 2073 656c 662e 636c 6f73 655f 776f 726b   self.close_work
-00042120: 6572 2877 732e 6164 6472 6573 7329 0a0a  er(ws.address)..
-00042130: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
-00042140: 6e66 6f28 6622 5265 7469 7265 6420 776f  nfo(f"Retired wo
-00042150: 726b 6572 207b 7773 2e61 6464 7265 7373  rker {ws.address
-00042160: 2172 7d20 287b 7374 696d 756c 7573 5f69  !r} ({stimulus_i
-00042170: 643d 2172 7d29 2229 0a20 2020 2020 2020  d=!r})").       
-00042180: 2072 6574 7572 6e20 7773 2e61 6464 7265   return ws.addre
-00042190: 7373 2c20 224f 4b22 2c20 7773 2e69 6465  ss, "OK", ws.ide
-000421a0: 6e74 6974 7928 290a 0a20 2020 2064 6566  ntity()..    def
-000421b0: 2061 6464 5f6b 6579 7328 0a20 2020 2020   add_keys(.     
-000421c0: 2020 2073 656c 662c 2077 6f72 6b65 723a     self, worker:
-000421d0: 2073 7472 2c20 6b65 7973 3a20 436f 6c6c   str, keys: Coll
-000421e0: 6563 7469 6f6e 5b4b 6579 5d20 3d20 2829  ection[Key] = ()
-000421f0: 2c20 7374 696d 756c 7573 5f69 643a 2073  , stimulus_id: s
-00042200: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
-00042210: 0a20 2020 2029 202d 3e20 4c69 7465 7261  .    ) -> Litera
-00042220: 6c5b 224f 4b22 2c20 226e 6f74 2066 6f75  l["OK", "not fou
-00042230: 6e64 225d 3a0a 2020 2020 2020 2020 2222  nd"]:.        ""
-00042240: 220a 2020 2020 2020 2020 4c65 6172 6e20  ".        Learn 
-00042250: 7468 6174 2061 2077 6f72 6b65 7220 6861  that a worker ha
-00042260: 7320 6365 7274 6169 6e20 6b65 7973 0a0a  s certain keys..
-00042270: 2020 2020 2020 2020 5468 6973 2073 686f          This sho
-00042280: 756c 6420 6e6f 7420 6265 2075 7365 6420  uld not be used 
-00042290: 696e 2070 7261 6374 6963 6520 616e 6420  in practice and 
-000422a0: 6973 206d 6f73 746c 7920 6865 7265 2066  is mostly here f
-000422b0: 6f72 206c 6567 6163 790a 2020 2020 2020  or legacy.      
-000422c0: 2020 7265 6173 6f6e 732e 2020 486f 7765    reasons.  Howe
-000422d0: 7665 722c 2069 7420 6973 2073 656e 7420  ver, it is sent 
-000422e0: 6279 2077 6f72 6b65 7273 2066 726f 6d20  by workers from 
-000422f0: 7469 6d65 2074 6f20 7469 6d65 2e0a 2020  time to time..  
-00042300: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00042310: 2020 6966 2077 6f72 6b65 7220 6e6f 7420    if worker not 
-00042320: 696e 2073 656c 662e 776f 726b 6572 733a  in self.workers:
-00042330: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00042340: 7572 6e20 226e 6f74 2066 6f75 6e64 220a  urn "not found".
-00042350: 2020 2020 2020 2020 7773 203d 2073 656c          ws = sel
-00042360: 662e 776f 726b 6572 735b 776f 726b 6572  f.workers[worker
-00042370: 5d0a 2020 2020 2020 2020 7265 6475 6e64  ].        redund
-00042380: 616e 745f 7265 706c 6963 6173 203d 205b  ant_replicas = [
-00042390: 5d0a 2020 2020 2020 2020 666f 7220 6b65  ].        for ke
-000423a0: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
-000423b0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-000423c0: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
-000423d0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-000423e0: 7320 6973 206e 6f74 204e 6f6e 6520 616e  s is not None an
-000423f0: 6420 7473 2e73 7461 7465 203d 3d20 226d  d ts.state == "m
-00042400: 656d 6f72 7922 3a0a 2020 2020 2020 2020  emory":.        
-00042410: 2020 2020 2020 2020 7365 6c66 2e61 6464          self.add
-00042420: 5f72 6570 6c69 6361 2874 732c 2077 7329  _replica(ts, ws)
-00042430: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00042440: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00042450: 2020 2072 6564 756e 6461 6e74 5f72 6570     redundant_rep
-00042460: 6c69 6361 732e 6170 7065 6e64 286b 6579  licas.append(key
-00042470: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
-00042480: 6475 6e64 616e 745f 7265 706c 6963 6173  dundant_replicas
-00042490: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000424a0: 206e 6f74 2073 7469 6d75 6c75 735f 6964   not stimulus_id
-000424b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000424c0: 2020 7374 696d 756c 7573 5f69 6420 3d20    stimulus_id = 
-000424d0: 6622 7265 6475 6e64 616e 742d 7265 706c  f"redundant-repl
-000424e0: 6963 6173 2d7b 7469 6d65 2829 7d22 0a20  icas-{time()}". 
-000424f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00042500: 776f 726b 6572 5f73 656e 6428 0a20 2020  worker_send(.   
-00042510: 2020 2020 2020 2020 2020 2020 2077 6f72               wor
-00042520: 6b65 722c 0a20 2020 2020 2020 2020 2020  ker,.           
-00042530: 2020 2020 207b 0a20 2020 2020 2020 2020       {.         
-00042540: 2020 2020 2020 2020 2020 2022 6f70 223a             "op":
-00042550: 2022 7265 6d6f 7665 2d72 6570 6c69 6361   "remove-replica
-00042560: 7322 2c0a 2020 2020 2020 2020 2020 2020  s",.            
-00042570: 2020 2020 2020 2020 226b 6579 7322 3a20          "keys": 
-00042580: 7265 6475 6e64 616e 745f 7265 706c 6963  redundant_replic
-00042590: 6173 2c0a 2020 2020 2020 2020 2020 2020  as,.            
-000425a0: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
-000425b0: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
-000425c0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-000425d0: 2020 2020 7d2c 0a20 2020 2020 2020 2020      },.         
-000425e0: 2020 2029 0a0a 2020 2020 2020 2020 7265     )..        re
-000425f0: 7475 726e 2022 4f4b 220a 0a20 2020 2040  turn "OK"..    @
-00042600: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
-00042610: 6566 2075 7064 6174 655f 6461 7461 280a  ef update_data(.
-00042620: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00042630: 2020 2020 2020 2a2c 0a20 2020 2020 2020        *,.       
-00042640: 2077 686f 5f68 6173 3a20 6469 6374 5b4b   who_has: dict[K
-00042650: 6579 2c20 6c69 7374 5b73 7472 5d5d 2c0a  ey, list[str]],.
-00042660: 2020 2020 2020 2020 6e62 7974 6573 3a20          nbytes: 
-00042670: 6469 6374 5b4b 6579 2c20 696e 745d 2c0a  dict[Key, int],.
-00042680: 2020 2020 2020 2020 636c 6965 6e74 3a20          client: 
-00042690: 7374 7220 7c20 4e6f 6e65 203d 204e 6f6e  str | None = Non
-000426a0: 652c 0a20 2020 2029 202d 3e20 4e6f 6e65  e,.    ) -> None
-000426b0: 3a0a 2020 2020 2020 2020 2222 224c 6561  :.        """Lea
-000426c0: 726e 2074 6861 7420 6e65 7720 6461 7461  rn that new data
-000426d0: 2068 6173 2065 6e74 6572 6564 2074 6865   has entered the
-000426e0: 206e 6574 776f 726b 2066 726f 6d20 616e   network from an
-000426f0: 2065 7874 6572 6e61 6c20 736f 7572 6365   external source
-00042700: 2222 220a 2020 2020 2020 2020 7768 6f5f  """.        who_
-00042710: 6861 7320 3d20 7b6b 3a20 5b73 656c 662e  has = {k: [self.
-00042720: 636f 6572 6365 5f61 6464 7265 7373 2876  coerce_address(v
-00042730: 7629 2066 6f72 2076 7620 696e 2076 5d20  v) for vv in v] 
-00042740: 666f 7220 6b2c 2076 2069 6e20 7768 6f5f  for k, v in who_
-00042750: 6861 732e 6974 656d 7328 297d 0a20 2020  has.items()}.   
-00042760: 2020 2020 206c 6f67 6765 722e 6465 6275       logger.debu
-00042770: 6728 2255 7064 6174 6520 6461 7461 2025  g("Update data %
-00042780: 7322 2c20 7768 6f5f 6861 7329 0a0a 2020  s", who_has)..  
-00042790: 2020 2020 2020 666f 7220 6b65 792c 2077        for key, w
-000427a0: 6f72 6b65 7273 2069 6e20 7768 6f5f 6861  orkers in who_ha
-000427b0: 732e 6974 656d 7328 293a 0a20 2020 2020  s.items():.     
-000427c0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-000427d0: 2e74 6173 6b73 2e67 6574 286b 6579 290a  .tasks.get(key).
-000427e0: 2020 2020 2020 2020 2020 2020 6966 2074              if t
-000427f0: 7320 6973 204e 6f6e 653a 0a20 2020 2020  s is None:.     
-00042800: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-00042810: 7365 6c66 2e6e 6577 5f74 6173 6b28 6b65  self.new_task(ke
-00042820: 792c 204e 6f6e 652c 2022 6d65 6d6f 7279  y, None, "memory
-00042830: 2229 0a20 2020 2020 2020 2020 2020 2074  ").            t
-00042840: 732e 7374 6174 6520 3d20 226d 656d 6f72  s.state = "memor
-00042850: 7922 0a20 2020 2020 2020 2020 2020 2074  y".            t
-00042860: 735f 6e62 7974 6573 203d 206e 6279 7465  s_nbytes = nbyte
-00042870: 732e 6765 7428 6b65 792c 202d 3129 0a20  s.get(key, -1). 
-00042880: 2020 2020 2020 2020 2020 2069 6620 7473             if ts
-00042890: 5f6e 6279 7465 7320 3e3d 2030 3a0a 2020  _nbytes >= 0:.  
-000428a0: 2020 2020 2020 2020 2020 2020 2020 7473                ts
-000428b0: 2e73 6574 5f6e 6279 7465 7328 7473 5f6e  .set_nbytes(ts_n
-000428c0: 6279 7465 7329 0a0a 2020 2020 2020 2020  bytes)..        
-000428d0: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
-000428e0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-000428f0: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
-00042900: 776f 726b 6572 735b 775d 0a20 2020 2020  workers[w].     
-00042910: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00042920: 6164 645f 7265 706c 6963 6128 7473 2c20  add_replica(ts, 
-00042930: 7773 290a 2020 2020 2020 2020 2020 2020  ws).            
-00042940: 7365 6c66 2e72 6570 6f72 7428 7b22 6f70  self.report({"op
-00042950: 223a 2022 6b65 792d 696e 2d6d 656d 6f72  ": "key-in-memor
-00042960: 7922 2c20 226b 6579 223a 206b 6579 2c20  y", "key": key, 
-00042970: 2277 6f72 6b65 7273 223a 206c 6973 7428  "workers": list(
-00042980: 776f 726b 6572 7329 7d29 0a0a 2020 2020  workers)})..    
-00042990: 2020 2020 6966 2063 6c69 656e 743a 0a20      if client:. 
-000429a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000429b0: 636c 6965 6e74 5f64 6573 6972 6573 5f6b  client_desires_k
-000429c0: 6579 7328 6b65 7973 3d6c 6973 7428 7768  eys(keys=list(wh
-000429d0: 6f5f 6861 7329 2c20 636c 6965 6e74 3d63  o_has), client=c
-000429e0: 6c69 656e 7429 0a0a 2020 2020 406f 7665  lient)..    @ove
-000429f0: 726c 6f61 640a 2020 2020 6465 6620 7265  rload.    def re
-00042a00: 706f 7274 5f6f 6e5f 6b65 7928 7365 6c66  port_on_key(self
-00042a10: 2c20 6b65 793a 204b 6579 2c20 2a2c 2063  , key: Key, *, c
-00042a20: 6c69 656e 743a 2073 7472 207c 204e 6f6e  lient: str | Non
-00042a30: 6520 3d20 4e6f 6e65 2920 2d3e 204e 6f6e  e = None) -> Non
-00042a40: 653a 0a20 2020 2020 2020 202e 2e2e 0a0a  e:.        .....
-00042a50: 2020 2020 406f 7665 726c 6f61 640a 2020      @overload.  
-00042a60: 2020 6465 6620 7265 706f 7274 5f6f 6e5f    def report_on_
-00042a70: 6b65 7928 7365 6c66 2c20 2a2c 2074 733a  key(self, *, ts:
-00042a80: 2054 6173 6b53 7461 7465 2c20 636c 6965   TaskState, clie
-00042a90: 6e74 3a20 7374 7220 7c20 4e6f 6e65 203d  nt: str | None =
-00042aa0: 204e 6f6e 6529 202d 3e20 4e6f 6e65 3a0a   None) -> None:.
-00042ab0: 2020 2020 2020 2020 2e2e 2e0a 0a20 2020          .....   
-00042ac0: 2064 6566 2072 6570 6f72 745f 6f6e 5f6b   def report_on_k
-00042ad0: 6579 2873 656c 662c 206b 6579 3d4e 6f6e  ey(self, key=Non
-00042ae0: 652c 202a 2c20 7473 3d4e 6f6e 652c 2063  e, *, ts=None, c
-00042af0: 6c69 656e 743d 4e6f 6e65 293a 0a20 2020  lient=None):.   
-00042b00: 2020 2020 2069 6620 2874 7320 6973 204e       if (ts is N
-00042b10: 6f6e 6529 203d 3d20 286b 6579 2069 7320  one) == (key is 
-00042b20: 4e6f 6e65 293a 0a20 2020 2020 2020 2020  None):.         
-00042b30: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
-00042b40: 726f 7228 2020 2320 7072 6167 6d61 3a20  ror(  # pragma: 
-00042b50: 6e6f 636f 7665 720a 2020 2020 2020 2020  nocover.        
-00042b60: 2020 2020 2020 2020 6622 7473 2061 6e64          f"ts and
-00042b70: 206b 6579 2061 7265 206d 7574 7561 6c6c   key are mutuall
-00042b80: 7920 6578 636c 7573 6976 653b 2072 6563  y exclusive; rec
-00042b90: 6569 7665 6420 7b6b 6579 3d21 727d 2c20  eived {key=!r}, 
-00042ba0: 7b74 733d 2172 7d22 0a20 2020 2020 2020  {ts=!r}".       
-00042bb0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
-00042bc0: 6620 7473 2069 7320 4e6f 6e65 3a0a 2020  f ts is None:.  
-00042bd0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00042be0: 206b 6579 2069 7320 6e6f 7420 4e6f 6e65   key is not None
-00042bf0: 0a20 2020 2020 2020 2020 2020 2074 7320  .            ts 
-00042c00: 3d20 7365 6c66 2e74 6173 6b73 2e67 6574  = self.tasks.get
-00042c10: 286b 6579 290a 2020 2020 2020 2020 656c  (key).        el
-00042c20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00042c30: 6b65 7920 3d20 7473 2e6b 6579 0a0a 2020  key = ts.key..  
-00042c40: 2020 2020 2020 6966 2074 7320 6973 206e        if ts is n
-00042c50: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-00042c60: 2020 2020 2072 6570 6f72 745f 6d73 6720       report_msg 
-00042c70: 3d20 5f74 6173 6b5f 746f 5f72 6570 6f72  = _task_to_repor
-00042c80: 745f 6d73 6728 7473 290a 2020 2020 2020  t_msg(ts).      
-00042c90: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00042ca0: 2020 2020 7265 706f 7274 5f6d 7367 203d      report_msg =
-00042cb0: 207b 226f 7022 3a20 2263 616e 6365 6c6c   {"op": "cancell
-00042cc0: 6564 2d6b 6579 7322 2c20 226b 6579 7322  ed-keys", "keys"
-00042cd0: 3a20 5b6b 6579 5d7d 0a20 2020 2020 2020  : [key]}.       
-00042ce0: 2069 6620 7265 706f 7274 5f6d 7367 2069   if report_msg i
-00042cf0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
-00042d00: 2020 2020 2020 2020 7365 6c66 2e72 6570          self.rep
-00042d10: 6f72 7428 7265 706f 7274 5f6d 7367 2c20  ort(report_msg, 
-00042d20: 7473 3d74 732c 2063 6c69 656e 743d 636c  ts=ts, client=cl
-00042d30: 6965 6e74 290a 0a20 2020 2040 6c6f 675f  ient)..    @log_
-00042d40: 6572 726f 7273 0a20 2020 2061 7379 6e63  errors.    async
-00042d50: 2064 6566 2066 6565 6428 0a20 2020 2020   def feed(.     
-00042d60: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
-00042d70: 2063 6f6d 6d3a 2043 6f6d 6d2c 0a20 2020   comm: Comm,.   
-00042d80: 2020 2020 2066 756e 6374 696f 6e3a 2062       function: b
-00042d90: 7974 6573 207c 204e 6f6e 6520 3d20 4e6f  ytes | None = No
-00042da0: 6e65 2c0a 2020 2020 2020 2020 7365 7475  ne,.        setu
-00042db0: 703a 2062 7974 6573 207c 204e 6f6e 6520  p: bytes | None 
-00042dc0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-00042dd0: 7465 6172 646f 776e 3a20 6279 7465 7320  teardown: bytes 
-00042de0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
-00042df0: 2020 2020 2020 2069 6e74 6572 7661 6c3a         interval:
-00042e00: 2073 7472 207c 2066 6c6f 6174 203d 2022   str | float = "
-00042e10: 3173 222c 0a20 2020 2020 2020 202a 2a6b  1s",.        **k
-00042e20: 7761 7267 733a 2041 6e79 2c0a 2020 2020  wargs: Any,.    
-00042e30: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-00042e40: 2020 2022 2222 0a20 2020 2020 2020 2050     """.        P
-00042e50: 726f 7669 6465 7320 6120 6461 7461 2043  rovides a data C
-00042e60: 6f6d 6d20 746f 2065 7874 6572 6e61 6c20  omm to external 
-00042e70: 7265 7175 6573 7465 720a 0a20 2020 2020  requester..     
-00042e80: 2020 2043 6175 7469 6f6e 3a20 7468 6973     Caution: this
-00042e90: 2072 756e 7320 6172 6269 7472 6172 7920   runs arbitrary 
-00042ea0: 5079 7468 6f6e 2063 6f64 6520 6f6e 2074  Python code on t
-00042eb0: 6865 2073 6368 6564 756c 6572 2e20 2054  he scheduler.  T
-00042ec0: 6869 7320 7368 6f75 6c64 0a20 2020 2020  his should.     
-00042ed0: 2020 2065 7665 6e74 7561 6c6c 7920 6265     eventually be
-00042ee0: 2070 6861 7365 6420 6f75 742e 2020 4974   phased out.  It
-00042ef0: 2069 7320 6d6f 7374 6c79 2075 7365 6420   is mostly used 
-00042f00: 6279 2064 6961 676e 6f73 7469 6373 2e0a  by diagnostics..
-00042f10: 2020 2020 2020 2020 2222 220a 0a20 2020          """..   
-00042f20: 2020 2020 2069 6e74 6572 7661 6c20 3d20       interval = 
-00042f30: 7061 7273 655f 7469 6d65 6465 6c74 6128  parse_timedelta(
-00042f40: 696e 7465 7276 616c 290a 2020 2020 2020  interval).      
-00042f50: 2020 6966 2066 756e 6374 696f 6e3a 0a20    if function:. 
-00042f60: 2020 2020 2020 2020 2020 2066 756e 6374             funct
-00042f70: 696f 6e20 3d20 7069 636b 6c65 2e6c 6f61  ion = pickle.loa
-00042f80: 6473 2866 756e 6374 696f 6e29 0a20 2020  ds(function).   
-00042f90: 2020 2020 2069 6620 7365 7475 703a 0a20       if setup:. 
-00042fa0: 2020 2020 2020 2020 2020 2073 6574 7570             setup
-00042fb0: 203d 2070 6963 6b6c 652e 6c6f 6164 7328   = pickle.loads(
-00042fc0: 7365 7475 7029 0a0a 2020 2020 2020 2020  setup)..        
-00042fd0: 6966 2074 6561 7264 6f77 6e3a 0a20 2020  if teardown:.   
-00042fe0: 2020 2020 2020 2020 2074 6561 7264 6f77           teardow
-00042ff0: 6e20 3d20 7069 636b 6c65 2e6c 6f61 6473  n = pickle.loads
-00043000: 2874 6561 7264 6f77 6e29 0a20 2020 2020  (teardown).     
-00043010: 2020 2073 7461 7465 203d 2073 6574 7570     state = setup
-00043020: 2873 656c 6629 2069 6620 7365 7475 7020  (self) if setup 
-00043030: 656c 7365 204e 6f6e 6520 2023 2074 7970  else None  # typ
-00043040: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-00043050: 2020 6966 2069 6e73 7065 6374 2e69 7361    if inspect.isa
-00043060: 7761 6974 6162 6c65 2873 7461 7465 293a  waitable(state):
-00043070: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00043080: 7465 203d 2061 7761 6974 2073 7461 7465  te = await state
-00043090: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
-000430a0: 2020 2020 2020 2020 2020 7768 696c 6520            while 
-000430b0: 7365 6c66 2e73 7461 7475 7320 3d3d 2053  self.status == S
-000430c0: 7461 7475 732e 7275 6e6e 696e 673a 0a20  tatus.running:. 
-000430d0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000430e0: 6620 7374 6174 6520 6973 204e 6f6e 653a  f state is None:
-000430f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043100: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
-00043110: 6675 6e63 7469 6f6e 2873 656c 6629 2020  function(self)  
-00043120: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
-00043130: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00043140: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00043150: 2020 2020 2020 2020 2072 6573 706f 6e73           respons
-00043160: 6520 3d20 6675 6e63 7469 6f6e 2873 656c  e = function(sel
-00043170: 662c 2073 7461 7465 2920 2023 2074 7970  f, state)  # typ
-00043180: 653a 2069 676e 6f72 650a 2020 2020 2020  e: ignore.      
-00043190: 2020 2020 2020 2020 2020 6177 6169 7420            await 
-000431a0: 636f 6d6d 2e77 7269 7465 2872 6573 706f  comm.write(respo
-000431b0: 6e73 6529 0a20 2020 2020 2020 2020 2020  nse).           
-000431c0: 2020 2020 2061 7761 6974 2061 7379 6e63       await async
-000431d0: 696f 2e73 6c65 6570 2869 6e74 6572 7661  io.sleep(interva
-000431e0: 6c29 0a20 2020 2020 2020 2065 7863 6570  l).        excep
-000431f0: 7420 4f53 4572 726f 723a 0a20 2020 2020  t OSError:.     
-00043200: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00043210: 2020 2020 6669 6e61 6c6c 793a 0a20 2020      finally:.   
-00043220: 2020 2020 2020 2020 2069 6620 7465 6172           if tear
-00043230: 646f 776e 3a0a 2020 2020 2020 2020 2020  down:.          
-00043240: 2020 2020 2020 7465 6172 646f 776e 2873        teardown(s
-00043250: 656c 662c 2073 7461 7465 2920 2023 2074  elf, state)  # t
-00043260: 7970 653a 2069 676e 6f72 650a 0a20 2020  ype: ignore..   
-00043270: 2064 6566 206c 6f67 5f77 6f72 6b65 725f   def log_worker_
-00043280: 6576 656e 7428 0a20 2020 2020 2020 2073  event(.        s
-00043290: 656c 662c 2077 6f72 6b65 723a 2073 7472  elf, worker: str
-000432a0: 2c20 746f 7069 633a 2073 7472 207c 2043  , topic: str | C
-000432b0: 6f6c 6c65 6374 696f 6e5b 7374 725d 2c20  ollection[str], 
-000432c0: 6d73 673a 2041 6e79 0a20 2020 2029 202d  msg: Any.    ) -
-000432d0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-000432e0: 6966 2069 7369 6e73 7461 6e63 6528 6d73  if isinstance(ms
-000432f0: 672c 2064 6963 7429 2061 6e64 2077 6f72  g, dict) and wor
-00043300: 6b65 7220 213d 2074 6f70 6963 3a0a 2020  ker != topic:.  
-00043310: 2020 2020 2020 2020 2020 6d73 675b 2277            msg["w
-00043320: 6f72 6b65 7222 5d20 3d20 776f 726b 6572  orker"] = worker
-00043330: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-00043340: 675f 6576 656e 7428 746f 7069 632c 206d  g_event(topic, m
-00043350: 7367 290a 0a20 2020 2064 6566 2073 7562  sg)..    def sub
-00043360: 7363 7269 6265 5f77 6f72 6b65 725f 7374  scribe_worker_st
-00043370: 6174 7573 2873 656c 662c 2063 6f6d 6d3a  atus(self, comm:
-00043380: 2043 6f6d 6d29 202d 3e20 6469 6374 5b73   Comm) -> dict[s
-00043390: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
-000433a0: 2020 576f 726b 6572 5374 6174 7573 506c    WorkerStatusPl
-000433b0: 7567 696e 2873 656c 662c 2063 6f6d 6d29  ugin(self, comm)
-000433c0: 0a20 2020 2020 2020 2069 6465 6e74 203d  .        ident =
-000433d0: 2073 656c 662e 6964 656e 7469 7479 2829   self.identity()
-000433e0: 0a20 2020 2020 2020 2066 6f72 2076 2069  .        for v i
-000433f0: 6e20 6964 656e 745b 2277 6f72 6b65 7273  n ident["workers
-00043400: 225d 2e76 616c 7565 7328 293a 0a20 2020  "].values():.   
-00043410: 2020 2020 2020 2020 2064 656c 2076 5b22           del v["
-00043420: 6d65 7472 6963 7322 5d0a 2020 2020 2020  metrics"].      
-00043430: 2020 2020 2020 6465 6c20 765b 226c 6173        del v["las
-00043440: 745f 7365 656e 225d 0a20 2020 2020 2020  t_seen"].       
-00043450: 2072 6574 7572 6e20 6964 656e 740a 0a20   return ident.. 
-00043460: 2020 2064 6566 2067 6574 5f70 726f 6365     def get_proce
-00043470: 7373 696e 6728 0a20 2020 2020 2020 2073  ssing(.        s
-00043480: 656c 662c 2077 6f72 6b65 7273 3a20 4974  elf, workers: It
-00043490: 6572 6162 6c65 5b73 7472 5d20 7c20 4e6f  erable[str] | No
-000434a0: 6e65 203d 204e 6f6e 650a 2020 2020 2920  ne = None.    ) 
-000434b0: 2d3e 2064 6963 745b 7374 722c 206c 6973  -> dict[str, lis
-000434c0: 745b 4b65 795d 5d3a 0a20 2020 2020 2020  t[Key]]:.       
-000434d0: 2069 6620 776f 726b 6572 7320 6973 206e   if workers is n
-000434e0: 6f74 204e 6f6e 653a 0a20 2020 2020 2020  ot None:.       
-000434f0: 2020 2020 2077 6f72 6b65 7273 203d 2073       workers = s
-00043500: 6574 286d 6170 2873 656c 662e 636f 6572  et(map(self.coer
-00043510: 6365 5f61 6464 7265 7373 2c20 776f 726b  ce_address, work
-00043520: 6572 7329 290a 2020 2020 2020 2020 2020  ers)).          
-00043530: 2020 7265 7475 726e 207b 773a 205b 7473    return {w: [ts
-00043540: 2e6b 6579 2066 6f72 2074 7320 696e 2073  .key for ts in s
-00043550: 656c 662e 776f 726b 6572 735b 775d 2e70  elf.workers[w].p
-00043560: 726f 6365 7373 696e 675d 2066 6f72 2077  rocessing] for w
-00043570: 2069 6e20 776f 726b 6572 737d 0a20 2020   in workers}.   
-00043580: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00043590: 2020 2020 2020 2072 6574 7572 6e20 7b0a         return {.
-000435a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000435b0: 773a 205b 7473 2e6b 6579 2066 6f72 2074  w: [ts.key for t
-000435c0: 7320 696e 2077 732e 7072 6f63 6573 7369  s in ws.processi
-000435d0: 6e67 5d20 666f 7220 772c 2077 7320 696e  ng] for w, ws in
-000435e0: 2073 656c 662e 776f 726b 6572 732e 6974   self.workers.it
-000435f0: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
-00043600: 2020 7d0a 0a20 2020 2064 6566 2067 6574    }..    def get
-00043610: 5f77 686f 5f68 6173 2873 656c 662c 206b  _who_has(self, k
-00043620: 6579 733a 2049 7465 7261 626c 655b 4b65  eys: Iterable[Ke
-00043630: 795d 207c 204e 6f6e 6520 3d20 4e6f 6e65  y] | None = None
-00043640: 2920 2d3e 2064 6963 745b 4b65 792c 206c  ) -> dict[Key, l
-00043650: 6973 745b 7374 725d 5d3a 0a20 2020 2020  ist[str]]:.     
-00043660: 2020 2069 6620 6b65 7973 2069 7320 6e6f     if keys is no
-00043670: 7420 4e6f 6e65 3a0a 2020 2020 2020 2020  t None:.        
-00043680: 2020 2020 7265 7475 726e 207b 0a20 2020      return {.   
-00043690: 2020 2020 2020 2020 2020 2020 206b 6579               key
-000436a0: 3a20 5b77 732e 6164 6472 6573 7320 666f  : [ws.address fo
-000436b0: 7220 7773 2069 6e20 7365 6c66 2e74 6173  r ws in self.tas
-000436c0: 6b73 5b6b 6579 5d2e 7768 6f5f 6861 7320  ks[key].who_has 
-000436d0: 6f72 2028 295d 0a20 2020 2020 2020 2020  or ()].         
-000436e0: 2020 2020 2020 2069 6620 6b65 7920 696e         if key in
-000436f0: 2073 656c 662e 7461 736b 730a 2020 2020   self.tasks.    
-00043700: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00043710: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00043720: 2020 2020 666f 7220 6b65 7920 696e 206b      for key in k
-00043730: 6579 730a 2020 2020 2020 2020 2020 2020  eys.            
-00043740: 7d0a 2020 2020 2020 2020 656c 7365 3a0a  }.        else:.
-00043750: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00043760: 726e 207b 0a20 2020 2020 2020 2020 2020  rn {.           
-00043770: 2020 2020 206b 6579 3a20 5b77 732e 6164       key: [ws.ad
-00043780: 6472 6573 7320 666f 7220 7773 2069 6e20  dress for ws in 
-00043790: 7473 2e77 686f 5f68 6173 206f 7220 2829  ts.who_has or ()
-000437a0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000437b0: 2020 666f 7220 6b65 792c 2074 7320 696e    for key, ts in
-000437c0: 2073 656c 662e 7461 736b 732e 6974 656d   self.tasks.item
-000437d0: 7328 290a 2020 2020 2020 2020 2020 2020  s().            
-000437e0: 7d0a 0a20 2020 2064 6566 2067 6574 5f68  }..    def get_h
-000437f0: 6173 5f77 6861 7428 0a20 2020 2020 2020  as_what(.       
-00043800: 2073 656c 662c 2077 6f72 6b65 7273 3a20   self, workers: 
-00043810: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
-00043820: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
-00043830: 2920 2d3e 2064 6963 745b 7374 722c 206c  ) -> dict[str, l
-00043840: 6973 745b 4b65 795d 5d3a 0a20 2020 2020  ist[Key]]:.     
-00043850: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
+0003d470: 666f 7220 7265 6369 7069 656e 7420 696e  for recipient in
+0003d480: 2073 6b69 7070 6564 5f72 6563 6970 6965   skipped_recipie
+0003d490: 6e74 733a 0a20 2020 2020 2020 2020 2020  nts:.           
+0003d4a0: 2020 2020 2020 2020 2068 6561 7071 2e68           heapq.h
+0003d4b0: 6561 7070 7573 6828 7265 6369 7069 656e  eappush(recipien
+0003d4c0: 7473 2c20 7265 6369 7069 656e 7429 0a0a  ts, recipient)..
+0003d4d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d4e0: 6966 206e 6f74 2075 7365 5f72 6563 6970  if not use_recip
+0003d4f0: 6965 6e74 3a0a 2020 2020 2020 2020 2020  ient:.          
+0003d500: 2020 2020 2020 2020 2020 2320 5468 6973            # This
+0003d510: 2074 6173 6b20 6861 7320 6e6f 2072 6563   task has no rec
+0003d520: 6970 6965 6e74 7320 6176 6169 6c61 626c  ipients availabl
+0003d530: 652e 204c 6561 7665 2069 7420 6f6e 2074  e. Leave it on t
+0003d540: 6865 2073 656e 6465 7220 616e 640a 2020  he sender and.  
+0003d550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d560: 2020 2320 6d6f 7665 206f 6e20 746f 2074    # move on to t
+0003d570: 6865 206e 6578 7420 7461 736b 206f 6620  he next task of 
+0003d580: 7468 6520 7361 6d65 2073 656e 6465 722e  the same sender.
+0003d590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d5a0: 2020 2020 2063 6f6e 7469 6e75 650a 0a20       continue.. 
+0003d5b0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003d5c0: 2053 6368 6564 756c 6520 7461 736b 2066   Schedule task f
+0003d5d0: 6f72 2074 7261 6e73 6665 7220 6672 6f6d  or transfer from
+0003d5e0: 2073 656e 6465 7220 746f 2072 6563 6970   sender to recip
+0003d5f0: 6965 6e74 0a20 2020 2020 2020 2020 2020  ient.           
+0003d600: 2020 2020 206d 7367 732e 6170 7065 6e64       msgs.append
+0003d610: 2828 736e 645f 7773 2c20 7265 635f 7773  ((snd_ws, rec_ws
+0003d620: 2c20 7473 2929 0a0a 2020 2020 2020 2020  , ts))..        
+0003d630: 2020 2020 2020 2020 2320 2a5f 6279 7465          # *_byte
+0003d640: 735f 6d61 782f 6d69 6e20 6172 6520 616c  s_max/min are al
+0003d650: 6c20 6e65 6761 7469 7665 2066 6f72 2068  l negative for h
+0003d660: 6561 7020 736f 7274 696e 670a 2020 2020  eap sorting.    
+0003d670: 2020 2020 2020 2020 2020 2020 736e 645f              snd_
+0003d680: 6279 7465 735f 6d61 7820 2b3d 206e 6279  bytes_max += nby
+0003d690: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+0003d6a0: 2020 2020 736e 645f 6279 7465 735f 6d69      snd_bytes_mi
+0003d6b0: 6e20 2b3d 206e 6279 7465 730a 2020 2020  n += nbytes.    
+0003d6c0: 2020 2020 2020 2020 2020 2020 7265 635f              rec_
+0003d6d0: 6279 7465 735f 6d61 7820 2b3d 206e 6279  bytes_max += nby
+0003d6e0: 7465 730a 2020 2020 2020 2020 2020 2020  tes.            
+0003d6f0: 2020 2020 7265 635f 6279 7465 735f 6d69      rec_bytes_mi
+0003d700: 6e20 2b3d 206e 6279 7465 730a 0a20 2020  n += nbytes..   
+0003d710: 2020 2020 2020 2020 2020 2020 2023 2053               # S
+0003d720: 746f 7020 6974 6572 6174 696e 6720 6f6e  top iterating on
+0003d730: 2074 6865 2074 6173 6b73 206f 6620 7468   the tasks of th
+0003d740: 6973 2073 656e 6465 7220 666f 7220 6e6f  is sender for no
+0003d750: 7720 616e 642c 2069 6620 6974 2073 7469  w and, if it sti
+0003d760: 6c6c 0a20 2020 2020 2020 2020 2020 2020  ll.             
+0003d770: 2020 2023 2068 6173 2062 7974 6573 2074     # has bytes t
+0003d780: 6f20 6c6f 7365 2c20 7075 7368 2069 7420  o lose, push it 
+0003d790: 6261 636b 2069 6e74 6f20 7468 6520 7365  back into the se
+0003d7a0: 6e64 6572 7320 6865 6170 3b20 6974 206d  nders heap; it m
+0003d7b0: 6179 206f 7220 6d61 790a 2020 2020 2020  ay or may.      
+0003d7c0: 2020 2020 2020 2020 2020 2320 6e6f 7420            # not 
+0003d7d0: 636f 6d65 2062 6163 6b20 6f6e 2074 6f70  come back on top
+0003d7e0: 2061 6761 696e 2e0a 2020 2020 2020 2020   again..        
+0003d7f0: 2020 2020 2020 2020 6966 2073 6e64 5f62          if snd_b
+0003d800: 7974 6573 5f6d 696e 203c 2030 3a0a 2020  ytes_min < 0:.  
+0003d810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d820: 2020 2320 5365 6520 6465 6669 6e69 7469    # See definiti
+0003d830: 6f6e 206f 6620 7365 6e64 6572 7320 6162  on of senders ab
+0003d840: 6f76 650a 2020 2020 2020 2020 2020 2020  ove.            
+0003d850: 2020 2020 2020 2020 6865 6170 712e 6865          heapq.he
+0003d860: 6170 7265 706c 6163 6528 0a20 2020 2020  apreplace(.     
+0003d870: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d880: 2020 2073 656e 6465 7273 2c0a 2020 2020     senders,.    
+0003d890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d8a0: 2020 2020 2873 6e64 5f62 7974 6573 5f6d      (snd_bytes_m
+0003d8b0: 6178 2c20 736e 645f 6279 7465 735f 6d69  ax, snd_bytes_mi
+0003d8c0: 6e2c 2069 6428 736e 645f 7773 292c 2073  n, id(snd_ws), s
+0003d8d0: 6e64 5f77 732c 2074 735f 6974 6572 292c  nd_ws, ts_iter),
+0003d8e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003d8f0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0003d900: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0003d910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003d920: 2068 6561 7071 2e68 6561 7070 6f70 2873   heapq.heappop(s
+0003d930: 656e 6465 7273 290a 0a20 2020 2020 2020  enders)..       
+0003d940: 2020 2020 2020 2020 2023 2049 6620 7265           # If re
+0003d950: 6369 7069 656e 7420 7374 696c 6c20 6861  cipient still ha
+0003d960: 7320 6279 7465 7320 746f 2067 6169 6e2c  s bytes to gain,
+0003d970: 2070 7573 6820 6974 2062 6163 6b20 696e   push it back in
+0003d980: 746f 2074 6865 2072 6563 6970 6965 6e74  to the recipient
+0003d990: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+0003d9a0: 2020 2320 6865 6170 3b20 6974 206d 6179    # heap; it may
+0003d9b0: 206f 7220 6d61 7920 6e6f 7420 636f 6d65   or may not come
+0003d9c0: 2062 6163 6b20 6f6e 2074 6f70 2061 6761   back on top aga
+0003d9d0: 696e 2e0a 2020 2020 2020 2020 2020 2020  in..            
+0003d9e0: 2020 2020 6966 2072 6563 5f62 7974 6573      if rec_bytes
+0003d9f0: 5f6d 696e 203c 2030 3a0a 2020 2020 2020  _min < 0:.      
+0003da00: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003da10: 5365 6520 6465 6669 6e69 7469 6f6e 206f  See definition o
+0003da20: 6620 7265 6369 7069 656e 7473 2061 626f  f recipients abo
+0003da30: 7665 0a20 2020 2020 2020 2020 2020 2020  ve.             
+0003da40: 2020 2020 2020 2068 6561 7071 2e68 6561         heapq.hea
+0003da50: 7072 6570 6c61 6365 280a 2020 2020 2020  preplace(.      
+0003da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003da70: 2020 7265 6369 7069 656e 7473 2c0a 2020    recipients,.  
+0003da80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003da90: 2020 2020 2020 2872 6563 5f62 7974 6573        (rec_bytes
+0003daa0: 5f6d 6178 2c20 7265 635f 6279 7465 735f  _max, rec_bytes_
+0003dab0: 6d69 6e2c 2069 6428 7265 635f 7773 292c  min, id(rec_ws),
+0003dac0: 2072 6563 5f77 7329 2c0a 2020 2020 2020   rec_ws),.      
+0003dad0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003daf0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003db00: 2020 2020 2020 2020 2020 6865 6170 712e            heapq.
+0003db10: 6865 6170 706f 7028 7265 6369 7069 656e  heappop(recipien
+0003db20: 7473 290a 0a20 2020 2020 2020 2020 2020  ts)..           
+0003db30: 2020 2020 2023 204d 6f76 6520 746f 206e       # Move to n
+0003db40: 6578 7420 7365 6e64 6572 2077 6974 6820  ext sender with 
+0003db50: 7468 6520 6d6f 7374 2064 6174 6120 746f  the most data to
+0003db60: 206c 6f73 652e 0a20 2020 2020 2020 2020   lose..         
+0003db70: 2020 2020 2020 2023 2049 7420 6d61 7920         # It may 
+0003db80: 6f72 206d 6179 206e 6f74 2062 6520 7468  or may not be th
+0003db90: 6520 7361 6d65 2073 656e 6465 7220 6167  e same sender ag
+0003dba0: 6169 6e2e 0a20 2020 2020 2020 2020 2020  ain..           
+0003dbb0: 2020 2020 2062 7265 616b 0a0a 2020 2020       break..    
+0003dbc0: 2020 2020 2020 2020 656c 7365 3a20 2023          else:  #
+0003dbd0: 2066 6f72 2074 7320 696e 2074 735f 6974   for ts in ts_it
+0003dbe0: 6572 0a20 2020 2020 2020 2020 2020 2020  er.             
+0003dbf0: 2020 2023 2045 7868 6175 7374 6564 2074     # Exhausted t
+0003dc00: 6173 6b73 206f 6e20 7468 6973 2073 656e  asks on this sen
+0003dc10: 6465 720a 2020 2020 2020 2020 2020 2020  der.            
+0003dc20: 2020 2020 6865 6170 712e 6865 6170 706f      heapq.heappo
+0003dc30: 7028 7365 6e64 6572 7329 0a0a 2020 2020  p(senders)..    
+0003dc40: 2020 2020 7265 7475 726e 206d 7367 730a      return msgs.
+0003dc50: 0a20 2020 2061 7379 6e63 2064 6566 205f  .    async def _
+0003dc60: 7265 6261 6c61 6e63 655f 6d6f 7665 5f64  rebalance_move_d
+0003dc70: 6174 6128 0a20 2020 2020 2020 2073 656c  ata(.        sel
+0003dc80: 662c 206d 7367 733a 206c 6973 745b 7475  f, msgs: list[tu
+0003dc90: 706c 655b 576f 726b 6572 5374 6174 652c  ple[WorkerState,
+0003dca0: 2057 6f72 6b65 7253 7461 7465 2c20 5461   WorkerState, Ta
+0003dcb0: 736b 5374 6174 655d 5d2c 2073 7469 6d75  skState]], stimu
+0003dcc0: 6c75 735f 6964 3a20 7374 720a 2020 2020  lus_id: str.    
+0003dcd0: 2920 2d3e 2064 6963 743a 0a20 2020 2020  ) -> dict:.     
+0003dce0: 2020 2022 2222 5065 7266 6f72 6d20 7468     """Perform th
+0003dcf0: 6520 6163 7475 616c 2074 7261 6e73 6665  e actual transfe
+0003dd00: 7220 6f66 2064 6174 6120 6163 726f 7373  r of data across
+0003dd10: 2074 6865 206e 6574 776f 726b 2069 6e20   the network in 
+0003dd20: 7265 6261 6c61 6e63 6528 292e 0a20 2020  rebalance()..   
+0003dd30: 2020 2020 2054 616b 6573 2069 6e20 696e       Takes in in
+0003dd40: 7075 7420 7468 6520 6f75 7470 7574 206f  put the output o
+0003dd50: 6620 5f72 6562 616c 616e 6365 5f66 696e  f _rebalance_fin
+0003dd60: 645f 6d73 6773 2829 2c20 7468 6174 2069  d_msgs(), that i
+0003dd70: 7320 6120 6c69 7374 206f 6620 7475 706c  s a list of tupl
+0003dd80: 6573 3a0a 0a20 2020 2020 2020 202d 2073  es:..        - s
+0003dd90: 656e 6465 7220 776f 726b 6572 0a20 2020  ender worker.   
+0003dda0: 2020 2020 202d 2072 6563 6970 6965 6e74       - recipient
+0003ddb0: 2077 6f72 6b65 720a 2020 2020 2020 2020   worker.        
+0003ddc0: 2d20 7461 736b 2074 6f20 6265 2074 7261  - task to be tra
+0003ddd0: 6e73 6665 7272 6564 0a0a 2020 2020 2020  nsferred..      
+0003dde0: 2020 4649 584d 4520 7468 6973 206d 6574    FIXME this met
+0003ddf0: 686f 6420 6973 206e 6f74 2072 6f62 7573  hod is not robus
+0003de00: 7420 7768 656e 2074 6865 2063 6c75 7374  t when the clust
+0003de10: 6572 2069 7320 6e6f 7420 6964 6c65 2e0a  er is not idle..
+0003de20: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0003de30: 2020 2020 2320 7b72 6563 6970 6965 6e74      # {recipient
+0003de40: 2061 6464 7265 7373 3a20 7b6b 6579 3a20   address: {key: 
+0003de50: 5b73 656e 6465 7220 6164 6472 6573 732c  [sender address,
+0003de60: 202e 2e2e 5d7d 7d0a 2020 2020 2020 2020   ...]}}.        
+0003de70: 746f 5f72 6563 6970 6965 6e74 733a 2064  to_recipients: d
+0003de80: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
+0003de90: 6465 6661 756c 7464 6963 745b 4b65 792c  defaultdict[Key,
+0003dea0: 206c 6973 745b 7374 725d 5d5d 203d 2064   list[str]]] = d
+0003deb0: 6566 6175 6c74 6469 6374 280a 2020 2020  efaultdict(.    
+0003dec0: 2020 2020 2020 2020 6c61 6d62 6461 3a20          lambda: 
+0003ded0: 6465 6661 756c 7464 6963 7428 6c69 7374  defaultdict(list
+0003dee0: 290a 2020 2020 2020 2020 290a 2020 2020  ).        ).    
+0003def0: 2020 2020 666f 7220 736e 645f 7773 2c20      for snd_ws, 
+0003df00: 7265 635f 7773 2c20 7473 2069 6e20 6d73  rec_ws, ts in ms
+0003df10: 6773 3a0a 2020 2020 2020 2020 2020 2020  gs:.            
+0003df20: 746f 5f72 6563 6970 6965 6e74 735b 7265  to_recipients[re
+0003df30: 635f 7773 2e61 6464 7265 7373 5d5b 7473  c_ws.address][ts
+0003df40: 2e6b 6579 5d2e 6170 7065 6e64 2873 6e64  .key].append(snd
+0003df50: 5f77 732e 6164 6472 6573 7329 0a20 2020  _ws.address).   
+0003df60: 2020 2020 2066 6169 6c65 645f 6b65 7973       failed_keys
+0003df70: 5f62 795f 7265 6369 7069 656e 7420 3d20  _by_recipient = 
+0003df80: 6469 6374 280a 2020 2020 2020 2020 2020  dict(.          
+0003df90: 2020 7a69 7028 0a20 2020 2020 2020 2020    zip(.         
+0003dfa0: 2020 2020 2020 2074 6f5f 7265 6369 7069         to_recipi
+0003dfb0: 656e 7473 2c0a 2020 2020 2020 2020 2020  ents,.          
+0003dfc0: 2020 2020 2020 6177 6169 7420 6173 796e        await asyn
+0003dfd0: 6369 6f2e 6761 7468 6572 280a 2020 2020  cio.gather(.    
+0003dfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003dff0: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
+0003e000: 2020 2020 2020 2020 2020 2023 204e 6f74             # Not
+0003e010: 653a 2074 6869 7320 6e65 7665 7220 7261  e: this never ra
+0003e020: 6973 6573 2065 7863 6570 7469 6f6e 730a  ises exceptions.
+0003e030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e040: 2020 2020 2020 2020 7365 6c66 2e67 6174          self.gat
+0003e050: 6865 725f 6f6e 5f77 6f72 6b65 7228 772c  her_on_worker(w,
+0003e060: 2077 686f 5f68 6173 290a 2020 2020 2020   who_has).      
+0003e070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e080: 2020 666f 7220 772c 2077 686f 5f68 6173    for w, who_has
+0003e090: 2069 6e20 746f 5f72 6563 6970 6965 6e74   in to_recipient
+0003e0a0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
+0003e0b0: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+0003e0c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e0d0: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
+0003e0e0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0003e0f0: 2020 2020 746f 5f73 656e 6465 7273 203d      to_senders =
+0003e100: 2064 6566 6175 6c74 6469 6374 286c 6973   defaultdict(lis
+0003e110: 7429 0a20 2020 2020 2020 2066 6f72 2073  t).        for s
+0003e120: 6e64 5f77 732c 2072 6563 5f77 732c 2074  nd_ws, rec_ws, t
+0003e130: 7320 696e 206d 7367 733a 0a20 2020 2020  s in msgs:.     
+0003e140: 2020 2020 2020 2069 6620 7473 2e6b 6579         if ts.key
+0003e150: 206e 6f74 2069 6e20 6661 696c 6564 5f6b   not in failed_k
+0003e160: 6579 735f 6279 5f72 6563 6970 6965 6e74  eys_by_recipient
+0003e170: 5b72 6563 5f77 732e 6164 6472 6573 735d  [rec_ws.address]
+0003e180: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0003e190: 2020 746f 5f73 656e 6465 7273 5b73 6e64    to_senders[snd
+0003e1a0: 5f77 732e 6164 6472 6573 735d 2e61 7070  _ws.address].app
+0003e1b0: 656e 6428 7473 2e6b 6579 290a 0a20 2020  end(ts.key)..   
+0003e1c0: 2020 2020 2023 204e 6f74 653a 2074 6869       # Note: thi
+0003e1d0: 7320 6e65 7665 7220 7261 6973 6573 2065  s never raises e
+0003e1e0: 7863 6570 7469 6f6e 730a 2020 2020 2020  xceptions.      
+0003e1f0: 2020 6177 6169 7420 6173 796e 6369 6f2e    await asyncio.
+0003e200: 6761 7468 6572 280a 2020 2020 2020 2020  gather(.        
+0003e210: 2020 2020 2a28 7365 6c66 2e64 656c 6574      *(self.delet
+0003e220: 655f 776f 726b 6572 5f64 6174 6128 722c  e_worker_data(r,
+0003e230: 2076 2c20 7374 696d 756c 7573 5f69 6429   v, stimulus_id)
+0003e240: 2066 6f72 2072 2c20 7620 696e 2074 6f5f   for r, v in to_
+0003e250: 7365 6e64 6572 732e 6974 656d 7328 2929  senders.items())
+0003e260: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0003e270: 2020 2020 666f 7220 722c 2076 2069 6e20      for r, v in 
+0003e280: 746f 5f72 6563 6970 6965 6e74 732e 6974  to_recipients.it
+0003e290: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
+0003e2a0: 2020 2073 656c 662e 6c6f 675f 6576 656e     self.log_even
+0003e2b0: 7428 722c 207b 2261 6374 696f 6e22 3a20  t(r, {"action": 
+0003e2c0: 2272 6562 616c 616e 6365 222c 2022 7768  "rebalance", "wh
+0003e2d0: 6f5f 6861 7322 3a20 767d 290a 2020 2020  o_has": v}).    
+0003e2e0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+0003e2f0: 6e74 280a 2020 2020 2020 2020 2020 2020  nt(.            
+0003e300: 2261 6c6c 222c 0a20 2020 2020 2020 2020  "all",.         
+0003e310: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0003e320: 2020 2020 2022 6163 7469 6f6e 223a 2022       "action": "
+0003e330: 7265 6261 6c61 6e63 6522 2c0a 2020 2020  rebalance",.    
+0003e340: 2020 2020 2020 2020 2020 2020 2273 656e              "sen
+0003e350: 6465 7273 223a 2076 616c 6d61 7028 6c65  ders": valmap(le
+0003e360: 6e2c 2074 6f5f 7365 6e64 6572 7329 2c0a  n, to_senders),.
+0003e370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003e380: 2272 6563 6970 6965 6e74 7322 3a20 7661  "recipients": va
+0003e390: 6c6d 6170 286c 656e 2c20 746f 5f72 6563  lmap(len, to_rec
+0003e3a0: 6970 6965 6e74 7329 2c0a 2020 2020 2020  ipients),.      
+0003e3b0: 2020 2020 2020 2020 2020 226d 6f76 6564            "moved
+0003e3c0: 5f6b 6579 7322 3a20 6c65 6e28 6d73 6773  _keys": len(msgs
+0003e3d0: 292c 0a20 2020 2020 2020 2020 2020 207d  ),.            }
+0003e3e0: 2c0a 2020 2020 2020 2020 290a 0a20 2020  ,.        )..   
+0003e3f0: 2020 2020 206d 6973 7369 6e67 5f6b 6579       missing_key
+0003e400: 7320 3d20 7b6b 2066 6f72 2072 2069 6e20  s = {k for r in 
+0003e410: 6661 696c 6564 5f6b 6579 735f 6279 5f72  failed_keys_by_r
+0003e420: 6563 6970 6965 6e74 2e76 616c 7565 7328  ecipient.values(
+0003e430: 2920 666f 7220 6b20 696e 2072 7d0a 2020  ) for k in r}.  
+0003e440: 2020 2020 2020 6966 206d 6973 7369 6e67        if missing
+0003e450: 5f6b 6579 733a 0a20 2020 2020 2020 2020  _keys:.         
+0003e460: 2020 2072 6574 7572 6e20 7b22 7374 6174     return {"stat
+0003e470: 7573 223a 2022 7061 7274 6961 6c2d 6661  us": "partial-fa
+0003e480: 696c 222c 2022 6b65 7973 223a 206c 6973  il", "keys": lis
+0003e490: 7428 6d69 7373 696e 675f 6b65 7973 297d  t(missing_keys)}
+0003e4a0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0003e4b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0003e4c0: 6e20 7b22 7374 6174 7573 223a 2022 4f4b  n {"status": "OK
+0003e4d0: 227d 0a0a 2020 2020 6173 796e 6320 6465  "}..    async de
+0003e4e0: 6620 7265 706c 6963 6174 6528 0a20 2020  f replicate(.   
+0003e4f0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+0003e500: 2020 2063 6f6d 6d3d 4e6f 6e65 2c0a 2020     comm=None,.  
+0003e510: 2020 2020 2020 6b65 7973 3d4e 6f6e 652c        keys=None,
+0003e520: 0a20 2020 2020 2020 206e 3d4e 6f6e 652c  .        n=None,
+0003e530: 0a20 2020 2020 2020 2077 6f72 6b65 7273  .        workers
+0003e540: 3d4e 6f6e 652c 0a20 2020 2020 2020 2062  =None,.        b
+0003e550: 7261 6e63 6869 6e67 5f66 6163 746f 723d  ranching_factor=
+0003e560: 322c 0a20 2020 2020 2020 2064 656c 6574  2,.        delet
+0003e570: 653d 5472 7565 2c0a 2020 2020 2020 2020  e=True,.        
+0003e580: 7374 696d 756c 7573 5f69 643d 4e6f 6e65  stimulus_id=None
+0003e590: 2c0a 2020 2020 293a 0a20 2020 2020 2020  ,.    ):.       
+0003e5a0: 2022 2222 5265 706c 6963 6174 6520 6461   """Replicate da
+0003e5b0: 7461 2074 6872 6f75 6768 6f75 7420 636c  ta throughout cl
+0003e5c0: 7573 7465 720a 0a20 2020 2020 2020 2054  uster..        T
+0003e5d0: 6869 7320 7065 7266 6f72 6d73 2061 2074  his performs a t
+0003e5e0: 7265 6520 636f 7079 206f 6620 7468 6520  ree copy of the 
+0003e5f0: 6461 7461 2074 6872 6f75 6768 6f75 7420  data throughout 
+0003e600: 7468 6520 6e65 7477 6f72 6b0a 2020 2020  the network.    
+0003e610: 2020 2020 696e 6469 7669 6475 616c 6c79      individually
+0003e620: 206f 6e20 6561 6368 2070 6965 6365 206f   on each piece o
+0003e630: 6620 6461 7461 2e0a 0a20 2020 2020 2020  f data...       
+0003e640: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+0003e650: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+0003e660: 2020 2020 2020 206b 6579 733a 2049 7465         keys: Ite
+0003e670: 7261 626c 650a 2020 2020 2020 2020 2020  rable.          
+0003e680: 2020 6c69 7374 206f 6620 6b65 7973 2074    list of keys t
+0003e690: 6f20 7265 706c 6963 6174 650a 2020 2020  o replicate.    
+0003e6a0: 2020 2020 6e3a 2069 6e74 0a20 2020 2020      n: int.     
+0003e6b0: 2020 2020 2020 204e 756d 6265 7220 6f66         Number of
+0003e6c0: 2072 6570 6c69 6361 7469 6f6e 7320 7765   replications we
+0003e6d0: 2065 7870 6563 7420 746f 2073 6565 2077   expect to see w
+0003e6e0: 6974 6869 6e20 7468 6520 636c 7573 7465  ithin the cluste
+0003e6f0: 720a 2020 2020 2020 2020 6272 616e 6368  r.        branch
+0003e700: 696e 675f 6661 6374 6f72 3a20 696e 742c  ing_factor: int,
+0003e710: 206f 7074 696f 6e61 6c0a 2020 2020 2020   optional.      
+0003e720: 2020 2020 2020 5468 6520 6e75 6d62 6572        The number
+0003e730: 206f 6620 776f 726b 6572 7320 7468 6174   of workers that
+0003e740: 2063 616e 2063 6f70 7920 6461 7461 2069   can copy data i
+0003e750: 6e20 6561 6368 2067 656e 6572 6174 696f  n each generatio
+0003e760: 6e2e 0a20 2020 2020 2020 2020 2020 2054  n..            T
+0003e770: 6865 206c 6172 6765 7220 7468 6520 6272  he larger the br
+0003e780: 616e 6368 696e 6720 6661 6374 6f72 2c20  anching factor, 
+0003e790: 7468 6520 6d6f 7265 2064 6174 6120 7765  the more data we
+0003e7a0: 2063 6f70 7920 696e 0a20 2020 2020 2020   copy in.       
+0003e7b0: 2020 2020 2061 2073 696e 676c 6520 7374       a single st
+0003e7c0: 6570 2c20 6275 7420 7468 6520 6d6f 7265  ep, but the more
+0003e7d0: 2061 2067 6976 656e 2077 6f72 6b65 7220   a given worker 
+0003e7e0: 7269 736b 7320 6265 696e 670a 2020 2020  risks being.    
+0003e7f0: 2020 2020 2020 2020 7377 616d 7065 6420          swamped 
+0003e800: 6279 2064 6174 6120 7265 7175 6573 7473  by data requests
+0003e810: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
+0003e820: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
+0003e830: 2d2d 2d2d 0a20 2020 2020 2020 2053 6368  ----.        Sch
+0003e840: 6564 756c 6572 2e72 6562 616c 616e 6365  eduler.rebalance
+0003e850: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0003e860: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+0003e870: 203d 2073 7469 6d75 6c75 735f 6964 206f   = stimulus_id o
+0003e880: 7220 6622 7265 706c 6963 6174 652d 7b74  r f"replicate-{t
+0003e890: 696d 6528 297d 220a 2020 2020 2020 2020  ime()}".        
+0003e8a0: 6173 7365 7274 2062 7261 6e63 6869 6e67  assert branching
+0003e8b0: 5f66 6163 746f 7220 3e20 300a 2020 2020  _factor > 0.    
+0003e8c0: 2020 2020 2320 446f 776e 6772 6164 6520      # Downgrade 
+0003e8d0: 7265 656e 7472 616e 7420 6c6f 636b 2074  reentrant lock t
+0003e8e0: 6f20 6e6f 6e2d 7265 656e 7472 616e 740a  o non-reentrant.
+0003e8f0: 2020 2020 2020 2020 6173 796e 6320 7769          async wi
+0003e900: 7468 2073 656c 662e 5f72 6570 6c69 6361  th self._replica
+0003e910: 5f6c 6f63 6b28 2822 7265 706c 6963 6174  _lock(("replicat
+0003e920: 6522 2c20 6f62 6a65 6374 2829 2929 3a0a  e", object())):.
+0003e930: 2020 2020 2020 2020 2020 2020 6966 2077              if w
+0003e940: 6f72 6b65 7273 2069 7320 6e6f 7420 4e6f  orkers is not No
+0003e950: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0003e960: 2020 2020 776f 726b 6572 7320 3d20 7b73      workers = {s
+0003e970: 656c 662e 776f 726b 6572 735b 775d 2066  elf.workers[w] f
+0003e980: 6f72 2077 2069 6e20 7365 6c66 2e77 6f72  or w in self.wor
+0003e990: 6b65 7273 5f6c 6973 7428 776f 726b 6572  kers_list(worker
+0003e9a0: 7329 7d0a 2020 2020 2020 2020 2020 2020  s)}.            
+0003e9b0: 2020 2020 776f 726b 6572 7320 3d20 7b77      workers = {w
+0003e9c0: 7320 666f 7220 7773 2069 6e20 776f 726b  s for ws in work
+0003e9d0: 6572 7320 6966 2077 732e 7374 6174 7573  ers if ws.status
+0003e9e0: 203d 3d20 5374 6174 7573 2e72 756e 6e69   == Status.runni
+0003e9f0: 6e67 7d0a 2020 2020 2020 2020 2020 2020  ng}.            
+0003ea00: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0003ea10: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+0003ea20: 7365 6c66 2e72 756e 6e69 6e67 0a0a 2020  self.running..  
+0003ea30: 2020 2020 2020 2020 2020 6966 206e 2069            if n i
+0003ea40: 7320 4e6f 6e65 3a0a 2020 2020 2020 2020  s None:.        
+0003ea50: 2020 2020 2020 2020 6e20 3d20 6c65 6e28          n = len(
+0003ea60: 776f 726b 6572 7329 0a20 2020 2020 2020  workers).       
+0003ea70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0003ea80: 2020 2020 2020 2020 2020 206e 203d 206d             n = m
+0003ea90: 696e 286e 2c20 6c65 6e28 776f 726b 6572  in(n, len(worker
+0003eaa0: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+0003eab0: 6966 206e 203d 3d20 303a 0a20 2020 2020  if n == 0:.     
+0003eac0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+0003ead0: 2056 616c 7565 4572 726f 7228 2243 616e   ValueError("Can
+0003eae0: 206e 6f74 2075 7365 2072 6570 6c69 6361   not use replica
+0003eaf0: 7465 2074 6f20 6465 6c65 7465 2064 6174  te to delete dat
+0003eb00: 6122 290a 0a20 2020 2020 2020 2020 2020  a")..           
+0003eb10: 2074 6173 6b73 203d 207b 7365 6c66 2e74   tasks = {self.t
+0003eb20: 6173 6b73 5b6b 5d20 666f 7220 6b20 696e  asks[k] for k in
+0003eb30: 206b 6579 737d 0a20 2020 2020 2020 2020   keys}.         
+0003eb40: 2020 206d 6973 7369 6e67 5f64 6174 6120     missing_data 
+0003eb50: 3d20 5b74 732e 6b65 7920 666f 7220 7473  = [ts.key for ts
+0003eb60: 2069 6e20 7461 736b 7320 6966 206e 6f74   in tasks if not
+0003eb70: 2074 732e 7768 6f5f 6861 735d 0a20 2020   ts.who_has].   
+0003eb80: 2020 2020 2020 2020 2069 6620 6d69 7373           if miss
+0003eb90: 696e 675f 6461 7461 3a0a 2020 2020 2020  ing_data:.      
+0003eba0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0003ebb0: 207b 2273 7461 7475 7322 3a20 2270 6172   {"status": "par
+0003ebc0: 7469 616c 2d66 6169 6c22 2c20 226b 6579  tial-fail", "key
+0003ebd0: 7322 3a20 6d69 7373 696e 675f 6461 7461  s": missing_data
+0003ebe0: 7d0a 0a20 2020 2020 2020 2020 2020 2023  }..            #
+0003ebf0: 2044 656c 6574 6520 6578 7472 616e 656f   Delete extraneo
+0003ec00: 7573 2064 6174 610a 2020 2020 2020 2020  us data.        
+0003ec10: 2020 2020 6966 2064 656c 6574 653a 0a20      if delete:. 
+0003ec20: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+0003ec30: 656c 5f77 6f72 6b65 725f 7461 736b 7320  el_worker_tasks 
+0003ec40: 3d20 6465 6661 756c 7464 6963 7428 7365  = defaultdict(se
+0003ec50: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+0003ec60: 2020 2066 6f72 2074 7320 696e 2074 6173     for ts in tas
+0003ec70: 6b73 3a0a 2020 2020 2020 2020 2020 2020  ks:.            
+0003ec80: 2020 2020 2020 2020 6465 6c5f 6361 6e64          del_cand
+0003ec90: 6964 6174 6573 203d 2074 7570 6c65 2874  idates = tuple(t
+0003eca0: 732e 7768 6f5f 6861 7320 2620 776f 726b  s.who_has & work
+0003ecb0: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
+0003ecc0: 2020 2020 2020 2020 2069 6620 6c65 6e28           if len(
+0003ecd0: 6465 6c5f 6361 6e64 6964 6174 6573 2920  del_candidates) 
+0003ece0: 3e20 6e3a 0a20 2020 2020 2020 2020 2020  > n:.           
+0003ecf0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0003ed00: 2077 7320 696e 2072 616e 646f 6d2e 7361   ws in random.sa
+0003ed10: 6d70 6c65 280a 2020 2020 2020 2020 2020  mple(.          
+0003ed20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ed30: 2020 6465 6c5f 6361 6e64 6964 6174 6573    del_candidates
+0003ed40: 2c20 6c65 6e28 6465 6c5f 6361 6e64 6964  , len(del_candid
+0003ed50: 6174 6573 2920 2d20 6e0a 2020 2020 2020  ates) - n.      
+0003ed60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ed70: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+0003ed80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ed90: 2064 656c 5f77 6f72 6b65 725f 7461 736b   del_worker_task
+0003eda0: 735b 7773 5d2e 6164 6428 7473 290a 0a20  s[ws].add(ts).. 
+0003edb0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0003edc0: 204e 6f74 653a 2074 6869 7320 6e65 7665   Note: this neve
+0003edd0: 7220 7261 6973 6573 2065 7863 6570 7469  r raises excepti
+0003ede0: 6f6e 730a 2020 2020 2020 2020 2020 2020  ons.            
+0003edf0: 2020 2020 6177 6169 7420 6173 796e 6369      await asynci
+0003ee00: 6f2e 6761 7468 6572 280a 2020 2020 2020  o.gather(.      
+0003ee10: 2020 2020 2020 2020 2020 2020 2020 2a5b                *[
+0003ee20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003ee30: 2020 2020 2020 2020 2073 656c 662e 6465           self.de
+0003ee40: 6c65 7465 5f77 6f72 6b65 725f 6461 7461  lete_worker_data
+0003ee50: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0003ee60: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+0003ee70: 2e61 6464 7265 7373 2c20 5b74 2e6b 6579  .address, [t.key
+0003ee80: 2066 6f72 2074 2069 6e20 7461 736b 735d   for t in tasks]
+0003ee90: 2c20 7374 696d 756c 7573 5f69 640a 2020  , stimulus_id.  
+0003eea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003eeb0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0003eec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003eed0: 666f 7220 7773 2c20 7461 736b 7320 696e  for ws, tasks in
+0003eee0: 2064 656c 5f77 6f72 6b65 725f 7461 736b   del_worker_task
+0003eef0: 732e 6974 656d 7328 290a 2020 2020 2020  s.items().      
+0003ef00: 2020 2020 2020 2020 2020 2020 2020 5d0a                ].
+0003ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003ef20: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+0003ef30: 2043 6f70 7920 6e6f 742d 7965 742d 6669   Copy not-yet-fi
+0003ef40: 6c6c 6564 2064 6174 610a 2020 2020 2020  lled data.      
+0003ef50: 2020 2020 2020 7768 696c 6520 7461 736b        while task
+0003ef60: 733a 0a20 2020 2020 2020 2020 2020 2020  s:.             
+0003ef70: 2020 2067 6174 6865 7273 203d 2064 6566     gathers = def
+0003ef80: 6175 6c74 6469 6374 2864 6963 7429 0a20  aultdict(dict). 
+0003ef90: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0003efa0: 6f72 2074 7320 696e 206c 6973 7428 7461  or ts in list(ta
+0003efb0: 736b 7329 3a0a 2020 2020 2020 2020 2020  sks):.          
+0003efc0: 2020 2020 2020 2020 2020 6966 2074 732e            if ts.
+0003efd0: 7374 6174 6520 3d3d 2022 666f 7267 6f74  state == "forgot
+0003efe0: 7465 6e22 3a0a 2020 2020 2020 2020 2020  ten":.          
+0003eff0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+0003f000: 7461 736b 2069 7320 6e6f 206c 6f6e 6765  task is no longe
+0003f010: 7220 6e65 6564 6564 2062 7920 616e 7920  r needed by any 
+0003f020: 636c 6965 6e74 206f 7220 6465 7065 6e64  client or depend
+0003f030: 656e 7420 7461 736b 0a20 2020 2020 2020  ent task.       
+0003f040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f050: 2074 6173 6b73 2e72 656d 6f76 6528 7473   tasks.remove(ts
+0003f060: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0003f070: 2020 2020 2020 2020 2020 636f 6e74 696e            contin
+0003f080: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+0003f090: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
+0003f0a0: 2e77 686f 5f68 6173 2069 7320 6e6f 7420  .who_has is not 
+0003f0b0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+0003f0c0: 2020 2020 2020 2020 206e 5f6d 6973 7369           n_missi
+0003f0d0: 6e67 203d 206e 202d 206c 656e 2874 732e  ng = n - len(ts.
+0003f0e0: 7768 6f5f 6861 7320 2620 776f 726b 6572  who_has & worker
+0003f0f0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+0003f100: 2020 2020 2020 2069 6620 6e5f 6d69 7373         if n_miss
+0003f110: 696e 6720 3c3d 2030 3a0a 2020 2020 2020  ing <= 0:.      
+0003f120: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f130: 2020 2320 416c 7265 6164 7920 7265 706c    # Already repl
+0003f140: 6963 6174 6564 2065 6e6f 7567 680a 2020  icated enough.  
+0003f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f160: 2020 2020 2020 7461 736b 732e 7265 6d6f        tasks.remo
+0003f170: 7665 2874 7329 0a20 2020 2020 2020 2020  ve(ts).         
+0003f180: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0003f190: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+0003f1a0: 2020 2020 2020 2020 2020 2020 2063 6f75               cou
+0003f1b0: 6e74 203d 206d 696e 286e 5f6d 6973 7369  nt = min(n_missi
+0003f1c0: 6e67 2c20 6272 616e 6368 696e 675f 6661  ng, branching_fa
+0003f1d0: 6374 6f72 202a 206c 656e 2874 732e 7768  ctor * len(ts.wh
+0003f1e0: 6f5f 6861 7329 290a 2020 2020 2020 2020  o_has)).        
+0003f1f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0003f200: 7274 2063 6f75 6e74 203e 2030 0a0a 2020  rt count > 0..  
+0003f210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f220: 2020 666f 7220 7773 2069 6e20 7261 6e64    for ws in rand
+0003f230: 6f6d 2e73 616d 706c 6528 7475 706c 6528  om.sample(tuple(
+0003f240: 776f 726b 6572 7320 2d20 7473 2e77 686f  workers - ts.who
+0003f250: 5f68 6173 292c 2063 6f75 6e74 293a 0a20  _has), count):. 
+0003f260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f270: 2020 2020 2020 2067 6174 6865 7273 5b77         gathers[w
+0003f280: 732e 6164 6472 6573 735d 5b74 732e 6b65  s.address][ts.ke
+0003f290: 795d 203d 205b 0a20 2020 2020 2020 2020  y] = [.         
+0003f2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f2b0: 2020 2077 7773 2e61 6464 7265 7373 2066     wws.address f
+0003f2c0: 6f72 2077 7773 2069 6e20 7473 2e77 686f  or wws in ts.who
+0003f2d0: 5f68 6173 0a20 2020 2020 2020 2020 2020  _has.           
+0003f2e0: 2020 2020 2020 2020 2020 2020 205d 0a0a               ]..
+0003f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f300: 6177 6169 7420 6173 796e 6369 6f2e 6761  await asyncio.ga
+0003f310: 7468 6572 280a 2020 2020 2020 2020 2020  ther(.          
+0003f320: 2020 2020 2020 2020 2020 2a28 0a20 2020            *(.   
+0003f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f340: 2020 2020 2023 204e 6f74 653a 2074 6869       # Note: thi
+0003f350: 7320 6e65 7665 7220 7261 6973 6573 2065  s never raises e
+0003f360: 7863 6570 7469 6f6e 730a 2020 2020 2020  xceptions.      
+0003f370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f380: 2020 7365 6c66 2e67 6174 6865 725f 6f6e    self.gather_on
+0003f390: 5f77 6f72 6b65 7228 772c 2077 686f 5f68  _worker(w, who_h
+0003f3a0: 6173 290a 2020 2020 2020 2020 2020 2020  as).            
+0003f3b0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0003f3c0: 772c 2077 686f 5f68 6173 2069 6e20 6761  w, who_has in ga
+0003f3d0: 7468 6572 732e 6974 656d 7328 290a 2020  thers.items().  
+0003f3e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f3f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0003f400: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0003f410: 2020 2020 2020 666f 7220 722c 2076 2069        for r, v i
+0003f420: 6e20 6761 7468 6572 732e 6974 656d 7328  n gathers.items(
+0003f430: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0003f440: 2020 2020 2020 2073 656c 662e 6c6f 675f         self.log_
+0003f450: 6576 656e 7428 722c 207b 2261 6374 696f  event(r, {"actio
+0003f460: 6e22 3a20 2272 6570 6c69 6361 7465 2d61  n": "replicate-a
+0003f470: 6464 222c 2022 7768 6f5f 6861 7322 3a20  dd", "who_has": 
+0003f480: 767d 290a 0a20 2020 2020 2020 2020 2020  v})..           
+0003f490: 2073 656c 662e 6c6f 675f 6576 656e 7428   self.log_event(
+0003f4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0003f4b0: 2022 616c 6c22 2c0a 2020 2020 2020 2020   "all",.        
+0003f4c0: 2020 2020 2020 2020 7b0a 2020 2020 2020          {.      
+0003f4d0: 2020 2020 2020 2020 2020 2020 2020 2261                "a
+0003f4e0: 6374 696f 6e22 3a20 2272 6570 6c69 6361  ction": "replica
+0003f4f0: 7465 222c 0a20 2020 2020 2020 2020 2020  te",.           
+0003f500: 2020 2020 2020 2020 2022 776f 726b 6572           "worker
+0003f510: 7322 3a20 6c69 7374 2877 6f72 6b65 7273  s": list(workers
+0003f520: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+0003f530: 2020 2020 2020 2022 6b65 792d 636f 756e         "key-coun
+0003f540: 7422 3a20 6c65 6e28 6b65 7973 292c 0a20  t": len(keys),. 
+0003f550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0003f560: 2020 2022 6272 616e 6368 696e 672d 6661     "branching-fa
+0003f570: 6374 6f72 223a 2062 7261 6e63 6869 6e67  ctor": branching
+0003f580: 5f66 6163 746f 722c 0a20 2020 2020 2020  _factor,.       
+0003f590: 2020 2020 2020 2020 207d 2c0a 2020 2020           },.    
+0003f5a0: 2020 2020 2020 2020 290a 0a20 2020 2040          )..    @
+0003f5b0: 6c6f 675f 6572 726f 7273 0a20 2020 2064  log_errors.    d
+0003f5c0: 6566 2077 6f72 6b65 7273 5f74 6f5f 636c  ef workers_to_cl
+0003f5d0: 6f73 6528 0a20 2020 2020 2020 2073 656c  ose(.        sel
+0003f5e0: 662c 0a20 2020 2020 2020 206d 656d 6f72  f,.        memor
+0003f5f0: 795f 7261 7469 6f3a 2069 6e74 207c 2066  y_ratio: int | f
+0003f600: 6c6f 6174 207c 204e 6f6e 6520 3d20 4e6f  loat | None = No
+0003f610: 6e65 2c0a 2020 2020 2020 2020 6e3a 2069  ne,.        n: i
+0003f620: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
+0003f630: 2c0a 2020 2020 2020 2020 6b65 793a 2043  ,.        key: C
+0003f640: 616c 6c61 626c 655b 5b57 6f72 6b65 7253  allable[[WorkerS
+0003f650: 7461 7465 5d2c 2048 6173 6861 626c 655d  tate], Hashable]
+0003f660: 207c 2062 7974 6573 207c 204e 6f6e 6520   | bytes | None 
+0003f670: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
+0003f680: 6d69 6e69 6d75 6d3a 2069 6e74 207c 204e  minimum: int | N
+0003f690: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+0003f6a0: 2020 2020 7461 7267 6574 3a20 696e 7420      target: int 
+0003f6b0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+0003f6c0: 2020 2020 2020 2061 7474 7269 6275 7465         attribute
+0003f6d0: 3a20 7374 7220 3d20 2261 6464 7265 7373  : str = "address
+0003f6e0: 222c 0a20 2020 2029 202d 3e20 6c69 7374  ",.    ) -> list
+0003f6f0: 5b73 7472 5d3a 0a20 2020 2020 2020 2022  [str]:.        "
+0003f700: 2222 0a20 2020 2020 2020 2046 696e 6420  "".        Find 
+0003f710: 776f 726b 6572 7320 7468 6174 2077 6520  workers that we 
+0003f720: 6361 6e20 636c 6f73 6520 7769 7468 206c  can close with l
+0003f730: 6f77 2063 6f73 740a 0a20 2020 2020 2020  ow cost..       
+0003f740: 2054 6869 7320 7265 7475 726e 7320 6120   This returns a 
+0003f750: 6c69 7374 206f 6620 776f 726b 6572 7320  list of workers 
+0003f760: 7468 6174 2061 7265 2067 6f6f 6420 6361  that are good ca
+0003f770: 6e64 6964 6174 6573 2074 6f20 7265 7469  ndidates to reti
+0003f780: 7265 2e0a 2020 2020 2020 2020 5468 6573  re..        Thes
+0003f790: 6520 776f 726b 6572 7320 6172 6520 6e6f  e workers are no
+0003f7a0: 7420 7275 6e6e 696e 6720 616e 7974 6869  t running anythi
+0003f7b0: 6e67 2061 6e64 2061 7265 2073 746f 7269  ng and are stori
+0003f7c0: 6e67 0a20 2020 2020 2020 2072 656c 6174  ng.        relat
+0003f7d0: 6976 656c 7920 6c69 7474 6c65 2064 6174  ively little dat
+0003f7e0: 6120 7265 6c61 7469 7665 2074 6f20 7468  a relative to th
+0003f7f0: 6569 7220 7065 6572 732e 2020 4966 2061  eir peers.  If a
+0003f800: 6c6c 2077 6f72 6b65 7273 2061 7265 0a20  ll workers are. 
+0003f810: 2020 2020 2020 2069 646c 6520 7468 656e         idle then
+0003f820: 2077 6520 7374 696c 6c20 6d61 696e 7461   we still mainta
+0003f830: 696e 2065 6e6f 7567 6820 776f 726b 6572  in enough worker
+0003f840: 7320 746f 2068 6176 6520 656e 6f75 6768  s to have enough
+0003f850: 2052 414d 2074 6f20 7374 6f72 650a 2020   RAM to store.  
+0003f860: 2020 2020 2020 6f75 7220 6461 7461 2c20        our data, 
+0003f870: 7769 7468 2061 2063 6f6d 666f 7274 6162  with a comfortab
+0003f880: 6c65 2062 7566 6665 722e 0a0a 2020 2020  le buffer...    
+0003f890: 2020 2020 5468 6973 2069 7320 666f 7220      This is for 
+0003f8a0: 7573 6520 7769 7468 2073 7973 7465 6d73  use with systems
+0003f8b0: 206c 696b 6520 6060 6469 7374 7269 6275   like ``distribu
+0003f8c0: 7465 642e 6465 706c 6f79 2e61 6461 7074  ted.deploy.adapt
+0003f8d0: 6976 6560 602e 0a0a 2020 2020 2020 2020  ive``...        
+0003f8e0: 5061 7261 6d65 7465 7273 0a20 2020 2020  Parameters.     
+0003f8f0: 2020 202d 2d2d 2d2d 2d2d 2d2d 2d0a 2020     ----------.  
+0003f900: 2020 2020 2020 6d65 6d6f 7279 5f72 6174        memory_rat
+0003f910: 696f 203a 204e 756d 6265 720a 2020 2020  io : Number.    
+0003f920: 2020 2020 2020 2020 416d 6f75 6e74 206f          Amount o
+0003f930: 6620 6578 7472 6120 7370 6163 6520 7765  f extra space we
+0003f940: 2077 616e 7420 746f 2068 6176 6520 666f   want to have fo
+0003f950: 7220 6f75 7220 7374 6f72 6564 2064 6174  r our stored dat
+0003f960: 612e 0a20 2020 2020 2020 2020 2020 2044  a..            D
+0003f970: 6566 6175 6c74 7320 746f 2032 2c20 6f72  efaults to 2, or
+0003f980: 2074 6861 7420 7765 2077 616e 7420 746f   that we want to
+0003f990: 2068 6176 6520 7477 6963 6520 6173 206d   have twice as m
+0003f9a0: 7563 6820 6d65 6d6f 7279 2061 7320 7765  uch memory as we
+0003f9b0: 0a20 2020 2020 2020 2020 2020 2063 7572  .            cur
+0003f9c0: 7265 6e74 6c79 2068 6176 6520 6461 7461  rently have data
+0003f9d0: 2e0a 2020 2020 2020 2020 6e20 3a20 696e  ..        n : in
+0003f9e0: 740a 2020 2020 2020 2020 2020 2020 4e75  t.            Nu
+0003f9f0: 6d62 6572 206f 6620 776f 726b 6572 7320  mber of workers 
+0003fa00: 746f 2063 6c6f 7365 0a20 2020 2020 2020  to close.       
+0003fa10: 206d 696e 696d 756d 203a 2069 6e74 0a20   minimum : int. 
+0003fa20: 2020 2020 2020 2020 2020 204d 696e 696d             Minim
+0003fa30: 756d 206e 756d 6265 7220 6f66 2077 6f72  um number of wor
+0003fa40: 6b65 7273 2074 6f20 6b65 6570 2061 726f  kers to keep aro
+0003fa50: 756e 640a 2020 2020 2020 2020 6b65 7920  und.        key 
+0003fa60: 3a20 4361 6c6c 6162 6c65 2857 6f72 6b65  : Callable(Worke
+0003fa70: 7253 7461 7465 290a 2020 2020 2020 2020  rState).        
+0003fa80: 2020 2020 416e 206f 7074 696f 6e61 6c20      An optional 
+0003fa90: 6361 6c6c 6162 6c65 206d 6170 7069 6e67  callable mapping
+0003faa0: 2061 2057 6f72 6b65 7253 7461 7465 206f   a WorkerState o
+0003fab0: 626a 6563 7420 746f 2061 2067 726f 7570  bject to a group
+0003fac0: 0a20 2020 2020 2020 2020 2020 2061 6666  .            aff
+0003fad0: 696c 6961 7469 6f6e 2e20 4772 6f75 7073  iliation. Groups
+0003fae0: 2077 696c 6c20 6265 2063 6c6f 7365 6420   will be closed 
+0003faf0: 746f 6765 7468 6572 2e20 5468 6973 2069  together. This i
+0003fb00: 7320 7573 6566 756c 2077 6865 6e0a 2020  s useful when.  
+0003fb10: 2020 2020 2020 2020 2020 636c 6f73 696e            closin
+0003fb20: 6720 776f 726b 6572 7320 6d75 7374 2062  g workers must b
+0003fb30: 6520 646f 6e65 2063 6f6c 6c65 6374 6976  e done collectiv
+0003fb40: 656c 792c 2073 7563 6820 6173 2062 7920  ely, such as by 
+0003fb50: 686f 7374 6e61 6d65 2e0a 2020 2020 2020  hostname..      
+0003fb60: 2020 7461 7267 6574 203a 2069 6e74 0a20    target : int. 
+0003fb70: 2020 2020 2020 2020 2020 2054 6172 6765             Targe
+0003fb80: 7420 6e75 6d62 6572 206f 6620 776f 726b  t number of work
+0003fb90: 6572 7320 746f 2068 6176 6520 6166 7465  ers to have afte
+0003fba0: 7220 7765 2063 6c6f 7365 0a20 2020 2020  r we close.     
+0003fbb0: 2020 2061 7474 7269 6275 7465 203a 2073     attribute : s
+0003fbc0: 7472 0a20 2020 2020 2020 2020 2020 2054  tr.            T
+0003fbd0: 6865 2061 7474 7269 6275 7465 206f 6620  he attribute of 
+0003fbe0: 7468 6520 576f 726b 6572 5374 6174 6520  the WorkerState 
+0003fbf0: 6f62 6a65 6374 2074 6f20 7265 7475 726e  object to return
+0003fc00: 2c20 6c69 6b65 2022 6164 6472 6573 7322  , like "address"
+0003fc10: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
+0003fc20: 226e 616d 6522 2e20 2044 6566 6175 6c74  "name".  Default
+0003fc30: 7320 746f 2022 6164 6472 6573 7322 2e0a  s to "address"..
+0003fc40: 0a20 2020 2020 2020 2045 7861 6d70 6c65  .        Example
+0003fc50: 730a 2020 2020 2020 2020 2d2d 2d2d 2d2d  s.        ------
+0003fc60: 2d2d 0a20 2020 2020 2020 203e 3e3e 2073  --.        >>> s
+0003fc70: 6368 6564 756c 6572 2e77 6f72 6b65 7273  cheduler.workers
+0003fc80: 5f74 6f5f 636c 6f73 6528 290a 2020 2020  _to_close().    
+0003fc90: 2020 2020 5b27 7463 703a 2f2f 3139 322e      ['tcp://192.
+0003fca0: 3136 382e 302e 313a 3132 3334 272c 2027  168.0.1:1234', '
+0003fcb0: 7463 703a 2f2f 3139 322e 3136 382e 302e  tcp://192.168.0.
+0003fcc0: 323a 3132 3334 275d 0a0a 2020 2020 2020  2:1234']..      
+0003fcd0: 2020 4772 6f75 7020 776f 726b 6572 7320    Group workers 
+0003fce0: 6279 2068 6f73 746e 616d 6520 7072 696f  by hostname prio
+0003fcf0: 7220 746f 2063 6c6f 7369 6e67 0a0a 2020  r to closing..  
+0003fd00: 2020 2020 2020 3e3e 3e20 7363 6865 6475        >>> schedu
+0003fd10: 6c65 722e 776f 726b 6572 735f 746f 5f63  ler.workers_to_c
+0003fd20: 6c6f 7365 286b 6579 3d6c 616d 6264 6120  lose(key=lambda 
+0003fd30: 7773 3a20 7773 2e68 6f73 7429 0a20 2020  ws: ws.host).   
+0003fd40: 2020 2020 205b 2774 6370 3a2f 2f31 3932       ['tcp://192
+0003fd50: 2e31 3638 2e30 2e31 3a31 3233 3427 2c20  .168.0.1:1234', 
+0003fd60: 2774 6370 3a2f 2f31 3932 2e31 3638 2e30  'tcp://192.168.0
+0003fd70: 2e31 3a34 3536 3727 5d0a 0a20 2020 2020  .1:4567']..     
+0003fd80: 2020 2052 656d 6f76 6520 7477 6f20 776f     Remove two wo
+0003fd90: 726b 6572 730a 0a20 2020 2020 2020 203e  rkers..        >
+0003fda0: 3e3e 2073 6368 6564 756c 6572 2e77 6f72  >> scheduler.wor
+0003fdb0: 6b65 7273 5f74 6f5f 636c 6f73 6528 6e3d  kers_to_close(n=
+0003fdc0: 3229 0a0a 2020 2020 2020 2020 4b65 6570  2)..        Keep
+0003fdd0: 2065 6e6f 7567 6820 776f 726b 6572 7320   enough workers 
+0003fde0: 746f 2068 6176 6520 7477 6963 6520 6173  to have twice as
+0003fdf0: 206d 7563 6820 6d65 6d6f 7279 2061 7320   much memory as 
+0003fe00: 7765 2077 6520 6e65 6564 2e0a 0a20 2020  we we need...   
+0003fe10: 2020 2020 203e 3e3e 2073 6368 6564 756c       >>> schedul
+0003fe20: 6572 2e77 6f72 6b65 7273 5f74 6f5f 636c  er.workers_to_cl
+0003fe30: 6f73 6528 6d65 6d6f 7279 5f72 6174 696f  ose(memory_ratio
+0003fe40: 3d32 290a 0a20 2020 2020 2020 2052 6574  =2)..        Ret
+0003fe50: 7572 6e73 0a20 2020 2020 2020 202d 2d2d  urns.        ---
+0003fe60: 2d2d 2d2d 0a20 2020 2020 2020 2074 6f5f  ----.        to_
+0003fe70: 636c 6f73 653a 206c 6973 7420 6f66 2077  close: list of w
+0003fe80: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
+0003fe90: 7468 6174 2061 7265 204f 4b20 746f 2063  that are OK to c
+0003fea0: 6c6f 7365 0a0a 2020 2020 2020 2020 5365  lose..        Se
+0003feb0: 6520 416c 736f 0a20 2020 2020 2020 202d  e Also.        -
+0003fec0: 2d2d 2d2d 2d2d 2d0a 2020 2020 2020 2020  -------.        
+0003fed0: 5363 6865 6475 6c65 722e 7265 7469 7265  Scheduler.retire
+0003fee0: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+0003fef0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+0003ff00: 7461 7267 6574 2069 7320 6e6f 7420 4e6f  target is not No
+0003ff10: 6e65 2061 6e64 206e 2069 7320 4e6f 6e65  ne and n is None
+0003ff20: 3a0a 2020 2020 2020 2020 2020 2020 6e20  :.            n 
+0003ff30: 3d20 6c65 6e28 7365 6c66 2e77 6f72 6b65  = len(self.worke
+0003ff40: 7273 2920 2d20 7461 7267 6574 0a20 2020  rs) - target.   
+0003ff50: 2020 2020 2069 6620 6e20 6973 206e 6f74       if n is not
+0003ff60: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0003ff70: 2020 2069 6620 6e20 3c20 303a 0a20 2020     if n < 0:.   
+0003ff80: 2020 2020 2020 2020 2020 2020 206e 203d               n =
+0003ff90: 2030 0a20 2020 2020 2020 2020 2020 2074   0.            t
+0003ffa0: 6172 6765 7420 3d20 6c65 6e28 7365 6c66  arget = len(self
+0003ffb0: 2e77 6f72 6b65 7273 2920 2d20 6e0a 0a20  .workers) - n.. 
+0003ffc0: 2020 2020 2020 2069 6620 6e20 6973 204e         if n is N
+0003ffd0: 6f6e 6520 616e 6420 6d65 6d6f 7279 5f72  one and memory_r
+0003ffe0: 6174 696f 2069 7320 4e6f 6e65 3a0a 2020  atio is None:.  
+0003fff0: 2020 2020 2020 2020 2020 6d65 6d6f 7279            memory
+00040000: 5f72 6174 696f 203d 2032 0a0a 2020 2020  _ratio = 2..    
+00040010: 2020 2020 6966 206e 6f74 206e 2061 6e64      if not n and
+00040020: 2061 6c6c 285b 7773 2e70 726f 6365 7373   all([ws.process
+00040030: 696e 6720 666f 7220 7773 2069 6e20 7365  ing for ws in se
+00040040: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
+00040050: 7328 295d 293a 0a20 2020 2020 2020 2020  s()]):.         
+00040060: 2020 2072 6574 7572 6e20 5b5d 0a0a 2020     return []..  
+00040070: 2020 2020 2020 6966 206b 6579 2069 7320        if key is 
+00040080: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00040090: 2020 6b65 7920 3d20 6f70 6572 6174 6f72    key = operator
+000400a0: 2e61 7474 7267 6574 7465 7228 2261 6464  .attrgetter("add
+000400b0: 7265 7373 2229 0a20 2020 2020 2020 2069  ress").        i
+000400c0: 6620 6973 696e 7374 616e 6365 286b 6579  f isinstance(key
+000400d0: 2c20 6279 7465 7329 3a0a 2020 2020 2020  , bytes):.      
+000400e0: 2020 2020 2020 6b65 7920 3d20 7069 636b        key = pick
+000400f0: 6c65 2e6c 6f61 6473 286b 6579 290a 0a20  le.loads(key).. 
+00040100: 2020 2020 2020 2023 204c 6f6e 6720 7275         # Long ru
+00040110: 6e6e 696e 6720 7461 736b 7320 7479 7069  nning tasks typi
+00040120: 6361 6c6c 7920 7573 6520 6120 776f 726b  cally use a work
+00040130: 6572 5f63 6c69 656e 7420 746f 2073 6368  er_client to sch
+00040140: 6564 756c 650a 2020 2020 2020 2020 2320  edule.        # 
+00040150: 6f74 6865 7220 7461 736b 732e 2057 6520  other tasks. We 
+00040160: 7368 6f75 6c64 206e 6576 6572 2073 6875  should never shu
+00040170: 7420 646f 776e 2074 6865 2077 6f72 6b65  t down the worke
+00040180: 7220 7468 6579 2772 650a 2020 2020 2020  r they're.      
+00040190: 2020 2320 7275 6e6e 696e 6720 6f6e 2c20    # running on, 
+000401a0: 6173 2069 7420 776f 756c 6420 6361 7573  as it would caus
+000401b0: 6520 7468 656d 2074 6f20 7265 7374 6172  e them to restar
+000401c0: 7420 6672 6f6d 2073 6372 6174 6368 0a20  t from scratch. 
+000401d0: 2020 2020 2020 2023 2073 6f6d 6577 6865         # somewhe
+000401e0: 7265 2065 6c73 652e 0a20 2020 2020 2020  re else..       
+000401f0: 2076 616c 6964 5f77 6f72 6b65 7273 203d   valid_workers =
+00040200: 205b 7773 2066 6f72 2077 7320 696e 2073   [ws for ws in s
+00040210: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
+00040220: 6573 2829 2069 6620 6e6f 7420 7773 2e6c  es() if not ws.l
+00040230: 6f6e 675f 7275 6e6e 696e 675d 0a20 2020  ong_running].   
+00040240: 2020 2020 2067 726f 7570 7320 3d20 6772       groups = gr
+00040250: 6f75 7062 7928 6b65 792c 2076 616c 6964  oupby(key, valid
+00040260: 5f77 6f72 6b65 7273 290a 0a20 2020 2020  _workers)..     
+00040270: 2020 206c 696d 6974 5f62 7974 6573 203d     limit_bytes =
+00040280: 207b 6b3a 2073 756d 2877 732e 6d65 6d6f   {k: sum(ws.memo
+00040290: 7279 5f6c 696d 6974 2066 6f72 2077 7320  ry_limit for ws 
+000402a0: 696e 2076 2920 666f 7220 6b2c 2076 2069  in v) for k, v i
+000402b0: 6e20 6772 6f75 7073 2e69 7465 6d73 2829  n groups.items()
+000402c0: 7d0a 2020 2020 2020 2020 6772 6f75 705f  }.        group_
+000402d0: 6279 7465 7320 3d20 7b6b 3a20 7375 6d28  bytes = {k: sum(
+000402e0: 7773 2e6e 6279 7465 7320 666f 7220 7773  ws.nbytes for ws
+000402f0: 2069 6e20 7629 2066 6f72 206b 2c20 7620   in v) for k, v 
+00040300: 696e 2067 726f 7570 732e 6974 656d 7328  in groups.items(
+00040310: 297d 0a0a 2020 2020 2020 2020 6c69 6d69  )}..        limi
+00040320: 7420 3d20 7375 6d28 6c69 6d69 745f 6279  t = sum(limit_by
+00040330: 7465 732e 7661 6c75 6573 2829 290a 2020  tes.values()).  
+00040340: 2020 2020 2020 746f 7461 6c20 3d20 7375        total = su
+00040350: 6d28 6772 6f75 705f 6279 7465 732e 7661  m(group_bytes.va
+00040360: 6c75 6573 2829 290a 0a20 2020 2020 2020  lues())..       
+00040370: 2064 6566 205f 6b65 7928 6772 6f75 7029   def _key(group)
+00040380: 3a0a 2020 2020 2020 2020 2020 2020 6973  :.            is
+00040390: 5f69 646c 6520 3d20 6e6f 7420 616e 7928  _idle = not any(
+000403a0: 5b77 7773 2e70 726f 6365 7373 696e 6720  [wws.processing 
+000403b0: 666f 7220 7777 7320 696e 2067 726f 7570  for wws in group
+000403c0: 735b 6772 6f75 705d 5d29 0a20 2020 2020  s[group]]).     
+000403d0: 2020 2020 2020 2062 7974 6573 203d 202d         bytes = -
+000403e0: 6772 6f75 705f 6279 7465 735b 6772 6f75  group_bytes[grou
+000403f0: 705d 0a20 2020 2020 2020 2020 2020 2072  p].            r
+00040400: 6574 7572 6e20 6973 5f69 646c 652c 2062  eturn is_idle, b
+00040410: 7974 6573 0a0a 2020 2020 2020 2020 6964  ytes..        id
+00040420: 6c65 203d 2073 6f72 7465 6428 6772 6f75  le = sorted(grou
+00040430: 7073 2c20 6b65 793d 5f6b 6579 290a 0a20  ps, key=_key).. 
+00040440: 2020 2020 2020 2074 6f5f 636c 6f73 6520         to_close 
+00040450: 3d20 5b5d 0a20 2020 2020 2020 206e 5f72  = [].        n_r
+00040460: 656d 6169 6e20 3d20 6c65 6e28 7365 6c66  emain = len(self
+00040470: 2e77 6f72 6b65 7273 290a 0a20 2020 2020  .workers)..     
+00040480: 2020 2077 6869 6c65 2069 646c 653a 0a20     while idle:. 
+00040490: 2020 2020 2020 2020 2020 2067 726f 7570             group
+000404a0: 203d 2069 646c 652e 706f 7028 290a 2020   = idle.pop().  
+000404b0: 2020 2020 2020 2020 2020 6966 206e 2069            if n i
+000404c0: 7320 4e6f 6e65 2061 6e64 2061 6e79 285b  s None and any([
+000404d0: 7773 2e70 726f 6365 7373 696e 6720 666f  ws.processing fo
+000404e0: 7220 7773 2069 6e20 6772 6f75 7073 5b67  r ws in groups[g
+000404f0: 726f 7570 5d5d 293a 0a20 2020 2020 2020  roup]]):.       
+00040500: 2020 2020 2020 2020 2062 7265 616b 0a0a           break..
+00040510: 2020 2020 2020 2020 2020 2020 6966 206d              if m
+00040520: 696e 696d 756d 2061 6e64 206e 5f72 656d  inimum and n_rem
+00040530: 6169 6e20 2d20 6c65 6e28 6772 6f75 7073  ain - len(groups
+00040540: 5b67 726f 7570 5d29 203c 206d 696e 696d  [group]) < minim
+00040550: 756d 3a0a 2020 2020 2020 2020 2020 2020  um:.            
+00040560: 2020 2020 6272 6561 6b0a 0a20 2020 2020      break..     
+00040570: 2020 2020 2020 206c 696d 6974 202d 3d20         limit -= 
+00040580: 6c69 6d69 745f 6279 7465 735b 6772 6f75  limit_bytes[grou
+00040590: 705d 0a0a 2020 2020 2020 2020 2020 2020  p]..            
+000405a0: 6966 2028 6e20 6973 206e 6f74 204e 6f6e  if (n is not Non
+000405b0: 6520 616e 6420 6e5f 7265 6d61 696e 202d  e and n_remain -
+000405c0: 206c 656e 2867 726f 7570 735b 6772 6f75   len(groups[grou
+000405d0: 705d 2920 3e3d 2028 7461 7267 6574 206f  p]) >= (target o
+000405e0: 7220 3029 2920 6f72 2028 0a20 2020 2020  r 0)) or (.     
+000405f0: 2020 2020 2020 2020 2020 206d 656d 6f72             memor
+00040600: 795f 7261 7469 6f20 6973 206e 6f74 204e  y_ratio is not N
+00040610: 6f6e 6520 616e 6420 6c69 6d69 7420 3e3d  one and limit >=
+00040620: 206d 656d 6f72 795f 7261 7469 6f20 2a20   memory_ratio * 
+00040630: 746f 7461 6c0a 2020 2020 2020 2020 2020  total.          
+00040640: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+00040650: 2020 2020 2074 6f5f 636c 6f73 652e 6170       to_close.ap
+00040660: 7065 6e64 2867 726f 7570 290a 2020 2020  pend(group).    
+00040670: 2020 2020 2020 2020 2020 2020 6e5f 7265              n_re
+00040680: 6d61 696e 202d 3d20 6c65 6e28 6772 6f75  main -= len(grou
+00040690: 7073 5b67 726f 7570 5d29 0a0a 2020 2020  ps[group])..    
+000406a0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000406b0: 2020 2020 2020 2020 2020 2020 2020 6272                br
+000406c0: 6561 6b0a 0a20 2020 2020 2020 2072 6573  eak..        res
+000406d0: 756c 7420 3d20 5b67 6574 6174 7472 2877  ult = [getattr(w
+000406e0: 732c 2061 7474 7269 6275 7465 2920 666f  s, attribute) fo
+000406f0: 7220 6720 696e 2074 6f5f 636c 6f73 6520  r g in to_close 
+00040700: 666f 7220 7773 2069 6e20 6772 6f75 7073  for ws in groups
+00040710: 5b67 5d5d 0a20 2020 2020 2020 2069 6620  [g]].        if 
+00040720: 7265 7375 6c74 3a0a 2020 2020 2020 2020  result:.        
+00040730: 2020 2020 6c6f 6767 6572 2e64 6562 7567      logger.debug
+00040740: 2822 5375 6767 6573 7420 636c 6f73 696e  ("Suggest closin
+00040750: 6720 776f 726b 6572 733a 2025 7322 2c20  g workers: %s", 
+00040760: 7265 7375 6c74 290a 0a20 2020 2020 2020  result)..       
+00040770: 2072 6574 7572 6e20 7265 7375 6c74 0a0a   return result..
+00040780: 2020 2020 406f 7665 726c 6f61 640a 2020      @overload.  
+00040790: 2020 6173 796e 6320 6465 6620 7265 7469    async def reti
+000407a0: 7265 5f77 6f72 6b65 7273 280a 2020 2020  re_workers(.    
+000407b0: 2020 2020 7365 6c66 2c0a 2020 2020 2020      self,.      
+000407c0: 2020 776f 726b 6572 733a 206c 6973 745b    workers: list[
+000407d0: 7374 725d 2c0a 2020 2020 2020 2020 2a2c  str],.        *,
+000407e0: 0a20 2020 2020 2020 2063 6c6f 7365 5f77  .        close_w
+000407f0: 6f72 6b65 7273 3a20 626f 6f6c 203d 2046  orkers: bool = F
+00040800: 616c 7365 2c0a 2020 2020 2020 2020 7265  alse,.        re
+00040810: 6d6f 7665 3a20 626f 6f6c 203d 2054 7275  move: bool = Tru
+00040820: 652c 0a20 2020 2020 2020 2073 7469 6d75  e,.        stimu
+00040830: 6c75 735f 6964 3a20 7374 7220 7c20 4e6f  lus_id: str | No
+00040840: 6e65 203d 204e 6f6e 652c 0a20 2020 2029  ne = None,.    )
+00040850: 202d 3e20 6469 6374 5b73 7472 2c20 416e   -> dict[str, An
+00040860: 795d 3a0a 2020 2020 2020 2020 2e2e 2e0a  y]:.        ....
+00040870: 0a20 2020 2040 6f76 6572 6c6f 6164 0a20  .    @overload. 
+00040880: 2020 2061 7379 6e63 2064 6566 2072 6574     async def ret
+00040890: 6972 655f 776f 726b 6572 7328 0a20 2020  ire_workers(.   
+000408a0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+000408b0: 2020 202a 2c0a 2020 2020 2020 2020 6e61     *,.        na
+000408c0: 6d65 733a 206c 6973 742c 0a20 2020 2020  mes: list,.     
+000408d0: 2020 2063 6c6f 7365 5f77 6f72 6b65 7273     close_workers
+000408e0: 3a20 626f 6f6c 203d 2046 616c 7365 2c0a  : bool = False,.
+000408f0: 2020 2020 2020 2020 7265 6d6f 7665 3a20          remove: 
+00040900: 626f 6f6c 203d 2054 7275 652c 0a20 2020  bool = True,.   
+00040910: 2020 2020 2073 7469 6d75 6c75 735f 6964       stimulus_id
+00040920: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+00040930: 6f6e 652c 0a20 2020 2029 202d 3e20 6469  one,.    ) -> di
+00040940: 6374 5b73 7472 2c20 416e 795d 3a0a 2020  ct[str, Any]:.  
+00040950: 2020 2020 2020 2e2e 2e0a 0a20 2020 2040        .....    @
+00040960: 6f76 6572 6c6f 6164 0a20 2020 2061 7379  overload.    asy
+00040970: 6e63 2064 6566 2072 6574 6972 655f 776f  nc def retire_wo
+00040980: 726b 6572 7328 0a20 2020 2020 2020 2073  rkers(.        s
+00040990: 656c 662c 0a20 2020 2020 2020 202a 2c0a  elf,.        *,.
+000409a0: 2020 2020 2020 2020 636c 6f73 655f 776f          close_wo
+000409b0: 726b 6572 733a 2062 6f6f 6c20 3d20 4661  rkers: bool = Fa
+000409c0: 6c73 652c 0a20 2020 2020 2020 2072 656d  lse,.        rem
+000409d0: 6f76 653a 2062 6f6f 6c20 3d20 5472 7565  ove: bool = True
+000409e0: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
+000409f0: 7573 5f69 643a 2073 7472 207c 204e 6f6e  us_id: str | Non
+00040a00: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00040a10: 2020 2320 5061 7261 6d65 7465 7273 2066    # Parameters f
+00040a20: 6f72 2077 6f72 6b65 7273 5f74 6f5f 636c  or workers_to_cl
+00040a30: 6f73 6528 290a 2020 2020 2020 2020 6d65  ose().        me
+00040a40: 6d6f 7279 5f72 6174 696f 3a20 696e 7420  mory_ratio: int 
+00040a50: 7c20 666c 6f61 7420 7c20 4e6f 6e65 203d  | float | None =
+00040a60: 204e 6f6e 652c 0a20 2020 2020 2020 206e   None,.        n
+00040a70: 3a20 696e 7420 7c20 4e6f 6e65 203d 204e  : int | None = N
+00040a80: 6f6e 652c 0a20 2020 2020 2020 206b 6579  one,.        key
+00040a90: 3a20 4361 6c6c 6162 6c65 5b5b 576f 726b  : Callable[[Work
+00040aa0: 6572 5374 6174 655d 2c20 4861 7368 6162  erState], Hashab
+00040ab0: 6c65 5d20 7c20 6279 7465 7320 7c20 4e6f  le] | bytes | No
+00040ac0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
+00040ad0: 2020 206d 696e 696d 756d 3a20 696e 7420     minimum: int 
+00040ae0: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a20  | None = None,. 
+00040af0: 2020 2020 2020 2074 6172 6765 743a 2069         target: i
+00040b00: 6e74 207c 204e 6f6e 6520 3d20 4e6f 6e65  nt | None = None
+00040b10: 2c0a 2020 2020 2020 2020 6174 7472 6962  ,.        attrib
+00040b20: 7574 653a 2073 7472 203d 2022 6164 6472  ute: str = "addr
+00040b30: 6573 7322 2c0a 2020 2020 2920 2d3e 2064  ess",.    ) -> d
+00040b40: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
+00040b50: 2020 2020 2020 202e 2e2e 0a0a 2020 2020         .....    
+00040b60: 406c 6f67 5f65 7272 6f72 730a 2020 2020  @log_errors.    
+00040b70: 6173 796e 6320 6465 6620 7265 7469 7265  async def retire
+00040b80: 5f77 6f72 6b65 7273 280a 2020 2020 2020  _workers(.      
+00040b90: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+00040ba0: 776f 726b 6572 733a 206c 6973 745b 7374  workers: list[st
+00040bb0: 725d 207c 204e 6f6e 6520 3d20 4e6f 6e65  r] | None = None
+00040bc0: 2c0a 2020 2020 2020 2020 2a2c 0a20 2020  ,.        *,.   
+00040bd0: 2020 2020 206e 616d 6573 3a20 6c69 7374       names: list
+00040be0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+00040bf0: 2020 2020 2020 2020 636c 6f73 655f 776f          close_wo
+00040c00: 726b 6572 733a 2062 6f6f 6c20 3d20 4661  rkers: bool = Fa
+00040c10: 6c73 652c 0a20 2020 2020 2020 2072 656d  lse,.        rem
+00040c20: 6f76 653a 2062 6f6f 6c20 3d20 5472 7565  ove: bool = True
+00040c30: 2c0a 2020 2020 2020 2020 7374 696d 756c  ,.        stimul
+00040c40: 7573 5f69 643a 2073 7472 207c 204e 6f6e  us_id: str | Non
+00040c50: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+00040c60: 2020 2a2a 6b77 6172 6773 3a20 416e 792c    **kwargs: Any,
+00040c70: 0a20 2020 2029 202d 3e20 6469 6374 5b73  .    ) -> dict[s
+00040c80: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
+00040c90: 2020 2222 2247 7261 6365 6675 6c6c 7920    """Gracefully 
+00040ca0: 7265 7469 7265 2077 6f72 6b65 7273 2066  retire workers f
+00040cb0: 726f 6d20 636c 7573 7465 722e 2041 6e79  rom cluster. Any
+00040cc0: 206b 6579 2074 6861 7420 6973 2069 6e20   key that is in 
+00040cd0: 6d65 6d6f 7279 2065 7863 6c75 7369 7665  memory exclusive
+00040ce0: 6c79 0a20 2020 2020 2020 206f 6e20 7468  ly.        on th
+00040cf0: 6520 7265 7469 7265 6420 776f 726b 6572  e retired worker
+00040d00: 7320 6973 2072 6570 6c69 6361 7465 6420  s is replicated 
+00040d10: 736f 6d65 7768 6572 6520 656c 7365 2e0a  somewhere else..
+00040d20: 0a20 2020 2020 2020 2050 6172 616d 6574  .        Paramet
+00040d30: 6572 730a 2020 2020 2020 2020 2d2d 2d2d  ers.        ----
+00040d40: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2077  ------.        w
+00040d50: 6f72 6b65 7273 3a20 6c69 7374 5b73 7472  orkers: list[str
+00040d60: 5d20 286f 7074 696f 6e61 6c29 0a20 2020  ] (optional).   
+00040d70: 2020 2020 2020 2020 204c 6973 7420 6f66           List of
+00040d80: 2077 6f72 6b65 7220 6164 6472 6573 7365   worker addresse
+00040d90: 7320 746f 2072 6574 6972 652e 0a20 2020  s to retire..   
+00040da0: 2020 2020 206e 616d 6573 3a20 6c69 7374       names: list
+00040db0: 2028 6f70 7469 6f6e 616c 290a 2020 2020   (optional).    
+00040dc0: 2020 2020 2020 2020 4c69 7374 206f 6620          List of 
+00040dd0: 776f 726b 6572 206e 616d 6573 2074 6f20  worker names to 
+00040de0: 7265 7469 7265 2e0a 2020 2020 2020 2020  retire..        
+00040df0: 2020 2020 4d75 7475 616c 6c79 2065 7863      Mutually exc
+00040e00: 6c75 7369 7665 2077 6974 6820 6060 776f  lusive with ``wo
+00040e10: 726b 6572 7360 602e 0a20 2020 2020 2020  rkers``..       
+00040e20: 2020 2020 2049 6620 6e65 6974 6865 7220       If neither 
+00040e30: 6060 776f 726b 6572 7360 6020 6e6f 7220  ``workers`` nor 
+00040e40: 6060 6e61 6d65 7360 6020 6172 6520 7072  ``names`` are pr
+00040e50: 6f76 6964 6564 2c20 7765 2063 616c 6c0a  ovided, we call.
+00040e60: 2020 2020 2020 2020 2020 2020 6060 776f              ``wo
+00040e70: 726b 6572 735f 746f 5f63 6c6f 7365 6060  rkers_to_close``
+00040e80: 2077 6869 6368 2066 696e 6473 2061 2067   which finds a g
+00040e90: 6f6f 6420 7365 742e 0a20 2020 2020 2020  ood set..       
+00040ea0: 2063 6c6f 7365 5f77 6f72 6b65 7273 3a20   close_workers: 
+00040eb0: 626f 6f6c 2028 6465 6661 756c 7473 2074  bool (defaults t
+00040ec0: 6f20 4661 6c73 6529 0a20 2020 2020 2020  o False).       
+00040ed0: 2020 2020 2057 6865 7468 6572 2074 6f20       Whether to 
+00040ee0: 6163 7475 616c 6c79 2063 6c6f 7365 2074  actually close t
+00040ef0: 6865 2077 6f72 6b65 7220 6578 706c 6963  he worker explic
+00040f00: 6974 6c79 2066 726f 6d20 6865 7265 2e0a  itly from here..
+00040f10: 2020 2020 2020 2020 2020 2020 4f74 6865              Othe
+00040f20: 7277 6973 652c 2077 6520 6578 7065 6374  rwise, we expect
+00040f30: 2073 6f6d 6520 6578 7465 726e 616c 206a   some external j
+00040f40: 6f62 2073 6368 6564 756c 6572 2074 6f20  ob scheduler to 
+00040f50: 6669 6e69 7368 206f 6666 2074 6865 2077  finish off the w
+00040f60: 6f72 6b65 722e 0a20 2020 2020 2020 2072  orker..        r
+00040f70: 656d 6f76 653a 2062 6f6f 6c20 2864 6566  emove: bool (def
+00040f80: 6175 6c74 7320 746f 2054 7275 6529 0a20  aults to True). 
+00040f90: 2020 2020 2020 2020 2020 2057 6865 7468             Wheth
+00040fa0: 6572 2074 6f20 7265 6d6f 7665 2074 6865  er to remove the
+00040fb0: 2077 6f72 6b65 7220 6d65 7461 6461 7461   worker metadata
+00040fc0: 2069 6d6d 6564 6961 7465 6c79 206f 7220   immediately or 
+00040fd0: 656c 7365 2077 6169 7420 666f 7220 7468  else wait for th
+00040fe0: 650a 2020 2020 2020 2020 2020 2020 776f  e.            wo
+00040ff0: 726b 6572 2074 6f20 636f 6e74 6163 7420  rker to contact 
+00041000: 7573 2e0a 0a20 2020 2020 2020 2020 2020  us...           
+00041010: 2049 6620 636c 6f73 655f 776f 726b 6572   If close_worker
+00041020: 733d 4661 6c73 6520 616e 6420 7265 6d6f  s=False and remo
+00041030: 7665 3d46 616c 7365 2c20 7468 6973 206d  ve=False, this m
+00041040: 6574 686f 6420 6a75 7374 2066 6c75 7368  ethod just flush
+00041050: 6573 2074 6865 2074 6173 6b73 0a20 2020  es the tasks.   
+00041060: 2020 2020 2020 2020 2069 6e20 6d65 6d6f           in memo
+00041070: 7279 206f 7574 206f 6620 7468 6520 776f  ry out of the wo
+00041080: 726b 6572 7320 616e 6420 7468 656e 2072  rkers and then r
+00041090: 6574 7572 6e73 2e0a 2020 2020 2020 2020  eturns..        
+000410a0: 2020 2020 4966 2063 6c6f 7365 5f77 6f72      If close_wor
+000410b0: 6b65 7273 3d54 7275 6520 616e 6420 7265  kers=True and re
+000410c0: 6d6f 7665 3d46 616c 7365 2c20 7468 6973  move=False, this
+000410d0: 206d 6574 686f 6420 7769 6c6c 2072 6574   method will ret
+000410e0: 7572 6e20 7768 696c 6520 7468 650a 2020  urn while the.  
+000410f0: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00041100: 7320 6172 6520 7374 696c 6c20 696e 2074  s are still in t
+00041110: 6865 2063 6c75 7374 6572 2c20 616c 7468  he cluster, alth
+00041120: 6f75 6768 2074 6865 7920 776f 6e27 7420  ough they won't 
+00041130: 6163 6365 7074 206e 6577 2074 6173 6b73  accept new tasks
+00041140: 2e0a 2020 2020 2020 2020 2020 2020 4966  ..            If
+00041150: 2063 6c6f 7365 5f77 6f72 6b65 7273 3d46   close_workers=F
+00041160: 616c 7365 206f 7220 666f 7220 7768 6174  alse or for what
+00041170: 6576 6572 2072 6561 736f 6e20 6120 776f  ever reason a wo
+00041180: 726b 6572 2064 6f65 736e 2774 2061 6363  rker doesn't acc
+00041190: 6570 7420 7468 650a 2020 2020 2020 2020  ept the.        
+000411a0: 2020 2020 636c 6f73 6520 636f 6d6d 616e      close comman
+000411b0: 642c 2069 7420 7769 6c6c 2062 6520 6c65  d, it will be le
+000411c0: 6674 2070 6572 6d61 6e65 6e74 6c79 2075  ft permanently u
+000411d0: 6e61 626c 6520 746f 2061 6363 6570 7420  nable to accept 
+000411e0: 6e65 7720 7461 736b 7320 616e 640a 2020  new tasks and.  
+000411f0: 2020 2020 2020 2020 2020 6974 2069 7320            it is 
+00041200: 6578 7065 6374 6564 2074 6f20 6265 2063  expected to be c
+00041210: 6c6f 7365 6420 696e 2073 6f6d 6520 6f74  losed in some ot
+00041220: 6865 7220 7761 792e 0a0a 2020 2020 2020  her way...      
+00041230: 2020 2a2a 6b77 6172 6773 3a20 6469 6374    **kwargs: dict
+00041240: 0a20 2020 2020 2020 2020 2020 2045 7874  .            Ext
+00041250: 7261 206f 7074 696f 6e73 2074 6f20 7061  ra options to pa
+00041260: 7373 2074 6f20 776f 726b 6572 735f 746f  ss to workers_to
+00041270: 5f63 6c6f 7365 2074 6f20 6465 7465 726d  _close to determ
+00041280: 696e 6520 7768 6963 680a 2020 2020 2020  ine which.      
+00041290: 2020 2020 2020 776f 726b 6572 7320 7765        workers we
+000412a0: 2073 686f 756c 6420 6472 6f70 2e20 4f6e   should drop. On
+000412b0: 6c79 2061 6363 6570 7465 6420 6966 2060  ly accepted if `
+000412c0: 6077 6f72 6b65 7273 6060 2061 6e64 2060  `workers`` and `
+000412d0: 606e 616d 6573 6060 2061 7265 0a20 2020  `names`` are.   
+000412e0: 2020 2020 2020 2020 206f 6d69 7474 6564           omitted
+000412f0: 2e0a 0a20 2020 2020 2020 2052 6574 7572  ...        Retur
+00041300: 6e73 0a20 2020 2020 2020 202d 2d2d 2d2d  ns.        -----
+00041310: 2d2d 0a20 2020 2020 2020 2044 6963 7469  --.        Dicti
+00041320: 6f6e 6172 7920 6d61 7070 696e 6720 776f  onary mapping wo
+00041330: 726b 6572 2049 442f 6164 6472 6573 7320  rker ID/address 
+00041340: 746f 2064 6963 7469 6f6e 6172 7920 6f66  to dictionary of
+00041350: 2069 6e66 6f72 6d61 7469 6f6e 2061 626f   information abo
+00041360: 7574 0a20 2020 2020 2020 2074 6861 7420  ut.        that 
+00041370: 776f 726b 6572 2066 6f72 2065 6163 6820  worker for each 
+00041380: 7265 7469 7265 6420 776f 726b 6572 2e0a  retired worker..
+00041390: 0a20 2020 2020 2020 2049 6620 7468 6572  .        If ther
+000413a0: 6520 6172 6520 6b65 7973 2074 6861 7420  e are keys that 
+000413b0: 6578 6973 7420 696e 206d 656d 6f72 7920  exist in memory 
+000413c0: 6f6e 6c79 206f 6e20 7468 6520 776f 726b  only on the work
+000413d0: 6572 7320 6265 696e 6720 7265 7469 7265  ers being retire
+000413e0: 6420 616e 6420 6974 0a20 2020 2020 2020  d and it.       
+000413f0: 2077 6173 2069 6d70 6f73 7369 626c 6520   was impossible 
+00041400: 746f 2072 6570 6c69 6361 7465 2074 6865  to replicate the
+00041410: 6d20 736f 6d65 7768 6572 6520 656c 7365  m somewhere else
+00041420: 2028 652e 672e 2062 6563 6175 7365 2074   (e.g. because t
+00041430: 6865 7265 2061 7265 6e27 740a 2020 2020  here aren't.    
+00041440: 2020 2020 616e 7920 6f74 6865 7220 7275      any other ru
+00041450: 6e6e 696e 6720 776f 726b 6572 7329 2c20  nning workers), 
+00041460: 7468 6520 776f 726b 6572 7320 686f 6c64  the workers hold
+00041470: 696e 6720 7375 6368 206b 6579 7320 776f  ing such keys wo
+00041480: 6e27 7420 6265 2072 6574 6972 6564 2061  n't be retired a
+00041490: 6e64 0a20 2020 2020 2020 2077 6f6e 2774  nd.        won't
+000414a0: 2061 7070 6561 7220 696e 2074 6865 2072   appear in the r
+000414b0: 6574 7572 6e65 6420 6469 6374 2e0a 0a20  eturned dict... 
+000414c0: 2020 2020 2020 2053 6565 2041 6c73 6f0a         See Also.
+000414d0: 2020 2020 2020 2020 2d2d 2d2d 2d2d 2d2d          --------
+000414e0: 0a20 2020 2020 2020 2053 6368 6564 756c  .        Schedul
+000414f0: 6572 2e77 6f72 6b65 7273 5f74 6f5f 636c  er.workers_to_cl
+00041500: 6f73 650a 2020 2020 2020 2020 2222 220a  ose.        """.
+00041510: 2020 2020 2020 2020 6966 206e 616d 6573          if names
+00041520: 2069 7320 6e6f 7420 4e6f 6e65 2061 6e64   is not None and
+00041530: 2077 6f72 6b65 7273 2069 7320 6e6f 7420   workers is not 
+00041540: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+00041550: 2020 7261 6973 6520 5479 7065 4572 726f    raise TypeErro
+00041560: 7228 226e 616d 6573 2061 6e64 2077 6f72  r("names and wor
+00041570: 6b65 7273 2061 7265 206d 7574 7561 6c6c  kers are mutuall
+00041580: 7920 6578 636c 7573 6976 6522 290a 2020  y exclusive").  
+00041590: 2020 2020 2020 6966 2028 6e61 6d65 7320        if (names 
+000415a0: 6973 206e 6f74 204e 6f6e 6520 6f72 2077  is not None or w
+000415b0: 6f72 6b65 7273 2069 7320 6e6f 7420 4e6f  orkers is not No
+000415c0: 6e65 2920 616e 6420 6b77 6172 6773 3a0a  ne) and kwargs:.
+000415d0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000415e0: 6520 5479 7065 4572 726f 7228 0a20 2020  e TypeError(.   
+000415f0: 2020 2020 2020 2020 2020 2020 2022 5061               "Pa
+00041600: 7261 6d65 7465 7273 2066 6f72 2077 6f72  rameters for wor
+00041610: 6b65 7273 5f74 6f5f 636c 6f73 6528 2920  kers_to_close() 
+00041620: 6172 6520 6d75 7475 616c 6c79 2065 7863  are mutually exc
+00041630: 6c75 7369 7665 2077 6974 6820 220a 2020  lusive with ".  
+00041640: 2020 2020 2020 2020 2020 2020 2020 6622                f"
+00041650: 6e61 6d65 7320 616e 6420 776f 726b 6572  names and worker
+00041660: 733a 207b 6b77 6172 6773 7d22 0a20 2020  s: {kwargs}".   
+00041670: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00041680: 2020 2020 7374 696d 756c 7573 5f69 6420      stimulus_id 
+00041690: 3d20 7374 696d 756c 7573 5f69 6420 6f72  = stimulus_id or
+000416a0: 2066 2272 6574 6972 652d 776f 726b 6572   f"retire-worker
+000416b0: 732d 7b74 696d 6528 297d 220a 2020 2020  s-{time()}".    
+000416c0: 2020 2020 2320 5468 6973 206c 6f63 6b20      # This lock 
+000416d0: 6d61 6b65 7320 7265 7469 7265 5f77 6f72  makes retire_wor
+000416e0: 6b65 7273 2c20 7265 6261 6c61 6e63 652c  kers, rebalance,
+000416f0: 2061 6e64 2072 6570 6c69 6361 7465 206d   and replicate m
+00041700: 7574 7561 6c6c 790a 2020 2020 2020 2020  utually.        
+00041710: 2320 6578 636c 7573 6976 6520 616e 6420  # exclusive and 
+00041720: 7769 6c6c 206e 6f20 6c6f 6e67 6572 2062  will no longer b
+00041730: 6520 6e65 6365 7373 6172 7920 6f6e 6365  e necessary once
+00041740: 2072 6562 616c 616e 6365 2061 6e64 2072   rebalance and r
+00041750: 6570 6c69 6361 7465 2061 7265 0a20 2020  eplicate are.   
+00041760: 2020 2020 2023 206d 6967 7261 7465 6420       # migrated 
+00041770: 746f 2074 6865 2041 6374 6976 6520 4d65  to the Active Me
+00041780: 6d6f 7279 204d 616e 6167 6572 2e0a 2020  mory Manager..  
+00041790: 2020 2020 2020 2320 486f 7765 7665 722c        # However,
+000417a0: 2069 7420 616c 6c6f 7773 206d 756c 7469   it allows multi
+000417b0: 706c 6520 696e 7374 616e 6365 7320 6f66  ple instances of
+000417c0: 2072 6574 6972 655f 776f 726b 6572 7320   retire_workers 
+000417d0: 746f 2072 756e 2069 6e20 7061 7261 6c6c  to run in parall
+000417e0: 656c 2e0a 2020 2020 2020 2020 6173 796e  el..        asyn
+000417f0: 6320 7769 7468 2073 656c 662e 5f72 6570  c with self._rep
+00041800: 6c69 6361 5f6c 6f63 6b28 2272 6574 6972  lica_lock("retir
+00041810: 652d 776f 726b 6572 7322 293a 0a20 2020  e-workers"):.   
+00041820: 2020 2020 2020 2020 2069 6620 6e61 6d65           if name
+00041830: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+00041840: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00041850: 6f67 6765 722e 696e 666f 2822 5265 7469  ogger.info("Reti
+00041860: 7265 2077 6f72 6b65 7220 6e61 6d65 7320  re worker names 
+00041870: 2573 222c 206e 616d 6573 290a 2020 2020  %s", names).    
+00041880: 2020 2020 2020 2020 2020 2020 2320 5375              # Su
+00041890: 7070 6f72 7420 6361 7365 7320 7768 6572  pport cases wher
+000418a0: 6520 6e61 6d65 7320 6172 6520 7061 7373  e names are pass
+000418b0: 6564 2074 6872 6f75 6768 2061 2043 4c49  ed through a CLI
+000418c0: 2061 6e64 2062 6563 6f6d 6520 7374 7269   and become stri
+000418d0: 6e67 730a 2020 2020 2020 2020 2020 2020  ngs.            
+000418e0: 2020 2020 6e61 6d65 735f 7365 7420 3d20      names_set = 
+000418f0: 7b73 7472 286e 616d 6529 2066 6f72 206e  {str(name) for n
+00041900: 616d 6520 696e 206e 616d 6573 7d0a 2020  ame in names}.  
+00041910: 2020 2020 2020 2020 2020 2020 2020 7773                ws
+00041920: 7320 3d20 7b77 7320 666f 7220 7773 2069  s = {ws for ws i
+00041930: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
+00041940: 616c 7565 7328 2920 6966 2073 7472 2877  alues() if str(w
+00041950: 732e 6e61 6d65 2920 696e 206e 616d 6573  s.name) in names
+00041960: 5f73 6574 7d0a 2020 2020 2020 2020 2020  _set}.          
+00041970: 2020 656c 6966 2077 6f72 6b65 7273 2069    elif workers i
+00041980: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+00041990: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
+000419a0: 6572 2e69 6e66 6f28 2252 6574 6972 6520  er.info("Retire 
+000419b0: 776f 726b 6572 2061 6464 7265 7373 6573  worker addresses
+000419c0: 2025 7322 2c20 776f 726b 6572 7329 0a20   %s", workers). 
+000419d0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+000419e0: 7373 203d 207b 0a20 2020 2020 2020 2020  ss = {.         
+000419f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00041a00: 776f 726b 6572 735b 6164 6472 6573 735d  workers[address]
+00041a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041a20: 2020 2020 2066 6f72 2061 6464 7265 7373       for address
+00041a30: 2069 6e20 776f 726b 6572 730a 2020 2020   in workers.    
+00041a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041a50: 6966 2061 6464 7265 7373 2069 6e20 7365  if address in se
+00041a60: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
+00041a70: 2020 2020 2020 2020 2020 207d 0a20 2020             }.   
+00041a80: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00041a90: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00041aa0: 7373 203d 207b 0a20 2020 2020 2020 2020  ss = {.         
+00041ab0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00041ac0: 776f 726b 6572 735b 6164 6472 6573 735d  workers[address]
+00041ad0: 2066 6f72 2061 6464 7265 7373 2069 6e20   for address in 
+00041ae0: 7365 6c66 2e77 6f72 6b65 7273 5f74 6f5f  self.workers_to_
+00041af0: 636c 6f73 6528 2a2a 6b77 6172 6773 290a  close(**kwargs).
+00041b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041b10: 7d0a 2020 2020 2020 2020 2020 2020 6966  }.            if
+00041b20: 206e 6f74 2077 7373 3a0a 2020 2020 2020   not wss:.      
+00041b30: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00041b40: 207b 7d0a 0a20 2020 2020 2020 2020 2020   {}..           
+00041b50: 2073 746f 705f 616d 6d20 3d20 4661 6c73   stop_amm = Fals
+00041b60: 650a 2020 2020 2020 2020 2020 2020 616d  e.            am
+00041b70: 6d3a 2041 6374 6976 654d 656d 6f72 794d  m: ActiveMemoryM
+00041b80: 616e 6167 6572 4578 7465 6e73 696f 6e20  anagerExtension 
+00041b90: 7c20 4e6f 6e65 203d 2073 656c 662e 6578  | None = self.ex
+00041ba0: 7465 6e73 696f 6e73 2e67 6574 2822 616d  tensions.get("am
+00041bb0: 6d22 290a 2020 2020 2020 2020 2020 2020  m").            
+00041bc0: 6966 206e 6f74 2061 6d6d 206f 7220 6e6f  if not amm or no
+00041bd0: 7420 616d 6d2e 7275 6e6e 696e 673a 0a20  t amm.running:. 
+00041be0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00041bf0: 6d6d 203d 2041 6374 6976 654d 656d 6f72  mm = ActiveMemor
+00041c00: 794d 616e 6167 6572 4578 7465 6e73 696f  yManagerExtensio
+00041c10: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
+00041c20: 2020 2020 2020 2073 656c 662c 2070 6f6c         self, pol
+00041c30: 6963 6965 733d 7365 7428 292c 2072 6567  icies=set(), reg
+00041c40: 6973 7465 723d 4661 6c73 652c 2073 7461  ister=False, sta
+00041c50: 7274 3d54 7275 652c 2069 6e74 6572 7661  rt=True, interva
+00041c60: 6c3d 322e 300a 2020 2020 2020 2020 2020  l=2.0.          
+00041c70: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00041c80: 2020 2020 2020 2020 7374 6f70 5f61 6d6d          stop_amm
+00041c90: 203d 2054 7275 650a 0a20 2020 2020 2020   = True..       
+00041ca0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00041cb0: 2020 2020 2020 2020 2020 636f 726f 7320            coros 
+00041cc0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+00041cd0: 2020 2020 2066 6f72 2077 7320 696e 2077       for ws in w
+00041ce0: 7373 3a0a 2020 2020 2020 2020 2020 2020  ss:.            
+00041cf0: 2020 2020 2020 2020 6c6f 6767 6572 2e69          logger.i
+00041d00: 6e66 6f28 6622 5265 7469 7269 6e67 2077  nfo(f"Retiring w
+00041d10: 6f72 6b65 7220 7b77 732e 6164 6472 6573  orker {ws.addres
+00041d20: 7321 727d 2028 7b73 7469 6d75 6c75 735f  s!r} ({stimulus_
+00041d30: 6964 3d21 727d 2922 290a 0a20 2020 2020  id=!r})")..     
+00041d40: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00041d50: 6f6c 6963 7920 3d20 5265 7469 7265 576f  olicy = RetireWo
+00041d60: 726b 6572 2877 732e 6164 6472 6573 7329  rker(ws.address)
+00041d70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00041d80: 2020 2020 2061 6d6d 2e61 6464 5f70 6f6c       amm.add_pol
+00041d90: 6963 7928 706f 6c69 6379 290a 0a20 2020  icy(policy)..   
+00041da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041db0: 2023 2043 6861 6e67 6520 576f 726b 6572   # Change Worker
+00041dc0: 2e73 7461 7475 7320 746f 2063 6c6f 7369  .status to closi
+00041dd0: 6e67 5f67 7261 6365 6675 6c6c 792e 2049  ng_gracefully. I
+00041de0: 6d6d 6564 6961 7465 6c79 2073 6574 0a20  mmediately set. 
+00041df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041e00: 2020 2023 2074 6865 2073 616d 6520 6f6e     # the same on
+00041e10: 2074 6865 2073 6368 6564 756c 6572 2074   the scheduler t
+00041e20: 6f20 7072 6576 656e 7420 7261 6365 2063  o prevent race c
+00041e30: 6f6e 6469 7469 6f6e 732e 0a20 2020 2020  onditions..     
+00041e40: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00041e50: 7265 765f 7374 6174 7573 203d 2077 732e  rev_status = ws.
+00041e60: 7374 6174 7573 0a20 2020 2020 2020 2020  status.         
+00041e70: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00041e80: 6861 6e64 6c65 5f77 6f72 6b65 725f 7374  handle_worker_st
+00041e90: 6174 7573 5f63 6861 6e67 6528 0a20 2020  atus_change(.   
+00041ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041eb0: 2020 2020 2053 7461 7475 732e 636c 6f73       Status.clos
+00041ec0: 696e 675f 6772 6163 6566 756c 6c79 2c20  ing_gracefully, 
+00041ed0: 7773 2c20 7374 696d 756c 7573 5f69 640a  ws, stimulus_id.
+00041ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041ef0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00041f00: 2020 2020 2020 2020 2020 2320 4649 584d            # FIXM
+00041f10: 453a 2057 6520 7368 6f75 6c64 2073 656e  E: We should sen
+00041f20: 6420 6120 6d65 7373 6167 6520 746f 2074  d a message to t
+00041f30: 6865 206e 616e 6e79 2066 6972 7374 3b0a  he nanny first;.
+00041f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041f50: 2020 2020 2320 6576 656e 7475 616c 6c79      # eventually
+00041f60: 2077 6f72 6b65 7273 2077 6f6e 2774 2062   workers won't b
+00041f70: 6520 6162 6c65 2074 6f20 636c 6f73 6520  e able to close 
+00041f80: 7468 6569 7220 6f77 6e20 6e61 6e6e 6965  their own nannie
+00041f90: 732e 0a20 2020 2020 2020 2020 2020 2020  s..             
+00041fa0: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
+00041fb0: 616d 5f63 6f6d 6d73 5b77 732e 6164 6472  am_comms[ws.addr
+00041fc0: 6573 735d 2e73 656e 6428 0a20 2020 2020  ess].send(.     
+00041fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00041fe0: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+00041ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042000: 2022 6f70 223a 2022 776f 726b 6572 2d73   "op": "worker-s
+00042010: 7461 7475 732d 6368 616e 6765 222c 0a20  tatus-change",. 
+00042020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042030: 2020 2020 2020 2020 2020 2022 7374 6174             "stat
+00042040: 7573 223a 2077 732e 7374 6174 7573 2e6e  us": ws.status.n
+00042050: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
+00042060: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042070: 2022 7374 696d 756c 7573 5f69 6422 3a20   "stimulus_id": 
+00042080: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+00042090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000420a0: 2020 2020 207d 0a20 2020 2020 2020 2020       }.         
+000420b0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+000420c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000420d0: 2020 636f 726f 732e 6170 7065 6e64 280a    coros.append(.
+000420e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000420f0: 2020 2020 2020 2020 7365 6c66 2e5f 7472          self._tr
+00042100: 6163 6b5f 7265 7469 7265 5f77 6f72 6b65  ack_retire_worke
+00042110: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00042120: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00042130: 732c 0a20 2020 2020 2020 2020 2020 2020  s,.             
+00042140: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00042150: 6f6c 6963 792c 0a20 2020 2020 2020 2020  olicy,.         
+00042160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042170: 2020 2070 7265 765f 7374 6174 7573 3d70     prev_status=p
+00042180: 7265 765f 7374 6174 7573 2c0a 2020 2020  rev_status,.    
+00042190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000421a0: 2020 2020 2020 2020 636c 6f73 653d 636c          close=cl
+000421b0: 6f73 655f 776f 726b 6572 732c 0a20 2020  ose_workers,.   
+000421c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000421d0: 2020 2020 2020 2020 2072 656d 6f76 653d           remove=
+000421e0: 7265 6d6f 7665 2c0a 2020 2020 2020 2020  remove,.        
+000421f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042200: 2020 2020 7374 696d 756c 7573 5f69 643d      stimulus_id=
+00042210: 7374 696d 756c 7573 5f69 642c 0a20 2020  stimulus_id,.   
+00042220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042230: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+00042240: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+00042250: 2020 2020 2020 2020 2020 2020 2020 2320                # 
+00042260: 4769 7665 2074 6865 2041 4d4d 2061 206b  Give the AMM a k
+00042270: 6963 6b2c 2069 6e20 6164 6469 7469 6f6e  ick, in addition
+00042280: 2074 6f20 6974 7320 7065 7269 6f64 6963   to its periodic
+00042290: 2072 756e 6e69 6e67 2e20 5468 6973 2069   running. This i
+000422a0: 730a 2020 2020 2020 2020 2020 2020 2020  s.              
+000422b0: 2020 2320 746f 2061 766f 6964 2075 6e6e    # to avoid unn
+000422c0: 6563 6573 7361 7269 6c79 2077 6169 7469  ecessarily waiti
+000422d0: 6e67 2066 6f72 2061 2070 6f74 656e 7469  ng for a potenti
+000422e0: 616c 6c79 2061 7262 6974 7261 7269 6c79  ally arbitrarily
+000422f0: 206c 6f6e 670a 2020 2020 2020 2020 2020   long.          
+00042300: 2020 2020 2020 2320 7469 6d65 2028 6465        # time (de
+00042310: 7065 6e64 696e 6720 6f6e 2069 6e74 6572  pending on inter
+00042320: 7661 6c20 7365 7474 696e 6773 290a 2020  val settings).  
+00042330: 2020 2020 2020 2020 2020 2020 2020 616d                am
+00042340: 6d2e 7275 6e5f 6f6e 6365 2829 0a0a 2020  m.run_once()..  
+00042350: 2020 2020 2020 2020 2020 2020 2020 776f                wo
+00042360: 726b 6572 735f 696e 666f 5f6f 6b20 3d20  rkers_info_ok = 
+00042370: 7b7d 0a20 2020 2020 2020 2020 2020 2020  {}.             
+00042380: 2020 2077 6f72 6b65 7273 5f69 6e66 6f5f     workers_info_
+00042390: 6162 6f72 7420 3d20 7b7d 0a20 2020 2020  abort = {}.     
+000423a0: 2020 2020 2020 2020 2020 2066 6f72 2061             for a
+000423b0: 6464 722c 2072 6573 756c 742c 2069 6e66  ddr, result, inf
+000423c0: 6f20 696e 2061 7761 6974 2061 7379 6e63  o in await async
+000423d0: 696f 2e67 6174 6865 7228 2a63 6f72 6f73  io.gather(*coros
+000423e0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+000423f0: 2020 2020 2020 2069 6620 7265 7375 6c74         if result
+00042400: 203d 3d20 224f 4b22 3a0a 2020 2020 2020   == "OK":.      
+00042410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042420: 2020 776f 726b 6572 735f 696e 666f 5f6f    workers_info_o
+00042430: 6b5b 6164 6472 5d20 3d20 696e 666f 0a20  k[addr] = info. 
+00042440: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042450: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00042460: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00042470: 2077 6f72 6b65 7273 5f69 6e66 6f5f 6162   workers_info_ab
+00042480: 6f72 745b 6164 6472 5d20 3d20 696e 666f  ort[addr] = info
+00042490: 0a0a 2020 2020 2020 2020 2020 2020 6669  ..            fi
+000424a0: 6e61 6c6c 793a 0a20 2020 2020 2020 2020  nally:.         
+000424b0: 2020 2020 2020 2069 6620 7374 6f70 5f61         if stop_a
+000424c0: 6d6d 3a0a 2020 2020 2020 2020 2020 2020  mm:.            
+000424d0: 2020 2020 2020 2020 616d 6d2e 7374 6f70          amm.stop
+000424e0: 2829 0a0a 2020 2020 2020 2020 7365 6c66  ()..        self
+000424f0: 2e6c 6f67 5f65 7665 6e74 280a 2020 2020  .log_event(.    
+00042500: 2020 2020 2020 2020 2261 6c6c 222c 0a20          "all",. 
+00042510: 2020 2020 2020 2020 2020 207b 0a20 2020             {.   
+00042520: 2020 2020 2020 2020 2020 2020 2022 6163               "ac
+00042530: 7469 6f6e 223a 2022 7265 7469 7265 2d77  tion": "retire-w
+00042540: 6f72 6b65 7273 222c 0a20 2020 2020 2020  orkers",.       
+00042550: 2020 2020 2020 2020 2022 7265 7469 7265           "retire
+00042560: 6422 3a20 776f 726b 6572 735f 696e 666f  d": workers_info
+00042570: 5f6f 6b2c 0a20 2020 2020 2020 2020 2020  _ok,.           
+00042580: 2020 2020 2022 636f 756c 642d 6e6f 742d       "could-not-
+00042590: 7265 7469 7265 223a 2077 6f72 6b65 7273  retire": workers
+000425a0: 5f69 6e66 6f5f 6162 6f72 742c 0a20 2020  _info_abort,.   
+000425b0: 2020 2020 2020 2020 2020 2020 2022 7374               "st
+000425c0: 696d 756c 7573 5f69 6422 3a20 7374 696d  imulus_id": stim
+000425d0: 756c 7573 5f69 642c 0a20 2020 2020 2020  ulus_id,.       
+000425e0: 2020 2020 207d 2c0a 2020 2020 2020 2020       },.        
+000425f0: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
+00042600: 6f67 5f65 7665 6e74 280a 2020 2020 2020  og_event(.      
+00042610: 2020 2020 2020 6c69 7374 2877 6f72 6b65        list(worke
+00042620: 7273 5f69 6e66 6f5f 6f6b 292c 0a20 2020  rs_info_ok),.   
+00042630: 2020 2020 2020 2020 207b 2261 6374 696f           {"actio
+00042640: 6e22 3a20 2272 6574 6972 6564 222c 2022  n": "retired", "
+00042650: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
+00042660: 696d 756c 7573 5f69 647d 2c0a 2020 2020  imulus_id},.    
+00042670: 2020 2020 290a 2020 2020 2020 2020 7365      ).        se
+00042680: 6c66 2e6c 6f67 5f65 7665 6e74 280a 2020  lf.log_event(.  
+00042690: 2020 2020 2020 2020 2020 6c69 7374 2877            list(w
+000426a0: 6f72 6b65 7273 5f69 6e66 6f5f 6162 6f72  orkers_info_abor
+000426b0: 7429 2c0a 2020 2020 2020 2020 2020 2020  t),.            
+000426c0: 7b22 6163 7469 6f6e 223a 2022 636f 756c  {"action": "coul
+000426d0: 642d 6e6f 742d 7265 7469 7265 222c 2022  d-not-retire", "
+000426e0: 7374 696d 756c 7573 5f69 6422 3a20 7374  stimulus_id": st
+000426f0: 696d 756c 7573 5f69 647d 2c0a 2020 2020  imulus_id},.    
+00042700: 2020 2020 290a 0a20 2020 2020 2020 2072      )..        r
+00042710: 6574 7572 6e20 776f 726b 6572 735f 696e  eturn workers_in
+00042720: 666f 5f6f 6b0a 0a20 2020 2061 7379 6e63  fo_ok..    async
+00042730: 2064 6566 205f 7472 6163 6b5f 7265 7469   def _track_reti
+00042740: 7265 5f77 6f72 6b65 7228 0a20 2020 2020  re_worker(.     
+00042750: 2020 2073 656c 662c 0a20 2020 2020 2020     self,.       
+00042760: 2077 733a 2057 6f72 6b65 7253 7461 7465   ws: WorkerState
+00042770: 2c0a 2020 2020 2020 2020 706f 6c69 6379  ,.        policy
+00042780: 3a20 5265 7469 7265 576f 726b 6572 2c0a  : RetireWorker,.
+00042790: 2020 2020 2020 2020 7072 6576 5f73 7461          prev_sta
+000427a0: 7475 733a 2053 7461 7475 732c 0a20 2020  tus: Status,.   
+000427b0: 2020 2020 2063 6c6f 7365 3a20 626f 6f6c       close: bool
+000427c0: 2c0a 2020 2020 2020 2020 7265 6d6f 7665  ,.        remove
+000427d0: 3a20 626f 6f6c 2c0a 2020 2020 2020 2020  : bool,.        
+000427e0: 7374 696d 756c 7573 5f69 643a 2073 7472  stimulus_id: str
+000427f0: 2c0a 2020 2020 2920 2d3e 2074 7570 6c65  ,.    ) -> tuple
+00042800: 5b73 7472 2c20 4c69 7465 7261 6c5b 224f  [str, Literal["O
+00042810: 4b22 2c20 226e 6f2d 7265 6369 7069 656e  K", "no-recipien
+00042820: 7473 225d 2c20 6469 6374 5d3a 0a20 2020  ts"], dict]:.   
+00042830: 2020 2020 2077 6869 6c65 206e 6f74 2070       while not p
+00042840: 6f6c 6963 792e 646f 6e65 2829 3a0a 2020  olicy.done():.  
+00042850: 2020 2020 2020 2020 2020 2320 536c 6565            # Slee
+00042860: 7020 302e 3031 7320 7768 656e 2074 6865  p 0.01s when the
+00042870: 7265 2061 7265 2034 2074 6173 6b73 206f  re are 4 tasks o
+00042880: 7220 6c65 7373 0a20 2020 2020 2020 2020  r less.         
+00042890: 2020 2023 2053 6c65 6570 2030 2e35 7320     # Sleep 0.5s 
+000428a0: 7768 656e 2074 6865 7265 2061 7265 2032  when there are 2
+000428b0: 3030 206f 7220 6d6f 7265 0a20 2020 2020  00 or more.     
+000428c0: 2020 2020 2020 2070 6f6c 6c5f 696e 7465         poll_inte
+000428d0: 7276 616c 203d 206d 6178 2830 2e30 312c  rval = max(0.01,
+000428e0: 206d 696e 2830 2e35 2c20 6c65 6e28 7773   min(0.5, len(ws
+000428f0: 2e68 6173 5f77 6861 7429 202f 2034 3030  .has_what) / 400
+00042900: 2929 0a20 2020 2020 2020 2020 2020 2061  )).            a
+00042910: 7761 6974 2061 7379 6e63 696f 2e73 6c65  wait asyncio.sle
+00042920: 6570 2870 6f6c 6c5f 696e 7465 7276 616c  ep(poll_interval
+00042930: 290a 0a20 2020 2020 2020 2069 6620 706f  )..        if po
+00042940: 6c69 6379 2e6e 6f5f 7265 6369 7069 656e  licy.no_recipien
+00042950: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
+00042960: 2320 4162 6f72 7420 7265 7469 7265 6d65  # Abort retireme
+00042970: 6e74 2e20 5468 6973 2074 696d 6520 7765  nt. This time we
+00042980: 2064 6f6e 2774 206e 6565 6420 746f 2077   don't need to w
+00042990: 6f72 7279 2061 626f 7574 2072 6163 650a  orry about race.
+000429a0: 2020 2020 2020 2020 2020 2020 2320 636f              # co
+000429b0: 6e64 6974 696f 6e73 2061 6e64 2077 6520  nditions and we 
+000429c0: 6361 6e20 7761 6974 2066 6f72 2061 2073  can wait for a s
+000429d0: 6368 6564 756c 6572 2d3e 776f 726b 6572  cheduler->worker
+000429e0: 2d3e 7363 6865 6475 6c65 720a 2020 2020  ->scheduler.    
+000429f0: 2020 2020 2020 2020 2320 726f 756e 642d          # round-
+00042a00: 7472 6970 2e0a 2020 2020 2020 2020 2020  trip..          
+00042a10: 2020 7365 6c66 2e73 7472 6561 6d5f 636f    self.stream_co
+00042a20: 6d6d 735b 7773 2e61 6464 7265 7373 5d2e  mms[ws.address].
+00042a30: 7365 6e64 280a 2020 2020 2020 2020 2020  send(.          
+00042a40: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+00042a50: 2020 2020 2020 2020 2020 2020 226f 7022              "op"
+00042a60: 3a20 2277 6f72 6b65 722d 7374 6174 7573  : "worker-status
+00042a70: 2d63 6861 6e67 6522 2c0a 2020 2020 2020  -change",.      
+00042a80: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00042a90: 7461 7475 7322 3a20 7072 6576 5f73 7461  tatus": prev_sta
+00042aa0: 7475 732e 6e61 6d65 2c0a 2020 2020 2020  tus.name,.      
+00042ab0: 2020 2020 2020 2020 2020 2020 2020 2273                "s
+00042ac0: 7469 6d75 6c75 735f 6964 223a 2073 7469  timulus_id": sti
+00042ad0: 6d75 6c75 735f 6964 2c0a 2020 2020 2020  mulus_id,.      
+00042ae0: 2020 2020 2020 2020 2020 7d0a 2020 2020            }.    
+00042af0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00042b00: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+00042b10: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
+00042b20: 2020 2020 2020 6622 436f 756c 6420 6e6f        f"Could no
+00042b30: 7420 7265 7469 7265 2077 6f72 6b65 7220  t retire worker 
+00042b40: 7b77 732e 6164 6472 6573 7321 727d 3a20  {ws.address!r}: 
+00042b50: 756e 6971 7565 2064 6174 6120 636f 756c  unique data coul
+00042b60: 6420 6e6f 7420 6265 2022 0a20 2020 2020  d not be ".     
+00042b70: 2020 2020 2020 2020 2020 2066 226d 6f76             f"mov
+00042b80: 6564 2074 6f20 616e 7920 6f74 6865 7220  ed to any other 
+00042b90: 776f 726b 6572 2028 7b73 7469 6d75 6c75  worker ({stimulu
+00042ba0: 735f 6964 3d21 727d 2922 0a20 2020 2020  s_id=!r})".     
+00042bb0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00042bc0: 2020 2020 2072 6574 7572 6e20 7773 2e61       return ws.a
+00042bd0: 6464 7265 7373 2c20 226e 6f2d 7265 6369  ddress, "no-reci
+00042be0: 7069 656e 7473 222c 2077 732e 6964 656e  pients", ws.iden
+00042bf0: 7469 7479 2829 0a0a 2020 2020 2020 2020  tity()..        
+00042c00: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
+00042c10: 2020 2020 2020 2020 2020 6622 416c 6c20            f"All 
+00042c20: 756e 6971 7565 206b 6579 7320 6f6e 2077  unique keys on w
+00042c30: 6f72 6b65 7220 7b77 732e 6164 6472 6573  orker {ws.addres
+00042c40: 7321 727d 2068 6176 6520 6265 656e 2072  s!r} have been r
+00042c50: 6570 6c69 6361 7465 6420 656c 7365 7768  eplicated elsewh
+00042c60: 6572 6522 0a20 2020 2020 2020 2029 0a0a  ere".        )..
+00042c70: 2020 2020 2020 2020 6966 2072 656d 6f76          if remov
+00042c80: 653a 0a20 2020 2020 2020 2020 2020 2061  e:.            a
+00042c90: 7761 6974 2073 656c 662e 7265 6d6f 7665  wait self.remove
+00042ca0: 5f77 6f72 6b65 7228 0a20 2020 2020 2020  _worker(.       
+00042cb0: 2020 2020 2020 2020 2077 732e 6164 6472           ws.addr
+00042cc0: 6573 732c 2073 6166 653d 5472 7565 2c20  ess, safe=True, 
+00042cd0: 636c 6f73 653d 636c 6f73 652c 2073 7469  close=close, sti
+00042ce0: 6d75 6c75 735f 6964 3d73 7469 6d75 6c75  mulus_id=stimulu
+00042cf0: 735f 6964 0a20 2020 2020 2020 2020 2020  s_id.           
+00042d00: 2029 0a20 2020 2020 2020 2065 6c69 6620   ).        elif 
+00042d10: 636c 6f73 653a 0a20 2020 2020 2020 2020  close:.         
+00042d20: 2020 2073 656c 662e 636c 6f73 655f 776f     self.close_wo
+00042d30: 726b 6572 2877 732e 6164 6472 6573 7329  rker(ws.address)
+00042d40: 0a0a 2020 2020 2020 2020 6c6f 6767 6572  ..        logger
+00042d50: 2e69 6e66 6f28 6622 5265 7469 7265 6420  .info(f"Retired 
+00042d60: 776f 726b 6572 207b 7773 2e61 6464 7265  worker {ws.addre
+00042d70: 7373 2172 7d20 287b 7374 696d 756c 7573  ss!r} ({stimulus
+00042d80: 5f69 643d 2172 7d29 2229 0a20 2020 2020  _id=!r})").     
+00042d90: 2020 2072 6574 7572 6e20 7773 2e61 6464     return ws.add
+00042da0: 7265 7373 2c20 224f 4b22 2c20 7773 2e69  ress, "OK", ws.i
+00042db0: 6465 6e74 6974 7928 290a 0a20 2020 2064  dentity()..    d
+00042dc0: 6566 2061 6464 5f6b 6579 7328 0a20 2020  ef add_keys(.   
+00042dd0: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
+00042de0: 723a 2073 7472 2c20 6b65 7973 3a20 436f  r: str, keys: Co
+00042df0: 6c6c 6563 7469 6f6e 5b4b 6579 5d20 3d20  llection[Key] = 
+00042e00: 2829 2c20 7374 696d 756c 7573 5f69 643a  (), stimulus_id:
+00042e10: 2073 7472 207c 204e 6f6e 6520 3d20 4e6f   str | None = No
+00042e20: 6e65 0a20 2020 2029 202d 3e20 4c69 7465  ne.    ) -> Lite
+00042e30: 7261 6c5b 224f 4b22 2c20 226e 6f74 2066  ral["OK", "not f
+00042e40: 6f75 6e64 225d 3a0a 2020 2020 2020 2020  ound"]:.        
+00042e50: 2222 220a 2020 2020 2020 2020 4c65 6172  """.        Lear
+00042e60: 6e20 7468 6174 2061 2077 6f72 6b65 7220  n that a worker 
+00042e70: 6861 7320 6365 7274 6169 6e20 6b65 7973  has certain keys
+00042e80: 0a0a 2020 2020 2020 2020 5468 6973 2073  ..        This s
+00042e90: 686f 756c 6420 6e6f 7420 6265 2075 7365  hould not be use
+00042ea0: 6420 696e 2070 7261 6374 6963 6520 616e  d in practice an
+00042eb0: 6420 6973 206d 6f73 746c 7920 6865 7265  d is mostly here
+00042ec0: 2066 6f72 206c 6567 6163 790a 2020 2020   for legacy.    
+00042ed0: 2020 2020 7265 6173 6f6e 732e 2020 486f      reasons.  Ho
+00042ee0: 7765 7665 722c 2069 7420 6973 2073 656e  wever, it is sen
+00042ef0: 7420 6279 2077 6f72 6b65 7273 2066 726f  t by workers fro
+00042f00: 6d20 7469 6d65 2074 6f20 7469 6d65 2e0a  m time to time..
+00042f10: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00042f20: 2020 2020 6966 2077 6f72 6b65 7220 6e6f      if worker no
+00042f30: 7420 696e 2073 656c 662e 776f 726b 6572  t in self.worker
+00042f40: 733a 0a20 2020 2020 2020 2020 2020 2072  s:.            r
+00042f50: 6574 7572 6e20 226e 6f74 2066 6f75 6e64  eturn "not found
+00042f60: 220a 2020 2020 2020 2020 7773 203d 2073  ".        ws = s
+00042f70: 656c 662e 776f 726b 6572 735b 776f 726b  elf.workers[work
+00042f80: 6572 5d0a 2020 2020 2020 2020 7265 6475  er].        redu
+00042f90: 6e64 616e 745f 7265 706c 6963 6173 203d  ndant_replicas =
+00042fa0: 205b 5d0a 2020 2020 2020 2020 666f 7220   [].        for 
+00042fb0: 6b65 7920 696e 206b 6579 733a 0a20 2020  key in keys:.   
+00042fc0: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
+00042fd0: 6c66 2e74 6173 6b73 2e67 6574 286b 6579  lf.tasks.get(key
+00042fe0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00042ff0: 2074 7320 6973 206e 6f74 204e 6f6e 6520   ts is not None 
+00043000: 616e 6420 7473 2e73 7461 7465 203d 3d20  and ts.state == 
+00043010: 226d 656d 6f72 7922 3a0a 2020 2020 2020  "memory":.      
+00043020: 2020 2020 2020 2020 2020 7365 6c66 2e61            self.a
+00043030: 6464 5f72 6570 6c69 6361 2874 732c 2077  dd_replica(ts, w
+00043040: 7329 0a20 2020 2020 2020 2020 2020 2065  s).            e
+00043050: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00043060: 2020 2020 2072 6564 756e 6461 6e74 5f72       redundant_r
+00043070: 6570 6c69 6361 732e 6170 7065 6e64 286b  eplicas.append(k
+00043080: 6579 290a 0a20 2020 2020 2020 2069 6620  ey)..        if 
+00043090: 7265 6475 6e64 616e 745f 7265 706c 6963  redundant_replic
+000430a0: 6173 3a0a 2020 2020 2020 2020 2020 2020  as:.            
+000430b0: 6966 206e 6f74 2073 7469 6d75 6c75 735f  if not stimulus_
+000430c0: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
+000430d0: 2020 2020 7374 696d 756c 7573 5f69 6420      stimulus_id 
+000430e0: 3d20 6622 7265 6475 6e64 616e 742d 7265  = f"redundant-re
+000430f0: 706c 6963 6173 2d7b 7469 6d65 2829 7d22  plicas-{time()}"
+00043100: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00043110: 662e 776f 726b 6572 5f73 656e 6428 0a20  f.worker_send(. 
+00043120: 2020 2020 2020 2020 2020 2020 2020 2077                 w
+00043130: 6f72 6b65 722c 0a20 2020 2020 2020 2020  orker,.         
+00043140: 2020 2020 2020 207b 0a20 2020 2020 2020         {.       
+00043150: 2020 2020 2020 2020 2020 2020 2022 6f70               "op
+00043160: 223a 2022 7265 6d6f 7665 2d72 6570 6c69  ": "remove-repli
+00043170: 6361 7322 2c0a 2020 2020 2020 2020 2020  cas",.          
+00043180: 2020 2020 2020 2020 2020 226b 6579 7322            "keys"
+00043190: 3a20 7265 6475 6e64 616e 745f 7265 706c  : redundant_repl
+000431a0: 6963 6173 2c0a 2020 2020 2020 2020 2020  icas,.          
+000431b0: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
+000431c0: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
+000431d0: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
+000431e0: 2020 2020 2020 7d2c 0a20 2020 2020 2020        },.       
+000431f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00043200: 7265 7475 726e 2022 4f4b 220a 0a20 2020  return "OK"..   
+00043210: 2040 6c6f 675f 6572 726f 7273 0a20 2020   @log_errors.   
+00043220: 2064 6566 2075 7064 6174 655f 6461 7461   def update_data
+00043230: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00043240: 2020 2020 2020 2020 2a2c 0a20 2020 2020          *,.     
+00043250: 2020 2077 686f 5f68 6173 3a20 6469 6374     who_has: dict
+00043260: 5b4b 6579 2c20 6c69 7374 5b73 7472 5d5d  [Key, list[str]]
+00043270: 2c0a 2020 2020 2020 2020 6e62 7974 6573  ,.        nbytes
+00043280: 3a20 6469 6374 5b4b 6579 2c20 696e 745d  : dict[Key, int]
+00043290: 2c0a 2020 2020 2020 2020 636c 6965 6e74  ,.        client
+000432a0: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+000432b0: 6f6e 652c 0a20 2020 2029 202d 3e20 4e6f  one,.    ) -> No
+000432c0: 6e65 3a0a 2020 2020 2020 2020 2222 224c  ne:.        """L
+000432d0: 6561 726e 2074 6861 7420 6e65 7720 6461  earn that new da
+000432e0: 7461 2068 6173 2065 6e74 6572 6564 2074  ta has entered t
+000432f0: 6865 206e 6574 776f 726b 2066 726f 6d20  he network from 
+00043300: 616e 2065 7874 6572 6e61 6c20 736f 7572  an external sour
+00043310: 6365 2222 220a 2020 2020 2020 2020 7768  ce""".        wh
+00043320: 6f5f 6861 7320 3d20 7b6b 3a20 5b73 656c  o_has = {k: [sel
+00043330: 662e 636f 6572 6365 5f61 6464 7265 7373  f.coerce_address
+00043340: 2876 7629 2066 6f72 2076 7620 696e 2076  (vv) for vv in v
+00043350: 5d20 666f 7220 6b2c 2076 2069 6e20 7768  ] for k, v in wh
+00043360: 6f5f 6861 732e 6974 656d 7328 297d 0a20  o_has.items()}. 
+00043370: 2020 2020 2020 206c 6f67 6765 722e 6465         logger.de
+00043380: 6275 6728 2255 7064 6174 6520 6461 7461  bug("Update data
+00043390: 2025 7322 2c20 7768 6f5f 6861 7329 0a0a   %s", who_has)..
+000433a0: 2020 2020 2020 2020 666f 7220 6b65 792c          for key,
+000433b0: 2077 6f72 6b65 7273 2069 6e20 7768 6f5f   workers in who_
+000433c0: 6861 732e 6974 656d 7328 293a 0a20 2020  has.items():.   
+000433d0: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
+000433e0: 6c66 2e74 6173 6b73 2e67 6574 286b 6579  lf.tasks.get(key
+000433f0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00043400: 2074 7320 6973 204e 6f6e 653a 0a20 2020   ts is None:.   
+00043410: 2020 2020 2020 2020 2020 2020 2074 7320               ts 
+00043420: 3d20 7365 6c66 2e6e 6577 5f74 6173 6b28  = self.new_task(
+00043430: 6b65 792c 204e 6f6e 652c 2022 6d65 6d6f  key, None, "memo
+00043440: 7279 2229 0a20 2020 2020 2020 2020 2020  ry").           
+00043450: 2074 732e 7374 6174 6520 3d20 226d 656d   ts.state = "mem
+00043460: 6f72 7922 0a20 2020 2020 2020 2020 2020  ory".           
+00043470: 2074 735f 6e62 7974 6573 203d 206e 6279   ts_nbytes = nby
+00043480: 7465 732e 6765 7428 6b65 792c 202d 3129  tes.get(key, -1)
+00043490: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+000434a0: 7473 5f6e 6279 7465 7320 3e3d 2030 3a0a  ts_nbytes >= 0:.
+000434b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000434c0: 7473 2e73 6574 5f6e 6279 7465 7328 7473  ts.set_nbytes(ts
+000434d0: 5f6e 6279 7465 7329 0a0a 2020 2020 2020  _nbytes)..      
+000434e0: 2020 2020 2020 666f 7220 7720 696e 2077        for w in w
+000434f0: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
+00043500: 2020 2020 2020 2020 7773 203d 2073 656c          ws = sel
+00043510: 662e 776f 726b 6572 735b 775d 0a20 2020  f.workers[w].   
+00043520: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00043530: 662e 6164 645f 7265 706c 6963 6128 7473  f.add_replica(ts
+00043540: 2c20 7773 290a 2020 2020 2020 2020 2020  , ws).          
+00043550: 2020 7365 6c66 2e72 6570 6f72 7428 7b22    self.report({"
+00043560: 6f70 223a 2022 6b65 792d 696e 2d6d 656d  op": "key-in-mem
+00043570: 6f72 7922 2c20 226b 6579 223a 206b 6579  ory", "key": key
+00043580: 2c20 2277 6f72 6b65 7273 223a 206c 6973  , "workers": lis
+00043590: 7428 776f 726b 6572 7329 7d29 0a0a 2020  t(workers)})..  
+000435a0: 2020 2020 2020 6966 2063 6c69 656e 743a        if client:
+000435b0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+000435c0: 662e 636c 6965 6e74 5f64 6573 6972 6573  f.client_desires
+000435d0: 5f6b 6579 7328 6b65 7973 3d6c 6973 7428  _keys(keys=list(
+000435e0: 7768 6f5f 6861 7329 2c20 636c 6965 6e74  who_has), client
+000435f0: 3d63 6c69 656e 7429 0a0a 2020 2020 406f  =client)..    @o
+00043600: 7665 726c 6f61 640a 2020 2020 6465 6620  verload.    def 
+00043610: 7265 706f 7274 5f6f 6e5f 6b65 7928 7365  report_on_key(se
+00043620: 6c66 2c20 6b65 793a 204b 6579 2c20 2a2c  lf, key: Key, *,
+00043630: 2063 6c69 656e 743a 2073 7472 207c 204e   client: str | N
+00043640: 6f6e 6520 3d20 4e6f 6e65 2920 2d3e 204e  one = None) -> N
+00043650: 6f6e 653a 0a20 2020 2020 2020 202e 2e2e  one:.        ...
+00043660: 0a0a 2020 2020 406f 7665 726c 6f61 640a  ..    @overload.
+00043670: 2020 2020 6465 6620 7265 706f 7274 5f6f      def report_o
+00043680: 6e5f 6b65 7928 7365 6c66 2c20 2a2c 2074  n_key(self, *, t
+00043690: 733a 2054 6173 6b53 7461 7465 2c20 636c  s: TaskState, cl
+000436a0: 6965 6e74 3a20 7374 7220 7c20 4e6f 6e65  ient: str | None
+000436b0: 203d 204e 6f6e 6529 202d 3e20 4e6f 6e65   = None) -> None
+000436c0: 3a0a 2020 2020 2020 2020 2e2e 2e0a 0a20  :.        ..... 
+000436d0: 2020 2064 6566 2072 6570 6f72 745f 6f6e     def report_on
+000436e0: 5f6b 6579 2873 656c 662c 206b 6579 3d4e  _key(self, key=N
+000436f0: 6f6e 652c 202a 2c20 7473 3d4e 6f6e 652c  one, *, ts=None,
+00043700: 2063 6c69 656e 743d 4e6f 6e65 293a 0a20   client=None):. 
+00043710: 2020 2020 2020 2069 6620 2874 7320 6973         if (ts is
+00043720: 204e 6f6e 6529 203d 3d20 286b 6579 2069   None) == (key i
+00043730: 7320 4e6f 6e65 293a 0a20 2020 2020 2020  s None):.       
+00043740: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+00043750: 4572 726f 7228 2020 2320 7072 6167 6d61  Error(  # pragma
+00043760: 3a20 6e6f 636f 7665 720a 2020 2020 2020  : nocover.      
+00043770: 2020 2020 2020 2020 2020 6622 7473 2061            f"ts a
+00043780: 6e64 206b 6579 2061 7265 206d 7574 7561  nd key are mutua
+00043790: 6c6c 7920 6578 636c 7573 6976 653b 2072  lly exclusive; r
+000437a0: 6563 6569 7665 6420 7b6b 6579 3d21 727d  eceived {key=!r}
+000437b0: 2c20 7b74 733d 2172 7d22 0a20 2020 2020  , {ts=!r}".     
+000437c0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+000437d0: 2069 6620 7473 2069 7320 4e6f 6e65 3a0a   if ts is None:.
+000437e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+000437f0: 7274 206b 6579 2069 7320 6e6f 7420 4e6f  rt key is not No
+00043800: 6e65 0a20 2020 2020 2020 2020 2020 2074  ne.            t
+00043810: 7320 3d20 7365 6c66 2e74 6173 6b73 2e67  s = self.tasks.g
+00043820: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
+00043830: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00043840: 2020 6b65 7920 3d20 7473 2e6b 6579 0a0a    key = ts.key..
+00043850: 2020 2020 2020 2020 6966 2074 7320 6973          if ts is
 00043860: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
-00043870: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
-00043880: 206d 6170 2873 656c 662e 636f 6572 6365   map(self.coerce
-00043890: 5f61 6464 7265 7373 2c20 776f 726b 6572  _address, worker
-000438a0: 7329 0a20 2020 2020 2020 2020 2020 2072  s).            r
-000438b0: 6574 7572 6e20 7b0a 2020 2020 2020 2020  eturn {.        
-000438c0: 2020 2020 2020 2020 773a 205b 7473 2e6b          w: [ts.k
-000438d0: 6579 2066 6f72 2074 7320 696e 2073 656c  ey for ts in sel
-000438e0: 662e 776f 726b 6572 735b 775d 2e68 6173  f.workers[w].has
-000438f0: 5f77 6861 745d 0a20 2020 2020 2020 2020  _what].         
-00043900: 2020 2020 2020 2069 6620 7720 696e 2073         if w in s
-00043910: 656c 662e 776f 726b 6572 730a 2020 2020  elf.workers.    
-00043920: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00043930: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
-00043940: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
-00043950: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
-00043960: 207d 0a20 2020 2020 2020 2065 6c73 653a   }.        else:
-00043970: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00043980: 7572 6e20 7b77 3a20 5b74 732e 6b65 7920  urn {w: [ts.key 
-00043990: 666f 7220 7473 2069 6e20 7773 2e68 6173  for ts in ws.has
-000439a0: 5f77 6861 745d 2066 6f72 2077 2c20 7773  _what] for w, ws
-000439b0: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-000439c0: 2e69 7465 6d73 2829 7d0a 0a20 2020 2064  .items()}..    d
-000439d0: 6566 2067 6574 5f6e 636f 7265 7328 7365  ef get_ncores(se
-000439e0: 6c66 2c20 776f 726b 6572 733a 2049 7465  lf, workers: Ite
-000439f0: 7261 626c 655b 7374 725d 207c 204e 6f6e  rable[str] | Non
-00043a00: 6520 3d20 4e6f 6e65 2920 2d3e 2064 6963  e = None) -> dic
-00043a10: 745b 7374 722c 2069 6e74 5d3a 0a20 2020  t[str, int]:.   
-00043a20: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
-00043a30: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00043a40: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-00043a50: 203d 206d 6170 2873 656c 662e 636f 6572   = map(self.coer
-00043a60: 6365 5f61 6464 7265 7373 2c20 776f 726b  ce_address, work
-00043a70: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
-00043a80: 2072 6574 7572 6e20 7b77 3a20 7365 6c66   return {w: self
-00043a90: 2e77 6f72 6b65 7273 5b77 5d2e 6e74 6872  .workers[w].nthr
-00043aa0: 6561 6473 2066 6f72 2077 2069 6e20 776f  eads for w in wo
-00043ab0: 726b 6572 7320 6966 2077 2069 6e20 7365  rkers if w in se
-00043ac0: 6c66 2e77 6f72 6b65 7273 7d0a 2020 2020  lf.workers}.    
-00043ad0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00043ae0: 2020 2020 2020 7265 7475 726e 207b 773a        return {w:
-00043af0: 2077 732e 6e74 6872 6561 6473 2066 6f72   ws.nthreads for
-00043b00: 2077 2c20 7773 2069 6e20 7365 6c66 2e77   w, ws in self.w
-00043b10: 6f72 6b65 7273 2e69 7465 6d73 2829 7d0a  orkers.items()}.
-00043b20: 0a20 2020 2064 6566 2067 6574 5f6e 636f  .    def get_nco
-00043b30: 7265 735f 7275 6e6e 696e 6728 0a20 2020  res_running(.   
-00043b40: 2020 2020 2073 656c 662c 2077 6f72 6b65       self, worke
-00043b50: 7273 3a20 4974 6572 6162 6c65 5b73 7472  rs: Iterable[str
-00043b60: 5d20 7c20 4e6f 6e65 203d 204e 6f6e 650a  ] | None = None.
-00043b70: 2020 2020 2920 2d3e 2064 6963 745b 7374      ) -> dict[st
-00043b80: 722c 2069 6e74 5d3a 0a20 2020 2020 2020  r, int]:.       
-00043b90: 206e 636f 7265 7320 3d20 7365 6c66 2e67   ncores = self.g
-00043ba0: 6574 5f6e 636f 7265 7328 776f 726b 6572  et_ncores(worker
-00043bb0: 733d 776f 726b 6572 7329 0a20 2020 2020  s=workers).     
-00043bc0: 2020 2072 6574 7572 6e20 7b0a 2020 2020     return {.    
-00043bd0: 2020 2020 2020 2020 773a 206e 2066 6f72          w: n for
-00043be0: 2077 2c20 6e20 696e 206e 636f 7265 732e   w, n in ncores.
-00043bf0: 6974 656d 7328 2920 6966 2073 656c 662e  items() if self.
-00043c00: 776f 726b 6572 735b 775d 2e73 7461 7475  workers[w].statu
-00043c10: 7320 3d3d 2053 7461 7475 732e 7275 6e6e  s == Status.runn
-00043c20: 696e 670a 2020 2020 2020 2020 7d0a 0a20  ing.        }.. 
-00043c30: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-00043c40: 5f63 616c 6c5f 7374 6163 6b28 7365 6c66  _call_stack(self
-00043c50: 2c20 6b65 7973 3a20 4974 6572 6162 6c65  , keys: Iterable
-00043c60: 5b4b 6579 5d20 7c20 4e6f 6e65 203d 204e  [Key] | None = N
-00043c70: 6f6e 6529 202d 3e20 6469 6374 5b73 7472  one) -> dict[str
-00043c80: 2c20 416e 795d 3a0a 2020 2020 2020 2020  , Any]:.        
-00043c90: 776f 726b 6572 733a 2064 6963 745b 7374  workers: dict[st
-00043ca0: 722c 206c 6973 745b 4b65 795d 207c 204e  r, list[Key] | N
-00043cb0: 6f6e 655d 0a20 2020 2020 2020 2069 6620  one].        if 
-00043cc0: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
-00043cd0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-00043ce0: 6163 6b20 3d20 6c69 7374 286b 6579 7329  ack = list(keys)
-00043cf0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-00043d00: 6365 7373 696e 6720 3d20 7365 7428 290a  cessing = set().
-00043d10: 2020 2020 2020 2020 2020 2020 7768 696c              whil
-00043d20: 6520 7374 6163 6b3a 0a20 2020 2020 2020  e stack:.       
-00043d30: 2020 2020 2020 2020 206b 6579 203d 2073           key = s
-00043d40: 7461 636b 2e70 6f70 2829 0a20 2020 2020  tack.pop().     
-00043d50: 2020 2020 2020 2020 2020 2074 7320 3d20             ts = 
-00043d60: 7365 6c66 2e74 6173 6b73 5b6b 6579 5d0a  self.tasks[key].
-00043d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043d80: 6966 2074 732e 7374 6174 6520 3d3d 2022  if ts.state == "
-00043d90: 7761 6974 696e 6722 3a0a 2020 2020 2020  waiting":.      
-00043da0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-00043db0: 6163 6b2e 6578 7465 6e64 285b 6474 732e  ack.extend([dts.
-00043dc0: 6b65 7920 666f 7220 6474 7320 696e 2074  key for dts in t
-00043dd0: 732e 6465 7065 6e64 656e 6369 6573 5d29  s.dependencies])
-00043de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00043df0: 2065 6c69 6620 7473 2e73 7461 7465 203d   elif ts.state =
-00043e00: 3d20 2270 726f 6365 7373 696e 6722 3a0a  = "processing":.
-00043e10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00043e20: 2020 2020 7072 6f63 6573 7369 6e67 2e61      processing.a
-00043e30: 6464 2874 7329 0a0a 2020 2020 2020 2020  dd(ts)..        
-00043e40: 2020 2020 776f 726b 6572 7320 3d20 6465      workers = de
-00043e50: 6661 756c 7464 6963 7428 6c69 7374 290a  faultdict(list).
-00043e60: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00043e70: 7473 2069 6e20 7072 6f63 6573 7369 6e67  ts in processing
-00043e80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00043e90: 2020 6966 2074 732e 7072 6f63 6573 7369    if ts.processi
-00043ea0: 6e67 5f6f 6e3a 0a20 2020 2020 2020 2020  ng_on:.         
-00043eb0: 2020 2020 2020 2020 2020 2077 6b65 7973             wkeys
-00043ec0: 203d 2077 6f72 6b65 7273 5b74 732e 7072   = workers[ts.pr
-00043ed0: 6f63 6573 7369 6e67 5f6f 6e2e 6164 6472  ocessing_on.addr
-00043ee0: 6573 735d 0a20 2020 2020 2020 2020 2020  ess].           
-00043ef0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-00043f00: 776b 6579 7320 6973 206e 6f74 204e 6f6e  wkeys is not Non
-00043f10: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-00043f20: 2020 2020 2020 776b 6579 732e 6170 7065        wkeys.appe
-00043f30: 6e64 2874 732e 6b65 7929 0a20 2020 2020  nd(ts.key).     
-00043f40: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00043f50: 2020 2020 2077 6f72 6b65 7273 203d 207b       workers = {
-00043f60: 773a 204e 6f6e 6520 666f 7220 7720 696e  w: None for w in
-00043f70: 2073 656c 662e 776f 726b 6572 737d 0a0a   self.workers}..
-00043f80: 2020 2020 2020 2020 6966 206e 6f74 2077          if not w
-00043f90: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
-00043fa0: 2020 2020 7265 7475 726e 207b 7d0a 0a20      return {}.. 
-00043fb0: 2020 2020 2020 2072 6573 756c 7473 203d         results =
-00043fc0: 2061 7761 6974 2061 7379 6e63 696f 2e67   await asyncio.g
-00043fd0: 6174 6865 7228 0a20 2020 2020 2020 2020  ather(.         
-00043fe0: 2020 202a 2873 656c 662e 7270 6328 7729     *(self.rpc(w)
-00043ff0: 2e63 616c 6c5f 7374 6163 6b28 6b65 7973  .call_stack(keys
-00044000: 3d76 2920 666f 7220 772c 2076 2069 6e20  =v) for w, v in 
-00044010: 776f 726b 6572 732e 6974 656d 7328 2929  workers.items())
-00044020: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
-00044030: 2020 2072 6573 706f 6e73 6520 3d20 7b77     response = {w
-00044040: 3a20 7220 666f 7220 772c 2072 2069 6e20  : r for w, r in 
-00044050: 7a69 7028 776f 726b 6572 732c 2072 6573  zip(workers, res
-00044060: 756c 7473 2920 6966 2072 7d0a 2020 2020  ults) if r}.    
-00044070: 2020 2020 7265 7475 726e 2072 6573 706f      return respo
-00044080: 6e73 650a 0a20 2020 2061 7379 6e63 2064  nse..    async d
-00044090: 6566 2062 656e 6368 6d61 726b 5f68 6172  ef benchmark_har
-000440a0: 6477 6172 6528 7365 6c66 2920 2d3e 2064  dware(self) -> d
-000440b0: 6963 745b 7374 722c 2064 6963 745b 7374  ict[str, dict[st
-000440c0: 722c 2066 6c6f 6174 5d5d 3a0a 2020 2020  r, float]]:.    
-000440d0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000440e0: 5275 6e20 6120 6265 6e63 686d 6172 6b20  Run a benchmark 
-000440f0: 6f6e 2074 6865 2077 6f72 6b65 7273 2066  on the workers f
-00044100: 6f72 206d 656d 6f72 792c 2064 6973 6b2c  or memory, disk,
-00044110: 2061 6e64 206e 6574 776f 726b 2062 616e   and network ban
-00044120: 6477 6964 7468 730a 0a20 2020 2020 2020  dwidths..       
-00044130: 2052 6574 7572 6e73 0a20 2020 2020 2020   Returns.       
-00044140: 202d 2d2d 2d2d 2d2d 0a20 2020 2020 2020   -------.       
-00044150: 2072 6573 756c 743a 2064 6963 740a 2020   result: dict.  
-00044160: 2020 2020 2020 2020 2020 4120 6469 6374            A dict
-00044170: 696f 6e61 7279 206d 6170 7069 6e67 2074  ionary mapping t
-00044180: 6865 206e 616d 6573 2022 6469 736b 222c  he names "disk",
-00044190: 2022 6d65 6d6f 7279 222c 2061 6e64 2022   "memory", and "
-000441a0: 6e65 7477 6f72 6b22 2074 6f0a 2020 2020  network" to.    
-000441b0: 2020 2020 2020 2020 6469 6374 696f 6e61          dictiona
-000441c0: 7269 6573 206d 6170 7069 6e67 2073 697a  ries mapping siz
-000441d0: 6573 2074 6f20 6261 6e64 7769 6474 6873  es to bandwidths
-000441e0: 2e20 2054 6865 7365 2062 616e 6477 6964  .  These bandwid
-000441f0: 7468 7320 6172 650a 2020 2020 2020 2020  ths are.        
-00044200: 2020 2020 6176 6572 6167 6564 206f 7665      averaged ove
-00044210: 7220 6d61 6e79 2077 6f72 6b65 7273 2072  r many workers r
-00044220: 756e 6e69 6e67 2063 6f6d 7075 7461 7469  unning computati
-00044230: 6f6e 7320 6163 726f 7373 2074 6865 2063  ons across the c
-00044240: 6c75 7374 6572 2e0a 2020 2020 2020 2020  luster..        
-00044250: 2222 220a 2020 2020 2020 2020 6f75 743a  """.        out:
-00044260: 2064 6963 745b 7374 722c 2064 6566 6175   dict[str, defau
-00044270: 6c74 6469 6374 5b73 7472 2c20 6c69 7374  ltdict[str, list
-00044280: 5b66 6c6f 6174 5d5d 5d20 3d20 7b0a 2020  [float]]] = {.  
-00044290: 2020 2020 2020 2020 2020 6e61 6d65 3a20            name: 
-000442a0: 6465 6661 756c 7464 6963 7428 6c69 7374  defaultdict(list
-000442b0: 2920 666f 7220 6e61 6d65 2069 6e20 5b22  ) for name in ["
-000442c0: 6469 736b 222c 2022 6d65 6d6f 7279 222c  disk", "memory",
-000442d0: 2022 6e65 7477 6f72 6b22 5d0a 2020 2020   "network"].    
-000442e0: 2020 2020 7d0a 0a20 2020 2020 2020 2023      }..        #
-000442f0: 2064 6973 6b0a 2020 2020 2020 2020 7265   disk.        re
-00044300: 7375 6c74 203d 2061 7761 6974 2073 656c  sult = await sel
-00044310: 662e 6272 6f61 6463 6173 7428 6d73 673d  f.broadcast(msg=
-00044320: 7b22 6f70 223a 2022 6265 6e63 686d 6172  {"op": "benchmar
-00044330: 6b5f 6469 736b 227d 290a 2020 2020 2020  k_disk"}).      
-00044340: 2020 666f 7220 6420 696e 2072 6573 756c    for d in resul
-00044350: 742e 7661 6c75 6573 2829 3a0a 2020 2020  t.values():.    
-00044360: 2020 2020 2020 2020 666f 7220 7369 7a65          for size
-00044370: 2c20 6475 7261 7469 6f6e 2069 6e20 642e  , duration in d.
-00044380: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-00044390: 2020 2020 2020 2020 206f 7574 5b22 6469           out["di
-000443a0: 736b 225d 5b73 697a 655d 2e61 7070 656e  sk"][size].appen
-000443b0: 6428 6475 7261 7469 6f6e 290a 0a20 2020  d(duration)..   
-000443c0: 2020 2020 2023 206d 656d 6f72 790a 2020       # memory.  
-000443d0: 2020 2020 2020 7265 7375 6c74 203d 2061        result = a
-000443e0: 7761 6974 2073 656c 662e 6272 6f61 6463  wait self.broadc
-000443f0: 6173 7428 6d73 673d 7b22 6f70 223a 2022  ast(msg={"op": "
-00044400: 6265 6e63 686d 6172 6b5f 6d65 6d6f 7279  benchmark_memory
-00044410: 227d 290a 2020 2020 2020 2020 666f 7220  "}).        for 
-00044420: 6420 696e 2072 6573 756c 742e 7661 6c75  d in result.valu
-00044430: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
-00044440: 2020 666f 7220 7369 7a65 2c20 6475 7261    for size, dura
-00044450: 7469 6f6e 2069 6e20 642e 6974 656d 7328  tion in d.items(
-00044460: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00044470: 2020 206f 7574 5b22 6d65 6d6f 7279 225d     out["memory"]
-00044480: 5b73 697a 655d 2e61 7070 656e 6428 6475  [size].append(du
-00044490: 7261 7469 6f6e 290a 0a20 2020 2020 2020  ration)..       
-000444a0: 2023 206e 6574 776f 726b 0a20 2020 2020   # network.     
-000444b0: 2020 2077 6f72 6b65 7273 203d 206c 6973     workers = lis
-000444c0: 7428 7365 6c66 2e77 6f72 6b65 7273 290a  t(self.workers).
-000444d0: 2020 2020 2020 2020 2320 4f6e 2061 6e20          # On an 
-000444e0: 6164 6170 7469 7665 2063 6c75 7374 6572  adaptive cluster
-000444f0: 2c20 6966 206d 756c 7469 706c 6520 776f  , if multiple wo
-00044500: 726b 6572 7320 6172 6520 7374 6172 7465  rkers are starte
-00044510: 6420 6f6e 2074 6865 2073 616d 6520 7068  d on the same ph
-00044520: 7973 6963 616c 2068 6f73 742c 0a20 2020  ysical host,.   
-00044530: 2020 2020 2023 2074 6865 7920 6172 6520       # they are 
-00044540: 6d6f 7265 206c 696b 656c 7920 746f 2063  more likely to c
-00044550: 6f6e 6e65 6374 2074 6f20 7468 6520 5363  onnect to the Sc
-00044560: 6865 6475 6c65 7220 696e 2073 6571 7565  heduler in seque
-00044570: 6e63 652c 2065 6e64 696e 6720 7570 206e  nce, ending up n
-00044580: 6578 7420 746f 0a20 2020 2020 2020 2023  ext to.        #
-00044590: 2065 6163 6820 6f74 6865 7220 696e 2074   each other in t
-000445a0: 6869 7320 6c69 7374 2e0a 2020 2020 2020  his list..      
-000445b0: 2020 2320 5468 6520 7472 616e 7366 6572    # The transfer
-000445c0: 2073 7065 6564 2077 6974 6869 6e20 7375   speed within su
-000445d0: 6368 2063 6c75 7374 6572 7320 6f66 2077  ch clusters of w
-000445e0: 6f72 6b65 7273 2077 696c 6c20 6265 2065  orkers will be e
-000445f0: 6666 6563 7469 7665 6c79 2074 6861 7420  ffectively that 
-00044600: 6f66 0a20 2020 2020 2020 2023 206c 6f63  of.        # loc
-00044610: 616c 686f 7374 2e20 5468 6973 2063 6f75  alhost. This cou
-00044620: 6c64 2068 6170 7065 6e20 6163 726f 7373  ld happen across
-00044630: 2064 6966 6665 7265 6e74 2056 4d73 2061   different VMs a
-00044640: 6e64 2f6f 7220 646f 636b 6572 2069 6d61  nd/or docker ima
-00044650: 6765 732c 2073 6f0a 2020 2020 2020 2020  ges, so.        
-00044660: 2320 696d 706c 656d 656e 7469 6e67 206c  # implementing l
-00044670: 6f67 6963 2062 6173 6564 206f 6e20 4950  ogic based on IP
-00044680: 2061 6464 7265 7373 6573 2077 6f75 6c64   addresses would
-00044690: 206e 6f74 206e 6563 6573 7361 7269 6c79   not necessarily
-000446a0: 2068 656c 702e 0a20 2020 2020 2020 2023   help..        #
-000446b0: 2052 616e 646f 6d69 7a65 2074 6865 2063   Randomize the c
-000446c0: 6f6e 6e65 6374 696f 6e73 2074 6f20 6576  onnections to ev
-000446d0: 656e 206f 7574 2074 6865 206d 6561 6e20  en out the mean 
-000446e0: 6d65 6173 7572 6573 2e0a 2020 2020 2020  measures..      
-000446f0: 2020 7261 6e64 6f6d 2e73 6875 6666 6c65    random.shuffle
-00044700: 2877 6f72 6b65 7273 290a 2020 2020 2020  (workers).      
-00044710: 2020 6675 7475 7265 7320 3d20 5b0a 2020    futures = [.  
-00044720: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-00044730: 7063 2861 292e 6265 6e63 686d 6172 6b5f  pc(a).benchmark_
-00044740: 6e65 7477 6f72 6b28 6164 6472 6573 733d  network(address=
-00044750: 6229 2066 6f72 2061 2c20 6220 696e 2070  b) for a, b in p
-00044760: 6172 7469 7469 6f6e 2832 2c20 776f 726b  artition(2, work
-00044770: 6572 7329 0a20 2020 2020 2020 205d 0a20  ers).        ]. 
-00044780: 2020 2020 2020 2072 6573 706f 6e73 6573         responses
-00044790: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
-000447a0: 2e67 6174 6865 7228 2a66 7574 7572 6573  .gather(*futures
-000447b0: 290a 0a20 2020 2020 2020 2066 6f72 2064  )..        for d
-000447c0: 2069 6e20 7265 7370 6f6e 7365 733a 0a20   in responses:. 
-000447d0: 2020 2020 2020 2020 2020 2066 6f72 2073             for s
-000447e0: 697a 652c 2064 7572 6174 696f 6e20 696e  ize, duration in
-000447f0: 2064 2e69 7465 6d73 2829 3a0a 2020 2020   d.items():.    
-00044800: 2020 2020 2020 2020 2020 2020 6f75 745b              out[
-00044810: 226e 6574 776f 726b 225d 5b73 697a 655d  "network"][size]
-00044820: 2e61 7070 656e 6428 6475 7261 7469 6f6e  .append(duration
-00044830: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-00044840: 7420 3d20 7b7d 0a20 2020 2020 2020 2066  t = {}.        f
-00044850: 6f72 206d 6f64 6520 696e 206f 7574 3a0a  or mode in out:.
-00044860: 2020 2020 2020 2020 2020 2020 7265 7375              resu
-00044870: 6c74 5b6d 6f64 655d 203d 207b 0a20 2020  lt[mode] = {.   
-00044880: 2020 2020 2020 2020 2020 2020 2073 697a               siz
-00044890: 653a 2073 756d 2864 7572 6174 696f 6e73  e: sum(durations
-000448a0: 2920 2f20 6c65 6e28 6475 7261 7469 6f6e  ) / len(duration
-000448b0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-000448c0: 2020 2066 6f72 2073 697a 652c 2064 7572     for size, dur
-000448d0: 6174 696f 6e73 2069 6e20 6f75 745b 6d6f  ations in out[mo
-000448e0: 6465 5d2e 6974 656d 7328 290a 2020 2020  de].items().    
-000448f0: 2020 2020 2020 2020 7d0a 0a20 2020 2020          }..     
-00044900: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
-00044910: 0a0a 2020 2020 406c 6f67 5f65 7272 6f72  ..    @log_error
-00044920: 730a 2020 2020 6465 6620 6765 745f 6e62  s.    def get_nb
-00044930: 7974 6573 280a 2020 2020 2020 2020 7365  ytes(.        se
-00044940: 6c66 2c20 6b65 7973 3a20 4974 6572 6162  lf, keys: Iterab
-00044950: 6c65 5b4b 6579 5d20 7c20 4e6f 6e65 203d  le[Key] | None =
-00044960: 204e 6f6e 652c 2073 756d 6d61 7279 3a20   None, summary: 
-00044970: 626f 6f6c 203d 2054 7275 650a 2020 2020  bool = True.    
-00044980: 2920 2d3e 2064 6963 745b 4b65 792c 2069  ) -> dict[Key, i
-00044990: 6e74 5d3a 0a20 2020 2020 2020 2069 6620  nt]:.        if 
-000449a0: 6b65 7973 2069 7320 6e6f 7420 4e6f 6e65  keys is not None
-000449b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000449c0: 7375 6c74 203d 207b 6b3a 2073 656c 662e  sult = {k: self.
-000449d0: 7461 736b 735b 6b5d 2e6e 6279 7465 7320  tasks[k].nbytes 
-000449e0: 666f 7220 6b20 696e 206b 6579 737d 0a20  for k in keys}. 
-000449f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00044a00: 2020 2020 2020 2020 2072 6573 756c 7420           result 
-00044a10: 3d20 7b6b 3a20 7473 2e6e 6279 7465 7320  = {k: ts.nbytes 
-00044a20: 666f 7220 6b2c 2074 7320 696e 2073 656c  for k, ts in sel
-00044a30: 662e 7461 736b 732e 6974 656d 7328 2920  f.tasks.items() 
-00044a40: 6966 2074 732e 6e62 7974 6573 203e 3d20  if ts.nbytes >= 
-00044a50: 307d 0a0a 2020 2020 2020 2020 6966 2073  0}..        if s
-00044a60: 756d 6d61 7279 3a0a 2020 2020 2020 2020  ummary:.        
-00044a70: 2020 2020 6f75 743a 2064 6566 6175 6c74      out: default
-00044a80: 6469 6374 5b4b 6579 2c20 696e 745d 203d  dict[Key, int] =
-00044a90: 2064 6566 6175 6c74 6469 6374 2869 6e74   defaultdict(int
-00044aa0: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
-00044ab0: 7220 6b2c 2076 2069 6e20 7265 7375 6c74  r k, v in result
-00044ac0: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-00044ad0: 2020 2020 2020 2020 2020 6f75 745b 6b65            out[ke
-00044ae0: 795f 7370 6c69 7428 6b29 5d20 2b3d 2076  y_split(k)] += v
-00044af0: 0a20 2020 2020 2020 2020 2020 2072 6573  .            res
-00044b00: 756c 7420 3d20 6469 6374 286f 7574 290a  ult = dict(out).
-00044b10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00044b20: 7265 7375 6c74 0a0a 2020 2020 6465 6620  result..    def 
-00044b30: 7275 6e5f 6675 6e63 7469 6f6e 280a 2020  run_function(.  
-00044b40: 2020 2020 2020 7365 6c66 2c0a 2020 2020        self,.    
-00044b50: 2020 2020 636f 6d6d 3a20 436f 6d6d 2c0a      comm: Comm,.
-00044b60: 2020 2020 2020 2020 6675 6e63 7469 6f6e          function
-00044b70: 3a20 4361 6c6c 6162 6c65 2c0a 2020 2020  : Callable,.    
-00044b80: 2020 2020 6172 6773 3a20 7475 706c 6520      args: tuple 
-00044b90: 3d20 2829 2c0a 2020 2020 2020 2020 6b77  = (),.        kw
-00044ba0: 6172 6773 3a20 6469 6374 207c 204e 6f6e  args: dict | Non
-00044bb0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
-00044bc0: 2020 7761 6974 3a20 626f 6f6c 203d 2054    wait: bool = T
-00044bd0: 7275 652c 0a20 2020 2029 202d 3e20 416e  rue,.    ) -> An
-00044be0: 793a 0a20 2020 2020 2020 2022 2222 5275  y:.        """Ru
-00044bf0: 6e20 6120 6675 6e63 7469 6f6e 2077 6974  n a function wit
-00044c00: 6869 6e20 7468 6973 2070 726f 6365 7373  hin this process
-00044c10: 0a0a 2020 2020 2020 2020 5365 6520 416c  ..        See Al
-00044c20: 736f 0a20 2020 2020 2020 202d 2d2d 2d2d  so.        -----
-00044c30: 2d2d 2d0a 2020 2020 2020 2020 436c 6965  ---.        Clie
-00044c40: 6e74 2e72 756e 5f6f 6e5f 7363 6865 6475  nt.run_on_schedu
-00044c50: 6c65 720a 2020 2020 2020 2020 2222 220a  ler.        """.
-00044c60: 2020 2020 2020 2020 6672 6f6d 2064 6973          from dis
-00044c70: 7472 6962 7574 6564 2e77 6f72 6b65 7220  tributed.worker 
-00044c80: 696d 706f 7274 2072 756e 0a0a 2020 2020  import run..    
-00044c90: 2020 2020 6b77 6172 6773 203d 206b 7761      kwargs = kwa
-00044ca0: 7267 7320 6f72 207b 7d0a 2020 2020 2020  rgs or {}.      
-00044cb0: 2020 7365 6c66 2e6c 6f67 5f65 7665 6e74    self.log_event
-00044cc0: 2822 616c 6c22 2c20 7b22 6163 7469 6f6e  ("all", {"action
-00044cd0: 223a 2022 7275 6e2d 6675 6e63 7469 6f6e  ": "run-function
-00044ce0: 222c 2022 6675 6e63 7469 6f6e 223a 2066  ", "function": f
-00044cf0: 756e 6374 696f 6e7d 290a 2020 2020 2020  unction}).      
-00044d00: 2020 7265 7475 726e 2072 756e 2873 656c    return run(sel
-00044d10: 662c 2063 6f6d 6d2c 2066 756e 6374 696f  f, comm, functio
-00044d20: 6e3d 6675 6e63 7469 6f6e 2c20 6172 6773  n=function, args
-00044d30: 3d61 7267 732c 206b 7761 7267 733d 6b77  =args, kwargs=kw
-00044d40: 6172 6773 2c20 7761 6974 3d77 6169 7429  args, wait=wait)
-00044d50: 0a0a 2020 2020 6465 6620 7365 745f 6d65  ..    def set_me
-00044d60: 7461 6461 7461 2873 656c 662c 206b 6579  tadata(self, key
-00044d70: 733a 206c 6973 745b 4b65 795d 2c20 7661  s: list[Key], va
-00044d80: 6c75 653a 206f 626a 6563 7420 3d20 4e6f  lue: object = No
-00044d90: 6e65 2920 2d3e 204e 6f6e 653a 0a20 2020  ne) -> None:.   
-00044da0: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
-00044db0: 7365 6c66 2e74 6173 6b5f 6d65 7461 6461  self.task_metada
-00044dc0: 7461 0a20 2020 2020 2020 2066 6f72 206b  ta.        for k
-00044dd0: 6579 2069 6e20 6b65 7973 5b3a 2d31 5d3a  ey in keys[:-1]:
-00044de0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00044df0: 6b65 7920 6e6f 7420 696e 206d 6574 6164  key not in metad
-00044e00: 6174 6120 6f72 206e 6f74 2069 7369 6e73  ata or not isins
-00044e10: 7461 6e63 6528 6d65 7461 6461 7461 5b6b  tance(metadata[k
-00044e20: 6579 5d2c 2028 6469 6374 2c20 6c69 7374  ey], (dict, list
-00044e30: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00044e40: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
-00044e50: 5d20 3d20 7b7d 0a20 2020 2020 2020 2020  ] = {}.         
-00044e60: 2020 206d 6574 6164 6174 6120 3d20 6d65     metadata = me
-00044e70: 7461 6461 7461 5b6b 6579 5d0a 2020 2020  tadata[key].    
-00044e80: 2020 2020 6d65 7461 6461 7461 5b6b 6579      metadata[key
-00044e90: 735b 2d31 5d5d 203d 2076 616c 7565 0a0a  s[-1]] = value..
-00044ea0: 2020 2020 6465 6620 6765 745f 6d65 7461      def get_meta
-00044eb0: 6461 7461 2873 656c 662c 206b 6579 733a  data(self, keys:
-00044ec0: 206c 6973 745b 4b65 795d 2c20 6465 6661   list[Key], defa
-00044ed0: 756c 743a 2041 6e79 203d 206e 6f5f 6465  ult: Any = no_de
-00044ee0: 6661 756c 7429 202d 3e20 416e 793a 0a20  fault) -> Any:. 
-00044ef0: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
-00044f00: 3d20 7365 6c66 2e74 6173 6b5f 6d65 7461  = self.task_meta
-00044f10: 6461 7461 0a20 2020 2020 2020 2074 7279  data.        try
-00044f20: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00044f30: 7220 6b65 7920 696e 206b 6579 733a 0a20  r key in keys:. 
-00044f40: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00044f50: 6574 6164 6174 6120 3d20 6d65 7461 6461  etadata = metada
-00044f60: 7461 5b6b 6579 5d0a 2020 2020 2020 2020  ta[key].        
-00044f70: 2020 2020 7265 7475 726e 206d 6574 6164      return metad
-00044f80: 6174 610a 2020 2020 2020 2020 6578 6365  ata.        exce
-00044f90: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-00044fa0: 2020 2020 2020 2020 2069 6620 6465 6661           if defa
-00044fb0: 756c 7420 6973 206e 6f74 206e 6f5f 6465  ult is not no_de
-00044fc0: 6661 756c 743a 0a20 2020 2020 2020 2020  fault:.         
-00044fd0: 2020 2020 2020 2072 6574 7572 6e20 6465         return de
-00044fe0: 6661 756c 740a 2020 2020 2020 2020 2020  fault.          
-00044ff0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00045000: 2020 2020 2020 2020 7261 6973 650a 0a20          raise.. 
-00045010: 2020 2064 6566 2073 6574 5f72 6573 7472     def set_restr
-00045020: 6963 7469 6f6e 7328 7365 6c66 2c20 776f  ictions(self, wo
-00045030: 726b 6572 3a20 6469 6374 5b4b 6579 2c20  rker: dict[Key, 
-00045040: 436f 6c6c 6563 7469 6f6e 5b73 7472 5d20  Collection[str] 
-00045050: 7c20 7374 7220 7c20 4e6f 6e65 5d29 202d  | str | None]) -
-00045060: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-00045070: 666f 7220 6b65 792c 2072 6573 7472 6963  for key, restric
-00045080: 7469 6f6e 7320 696e 2077 6f72 6b65 722e  tions in worker.
-00045090: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
-000450a0: 2020 2020 2074 7320 3d20 7365 6c66 2e74       ts = self.t
-000450b0: 6173 6b73 5b6b 6579 5d0a 2020 2020 2020  asks[key].      
-000450c0: 2020 2020 2020 6966 2069 7369 6e73 7461        if isinsta
-000450d0: 6e63 6528 7265 7374 7269 6374 696f 6e73  nce(restrictions
-000450e0: 2c20 7374 7229 3a0a 2020 2020 2020 2020  , str):.        
-000450f0: 2020 2020 2020 2020 7265 7374 7269 6374          restrict
-00045100: 696f 6e73 203d 207b 7265 7374 7269 6374  ions = {restrict
-00045110: 696f 6e73 7d0a 2020 2020 2020 2020 2020  ions}.          
-00045120: 2020 7473 2e77 6f72 6b65 725f 7265 7374    ts.worker_rest
-00045130: 7269 6374 696f 6e73 203d 2073 6574 2872  rictions = set(r
-00045140: 6573 7472 6963 7469 6f6e 7329 2069 6620  estrictions) if 
-00045150: 7265 7374 7269 6374 696f 6e73 2065 6c73  restrictions els
-00045160: 6520 4e6f 6e65 0a0a 2020 2020 406c 6f67  e None..    @log
-00045170: 5f65 7272 6f72 730a 2020 2020 6465 6620  _errors.    def 
-00045180: 6765 745f 7461 736b 5f70 7265 6669 785f  get_task_prefix_
-00045190: 7374 6174 6573 2873 656c 6629 202d 3e20  states(self) -> 
-000451a0: 6469 6374 5b73 7472 2c20 6469 6374 5b73  dict[str, dict[s
-000451b0: 7472 2c20 696e 745d 5d3a 0a20 2020 2020  tr, int]]:.     
-000451c0: 2020 2073 7461 7465 203d 207b 7d0a 0a20     state = {}.. 
-000451d0: 2020 2020 2020 2066 6f72 2074 7020 696e         for tp in
-000451e0: 2073 656c 662e 7461 736b 5f70 7265 6669   self.task_prefi
-000451f0: 7865 732e 7661 6c75 6573 2829 3a0a 2020  xes.values():.  
-00045200: 2020 2020 2020 2020 2020 6163 7469 7665            active
-00045210: 5f73 7461 7465 7320 3d20 7470 2e61 6374  _states = tp.act
-00045220: 6976 655f 7374 6174 6573 0a20 2020 2020  ive_states.     
-00045230: 2020 2020 2020 2073 733a 206c 6973 745b         ss: list[
-00045240: 5461 736b 5374 6174 6553 7461 7465 5d20  TaskStateState] 
-00045250: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
-00045260: 2020 2020 226d 656d 6f72 7922 2c0a 2020      "memory",.  
-00045270: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-00045280: 7272 6564 222c 0a20 2020 2020 2020 2020  rred",.         
-00045290: 2020 2020 2020 2022 7265 6c65 6173 6564         "released
-000452a0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
-000452b0: 2020 2022 7072 6f63 6573 7369 6e67 222c     "processing",
-000452c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000452d0: 2022 7761 6974 696e 6722 2c0a 2020 2020   "waiting",.    
-000452e0: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-000452f0: 2020 2020 2020 6966 2061 6e79 2861 6374        if any(act
-00045300: 6976 655f 7374 6174 6573 2e67 6574 2873  ive_states.get(s
-00045310: 2920 666f 7220 7320 696e 2073 7329 3a0a  ) for s in ss):.
-00045320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00045330: 7374 6174 655b 7470 2e6e 616d 655d 203d  state[tp.name] =
-00045340: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-00045350: 2020 2020 2020 2022 6d65 6d6f 7279 223a         "memory":
-00045360: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
-00045370: 6d65 6d6f 7279 225d 2c0a 2020 2020 2020  memory"],.      
-00045380: 2020 2020 2020 2020 2020 2020 2020 2265                "e
-00045390: 7272 6564 223a 2061 6374 6976 655f 7374  rred": active_st
-000453a0: 6174 6573 5b22 6572 7265 6422 5d2c 0a20  ates["erred"],. 
-000453b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000453c0: 2020 2022 7265 6c65 6173 6564 223a 2061     "released": a
-000453d0: 6374 6976 655f 7374 6174 6573 5b22 7265  ctive_states["re
-000453e0: 6c65 6173 6564 225d 2c0a 2020 2020 2020  leased"],.      
-000453f0: 2020 2020 2020 2020 2020 2020 2020 2270                "p
-00045400: 726f 6365 7373 696e 6722 3a20 6163 7469  rocessing": acti
-00045410: 7665 5f73 7461 7465 735b 2270 726f 6365  ve_states["proce
-00045420: 7373 696e 6722 5d2c 0a20 2020 2020 2020  ssing"],.       
-00045430: 2020 2020 2020 2020 2020 2020 2022 7761               "wa
-00045440: 6974 696e 6722 3a20 6163 7469 7665 5f73  iting": active_s
-00045450: 7461 7465 735b 2277 6169 7469 6e67 225d  tates["waiting"]
-00045460: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00045470: 2020 7d0a 0a20 2020 2020 2020 2072 6574    }..        ret
-00045480: 7572 6e20 7374 6174 650a 0a20 2020 2064  urn state..    d
-00045490: 6566 2067 6574 5f74 6173 6b5f 7374 6174  ef get_task_stat
-000454a0: 7573 2873 656c 662c 206b 6579 733a 2049  us(self, keys: I
-000454b0: 7465 7261 626c 655b 4b65 795d 2920 2d3e  terable[Key]) ->
-000454c0: 2064 6963 745b 4b65 792c 2054 6173 6b53   dict[Key, TaskS
-000454d0: 7461 7465 5374 6174 6520 7c20 4e6f 6e65  tateState | None
-000454e0: 5d3a 0a20 2020 2020 2020 2072 6574 7572  ]:.        retur
-000454f0: 6e20 7b0a 2020 2020 2020 2020 2020 2020  n {.            
-00045500: 6b65 793a 2028 7365 6c66 2e74 6173 6b73  key: (self.tasks
-00045510: 5b6b 6579 5d2e 7374 6174 6520 6966 206b  [key].state if k
-00045520: 6579 2069 6e20 7365 6c66 2e74 6173 6b73  ey in self.tasks
-00045530: 2065 6c73 6520 4e6f 6e65 2920 666f 7220   else None) for 
-00045540: 6b65 7920 696e 206b 6579 730a 2020 2020  key in keys.    
-00045550: 2020 2020 7d0a 0a20 2020 2064 6566 2067      }..    def g
-00045560: 6574 5f74 6173 6b5f 7374 7265 616d 280a  et_task_stream(.
-00045570: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
-00045580: 2020 2020 2020 7374 6172 743a 2073 7472        start: str
-00045590: 207c 2066 6c6f 6174 207c 204e 6f6e 6520   | float | None 
-000455a0: 3d20 4e6f 6e65 2c0a 2020 2020 2020 2020  = None,.        
-000455b0: 7374 6f70 3a20 7374 7220 7c20 666c 6f61  stop: str | floa
-000455c0: 7420 7c20 4e6f 6e65 203d 204e 6f6e 652c  t | None = None,
-000455d0: 0a20 2020 2020 2020 2063 6f75 6e74 3a20  .        count: 
-000455e0: 696e 7420 7c20 4e6f 6e65 203d 204e 6f6e  int | None = Non
-000455f0: 652c 0a20 2020 2029 202d 3e20 6c69 7374  e,.    ) -> list
-00045600: 3a0a 2020 2020 2020 2020 6672 6f6d 2064  :.        from d
-00045610: 6973 7472 6962 7574 6564 2e64 6961 676e  istributed.diagn
-00045620: 6f73 7469 6373 2e74 6173 6b5f 7374 7265  ostics.task_stre
-00045630: 616d 2069 6d70 6f72 7420 5461 736b 5374  am import TaskSt
-00045640: 7265 616d 506c 7567 696e 0a0a 2020 2020  reamPlugin..    
-00045650: 2020 2020 6966 2054 6173 6b53 7472 6561      if TaskStrea
-00045660: 6d50 6c75 6769 6e2e 6e61 6d65 206e 6f74  mPlugin.name not
-00045670: 2069 6e20 7365 6c66 2e70 6c75 6769 6e73   in self.plugins
-00045680: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00045690: 6c66 2e61 6464 5f70 6c75 6769 6e28 5461  lf.add_plugin(Ta
-000456a0: 736b 5374 7265 616d 506c 7567 696e 2873  skStreamPlugin(s
-000456b0: 656c 6629 290a 0a20 2020 2020 2020 2070  elf))..        p
-000456c0: 6c75 6769 6e20 3d20 6361 7374 2854 6173  lugin = cast(Tas
-000456d0: 6b53 7472 6561 6d50 6c75 6769 6e2c 2073  kStreamPlugin, s
-000456e0: 656c 662e 706c 7567 696e 735b 5461 736b  elf.plugins[Task
-000456f0: 5374 7265 616d 506c 7567 696e 2e6e 616d  StreamPlugin.nam
-00045700: 655d 290a 0a20 2020 2020 2020 2072 6574  e])..        ret
-00045710: 7572 6e20 706c 7567 696e 2e63 6f6c 6c65  urn plugin.colle
-00045720: 6374 2873 7461 7274 3d73 7461 7274 2c20  ct(start=start, 
-00045730: 7374 6f70 3d73 746f 702c 2063 6f75 6e74  stop=stop, count
-00045740: 3d63 6f75 6e74 290a 0a20 2020 2064 6566  =count)..    def
-00045750: 2073 7461 7274 5f74 6173 6b5f 6d65 7461   start_task_meta
-00045760: 6461 7461 2873 656c 662c 206e 616d 653a  data(self, name:
-00045770: 2073 7472 2920 2d3e 204e 6f6e 653a 0a20   str) -> None:. 
-00045780: 2020 2020 2020 2070 6c75 6769 6e20 3d20         plugin = 
-00045790: 436f 6c6c 6563 7454 6173 6b4d 6574 6144  CollectTaskMetaD
-000457a0: 6174 6150 6c75 6769 6e28 7363 6865 6475  ataPlugin(schedu
-000457b0: 6c65 723d 7365 6c66 2c20 6e61 6d65 3d6e  ler=self, name=n
-000457c0: 616d 6529 0a20 2020 2020 2020 2073 656c  ame).        sel
-000457d0: 662e 6164 645f 706c 7567 696e 2870 6c75  f.add_plugin(plu
-000457e0: 6769 6e29 0a0a 2020 2020 6465 6620 7374  gin)..    def st
-000457f0: 6f70 5f74 6173 6b5f 6d65 7461 6461 7461  op_task_metadata
-00045800: 2873 656c 662c 206e 616d 653a 2073 7472  (self, name: str
-00045810: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2920   | None = None) 
-00045820: 2d3e 2064 6963 743a 0a20 2020 2020 2020  -> dict:.       
-00045830: 2070 6c75 6769 6e73 203d 205b 0a20 2020   plugins = [.   
-00045840: 2020 2020 2020 2020 2070 0a20 2020 2020           p.     
-00045850: 2020 2020 2020 2066 6f72 2070 2069 6e20         for p in 
-00045860: 6c69 7374 2873 656c 662e 706c 7567 696e  list(self.plugin
-00045870: 732e 7661 6c75 6573 2829 290a 2020 2020  s.values()).    
-00045880: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
-00045890: 7461 6e63 6528 702c 2043 6f6c 6c65 6374  tance(p, Collect
-000458a0: 5461 736b 4d65 7461 4461 7461 506c 7567  TaskMetaDataPlug
-000458b0: 696e 2920 616e 6420 702e 6e61 6d65 203d  in) and p.name =
-000458c0: 3d20 6e61 6d65 0a20 2020 2020 2020 205d  = name.        ]
-000458d0: 0a20 2020 2020 2020 2069 6620 6c65 6e28  .        if len(
-000458e0: 706c 7567 696e 7329 2021 3d20 313a 0a20  plugins) != 1:. 
-000458f0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
-00045900: 2056 616c 7565 4572 726f 7228 0a20 2020   ValueError(.   
-00045910: 2020 2020 2020 2020 2020 2020 2022 4578               "Ex
-00045920: 7065 6374 6564 2074 6f20 6669 6e64 2065  pected to find e
-00045930: 7861 6374 6c79 206f 6e65 2043 6f6c 6c65  xactly one Colle
-00045940: 6374 5461 736b 4d65 7461 4461 7461 506c  ctTaskMetaDataPl
-00045950: 7567 696e 2022 0a20 2020 2020 2020 2020  ugin ".         
-00045960: 2020 2020 2020 2066 2277 6974 6820 6e61         f"with na
-00045970: 6d65 207b 6e61 6d65 7d20 6275 7420 666f  me {name} but fo
-00045980: 756e 6420 7b6c 656e 2870 6c75 6769 6e73  und {len(plugins
-00045990: 297d 2e22 0a20 2020 2020 2020 2020 2020  )}.".           
-000459a0: 2029 0a0a 2020 2020 2020 2020 706c 7567   )..        plug
-000459b0: 696e 203d 2070 6c75 6769 6e73 5b30 5d0a  in = plugins[0].
-000459c0: 2020 2020 2020 2020 7365 6c66 2e72 656d          self.rem
-000459d0: 6f76 655f 706c 7567 696e 286e 616d 653d  ove_plugin(name=
-000459e0: 706c 7567 696e 2e6e 616d 6529 0a20 2020  plugin.name).   
-000459f0: 2020 2020 2072 6574 7572 6e20 7b22 6d65       return {"me
-00045a00: 7461 6461 7461 223a 2070 6c75 6769 6e2e  tadata": plugin.
-00045a10: 6d65 7461 6461 7461 2c20 2273 7461 7465  metadata, "state
-00045a20: 223a 2070 6c75 6769 6e2e 7374 6174 657d  ": plugin.state}
-00045a30: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
-00045a40: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
-00045a50: 706c 7567 696e 280a 2020 2020 2020 2020  plugin(.        
-00045a60: 7365 6c66 2c20 636f 6d6d 3a20 4e6f 6e65  self, comm: None
-00045a70: 2c20 706c 7567 696e 3a20 6279 7465 732c  , plugin: bytes,
-00045a80: 206e 616d 653a 2073 7472 2c20 6964 656d   name: str, idem
-00045a90: 706f 7465 6e74 3a20 626f 6f6c 207c 204e  potent: bool | N
-00045aa0: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
-00045ab0: 202d 3e20 6469 6374 5b73 7472 2c20 4f4b   -> dict[str, OK
-00045ac0: 4d65 7373 6167 655d 3a0a 2020 2020 2020  Message]:.      
-00045ad0: 2020 2222 2252 6567 6973 7465 7273 2061    """Registers a
-00045ae0: 2077 6f72 6b65 7220 706c 7567 696e 206f   worker plugin o
-00045af0: 6e20 616c 6c20 7275 6e6e 696e 6720 616e  n all running an
-00045b00: 6420 6675 7475 7265 2077 6f72 6b65 7273  d future workers
-00045b10: 2222 220a 2020 2020 2020 2020 6c6f 6767  """.        logg
-00045b20: 6572 2e69 6e66 6f28 2252 6567 6973 7465  er.info("Registe
-00045b30: 7269 6e67 2057 6f72 6b65 7220 706c 7567  ring Worker plug
-00045b40: 696e 2025 7322 2c20 6e61 6d65 290a 2020  in %s", name).  
-00045b50: 2020 2020 2020 6966 2069 6465 6d70 6f74        if idempot
-00045b60: 656e 7420 6973 204e 6f6e 653a 0a20 2020  ent is None:.   
-00045b70: 2020 2020 2020 2020 2077 6172 6e69 6e67           warning
-00045b80: 732e 7761 726e 280a 2020 2020 2020 2020  s.warn(.        
-00045b90: 2020 2020 2020 2020 2254 6865 2073 6967          "The sig
-00045ba0: 6e61 7475 7265 206f 6620 6053 6368 6564  nature of `Sched
-00045bb0: 756c 6572 2e72 6567 6973 7465 725f 776f  uler.register_wo
-00045bc0: 726b 6572 5f70 6c75 6769 6e60 206e 6f77  rker_plugin` now
-00045bd0: 2072 6571 7569 7265 7320 220a 2020 2020   requires ".    
-00045be0: 2020 2020 2020 2020 2020 2020 2260 6964              "`id
-00045bf0: 656d 706f 7465 6e74 602e 204e 6f74 2069  empotent`. Not i
-00045c00: 6e63 6c75 6469 6e67 2060 6964 656d 706f  ncluding `idempo
-00045c10: 7465 6e74 6020 696e 2074 6865 2073 6967  tent` in the sig
-00045c20: 6e61 7475 7265 2077 696c 6c20 6e6f 206c  nature will no l
-00045c30: 6f6e 6765 7220 220a 2020 2020 2020 2020  onger ".        
-00045c40: 2020 2020 2020 2020 2262 6520 7375 7070          "be supp
-00045c50: 6f72 7465 6420 696e 2066 7574 7572 6520  orted in future 
-00045c60: 7665 7273 696f 6e73 2e22 2c0a 2020 2020  versions.",.    
-00045c70: 2020 2020 2020 2020 2020 2020 4675 7475              Futu
-00045c80: 7265 5761 726e 696e 672c 0a20 2020 2020  reWarning,.     
-00045c90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00045ca0: 2020 2020 2069 6465 6d70 6f74 656e 7420       idempotent 
-00045cb0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
-00045cc0: 6966 206e 616d 6520 696e 2073 656c 662e  if name in self.
-00045cd0: 776f 726b 6572 5f70 6c75 6769 6e73 2061  worker_plugins a
-00045ce0: 6e64 2069 6465 6d70 6f74 656e 743a 0a20  nd idempotent:. 
-00045cf0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00045d00: 6e20 7b7d 0a0a 2020 2020 2020 2020 7365  n {}..        se
-00045d10: 6c66 2e77 6f72 6b65 725f 706c 7567 696e  lf.worker_plugin
-00045d20: 735b 6e61 6d65 5d20 3d20 706c 7567 696e  s[name] = plugin
-00045d30: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
-00045d40: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
-00045d50: 2e62 726f 6164 6361 7374 280a 2020 2020  .broadcast(.    
-00045d60: 2020 2020 2020 2020 6d73 673d 6469 6374          msg=dict
-00045d70: 286f 703d 2270 6c75 6769 6e2d 6164 6422  (op="plugin-add"
-00045d80: 2c20 706c 7567 696e 3d70 6c75 6769 6e2c  , plugin=plugin,
-00045d90: 206e 616d 653d 6e61 6d65 290a 2020 2020   name=name).    
-00045da0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-00045db0: 7475 726e 2072 6573 706f 6e73 6573 0a0a  turn responses..
-00045dc0: 2020 2020 6173 796e 6320 6465 6620 756e      async def un
-00045dd0: 7265 6769 7374 6572 5f77 6f72 6b65 725f  register_worker_
-00045de0: 706c 7567 696e 280a 2020 2020 2020 2020  plugin(.        
-00045df0: 7365 6c66 2c20 636f 6d6d 3a20 4e6f 6e65  self, comm: None
-00045e00: 2c20 6e61 6d65 3a20 7374 720a 2020 2020  , name: str.    
-00045e10: 2920 2d3e 2064 6963 745b 7374 722c 2045  ) -> dict[str, E
-00045e20: 7272 6f72 4d65 7373 6167 6520 7c20 4f4b  rrorMessage | OK
-00045e30: 4d65 7373 6167 655d 3a0a 2020 2020 2020  Message]:.      
-00045e40: 2020 2222 2255 6e72 6567 6973 7465 7273    """Unregisters
-00045e50: 2061 2077 6f72 6b65 7220 706c 7567 696e   a worker plugin
-00045e60: 2222 220a 2020 2020 2020 2020 7472 793a  """.        try:
-00045e70: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00045e80: 662e 776f 726b 6572 5f70 6c75 6769 6e73  f.worker_plugins
-00045e90: 2e70 6f70 286e 616d 6529 0a20 2020 2020  .pop(name).     
-00045ea0: 2020 2065 7863 6570 7420 4b65 7945 7272     except KeyErr
-00045eb0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
-00045ec0: 7261 6973 6520 5661 6c75 6545 7272 6f72  raise ValueError
-00045ed0: 2866 2254 6865 2077 6f72 6b65 7220 706c  (f"The worker pl
-00045ee0: 7567 696e 207b 6e61 6d65 7d20 646f 6573  ugin {name} does
-00045ef0: 206e 6f74 2065 7869 7374 2229 0a0a 2020   not exist")..  
-00045f00: 2020 2020 2020 7265 7370 6f6e 7365 7320        responses 
-00045f10: 3d20 6177 6169 7420 7365 6c66 2e62 726f  = await self.bro
-00045f20: 6164 6361 7374 286d 7367 3d64 6963 7428  adcast(msg=dict(
-00045f30: 6f70 3d22 706c 7567 696e 2d72 656d 6f76  op="plugin-remov
-00045f40: 6522 2c20 6e61 6d65 3d6e 616d 6529 290a  e", name=name)).
-00045f50: 2020 2020 2020 2020 7265 7475 726e 2072          return r
-00045f60: 6573 706f 6e73 6573 0a0a 2020 2020 6173  esponses..    as
-00045f70: 796e 6320 6465 6620 7265 6769 7374 6572  ync def register
-00045f80: 5f6e 616e 6e79 5f70 6c75 6769 6e28 0a20  _nanny_plugin(. 
-00045f90: 2020 2020 2020 2073 656c 662c 2063 6f6d         self, com
-00045fa0: 6d3a 204e 6f6e 652c 2070 6c75 6769 6e3a  m: None, plugin:
-00045fb0: 2062 7974 6573 2c20 6e61 6d65 3a20 7374   bytes, name: st
-00045fc0: 722c 2069 6465 6d70 6f74 656e 743a 2062  r, idempotent: b
-00045fd0: 6f6f 6c20 7c20 4e6f 6e65 203d 204e 6f6e  ool | None = Non
-00045fe0: 650a 2020 2020 2920 2d3e 2064 6963 745b  e.    ) -> dict[
-00045ff0: 7374 722c 204f 4b4d 6573 7361 6765 5d3a  str, OKMessage]:
-00046000: 0a20 2020 2020 2020 2022 2222 5265 6769  .        """Regi
-00046010: 7374 6572 7320 6120 6e61 6e6e 7920 706c  sters a nanny pl
-00046020: 7567 696e 206f 6e20 616c 6c20 7275 6e6e  ugin on all runn
-00046030: 696e 6720 616e 6420 6675 7475 7265 206e  ing and future n
-00046040: 616e 6e69 6573 2222 220a 2020 2020 2020  annies""".      
-00046050: 2020 6c6f 6767 6572 2e69 6e66 6f28 2252    logger.info("R
-00046060: 6567 6973 7465 7269 6e67 204e 616e 6e79  egistering Nanny
-00046070: 2070 6c75 6769 6e20 2573 222c 206e 616d   plugin %s", nam
-00046080: 6529 0a0a 2020 2020 2020 2020 6966 2069  e)..        if i
-00046090: 6465 6d70 6f74 656e 7420 6973 204e 6f6e  dempotent is Non
-000460a0: 653a 0a20 2020 2020 2020 2020 2020 2077  e:.            w
-000460b0: 6172 6e69 6e67 732e 7761 726e 280a 2020  arnings.warn(.  
-000460c0: 2020 2020 2020 2020 2020 2020 2020 2254                "T
-000460d0: 6865 2073 6967 6e61 7475 7265 206f 6620  he signature of 
-000460e0: 6053 6368 6564 756c 6572 2e72 6567 6973  `Scheduler.regis
-000460f0: 7465 725f 6e61 6e6e 795f 706c 7567 696e  ter_nanny_plugin
-00046100: 6020 6e6f 7720 7265 7175 6972 6573 2022  ` now requires "
-00046110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00046120: 2022 6069 6465 6d70 6f74 656e 7460 2e20   "`idempotent`. 
-00046130: 4e6f 7420 696e 636c 7564 696e 6720 6069  Not including `i
-00046140: 6465 6d70 6f74 656e 7460 2069 6e20 7468  dempotent` in th
-00046150: 6520 7369 676e 6174 7572 6520 7769 6c6c  e signature will
-00046160: 206e 6f20 6c6f 6e67 6572 2022 0a20 2020   no longer ".   
-00046170: 2020 2020 2020 2020 2020 2020 2022 6265               "be
-00046180: 2073 7570 706f 7274 6564 2069 6e20 6675   supported in fu
-00046190: 7475 7265 2076 6572 7369 6f6e 732e 222c  ture versions.",
-000461a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000461b0: 2046 7574 7572 6557 6172 6e69 6e67 2c0a   FutureWarning,.
-000461c0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-000461d0: 2020 2020 2020 2020 2020 6964 656d 706f            idempo
-000461e0: 7465 6e74 203d 2046 616c 7365 0a0a 2020  tent = False..  
-000461f0: 2020 2020 2020 6966 206e 616d 6520 696e        if name in
-00046200: 2073 656c 662e 6e61 6e6e 795f 706c 7567   self.nanny_plug
-00046210: 696e 7320 616e 6420 6964 656d 706f 7465  ins and idempote
-00046220: 6e74 3a0a 2020 2020 2020 2020 2020 2020  nt:.            
-00046230: 7265 7475 726e 207b 7d0a 0a20 2020 2020  return {}..     
-00046240: 2020 2073 656c 662e 6e61 6e6e 795f 706c     self.nanny_pl
-00046250: 7567 696e 735b 6e61 6d65 5d20 3d20 706c  ugins[name] = pl
-00046260: 7567 696e 0a20 2020 2020 2020 2061 7379  ugin.        asy
-00046270: 6e63 2077 6974 6820 7365 6c66 2e5f 7374  nc with self._st
-00046280: 6172 7469 6e67 5f6e 616e 6e69 6573 5f63  arting_nannies_c
-00046290: 6f6e 643a 0a20 2020 2020 2020 2020 2020  ond:.           
-000462a0: 2069 6620 7365 6c66 2e5f 7374 6172 7469   if self._starti
-000462b0: 6e67 5f6e 616e 6e69 6573 3a0a 2020 2020  ng_nannies:.    
-000462c0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-000462d0: 6572 2e69 6e66 6f28 2257 6169 7469 6e67  er.info("Waiting
-000462e0: 2066 6f72 204e 616e 6e69 6573 2074 6f20   for Nannies to 
-000462f0: 7374 6172 7420 2573 222c 2073 656c 662e  start %s", self.
-00046300: 5f73 7461 7274 696e 675f 6e61 6e6e 6965  _starting_nannie
-00046310: 7329 0a20 2020 2020 2020 2020 2020 2061  s).            a
-00046320: 7761 6974 2073 656c 662e 5f73 7461 7274  wait self._start
-00046330: 696e 675f 6e61 6e6e 6965 735f 636f 6e64  ing_nannies_cond
-00046340: 2e77 6169 745f 666f 7228 0a20 2020 2020  .wait_for(.     
-00046350: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-00046360: 613a 206e 6f74 2073 656c 662e 5f73 7461  a: not self._sta
-00046370: 7274 696e 675f 6e61 6e6e 6965 730a 2020  rting_nannies.  
-00046380: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00046390: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
-000463a0: 7320 3d20 6177 6169 7420 7365 6c66 2e62  s = await self.b
-000463b0: 726f 6164 6361 7374 280a 2020 2020 2020  roadcast(.      
-000463c0: 2020 2020 2020 2020 2020 6d73 673d 6469            msg=di
-000463d0: 6374 286f 703d 2270 6c75 6769 6e5f 6164  ct(op="plugin_ad
-000463e0: 6422 2c20 706c 7567 696e 3d70 6c75 6769  d", plugin=plugi
-000463f0: 6e2c 206e 616d 653d 6e61 6d65 292c 0a20  n, name=name),. 
-00046400: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00046410: 616e 6e79 3d54 7275 652c 0a20 2020 2020  anny=True,.     
-00046420: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00046430: 2020 2020 2072 6574 7572 6e20 7265 7370       return resp
-00046440: 6f6e 7365 730a 0a20 2020 2061 7379 6e63  onses..    async
-00046450: 2064 6566 2075 6e72 6567 6973 7465 725f   def unregister_
-00046460: 6e61 6e6e 795f 706c 7567 696e 280a 2020  nanny_plugin(.  
-00046470: 2020 2020 2020 7365 6c66 2c20 636f 6d6d        self, comm
-00046480: 3a20 4e6f 6e65 2c20 6e61 6d65 3a20 7374  : None, name: st
-00046490: 720a 2020 2020 2920 2d3e 2064 6963 745b  r.    ) -> dict[
-000464a0: 7374 722c 2045 7272 6f72 4d65 7373 6167  str, ErrorMessag
-000464b0: 6520 7c20 4f4b 4d65 7373 6167 655d 3a0a  e | OKMessage]:.
-000464c0: 2020 2020 2020 2020 2222 2255 6e72 6567          """Unreg
-000464d0: 6973 7465 7273 2061 2077 6f72 6b65 7220  isters a worker 
-000464e0: 706c 7567 696e 2222 220a 2020 2020 2020  plugin""".      
-000464f0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00046500: 2020 2073 656c 662e 6e61 6e6e 795f 706c     self.nanny_pl
-00046510: 7567 696e 732e 706f 7028 6e61 6d65 290a  ugins.pop(name).
-00046520: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-00046530: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-00046540: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
-00046550: 4572 726f 7228 6622 5468 6520 6e61 6e6e  Error(f"The nann
-00046560: 7920 706c 7567 696e 207b 6e61 6d65 7d20  y plugin {name} 
-00046570: 646f 6573 206e 6f74 2065 7869 7374 2229  does not exist")
-00046580: 0a0a 2020 2020 2020 2020 7265 7370 6f6e  ..        respon
-00046590: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
-000465a0: 2e62 726f 6164 6361 7374 280a 2020 2020  .broadcast(.    
-000465b0: 2020 2020 2020 2020 6d73 673d 6469 6374          msg=dict
-000465c0: 286f 703d 2270 6c75 6769 6e5f 7265 6d6f  (op="plugin_remo
-000465d0: 7665 222c 206e 616d 653d 6e61 6d65 292c  ve", name=name),
-000465e0: 206e 616e 6e79 3d54 7275 650a 2020 2020   nanny=True.    
-000465f0: 2020 2020 290a 2020 2020 2020 2020 7265      ).        re
-00046600: 7475 726e 2072 6573 706f 6e73 6573 0a0a  turn responses..
-00046610: 2020 2020 6465 6620 7472 616e 7369 7469      def transiti
-00046620: 6f6e 280a 2020 2020 2020 2020 7365 6c66  on(.        self
-00046630: 2c0a 2020 2020 2020 2020 6b65 793a 204b  ,.        key: K
-00046640: 6579 2c0a 2020 2020 2020 2020 6669 6e69  ey,.        fini
-00046650: 7368 3a20 5461 736b 5374 6174 6553 7461  sh: TaskStateSta
-00046660: 7465 2c0a 2020 2020 2020 2020 7374 696d  te,.        stim
-00046670: 756c 7573 5f69 643a 2073 7472 2c0a 2020  ulus_id: str,.  
-00046680: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
-00046690: 416e 792c 0a20 2020 2029 202d 3e20 5265  Any,.    ) -> Re
-000466a0: 6373 3a0a 2020 2020 2020 2020 2222 2254  cs:.        """T
-000466b0: 7261 6e73 6974 696f 6e20 6120 6b65 7920  ransition a key 
-000466c0: 6672 6f6d 2069 7473 2063 7572 7265 6e74  from its current
-000466d0: 2073 7461 7465 2074 6f20 7468 6520 6669   state to the fi
-000466e0: 6e69 7368 2073 7461 7465 0a0a 2020 2020  nish state..    
-000466f0: 2020 2020 4578 616d 706c 6573 0a20 2020      Examples.   
-00046700: 2020 2020 202d 2d2d 2d2d 2d2d 2d0a 2020       --------.  
-00046710: 2020 2020 2020 3e3e 3e20 7365 6c66 2e74        >>> self.t
-00046720: 7261 6e73 6974 696f 6e28 2778 272c 2027  ransition('x', '
-00046730: 7761 6974 696e 6727 290a 2020 2020 2020  waiting').      
-00046740: 2020 7b27 7827 3a20 2770 726f 6365 7373    {'x': 'process
-00046750: 696e 6727 7d0a 0a20 2020 2020 2020 2052  ing'}..        R
-00046760: 6574 7572 6e73 0a20 2020 2020 2020 202d  eturns.        -
-00046770: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2044  ------.        D
-00046780: 6963 7469 6f6e 6172 7920 6f66 2072 6563  ictionary of rec
-00046790: 6f6d 6d65 6e64 6174 696f 6e73 2066 6f72  ommendations for
-000467a0: 2066 7574 7572 6520 7472 616e 7369 7469   future transiti
-000467b0: 6f6e 730a 0a20 2020 2020 2020 2053 6565  ons..        See
-000467c0: 2041 6c73 6f0a 2020 2020 2020 2020 2d2d   Also.        --
-000467d0: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2053  ------.        S
-000467e0: 6368 6564 756c 6572 2e74 7261 6e73 6974  cheduler.transit
-000467f0: 696f 6e73 3a20 7472 616e 7369 7469 7665  ions: transitive
-00046800: 2076 6572 7369 6f6e 206f 6620 7468 6973   version of this
-00046810: 2066 756e 6374 696f 6e0a 2020 2020 2020   function.      
-00046820: 2020 2222 220a 2020 2020 2020 2020 7265    """.        re
-00046830: 636f 6d6d 656e 6461 7469 6f6e 732c 2063  commendations, c
-00046840: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
-00046850: 6572 5f6d 7367 7320 3d20 7365 6c66 2e5f  er_msgs = self._
-00046860: 7472 616e 7369 7469 6f6e 280a 2020 2020  transition(.    
-00046870: 2020 2020 2020 2020 6b65 792c 2066 696e          key, fin
-00046880: 6973 682c 2073 7469 6d75 6c75 735f 6964  ish, stimulus_id
-00046890: 2c20 2a2a 6b77 6172 6773 0a20 2020 2020  , **kwargs.     
-000468a0: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
-000468b0: 662e 7365 6e64 5f61 6c6c 2863 6c69 656e  f.send_all(clien
-000468c0: 745f 6d73 6773 2c20 776f 726b 6572 5f6d  t_msgs, worker_m
-000468d0: 7367 7329 0a20 2020 2020 2020 2072 6574  sgs).        ret
-000468e0: 7572 6e20 7265 636f 6d6d 656e 6461 7469  urn recommendati
-000468f0: 6f6e 730a 0a20 2020 2064 6566 2074 7261  ons..    def tra
-00046900: 6e73 6974 696f 6e73 2873 656c 662c 2072  nsitions(self, r
-00046910: 6563 6f6d 6d65 6e64 6174 696f 6e73 3a20  ecommendations: 
-00046920: 5265 6373 2c20 7374 696d 756c 7573 5f69  Recs, stimulus_i
-00046930: 643a 2073 7472 2920 2d3e 204e 6f6e 653a  d: str) -> None:
-00046940: 0a20 2020 2020 2020 2022 2222 5072 6f63  .        """Proc
-00046950: 6573 7320 7472 616e 7369 7469 6f6e 7320  ess transitions 
-00046960: 756e 7469 6c20 6e6f 6e65 2061 7265 206c  until none are l
-00046970: 6566 740a 0a20 2020 2020 2020 2054 6869  eft..        Thi
-00046980: 7320 696e 636c 7564 6573 2066 6565 6462  s includes feedb
-00046990: 6163 6b20 6672 6f6d 2070 7265 7669 6f75  ack from previou
-000469a0: 7320 7472 616e 7369 7469 6f6e 7320 616e  s transitions an
-000469b0: 6420 636f 6e74 696e 7565 7320 756e 7469  d continues unti
-000469c0: 6c20 7765 0a20 2020 2020 2020 2072 6561  l we.        rea
-000469d0: 6368 2061 2073 7465 6164 7920 7374 6174  ch a steady stat
-000469e0: 650a 2020 2020 2020 2020 2222 220a 2020  e.        """.  
-000469f0: 2020 2020 2020 636c 6965 6e74 5f6d 7367        client_msg
-00046a00: 733a 204d 7367 7320 3d20 7b7d 0a20 2020  s: Msgs = {}.   
-00046a10: 2020 2020 2077 6f72 6b65 725f 6d73 6773       worker_msgs
-00046a20: 3a20 4d73 6773 203d 207b 7d0a 2020 2020  : Msgs = {}.    
-00046a30: 2020 2020 7365 6c66 2e5f 7472 616e 7369      self._transi
-00046a40: 7469 6f6e 7328 7265 636f 6d6d 656e 6461  tions(recommenda
-00046a50: 7469 6f6e 732c 2063 6c69 656e 745f 6d73  tions, client_ms
-00046a60: 6773 2c20 776f 726b 6572 5f6d 7367 732c  gs, worker_msgs,
-00046a70: 2073 7469 6d75 6c75 735f 6964 290a 2020   stimulus_id).  
-00046a80: 2020 2020 2020 7365 6c66 2e73 656e 645f        self.send_
-00046a90: 616c 6c28 636c 6965 6e74 5f6d 7367 732c  all(client_msgs,
-00046aa0: 2077 6f72 6b65 725f 6d73 6773 290a 0a20   worker_msgs).. 
-00046ab0: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-00046ac0: 5f73 746f 7279 2873 656c 662c 206b 6579  _story(self, key
-00046ad0: 735f 6f72 5f73 7469 6d75 6c69 3a20 4974  s_or_stimuli: It
-00046ae0: 6572 6162 6c65 5b4b 6579 207c 2073 7472  erable[Key | str
-00046af0: 5d29 202d 3e20 6c69 7374 5b54 7261 6e73  ]) -> list[Trans
-00046b00: 6974 696f 6e5d 3a0a 2020 2020 2020 2020  ition]:.        
-00046b10: 2222 2252 5043 2068 6f6f 6b20 666f 7220  """RPC hook for 
-00046b20: 3a6d 6574 683a 6053 6368 6564 756c 6572  :meth:`Scheduler
-00046b30: 5374 6174 652e 7374 6f72 7960 2e0a 0a20  State.story`... 
-00046b40: 2020 2020 2020 204e 6f74 6520 7468 6174         Note that
-00046b50: 2074 6865 206d 7367 7061 636b 2073 6572   the msgpack ser
-00046b60: 6961 6c69 7a61 7469 6f6e 2f64 6573 6572  ialization/deser
-00046b70: 6961 6c69 7a61 7469 6f6e 2072 6f75 6e64  ialization round
-00046b80: 2d74 7269 7020 7769 6c6c 2074 7261 6e73  -trip will trans
-00046b90: 666f 726d 0a20 2020 2020 2020 2074 6865  form.        the
-00046ba0: 203a 636c 6173 733a 6054 7261 6e73 6974   :class:`Transit
-00046bb0: 696f 6e60 206e 616d 6564 7475 706c 6573  ion` namedtuples
-00046bc0: 2069 6e74 6f20 7265 6775 6c61 7220 7475   into regular tu
-00046bd0: 706c 6573 2e0a 2020 2020 2020 2020 2222  ples..        ""
-00046be0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
-00046bf0: 2073 656c 662e 7374 6f72 7928 2a6b 6579   self.story(*key
-00046c00: 735f 6f72 5f73 7469 6d75 6c69 290a 0a20  s_or_stimuli).. 
-00046c10: 2020 2064 6566 205f 7265 7363 6865 6475     def _reschedu
-00046c20: 6c65 280a 2020 2020 2020 2020 7365 6c66  le(.        self
-00046c30: 2c20 6b65 793a 204b 6579 2c20 776f 726b  , key: Key, work
-00046c40: 6572 3a20 7374 7220 7c20 4e6f 6e65 203d  er: str | None =
-00046c50: 204e 6f6e 652c 202a 2c20 7374 696d 756c   None, *, stimul
-00046c60: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
-00046c70: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00046c80: 2020 2222 2252 6573 6368 6564 756c 6520    """Reschedule 
-00046c90: 6120 7461 736b 2e0a 0a20 2020 2020 2020  a task...       
-00046ca0: 2054 6869 7320 6675 6e63 7469 6f6e 2073   This function s
-00046cb0: 686f 756c 6420 6f6e 6c79 2062 6520 7573  hould only be us
-00046cc0: 6564 2077 6865 6e20 7468 6520 7461 736b  ed when the task
-00046cd0: 2068 6173 2061 6c72 6561 6479 2062 6565   has already bee
-00046ce0: 6e20 7265 6c65 6173 6564 2069 6e0a 2020  n released in.  
-00046cf0: 2020 2020 2020 736f 6d65 2077 6179 206f        some way o
-00046d00: 6e20 7468 6520 776f 726b 6572 2069 7427  n the worker it'
-00046d10: 7320 6173 7369 676e 6564 2074 6f20 e280  s assigned to ..
-00046d20: 9420 6569 7468 6572 2076 6961 2063 616e  . either via can
-00046d30: 6365 6c6c 6174 696f 6e20 6f72 2061 0a20  cellation or a. 
-00046d40: 2020 2020 2020 2052 6573 6368 6564 756c         Reschedul
-00046d50: 6520 6578 6365 7074 696f 6e20 e280 9420  e exception ... 
-00046d60: 616e 6420 796f 7520 6172 6520 6365 7274  and you are cert
-00046d70: 6169 6e20 7468 6520 776f 726b 6572 2077  ain the worker w
-00046d80: 696c 6c20 6e6f 7420 7365 6e64 2061 6e79  ill not send any
-00046d90: 2066 7572 7468 6572 0a20 2020 2020 2020   further.       
-00046da0: 2075 7064 6174 6573 2061 626f 7574 2074   updates about t
-00046db0: 6865 2074 6173 6b20 746f 2074 6865 2073  he task to the s
-00046dc0: 6368 6564 756c 6572 2e0a 2020 2020 2020  cheduler..      
-00046dd0: 2020 2222 220a 2020 2020 2020 2020 7472    """.        tr
-00046de0: 793a 0a20 2020 2020 2020 2020 2020 2074  y:.            t
-00046df0: 7320 3d20 7365 6c66 2e74 6173 6b73 5b6b  s = self.tasks[k
-00046e00: 6579 5d0a 2020 2020 2020 2020 6578 6365  ey].        exce
-00046e10: 7074 204b 6579 4572 726f 723a 0a20 2020  pt KeyError:.   
-00046e20: 2020 2020 2020 2020 206c 6f67 6765 722e           logger.
-00046e30: 7761 726e 696e 6728 0a20 2020 2020 2020  warning(.       
-00046e40: 2020 2020 2020 2020 2066 2241 7474 656d           f"Attem
-00046e50: 7074 696e 6720 746f 2072 6573 6368 6564  pting to resched
-00046e60: 756c 6520 7461 736b 207b 6b65 7921 727d  ule task {key!r}
-00046e70: 2c20 7768 6963 6820 7761 7320 6e6f 7420  , which was not 
-00046e80: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-00046e90: 2020 2266 6f75 6e64 206f 6e20 7468 6520    "found on the 
-00046ea0: 7363 6865 6475 6c65 722e 2041 626f 7274  scheduler. Abort
-00046eb0: 696e 6720 7265 7363 6865 6475 6c65 2e22  ing reschedule."
-00046ec0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
-00046ed0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00046ee0: 6e0a 2020 2020 2020 2020 6966 2074 732e  n.        if ts.
-00046ef0: 7374 6174 6520 213d 2022 7072 6f63 6573  state != "proces
-00046f00: 7369 6e67 223a 0a20 2020 2020 2020 2020  sing":.         
-00046f10: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-00046f20: 2020 6966 2077 6f72 6b65 7220 616e 6420    if worker and 
-00046f30: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-00046f40: 2061 6e64 2074 732e 7072 6f63 6573 7369   and ts.processi
-00046f50: 6e67 5f6f 6e2e 6164 6472 6573 7320 213d  ng_on.address !=
-00046f60: 2077 6f72 6b65 723a 0a20 2020 2020 2020   worker:.       
-00046f70: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
-00046f80: 2020 2020 2320 7472 616e 7369 7469 6f6e      # transition
-00046f90: 5f70 726f 6365 7373 696e 675f 7265 6c65  _processing_rele
-00046fa0: 6173 6564 2077 696c 6c20 696d 6d65 6469  ased will immedi
-00046fb0: 6174 656c 7920 7375 6767 6573 7420 616e  ately suggest an
-00046fc0: 2061 6464 6974 696f 6e61 6c0a 2020 2020   additional.    
-00046fd0: 2020 2020 2320 7472 616e 7369 7469 6f6e      # transition
-00046fe0: 2074 6f20 7761 6974 696e 6720 6966 2074   to waiting if t
-00046ff0: 6865 2074 6173 6b20 6861 7320 616e 7920  he task has any 
-00047000: 7761 6974 6572 7320 6f72 2063 6c69 656e  waiters or clien
-00047010: 7473 2068 6f6c 6469 6e67 2061 2066 7574  ts holding a fut
-00047020: 7572 652e 0a20 2020 2020 2020 2073 656c  ure..        sel
-00047030: 662e 7472 616e 7369 7469 6f6e 7328 7b6b  f.transitions({k
-00047040: 6579 3a20 2272 656c 6561 7365 6422 7d2c  ey: "released"},
-00047050: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-00047060: 6d75 6c75 735f 6964 290a 0a20 2020 2023  mulus_id)..    #
-00047070: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00047080: 2323 2323 0a20 2020 2023 2055 7469 6c69  ####.    # Utili
-00047090: 7479 2066 756e 6374 696f 6e73 2023 0a20  ty functions #. 
-000470a0: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-000470b0: 2323 2323 2323 2323 0a0a 2020 2020 6465  ########..    de
-000470c0: 6620 6164 645f 7265 736f 7572 6365 7328  f add_resources(
-000470d0: 0a20 2020 2020 2020 2073 656c 662c 2077  .        self, w
-000470e0: 6f72 6b65 723a 2073 7472 2c20 7265 736f  orker: str, reso
-000470f0: 7572 6365 733a 2064 6963 7420 7c20 4e6f  urces: dict | No
-00047100: 6e65 203d 204e 6f6e 650a 2020 2020 2920  ne = None.    ) 
-00047110: 2d3e 204c 6974 6572 616c 5b22 4f4b 225d  -> Literal["OK"]
-00047120: 3a0a 2020 2020 2020 2020 7773 203d 2073  :.        ws = s
-00047130: 656c 662e 776f 726b 6572 735b 776f 726b  elf.workers[work
-00047140: 6572 5d0a 2020 2020 2020 2020 6966 2072  er].        if r
-00047150: 6573 6f75 7263 6573 3a0a 2020 2020 2020  esources:.      
-00047160: 2020 2020 2020 7773 2e72 6573 6f75 7263        ws.resourc
-00047170: 6573 2e75 7064 6174 6528 7265 736f 7572  es.update(resour
-00047180: 6365 7329 0a20 2020 2020 2020 2077 732e  ces).        ws.
-00047190: 7573 6564 5f72 6573 6f75 7263 6573 203d  used_resources =
-000471a0: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
-000471b0: 7265 736f 7572 6365 2c20 7175 616e 7469  resource, quanti
-000471c0: 7479 2069 6e20 7773 2e72 6573 6f75 7263  ty in ws.resourc
-000471d0: 6573 2e69 7465 6d73 2829 3a0a 2020 2020  es.items():.    
-000471e0: 2020 2020 2020 2020 7773 2e75 7365 645f          ws.used_
-000471f0: 7265 736f 7572 6365 735b 7265 736f 7572  resources[resour
-00047200: 6365 5d20 3d20 300a 2020 2020 2020 2020  ce] = 0.        
-00047210: 2020 2020 6472 203d 2073 656c 662e 7265      dr = self.re
-00047220: 736f 7572 6365 732e 6765 7428 7265 736f  sources.get(reso
-00047230: 7572 6365 2c20 4e6f 6e65 290a 2020 2020  urce, None).    
-00047240: 2020 2020 2020 2020 6966 2064 7220 6973          if dr is
-00047250: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
-00047260: 2020 2020 2020 2073 656c 662e 7265 736f         self.reso
-00047270: 7572 6365 735b 7265 736f 7572 6365 5d20  urces[resource] 
-00047280: 3d20 6472 203d 207b 7d0a 2020 2020 2020  = dr = {}.      
-00047290: 2020 2020 2020 6472 5b77 6f72 6b65 725d        dr[worker]
-000472a0: 203d 2071 7561 6e74 6974 790a 2020 2020   = quantity.    
-000472b0: 2020 2020 7265 7475 726e 2022 4f4b 220a      return "OK".
-000472c0: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
-000472d0: 7265 736f 7572 6365 7328 7365 6c66 2c20  resources(self, 
-000472e0: 776f 726b 6572 3a20 7374 7229 202d 3e20  worker: str) -> 
-000472f0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7773  None:.        ws
-00047300: 203d 2073 656c 662e 776f 726b 6572 735b   = self.workers[
-00047310: 776f 726b 6572 5d0a 2020 2020 2020 2020  worker].        
-00047320: 666f 7220 7265 736f 7572 6365 2069 6e20  for resource in 
-00047330: 7773 2e72 6573 6f75 7263 6573 3a0a 2020  ws.resources:.  
-00047340: 2020 2020 2020 2020 2020 6472 203d 2073            dr = s
-00047350: 656c 662e 7265 736f 7572 6365 732e 7365  elf.resources.se
-00047360: 7464 6566 6175 6c74 2872 6573 6f75 7263  tdefault(resourc
-00047370: 652c 207b 7d29 0a20 2020 2020 2020 2020  e, {}).         
-00047380: 2020 2064 656c 2064 725b 776f 726b 6572     del dr[worker
-00047390: 5d0a 0a20 2020 2064 6566 2063 6f65 7263  ]..    def coerc
-000473a0: 655f 6164 6472 6573 7328 7365 6c66 2c20  e_address(self, 
-000473b0: 6164 6472 3a20 7374 7220 7c20 7475 706c  addr: str | tupl
-000473c0: 652c 2072 6573 6f6c 7665 3a20 626f 6f6c  e, resolve: bool
-000473d0: 203d 2054 7275 6529 202d 3e20 7374 723a   = True) -> str:
-000473e0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-000473f0: 2020 2020 2043 6f65 7263 6520 706f 7373       Coerce poss
-00047400: 6962 6c65 2069 6e70 7574 2061 6464 7265  ible input addre
-00047410: 7373 6573 2074 6f20 6361 6e6f 6e69 6361  sses to canonica
-00047420: 6c20 666f 726d 2e0a 2020 2020 2020 2020  l form..        
-00047430: 2a72 6573 6f6c 7665 2a20 6361 6e20 6265  *resolve* can be
-00047440: 2064 6973 6162 6c65 6420 666f 7220 7465   disabled for te
-00047450: 7374 696e 6720 7769 7468 2066 616b 6520  sting with fake 
-00047460: 686f 7374 6e61 6d65 732e 0a0a 2020 2020  hostnames...    
-00047470: 2020 2020 4861 6e64 6c65 7320 7374 7269      Handles stri
-00047480: 6e67 732c 2074 7570 6c65 732c 206f 7220  ngs, tuples, or 
-00047490: 616c 6961 7365 732e 0a20 2020 2020 2020  aliases..       
-000474a0: 2022 2222 0a20 2020 2020 2020 2023 2058   """.        # X
-000474b0: 5858 2068 6f77 206d 616e 7920 6164 6472  XX how many addr
-000474c0: 6573 732d 7061 7273 696e 6720 726f 7574  ess-parsing rout
-000474d0: 696e 6573 2064 6f20 7765 2068 6176 653f  ines do we have?
-000474e0: 0a20 2020 2020 2020 2069 6620 6164 6472  .        if addr
-000474f0: 2069 6e20 7365 6c66 2e61 6c69 6173 6573   in self.aliases
-00047500: 3a0a 2020 2020 2020 2020 2020 2020 6164  :.            ad
-00047510: 6472 203d 2073 656c 662e 616c 6961 7365  dr = self.aliase
-00047520: 735b 6164 6472 5d0a 2020 2020 2020 2020  s[addr].        
-00047530: 6966 2069 7369 6e73 7461 6e63 6528 6164  if isinstance(ad
-00047540: 6472 2c20 7475 706c 6529 3a0a 2020 2020  dr, tuple):.    
-00047550: 2020 2020 2020 2020 6164 6472 203d 2075          addr = u
-00047560: 6e70 6172 7365 5f68 6f73 745f 706f 7274  nparse_host_port
-00047570: 282a 6164 6472 290a 2020 2020 2020 2020  (*addr).        
-00047580: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-00047590: 6528 6164 6472 2c20 7374 7229 3a0a 2020  e(addr, str):.  
-000475a0: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-000475b0: 5479 7065 4572 726f 7228 6622 6164 6472  TypeError(f"addr
-000475c0: 6573 7365 7320 7368 6f75 6c64 2062 6520  esses should be 
-000475d0: 7374 7269 6e67 7320 6f72 2074 7570 6c65  strings or tuple
-000475e0: 732c 2067 6f74 207b 6164 6472 2172 7d22  s, got {addr!r}"
-000475f0: 290a 0a20 2020 2020 2020 2069 6620 7265  )..        if re
-00047600: 736f 6c76 653a 0a20 2020 2020 2020 2020  solve:.         
-00047610: 2020 2061 6464 7220 3d20 7265 736f 6c76     addr = resolv
-00047620: 655f 6164 6472 6573 7328 6164 6472 290a  e_address(addr).
-00047630: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00047640: 2020 2020 2020 2020 2020 6164 6472 203d            addr =
-00047650: 206e 6f72 6d61 6c69 7a65 5f61 6464 7265   normalize_addre
-00047660: 7373 2861 6464 7229 0a0a 2020 2020 2020  ss(addr)..      
-00047670: 2020 7265 7475 726e 2061 6464 720a 0a20    return addr.. 
-00047680: 2020 2064 6566 2077 6f72 6b65 7273 5f6c     def workers_l
-00047690: 6973 7428 7365 6c66 2c20 776f 726b 6572  ist(self, worker
-000476a0: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
-000476b0: 207c 204e 6f6e 6529 202d 3e20 6c69 7374   | None) -> list
-000476c0: 5b73 7472 5d3a 0a20 2020 2020 2020 2022  [str]:.        "
-000476d0: 2222 0a20 2020 2020 2020 204c 6973 7420  "".        List 
-000476e0: 6f66 2071 7561 6c69 6679 696e 6720 776f  of qualifying wo
-000476f0: 726b 6572 730a 0a20 2020 2020 2020 2054  rkers..        T
-00047700: 616b 6573 2061 206c 6973 7420 6f66 2077  akes a list of w
-00047710: 6f72 6b65 7220 6164 6472 6573 7365 7320  orker addresses 
-00047720: 6f72 2068 6f73 746e 616d 6573 2e0a 2020  or hostnames..  
-00047730: 2020 2020 2020 5265 7475 726e 7320 6120        Returns a 
-00047740: 6c69 7374 206f 6620 616c 6c20 776f 726b  list of all work
-00047750: 6572 2061 6464 7265 7373 6573 2074 6861  er addresses tha
-00047760: 7420 6d61 7463 680a 2020 2020 2020 2020  t match.        
-00047770: 2222 220a 2020 2020 2020 2020 6966 2077  """.        if w
-00047780: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
-00047790: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000477a0: 726e 206c 6973 7428 7365 6c66 2e77 6f72  rn list(self.wor
-000477b0: 6b65 7273 290a 0a20 2020 2020 2020 206f  kers)..        o
-000477c0: 7574 203d 2073 6574 2829 0a20 2020 2020  ut = set().     
-000477d0: 2020 2066 6f72 2077 2069 6e20 776f 726b     for w in work
-000477e0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-000477f0: 2069 6620 223a 2220 696e 2077 3a0a 2020   if ":" in w:.  
-00047800: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
-00047810: 742e 6164 6428 7729 0a20 2020 2020 2020  t.add(w).       
-00047820: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00047830: 2020 2020 2020 2020 2020 206f 7574 2e75             out.u
-00047840: 7064 6174 6528 7b77 7720 666f 7220 7777  pdate({ww for ww
-00047850: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
-00047860: 2069 6620 7720 696e 2077 777d 2920 2023   if w in ww})  #
-00047870: 2054 4f44 4f3a 2071 7561 6472 6174 6963   TODO: quadratic
-00047880: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00047890: 6c69 7374 286f 7574 290a 0a20 2020 2061  list(out)..    a
-000478a0: 7379 6e63 2064 6566 2067 6574 5f70 726f  sync def get_pro
-000478b0: 6669 6c65 280a 2020 2020 2020 2020 7365  file(.        se
-000478c0: 6c66 2c0a 2020 2020 2020 2020 636f 6d6d  lf,.        comm
-000478d0: 3d4e 6f6e 652c 0a20 2020 2020 2020 2077  =None,.        w
-000478e0: 6f72 6b65 7273 3d4e 6f6e 652c 0a20 2020  orkers=None,.   
-000478f0: 2020 2020 2073 6368 6564 756c 6572 3d46       scheduler=F
-00047900: 616c 7365 2c0a 2020 2020 2020 2020 7365  alse,.        se
-00047910: 7276 6572 3d46 616c 7365 2c0a 2020 2020  rver=False,.    
-00047920: 2020 2020 6d65 7267 655f 776f 726b 6572      merge_worker
-00047930: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-00047940: 7374 6172 743d 4e6f 6e65 2c0a 2020 2020  start=None,.    
-00047950: 2020 2020 7374 6f70 3d4e 6f6e 652c 0a20      stop=None,. 
-00047960: 2020 2020 2020 206b 6579 3d4e 6f6e 652c         key=None,
-00047970: 0a20 2020 2029 3a0a 2020 2020 2020 2020  .    ):.        
-00047980: 6966 2077 6f72 6b65 7273 2069 7320 4e6f  if workers is No
-00047990: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
-000479a0: 776f 726b 6572 7320 3d20 7365 6c66 2e77  workers = self.w
-000479b0: 6f72 6b65 7273 0a20 2020 2020 2020 2065  orkers.        e
-000479c0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-000479d0: 2077 6f72 6b65 7273 203d 2073 6574 2873   workers = set(s
-000479e0: 656c 662e 776f 726b 6572 7329 2026 2073  elf.workers) & s
-000479f0: 6574 2877 6f72 6b65 7273 290a 0a20 2020  et(workers)..   
-00047a00: 2020 2020 2069 6620 7363 6865 6475 6c65       if schedule
-00047a10: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
-00047a20: 6574 7572 6e20 7072 6f66 696c 652e 6765  eturn profile.ge
-00047a30: 745f 7072 6f66 696c 6528 7365 6c66 2e69  t_profile(self.i
-00047a40: 6f5f 6c6f 6f70 2e70 726f 6669 6c65 2c20  o_loop.profile, 
-00047a50: 7374 6172 743d 7374 6172 742c 2073 746f  start=start, sto
-00047a60: 703d 7374 6f70 290a 0a20 2020 2020 2020  p=stop)..       
-00047a70: 2072 6573 756c 7473 203d 2061 7761 6974   results = await
-00047a80: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-00047a90: 0a20 2020 2020 2020 2020 2020 202a 280a  .            *(.
-00047aa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00047ab0: 7365 6c66 2e72 7063 2877 292e 7072 6f66  self.rpc(w).prof
-00047ac0: 696c 6528 7374 6172 743d 7374 6172 742c  ile(start=start,
-00047ad0: 2073 746f 703d 7374 6f70 2c20 6b65 793d   stop=stop, key=
-00047ae0: 6b65 792c 2073 6572 7665 723d 7365 7276  key, server=serv
-00047af0: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
-00047b00: 2020 2020 666f 7220 7720 696e 2077 6f72      for w in wor
-00047b10: 6b65 7273 0a20 2020 2020 2020 2020 2020  kers.           
-00047b20: 2029 2c0a 2020 2020 2020 2020 2020 2020   ),.            
-00047b30: 7265 7475 726e 5f65 7863 6570 7469 6f6e  return_exception
-00047b40: 733d 5472 7565 2c0a 2020 2020 2020 2020  s=True,.        
-00047b50: 290a 0a20 2020 2020 2020 2072 6573 756c  )..        resul
-00047b60: 7473 203d 205b 7220 666f 7220 7220 696e  ts = [r for r in
-00047b70: 2072 6573 756c 7473 2069 6620 6e6f 7420   results if not 
-00047b80: 6973 696e 7374 616e 6365 2872 2c20 4578  isinstance(r, Ex
-00047b90: 6365 7074 696f 6e29 5d0a 0a20 2020 2020  ception)]..     
-00047ba0: 2020 2069 6620 6d65 7267 655f 776f 726b     if merge_work
-00047bb0: 6572 733a 0a20 2020 2020 2020 2020 2020  ers:.           
-00047bc0: 2072 6573 706f 6e73 6520 3d20 7072 6f66   response = prof
-00047bd0: 696c 652e 6d65 7267 6528 2a72 6573 756c  ile.merge(*resul
-00047be0: 7473 290a 2020 2020 2020 2020 656c 7365  ts).        else
-00047bf0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00047c00: 7370 6f6e 7365 203d 2064 6963 7428 7a69  sponse = dict(zi
-00047c10: 7028 776f 726b 6572 732c 2072 6573 756c  p(workers, resul
-00047c20: 7473 2929 0a20 2020 2020 2020 2072 6574  ts)).        ret
-00047c30: 7572 6e20 7265 7370 6f6e 7365 0a0a 2020  urn response..  
-00047c40: 2020 6173 796e 6320 6465 6620 6765 745f    async def get_
-00047c50: 7072 6f66 696c 655f 6d65 7461 6461 7461  profile_metadata
-00047c60: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
-00047c70: 2020 2020 2020 2020 776f 726b 6572 733a          workers:
-00047c80: 2049 7465 7261 626c 655b 7374 725d 207c   Iterable[str] |
-00047c90: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
-00047ca0: 2020 2020 2020 7374 6172 743a 2066 6c6f        start: flo
-00047cb0: 6174 203d 2030 2c0a 2020 2020 2020 2020  at = 0,.        
-00047cc0: 7374 6f70 3a20 666c 6f61 7420 7c20 4e6f  stop: float | No
-00047cd0: 6e65 203d 204e 6f6e 652c 0a20 2020 2020  ne = None,.     
-00047ce0: 2020 2070 726f 6669 6c65 5f63 7963 6c65     profile_cycle
-00047cf0: 5f69 6e74 6572 7661 6c3a 2073 7472 207c  _interval: str |
-00047d00: 2066 6c6f 6174 207c 204e 6f6e 6520 3d20   float | None = 
-00047d10: 4e6f 6e65 2c0a 2020 2020 2920 2d3e 2064  None,.    ) -> d
-00047d20: 6963 745b 7374 722c 2041 6e79 5d3a 0a20  ict[str, Any]:. 
-00047d30: 2020 2020 2020 2064 7420 3d20 7072 6f66         dt = prof
-00047d40: 696c 655f 6379 636c 655f 696e 7465 7276  ile_cycle_interv
-00047d50: 616c 206f 7220 6461 736b 2e63 6f6e 6669  al or dask.confi
-00047d60: 672e 6765 7428 0a20 2020 2020 2020 2020  g.get(.         
-00047d70: 2020 2022 6469 7374 7269 6275 7465 642e     "distributed.
-00047d80: 776f 726b 6572 2e70 726f 6669 6c65 2e63  worker.profile.c
-00047d90: 7963 6c65 220a 2020 2020 2020 2020 290a  ycle".        ).
-00047da0: 2020 2020 2020 2020 6474 203d 2070 6172          dt = par
-00047db0: 7365 5f74 696d 6564 656c 7461 2864 742c  se_timedelta(dt,
-00047dc0: 2064 6566 6175 6c74 3d22 6d73 2229 0a0a   default="ms")..
-00047dd0: 2020 2020 2020 2020 6966 2077 6f72 6b65          if worke
-00047de0: 7273 2069 7320 4e6f 6e65 3a0a 2020 2020  rs is None:.    
-00047df0: 2020 2020 2020 2020 776f 726b 6572 7320          workers 
-00047e00: 3d20 7365 6c66 2e77 6f72 6b65 7273 0a20  = self.workers. 
-00047e10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00047e20: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
-00047e30: 203d 2073 6574 2873 656c 662e 776f 726b   = set(self.work
-00047e40: 6572 7329 2026 2073 6574 2877 6f72 6b65  ers) & set(worke
-00047e50: 7273 290a 2020 2020 2020 2020 7265 7375  rs).        resu
-00047e60: 6c74 733a 2053 6571 7565 6e63 655b 416e  lts: Sequence[An
-00047e70: 795d 203d 2061 7761 6974 2061 7379 6e63  y] = await async
-00047e80: 696f 2e67 6174 6865 7228 0a20 2020 2020  io.gather(.     
-00047e90: 2020 2020 2020 202a 2873 656c 662e 7270         *(self.rp
-00047ea0: 6328 7729 2e70 726f 6669 6c65 5f6d 6574  c(w).profile_met
-00047eb0: 6164 6174 6128 7374 6172 743d 7374 6172  adata(start=star
-00047ec0: 742c 2073 746f 703d 7374 6f70 2920 666f  t, stop=stop) fo
-00047ed0: 7220 7720 696e 2077 6f72 6b65 7273 292c  r w in workers),
-00047ee0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00047ef0: 7572 6e5f 6578 6365 7074 696f 6e73 3d54  urn_exceptions=T
-00047f00: 7275 652c 0a20 2020 2020 2020 2029 0a0a  rue,.        )..
-00047f10: 2020 2020 2020 2020 7265 7375 6c74 7320          results 
-00047f20: 3d20 5b72 2066 6f72 2072 2069 6e20 7265  = [r for r in re
-00047f30: 7375 6c74 7320 6966 206e 6f74 2069 7369  sults if not isi
-00047f40: 6e73 7461 6e63 6528 722c 2045 7863 6570  nstance(r, Excep
-00047f50: 7469 6f6e 295d 0a20 2020 2020 2020 2063  tion)].        c
-00047f60: 6f75 6e74 7320 3d20 5b0a 2020 2020 2020  ounts = [.      
-00047f70: 2020 2020 2020 2874 696d 652c 2073 756d        (time, sum
-00047f80: 2870 6c75 636b 2831 2c20 6772 6f75 7029  (pluck(1, group)
-00047f90: 2929 0a20 2020 2020 2020 2020 2020 2066  )).            f
-00047fa0: 6f72 2074 696d 652c 2067 726f 7570 2069  or time, group i
-00047fb0: 6e20 6974 6572 746f 6f6c 732e 6772 6f75  n itertools.grou
-00047fc0: 7062 7928 0a20 2020 2020 2020 2020 2020  pby(.           
-00047fd0: 2020 2020 206d 6572 6765 5f73 6f72 7465       merge_sorte
-00047fe0: 6428 0a20 2020 2020 2020 2020 2020 2020  d(.             
-00047ff0: 2020 2020 2020 202a 2876 5b22 636f 756e         *(v["coun
-00048000: 7473 225d 2066 6f72 2076 2069 6e20 7265  ts"] for v in re
-00048010: 7375 6c74 7329 2c0a 2020 2020 2020 2020  sults),.        
-00048020: 2020 2020 2020 2020 292c 0a20 2020 2020          ),.     
-00048030: 2020 2020 2020 2020 2020 206c 616d 6264             lambd
-00048040: 6120 743a 2074 5b30 5d20 2f2f 2064 7420  a t: t[0] // dt 
-00048050: 2a20 6474 2c0a 2020 2020 2020 2020 2020  * dt,.          
-00048060: 2020 290a 2020 2020 2020 2020 5d0a 0a20    ).        ].. 
-00048070: 2020 2020 2020 206b 6579 733a 2064 6963         keys: dic
-00048080: 745b 4b65 792c 206c 6973 745b 6c69 7374  t[Key, list[list
-00048090: 5d5d 203d 207b 0a20 2020 2020 2020 2020  ]] = {.         
-000480a0: 2020 206b 3a20 5b5d 2066 6f72 2076 2069     k: [] for v i
-000480b0: 6e20 7265 7375 6c74 7320 666f 7220 742c  n results for t,
-000480c0: 2064 2069 6e20 765b 226b 6579 7322 5d20   d in v["keys"] 
-000480d0: 666f 7220 6b20 696e 2064 0a20 2020 2020  for k in d.     
-000480e0: 2020 207d 0a0a 2020 2020 2020 2020 6772     }..        gr
-000480f0: 6f75 7073 3120 3d20 5b76 5b22 6b65 7973  oups1 = [v["keys
-00048100: 225d 2066 6f72 2076 2069 6e20 7265 7375  "] for v in resu
-00048110: 6c74 735d 0a20 2020 2020 2020 2067 726f  lts].        gro
-00048120: 7570 7332 203d 206c 6973 7428 6d65 7267  ups2 = list(merg
-00048130: 655f 736f 7274 6564 282a 6772 6f75 7073  e_sorted(*groups
-00048140: 312c 206b 6579 3d66 6972 7374 2929 0a0a  1, key=first))..
-00048150: 2020 2020 2020 2020 6c61 7374 203d 2030          last = 0
-00048160: 0a20 2020 2020 2020 2066 6f72 2074 2c20  .        for t, 
-00048170: 6420 696e 2067 726f 7570 7332 3a0a 2020  d in groups2:.  
-00048180: 2020 2020 2020 2020 2020 7474 203d 2074            tt = t
-00048190: 202f 2f20 6474 202a 2064 740a 2020 2020   // dt * dt.    
-000481a0: 2020 2020 2020 2020 6966 2074 7420 3e20          if tt > 
-000481b0: 6c61 7374 3a0a 2020 2020 2020 2020 2020  last:.          
-000481c0: 2020 2020 2020 6c61 7374 203d 2074 740a        last = tt.
-000481d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000481e0: 666f 7220 7620 696e 206b 6579 732e 7661  for v in keys.va
-000481f0: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
-00048200: 2020 2020 2020 2020 2020 2020 762e 6170              v.ap
-00048210: 7065 6e64 285b 7474 2c20 305d 290a 2020  pend([tt, 0]).  
-00048220: 2020 2020 2020 2020 2020 666f 7220 6b2c            for k,
-00048230: 2076 2069 6e20 642e 6974 656d 7328 293a   v in d.items():
-00048240: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00048250: 206b 6579 735b 6b5d 5b2d 315d 5b31 5d20   keys[k][-1][1] 
-00048260: 2b3d 2076 0a0a 2020 2020 2020 2020 7265  += v..        re
-00048270: 7475 726e 207b 2263 6f75 6e74 7322 3a20  turn {"counts": 
-00048280: 636f 756e 7473 2c20 226b 6579 7322 3a20  counts, "keys": 
-00048290: 6b65 7973 7d0a 0a20 2020 2061 7379 6e63  keys}..    async
-000482a0: 2064 6566 2070 6572 666f 726d 616e 6365   def performance
-000482b0: 5f72 6570 6f72 7428 0a20 2020 2020 2020  _report(.       
-000482c0: 2073 656c 662c 2073 7461 7274 3a20 666c   self, start: fl
-000482d0: 6f61 742c 206c 6173 745f 636f 756e 743a  oat, last_count:
-000482e0: 2069 6e74 2c20 636f 6465 3a20 7374 7220   int, code: str 
-000482f0: 3d20 2222 2c20 6d6f 6465 3a20 7374 7220  = "", mode: str 
-00048300: 7c20 4e6f 6e65 203d 204e 6f6e 650a 2020  | None = None.  
-00048310: 2020 2920 2d3e 2073 7472 3a0a 2020 2020    ) -> str:.    
-00048320: 2020 2020 7374 6f70 203d 2074 696d 6528      stop = time(
-00048330: 290a 2020 2020 2020 2020 2320 5072 6f66  ).        # Prof
-00048340: 696c 6573 0a20 2020 2020 2020 2063 6f6d  iles.        com
-00048350: 7075 7465 2c20 7363 6865 6475 6c65 722c  pute, scheduler,
-00048360: 2077 6f72 6b65 7273 203d 2061 7761 6974   workers = await
-00048370: 2061 7379 6e63 696f 2e67 6174 6865 7228   asyncio.gather(
-00048380: 0a20 2020 2020 2020 2020 2020 202a 5b0a  .            *[.
-00048390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000483a0: 7365 6c66 2e67 6574 5f70 726f 6669 6c65  self.get_profile
-000483b0: 2873 7461 7274 3d73 7461 7274 292c 0a20  (start=start),. 
-000483c0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000483d0: 656c 662e 6765 745f 7072 6f66 696c 6528  elf.get_profile(
-000483e0: 7363 6865 6475 6c65 723d 5472 7565 2c20  scheduler=True, 
-000483f0: 7374 6172 743d 7374 6172 7429 2c0a 2020  start=start),.  
-00048400: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00048410: 6c66 2e67 6574 5f70 726f 6669 6c65 2873  lf.get_profile(s
-00048420: 6572 7665 723d 5472 7565 2c20 7374 6172  erver=True, star
-00048430: 743d 7374 6172 7429 2c0a 2020 2020 2020  t=start),.      
-00048440: 2020 2020 2020 5d0a 2020 2020 2020 2020        ].        
-00048450: 290a 2020 2020 2020 2020 6672 6f6d 2064  ).        from d
-00048460: 6973 7472 6962 7574 6564 2069 6d70 6f72  istributed impor
-00048470: 7420 7072 6f66 696c 650a 0a20 2020 2020  t profile..     
-00048480: 2020 2064 6566 2070 726f 6669 6c65 5f74     def profile_t
-00048490: 6f5f 6669 6775 7265 2873 7461 7465 293a  o_figure(state):
-000484a0: 0a20 2020 2020 2020 2020 2020 2064 6174  .            dat
-000484b0: 6120 3d20 7072 6f66 696c 652e 706c 6f74  a = profile.plot
-000484c0: 5f64 6174 6128 7374 6174 6529 0a20 2020  _data(state).   
-000484d0: 2020 2020 2020 2020 2066 6967 7572 652c           figure,
-000484e0: 2073 6f75 7263 6520 3d20 7072 6f66 696c   source = profil
-000484f0: 652e 706c 6f74 5f66 6967 7572 6528 6461  e.plot_figure(da
-00048500: 7461 2c20 7369 7a69 6e67 5f6d 6f64 653d  ta, sizing_mode=
-00048510: 2273 7472 6574 6368 5f62 6f74 6822 290a  "stretch_both").
-00048520: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00048530: 726e 2066 6967 7572 650a 0a20 2020 2020  rn figure..     
-00048540: 2020 2063 6f6d 7075 7465 2c20 7363 6865     compute, sche
-00048550: 6475 6c65 722c 2077 6f72 6b65 7273 203d  duler, workers =
-00048560: 206d 6170 280a 2020 2020 2020 2020 2020   map(.          
-00048570: 2020 7072 6f66 696c 655f 746f 5f66 6967    profile_to_fig
-00048580: 7572 652c 2028 636f 6d70 7574 652c 2073  ure, (compute, s
-00048590: 6368 6564 756c 6572 2c20 776f 726b 6572  cheduler, worker
-000485a0: 7329 0a20 2020 2020 2020 2029 0a0a 2020  s).        )..  
-000485b0: 2020 2020 2020 2320 5461 736b 2073 7472        # Task str
-000485c0: 6561 6d0a 2020 2020 2020 2020 7461 736b  eam.        task
-000485d0: 5f73 7472 6561 6d20 3d20 7365 6c66 2e67  _stream = self.g
-000485e0: 6574 5f74 6173 6b5f 7374 7265 616d 2873  et_task_stream(s
-000485f0: 7461 7274 3d73 7461 7274 290a 2020 2020  tart=start).    
-00048600: 2020 2020 746f 7461 6c5f 7461 736b 7320      total_tasks 
-00048610: 3d20 6c65 6e28 7461 736b 5f73 7472 6561  = len(task_strea
-00048620: 6d29 0a20 2020 2020 2020 2074 696d 6573  m).        times
-00048630: 7065 6e74 3a20 6465 6661 756c 7464 6963  pent: defaultdic
-00048640: 745b 7374 722c 2066 6c6f 6174 5d20 3d20  t[str, float] = 
-00048650: 6465 6661 756c 7464 6963 7428 666c 6f61  defaultdict(floa
-00048660: 7429 0a20 2020 2020 2020 2066 6f72 2064  t).        for d
-00048670: 2069 6e20 7461 736b 5f73 7472 6561 6d3a   in task_stream:
-00048680: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00048690: 2078 2069 6e20 645b 2273 7461 7274 7374   x in d["startst
-000486a0: 6f70 7322 5d3a 0a20 2020 2020 2020 2020  ops"]:.         
-000486b0: 2020 2020 2020 2074 696d 6573 7065 6e74         timespent
-000486c0: 5b78 5b22 6163 7469 6f6e 225d 5d20 2b3d  [x["action"]] +=
-000486d0: 2078 5b22 7374 6f70 225d 202d 2078 5b22   x["stop"] - x["
-000486e0: 7374 6172 7422 5d0a 2020 2020 2020 2020  start"].        
-000486f0: 7461 736b 735f 7469 6d69 6e67 7320 3d20  tasks_timings = 
-00048700: 2222 0a20 2020 2020 2020 2066 6f72 206b  "".        for k
-00048710: 2069 6e20 736f 7274 6564 2874 696d 6573   in sorted(times
-00048720: 7065 6e74 2e6b 6579 7328 2929 3a0a 2020  pent.keys()):.  
-00048730: 2020 2020 2020 2020 2020 7461 736b 735f            tasks_
-00048740: 7469 6d69 6e67 7320 2b3d 2066 225c 6e3c  timings += f"\n<
-00048750: 6c69 3e20 7b6b 7d20 7469 6d65 3a20 7b66  li> {k} time: {f
-00048760: 6f72 6d61 745f 7469 6d65 2874 696d 6573  ormat_time(times
-00048770: 7065 6e74 5b6b 5d29 7d20 3c2f 6c69 3e22  pent[k])} </li>"
-00048780: 0a0a 2020 2020 2020 2020 6672 6f6d 2064  ..        from d
-00048790: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
-000487a0: 6f61 7264 2e63 6f6d 706f 6e65 6e74 732e  oard.components.
-000487b0: 7363 6865 6475 6c65 7220 696d 706f 7274  scheduler import
-000487c0: 2074 6173 6b5f 7374 7265 616d 5f66 6967   task_stream_fig
-000487d0: 7572 650a 2020 2020 2020 2020 6672 6f6d  ure.        from
-000487e0: 2064 6973 7472 6962 7574 6564 2e64 6961   distributed.dia
-000487f0: 676e 6f73 7469 6373 2e74 6173 6b5f 7374  gnostics.task_st
-00048800: 7265 616d 2069 6d70 6f72 7420 7265 6374  ream import rect
-00048810: 616e 676c 6573 0a0a 2020 2020 2020 2020  angles..        
-00048820: 7265 6374 7320 3d20 7265 6374 616e 676c  rects = rectangl
-00048830: 6573 2874 6173 6b5f 7374 7265 616d 290a  es(task_stream).
-00048840: 2020 2020 2020 2020 736f 7572 6365 2c20          source, 
-00048850: 7461 736b 5f73 7472 6561 6d20 3d20 7461  task_stream = ta
-00048860: 736b 5f73 7472 6561 6d5f 6669 6775 7265  sk_stream_figure
-00048870: 2873 697a 696e 675f 6d6f 6465 3d22 7374  (sizing_mode="st
-00048880: 7265 7463 685f 626f 7468 2229 0a20 2020  retch_both").   
-00048890: 2020 2020 2073 6f75 7263 652e 6461 7461       source.data
-000488a0: 2e75 7064 6174 6528 7265 6374 7329 0a0a  .update(rects)..
-000488b0: 2020 2020 2020 2020 2320 4261 6e64 7769          # Bandwi
-000488c0: 6474 680a 2020 2020 2020 2020 6672 6f6d  dth.        from
-000488d0: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
-000488e0: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
-000488f0: 732e 7363 6865 6475 6c65 7220 696d 706f  s.scheduler impo
-00048900: 7274 2028 0a20 2020 2020 2020 2020 2020  rt (.           
-00048910: 2042 616e 6477 6964 7468 5479 7065 732c   BandwidthTypes,
-00048920: 0a20 2020 2020 2020 2020 2020 2042 616e  .            Ban
-00048930: 6477 6964 7468 576f 726b 6572 732c 0a20  dwidthWorkers,. 
-00048940: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-00048950: 2020 6261 6e64 7769 6474 685f 776f 726b    bandwidth_work
-00048960: 6572 7320 3d20 4261 6e64 7769 6474 6857  ers = BandwidthW
-00048970: 6f72 6b65 7273 2873 656c 662c 2073 697a  orkers(self, siz
-00048980: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
-00048990: 685f 626f 7468 2229 0a20 2020 2020 2020  h_both").       
-000489a0: 2062 616e 6477 6964 7468 5f77 6f72 6b65   bandwidth_worke
-000489b0: 7273 2e75 7064 6174 6528 290a 2020 2020  rs.update().    
-000489c0: 2020 2020 6261 6e64 7769 6474 685f 7479      bandwidth_ty
-000489d0: 7065 7320 3d20 4261 6e64 7769 6474 6854  pes = BandwidthT
-000489e0: 7970 6573 2873 656c 662c 2073 697a 696e  ypes(self, sizin
-000489f0: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
-00048a00: 626f 7468 2229 0a20 2020 2020 2020 2062  both").        b
-00048a10: 616e 6477 6964 7468 5f74 7970 6573 2e75  andwidth_types.u
-00048a20: 7064 6174 6528 290a 0a20 2020 2020 2020  pdate()..       
-00048a30: 2023 2053 7973 7465 6d20 6d6f 6e69 746f   # System monito
-00048a40: 720a 2020 2020 2020 2020 6672 6f6d 2064  r.        from d
-00048a50: 6973 7472 6962 7574 6564 2e64 6173 6862  istributed.dashb
-00048a60: 6f61 7264 2e63 6f6d 706f 6e65 6e74 732e  oard.components.
-00048a70: 7368 6172 6564 2069 6d70 6f72 7420 5379  shared import Sy
-00048a80: 7374 656d 4d6f 6e69 746f 720a 0a20 2020  stemMonitor..   
-00048a90: 2020 2020 2073 7973 6d6f 6e20 3d20 5379       sysmon = Sy
-00048aa0: 7374 656d 4d6f 6e69 746f 7228 7365 6c66  stemMonitor(self
-00048ab0: 2c20 6c61 7374 5f63 6f75 6e74 3d6c 6173  , last_count=las
-00048ac0: 745f 636f 756e 742c 2073 697a 696e 675f  t_count, sizing_
-00048ad0: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-00048ae0: 7468 2229 0a20 2020 2020 2020 2073 7973  th").        sys
-00048af0: 6d6f 6e2e 7570 6461 7465 2829 0a0a 2020  mon.update()..  
-00048b00: 2020 2020 2020 2320 5363 6865 6475 6c65        # Schedule
-00048b10: 7220 6c6f 6773 0a20 2020 2020 2020 2066  r logs.        f
-00048b20: 726f 6d20 6469 7374 7269 6275 7465 642e  rom distributed.
-00048b30: 6461 7368 626f 6172 642e 636f 6d70 6f6e  dashboard.compon
-00048b40: 656e 7473 2e73 6368 6564 756c 6572 2069  ents.scheduler i
-00048b50: 6d70 6f72 7420 280a 2020 2020 2020 2020  mport (.        
-00048b60: 2020 2020 5f42 4f4b 4548 5f53 5459 4c45      _BOKEH_STYLE
-00048b70: 535f 4b57 4152 4753 2c0a 2020 2020 2020  S_KWARGS,.      
-00048b80: 2020 2020 2020 5363 6865 6475 6c65 724c        SchedulerL
-00048b90: 6f67 732c 0a20 2020 2020 2020 2029 0a0a  ogs,.        )..
-00048ba0: 2020 2020 2020 2020 6c6f 6773 203d 2053          logs = S
-00048bb0: 6368 6564 756c 6572 4c6f 6773 2873 656c  chedulerLogs(sel
-00048bc0: 662c 2073 7461 7274 3d73 7461 7274 290a  f, start=start).
-00048bd0: 0a20 2020 2020 2020 2066 726f 6d20 626f  .        from bo
-00048be0: 6b65 682e 6d6f 6465 6c73 2069 6d70 6f72  keh.models impor
-00048bf0: 7420 4469 762c 2054 6162 730a 0a20 2020  t Div, Tabs..   
-00048c00: 2020 2020 2069 6d70 6f72 7420 6469 7374       import dist
-00048c10: 7269 6275 7465 640a 2020 2020 2020 2020  ributed.        
-00048c20: 6672 6f6d 2064 6973 7472 6962 7574 6564  from distributed
-00048c30: 2e64 6173 6862 6f61 7264 2e63 6f72 6520  .dashboard.core 
-00048c40: 696d 706f 7274 2054 6162 5061 6e65 6c0a  import TabPanel.
-00048c50: 0a20 2020 2020 2020 2023 2048 544d 4c0a  .        # HTML.
-00048c60: 2020 2020 2020 2020 6874 6d6c 203d 2022          html = "
-00048c70: 2222 0a20 2020 2020 2020 203c 6831 3e20  "".        <h1> 
-00048c80: 4461 736b 2050 6572 666f 726d 616e 6365  Dask Performance
-00048c90: 2052 6570 6f72 7420 3c2f 6831 3e0a 0a20   Report </h1>.. 
-00048ca0: 2020 2020 2020 203c 693e 2053 656c 6563         <i> Selec
-00048cb0: 7420 6469 6666 6572 656e 7420 7461 6273  t different tabs
-00048cc0: 206f 6e20 7468 6520 746f 7020 666f 7220   on the top for 
-00048cd0: 6164 6469 7469 6f6e 616c 2069 6e66 6f72  additional infor
-00048ce0: 6d61 7469 6f6e 203c 2f69 3e0a 0a20 2020  mation </i>..   
-00048cf0: 2020 2020 203c 6832 3e20 4475 7261 7469       <h2> Durati
-00048d00: 6f6e 3a20 7b74 696d 657d 203c 2f68 323e  on: {time} </h2>
-00048d10: 0a20 2020 2020 2020 203c 6832 3e20 5461  .        <h2> Ta
-00048d20: 736b 7320 496e 666f 726d 6174 696f 6e20  sks Information 
-00048d30: 3c2f 6832 3e0a 2020 2020 2020 2020 3c75  </h2>.        <u
-00048d40: 6c3e 0a20 2020 2020 2020 2020 3c6c 693e  l>.         <li>
-00048d50: 206e 756d 6265 7220 6f66 2074 6173 6b73   number of tasks
-00048d60: 3a20 7b6e 7461 736b 737d 203c 2f6c 693e  : {ntasks} </li>
-00048d70: 0a20 2020 2020 2020 2020 7b74 6173 6b73  .         {tasks
-00048d80: 5f74 696d 696e 6773 7d0a 2020 2020 2020  _timings}.      
-00048d90: 2020 3c2f 756c 3e0a 0a20 2020 2020 2020    </ul>..       
-00048da0: 203c 6832 3e20 5363 6865 6475 6c65 7220   <h2> Scheduler 
-00048db0: 496e 666f 726d 6174 696f 6e20 3c2f 6832  Information </h2
-00048dc0: 3e0a 2020 2020 2020 2020 3c75 6c3e 0a20  >.        <ul>. 
-00048dd0: 2020 2020 2020 2020 203c 6c69 3e20 4164           <li> Ad
-00048de0: 6472 6573 733a 207b 6164 6472 6573 737d  dress: {address}
-00048df0: 203c 2f6c 693e 0a20 2020 2020 2020 2020   </li>.         
-00048e00: 203c 6c69 3e20 576f 726b 6572 733a 207b   <li> Workers: {
-00048e10: 6e77 6f72 6b65 7273 7d20 3c2f 6c69 3e0a  nworkers} </li>.
-00048e20: 2020 2020 2020 2020 2020 3c6c 693e 2054            <li> T
-00048e30: 6872 6561 6473 3a20 7b74 6872 6561 6473  hreads: {threads
-00048e40: 7d20 3c2f 6c69 3e0a 2020 2020 2020 2020  } </li>.        
-00048e50: 2020 3c6c 693e 204d 656d 6f72 793a 207b    <li> Memory: {
-00048e60: 6d65 6d6f 7279 7d20 3c2f 6c69 3e0a 2020  memory} </li>.  
-00048e70: 2020 2020 2020 2020 3c6c 693e 2044 6173          <li> Das
-00048e80: 6b20 5665 7273 696f 6e3a 207b 6461 736b  k Version: {dask
-00048e90: 5f76 6572 7369 6f6e 7d20 3c2f 6c69 3e0a  _version} </li>.
-00048ea0: 2020 2020 2020 2020 2020 3c6c 693e 2044            <li> D
-00048eb0: 6173 6b2e 4469 7374 7269 6275 7465 6420  ask.Distributed 
-00048ec0: 5665 7273 696f 6e3a 207b 6469 7374 7269  Version: {distri
-00048ed0: 6275 7465 645f 7665 7273 696f 6e7d 203c  buted_version} <
-00048ee0: 2f6c 693e 0a20 2020 2020 2020 203c 2f75  /li>.        </u
-00048ef0: 6c3e 0a0a 2020 2020 2020 2020 3c68 323e  l>..        <h2>
-00048f00: 2043 616c 6c69 6e67 2043 6f64 6520 3c2f   Calling Code </
-00048f10: 6832 3e0a 2020 2020 2020 2020 3c70 7265  h2>.        <pre
-00048f20: 3e0a 7b63 6f64 657d 0a20 2020 2020 2020  >.{code}.       
-00048f30: 203c 2f70 7265 3e0a 2020 2020 2020 2020   </pre>.        
-00048f40: 2222 222e 666f 726d 6174 280a 2020 2020  """.format(.    
-00048f50: 2020 2020 2020 2020 7469 6d65 3d66 6f72          time=for
-00048f60: 6d61 745f 7469 6d65 2873 746f 7020 2d20  mat_time(stop - 
-00048f70: 7374 6172 7429 2c0a 2020 2020 2020 2020  start),.        
-00048f80: 2020 2020 6e74 6173 6b73 3d74 6f74 616c      ntasks=total
-00048f90: 5f74 6173 6b73 2c0a 2020 2020 2020 2020  _tasks,.        
-00048fa0: 2020 2020 7461 736b 735f 7469 6d69 6e67      tasks_timing
-00048fb0: 733d 7461 736b 735f 7469 6d69 6e67 732c  s=tasks_timings,
-00048fc0: 0a20 2020 2020 2020 2020 2020 2061 6464  .            add
-00048fd0: 7265 7373 3d73 656c 662e 6164 6472 6573  ress=self.addres
-00048fe0: 732c 0a20 2020 2020 2020 2020 2020 206e  s,.            n
-00048ff0: 776f 726b 6572 733d 6c65 6e28 7365 6c66  workers=len(self
-00049000: 2e77 6f72 6b65 7273 292c 0a20 2020 2020  .workers),.     
-00049010: 2020 2020 2020 2074 6872 6561 6473 3d73         threads=s
-00049020: 756d 2877 732e 6e74 6872 6561 6473 2066  um(ws.nthreads f
-00049030: 6f72 2077 7320 696e 2073 656c 662e 776f  or ws in self.wo
-00049040: 726b 6572 732e 7661 6c75 6573 2829 292c  rkers.values()),
-00049050: 0a20 2020 2020 2020 2020 2020 206d 656d  .            mem
-00049060: 6f72 793d 666f 726d 6174 5f62 7974 6573  ory=format_bytes
-00049070: 2873 756d 2877 732e 6d65 6d6f 7279 5f6c  (sum(ws.memory_l
-00049080: 696d 6974 2066 6f72 2077 7320 696e 2073  imit for ws in s
-00049090: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
-000490a0: 6573 2829 2929 2c0a 2020 2020 2020 2020  es())),.        
-000490b0: 2020 2020 636f 6465 3d63 6f64 652c 0a20      code=code,. 
-000490c0: 2020 2020 2020 2020 2020 2064 6173 6b5f             dask_
-000490d0: 7665 7273 696f 6e3d 6461 736b 2e5f 5f76  version=dask.__v
-000490e0: 6572 7369 6f6e 5f5f 2c0a 2020 2020 2020  ersion__,.      
-000490f0: 2020 2020 2020 6469 7374 7269 6275 7465        distribute
-00049100: 645f 7665 7273 696f 6e3d 6469 7374 7269  d_version=distri
-00049110: 6275 7465 642e 5f5f 7665 7273 696f 6e5f  buted.__version_
-00049120: 5f2c 0a20 2020 2020 2020 2029 0a20 2020  _,.        ).   
-00049130: 2020 2020 2068 746d 6c20 3d20 4469 7628       html = Div(
-00049140: 7465 7874 3d68 746d 6c2c 202a 2a5f 424f  text=html, **_BO
-00049150: 4b45 485f 5354 594c 4553 5f4b 5741 5247  KEH_STYLES_KWARG
-00049160: 5329 0a0a 2020 2020 2020 2020 6874 6d6c  S)..        html
-00049170: 203d 2054 6162 5061 6e65 6c28 6368 696c   = TabPanel(chil
-00049180: 643d 6874 6d6c 2c20 7469 746c 653d 2253  d=html, title="S
-00049190: 756d 6d61 7279 2229 0a20 2020 2020 2020  ummary").       
-000491a0: 2063 6f6d 7075 7465 203d 2054 6162 5061   compute = TabPa
-000491b0: 6e65 6c28 6368 696c 643d 636f 6d70 7574  nel(child=comput
-000491c0: 652c 2074 6974 6c65 3d22 576f 726b 6572  e, title="Worker
-000491d0: 2050 726f 6669 6c65 2028 636f 6d70 7574   Profile (comput
-000491e0: 6529 2229 0a20 2020 2020 2020 2077 6f72  e)").        wor
-000491f0: 6b65 7273 203d 2054 6162 5061 6e65 6c28  kers = TabPanel(
-00049200: 6368 696c 643d 776f 726b 6572 732c 2074  child=workers, t
-00049210: 6974 6c65 3d22 576f 726b 6572 2050 726f  itle="Worker Pro
-00049220: 6669 6c65 2028 6164 6d69 6e69 7374 7261  file (administra
-00049230: 7469 7665 2922 290a 2020 2020 2020 2020  tive)").        
-00049240: 7363 6865 6475 6c65 7220 3d20 5461 6250  scheduler = TabP
-00049250: 616e 656c 280a 2020 2020 2020 2020 2020  anel(.          
-00049260: 2020 6368 696c 643d 7363 6865 6475 6c65    child=schedule
-00049270: 722c 2074 6974 6c65 3d22 5363 6865 6475  r, title="Schedu
-00049280: 6c65 7220 5072 6f66 696c 6520 2861 646d  ler Profile (adm
-00049290: 696e 6973 7472 6174 6976 6529 220a 2020  inistrative)".  
-000492a0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
-000492b0: 7461 736b 5f73 7472 6561 6d20 3d20 5461  task_stream = Ta
-000492c0: 6250 616e 656c 2863 6869 6c64 3d74 6173  bPanel(child=tas
-000492d0: 6b5f 7374 7265 616d 2c20 7469 746c 653d  k_stream, title=
-000492e0: 2254 6173 6b20 5374 7265 616d 2229 0a20  "Task Stream"). 
-000492f0: 2020 2020 2020 2062 616e 6477 6964 7468         bandwidth
-00049300: 5f77 6f72 6b65 7273 203d 2054 6162 5061  _workers = TabPa
-00049310: 6e65 6c28 0a20 2020 2020 2020 2020 2020  nel(.           
-00049320: 2063 6869 6c64 3d62 616e 6477 6964 7468   child=bandwidth
-00049330: 5f77 6f72 6b65 7273 2e72 6f6f 742c 2074  _workers.root, t
-00049340: 6974 6c65 3d22 4261 6e64 7769 6474 6820  itle="Bandwidth 
-00049350: 2857 6f72 6b65 7273 2922 0a20 2020 2020  (Workers)".     
-00049360: 2020 2029 0a20 2020 2020 2020 2062 616e     ).        ban
-00049370: 6477 6964 7468 5f74 7970 6573 203d 2054  dwidth_types = T
-00049380: 6162 5061 6e65 6c28 0a20 2020 2020 2020  abPanel(.       
-00049390: 2020 2020 2063 6869 6c64 3d62 616e 6477       child=bandw
-000493a0: 6964 7468 5f74 7970 6573 2e72 6f6f 742c  idth_types.root,
-000493b0: 2074 6974 6c65 3d22 4261 6e64 7769 6474   title="Bandwidt
-000493c0: 6820 2854 7970 6573 2922 0a20 2020 2020  h (Types)".     
-000493d0: 2020 2029 0a20 2020 2020 2020 2073 7973     ).        sys
-000493e0: 7465 6d20 3d20 5461 6250 616e 656c 2863  tem = TabPanel(c
-000493f0: 6869 6c64 3d73 7973 6d6f 6e2e 726f 6f74  hild=sysmon.root
-00049400: 2c20 7469 746c 653d 2253 7973 7465 6d22  , title="System"
-00049410: 290a 2020 2020 2020 2020 6c6f 6773 203d  ).        logs =
-00049420: 2054 6162 5061 6e65 6c28 6368 696c 643d   TabPanel(child=
-00049430: 6c6f 6773 2e72 6f6f 742c 2074 6974 6c65  logs.root, title
-00049440: 3d22 5363 6865 6475 6c65 7220 4c6f 6773  ="Scheduler Logs
-00049450: 2229 0a0a 2020 2020 2020 2020 7461 6273  ")..        tabs
-00049460: 203d 2054 6162 7328 0a20 2020 2020 2020   = Tabs(.       
-00049470: 2020 2020 2074 6162 733d 5b0a 2020 2020       tabs=[.    
-00049480: 2020 2020 2020 2020 2020 2020 6874 6d6c              html
-00049490: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000494a0: 2020 7461 736b 5f73 7472 6561 6d2c 0a20    task_stream,. 
-000494b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-000494c0: 7973 7465 6d2c 0a20 2020 2020 2020 2020  ystem,.         
-000494d0: 2020 2020 2020 206c 6f67 732c 0a20 2020         logs,.   
-000494e0: 2020 2020 2020 2020 2020 2020 2063 6f6d               com
-000494f0: 7075 7465 2c0a 2020 2020 2020 2020 2020  pute,.          
-00049500: 2020 2020 2020 776f 726b 6572 732c 0a20        workers,. 
-00049510: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00049520: 6368 6564 756c 6572 2c0a 2020 2020 2020  cheduler,.      
-00049530: 2020 2020 2020 2020 2020 6261 6e64 7769            bandwi
-00049540: 6474 685f 776f 726b 6572 732c 0a20 2020  dth_workers,.   
-00049550: 2020 2020 2020 2020 2020 2020 2062 616e               ban
-00049560: 6477 6964 7468 5f74 7970 6573 2c0a 2020  dwidth_types,.  
-00049570: 2020 2020 2020 2020 2020 5d2c 0a20 2020            ],.   
-00049580: 2020 2020 2020 2020 2073 697a 696e 675f           sizing_
-00049590: 6d6f 6465 3d22 7374 7265 7463 685f 626f  mode="stretch_bo
-000495a0: 7468 222c 0a20 2020 2020 2020 2029 0a0a  th",.        )..
-000495b0: 2020 2020 2020 2020 6672 6f6d 2062 6f6b          from bok
-000495c0: 6568 2e63 6f72 652e 7465 6d70 6c61 7465  eh.core.template
-000495d0: 7320 696d 706f 7274 2067 6574 5f65 6e76  s import get_env
-000495e0: 0a20 2020 2020 2020 2066 726f 6d20 626f  .        from bo
-000495f0: 6b65 682e 706c 6f74 7469 6e67 2069 6d70  keh.plotting imp
-00049600: 6f72 7420 6f75 7470 7574 5f66 696c 652c  ort output_file,
-00049610: 2073 6176 650a 0a20 2020 2020 2020 2077   save..        w
-00049620: 6974 6820 746d 7066 696c 6528 6578 7465  ith tmpfile(exte
-00049630: 6e73 696f 6e3d 222e 6874 6d6c 2229 2061  nsion=".html") a
-00049640: 7320 666e 3a0a 2020 2020 2020 2020 2020  s fn:.          
-00049650: 2020 6f75 7470 7574 5f66 696c 6528 6669    output_file(fi
-00049660: 6c65 6e61 6d65 3d66 6e2c 2074 6974 6c65  lename=fn, title
-00049670: 3d22 4461 736b 2050 6572 666f 726d 616e  ="Dask Performan
-00049680: 6365 2052 6570 6f72 7422 2c20 6d6f 6465  ce Report", mode
-00049690: 3d6d 6f64 6529 0a20 2020 2020 2020 2020  =mode).         
-000496a0: 2020 2074 656d 706c 6174 655f 6469 7265     template_dire
-000496b0: 6374 6f72 7920 3d20 6f73 2e70 6174 682e  ctory = os.path.
-000496c0: 6a6f 696e 280a 2020 2020 2020 2020 2020  join(.          
-000496d0: 2020 2020 2020 6f73 2e70 6174 682e 6469        os.path.di
-000496e0: 726e 616d 6528 6f73 2e70 6174 682e 6162  rname(os.path.ab
-000496f0: 7370 6174 6828 5f5f 6669 6c65 5f5f 2929  spath(__file__))
-00049700: 2c20 2264 6173 6862 6f61 7264 222c 2022  , "dashboard", "
-00049710: 7465 6d70 6c61 7465 7322 0a20 2020 2020  templates".     
-00049720: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00049730: 2020 2020 2074 656d 706c 6174 655f 656e       template_en
-00049740: 7669 726f 6e6d 656e 7420 3d20 6765 745f  vironment = get_
-00049750: 656e 7628 290a 2020 2020 2020 2020 2020  env().          
-00049760: 2020 7465 6d70 6c61 7465 5f65 6e76 6972    template_envir
-00049770: 6f6e 6d65 6e74 2e6c 6f61 6465 722e 7365  onment.loader.se
-00049780: 6172 6368 7061 7468 2e61 7070 656e 6428  archpath.append(
-00049790: 7465 6d70 6c61 7465 5f64 6972 6563 746f  template_directo
-000497a0: 7279 290a 2020 2020 2020 2020 2020 2020  ry).            
-000497b0: 7465 6d70 6c61 7465 203d 2074 656d 706c  template = templ
-000497c0: 6174 655f 656e 7669 726f 6e6d 656e 742e  ate_environment.
-000497d0: 6765 745f 7465 6d70 6c61 7465 2822 7065  get_template("pe
-000497e0: 7266 6f72 6d61 6e63 655f 7265 706f 7274  rformance_report
-000497f0: 2e68 746d 6c22 290a 2020 2020 2020 2020  .html").        
-00049800: 2020 2020 7361 7665 2874 6162 732c 2066      save(tabs, f
-00049810: 696c 656e 616d 653d 666e 2c20 7465 6d70  ilename=fn, temp
-00049820: 6c61 7465 3d74 656d 706c 6174 6529 0a0a  late=template)..
-00049830: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00049840: 206f 7065 6e28 666e 2920 6173 2066 3a0a   open(fn) as f:.
-00049850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049860: 6461 7461 203d 2066 2e72 6561 6428 290a  data = f.read().
-00049870: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00049880: 6461 7461 0a0a 2020 2020 6173 796e 6320  data..    async 
-00049890: 6465 6620 6765 745f 776f 726b 6572 5f6c  def get_worker_l
-000498a0: 6f67 7328 7365 6c66 2c20 6e3d 4e6f 6e65  ogs(self, n=None
-000498b0: 2c20 776f 726b 6572 733d 4e6f 6e65 2c20  , workers=None, 
-000498c0: 6e61 6e6e 793d 4661 6c73 6529 3a0a 2020  nanny=False):.  
-000498d0: 2020 2020 2020 7265 7375 6c74 7320 3d20        results = 
-000498e0: 6177 6169 7420 7365 6c66 2e62 726f 6164  await self.broad
-000498f0: 6361 7374 280a 2020 2020 2020 2020 2020  cast(.          
-00049900: 2020 6d73 673d 7b22 6f70 223a 2022 6765    msg={"op": "ge
-00049910: 745f 6c6f 6773 222c 2022 6e22 3a20 6e7d  t_logs", "n": n}
-00049920: 2c20 776f 726b 6572 733d 776f 726b 6572  , workers=worker
-00049930: 732c 206e 616e 6e79 3d6e 616e 6e79 0a20  s, nanny=nanny. 
-00049940: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00049950: 2072 6574 7572 6e20 7265 7375 6c74 730a   return results.
-00049960: 0a20 2020 2064 6566 206c 6f67 5f65 7665  .    def log_eve
-00049970: 6e74 2873 656c 662c 2074 6f70 6963 3a20  nt(self, topic: 
-00049980: 7374 7220 7c20 436f 6c6c 6563 7469 6f6e  str | Collection
-00049990: 5b73 7472 5d2c 206d 7367 3a20 416e 7929  [str], msg: Any)
-000499a0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000499b0: 2020 2222 224c 6f67 2061 6e20 6576 656e    """Log an even
-000499c0: 7420 756e 6465 7220 6120 6769 7665 6e20  t under a given 
-000499d0: 746f 7069 630a 0a20 2020 2020 2020 2050  topic..        P
-000499e0: 6172 616d 6574 6572 730a 2020 2020 2020  arameters.      
-000499f0: 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20 2020    ----------.   
-00049a00: 2020 2020 2074 6f70 6963 203a 2073 7472       topic : str
-00049a10: 2c20 6c69 7374 5b73 7472 5d0a 2020 2020  , list[str].    
-00049a20: 2020 2020 2020 2020 4e61 6d65 206f 6620          Name of 
-00049a30: 7468 6520 746f 7069 6320 756e 6465 7220  the topic under 
-00049a40: 7768 6963 6820 746f 206c 6f67 2061 6e20  which to log an 
-00049a50: 6576 656e 742e 2054 6f20 6c6f 6720 7468  event. To log th
-00049a60: 6520 7361 6d65 0a20 2020 2020 2020 2020  e same.         
-00049a70: 2020 2065 7665 6e74 2075 6e64 6572 206d     event under m
-00049a80: 756c 7469 706c 6520 746f 7069 6373 2c20  ultiple topics, 
-00049a90: 7061 7373 2061 206c 6973 7420 6f66 2074  pass a list of t
-00049aa0: 6f70 6963 206e 616d 6573 2e0a 2020 2020  opic names..    
-00049ab0: 2020 2020 6d73 670a 2020 2020 2020 2020      msg.        
-00049ac0: 2020 2020 4576 656e 7420 6d65 7373 6167      Event messag
-00049ad0: 6520 746f 206c 6f67 2e20 4e6f 7465 2074  e to log. Note t
-00049ae0: 6869 7320 6d75 7374 2062 6520 6d73 6770  his must be msgp
-00049af0: 6163 6b20 7365 7269 616c 697a 6162 6c65  ack serializable
-00049b00: 2e0a 0a20 2020 2020 2020 2053 6565 2061  ...        See a
-00049b10: 6c73 6f0a 2020 2020 2020 2020 2d2d 2d2d  lso.        ----
-00049b20: 2d2d 2d2d 0a20 2020 2020 2020 2043 6c69  ----.        Cli
-00049b30: 656e 742e 6c6f 675f 6576 656e 740a 2020  ent.log_event.  
-00049b40: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00049b50: 2020 6576 656e 7420 3d20 2874 696d 6528    event = (time(
-00049b60: 292c 206d 7367 290a 2020 2020 2020 2020  ), msg).        
-00049b70: 6966 206e 6f74 2069 7369 6e73 7461 6e63  if not isinstanc
-00049b80: 6528 746f 7069 632c 2073 7472 293a 0a20  e(topic, str):. 
-00049b90: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
-00049ba0: 2069 6e20 746f 7069 633a 0a20 2020 2020   in topic:.     
-00049bb0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00049bc0: 6576 656e 7473 5b74 5d2e 6170 7065 6e64  events[t].append
-00049bd0: 2865 7665 6e74 290a 2020 2020 2020 2020  (event).        
-00049be0: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
-00049bf0: 6e74 5f63 6f75 6e74 735b 745d 202b 3d20  nt_counts[t] += 
-00049c00: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-00049c10: 2020 7365 6c66 2e5f 7265 706f 7274 5f65    self._report_e
-00049c20: 7665 6e74 2874 2c20 6576 656e 7429 0a20  vent(t, event). 
-00049c30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00049c40: 2020 2020 2020 2020 2073 656c 662e 6576           self.ev
-00049c50: 656e 7473 5b74 6f70 6963 5d2e 6170 7065  ents[topic].appe
-00049c60: 6e64 2865 7665 6e74 290a 2020 2020 2020  nd(event).      
-00049c70: 2020 2020 2020 7365 6c66 2e65 7665 6e74        self.event
-00049c80: 5f63 6f75 6e74 735b 746f 7069 635d 202b  _counts[topic] +
-00049c90: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00049ca0: 7365 6c66 2e5f 7265 706f 7274 5f65 7665  self._report_eve
-00049cb0: 6e74 2874 6f70 6963 2c20 6576 656e 7429  nt(topic, event)
-00049cc0: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-00049cd0: 7220 706c 7567 696e 2069 6e20 6c69 7374  r plugin in list
-00049ce0: 2873 656c 662e 706c 7567 696e 732e 7661  (self.plugins.va
-00049cf0: 6c75 6573 2829 293a 0a20 2020 2020 2020  lues()):.       
-00049d00: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-00049d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00049d20: 2020 706c 7567 696e 2e6c 6f67 5f65 7665    plugin.log_eve
-00049d30: 6e74 2874 6f70 6963 2c20 6d73 6729 0a20  nt(topic, msg). 
-00049d40: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00049d50: 7863 6570 7420 4578 6365 7074 696f 6e3a  xcept Exception:
-00049d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00049d70: 2020 2020 206c 6f67 6765 722e 696e 666f       logger.info
-00049d80: 2822 506c 7567 696e 2066 6169 6c65 6420  ("Plugin failed 
-00049d90: 7769 7468 2065 7863 6570 7469 6f6e 222c  with exception",
-00049da0: 2065 7863 5f69 6e66 6f3d 5472 7565 290a   exc_info=True).
-00049db0: 0a20 2020 2064 6566 205f 7265 706f 7274  .    def _report
-00049dc0: 5f65 7665 6e74 2873 656c 662c 206e 616d  _event(self, nam
-00049dd0: 652c 2065 7665 6e74 293a 0a20 2020 2020  e, event):.     
-00049de0: 2020 206d 7367 203d 207b 0a20 2020 2020     msg = {.     
-00049df0: 2020 2020 2020 2022 6f70 223a 2022 6576         "op": "ev
-00049e00: 656e 7422 2c0a 2020 2020 2020 2020 2020  ent",.          
-00049e10: 2020 2274 6f70 6963 223a 206e 616d 652c    "topic": name,
-00049e20: 0a20 2020 2020 2020 2020 2020 2022 6576  .            "ev
-00049e30: 656e 7422 3a20 6576 656e 742c 0a20 2020  ent": event,.   
-00049e40: 2020 2020 207d 0a20 2020 2020 2020 2063       }.        c
-00049e50: 6c69 656e 745f 6d73 6773 203d 207b 636c  lient_msgs = {cl
-00049e60: 6965 6e74 3a20 5b6d 7367 5d20 666f 7220  ient: [msg] for 
-00049e70: 636c 6965 6e74 2069 6e20 7365 6c66 2e65  client in self.e
-00049e80: 7665 6e74 5f73 7562 7363 7269 6265 725b  vent_subscriber[
-00049e90: 6e61 6d65 5d7d 0a20 2020 2020 2020 2073  name]}.        s
-00049ea0: 656c 662e 7365 6e64 5f61 6c6c 2863 6c69  elf.send_all(cli
-00049eb0: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
-00049ec0: 5f6d 7367 733d 7b7d 290a 0a20 2020 2064  _msgs={})..    d
-00049ed0: 6566 2073 7562 7363 7269 6265 5f74 6f70  ef subscribe_top
-00049ee0: 6963 2873 656c 662c 2074 6f70 6963 2c20  ic(self, topic, 
-00049ef0: 636c 6965 6e74 293a 0a20 2020 2020 2020  client):.       
-00049f00: 2073 656c 662e 6576 656e 745f 7375 6273   self.event_subs
-00049f10: 6372 6962 6572 5b74 6f70 6963 5d2e 6164  criber[topic].ad
-00049f20: 6428 636c 6965 6e74 290a 0a20 2020 2064  d(client)..    d
-00049f30: 6566 2075 6e73 7562 7363 7269 6265 5f74  ef unsubscribe_t
-00049f40: 6f70 6963 2873 656c 662c 2074 6f70 6963  opic(self, topic
-00049f50: 2c20 636c 6965 6e74 293a 0a20 2020 2020  , client):.     
-00049f60: 2020 2073 656c 662e 6576 656e 745f 7375     self.event_su
-00049f70: 6273 6372 6962 6572 5b74 6f70 6963 5d2e  bscriber[topic].
-00049f80: 6469 7363 6172 6428 636c 6965 6e74 290a  discard(client).
-00049f90: 0a20 2020 2064 6566 2067 6574 5f65 7665  .    def get_eve
-00049fa0: 6e74 7328 7365 6c66 2c20 746f 7069 633d  nts(self, topic=
-00049fb0: 4e6f 6e65 293a 0a20 2020 2020 2020 2069  None):.        i
-00049fc0: 6620 746f 7069 6320 6973 206e 6f74 204e  f topic is not N
-00049fd0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-00049fe0: 2072 6574 7572 6e20 7475 706c 6528 7365   return tuple(se
-00049ff0: 6c66 2e65 7665 6e74 735b 746f 7069 635d  lf.events[topic]
-0004a000: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-0004a010: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0004a020: 726e 2076 616c 6d61 7028 7475 706c 652c  rn valmap(tuple,
-0004a030: 2073 656c 662e 6576 656e 7473 290a 0a20   self.events).. 
-0004a040: 2020 2061 7379 6e63 2064 6566 2067 6574     async def get
-0004a050: 5f77 6f72 6b65 725f 6d6f 6e69 746f 725f  _worker_monitor_
-0004a060: 696e 666f 2873 656c 662c 2072 6563 656e  info(self, recen
-0004a070: 743d 4661 6c73 652c 2073 7461 7274 733d  t=False, starts=
-0004a080: 4e6f 6e65 293a 0a20 2020 2020 2020 2069  None):.        i
-0004a090: 6620 7374 6172 7473 2069 7320 4e6f 6e65  f starts is None
-0004a0a0: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
-0004a0b0: 6172 7473 203d 207b 7d0a 2020 2020 2020  arts = {}.      
-0004a0c0: 2020 7265 7375 6c74 7320 3d20 6177 6169    results = awai
-0004a0d0: 7420 6173 796e 6369 6f2e 6761 7468 6572  t asyncio.gather
-0004a0e0: 280a 2020 2020 2020 2020 2020 2020 2a28  (.            *(
-0004a0f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a100: 2073 656c 662e 7270 6328 7729 2e67 6574   self.rpc(w).get
-0004a110: 5f6d 6f6e 6974 6f72 5f69 6e66 6f28 7265  _monitor_info(re
-0004a120: 6365 6e74 3d72 6563 656e 742c 2073 7461  cent=recent, sta
-0004a130: 7274 3d73 7461 7274 732e 6765 7428 772c  rt=starts.get(w,
-0004a140: 2030 2929 0a20 2020 2020 2020 2020 2020   0)).           
-0004a150: 2020 2020 2066 6f72 2077 2069 6e20 7365       for w in se
-0004a160: 6c66 2e77 6f72 6b65 7273 0a20 2020 2020  lf.workers.     
-0004a170: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0004a180: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
-0004a190: 6e20 6469 6374 287a 6970 2873 656c 662e  n dict(zip(self.
-0004a1a0: 776f 726b 6572 732c 2072 6573 756c 7473  workers, results
-0004a1b0: 2929 0a0a 2020 2020 2323 2323 2323 2323  ))..    ########
-0004a1c0: 2323 230a 2020 2020 2320 436c 6561 6e75  ###.    # Cleanu
-0004a1d0: 7020 230a 2020 2020 2323 2323 2323 2323  p #.    ########
-0004a1e0: 2323 230a 0a20 2020 2061 7379 6e63 2064  ###..    async d
-0004a1f0: 6566 2063 6865 636b 5f77 6f72 6b65 725f  ef check_worker_
-0004a200: 7474 6c28 7365 6c66 293a 0a20 2020 2020  ttl(self):.     
-0004a210: 2020 206e 6f77 203d 2074 696d 6528 290a     now = time().
-0004a220: 2020 2020 2020 2020 7374 696d 756c 7573          stimulus
-0004a230: 5f69 6420 3d20 6622 6368 6563 6b2d 776f  _id = f"check-wo
-0004a240: 726b 6572 2d74 746c 2d7b 6e6f 777d 220a  rker-ttl-{now}".
-0004a250: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
-0004a260: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
-0004a270: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
-0004a280: 2020 2020 2069 6620 2877 732e 6c61 7374       if (ws.last
-0004a290: 5f73 6565 6e20 3c20 6e6f 7720 2d20 7365  _seen < now - se
-0004a2a0: 6c66 2e77 6f72 6b65 725f 7474 6c29 2061  lf.worker_ttl) a
-0004a2b0: 6e64 2028 0a20 2020 2020 2020 2020 2020  nd (.           
-0004a2c0: 2020 2020 2077 732e 6c61 7374 5f73 6565       ws.last_see
-0004a2d0: 6e20 3c20 6e6f 7720 2d20 3130 202a 2068  n < now - 10 * h
-0004a2e0: 6561 7274 6265 6174 5f69 6e74 6572 7661  eartbeat_interva
-0004a2f0: 6c28 6c65 6e28 7365 6c66 2e77 6f72 6b65  l(len(self.worke
-0004a300: 7273 2929 0a20 2020 2020 2020 2020 2020  rs)).           
-0004a310: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-0004a320: 2020 2020 6c6f 6767 6572 2e77 6172 6e69      logger.warni
-0004a330: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
-0004a340: 2020 2020 2020 2020 2257 6f72 6b65 7220          "Worker 
-0004a350: 6661 696c 6564 2074 6f20 6865 6172 7462  failed to heartb
-0004a360: 6561 7420 7769 7468 696e 2025 7320 7365  eat within %s se
-0004a370: 636f 6e64 732e 2043 6c6f 7369 6e67 3a20  conds. Closing: 
-0004a380: 2573 222c 0a20 2020 2020 2020 2020 2020  %s",.           
-0004a390: 2020 2020 2020 2020 2073 656c 662e 776f           self.wo
-0004a3a0: 726b 6572 5f74 746c 2c0a 2020 2020 2020  rker_ttl,.      
-0004a3b0: 2020 2020 2020 2020 2020 2020 2020 7773                ws
-0004a3c0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004a3d0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0004a3e0: 2020 2020 6177 6169 7420 7365 6c66 2e72      await self.r
-0004a3f0: 656d 6f76 655f 776f 726b 6572 2861 6464  emove_worker(add
-0004a400: 7265 7373 3d77 732e 6164 6472 6573 732c  ress=ws.address,
-0004a410: 2073 7469 6d75 6c75 735f 6964 3d73 7469   stimulus_id=sti
-0004a420: 6d75 6c75 735f 6964 290a 0a20 2020 2064  mulus_id)..    d
-0004a430: 6566 2063 6865 636b 5f69 646c 6528 7365  ef check_idle(se
-0004a440: 6c66 2920 2d3e 2066 6c6f 6174 207c 204e  lf) -> float | N
-0004a450: 6f6e 653a 0a20 2020 2020 2020 2069 6620  one:.        if 
-0004a460: 7365 6c66 2e73 7461 7475 7320 696e 2028  self.status in (
-0004a470: 5374 6174 7573 2e63 6c6f 7369 6e67 2c20  Status.closing, 
-0004a480: 5374 6174 7573 2e63 6c6f 7365 6429 3a0a  Status.closed):.
-0004a490: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0004a4a0: 726e 204e 6f6e 6520 2023 2070 7261 676d  rn None  # pragm
-0004a4b0: 613a 206e 6f63 6f76 6572 0a0a 2020 2020  a: nocover..    
-0004a4c0: 2020 2020 6966 2073 656c 662e 7472 616e      if self.tran
-0004a4d0: 7369 7469 6f6e 5f63 6f75 6e74 6572 2021  sition_counter !
-0004a4e0: 3d20 7365 6c66 2e5f 6964 6c65 5f74 7261  = self._idle_tra
-0004a4f0: 6e73 6974 696f 6e5f 636f 756e 7465 723a  nsition_counter:
-0004a500: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0004a510: 662e 5f69 646c 655f 7472 616e 7369 7469  f._idle_transiti
-0004a520: 6f6e 5f63 6f75 6e74 6572 203d 2073 656c  on_counter = sel
-0004a530: 662e 7472 616e 7369 7469 6f6e 5f63 6f75  f.transition_cou
-0004a540: 6e74 6572 0a20 2020 2020 2020 2020 2020  nter.           
-0004a550: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
-0004a560: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-0004a570: 2020 2020 7265 7475 726e 204e 6f6e 650a      return None.
-0004a580: 0a20 2020 2020 2020 2069 6620 280a 2020  .        if (.  
-0004a590: 2020 2020 2020 2020 2020 7365 6c66 2e71            self.q
-0004a5a0: 7565 7565 640a 2020 2020 2020 2020 2020  ueued.          
-0004a5b0: 2020 6f72 2073 656c 662e 756e 7275 6e6e    or self.unrunn
-0004a5c0: 6162 6c65 0a20 2020 2020 2020 2020 2020  able.           
-0004a5d0: 206f 7220 616e 7928 7773 2e70 726f 6365   or any(ws.proce
-0004a5e0: 7373 696e 6720 666f 7220 7773 2069 6e20  ssing for ws in 
-0004a5f0: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-0004a600: 7565 7328 2929 0a20 2020 2020 2020 2029  ues()).        )
-0004a610: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0004a620: 6c66 2e69 646c 655f 7369 6e63 6520 3d20  lf.idle_since = 
-0004a630: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0004a640: 2072 6574 7572 6e20 4e6f 6e65 0a0a 2020   return None..  
-0004a650: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
-0004a660: 662e 6964 6c65 5f73 696e 6365 3a0a 2020  f.idle_since:.  
-0004a670: 2020 2020 2020 2020 2020 7365 6c66 2e69            self.i
-0004a680: 646c 655f 7369 6e63 6520 3d20 7469 6d65  dle_since = time
-0004a690: 2829 0a20 2020 2020 2020 2020 2020 2072  ().            r
-0004a6a0: 6574 7572 6e20 7365 6c66 2e69 646c 655f  eturn self.idle_
-0004a6b0: 7369 6e63 650a 0a20 2020 2020 2020 2069  since..        i
-0004a6c0: 6620 7365 6c66 2e6a 7570 7974 6572 3a0a  f self.jupyter:.
-0004a6d0: 2020 2020 2020 2020 2020 2020 6c61 7374              last
-0004a6e0: 5f61 6374 6976 6974 7920 3d20 280a 2020  _activity = (.  
-0004a6f0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-0004a700: 6c66 2e5f 6a75 7079 7465 725f 7365 7276  lf._jupyter_serv
-0004a710: 6572 5f61 7070 6c69 6361 7469 6f6e 2e77  er_application.w
-0004a720: 6562 5f61 7070 2e6c 6173 745f 6163 7469  eb_app.last_acti
-0004a730: 7669 7479 2829 2e74 696d 6573 7461 6d70  vity().timestamp
-0004a740: 2829 0a20 2020 2020 2020 2020 2020 2029  ().            )
-0004a750: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0004a760: 6c61 7374 5f61 6374 6976 6974 7920 3e20  last_activity > 
-0004a770: 7365 6c66 2e69 646c 655f 7369 6e63 653a  self.idle_since:
-0004a780: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a790: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
-0004a7a0: 203d 206c 6173 745f 6163 7469 7669 7479   = last_activity
-0004a7b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004a7c0: 2072 6574 7572 6e20 7365 6c66 2e69 646c   return self.idl
-0004a7d0: 655f 7369 6e63 650a 0a20 2020 2020 2020  e_since..       
-0004a7e0: 2069 6620 7365 6c66 2e69 646c 655f 7469   if self.idle_ti
-0004a7f0: 6d65 6f75 743a 0a20 2020 2020 2020 2020  meout:.         
-0004a800: 2020 2069 6620 7469 6d65 2829 203e 2073     if time() > s
-0004a810: 656c 662e 6964 6c65 5f73 696e 6365 202b  elf.idle_since +
-0004a820: 2073 656c 662e 6964 6c65 5f74 696d 656f   self.idle_timeo
-0004a830: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
-0004a840: 2020 2020 6173 7365 7274 2073 656c 662e      assert self.
-0004a850: 6964 6c65 5f73 696e 6365 0a20 2020 2020  idle_since.     
-0004a860: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
-0004a870: 722e 696e 666f 280a 2020 2020 2020 2020  r.info(.        
-0004a880: 2020 2020 2020 2020 2020 2020 2253 6368              "Sch
-0004a890: 6564 756c 6572 2063 6c6f 7369 6e67 2061  eduler closing a
-0004a8a0: 6674 6572 2062 6569 6e67 2069 646c 6520  fter being idle 
-0004a8b0: 666f 7220 2573 222c 0a20 2020 2020 2020  for %s",.       
-0004a8c0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-0004a8d0: 6d61 745f 7469 6d65 2873 656c 662e 6964  mat_time(self.id
-0004a8e0: 6c65 5f74 696d 656f 7574 292c 0a20 2020  le_timeout),.   
-0004a8f0: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-0004a900: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0004a910: 656c 662e 5f6f 6e67 6f69 6e67 5f62 6163  elf._ongoing_bac
-0004a920: 6b67 726f 756e 645f 7461 736b 732e 6361  kground_tasks.ca
-0004a930: 6c6c 5f73 6f6f 6e28 7365 6c66 2e63 6c6f  ll_soon(self.clo
-0004a940: 7365 290a 2020 2020 2020 2020 7265 7475  se).        retu
-0004a950: 726e 2073 656c 662e 6964 6c65 5f73 696e  rn self.idle_sin
-0004a960: 6365 0a0a 2020 2020 6465 6620 5f63 6865  ce..    def _che
-0004a970: 636b 5f6e 6f5f 776f 726b 6572 7328 7365  ck_no_workers(se
-0004a980: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
-0004a990: 2020 2020 2022 2222 5368 7574 2064 6f77       """Shut dow
-0004a9a0: 6e20 7468 6520 7363 6865 6475 6c65 7220  n the scheduler 
-0004a9b0: 6966 2074 6865 7265 2068 6176 6520 6265  if there have be
-0004a9c0: 656e 2074 6173 6b73 2072 6561 6479 2074  en tasks ready t
-0004a9d0: 6f20 7275 6e20 7768 6963 6820 6861 7665  o run which have
-0004a9e0: 0a20 2020 2020 2020 206e 6f77 6865 7265  .        nowhere
-0004a9f0: 2074 6f20 7275 6e20 666f 7220 6064 6973   to run for `dis
-0004aa00: 7472 6962 7574 6564 2e73 6368 6564 756c  tributed.schedul
-0004aa10: 6572 2e6e 6f2d 776f 726b 6572 732d 7469  er.no-workers-ti
-0004aa20: 6d65 6f75 7460 2c20 616e 6420 7468 6572  meout`, and ther
-0004aa30: 650a 2020 2020 2020 2020 6172 656e 2774  e.        aren't
-0004aa40: 206f 7468 6572 2074 6173 6b73 2072 756e   other tasks run
-0004aa50: 6e69 6e67 2e0a 2020 2020 2020 2020 2222  ning..        ""
-0004aa60: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-0004aa70: 662e 7374 6174 7573 2069 6e20 2853 7461  f.status in (Sta
-0004aa80: 7475 732e 636c 6f73 696e 672c 2053 7461  tus.closing, Sta
-0004aa90: 7475 732e 636c 6f73 6564 293a 0a20 2020  tus.closed):.   
-0004aaa0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0004aab0: 2023 2070 7261 676d 613a 206e 6f63 6f76   # pragma: nocov
-0004aac0: 6572 0a0a 2020 2020 2020 2020 6966 2028  er..        if (
-0004aad0: 0a20 2020 2020 2020 2020 2020 2028 6e6f  .            (no
-0004aae0: 7420 7365 6c66 2e71 7565 7565 6420 616e  t self.queued an
-0004aaf0: 6420 6e6f 7420 7365 6c66 2e75 6e72 756e  d not self.unrun
-0004ab00: 6e61 626c 6529 0a20 2020 2020 2020 2020  nable).         
-0004ab10: 2020 206f 7220 2873 656c 662e 7175 6575     or (self.queu
-0004ab20: 6564 2061 6e64 2073 656c 662e 776f 726b  ed and self.work
-0004ab30: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
-0004ab40: 206f 7220 616e 7928 7773 2e70 726f 6365   or any(ws.proce
-0004ab50: 7373 696e 6720 666f 7220 7773 2069 6e20  ssing for ws in 
-0004ab60: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
-0004ab70: 7565 7328 2929 0a20 2020 2020 2020 2029  ues()).        )
-0004ab80: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0004ab90: 6c66 2e5f 6e6f 5f77 6f72 6b65 7273 5f73  lf._no_workers_s
-0004aba0: 696e 6365 203d 204e 6f6e 650a 2020 2020  ince = None.    
-0004abb0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
-0004abc0: 2020 2020 2020 2020 2320 312e 2054 6865          # 1. The
-0004abd0: 7265 2061 7265 2071 7565 7565 6420 6f72  re are queued or
-0004abe0: 2075 6e72 756e 6e61 626c 6520 7461 736b   unrunnable task
-0004abf0: 7320 616e 6420 6e6f 2077 6f72 6b65 7273  s and no workers
-0004ac00: 2061 7420 616c 6c0a 2020 2020 2020 2020   at all.        
-0004ac10: 2320 322e 2054 6865 7265 2061 7265 2075  # 2. There are u
-0004ac20: 6e72 756e 6e61 626c 6520 7461 736b 7320  nrunnable tasks 
-0004ac30: 616e 6420 6e6f 2077 6f72 6b65 7273 2073  and no workers s
-0004ac40: 6174 6973 6679 2074 6865 6972 2072 6573  atisfy their res
-0004ac50: 7472 6963 7469 6f6e 730a 2020 2020 2020  trictions.      
-0004ac60: 2020 2320 284f 6e6c 7920 726f 6f74 6973    # (Only rootis
-0004ac70: 6820 7461 736b 7320 6361 6e20 6265 2071  h tasks can be q
-0004ac80: 7565 7565 642c 2061 6e64 2072 6f6f 7469  ueued, and rooti
-0004ac90: 7368 2074 6173 6b73 2063 616e 2774 2068  sh tasks can't h
-0004aca0: 6176 6520 7265 7374 7269 6374 696f 6e73  ave restrictions
-0004acb0: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-0004acc0: 7420 7365 6c66 2e5f 6e6f 5f77 6f72 6b65  t self._no_worke
-0004acd0: 7273 5f73 696e 6365 3a0a 2020 2020 2020  rs_since:.      
-0004ace0: 2020 2020 2020 7365 6c66 2e5f 6e6f 5f77        self._no_w
-0004acf0: 6f72 6b65 7273 5f73 696e 6365 203d 2074  orkers_since = t
-0004ad00: 696d 6528 290a 2020 2020 2020 2020 2020  ime().          
-0004ad10: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-0004ad20: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
-0004ad30: 2020 2073 656c 662e 6e6f 5f77 6f72 6b65     self.no_worke
-0004ad40: 7273 5f74 696d 656f 7574 0a20 2020 2020  rs_timeout.     
-0004ad50: 2020 2020 2020 2061 6e64 2074 696d 6528         and time(
-0004ad60: 2920 3e20 7365 6c66 2e5f 6e6f 5f77 6f72  ) > self._no_wor
-0004ad70: 6b65 7273 5f73 696e 6365 202b 2073 656c  kers_since + sel
-0004ad80: 662e 6e6f 5f77 6f72 6b65 7273 5f74 696d  f.no_workers_tim
-0004ad90: 656f 7574 0a20 2020 2020 2020 2029 3a0a  eout.        ):.
-0004ada0: 2020 2020 2020 2020 2020 2020 6c6f 6767              logg
-0004adb0: 6572 2e69 6e66 6f28 0a20 2020 2020 2020  er.info(.       
-0004adc0: 2020 2020 2020 2020 2022 5461 736b 7320           "Tasks 
-0004add0: 6861 7665 2062 6565 6e20 7769 7468 6f75  have been withou
-0004ade0: 7420 616e 7920 776f 726b 6572 7320 746f  t any workers to
-0004adf0: 2072 756e 2074 6865 6d20 666f 7220 2573   run them for %s
-0004ae00: 3b20 220a 2020 2020 2020 2020 2020 2020  ; ".            
-0004ae10: 2020 2020 2273 6875 7474 696e 6720 7363      "shutting sc
-0004ae20: 6865 6475 6c65 7220 646f 776e 222c 0a20  heduler down",. 
-0004ae30: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0004ae40: 6f72 6d61 745f 7469 6d65 2873 656c 662e  ormat_time(self.
-0004ae50: 6e6f 5f77 6f72 6b65 7273 5f74 696d 656f  no_workers_timeo
-0004ae60: 7574 292c 0a20 2020 2020 2020 2020 2020  ut),.           
-0004ae70: 2029 0a20 2020 2020 2020 2020 2020 2073   ).            s
-0004ae80: 656c 662e 5f6f 6e67 6f69 6e67 5f62 6163  elf._ongoing_bac
-0004ae90: 6b67 726f 756e 645f 7461 736b 732e 6361  kground_tasks.ca
-0004aea0: 6c6c 5f73 6f6f 6e28 7365 6c66 2e63 6c6f  ll_soon(self.clo
-0004aeb0: 7365 290a 0a20 2020 2064 6566 2061 6461  se)..    def ada
-0004aec0: 7074 6976 655f 7461 7267 6574 2873 656c  ptive_target(sel
-0004aed0: 662c 2074 6172 6765 745f 6475 7261 7469  f, target_durati
-0004aee0: 6f6e 3d4e 6f6e 6529 3a0a 2020 2020 2020  on=None):.      
-0004aef0: 2020 2222 2244 6573 6972 6564 206e 756d    """Desired num
-0004af00: 6265 7220 6f66 2077 6f72 6b65 7273 2062  ber of workers b
-0004af10: 6173 6564 206f 6e20 7468 6520 6375 7272  ased on the curr
-0004af20: 656e 7420 776f 726b 6c6f 6164 0a0a 2020  ent workload..  
-0004af30: 2020 2020 2020 5468 6973 206c 6f6f 6b73        This looks
-0004af40: 2061 7420 7468 6520 6375 7272 656e 7420   at the current 
-0004af50: 7275 6e6e 696e 6720 7461 736b 7320 616e  running tasks an
-0004af60: 6420 6d65 6d6f 7279 2075 7365 2c20 616e  d memory use, an
-0004af70: 6420 7265 7475 726e 7320 610a 2020 2020  d returns a.    
-0004af80: 2020 2020 6e75 6d62 6572 206f 6620 6465      number of de
-0004af90: 7369 7265 6420 776f 726b 6572 732e 2020  sired workers.  
-0004afa0: 5468 6973 2069 7320 6f66 7465 6e20 7573  This is often us
-0004afb0: 6564 2062 7920 6164 6170 7469 7665 2073  ed by adaptive s
-0004afc0: 6368 6564 756c 696e 672e 0a0a 2020 2020  cheduling...    
-0004afd0: 2020 2020 5061 7261 6d65 7465 7273 0a20      Parameters. 
-0004afe0: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d2d         ---------
-0004aff0: 2d0a 2020 2020 2020 2020 7461 7267 6574  -.        target
-0004b000: 5f64 7572 6174 696f 6e20 3a20 7374 720a  _duration : str.
-0004b010: 2020 2020 2020 2020 2020 2020 4120 6465              A de
-0004b020: 7369 7265 6420 6475 7261 7469 6f6e 206f  sired duration o
-0004b030: 6620 7469 6d65 2066 6f72 2063 6f6d 7075  f time for compu
-0004b040: 7461 7469 6f6e 7320 746f 2074 616b 652e  tations to take.
-0004b050: 2020 5468 6973 2061 6666 6563 7473 0a20    This affects. 
-0004b060: 2020 2020 2020 2020 2020 2068 6f77 2072             how r
-0004b070: 6170 6964 6c79 2074 6865 2073 6368 6564  apidly the sched
-0004b080: 756c 6572 2077 696c 6c20 6173 6b20 746f  uler will ask to
-0004b090: 2073 6361 6c65 2e0a 0a20 2020 2020 2020   scale...       
-0004b0a0: 2053 6565 2041 6c73 6f0a 2020 2020 2020   See Also.      
-0004b0b0: 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020    --------.     
-0004b0c0: 2020 2064 6973 7472 6962 7574 6564 2e64     distributed.d
-0004b0d0: 6570 6c6f 792e 4164 6170 7469 7665 0a20  eploy.Adaptive. 
-0004b0e0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0004b0f0: 2020 2069 6620 7461 7267 6574 5f64 7572     if target_dur
-0004b100: 6174 696f 6e20 6973 204e 6f6e 653a 0a20  ation is None:. 
-0004b110: 2020 2020 2020 2020 2020 2074 6172 6765             targe
-0004b120: 745f 6475 7261 7469 6f6e 203d 2064 6173  t_duration = das
-0004b130: 6b2e 636f 6e66 6967 2e67 6574 2822 6469  k.config.get("di
-0004b140: 7374 7269 6275 7465 642e 6164 6170 7469  stributed.adapti
-0004b150: 7665 2e74 6172 6765 742d 6475 7261 7469  ve.target-durati
-0004b160: 6f6e 2229 0a20 2020 2020 2020 2074 6172  on").        tar
-0004b170: 6765 745f 6475 7261 7469 6f6e 203d 2070  get_duration = p
-0004b180: 6172 7365 5f74 696d 6564 656c 7461 2874  arse_timedelta(t
-0004b190: 6172 6765 745f 6475 7261 7469 6f6e 290a  arget_duration).
-0004b1a0: 0a20 2020 2020 2020 2023 2043 5055 0a20  .        # CPU. 
-0004b1b0: 2020 2020 2020 2071 7565 7565 6420 3d20         queued = 
-0004b1c0: 7461 6b65 2831 3030 2c20 636f 6e63 6174  take(100, concat
-0004b1d0: 285b 7365 6c66 2e71 7565 7565 642c 2073  ([self.queued, s
-0004b1e0: 656c 662e 756e 7275 6e6e 6162 6c65 5d29  elf.unrunnable])
-0004b1f0: 290a 2020 2020 2020 2020 7175 6575 6564  ).        queued
-0004b200: 5f6f 6363 7570 616e 6379 203d 2030 0a20  _occupancy = 0. 
-0004b210: 2020 2020 2020 2066 6f72 2074 7320 696e         for ts in
-0004b220: 2071 7565 7565 643a 0a20 2020 2020 2020   queued:.       
-0004b230: 2020 2020 2069 6620 7473 2e70 7265 6669       if ts.prefi
-0004b240: 782e 6475 7261 7469 6f6e 5f61 7665 7261  x.duration_avera
-0004b250: 6765 203d 3d20 2d31 3a0a 2020 2020 2020  ge == -1:.      
-0004b260: 2020 2020 2020 2020 2020 7175 6575 6564            queued
-0004b270: 5f6f 6363 7570 616e 6379 202b 3d20 7365  _occupancy += se
-0004b280: 6c66 2e55 4e4b 4e4f 574e 5f54 4153 4b5f  lf.UNKNOWN_TASK_
-0004b290: 4455 5241 5449 4f4e 0a20 2020 2020 2020  DURATION.       
-0004b2a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0004b2b0: 2020 2020 2020 2020 2020 2071 7565 7565             queue
-0004b2c0: 645f 6f63 6375 7061 6e63 7920 2b3d 2074  d_occupancy += t
-0004b2d0: 732e 7072 6566 6978 2e64 7572 6174 696f  s.prefix.duratio
-0004b2e0: 6e5f 6176 6572 6167 650a 0a20 2020 2020  n_average..     
-0004b2f0: 2020 2074 6173 6b73 5f72 6561 6479 203d     tasks_ready =
-0004b300: 206c 656e 2873 656c 662e 7175 6575 6564   len(self.queued
-0004b310: 2920 2b20 6c65 6e28 7365 6c66 2e75 6e72  ) + len(self.unr
-0004b320: 756e 6e61 626c 6529 0a20 2020 2020 2020  unnable).       
-0004b330: 2069 6620 7461 736b 735f 7265 6164 7920   if tasks_ready 
-0004b340: 3e20 3130 303a 0a20 2020 2020 2020 2020  > 100:.         
-0004b350: 2020 2071 7565 7565 645f 6f63 6375 7061     queued_occupa
-0004b360: 6e63 7920 2a3d 2074 6173 6b73 5f72 6561  ncy *= tasks_rea
-0004b370: 6479 202f 2031 3030 0a0a 2020 2020 2020  dy / 100..      
-0004b380: 2020 6370 7520 3d20 6d61 7468 2e63 6569    cpu = math.cei
-0004b390: 6c28 2873 656c 662e 746f 7461 6c5f 6f63  l((self.total_oc
-0004b3a0: 6375 7061 6e63 7920 2b20 7175 6575 6564  cupancy + queued
-0004b3b0: 5f6f 6363 7570 616e 6379 2920 2f20 7461  _occupancy) / ta
-0004b3c0: 7267 6574 5f64 7572 6174 696f 6e29 0a0a  rget_duration)..
-0004b3d0: 2020 2020 2020 2020 2320 4176 6f69 6420          # Avoid 
-0004b3e0: 6120 6665 7720 6c6f 6e67 2074 6173 6b73  a few long tasks
-0004b3f0: 2066 726f 6d20 6173 6b69 6e67 2066 6f72   from asking for
-0004b400: 206d 616e 7920 636f 7265 730a 2020 2020   many cores.    
-0004b410: 2020 2020 666f 7220 7773 2069 6e20 7365      for ws in se
-0004b420: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
-0004b430: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0004b440: 2069 6620 7461 736b 735f 7265 6164 7920   if tasks_ready 
-0004b450: 3e20 6370 753a 0a20 2020 2020 2020 2020  > cpu:.         
-0004b460: 2020 2020 2020 2062 7265 616b 0a20 2020         break.   
-0004b470: 2020 2020 2020 2020 2074 6173 6b73 5f72           tasks_r
-0004b480: 6561 6479 202b 3d20 6c65 6e28 7773 2e70  eady += len(ws.p
-0004b490: 726f 6365 7373 696e 6729 0a20 2020 2020  rocessing).     
-0004b4a0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0004b4b0: 2020 2020 2063 7075 203d 206d 696e 2874       cpu = min(t
-0004b4c0: 6173 6b73 5f72 6561 6479 2c20 6370 7529  asks_ready, cpu)
-0004b4d0: 0a0a 2020 2020 2020 2020 2320 4469 7669  ..        # Divi
-0004b4e0: 6465 2062 7920 6176 6572 6167 6520 6e74  de by average nt
-0004b4f0: 6872 6561 6473 2070 6572 2077 6f72 6b65  hreads per worke
-0004b500: 720a 2020 2020 2020 2020 6966 2073 656c  r.        if sel
-0004b510: 662e 776f 726b 6572 733a 0a20 2020 2020  f.workers:.     
-0004b520: 2020 2020 2020 206e 7468 7265 6164 7320         nthreads 
-0004b530: 3d20 7375 6d28 7773 2e6e 7468 7265 6164  = sum(ws.nthread
-0004b540: 7320 666f 7220 7773 2069 6e20 7365 6c66  s for ws in self
-0004b550: 2e77 6f72 6b65 7273 2e76 616c 7565 7328  .workers.values(
-0004b560: 2929 0a20 2020 2020 2020 2020 2020 2063  )).            c
-0004b570: 7075 203d 206d 6174 682e 6365 696c 2863  pu = math.ceil(c
-0004b580: 7075 202f 206e 7468 7265 6164 7320 2a20  pu / nthreads * 
-0004b590: 6c65 6e28 7365 6c66 2e77 6f72 6b65 7273  len(self.workers
-0004b5a0: 2929 0a0a 2020 2020 2020 2020 6966 2028  ))..        if (
-0004b5b0: 7365 6c66 2e75 6e72 756e 6e61 626c 6520  self.unrunnable 
-0004b5c0: 6f72 2073 656c 662e 7175 6575 6564 2920  or self.queued) 
-0004b5d0: 616e 6420 6e6f 7420 7365 6c66 2e77 6f72  and not self.wor
-0004b5e0: 6b65 7273 3a0a 2020 2020 2020 2020 2020  kers:.          
-0004b5f0: 2020 6370 7520 3d20 6d61 7828 312c 2063    cpu = max(1, c
-0004b600: 7075 290a 0a20 2020 2020 2020 2023 2061  pu)..        # a
-0004b610: 6464 206d 6f72 6520 776f 726b 6572 7320  dd more workers 
-0004b620: 6966 206d 6f72 6520 7468 616e 2036 3025  if more than 60%
-0004b630: 206f 6620 6d65 6d6f 7279 2069 7320 7573   of memory is us
-0004b640: 6564 0a20 2020 2020 2020 206c 696d 6974  ed.        limit
-0004b650: 203d 2073 756d 2877 732e 6d65 6d6f 7279   = sum(ws.memory
-0004b660: 5f6c 696d 6974 2066 6f72 2077 7320 696e  _limit for ws in
-0004b670: 2073 656c 662e 776f 726b 6572 732e 7661   self.workers.va
-0004b680: 6c75 6573 2829 290a 2020 2020 2020 2020  lues()).        
-0004b690: 7573 6564 203d 2073 756d 2877 732e 6e62  used = sum(ws.nb
-0004b6a0: 7974 6573 2066 6f72 2077 7320 696e 2073  ytes for ws in s
-0004b6b0: 656c 662e 776f 726b 6572 732e 7661 6c75  elf.workers.valu
-0004b6c0: 6573 2829 290a 2020 2020 2020 2020 6d65  es()).        me
-0004b6d0: 6d6f 7279 203d 2030 0a20 2020 2020 2020  mory = 0.       
-0004b6e0: 2069 6620 7573 6564 203e 2030 2e36 202a   if used > 0.6 *
-0004b6f0: 206c 696d 6974 2061 6e64 206c 696d 6974   limit and limit
-0004b700: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-0004b710: 2020 6d65 6d6f 7279 203d 2032 202a 206c    memory = 2 * l
-0004b720: 656e 2873 656c 662e 776f 726b 6572 7329  en(self.workers)
-0004b730: 0a0a 2020 2020 2020 2020 7461 7267 6574  ..        target
-0004b740: 203d 206d 6178 286d 656d 6f72 792c 2063   = max(memory, c
-0004b750: 7075 290a 2020 2020 2020 2020 6966 2074  pu).        if t
-0004b760: 6172 6765 7420 3e3d 206c 656e 2873 656c  arget >= len(sel
-0004b770: 662e 776f 726b 6572 7329 3a0a 2020 2020  f.workers):.    
-0004b780: 2020 2020 2020 2020 7265 7475 726e 2074          return t
-0004b790: 6172 6765 740a 2020 2020 2020 2020 656c  arget.        el
-0004b7a0: 7365 3a20 2023 2053 6361 6c65 2064 6f77  se:  # Scale dow
-0004b7b0: 6e3f 0a20 2020 2020 2020 2020 2020 2074  n?.            t
-0004b7c0: 6f5f 636c 6f73 6520 3d20 7365 6c66 2e77  o_close = self.w
-0004b7d0: 6f72 6b65 7273 5f74 6f5f 636c 6f73 6528  orkers_to_close(
-0004b7e0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
-0004b7f0: 7475 726e 206c 656e 2873 656c 662e 776f  turn len(self.wo
-0004b800: 726b 6572 7329 202d 206c 656e 2874 6f5f  rkers) - len(to_
-0004b810: 636c 6f73 6529 0a0a 2020 2020 6465 6620  close)..    def 
-0004b820: 7265 7175 6573 745f 6163 7175 6972 655f  request_acquire_
-0004b830: 7265 706c 6963 6173 280a 2020 2020 2020  replicas(.      
-0004b840: 2020 7365 6c66 2c20 6164 6472 3a20 7374    self, addr: st
-0004b850: 722c 206b 6579 733a 2049 7465 7261 626c  r, keys: Iterabl
-0004b860: 655b 4b65 795d 2c20 2a2c 2073 7469 6d75  e[Key], *, stimu
-0004b870: 6c75 735f 6964 3a20 7374 720a 2020 2020  lus_id: str.    
-0004b880: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
-0004b890: 2020 2022 2222 4173 796e 6368 726f 6e6f     """Asynchrono
-0004b8a0: 7573 6c79 2061 736b 2061 2077 6f72 6b65  usly ask a worke
-0004b8b0: 7220 746f 2061 6371 7569 7265 2061 2072  r to acquire a r
-0004b8c0: 6570 6c69 6361 206f 6620 7468 6520 6c69  eplica of the li
-0004b8d0: 7374 6564 206b 6579 7320 6672 6f6d 0a20  sted keys from. 
-0004b8e0: 2020 2020 2020 206f 7468 6572 2077 6f72         other wor
-0004b8f0: 6b65 7273 2e20 5468 6973 2069 7320 6120  kers. This is a 
-0004b900: 6669 7265 2d61 6e64 2d66 6f72 6765 7420  fire-and-forget 
-0004b910: 6f70 6572 6174 696f 6e20 7768 6963 6820  operation which 
-0004b920: 6f66 6665 7273 206e 6f20 6665 6564 6261  offers no feedba
-0004b930: 636b 2066 6f72 0a20 2020 2020 2020 2073  ck for.        s
-0004b940: 7563 6365 7373 206f 7220 6661 696c 7572  uccess or failur
-0004b950: 652c 2061 6e64 2069 7320 696e 7465 6e64  e, and is intend
-0004b960: 6564 2066 6f72 2068 6f75 7365 6b65 6570  ed for housekeep
-0004b970: 696e 6720 616e 6420 6e6f 7420 666f 7220  ing and not for 
-0004b980: 636f 6d70 7574 6174 696f 6e2e 0a20 2020  computation..   
-0004b990: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0004b9a0: 2077 686f 5f68 6173 203d 207b 7d0a 2020   who_has = {}.  
-0004b9b0: 2020 2020 2020 6e62 7974 6573 203d 207b        nbytes = {
-0004b9c0: 7d0a 2020 2020 2020 2020 666f 7220 6b65  }.        for ke
-0004b9d0: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
-0004b9e0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-0004b9f0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-0004ba00: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0004ba10: 732e 7768 6f5f 6861 730a 2020 2020 2020  s.who_has.      
-0004ba20: 2020 2020 2020 7768 6f5f 6861 735b 6b65        who_has[ke
-0004ba30: 795d 203d 205b 7773 2e61 6464 7265 7373  y] = [ws.address
-0004ba40: 2066 6f72 2077 7320 696e 2074 732e 7768   for ws in ts.wh
-0004ba50: 6f5f 6861 7320 6f72 2028 295d 0a20 2020  o_has or ()].   
-0004ba60: 2020 2020 2020 2020 206e 6279 7465 735b           nbytes[
-0004ba70: 6b65 795d 203d 2074 732e 6e62 7974 6573  key] = ts.nbytes
-0004ba80: 0a0a 2020 2020 2020 2020 7365 6c66 2e73  ..        self.s
-0004ba90: 7472 6561 6d5f 636f 6d6d 735b 6164 6472  tream_comms[addr
-0004baa0: 5d2e 7365 6e64 280a 2020 2020 2020 2020  ].send(.        
-0004bab0: 2020 2020 7b0a 2020 2020 2020 2020 2020      {.          
-0004bac0: 2020 2020 2020 226f 7022 3a20 2261 6371        "op": "acq
-0004bad0: 7569 7265 2d72 6570 6c69 6361 7322 2c0a  uire-replicas",.
-0004bae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004baf0: 2277 686f 5f68 6173 223a 2077 686f 5f68  "who_has": who_h
-0004bb00: 6173 2c0a 2020 2020 2020 2020 2020 2020  as,.            
-0004bb10: 2020 2020 226e 6279 7465 7322 3a20 6e62      "nbytes": nb
-0004bb20: 7974 6573 2c0a 2020 2020 2020 2020 2020  ytes,.          
-0004bb30: 2020 2020 2020 2273 7469 6d75 6c75 735f        "stimulus_
-0004bb40: 6964 223a 2073 7469 6d75 6c75 735f 6964  id": stimulus_id
-0004bb50: 2c0a 2020 2020 2020 2020 2020 2020 7d2c  ,.            },
-0004bb60: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0004bb70: 6465 6620 7265 7175 6573 745f 7265 6d6f  def request_remo
-0004bb80: 7665 5f72 6570 6c69 6361 7328 0a20 2020  ve_replicas(.   
-0004bb90: 2020 2020 2073 656c 662c 2061 6464 723a       self, addr:
-0004bba0: 2073 7472 2c20 6b65 7973 3a20 6c69 7374   str, keys: list
-0004bbb0: 5b4b 6579 5d2c 202a 2c20 7374 696d 756c  [Key], *, stimul
-0004bbc0: 7573 5f69 643a 2073 7472 0a20 2020 2029  us_id: str.    )
-0004bbd0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-0004bbe0: 2020 2222 2241 7379 6e63 6872 6f6e 6f75    """Asynchronou
-0004bbf0: 736c 7920 6173 6b20 6120 776f 726b 6572  sly ask a worker
-0004bc00: 2074 6f20 6469 7363 6172 6420 6974 7320   to discard its 
-0004bc10: 7265 706c 6963 6120 6f66 2074 6865 206c  replica of the l
-0004bc20: 6973 7465 6420 6b65 7973 2e0a 2020 2020  isted keys..    
-0004bc30: 2020 2020 5468 6973 206d 7573 7420 6e65      This must ne
-0004bc40: 7665 7220 6265 2075 7365 6420 746f 2064  ver be used to d
-0004bc50: 6573 7472 6f79 2074 6865 206c 6173 7420  estroy the last 
-0004bc60: 7265 706c 6963 6120 6f66 2061 206b 6579  replica of a key
-0004bc70: 2e20 5468 6973 2069 7320 610a 2020 2020  . This is a.    
-0004bc80: 2020 2020 6669 7265 2d61 6e64 2d66 6f72      fire-and-for
-0004bc90: 6765 7420 6f70 6572 6174 696f 6e2c 2069  get operation, i
-0004bca0: 6e74 656e 6465 6420 666f 7220 686f 7573  ntended for hous
-0004bcb0: 656b 6565 7069 6e67 2061 6e64 206e 6f74  ekeeping and not
-0004bcc0: 2066 6f72 2063 6f6d 7075 7461 7469 6f6e   for computation
-0004bcd0: 2e0a 0a20 2020 2020 2020 2054 6865 2072  ...        The r
-0004bce0: 6570 6c69 6361 2064 6973 6170 7065 6172  eplica disappear
-0004bcf0: 7320 696d 6d65 6469 6174 656c 7920 6672  s immediately fr
-0004bd00: 6f6d 2054 6173 6b53 7461 7465 2e77 686f  om TaskState.who
-0004bd10: 5f68 6173 206f 6e20 7468 6520 5363 6865  _has on the Sche
-0004bd20: 6475 6c65 7220 7369 6465 3b0a 2020 2020  duler side;.    
-0004bd30: 2020 2020 6966 2074 6865 2077 6f72 6b65      if the worke
-0004bd40: 7220 7265 6675 7365 7320 746f 2064 656c  r refuses to del
-0004bd50: 6574 652c 2065 2e67 2e20 6265 6361 7573  ete, e.g. becaus
-0004bd60: 6520 7468 6520 7461 736b 2069 7320 6120  e the task is a 
-0004bd70: 6465 7065 6e64 656e 6379 206f 660a 2020  dependency of.  
-0004bd80: 2020 2020 2020 616e 6f74 6865 7220 7461        another ta
-0004bd90: 736b 2072 756e 6e69 6e67 206f 6e20 6974  sk running on it
-0004bda0: 2c20 6974 2077 696c 6c20 2861 6c73 6f20  , it will (also 
-0004bdb0: 6173 796e 6368 726f 6e6f 7573 6c79 2920  asynchronously) 
-0004bdc0: 696e 666f 726d 2074 6865 2073 6368 6564  inform the sched
-0004bdd0: 756c 6572 0a20 2020 2020 2020 2074 6f20  uler.        to 
-0004bde0: 7265 2d61 6464 2069 7473 656c 6620 746f  re-add itself to
-0004bdf0: 2077 686f 5f68 6173 2e20 4966 2074 6865   who_has. If the
-0004be00: 2077 6f72 6b65 7220 6167 7265 6573 2074   worker agrees t
-0004be10: 6f20 6469 7363 6172 6420 7468 6520 7461  o discard the ta
-0004be20: 736b 2c20 7468 6572 6520 6973 0a20 2020  sk, there is.   
-0004be30: 2020 2020 206e 6f20 6665 6564 6261 636b       no feedback
-0004be40: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0004be50: 2020 2020 2020 7773 203d 2073 656c 662e        ws = self.
-0004be60: 776f 726b 6572 735b 6164 6472 5d0a 0a20  workers[addr].. 
-0004be70: 2020 2020 2020 2023 2054 6865 2073 6368         # The sch
-0004be80: 6564 756c 6572 2069 6d6d 6564 6961 7465  eduler immediate
-0004be90: 6c79 2066 6f72 6765 7473 2061 626f 7574  ly forgets about
-0004bea0: 2074 6865 2072 6570 6c69 6361 2061 6e64   the replica and
-0004beb0: 2073 7567 6765 7374 7320 7468 6520 776f   suggests the wo
-0004bec0: 726b 6572 2074 6f0a 2020 2020 2020 2020  rker to.        
-0004bed0: 2320 6472 6f70 2069 742e 2054 6865 2077  # drop it. The w
-0004bee0: 6f72 6b65 7220 6d61 7920 7265 6675 7365  orker may refuse
-0004bef0: 2c20 6174 2077 6869 6368 2070 6f69 6e74  , at which point
-0004bf00: 2069 7420 7769 6c6c 2073 656e 6420 6261   it will send ba
-0004bf10: 636b 2061 6e20 6164 642d 6b65 7973 0a20  ck an add-keys. 
-0004bf20: 2020 2020 2020 2023 206d 6573 7361 6765         # message
-0004bf30: 2074 6f20 7265 696e 7374 6174 6520 6974   to reinstate it
-0004bf40: 2e0a 2020 2020 2020 2020 666f 7220 6b65  ..        for ke
-0004bf50: 7920 696e 206b 6579 733a 0a20 2020 2020  y in keys:.     
-0004bf60: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
-0004bf70: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
-0004bf80: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0004bf90: 7661 6c69 6461 7465 3a0a 2020 2020 2020  validate:.      
-0004bfa0: 2020 2020 2020 2020 2020 2320 446f 206e            # Do n
-0004bfb0: 6f74 2064 6573 7472 6f79 2074 6865 206c  ot destroy the l
-0004bfc0: 6173 7420 636f 7079 0a20 2020 2020 2020  ast copy.       
-0004bfd0: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0004bfe0: 7473 2e77 686f 5f68 6173 0a20 2020 2020  ts.who_has.     
-0004bff0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0004c000: 7420 6c65 6e28 7473 2e77 686f 5f68 6173  t len(ts.who_has
-0004c010: 2920 3e20 310a 2020 2020 2020 2020 2020  ) > 1.          
-0004c020: 2020 7365 6c66 2e72 656d 6f76 655f 7265    self.remove_re
-0004c030: 706c 6963 6128 7473 2c20 7773 290a 0a20  plica(ts, ws).. 
-0004c040: 2020 2020 2020 2073 656c 662e 7374 7265         self.stre
-0004c050: 616d 5f63 6f6d 6d73 5b61 6464 725d 2e73  am_comms[addr].s
-0004c060: 656e 6428 0a20 2020 2020 2020 2020 2020  end(.           
-0004c070: 207b 0a20 2020 2020 2020 2020 2020 2020   {.             
-0004c080: 2020 2022 6f70 223a 2022 7265 6d6f 7665     "op": "remove
-0004c090: 2d72 6570 6c69 6361 7322 2c0a 2020 2020  -replicas",.    
-0004c0a0: 2020 2020 2020 2020 2020 2020 226b 6579              "key
-0004c0b0: 7322 3a20 6b65 7973 2c0a 2020 2020 2020  s": keys,.      
-0004c0c0: 2020 2020 2020 2020 2020 2273 7469 6d75            "stimu
-0004c0d0: 6c75 735f 6964 223a 2073 7469 6d75 6c75  lus_id": stimulu
-0004c0e0: 735f 6964 2c0a 2020 2020 2020 2020 2020  s_id,.          
-0004c0f0: 2020 7d0a 2020 2020 2020 2020 290a 0a0a    }.        )...
-0004c100: 6465 6620 5f74 6173 6b5f 746f 5f72 6570  def _task_to_rep
-0004c110: 6f72 745f 6d73 6728 7473 3a20 5461 736b  ort_msg(ts: Task
-0004c120: 5374 6174 6529 202d 3e20 6469 6374 5b73  State) -> dict[s
-0004c130: 7472 2c20 416e 795d 207c 204e 6f6e 653a  tr, Any] | None:
-0004c140: 0a20 2020 2069 6620 7473 2e73 7461 7465  .    if ts.state
-0004c150: 203d 3d20 2266 6f72 676f 7474 656e 223a   == "forgotten":
-0004c160: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0004c170: 7b22 6f70 223a 2022 6361 6e63 656c 6c65  {"op": "cancelle
-0004c180: 642d 6b65 7973 222c 2022 6b65 7973 223a  d-keys", "keys":
-0004c190: 205b 7473 2e6b 6579 5d7d 0a20 2020 2065   [ts.key]}.    e
-0004c1a0: 6c69 6620 7473 2e73 7461 7465 203d 3d20  lif ts.state == 
-0004c1b0: 226d 656d 6f72 7922 3a0a 2020 2020 2020  "memory":.      
-0004c1c0: 2020 7265 7475 726e 207b 226f 7022 3a20    return {"op": 
-0004c1d0: 226b 6579 2d69 6e2d 6d65 6d6f 7279 222c  "key-in-memory",
-0004c1e0: 2022 6b65 7922 3a20 7473 2e6b 6579 7d0a   "key": ts.key}.
-0004c1f0: 2020 2020 656c 6966 2074 732e 7374 6174      elif ts.stat
-0004c200: 6520 3d3d 2022 6572 7265 6422 3a0a 2020  e == "erred":.  
-0004c210: 2020 2020 2020 6661 696c 696e 675f 7473        failing_ts
-0004c220: 203d 2074 732e 6578 6365 7074 696f 6e5f   = ts.exception_
-0004c230: 626c 616d 650a 2020 2020 2020 2020 6173  blame.        as
-0004c240: 7365 7274 2066 6169 6c69 6e67 5f74 730a  sert failing_ts.
-0004c250: 2020 2020 2020 2020 7265 7475 726e 207b          return {
-0004c260: 0a20 2020 2020 2020 2020 2020 2022 6f70  .            "op
-0004c270: 223a 2022 7461 736b 2d65 7272 6564 222c  ": "task-erred",
-0004c280: 0a20 2020 2020 2020 2020 2020 2022 6b65  .            "ke
-0004c290: 7922 3a20 7473 2e6b 6579 2c0a 2020 2020  y": ts.key,.    
-0004c2a0: 2020 2020 2020 2020 2265 7863 6570 7469          "excepti
-0004c2b0: 6f6e 223a 2066 6169 6c69 6e67 5f74 732e  on": failing_ts.
-0004c2c0: 6578 6365 7074 696f 6e2c 0a20 2020 2020  exception,.     
-0004c2d0: 2020 2020 2020 2022 7472 6163 6562 6163         "tracebac
-0004c2e0: 6b22 3a20 6661 696c 696e 675f 7473 2e74  k": failing_ts.t
-0004c2f0: 7261 6365 6261 636b 2c0a 2020 2020 2020  raceback,.      
-0004c300: 2020 7d0a 2020 2020 656c 7365 3a0a 2020    }.    else:.  
-0004c310: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-0004c320: 650a 0a0a 6465 6620 5f74 6173 6b5f 746f  e...def _task_to
-0004c330: 5f63 6c69 656e 745f 6d73 6773 2874 733a  _client_msgs(ts:
-0004c340: 2054 6173 6b53 7461 7465 2920 2d3e 204d   TaskState) -> M
-0004c350: 7367 733a 0a20 2020 2069 6620 7473 2e77  sgs:.    if ts.w
-0004c360: 686f 5f77 616e 7473 3a0a 2020 2020 2020  ho_wants:.      
-0004c370: 2020 7265 706f 7274 5f6d 7367 203d 205f    report_msg = _
-0004c380: 7461 736b 5f74 6f5f 7265 706f 7274 5f6d  task_to_report_m
-0004c390: 7367 2874 7329 0a20 2020 2020 2020 2069  sg(ts).        i
-0004c3a0: 6620 7265 706f 7274 5f6d 7367 2069 7320  f report_msg is 
-0004c3b0: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-0004c3c0: 2020 2020 2020 7265 7475 726e 207b 6373        return {cs
-0004c3d0: 2e63 6c69 656e 745f 6b65 793a 205b 7265  .client_key: [re
-0004c3e0: 706f 7274 5f6d 7367 5d20 666f 7220 6373  port_msg] for cs
-0004c3f0: 2069 6e20 7473 2e77 686f 5f77 616e 7473   in ts.who_wants
-0004c400: 7d0a 2020 2020 7265 7475 726e 207b 7d0a  }.    return {}.
-0004c410: 0a0a 6465 6620 6465 6369 6465 5f77 6f72  ..def decide_wor
-0004c420: 6b65 7228 0a20 2020 2074 733a 2054 6173  ker(.    ts: Tas
-0004c430: 6b53 7461 7465 2c0a 2020 2020 616c 6c5f  kState,.    all_
-0004c440: 776f 726b 6572 733a 2073 6574 5b57 6f72  workers: set[Wor
-0004c450: 6b65 7253 7461 7465 5d2c 0a20 2020 2076  kerState],.    v
-0004c460: 616c 6964 5f77 6f72 6b65 7273 3a20 7365  alid_workers: se
-0004c470: 745b 576f 726b 6572 5374 6174 655d 207c  t[WorkerState] |
-0004c480: 204e 6f6e 652c 0a20 2020 206f 626a 6563   None,.    objec
-0004c490: 7469 7665 3a20 4361 6c6c 6162 6c65 5b5b  tive: Callable[[
-0004c4a0: 576f 726b 6572 5374 6174 655d 2c20 416e  WorkerState], An
-0004c4b0: 795d 2c0a 2920 2d3e 2057 6f72 6b65 7253  y],.) -> WorkerS
-0004c4c0: 7461 7465 207c 204e 6f6e 653a 0a20 2020  tate | None:.   
-0004c4d0: 2022 2222 0a20 2020 2044 6563 6964 6520   """.    Decide 
-0004c4e0: 7768 6963 6820 776f 726b 6572 2073 686f  which worker sho
-0004c4f0: 756c 6420 7461 6b65 2074 6173 6b20 2a74  uld take task *t
-0004c500: 732a 2e0a 0a20 2020 2057 6520 6368 6f6f  s*...    We choo
-0004c510: 7365 2074 6865 2077 6f72 6b65 7220 7468  se the worker th
-0004c520: 6174 2068 6173 2074 6865 2064 6174 6120  at has the data 
-0004c530: 6f6e 2077 6869 6368 202a 7473 2a20 6465  on which *ts* de
-0004c540: 7065 6e64 732e 0a0a 2020 2020 4966 2073  pends...    If s
-0004c550: 6576 6572 616c 2077 6f72 6b65 7273 2068  everal workers h
-0004c560: 6176 6520 6465 7065 6e64 656e 6369 6573  ave dependencies
-0004c570: 2074 6865 6e20 7765 2063 686f 6f73 6520   then we choose 
-0004c580: 7468 6520 6c65 7373 2d62 7573 7920 776f  the less-busy wo
-0004c590: 726b 6572 2e0a 0a20 2020 204f 7074 696f  rker...    Optio
-0004c5a0: 6e61 6c6c 7920 7072 6f76 6964 6520 2a76  nally provide *v
-0004c5b0: 616c 6964 5f77 6f72 6b65 7273 2a20 6f66  alid_workers* of
-0004c5c0: 2077 6865 7265 206a 6f62 7320 6172 6520   where jobs are 
-0004c5d0: 616c 6c6f 7765 6420 746f 206f 6363 7572  allowed to occur
-0004c5e0: 0a20 2020 2028 6966 2061 6c6c 2077 6f72  .    (if all wor
-0004c5f0: 6b65 7273 2061 7265 2061 6c6c 6f77 6564  kers are allowed
-0004c600: 2074 6f20 7461 6b65 2074 6865 2074 6173   to take the tas
-0004c610: 6b2c 2070 6173 7320 4e6f 6e65 2069 6e73  k, pass None ins
-0004c620: 7465 6164 292e 0a0a 2020 2020 4966 2074  tead)...    If t
-0004c630: 6865 2074 6173 6b20 7265 7175 6972 6573  he task requires
-0004c640: 2064 6174 6120 636f 6d6d 756e 6963 6174   data communicat
-0004c650: 696f 6e20 6265 6361 7573 6520 6e6f 2065  ion because no e
-0004c660: 6c69 6769 626c 6520 776f 726b 6572 2068  ligible worker h
-0004c670: 6173 0a20 2020 2061 6c6c 2074 6865 2064  as.    all the d
-0004c680: 6570 656e 6465 6e63 6965 7320 616c 7265  ependencies alre
-0004c690: 6164 792c 2074 6865 6e20 7765 2063 686f  ady, then we cho
-0004c6a0: 6f73 6520 746f 206d 696e 696d 697a 6520  ose to minimize 
-0004c6b0: 7468 6520 6e75 6d62 6572 0a20 2020 206f  the number.    o
-0004c6c0: 6620 6279 7465 7320 7365 6e74 2062 6574  f bytes sent bet
-0004c6d0: 7765 656e 2077 6f72 6b65 7273 2e20 2054  ween workers.  T
-0004c6e0: 6869 7320 6973 2064 6574 6572 6d69 6e65  his is determine
-0004c6f0: 6420 6279 2063 616c 6c69 6e67 2074 6865  d by calling the
-0004c700: 0a20 2020 202a 6f62 6a65 6374 6976 652a  .    *objective*
-0004c710: 2066 756e 6374 696f 6e2e 0a20 2020 2022   function..    "
-0004c720: 2222 0a20 2020 2061 7373 6572 7420 616c  "".    assert al
-0004c730: 6c28 6474 732e 7768 6f5f 6861 7320 666f  l(dts.who_has fo
-0004c740: 7220 6474 7320 696e 2074 732e 6465 7065  r dts in ts.depe
-0004c750: 6e64 656e 6369 6573 290a 2020 2020 6966  ndencies).    if
-0004c760: 2074 732e 6163 746f 723a 0a20 2020 2020   ts.actor:.     
-0004c770: 2020 2063 616e 6469 6461 7465 7320 3d20     candidates = 
-0004c780: 616c 6c5f 776f 726b 6572 732e 636f 7079  all_workers.copy
-0004c790: 2829 0a20 2020 2065 6c73 653a 0a20 2020  ().    else:.   
-0004c7a0: 2020 2020 2063 616e 6469 6461 7465 7320       candidates 
-0004c7b0: 3d20 7b77 7773 2066 6f72 2064 7473 2069  = {wws for dts i
-0004c7c0: 6e20 7473 2e64 6570 656e 6465 6e63 6965  n ts.dependencie
-0004c7d0: 7320 666f 7220 7777 7320 696e 2064 7473  s for wws in dts
-0004c7e0: 2e77 686f 5f68 6173 206f 7220 2829 7d0a  .who_has or ()}.
-0004c7f0: 2020 2020 2020 2020 6361 6e64 6964 6174          candidat
-0004c800: 6573 2026 3d20 616c 6c5f 776f 726b 6572  es &= all_worker
-0004c810: 730a 2020 2020 6966 2076 616c 6964 5f77  s.    if valid_w
-0004c820: 6f72 6b65 7273 2069 7320 4e6f 6e65 3a0a  orkers is None:.
-0004c830: 2020 2020 2020 2020 6966 206e 6f74 2063          if not c
-0004c840: 616e 6469 6461 7465 733a 0a20 2020 2020  andidates:.     
-0004c850: 2020 2020 2020 2063 616e 6469 6461 7465         candidate
-0004c860: 7320 3d20 616c 6c5f 776f 726b 6572 732e  s = all_workers.
-0004c870: 636f 7079 2829 0a20 2020 2065 6c73 653a  copy().    else:
-0004c880: 0a20 2020 2020 2020 2063 616e 6469 6461  .        candida
-0004c890: 7465 7320 263d 2076 616c 6964 5f77 6f72  tes &= valid_wor
-0004c8a0: 6b65 7273 0a20 2020 2020 2020 2069 6620  kers.        if 
-0004c8b0: 6e6f 7420 6361 6e64 6964 6174 6573 3a0a  not candidates:.
-0004c8c0: 2020 2020 2020 2020 2020 2020 6361 6e64              cand
-0004c8d0: 6964 6174 6573 203d 2076 616c 6964 5f77  idates = valid_w
-0004c8e0: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
-0004c8f0: 2020 2069 6620 6e6f 7420 6361 6e64 6964     if not candid
-0004c900: 6174 6573 3a0a 2020 2020 2020 2020 2020  ates:.          
-0004c910: 2020 2020 2020 6966 2074 732e 6c6f 6f73        if ts.loos
-0004c920: 655f 7265 7374 7269 6374 696f 6e73 3a0a  e_restrictions:.
-0004c930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004c940: 2020 2020 7265 7475 726e 2064 6563 6964      return decid
-0004c950: 655f 776f 726b 6572 2874 732c 2061 6c6c  e_worker(ts, all
-0004c960: 5f77 6f72 6b65 7273 2c20 4e6f 6e65 2c20  _workers, None, 
-0004c970: 6f62 6a65 6374 6976 6529 0a0a 2020 2020  objective)..    
-0004c980: 6966 206e 6f74 2063 616e 6469 6461 7465  if not candidate
-0004c990: 733a 0a20 2020 2020 2020 2072 6574 7572  s:.        retur
-0004c9a0: 6e20 4e6f 6e65 0a20 2020 2065 6c69 6620  n None.    elif 
-0004c9b0: 6c65 6e28 6361 6e64 6964 6174 6573 2920  len(candidates) 
-0004c9c0: 3d3d 2031 3a0a 2020 2020 2020 2020 7265  == 1:.        re
-0004c9d0: 7475 726e 206e 6578 7428 6974 6572 2863  turn next(iter(c
-0004c9e0: 616e 6469 6461 7465 7329 290a 2020 2020  andidates)).    
-0004c9f0: 656c 7365 3a0a 2020 2020 2020 2020 7265  else:.        re
-0004ca00: 7475 726e 206d 696e 2863 616e 6469 6461  turn min(candida
-0004ca10: 7465 732c 206b 6579 3d6f 626a 6563 7469  tes, key=objecti
-0004ca20: 7665 290a 0a0a 6465 6620 7661 6c69 6461  ve)...def valida
-0004ca30: 7465 5f74 6173 6b5f 7374 6174 6528 7473  te_task_state(ts
-0004ca40: 3a20 5461 736b 5374 6174 6529 202d 3e20  : TaskState) -> 
-0004ca50: 4e6f 6e65 3a0a 2020 2020 2222 2256 616c  None:.    """Val
-0004ca60: 6964 6174 6520 7468 6520 6769 7665 6e20  idate the given 
-0004ca70: 5461 736b 5374 6174 6522 2222 0a20 2020  TaskState""".   
-0004ca80: 2061 7373 6572 7420 7473 2e73 7461 7465   assert ts.state
-0004ca90: 2069 6e20 414c 4c5f 5441 534b 5f53 5441   in ALL_TASK_STA
-0004caa0: 5445 532c 2074 730a 0a20 2020 2069 6620  TES, ts..    if 
-0004cab0: 7473 2e77 6169 7469 6e67 5f6f 6e3a 0a20  ts.waiting_on:. 
-0004cac0: 2020 2020 2020 2061 7373 6572 7420 7473         assert ts
-0004cad0: 2e77 6169 7469 6e67 5f6f 6e2e 6973 7375  .waiting_on.issu
-0004cae0: 6273 6574 2874 732e 6465 7065 6e64 656e  bset(ts.dependen
-0004caf0: 6369 6573 292c 2028 0a20 2020 2020 2020  cies), (.       
-0004cb00: 2020 2020 2022 7761 6974 696e 6720 6e6f       "waiting no
-0004cb10: 7420 7375 6273 6574 206f 6620 6465 7065  t subset of depe
-0004cb20: 6e64 656e 6369 6573 222c 0a20 2020 2020  ndencies",.     
-0004cb30: 2020 2020 2020 2073 7472 2874 732e 7761         str(ts.wa
-0004cb40: 6974 696e 675f 6f6e 292c 0a20 2020 2020  iting_on),.     
-0004cb50: 2020 2020 2020 2073 7472 2874 732e 6465         str(ts.de
-0004cb60: 7065 6e64 656e 6369 6573 292c 0a20 2020  pendencies),.   
-0004cb70: 2020 2020 2029 0a20 2020 2069 6620 7473       ).    if ts
-0004cb80: 2e77 6169 7465 7273 3a0a 2020 2020 2020  .waiters:.      
-0004cb90: 2020 6173 7365 7274 2074 732e 7761 6974    assert ts.wait
-0004cba0: 6572 732e 6973 7375 6273 6574 2874 732e  ers.issubset(ts.
-0004cbb0: 6465 7065 6e64 656e 7473 292c 2028 0a20  dependents), (. 
-0004cbc0: 2020 2020 2020 2020 2020 2022 7761 6974             "wait
-0004cbd0: 6572 7320 6e6f 7420 7375 6273 6574 206f  ers not subset o
-0004cbe0: 6620 6465 7065 6e64 656e 7473 222c 0a20  f dependents",. 
-0004cbf0: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
-0004cc00: 732e 7761 6974 6572 7329 2c0a 2020 2020  s.waiters),.    
-0004cc10: 2020 2020 2020 2020 7374 7228 7473 2e64          str(ts.d
-0004cc20: 6570 656e 6465 6e74 7329 2c0a 2020 2020  ependents),.    
-0004cc30: 2020 2020 290a 0a20 2020 2066 6f72 2064      )..    for d
-0004cc40: 7473 2069 6e20 7473 2e77 6169 7469 6e67  ts in ts.waiting
-0004cc50: 5f6f 6e20 6f72 2028 293a 0a20 2020 2020  _on or ():.     
-0004cc60: 2020 2061 7373 6572 7420 6e6f 7420 6474     assert not dt
-0004cc70: 732e 7768 6f5f 6861 732c 2028 2277 6169  s.who_has, ("wai
-0004cc80: 7469 6e67 206f 6e20 696e 2d6d 656d 6f72  ting on in-memor
-0004cc90: 7920 6465 7022 2c20 7374 7228 7473 292c  y dep", str(ts),
-0004cca0: 2073 7472 2864 7473 2929 0a20 2020 2020   str(dts)).     
-0004ccb0: 2020 2061 7373 6572 7420 6474 732e 7374     assert dts.st
-0004ccc0: 6174 6520 213d 2022 7265 6c65 6173 6564  ate != "released
-0004ccd0: 222c 2028 2277 6169 7469 6e67 206f 6e20  ", ("waiting on 
-0004cce0: 7265 6c65 6173 6564 2064 6570 222c 2073  released dep", s
-0004ccf0: 7472 2874 7329 2c20 7374 7228 6474 7329  tr(ts), str(dts)
-0004cd00: 290a 2020 2020 666f 7220 6474 7320 696e  ).    for dts in
-0004cd10: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
-0004cd20: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-0004cd30: 2074 7320 696e 2064 7473 2e64 6570 656e   ts in dts.depen
-0004cd40: 6465 6e74 732c 2028 0a20 2020 2020 2020  dents, (.       
-0004cd50: 2020 2020 2022 6e6f 7420 696e 2064 6570       "not in dep
-0004cd60: 656e 6465 6e63 7927 7320 6465 7065 6e64  endency's depend
-0004cd70: 656e 7473 222c 0a20 2020 2020 2020 2020  ents",.         
-0004cd80: 2020 2073 7472 2874 7329 2c0a 2020 2020     str(ts),.    
-0004cd90: 2020 2020 2020 2020 7374 7228 6474 7329          str(dts)
-0004cda0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-0004cdb0: 7228 6474 732e 6465 7065 6e64 656e 7473  r(dts.dependents
-0004cdc0: 292c 0a20 2020 2020 2020 2029 0a20 2020  ),.        ).   
-0004cdd0: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
-0004cde0: 2069 6e20 2822 7761 6974 696e 6722 2c20   in ("waiting", 
-0004cdf0: 2271 7565 7565 6422 2c20 2270 726f 6365  "queued", "proce
-0004ce00: 7373 696e 6722 2c20 226e 6f2d 776f 726b  ssing", "no-work
-0004ce10: 6572 2229 3a0a 2020 2020 2020 2020 2020  er"):.          
-0004ce20: 2020 6173 7365 7274 2074 732e 7761 6974    assert ts.wait
-0004ce30: 696e 675f 6f6e 2061 6e64 2064 7473 2069  ing_on and dts i
-0004ce40: 6e20 7473 2e77 6169 7469 6e67 5f6f 6e20  n ts.waiting_on 
-0004ce50: 6f72 2064 7473 2e77 686f 5f68 6173 2c20  or dts.who_has, 
-0004ce60: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0004ce70: 2020 2264 6570 206d 6973 7369 6e67 222c    "dep missing",
-0004ce80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0004ce90: 2073 7472 2874 7329 2c0a 2020 2020 2020   str(ts),.      
-0004cea0: 2020 2020 2020 2020 2020 7374 7228 6474            str(dt
-0004ceb0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-0004cec0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-0004ced0: 2064 7473 2e73 7461 7465 2021 3d20 2266   dts.state != "f
-0004cee0: 6f72 676f 7474 656e 220a 0a20 2020 2066  orgotten"..    f
-0004cef0: 6f72 2064 7473 2069 6e20 7473 2e77 6169  or dts in ts.wai
-0004cf00: 7465 7273 206f 7220 2829 3a0a 2020 2020  ters or ():.    
-0004cf10: 2020 2020 6173 7365 7274 2064 7473 2e73      assert dts.s
-0004cf20: 7461 7465 2069 6e20 2822 7761 6974 696e  tate in ("waitin
-0004cf30: 6722 2c20 2271 7565 7565 6422 2c20 2270  g", "queued", "p
-0004cf40: 726f 6365 7373 696e 6722 2c20 226e 6f2d  rocessing", "no-
-0004cf50: 776f 726b 6572 2229 2c20 280a 2020 2020  worker"), (.    
-0004cf60: 2020 2020 2020 2020 2277 6169 7465 7220          "waiter 
-0004cf70: 6e6f 7420 696e 2070 6c61 7922 2c0a 2020  not in play",.  
-0004cf80: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
-0004cf90: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
-0004cfa0: 7472 2864 7473 292c 0a20 2020 2020 2020  tr(dts),.       
-0004cfb0: 2029 0a20 2020 2066 6f72 2064 7473 2069   ).    for dts i
-0004cfc0: 6e20 7473 2e64 6570 656e 6465 6e74 733a  n ts.dependents:
-0004cfd0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0004cfe0: 7473 2069 6e20 6474 732e 6465 7065 6e64  ts in dts.depend
-0004cff0: 656e 6369 6573 2c20 280a 2020 2020 2020  encies, (.      
-0004d000: 2020 2020 2020 226e 6f74 2069 6e20 6465        "not in de
-0004d010: 7065 6e64 656e 7427 7320 6465 7065 6e64  pendent's depend
-0004d020: 656e 6369 6573 222c 0a20 2020 2020 2020  encies",.       
-0004d030: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
-0004d040: 2020 2020 2020 2020 2020 7374 7228 6474            str(dt
-0004d050: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-0004d060: 7374 7228 6474 732e 6465 7065 6e64 656e  str(dts.dependen
-0004d070: 6369 6573 292c 0a20 2020 2020 2020 2029  cies),.        )
-0004d080: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0004d090: 6474 732e 7374 6174 6520 213d 2022 666f  dts.state != "fo
-0004d0a0: 7267 6f74 7465 6e22 0a0a 2020 2020 6173  rgotten"..    as
-0004d0b0: 7365 7274 2028 7473 2e70 726f 6365 7373  sert (ts.process
-0004d0c0: 696e 675f 6f6e 2069 7320 6e6f 7420 4e6f  ing_on is not No
-0004d0d0: 6e65 2920 3d3d 2028 7473 2e73 7461 7465  ne) == (ts.state
-0004d0e0: 203d 3d20 2270 726f 6365 7373 696e 6722   == "processing"
-0004d0f0: 290a 2020 2020 6173 7365 7274 2062 6f6f  ).    assert boo
-0004d100: 6c28 7473 2e77 686f 5f68 6173 2920 3d3d  l(ts.who_has) ==
-0004d110: 2028 7473 2e73 7461 7465 203d 3d20 226d   (ts.state == "m
-0004d120: 656d 6f72 7922 292c 2028 7473 2c20 7473  emory"), (ts, ts
-0004d130: 2e77 686f 5f68 6173 2c20 7473 2e73 7461  .who_has, ts.sta
-0004d140: 7465 290a 0a20 2020 2069 6620 7473 2e73  te)..    if ts.s
-0004d150: 7461 7465 203d 3d20 2271 7565 7565 6422  tate == "queued"
-0004d160: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-0004d170: 206e 6f74 2074 732e 7072 6f63 6573 7369   not ts.processi
-0004d180: 6e67 5f6f 6e0a 2020 2020 2020 2020 6173  ng_on.        as
-0004d190: 7365 7274 206e 6f74 2074 732e 7768 6f5f  sert not ts.who_
-0004d1a0: 6861 730a 2020 2020 2020 2020 6173 7365  has.        asse
-0004d1b0: 7274 2061 6c6c 2864 7473 2e77 686f 5f68  rt all(dts.who_h
-0004d1c0: 6173 2066 6f72 2064 7473 2069 6e20 7473  as for dts in ts
-0004d1d0: 2e64 6570 656e 6465 6e63 6965 7329 2c20  .dependencies), 
-0004d1e0: 280a 2020 2020 2020 2020 2020 2020 2274  (.            "t
-0004d1f0: 6173 6b20 7175 6575 6564 2077 6974 686f  ask queued witho
-0004d200: 7574 2061 6c6c 2064 6570 7322 2c0a 2020  ut all deps",.  
-0004d210: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
-0004d220: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
-0004d230: 7472 2874 732e 6465 7065 6e64 656e 6369  tr(ts.dependenci
-0004d240: 6573 292c 0a20 2020 2020 2020 2029 0a0a  es),.        )..
-0004d250: 2020 2020 6966 2074 732e 7374 6174 6520      if ts.state 
-0004d260: 3d3d 2022 7072 6f63 6573 7369 6e67 223a  == "processing":
-0004d270: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0004d280: 616c 6c28 6474 732e 7768 6f5f 6861 7320  all(dts.who_has 
-0004d290: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
-0004d2a0: 7065 6e64 656e 6369 6573 292c 2028 0a20  pendencies), (. 
-0004d2b0: 2020 2020 2020 2020 2020 2022 7461 736b             "task
-0004d2c0: 2070 726f 6365 7373 696e 6720 7769 7468   processing with
-0004d2d0: 6f75 7420 616c 6c20 6465 7073 222c 0a20  out all deps",. 
-0004d2e0: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
-0004d2f0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
-0004d300: 7374 7228 7473 2e64 6570 656e 6465 6e63  str(ts.dependenc
-0004d310: 6965 7329 2c0a 2020 2020 2020 2020 290a  ies),.        ).
-0004d320: 2020 2020 2020 2020 6173 7365 7274 206e          assert n
-0004d330: 6f74 2074 732e 7761 6974 696e 675f 6f6e  ot ts.waiting_on
-0004d340: 0a0a 2020 2020 6966 2074 732e 7768 6f5f  ..    if ts.who_
-0004d350: 6861 733a 0a20 2020 2020 2020 2061 7373  has:.        ass
-0004d360: 6572 7420 7473 2e77 6169 7465 7273 206f  ert ts.waiters o
-0004d370: 7220 7473 2e77 686f 5f77 616e 7473 2c20  r ts.who_wants, 
-0004d380: 280a 2020 2020 2020 2020 2020 2020 2275  (.            "u
-0004d390: 6e6e 6565 6465 6420 7461 736b 2069 6e20  nneeded task in 
-0004d3a0: 6d65 6d6f 7279 222c 0a20 2020 2020 2020  memory",.       
-0004d3b0: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
-0004d3c0: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
-0004d3d0: 2e77 686f 5f68 6173 292c 0a20 2020 2020  .who_has),.     
-0004d3e0: 2020 2029 0a20 2020 2020 2020 2069 6620     ).        if 
-0004d3f0: 7473 2e72 756e 5f73 7065 633a 2020 2320  ts.run_spec:  # 
-0004d400: 7761 7320 636f 6d70 7574 6564 0a20 2020  was computed.   
-0004d410: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0004d420: 7473 2e74 7970 650a 2020 2020 2020 2020  ts.type.        
-0004d430: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0004d440: 7461 6e63 6528 7473 2e74 7970 652c 2073  tance(ts.type, s
-0004d450: 7472 290a 2020 2020 2020 2020 6173 7365  tr).        asse
-0004d460: 7274 206e 6f74 2061 6e79 280a 2020 2020  rt not any(.    
-0004d470: 2020 2020 2020 2020 5b0a 2020 2020 2020          [.      
-0004d480: 2020 2020 2020 2020 2020 7473 2069 6e20            ts in 
-0004d490: 6474 732e 7761 6974 696e 675f 6f6e 0a20  dts.waiting_on. 
-0004d4a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0004d4b0: 6f72 2064 7473 2069 6e20 7473 2e64 6570  or dts in ts.dep
-0004d4c0: 656e 6465 6e74 730a 2020 2020 2020 2020  endents.        
-0004d4d0: 2020 2020 2020 2020 6966 2064 7473 2e77          if dts.w
-0004d4e0: 6169 7469 6e67 5f6f 6e20 6973 206e 6f74  aiting_on is not
-0004d4f0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
-0004d500: 2020 5d0a 2020 2020 2020 2020 290a 2020    ].        ).  
-0004d510: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
-0004d520: 7473 2e77 686f 5f68 6173 3a0a 2020 2020  ts.who_has:.    
-0004d530: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0004d540: 7320 696e 2077 732e 6861 735f 7768 6174  s in ws.has_what
-0004d550: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
-0004d560: 2020 2020 226e 6f74 2069 6e20 7768 6f5f      "not in who_
-0004d570: 6861 7327 2068 6173 5f77 6861 7422 2c0a  has' has_what",.
-0004d580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004d590: 7374 7228 7473 292c 0a20 2020 2020 2020  str(ts),.       
-0004d5a0: 2020 2020 2020 2020 2073 7472 2877 7329           str(ws)
-0004d5b0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0004d5c0: 2020 7374 7228 7773 2e68 6173 5f77 6861    str(ws.has_wha
-0004d5d0: 7429 2c0a 2020 2020 2020 2020 2020 2020  t),.            
-0004d5e0: 290a 0a20 2020 2066 6f72 2063 7320 696e  )..    for cs in
-0004d5f0: 2074 732e 7768 6f5f 7761 6e74 7320 6f72   ts.who_wants or
-0004d600: 2028 293a 0a20 2020 2020 2020 2061 7373   ():.        ass
-0004d610: 6572 7420 7473 2069 6e20 6373 2e77 616e  ert ts in cs.wan
-0004d620: 7473 5f77 6861 742c 2028 0a20 2020 2020  ts_what, (.     
-0004d630: 2020 2020 2020 2022 6e6f 7420 696e 2077         "not in w
-0004d640: 686f 5f77 616e 7473 2720 7761 6e74 735f  ho_wants' wants_
-0004d650: 7768 6174 222c 0a20 2020 2020 2020 2020  what",.         
-0004d660: 2020 2073 7472 2874 7329 2c0a 2020 2020     str(ts),.    
-0004d670: 2020 2020 2020 2020 7374 7228 6373 292c          str(cs),
-0004d680: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
-0004d690: 2863 732e 7761 6e74 735f 7768 6174 292c  (cs.wants_what),
-0004d6a0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
-0004d6b0: 6966 2074 732e 6163 746f 723a 0a20 2020  if ts.actor:.   
-0004d6c0: 2020 2020 2069 6620 7473 2e73 7461 7465       if ts.state
-0004d6d0: 203d 3d20 226d 656d 6f72 7922 3a0a 2020   == "memory":.  
-0004d6e0: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-0004d6f0: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
-0004d700: 2020 2020 2020 2020 6173 7365 7274 2073          assert s
-0004d710: 756d 2874 7320 696e 2077 732e 6163 746f  um(ts in ws.acto
-0004d720: 7273 2066 6f72 2077 7320 696e 2074 732e  rs for ws in ts.
-0004d730: 7768 6f5f 6861 7329 203d 3d20 310a 2020  who_has) == 1.  
-0004d740: 2020 2020 2020 6966 2074 732e 7374 6174        if ts.stat
-0004d750: 6520 3d3d 2022 7072 6f63 6573 7369 6e67  e == "processing
-0004d760: 223a 0a20 2020 2020 2020 2020 2020 2061  ":.            a
-0004d770: 7373 6572 7420 7473 2e70 726f 6365 7373  ssert ts.process
-0004d780: 696e 675f 6f6e 0a20 2020 2020 2020 2020  ing_on.         
-0004d790: 2020 2061 7373 6572 7420 7473 2069 6e20     assert ts in 
-0004d7a0: 7473 2e70 726f 6365 7373 696e 675f 6f6e  ts.processing_on
-0004d7b0: 2e61 6374 6f72 730a 2020 2020 2020 2020  .actors.        
-0004d7c0: 6173 7365 7274 2074 732e 7374 6174 6520  assert ts.state 
-0004d7d0: 213d 2022 7175 6575 6564 220a 0a0a 6465  != "queued"...de
-0004d7e0: 6620 7661 6c69 6461 7465 5f77 6f72 6b65  f validate_worke
-0004d7f0: 725f 7374 6174 6528 7773 3a20 576f 726b  r_state(ws: Work
-0004d800: 6572 5374 6174 6529 202d 3e20 4e6f 6e65  erState) -> None
-0004d810: 3a0a 2020 2020 666f 7220 7473 2069 6e20  :.    for ts in 
-0004d820: 7773 2e68 6173 5f77 6861 7420 6f72 2028  ws.has_what or (
-0004d830: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-0004d840: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
-0004d850: 2020 2020 2061 7373 6572 7420 7773 2069       assert ws i
-0004d860: 6e20 7473 2e77 686f 5f68 6173 2c20 280a  n ts.who_has, (.
-0004d870: 2020 2020 2020 2020 2020 2020 226e 6f74              "not
-0004d880: 2069 6e20 6861 735f 7768 6174 2720 7768   in has_what' wh
-0004d890: 6f5f 6861 7322 2c0a 2020 2020 2020 2020  o_has",.        
-0004d8a0: 2020 2020 7374 7228 7773 292c 0a20 2020      str(ws),.   
-0004d8b0: 2020 2020 2020 2020 2073 7472 2874 7329           str(ts)
-0004d8c0: 2c0a 2020 2020 2020 2020 2020 2020 7374  ,.            st
-0004d8d0: 7228 7473 2e77 686f 5f68 6173 292c 0a20  r(ts.who_has),. 
-0004d8e0: 2020 2020 2020 2029 0a0a 2020 2020 666f         )..    fo
-0004d8f0: 7220 7473 2069 6e20 7773 2e61 6374 6f72  r ts in ws.actor
-0004d900: 733a 0a20 2020 2020 2020 2061 7373 6572  s:.        asser
-0004d910: 7420 7473 2e73 7461 7465 2069 6e20 2822  t ts.state in ("
-0004d920: 6d65 6d6f 7279 222c 2022 7072 6f63 6573  memory", "proces
-0004d930: 7369 6e67 2229 0a0a 0a64 6566 2076 616c  sing")...def val
-0004d940: 6964 6174 655f 7374 6174 6528 0a20 2020  idate_state(.   
-0004d950: 2074 6173 6b73 3a20 6469 6374 5b4b 6579   tasks: dict[Key
-0004d960: 2c20 5461 736b 5374 6174 655d 2c0a 2020  , TaskState],.  
-0004d970: 2020 776f 726b 6572 733a 2064 6963 745b    workers: dict[
-0004d980: 7374 722c 2057 6f72 6b65 7253 7461 7465  str, WorkerState
-0004d990: 5d2c 0a20 2020 2063 6c69 656e 7473 3a20  ],.    clients: 
-0004d9a0: 6469 6374 5b73 7472 2c20 436c 6965 6e74  dict[str, Client
-0004d9b0: 5374 6174 655d 2c0a 2920 2d3e 204e 6f6e  State],.) -> Non
-0004d9c0: 653a 0a20 2020 2022 2222 5661 6c69 6461  e:.    """Valida
-0004d9d0: 7465 2061 2063 7572 7265 6e74 2072 756e  te a current run
-0004d9e0: 7469 6d65 2073 7461 7465 2e0a 0a20 2020  time state...   
-0004d9f0: 2054 6869 7320 7065 7266 6f72 6d73 2061   This performs a
-0004da00: 2073 6571 7565 6e63 6520 6f66 2063 6865   sequence of che
-0004da10: 636b 7320 6f6e 2074 6865 2065 6e74 6972  cks on the entir
-0004da20: 6520 6772 6170 682c 2072 756e 6e69 6e67  e graph, running
-0004da30: 2069 6e20 6162 6f75 7420 6c69 6e65 6172   in about linear
-0004da40: 0a20 2020 2074 696d 652e 2054 6869 7320  .    time. This 
-0004da50: 7261 6973 6573 2061 7373 6572 7420 6572  raises assert er
-0004da60: 726f 7273 2069 6620 616e 7974 6869 6e67  rors if anything
-0004da70: 2064 6f65 736e 2774 2063 6865 636b 206f   doesn't check o
-0004da80: 7574 2e0a 2020 2020 2222 220a 2020 2020  ut..    """.    
-0004da90: 666f 7220 7473 2069 6e20 7461 736b 732e  for ts in tasks.
-0004daa0: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
-0004dab0: 2020 7661 6c69 6461 7465 5f74 6173 6b5f    validate_task_
-0004dac0: 7374 6174 6528 7473 290a 0a20 2020 2066  state(ts)..    f
-0004dad0: 6f72 2077 7320 696e 2077 6f72 6b65 7273  or ws in workers
-0004dae0: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
-0004daf0: 2020 2076 616c 6964 6174 655f 776f 726b     validate_work
-0004db00: 6572 5f73 7461 7465 2877 7329 0a0a 2020  er_state(ws)..  
-0004db10: 2020 666f 7220 6373 2069 6e20 636c 6965    for cs in clie
-0004db20: 6e74 732e 7661 6c75 6573 2829 3a0a 2020  nts.values():.  
-0004db30: 2020 2020 2020 666f 7220 7473 2069 6e20        for ts in 
-0004db40: 6373 2e77 616e 7473 5f77 6861 7420 6f72  cs.wants_what or
-0004db50: 2028 293a 0a20 2020 2020 2020 2020 2020   ():.           
-0004db60: 2061 7373 6572 7420 7473 2e77 686f 5f77   assert ts.who_w
-0004db70: 616e 7473 0a20 2020 2020 2020 2020 2020  ants.           
-0004db80: 2061 7373 6572 7420 6373 2069 6e20 7473   assert cs in ts
-0004db90: 2e77 686f 5f77 616e 7473 2c20 280a 2020  .who_wants, (.  
-0004dba0: 2020 2020 2020 2020 2020 2020 2020 226e                "n
-0004dbb0: 6f74 2069 6e20 7761 6e74 735f 7768 6174  ot in wants_what
-0004dbc0: 2720 7768 6f5f 7761 6e74 7322 2c0a 2020  ' who_wants",.  
-0004dbd0: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0004dbe0: 7228 6373 292c 0a20 2020 2020 2020 2020  r(cs),.         
-0004dbf0: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
-0004dc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004dc10: 7374 7228 7473 2e77 686f 5f77 616e 7473  str(ts.who_wants
-0004dc20: 292c 0a20 2020 2020 2020 2020 2020 2029  ),.            )
-0004dc30: 0a0a 0a64 6566 2068 6561 7274 6265 6174  ...def heartbeat
-0004dc40: 5f69 6e74 6572 7661 6c28 6e3a 2069 6e74  _interval(n: int
-0004dc50: 2920 2d3e 2066 6c6f 6174 3a0a 2020 2020  ) -> float:.    
-0004dc60: 2222 2249 6e74 6572 7661 6c20 696e 2073  """Interval in s
-0004dc70: 6563 6f6e 6473 2074 6861 7420 7765 2064  econds that we d
-0004dc80: 6573 6972 6520 6865 6172 7462 6561 7473  esire heartbeats
-0004dc90: 2062 6173 6564 206f 6e20 6e75 6d62 6572   based on number
-0004dca0: 206f 6620 776f 726b 6572 7322 2222 0a20   of workers""". 
-0004dcb0: 2020 2069 6620 6e20 3c3d 2031 303a 0a20     if n <= 10:. 
-0004dcc0: 2020 2020 2020 2072 6574 7572 6e20 302e         return 0.
-0004dcd0: 350a 2020 2020 656c 6966 206e 203c 2035  5.    elif n < 5
-0004dce0: 303a 0a20 2020 2020 2020 2072 6574 7572  0:.        retur
-0004dcf0: 6e20 310a 2020 2020 656c 6966 206e 203c  n 1.    elif n <
-0004dd00: 2032 3030 3a0a 2020 2020 2020 2020 7265   200:.        re
-0004dd10: 7475 726e 2032 0a20 2020 2065 6c73 653a  turn 2.    else:
-0004dd20: 0a20 2020 2020 2020 2023 204e 6f20 6d6f  .        # No mo
-0004dd30: 7265 2074 6861 6e20 3230 3020 6865 6172  re than 200 hear
-0004dd40: 7462 6561 7473 2061 2073 6563 6f6e 6420  tbeats a second 
-0004dd50: 7363 616c 6564 2062 7920 776f 726b 6572  scaled by worker
-0004dd60: 730a 2020 2020 2020 2020 7265 7475 726e  s.        return
-0004dd70: 206e 202f 2032 3030 202b 2031 0a0a 0a64   n / 200 + 1...d
-0004dd80: 6566 205f 7461 736b 5f73 6c6f 7473 5f61  ef _task_slots_a
-0004dd90: 7661 696c 6162 6c65 2877 733a 2057 6f72  vailable(ws: Wor
-0004dda0: 6b65 7253 7461 7465 2c20 7361 7475 7261  kerState, satura
-0004ddb0: 7469 6f6e 5f66 6163 746f 723a 2066 6c6f  tion_factor: flo
-0004ddc0: 6174 2920 2d3e 2069 6e74 3a0a 2020 2020  at) -> int:.    
-0004ddd0: 2222 224e 756d 6265 7220 6f66 2074 6173  """Number of tas
-0004dde0: 6b73 2074 6861 7420 6361 6e20 6265 2073  ks that can be s
-0004ddf0: 656e 7420 746f 2074 6869 7320 776f 726b  ent to this work
-0004de00: 6572 2077 6974 686f 7574 206f 7665 7273  er without overs
-0004de10: 6174 7572 6174 696e 6720 6974 2222 220a  aturating it""".
-0004de20: 2020 2020 6173 7365 7274 206e 6f74 206d      assert not m
-0004de30: 6174 682e 6973 696e 6628 7361 7475 7261  ath.isinf(satura
-0004de40: 7469 6f6e 5f66 6163 746f 7229 0a20 2020  tion_factor).   
-0004de50: 2072 6574 7572 6e20 6d61 7828 6d61 7468   return max(math
-0004de60: 2e63 6569 6c28 7361 7475 7261 7469 6f6e  .ceil(saturation
-0004de70: 5f66 6163 746f 7220 2a20 7773 2e6e 7468  _factor * ws.nth
-0004de80: 7265 6164 7329 2c20 3129 202d 2028 0a20  reads), 1) - (. 
-0004de90: 2020 2020 2020 206c 656e 2877 732e 7072         len(ws.pr
-0004dea0: 6f63 6573 7369 6e67 2920 2d20 6c65 6e28  ocessing) - len(
-0004deb0: 7773 2e6c 6f6e 675f 7275 6e6e 696e 6729  ws.long_running)
-0004dec0: 0a20 2020 2029 0a0a 0a64 6566 205f 776f  .    )...def _wo
-0004ded0: 726b 6572 5f66 756c 6c28 7773 3a20 576f  rker_full(ws: Wo
-0004dee0: 726b 6572 5374 6174 652c 2073 6174 7572  rkerState, satur
-0004def0: 6174 696f 6e5f 6661 6374 6f72 3a20 666c  ation_factor: fl
-0004df00: 6f61 7429 202d 3e20 626f 6f6c 3a0a 2020  oat) -> bool:.  
-0004df10: 2020 6966 206d 6174 682e 6973 696e 6628    if math.isinf(
-0004df20: 7361 7475 7261 7469 6f6e 5f66 6163 746f  saturation_facto
-0004df30: 7229 3a0a 2020 2020 2020 2020 7265 7475  r):.        retu
-0004df40: 726e 2046 616c 7365 0a20 2020 2072 6574  rn False.    ret
-0004df50: 7572 6e20 5f74 6173 6b5f 736c 6f74 735f  urn _task_slots_
-0004df60: 6176 6169 6c61 626c 6528 7773 2c20 7361  available(ws, sa
-0004df70: 7475 7261 7469 6f6e 5f66 6163 746f 7229  turation_factor)
-0004df80: 203c 3d20 300a 0a0a 636c 6173 7320 4b69   <= 0...class Ki
-0004df90: 6c6c 6564 576f 726b 6572 2845 7863 6570  lledWorker(Excep
-0004dfa0: 7469 6f6e 293a 0a20 2020 2064 6566 205f  tion):.    def _
-0004dfb0: 5f69 6e69 745f 5f28 7365 6c66 2c20 7461  _init__(self, ta
-0004dfc0: 736b 3a20 4b65 792c 206c 6173 745f 776f  sk: Key, last_wo
-0004dfd0: 726b 6572 3a20 576f 726b 6572 5374 6174  rker: WorkerStat
-0004dfe0: 652c 2061 6c6c 6f77 6564 5f66 6169 6c75  e, allowed_failu
-0004dff0: 7265 733a 2069 6e74 293a 0a20 2020 2020  res: int):.     
-0004e000: 2020 2073 7570 6572 2829 2e5f 5f69 6e69     super().__ini
-0004e010: 745f 5f28 7461 736b 2c20 6c61 7374 5f77  t__(task, last_w
-0004e020: 6f72 6b65 722c 2061 6c6c 6f77 6564 5f66  orker, allowed_f
-0004e030: 6169 6c75 7265 7329 0a0a 2020 2020 4070  ailures)..    @p
-0004e040: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-0004e050: 7461 736b 2873 656c 6629 202d 3e20 4b65  task(self) -> Ke
-0004e060: 793a 0a20 2020 2020 2020 2072 6574 7572  y:.        retur
-0004e070: 6e20 7365 6c66 2e61 7267 735b 305d 0a0a  n self.args[0]..
-0004e080: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-0004e090: 2020 6465 6620 6c61 7374 5f77 6f72 6b65    def last_worke
-0004e0a0: 7228 7365 6c66 2920 2d3e 2057 6f72 6b65  r(self) -> Worke
-0004e0b0: 7253 7461 7465 3a0a 2020 2020 2020 2020  rState:.        
-0004e0c0: 7265 7475 726e 2073 656c 662e 6172 6773  return self.args
-0004e0d0: 5b31 5d0a 0a20 2020 2040 7072 6f70 6572  [1]..    @proper
-0004e0e0: 7479 0a20 2020 2064 6566 2061 6c6c 6f77  ty.    def allow
-0004e0f0: 6564 5f66 6169 6c75 7265 7328 7365 6c66  ed_failures(self
-0004e100: 2920 2d3e 2069 6e74 3a0a 2020 2020 2020  ) -> int:.      
-0004e110: 2020 7265 7475 726e 2073 656c 662e 6172    return self.ar
-0004e120: 6773 5b32 5d0a 0a20 2020 2064 6566 205f  gs[2]..    def _
-0004e130: 5f73 7472 5f5f 2873 656c 6629 202d 3e20  _str__(self) -> 
-0004e140: 7374 723a 0a20 2020 2020 2020 2072 6574  str:.        ret
-0004e150: 7572 6e20 280a 2020 2020 2020 2020 2020  urn (.          
-0004e160: 2020 6622 4174 7465 6d70 7465 6420 746f    f"Attempted to
-0004e170: 2072 756e 2074 6173 6b20 7b73 656c 662e   run task {self.
-0004e180: 7461 736b 2172 7d20 6f6e 207b 7365 6c66  task!r} on {self
-0004e190: 2e61 6c6c 6f77 6564 5f66 6169 6c75 7265  .allowed_failure
-0004e1a0: 7320 2b20 317d 2022 0a20 2020 2020 2020  s + 1} ".       
-0004e1b0: 2020 2020 2022 6469 6666 6572 656e 7420       "different 
-0004e1c0: 776f 726b 6572 732c 2062 7574 2061 6c6c  workers, but all
-0004e1d0: 2074 686f 7365 2077 6f72 6b65 7273 2064   those workers d
-0004e1e0: 6965 6420 7768 696c 6520 7275 6e6e 696e  ied while runnin
-0004e1f0: 6720 6974 2e20 220a 2020 2020 2020 2020  g it. ".        
-0004e200: 2020 2020 6622 5468 6520 6c61 7374 2077      f"The last w
-0004e210: 6f72 6b65 7220 7468 6174 2061 7474 656d  orker that attem
-0004e220: 7074 2074 6f20 7275 6e20 7468 6520 7461  pt to run the ta
-0004e230: 736b 2077 6173 207b 7365 6c66 2e6c 6173  sk was {self.las
-0004e240: 745f 776f 726b 6572 2e61 6464 7265 7373  t_worker.address
-0004e250: 7d2e 2022 0a20 2020 2020 2020 2020 2020  }. ".           
-0004e260: 2022 496e 7370 6563 7469 6e67 2077 6f72   "Inspecting wor
-0004e270: 6b65 7220 6c6f 6773 2069 7320 6f66 7465  ker logs is ofte
-0004e280: 6e20 6120 676f 6f64 206e 6578 7420 7374  n a good next st
-0004e290: 6570 2074 6f20 6469 6167 6e6f 7365 2077  ep to diagnose w
-0004e2a0: 6861 7420 7765 6e74 2077 726f 6e67 2e20  hat went wrong. 
-0004e2b0: 220a 2020 2020 2020 2020 2020 2020 2246  ".            "F
-0004e2c0: 6f72 206d 6f72 6520 696e 666f 726d 6174  or more informat
-0004e2d0: 696f 6e20 7365 6520 6874 7470 733a 2f2f  ion see https://
-0004e2e0: 6469 7374 7269 6275 7465 642e 6461 736b  distributed.dask
-0004e2f0: 2e6f 7267 2f65 6e2f 7374 6162 6c65 2f6b  .org/en/stable/k
-0004e300: 696c 6c65 642e 6874 6d6c 2e22 0a20 2020  illed.html.".   
-0004e310: 2020 2020 2029 0a0a 0a63 6c61 7373 2057       )...class W
-0004e320: 6f72 6b65 7253 7461 7475 7350 6c75 6769  orkerStatusPlugi
-0004e330: 6e28 5363 6865 6475 6c65 7250 6c75 6769  n(SchedulerPlugi
-0004e340: 6e29 3a0a 2020 2020 2222 2241 2070 6c75  n):.    """A plu
-0004e350: 6769 6e20 746f 2073 6861 7265 2077 6f72  gin to share wor
-0004e360: 6b65 7220 7374 6174 7573 2077 6974 6820  ker status with 
-0004e370: 6120 7265 6d6f 7465 206f 6273 6572 7665  a remote observe
-0004e380: 720a 0a20 2020 2054 6869 7320 6973 2075  r..    This is u
-0004e390: 7365 6420 696e 2063 6c75 7374 6572 206d  sed in cluster m
-0004e3a0: 616e 6167 6572 7320 746f 206b 6565 7020  anagers to keep 
-0004e3b0: 7570 6461 7465 6420 6162 6f75 7420 7468  updated about th
-0004e3c0: 6520 7374 6174 7573 206f 6620 7468 6520  e status of the 
-0004e3d0: 7363 6865 6475 6c65 722e 0a20 2020 2022  scheduler..    "
-0004e3e0: 2222 0a0a 2020 2020 6e61 6d65 3a20 436c  ""..    name: Cl
-0004e3f0: 6173 7356 6172 5b73 7472 5d20 3d20 2277  assVar[str] = "w
-0004e400: 6f72 6b65 722d 7374 6174 7573 220a 2020  orker-status".  
-0004e410: 2020 6263 6f6d 6d3a 2042 6174 6368 6564    bcomm: Batched
-0004e420: 5365 6e64 0a0a 2020 2020 6465 6620 5f5f  Send..    def __
-0004e430: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
-0004e440: 6564 756c 6572 3a20 5363 6865 6475 6c65  eduler: Schedule
-0004e450: 722c 2063 6f6d 6d3a 2043 6f6d 6d29 3a0a  r, comm: Comm):.
-0004e460: 2020 2020 2020 2020 7365 6c66 2e62 636f          self.bco
-0004e470: 6d6d 203d 2042 6174 6368 6564 5365 6e64  mm = BatchedSend
-0004e480: 2869 6e74 6572 7661 6c3d 2235 6d73 2229  (interval="5ms")
-0004e490: 0a20 2020 2020 2020 2073 656c 662e 6263  .        self.bc
-0004e4a0: 6f6d 6d2e 7374 6172 7428 636f 6d6d 290a  omm.start(comm).
-0004e4b0: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
-0004e4c0: 722e 6164 645f 706c 7567 696e 2873 656c  r.add_plugin(sel
-0004e4d0: 6629 0a0a 2020 2020 6465 6620 6164 645f  f)..    def add_
-0004e4e0: 776f 726b 6572 2873 656c 662c 2073 6368  worker(self, sch
-0004e4f0: 6564 756c 6572 3a20 5363 6865 6475 6c65  eduler: Schedule
-0004e500: 722c 2077 6f72 6b65 723a 2073 7472 2920  r, worker: str) 
-0004e510: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0004e520: 2069 6465 6e74 203d 2073 6368 6564 756c   ident = schedul
-0004e530: 6572 2e77 6f72 6b65 7273 5b77 6f72 6b65  er.workers[worke
-0004e540: 725d 2e69 6465 6e74 6974 7928 290a 2020  r].identity().  
-0004e550: 2020 2020 2020 6465 6c20 6964 656e 745b        del ident[
-0004e560: 226d 6574 7269 6373 225d 0a20 2020 2020  "metrics"].     
-0004e570: 2020 2064 656c 2069 6465 6e74 5b22 6c61     del ident["la
-0004e580: 7374 5f73 6565 6e22 5d0a 2020 2020 2020  st_seen"].      
-0004e590: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-0004e5a0: 2020 2073 656c 662e 6263 6f6d 6d2e 7365     self.bcomm.se
-0004e5b0: 6e64 285b 2261 6464 222c 207b 2277 6f72  nd(["add", {"wor
-0004e5c0: 6b65 7273 223a 207b 776f 726b 6572 3a20  kers": {worker: 
-0004e5d0: 6964 656e 747d 7d5d 290a 2020 2020 2020  ident}}]).      
-0004e5e0: 2020 6578 6365 7074 2043 6f6d 6d43 6c6f    except CommClo
-0004e5f0: 7365 6445 7272 6f72 3a0a 2020 2020 2020  sedError:.      
-0004e600: 2020 2020 2020 7363 6865 6475 6c65 722e        scheduler.
-0004e610: 7265 6d6f 7665 5f70 6c75 6769 6e28 6e61  remove_plugin(na
-0004e620: 6d65 3d73 656c 662e 6e61 6d65 290a 0a20  me=self.name).. 
-0004e630: 2020 2064 6566 2072 656d 6f76 655f 776f     def remove_wo
-0004e640: 726b 6572 2873 656c 662c 2073 6368 6564  rker(self, sched
-0004e650: 756c 6572 3a20 5363 6865 6475 6c65 722c  uler: Scheduler,
-0004e660: 2077 6f72 6b65 723a 2073 7472 2c20 2a2a   worker: str, **
-0004e670: 6b77 6172 6773 3a20 416e 7929 202d 3e20  kwargs: Any) -> 
-0004e680: 4e6f 6e65 3a0a 2020 2020 2020 2020 7472  None:.        tr
-0004e690: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
-0004e6a0: 656c 662e 6263 6f6d 6d2e 7365 6e64 285b  elf.bcomm.send([
-0004e6b0: 2272 656d 6f76 6522 2c20 776f 726b 6572  "remove", worker
-0004e6c0: 5d29 0a20 2020 2020 2020 2065 7863 6570  ]).        excep
-0004e6d0: 7420 436f 6d6d 436c 6f73 6564 4572 726f  t CommClosedErro
-0004e6e0: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
-0004e6f0: 6368 6564 756c 6572 2e72 656d 6f76 655f  cheduler.remove_
-0004e700: 706c 7567 696e 286e 616d 653d 7365 6c66  plugin(name=self
-0004e710: 2e6e 616d 6529 0a0a 2020 2020 6465 6620  .name)..    def 
-0004e720: 7465 6172 646f 776e 2873 656c 6629 202d  teardown(self) -
-0004e730: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
-0004e740: 7365 6c66 2e62 636f 6d6d 2e63 6c6f 7365  self.bcomm.close
-0004e750: 2829 0a0a 0a63 6c61 7373 2043 6f6c 6c65  ()...class Colle
-0004e760: 6374 5461 736b 4d65 7461 4461 7461 506c  ctTaskMetaDataPl
-0004e770: 7567 696e 2853 6368 6564 756c 6572 506c  ugin(SchedulerPl
-0004e780: 7567 696e 293a 0a20 2020 2073 6368 6564  ugin):.    sched
-0004e790: 756c 6572 3a20 5363 6865 6475 6c65 720a  uler: Scheduler.
-0004e7a0: 2020 2020 6e61 6d65 3a20 7374 720a 2020      name: str.  
-0004e7b0: 2020 6b65 7973 3a20 7365 745b 4b65 795d    keys: set[Key]
-0004e7c0: 0a20 2020 206d 6574 6164 6174 613a 2064  .    metadata: d
-0004e7d0: 6963 745b 4b65 792c 2041 6e79 5d0a 2020  ict[Key, Any].  
-0004e7e0: 2020 7374 6174 653a 2064 6963 745b 4b65    state: dict[Ke
-0004e7f0: 792c 2054 6173 6b53 7461 7465 5374 6174  y, TaskStateStat
-0004e800: 655d 0a0a 2020 2020 6465 6620 5f5f 696e  e]..    def __in
-0004e810: 6974 5f5f 2873 656c 662c 2073 6368 6564  it__(self, sched
-0004e820: 756c 6572 3a20 5363 6865 6475 6c65 722c  uler: Scheduler,
-0004e830: 206e 616d 653a 2073 7472 293a 0a20 2020   name: str):.   
-0004e840: 2020 2020 2073 656c 662e 7363 6865 6475       self.schedu
-0004e850: 6c65 7220 3d20 7363 6865 6475 6c65 720a  ler = scheduler.
-0004e860: 2020 2020 2020 2020 7365 6c66 2e6e 616d          self.nam
-0004e870: 6520 3d20 6e61 6d65 0a20 2020 2020 2020  e = name.       
-0004e880: 2073 656c 662e 6b65 7973 203d 2073 6574   self.keys = set
-0004e890: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-0004e8a0: 6d65 7461 6461 7461 203d 207b 7d0a 2020  metadata = {}.  
-0004e8b0: 2020 2020 2020 7365 6c66 2e73 7461 7465        self.state
-0004e8c0: 203d 207b 7d0a 0a20 2020 2064 6566 2075   = {}..    def u
-0004e8d0: 7064 6174 655f 6772 6170 6828 0a20 2020  pdate_graph(.   
-0004e8e0: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
-0004e8f0: 2020 2073 6368 6564 756c 6572 3a20 5363     scheduler: Sc
-0004e900: 6865 6475 6c65 722c 0a20 2020 2020 2020  heduler,.       
-0004e910: 202a 2c0a 2020 2020 2020 2020 6b65 7973   *,.        keys
-0004e920: 3a20 7365 745b 4b65 795d 2c0a 2020 2020  : set[Key],.    
-0004e930: 2020 2020 2a2a 6b77 6172 6773 3a20 416e      **kwargs: An
-0004e940: 792c 0a20 2020 2029 202d 3e20 4e6f 6e65  y,.    ) -> None
-0004e950: 3a0a 2020 2020 2020 2020 7365 6c66 2e6b  :.        self.k
-0004e960: 6579 732e 7570 6461 7465 286b 6579 7329  eys.update(keys)
-0004e970: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
-0004e980: 7469 6f6e 280a 2020 2020 2020 2020 7365  tion(.        se
-0004e990: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
-0004e9a0: 204b 6579 2c0a 2020 2020 2020 2020 7374   Key,.        st
-0004e9b0: 6172 743a 2054 6173 6b53 7461 7465 5374  art: TaskStateSt
-0004e9c0: 6174 652c 0a20 2020 2020 2020 2066 696e  ate,.        fin
-0004e9d0: 6973 683a 2054 6173 6b53 7461 7465 5374  ish: TaskStateSt
-0004e9e0: 6174 652c 0a20 2020 2020 2020 202a 6172  ate,.        *ar
-0004e9f0: 6773 3a20 416e 792c 0a20 2020 2020 2020  gs: Any,.       
-0004ea00: 202a 2a6b 7761 7267 733a 2041 6e79 2c0a   **kwargs: Any,.
-0004ea10: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-0004ea20: 2020 2020 2020 2069 6620 6669 6e69 7368         if finish
-0004ea30: 2069 6e20 2822 6d65 6d6f 7279 222c 2022   in ("memory", "
-0004ea40: 6572 7265 6422 293a 0a20 2020 2020 2020  erred"):.       
-0004ea50: 2020 2020 2074 7320 3d20 7365 6c66 2e73       ts = self.s
-0004ea60: 6368 6564 756c 6572 2e74 6173 6b73 2e67  cheduler.tasks.g
-0004ea70: 6574 286b 6579 290a 2020 2020 2020 2020  et(key).        
-0004ea80: 2020 2020 6966 2074 7320 6973 206e 6f74      if ts is not
-0004ea90: 204e 6f6e 6520 616e 6420 7473 2e6b 6579   None and ts.key
-0004eaa0: 2069 6e20 7365 6c66 2e6b 6579 733a 0a20   in self.keys:. 
-0004eab0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0004eac0: 656c 662e 6d65 7461 6461 7461 5b6b 6579  elf.metadata[key
-0004ead0: 5d20 3d20 7473 2e6d 6574 6164 6174 610a  ] = ts.metadata.
-0004eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004eaf0: 7365 6c66 2e73 7461 7465 5b6b 6579 5d20  self.state[key] 
-0004eb00: 3d20 6669 6e69 7368 0a20 2020 2020 2020  = finish.       
-0004eb10: 2020 2020 2020 2020 2073 656c 662e 6b65           self.ke
-0004eb20: 7973 2e64 6973 6361 7264 286b 6579 290a  ys.discard(key).
-0004eb30: 0a0a 6465 6620 5f6d 6174 6572 6961 6c69  ..def _materiali
-0004eb40: 7a65 5f67 7261 7068 280a 2020 2020 6772  ze_graph(.    gr
-0004eb50: 6170 683a 2048 6967 684c 6576 656c 4772  aph: HighLevelGr
-0004eb60: 6170 682c 2067 6c6f 6261 6c5f 616e 6e6f  aph, global_anno
-0004eb70: 7461 7469 6f6e 733a 2064 6963 745b 7374  tations: dict[st
-0004eb80: 722c 2041 6e79 5d0a 2920 2d3e 2074 7570  r, Any].) -> tup
-0004eb90: 6c65 5b64 6963 745b 4b65 792c 2054 5f72  le[dict[Key, T_r
-0004eba0: 756e 7370 6563 5d2c 2064 6963 745b 4b65  unspec], dict[Ke
-0004ebb0: 792c 2073 6574 5b4b 6579 5d5d 2c20 6469  y, set[Key]], di
-0004ebc0: 6374 5b73 7472 2c20 6469 6374 5b4b 6579  ct[str, dict[Key
-0004ebd0: 2c20 416e 795d 5d5d 3a0a 2020 2020 6473  , Any]]]:.    ds
-0004ebe0: 6b20 3d20 656e 7375 7265 5f64 6963 7428  k = ensure_dict(
-0004ebf0: 6772 6170 6829 0a20 2020 2066 6f72 206b  graph).    for k
-0004ec00: 2069 6e20 6473 6b3a 0a20 2020 2020 2020   in dsk:.       
-0004ec10: 2076 616c 6964 6174 655f 6b65 7928 6b29   validate_key(k)
-0004ec20: 0a20 2020 2061 6e6e 6f74 6174 696f 6e73  .    annotations
-0004ec30: 5f62 795f 7479 7065 3a20 6465 6661 756c  _by_type: defaul
-0004ec40: 7464 6963 745b 7374 722c 2064 6963 745b  tdict[str, dict[
-0004ec50: 4b65 792c 2041 6e79 5d5d 203d 2064 6566  Key, Any]] = def
-0004ec60: 6175 6c74 6469 6374 2864 6963 7429 0a20  aultdict(dict). 
-0004ec70: 2020 2066 6f72 2061 6e6e 6f74 6174 696f     for annotatio
-0004ec80: 6e73 5f74 7970 652c 2076 616c 7565 2069  ns_type, value i
-0004ec90: 6e20 676c 6f62 616c 5f61 6e6e 6f74 6174  n global_annotat
-0004eca0: 696f 6e73 2e69 7465 6d73 2829 3a0a 2020  ions.items():.  
-0004ecb0: 2020 2020 2020 616e 6e6f 7461 7469 6f6e        annotation
-0004ecc0: 735f 6279 5f74 7970 655b 616e 6e6f 7461  s_by_type[annota
-0004ecd0: 7469 6f6e 735f 7479 7065 5d2e 7570 6461  tions_type].upda
-0004ece0: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
-0004ecf0: 7b6b 3a20 2876 616c 7565 286b 2920 6966  {k: (value(k) if
-0004ed00: 2063 616c 6c61 626c 6528 7661 6c75 6529   callable(value)
-0004ed10: 2065 6c73 6520 7661 6c75 6529 2066 6f72   else value) for
-0004ed20: 206b 2069 6e20 6473 6b7d 0a20 2020 2020   k in dsk}.     
-0004ed30: 2020 2029 0a0a 2020 2020 666f 7220 6c61     )..    for la
-0004ed40: 7965 7220 696e 2067 7261 7068 2e6c 6179  yer in graph.lay
-0004ed50: 6572 732e 7661 6c75 6573 2829 3a0a 2020  ers.values():.  
-0004ed60: 2020 2020 2020 6966 206c 6179 6572 2e61        if layer.a
-0004ed70: 6e6e 6f74 6174 696f 6e73 3a0a 2020 2020  nnotations:.    
-0004ed80: 2020 2020 2020 2020 616e 6e6f 7420 3d20          annot = 
-0004ed90: 6c61 7965 722e 616e 6e6f 7461 7469 6f6e  layer.annotation
-0004eda0: 730a 2020 2020 2020 2020 2020 2020 666f  s.            fo
-0004edb0: 7220 616e 6e6f 745f 7479 7065 2c20 7661  r annot_type, va
-0004edc0: 6c75 6520 696e 2061 6e6e 6f74 2e69 7465  lue in annot.ite
-0004edd0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-0004ede0: 2020 2020 2020 616e 6e6f 7461 7469 6f6e        annotation
-0004edf0: 735f 6279 5f74 7970 655b 616e 6e6f 745f  s_by_type[annot_
-0004ee00: 7479 7065 5d2e 7570 6461 7465 280a 2020  type].update(.  
-0004ee10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0004ee20: 2020 7b6b 3a20 2876 616c 7565 286b 2920    {k: (value(k) 
-0004ee30: 6966 2063 616c 6c61 626c 6528 7661 6c75  if callable(valu
-0004ee40: 6529 2065 6c73 6520 7661 6c75 6529 2066  e) else value) f
-0004ee50: 6f72 206b 2069 6e20 6c61 7965 727d 0a20  or k in layer}. 
-0004ee60: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0004ee70: 0a20 2020 2064 6570 656e 6465 6e63 6965  .    dependencie
-0004ee80: 732c 205f 203d 2067 6574 5f64 6570 7328  s, _ = get_deps(
-0004ee90: 6473 6b29 0a0a 2020 2020 2320 5265 6d6f  dsk)..    # Remo
-0004eea0: 7665 2060 4675 7475 7265 6020 6f62 6a65  ve `Future` obje
-0004eeb0: 6374 7320 6672 6f6d 2067 7261 7068 2061  cts from graph a
-0004eec0: 6e64 206e 6f74 6520 616e 7920 6675 7475  nd note any futu
-0004eed0: 7265 2064 6570 656e 6465 6e63 6965 730a  re dependencies.
-0004eee0: 2020 2020 6473 6b32 203d 207b 7d0a 2020      dsk2 = {}.  
-0004eef0: 2020 6675 745f 6465 7073 203d 207b 7d0a    fut_deps = {}.
-0004ef00: 2020 2020 666f 7220 6b2c 2076 2069 6e20      for k, v in 
-0004ef10: 6473 6b2e 6974 656d 7328 293a 0a20 2020  dsk.items():.   
-0004ef20: 2020 2020 2076 2c20 6675 7473 203d 2075       v, futs = u
-0004ef30: 6e70 6163 6b5f 7265 6d6f 7465 6461 7461  npack_remotedata
-0004ef40: 2876 2c20 6279 7465 5f6b 6579 733d 5472  (v, byte_keys=Tr
-0004ef50: 7565 290a 2020 2020 2020 2020 6966 2066  ue).        if f
-0004ef60: 7574 733a 0a20 2020 2020 2020 2020 2020  uts:.           
-0004ef70: 2066 7574 5f64 6570 735b 6b5d 203d 2066   fut_deps[k] = f
-0004ef80: 7574 730a 0a20 2020 2020 2020 2023 2052  uts..        # R
-0004ef90: 656d 6f76 6520 616c 6961 7365 7320 7b78  emove aliases {x
-0004efa0: 3a20 787d 2e0a 2020 2020 2020 2020 2320  : x}..        # 
-0004efb0: 4649 584d 453a 2054 6869 7320 6973 2061  FIXME: This is a
-0004efc0: 6e20 6172 7469 6661 6374 2067 656e 6572  n artifact gener
-0004efd0: 6174 6564 2062 7920 756e 7061 636b 5f72  ated by unpack_r
-0004efe0: 656d 6f74 6564 6174 6120 7768 656e 2075  emotedata when u
-0004eff0: 7369 6e67 2070 6572 7369 7374 6564 0a20  sing persisted. 
-0004f000: 2020 2020 2020 2023 2063 6f6c 6c65 6374         # collect
-0004f010: 696f 6e73 2e20 5468 6572 6520 7368 6f75  ions. There shou
-0004f020: 6c64 2062 6520 6120 6265 7474 6572 2077  ld be a better w
-0004f030: 6179 2074 6f20 6163 6869 6576 6520 7468  ay to achieve th
-0004f040: 6174 2074 6173 6b73 2061 7265 206e 6f74  at tasks are not
-0004f050: 2073 656c 660a 2020 2020 2020 2020 2320   self.        # 
-0004f060: 7265 6665 7265 6e63 696e 6720 7468 656d  referencing them
-0004f070: 7365 6c76 6573 2e0a 2020 2020 2020 2020  selves..        
-0004f080: 6966 206e 6f74 2069 736b 6579 2876 2920  if not iskey(v) 
-0004f090: 6f72 2076 2021 3d20 6b3a 0a20 2020 2020  or v != k:.     
-0004f0a0: 2020 2020 2020 2064 736b 325b 6b5d 203d         dsk2[k] =
-0004f0b0: 2076 0a0a 2020 2020 6473 6b20 3d20 6473   v..    dsk = ds
-0004f0c0: 6b32 0a0a 2020 2020 2320 2d20 4164 6420  k2..    # - Add 
-0004f0d0: 696e 2064 6570 7320 666f 7220 616e 7920  in deps for any 
-0004f0e0: 7461 736b 7320 7468 6174 2064 6570 656e  tasks that depen
-0004f0f0: 6420 6f6e 2066 7574 7572 6573 0a20 2020  d on futures.   
-0004f100: 2066 6f72 206b 2c20 6675 7475 7265 7320   for k, futures 
-0004f110: 696e 2066 7574 5f64 6570 732e 6974 656d  in fut_deps.item
-0004f120: 7328 293a 0a20 2020 2020 2020 2064 6570  s():.        dep
-0004f130: 656e 6465 6e63 6965 735b 6b5d 2e75 7064  endencies[k].upd
-0004f140: 6174 6528 662e 6b65 7920 666f 7220 6620  ate(f.key for f 
-0004f150: 696e 2066 7574 7572 6573 290a 0a20 2020  in futures)..   
-0004f160: 2023 2052 656d 6f76 6520 616e 7920 7365   # Remove any se
-0004f170: 6c66 2d64 6570 656e 6465 6e63 6965 7320  lf-dependencies 
-0004f180: 2868 6170 7065 6e73 206f 6e20 7465 7374  (happens on test
-0004f190: 5f70 7562 6c69 7368 5f62 6167 2829 2061  _publish_bag() a
-0004f1a0: 6e64 206f 7468 6572 7329 0a20 2020 2066  nd others).    f
-0004f1b0: 6f72 206b 2c20 7620 696e 2064 6570 656e  or k, v in depen
-0004f1c0: 6465 6e63 6965 732e 6974 656d 7328 293a  dencies.items():
-0004f1d0: 0a20 2020 2020 2020 2064 6570 7320 3d20  .        deps = 
-0004f1e0: 7365 7428 7629 0a20 2020 2020 2020 2064  set(v).        d
-0004f1f0: 6570 732e 6469 7363 6172 6428 6b29 0a20  eps.discard(k). 
-0004f200: 2020 2020 2020 2064 6570 656e 6465 6e63         dependenc
-0004f210: 6965 735b 6b5d 203d 2064 6570 730a 0a20  ies[k] = deps.. 
-0004f220: 2020 2064 736b 203d 2076 616c 6d61 7028     dsk = valmap(
-0004f230: 5f6e 6f72 6d61 6c69 7a65 5f74 6173 6b2c  _normalize_task,
-0004f240: 2064 736b 290a 2020 2020 7265 7475 726e   dsk).    return
-0004f250: 2064 736b 2c20 6465 7065 6e64 656e 6369   dsk, dependenci
-0004f260: 6573 2c20 616e 6e6f 7461 7469 6f6e 735f  es, annotations_
-0004f270: 6279 5f74 7970 650a                      by_type.
+00043870: 2020 2020 2020 2072 6570 6f72 745f 6d73         report_ms
+00043880: 6720 3d20 5f74 6173 6b5f 746f 5f72 6570  g = _task_to_rep
+00043890: 6f72 745f 6d73 6728 7473 290a 2020 2020  ort_msg(ts).    
+000438a0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000438b0: 2020 2020 2020 7265 706f 7274 5f6d 7367        report_msg
+000438c0: 203d 207b 226f 7022 3a20 2263 616e 6365   = {"op": "cance
+000438d0: 6c6c 6564 2d6b 6579 7322 2c20 226b 6579  lled-keys", "key
+000438e0: 7322 3a20 5b6b 6579 5d7d 0a20 2020 2020  s": [key]}.     
+000438f0: 2020 2069 6620 7265 706f 7274 5f6d 7367     if report_msg
+00043900: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+00043910: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00043920: 6570 6f72 7428 7265 706f 7274 5f6d 7367  eport(report_msg
+00043930: 2c20 7473 3d74 732c 2063 6c69 656e 743d  , ts=ts, client=
+00043940: 636c 6965 6e74 290a 0a20 2020 2040 6c6f  client)..    @lo
+00043950: 675f 6572 726f 7273 0a20 2020 2061 7379  g_errors.    asy
+00043960: 6e63 2064 6566 2066 6565 6428 0a20 2020  nc def feed(.   
+00043970: 2020 2020 2073 656c 662c 0a20 2020 2020       self,.     
+00043980: 2020 2063 6f6d 6d3a 2043 6f6d 6d2c 0a20     comm: Comm,. 
+00043990: 2020 2020 2020 2066 756e 6374 696f 6e3a         function:
+000439a0: 2062 7974 6573 207c 204e 6f6e 6520 3d20   bytes | None = 
+000439b0: 4e6f 6e65 2c0a 2020 2020 2020 2020 7365  None,.        se
+000439c0: 7475 703a 2062 7974 6573 207c 204e 6f6e  tup: bytes | Non
+000439d0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+000439e0: 2020 7465 6172 646f 776e 3a20 6279 7465    teardown: byte
+000439f0: 7320 7c20 4e6f 6e65 203d 204e 6f6e 652c  s | None = None,
+00043a00: 0a20 2020 2020 2020 2069 6e74 6572 7661  .        interva
+00043a10: 6c3a 2073 7472 207c 2066 6c6f 6174 203d  l: str | float =
+00043a20: 2022 3173 222c 0a20 2020 2020 2020 202a   "1s",.        *
+00043a30: 2a6b 7761 7267 733a 2041 6e79 2c0a 2020  *kwargs: Any,.  
+00043a40: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+00043a50: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00043a60: 2050 726f 7669 6465 7320 6120 6461 7461   Provides a data
+00043a70: 2043 6f6d 6d20 746f 2065 7874 6572 6e61   Comm to externa
+00043a80: 6c20 7265 7175 6573 7465 720a 0a20 2020  l requester..   
+00043a90: 2020 2020 2043 6175 7469 6f6e 3a20 7468       Caution: th
+00043aa0: 6973 2072 756e 7320 6172 6269 7472 6172  is runs arbitrar
+00043ab0: 7920 5079 7468 6f6e 2063 6f64 6520 6f6e  y Python code on
+00043ac0: 2074 6865 2073 6368 6564 756c 6572 2e20   the scheduler. 
+00043ad0: 2054 6869 7320 7368 6f75 6c64 0a20 2020   This should.   
+00043ae0: 2020 2020 2065 7665 6e74 7561 6c6c 7920       eventually 
+00043af0: 6265 2070 6861 7365 6420 6f75 742e 2020  be phased out.  
+00043b00: 4974 2069 7320 6d6f 7374 6c79 2075 7365  It is mostly use
+00043b10: 6420 6279 2064 6961 676e 6f73 7469 6373  d by diagnostics
+00043b20: 2e0a 2020 2020 2020 2020 2222 220a 0a20  ..        """.. 
+00043b30: 2020 2020 2020 2069 6e74 6572 7661 6c20         interval 
+00043b40: 3d20 7061 7273 655f 7469 6d65 6465 6c74  = parse_timedelt
+00043b50: 6128 696e 7465 7276 616c 290a 2020 2020  a(interval).    
+00043b60: 2020 2020 6966 2066 756e 6374 696f 6e3a      if function:
+00043b70: 0a20 2020 2020 2020 2020 2020 2066 756e  .            fun
+00043b80: 6374 696f 6e20 3d20 7069 636b 6c65 2e6c  ction = pickle.l
+00043b90: 6f61 6473 2866 756e 6374 696f 6e29 0a20  oads(function). 
+00043ba0: 2020 2020 2020 2069 6620 7365 7475 703a         if setup:
+00043bb0: 0a20 2020 2020 2020 2020 2020 2073 6574  .            set
+00043bc0: 7570 203d 2070 6963 6b6c 652e 6c6f 6164  up = pickle.load
+00043bd0: 7328 7365 7475 7029 0a0a 2020 2020 2020  s(setup)..      
+00043be0: 2020 6966 2074 6561 7264 6f77 6e3a 0a20    if teardown:. 
+00043bf0: 2020 2020 2020 2020 2020 2074 6561 7264             teard
+00043c00: 6f77 6e20 3d20 7069 636b 6c65 2e6c 6f61  own = pickle.loa
+00043c10: 6473 2874 6561 7264 6f77 6e29 0a20 2020  ds(teardown).   
+00043c20: 2020 2020 2073 7461 7465 203d 2073 6574       state = set
+00043c30: 7570 2873 656c 6629 2069 6620 7365 7475  up(self) if setu
+00043c40: 7020 656c 7365 204e 6f6e 6520 2023 2074  p else None  # t
+00043c50: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+00043c60: 2020 2020 6966 2069 6e73 7065 6374 2e69      if inspect.i
+00043c70: 7361 7761 6974 6162 6c65 2873 7461 7465  sawaitable(state
+00043c80: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+00043c90: 7461 7465 203d 2061 7761 6974 2073 7461  tate = await sta
+00043ca0: 7465 0a20 2020 2020 2020 2074 7279 3a0a  te.        try:.
+00043cb0: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+00043cc0: 6520 7365 6c66 2e73 7461 7475 7320 3d3d  e self.status ==
+00043cd0: 2053 7461 7475 732e 7275 6e6e 696e 673a   Status.running:
+00043ce0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043cf0: 2069 6620 7374 6174 6520 6973 204e 6f6e   if state is Non
+00043d00: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00043d10: 2020 2020 2020 2072 6573 706f 6e73 6520         response 
+00043d20: 3d20 6675 6e63 7469 6f6e 2873 656c 6629  = function(self)
+00043d30: 2020 2320 7479 7065 3a20 6967 6e6f 7265    # type: ignore
+00043d40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00043d50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00043d60: 2020 2020 2020 2020 2020 2072 6573 706f             respo
+00043d70: 6e73 6520 3d20 6675 6e63 7469 6f6e 2873  nse = function(s
+00043d80: 656c 662c 2073 7461 7465 2920 2023 2074  elf, state)  # t
+00043d90: 7970 653a 2069 676e 6f72 650a 2020 2020  ype: ignore.    
+00043da0: 2020 2020 2020 2020 2020 2020 6177 6169              awai
+00043db0: 7420 636f 6d6d 2e77 7269 7465 2872 6573  t comm.write(res
+00043dc0: 706f 6e73 6529 0a20 2020 2020 2020 2020  ponse).         
+00043dd0: 2020 2020 2020 2061 7761 6974 2061 7379         await asy
+00043de0: 6e63 696f 2e73 6c65 6570 2869 6e74 6572  ncio.sleep(inter
+00043df0: 7661 6c29 0a20 2020 2020 2020 2065 7863  val).        exc
+00043e00: 6570 7420 4f53 4572 726f 723a 0a20 2020  ept OSError:.   
+00043e10: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+00043e20: 2020 2020 2020 6669 6e61 6c6c 793a 0a20        finally:. 
+00043e30: 2020 2020 2020 2020 2020 2069 6620 7465             if te
+00043e40: 6172 646f 776e 3a0a 2020 2020 2020 2020  ardown:.        
+00043e50: 2020 2020 2020 2020 7465 6172 646f 776e          teardown
+00043e60: 2873 656c 662c 2073 7461 7465 2920 2023  (self, state)  #
+00043e70: 2074 7970 653a 2069 676e 6f72 650a 0a20   type: ignore.. 
+00043e80: 2020 2064 6566 206c 6f67 5f77 6f72 6b65     def log_worke
+00043e90: 725f 6576 656e 7428 0a20 2020 2020 2020  r_event(.       
+00043ea0: 2073 656c 662c 2077 6f72 6b65 723a 2073   self, worker: s
+00043eb0: 7472 2c20 746f 7069 633a 2073 7472 207c  tr, topic: str |
+00043ec0: 2043 6f6c 6c65 6374 696f 6e5b 7374 725d   Collection[str]
+00043ed0: 2c20 6d73 673a 2041 6e79 0a20 2020 2029  , msg: Any.    )
+00043ee0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00043ef0: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00043f00: 6d73 672c 2064 6963 7429 2061 6e64 2077  msg, dict) and w
+00043f10: 6f72 6b65 7220 213d 2074 6f70 6963 3a0a  orker != topic:.
+00043f20: 2020 2020 2020 2020 2020 2020 6d73 675b              msg[
+00043f30: 2277 6f72 6b65 7222 5d20 3d20 776f 726b  "worker"] = work
+00043f40: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
+00043f50: 6c6f 675f 6576 656e 7428 746f 7069 632c  log_event(topic,
+00043f60: 206d 7367 290a 0a20 2020 2064 6566 2073   msg)..    def s
+00043f70: 7562 7363 7269 6265 5f77 6f72 6b65 725f  ubscribe_worker_
+00043f80: 7374 6174 7573 2873 656c 662c 2063 6f6d  status(self, com
+00043f90: 6d3a 2043 6f6d 6d29 202d 3e20 6469 6374  m: Comm) -> dict
+00043fa0: 5b73 7472 2c20 416e 795d 3a0a 2020 2020  [str, Any]:.    
+00043fb0: 2020 2020 576f 726b 6572 5374 6174 7573      WorkerStatus
+00043fc0: 506c 7567 696e 2873 656c 662c 2063 6f6d  Plugin(self, com
+00043fd0: 6d29 0a20 2020 2020 2020 2069 6465 6e74  m).        ident
+00043fe0: 203d 2073 656c 662e 6964 656e 7469 7479   = self.identity
+00043ff0: 2829 0a20 2020 2020 2020 2066 6f72 2076  ().        for v
+00044000: 2069 6e20 6964 656e 745b 2277 6f72 6b65   in ident["worke
+00044010: 7273 225d 2e76 616c 7565 7328 293a 0a20  rs"].values():. 
+00044020: 2020 2020 2020 2020 2020 2064 656c 2076             del v
+00044030: 5b22 6d65 7472 6963 7322 5d0a 2020 2020  ["metrics"].    
+00044040: 2020 2020 2020 2020 6465 6c20 765b 226c          del v["l
+00044050: 6173 745f 7365 656e 225d 0a20 2020 2020  ast_seen"].     
+00044060: 2020 2072 6574 7572 6e20 6964 656e 740a     return ident.
+00044070: 0a20 2020 2064 6566 2067 6574 5f70 726f  .    def get_pro
+00044080: 6365 7373 696e 6728 0a20 2020 2020 2020  cessing(.       
+00044090: 2073 656c 662c 2077 6f72 6b65 7273 3a20   self, workers: 
+000440a0: 4974 6572 6162 6c65 5b73 7472 5d20 7c20  Iterable[str] | 
+000440b0: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
+000440c0: 2920 2d3e 2064 6963 745b 7374 722c 206c  ) -> dict[str, l
+000440d0: 6973 745b 4b65 795d 5d3a 0a20 2020 2020  ist[Key]]:.     
+000440e0: 2020 2069 6620 776f 726b 6572 7320 6973     if workers is
+000440f0: 206e 6f74 204e 6f6e 653a 0a20 2020 2020   not None:.     
+00044100: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
+00044110: 2073 6574 286d 6170 2873 656c 662e 636f   set(map(self.co
+00044120: 6572 6365 5f61 6464 7265 7373 2c20 776f  erce_address, wo
+00044130: 726b 6572 7329 290a 2020 2020 2020 2020  rkers)).        
+00044140: 2020 2020 7265 7475 726e 207b 773a 205b      return {w: [
+00044150: 7473 2e6b 6579 2066 6f72 2074 7320 696e  ts.key for ts in
+00044160: 2073 656c 662e 776f 726b 6572 735b 775d   self.workers[w]
+00044170: 2e70 726f 6365 7373 696e 675d 2066 6f72  .processing] for
+00044180: 2077 2069 6e20 776f 726b 6572 737d 0a20   w in workers}. 
+00044190: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000441a0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000441b0: 7b0a 2020 2020 2020 2020 2020 2020 2020  {.              
+000441c0: 2020 773a 205b 7473 2e6b 6579 2066 6f72    w: [ts.key for
+000441d0: 2074 7320 696e 2077 732e 7072 6f63 6573   ts in ws.proces
+000441e0: 7369 6e67 5d20 666f 7220 772c 2077 7320  sing] for w, ws 
+000441f0: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+00044200: 6974 656d 7328 290a 2020 2020 2020 2020  items().        
+00044210: 2020 2020 7d0a 0a20 2020 2064 6566 2067      }..    def g
+00044220: 6574 5f77 686f 5f68 6173 2873 656c 662c  et_who_has(self,
+00044230: 206b 6579 733a 2049 7465 7261 626c 655b   keys: Iterable[
+00044240: 4b65 795d 207c 204e 6f6e 6520 3d20 4e6f  Key] | None = No
+00044250: 6e65 2920 2d3e 2064 6963 745b 4b65 792c  ne) -> dict[Key,
+00044260: 206c 6973 745b 7374 725d 5d3a 0a20 2020   list[str]]:.   
+00044270: 2020 2020 2069 6620 6b65 7973 2069 7320       if keys is 
+00044280: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
+00044290: 2020 2020 2020 7265 7475 726e 207b 0a20        return {. 
+000442a0: 2020 2020 2020 2020 2020 2020 2020 206b                 k
+000442b0: 6579 3a20 5b77 732e 6164 6472 6573 7320  ey: [ws.address 
+000442c0: 666f 7220 7773 2069 6e20 7365 6c66 2e74  for ws in self.t
+000442d0: 6173 6b73 5b6b 6579 5d2e 7768 6f5f 6861  asks[key].who_ha
+000442e0: 7320 6f72 2028 295d 0a20 2020 2020 2020  s or ()].       
+000442f0: 2020 2020 2020 2020 2069 6620 6b65 7920           if key 
+00044300: 696e 2073 656c 662e 7461 736b 730a 2020  in self.tasks.  
+00044310: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00044320: 7365 205b 5d0a 2020 2020 2020 2020 2020  se [].          
+00044330: 2020 2020 2020 666f 7220 6b65 7920 696e        for key in
+00044340: 206b 6579 730a 2020 2020 2020 2020 2020   keys.          
+00044350: 2020 7d0a 2020 2020 2020 2020 656c 7365    }.        else
+00044360: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00044370: 7475 726e 207b 0a20 2020 2020 2020 2020  turn {.         
+00044380: 2020 2020 2020 206b 6579 3a20 5b77 732e         key: [ws.
+00044390: 6164 6472 6573 7320 666f 7220 7773 2069  address for ws i
+000443a0: 6e20 7473 2e77 686f 5f68 6173 206f 7220  n ts.who_has or 
+000443b0: 2829 5d0a 2020 2020 2020 2020 2020 2020  ()].            
+000443c0: 2020 2020 666f 7220 6b65 792c 2074 7320      for key, ts 
+000443d0: 696e 2073 656c 662e 7461 736b 732e 6974  in self.tasks.it
+000443e0: 656d 7328 290a 2020 2020 2020 2020 2020  ems().          
+000443f0: 2020 7d0a 0a20 2020 2064 6566 2067 6574    }..    def get
+00044400: 5f68 6173 5f77 6861 7428 0a20 2020 2020  _has_what(.     
+00044410: 2020 2073 656c 662c 2077 6f72 6b65 7273     self, workers
+00044420: 3a20 4974 6572 6162 6c65 5b73 7472 5d20  : Iterable[str] 
+00044430: 7c20 4e6f 6e65 203d 204e 6f6e 650a 2020  | None = None.  
+00044440: 2020 2920 2d3e 2064 6963 745b 7374 722c    ) -> dict[str,
+00044450: 206c 6973 745b 4b65 795d 5d3a 0a20 2020   list[Key]]:.   
+00044460: 2020 2020 2069 6620 776f 726b 6572 7320       if workers 
+00044470: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
+00044480: 2020 2020 2020 2020 2077 6f72 6b65 7273           workers
+00044490: 203d 206d 6170 2873 656c 662e 636f 6572   = map(self.coer
+000444a0: 6365 5f61 6464 7265 7373 2c20 776f 726b  ce_address, work
+000444b0: 6572 7329 0a20 2020 2020 2020 2020 2020  ers).           
+000444c0: 2072 6574 7572 6e20 7b0a 2020 2020 2020   return {.      
+000444d0: 2020 2020 2020 2020 2020 773a 205b 7473            w: [ts
+000444e0: 2e6b 6579 2066 6f72 2074 7320 696e 2073  .key for ts in s
+000444f0: 656c 662e 776f 726b 6572 735b 775d 2e68  elf.workers[w].h
+00044500: 6173 5f77 6861 745d 0a20 2020 2020 2020  as_what].       
+00044510: 2020 2020 2020 2020 2069 6620 7720 696e           if w in
+00044520: 2073 656c 662e 776f 726b 6572 730a 2020   self.workers.  
+00044530: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00044540: 7365 205b 5d0a 2020 2020 2020 2020 2020  se [].          
+00044550: 2020 2020 2020 666f 7220 7720 696e 2077        for w in w
+00044560: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
+00044570: 2020 207d 0a20 2020 2020 2020 2065 6c73     }.        els
+00044580: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00044590: 6574 7572 6e20 7b77 3a20 5b74 732e 6b65  eturn {w: [ts.ke
+000445a0: 7920 666f 7220 7473 2069 6e20 7773 2e68  y for ts in ws.h
+000445b0: 6173 5f77 6861 745d 2066 6f72 2077 2c20  as_what] for w, 
+000445c0: 7773 2069 6e20 7365 6c66 2e77 6f72 6b65  ws in self.worke
+000445d0: 7273 2e69 7465 6d73 2829 7d0a 0a20 2020  rs.items()}..   
+000445e0: 2064 6566 2067 6574 5f6e 636f 7265 7328   def get_ncores(
+000445f0: 7365 6c66 2c20 776f 726b 6572 733a 2049  self, workers: I
+00044600: 7465 7261 626c 655b 7374 725d 207c 204e  terable[str] | N
+00044610: 6f6e 6520 3d20 4e6f 6e65 2920 2d3e 2064  one = None) -> d
+00044620: 6963 745b 7374 722c 2069 6e74 5d3a 0a20  ict[str, int]:. 
+00044630: 2020 2020 2020 2069 6620 776f 726b 6572         if worker
+00044640: 7320 6973 206e 6f74 204e 6f6e 653a 0a20  s is not None:. 
+00044650: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00044660: 7273 203d 206d 6170 2873 656c 662e 636f  rs = map(self.co
+00044670: 6572 6365 5f61 6464 7265 7373 2c20 776f  erce_address, wo
+00044680: 726b 6572 7329 0a20 2020 2020 2020 2020  rkers).         
+00044690: 2020 2072 6574 7572 6e20 7b77 3a20 7365     return {w: se
+000446a0: 6c66 2e77 6f72 6b65 7273 5b77 5d2e 6e74  lf.workers[w].nt
+000446b0: 6872 6561 6473 2066 6f72 2077 2069 6e20  hreads for w in 
+000446c0: 776f 726b 6572 7320 6966 2077 2069 6e20  workers if w in 
+000446d0: 7365 6c66 2e77 6f72 6b65 7273 7d0a 2020  self.workers}.  
+000446e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000446f0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+00044700: 773a 2077 732e 6e74 6872 6561 6473 2066  w: ws.nthreads f
+00044710: 6f72 2077 2c20 7773 2069 6e20 7365 6c66  or w, ws in self
+00044720: 2e77 6f72 6b65 7273 2e69 7465 6d73 2829  .workers.items()
+00044730: 7d0a 0a20 2020 2064 6566 2067 6574 5f6e  }..    def get_n
+00044740: 636f 7265 735f 7275 6e6e 696e 6728 0a20  cores_running(. 
+00044750: 2020 2020 2020 2073 656c 662c 2077 6f72         self, wor
+00044760: 6b65 7273 3a20 4974 6572 6162 6c65 5b73  kers: Iterable[s
+00044770: 7472 5d20 7c20 4e6f 6e65 203d 204e 6f6e  tr] | None = Non
+00044780: 650a 2020 2020 2920 2d3e 2064 6963 745b  e.    ) -> dict[
+00044790: 7374 722c 2069 6e74 5d3a 0a20 2020 2020  str, int]:.     
+000447a0: 2020 206e 636f 7265 7320 3d20 7365 6c66     ncores = self
+000447b0: 2e67 6574 5f6e 636f 7265 7328 776f 726b  .get_ncores(work
+000447c0: 6572 733d 776f 726b 6572 7329 0a20 2020  ers=workers).   
+000447d0: 2020 2020 2072 6574 7572 6e20 7b0a 2020       return {.  
+000447e0: 2020 2020 2020 2020 2020 773a 206e 2066            w: n f
+000447f0: 6f72 2077 2c20 6e20 696e 206e 636f 7265  or w, n in ncore
+00044800: 732e 6974 656d 7328 2920 6966 2073 656c  s.items() if sel
+00044810: 662e 776f 726b 6572 735b 775d 2e73 7461  f.workers[w].sta
+00044820: 7475 7320 3d3d 2053 7461 7475 732e 7275  tus == Status.ru
+00044830: 6e6e 696e 670a 2020 2020 2020 2020 7d0a  nning.        }.
+00044840: 0a20 2020 2061 7379 6e63 2064 6566 2067  .    async def g
+00044850: 6574 5f63 616c 6c5f 7374 6163 6b28 7365  et_call_stack(se
+00044860: 6c66 2c20 6b65 7973 3a20 4974 6572 6162  lf, keys: Iterab
+00044870: 6c65 5b4b 6579 5d20 7c20 4e6f 6e65 203d  le[Key] | None =
+00044880: 204e 6f6e 6529 202d 3e20 6469 6374 5b73   None) -> dict[s
+00044890: 7472 2c20 416e 795d 3a0a 2020 2020 2020  tr, Any]:.      
+000448a0: 2020 776f 726b 6572 733a 2064 6963 745b    workers: dict[
+000448b0: 7374 722c 206c 6973 745b 4b65 795d 207c  str, list[Key] |
+000448c0: 204e 6f6e 655d 0a20 2020 2020 2020 2069   None].        i
+000448d0: 6620 6b65 7973 2069 7320 6e6f 7420 4e6f  f keys is not No
+000448e0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000448f0: 7374 6163 6b20 3d20 6c69 7374 286b 6579  stack = list(key
+00044900: 7329 0a20 2020 2020 2020 2020 2020 2070  s).            p
+00044910: 726f 6365 7373 696e 6720 3d20 7365 7428  rocessing = set(
+00044920: 290a 2020 2020 2020 2020 2020 2020 7768  ).            wh
+00044930: 696c 6520 7374 6163 6b3a 0a20 2020 2020  ile stack:.     
+00044940: 2020 2020 2020 2020 2020 206b 6579 203d             key =
+00044950: 2073 7461 636b 2e70 6f70 2829 0a20 2020   stack.pop().   
+00044960: 2020 2020 2020 2020 2020 2020 2074 7320               ts 
+00044970: 3d20 7365 6c66 2e74 6173 6b73 5b6b 6579  = self.tasks[key
+00044980: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00044990: 2020 6966 2074 732e 7374 6174 6520 3d3d    if ts.state ==
+000449a0: 2022 7761 6974 696e 6722 3a0a 2020 2020   "waiting":.    
+000449b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000449c0: 7374 6163 6b2e 6578 7465 6e64 285b 6474  stack.extend([dt
+000449d0: 732e 6b65 7920 666f 7220 6474 7320 696e  s.key for dts in
+000449e0: 2074 732e 6465 7065 6e64 656e 6369 6573   ts.dependencies
+000449f0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00044a00: 2020 2065 6c69 6620 7473 2e73 7461 7465     elif ts.state
+00044a10: 203d 3d20 2270 726f 6365 7373 696e 6722   == "processing"
+00044a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00044a30: 2020 2020 2020 7072 6f63 6573 7369 6e67        processing
+00044a40: 2e61 6464 2874 7329 0a0a 2020 2020 2020  .add(ts)..      
+00044a50: 2020 2020 2020 776f 726b 6572 7320 3d20        workers = 
+00044a60: 6465 6661 756c 7464 6963 7428 6c69 7374  defaultdict(list
+00044a70: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00044a80: 7220 7473 2069 6e20 7072 6f63 6573 7369  r ts in processi
+00044a90: 6e67 3a0a 2020 2020 2020 2020 2020 2020  ng:.            
+00044aa0: 2020 2020 6966 2074 732e 7072 6f63 6573      if ts.proces
+00044ab0: 7369 6e67 5f6f 6e3a 0a20 2020 2020 2020  sing_on:.       
+00044ac0: 2020 2020 2020 2020 2020 2020 2077 6b65               wke
+00044ad0: 7973 203d 2077 6f72 6b65 7273 5b74 732e  ys = workers[ts.
+00044ae0: 7072 6f63 6573 7369 6e67 5f6f 6e2e 6164  processing_on.ad
+00044af0: 6472 6573 735d 0a20 2020 2020 2020 2020  dress].         
+00044b00: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+00044b10: 7420 776b 6579 7320 6973 206e 6f74 204e  t wkeys is not N
+00044b20: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
+00044b30: 2020 2020 2020 2020 776b 6579 732e 6170          wkeys.ap
+00044b40: 7065 6e64 2874 732e 6b65 7929 0a20 2020  pend(ts.key).   
+00044b50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00044b60: 2020 2020 2020 2077 6f72 6b65 7273 203d         workers =
+00044b70: 207b 773a 204e 6f6e 6520 666f 7220 7720   {w: None for w 
+00044b80: 696e 2073 656c 662e 776f 726b 6572 737d  in self.workers}
+00044b90: 0a0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00044ba0: 2077 6f72 6b65 7273 3a0a 2020 2020 2020   workers:.      
+00044bb0: 2020 2020 2020 7265 7475 726e 207b 7d0a        return {}.
+00044bc0: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
+00044bd0: 203d 2061 7761 6974 2061 7379 6e63 696f   = await asyncio
+00044be0: 2e67 6174 6865 7228 0a20 2020 2020 2020  .gather(.       
+00044bf0: 2020 2020 202a 2873 656c 662e 7270 6328       *(self.rpc(
+00044c00: 7729 2e63 616c 6c5f 7374 6163 6b28 6b65  w).call_stack(ke
+00044c10: 7973 3d76 2920 666f 7220 772c 2076 2069  ys=v) for w, v i
+00044c20: 6e20 776f 726b 6572 732e 6974 656d 7328  n workers.items(
+00044c30: 2929 0a20 2020 2020 2020 2029 0a20 2020  )).        ).   
+00044c40: 2020 2020 2072 6573 706f 6e73 6520 3d20       response = 
+00044c50: 7b77 3a20 7220 666f 7220 772c 2072 2069  {w: r for w, r i
+00044c60: 6e20 7a69 7028 776f 726b 6572 732c 2072  n zip(workers, r
+00044c70: 6573 756c 7473 2920 6966 2072 7d0a 2020  esults) if r}.  
+00044c80: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00044c90: 706f 6e73 650a 0a20 2020 2061 7379 6e63  ponse..    async
+00044ca0: 2064 6566 2062 656e 6368 6d61 726b 5f68   def benchmark_h
+00044cb0: 6172 6477 6172 6528 7365 6c66 2920 2d3e  ardware(self) ->
+00044cc0: 2064 6963 745b 7374 722c 2064 6963 745b   dict[str, dict[
+00044cd0: 7374 722c 2066 6c6f 6174 5d5d 3a0a 2020  str, float]]:.  
+00044ce0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00044cf0: 2020 5275 6e20 6120 6265 6e63 686d 6172    Run a benchmar
+00044d00: 6b20 6f6e 2074 6865 2077 6f72 6b65 7273  k on the workers
+00044d10: 2066 6f72 206d 656d 6f72 792c 2064 6973   for memory, dis
+00044d20: 6b2c 2061 6e64 206e 6574 776f 726b 2062  k, and network b
+00044d30: 616e 6477 6964 7468 730a 0a20 2020 2020  andwidths..     
+00044d40: 2020 2052 6574 7572 6e73 0a20 2020 2020     Returns.     
+00044d50: 2020 202d 2d2d 2d2d 2d2d 0a20 2020 2020     -------.     
+00044d60: 2020 2072 6573 756c 743a 2064 6963 740a     result: dict.
+00044d70: 2020 2020 2020 2020 2020 2020 4120 6469              A di
+00044d80: 6374 696f 6e61 7279 206d 6170 7069 6e67  ctionary mapping
+00044d90: 2074 6865 206e 616d 6573 2022 6469 736b   the names "disk
+00044da0: 222c 2022 6d65 6d6f 7279 222c 2061 6e64  ", "memory", and
+00044db0: 2022 6e65 7477 6f72 6b22 2074 6f0a 2020   "network" to.  
+00044dc0: 2020 2020 2020 2020 2020 6469 6374 696f            dictio
+00044dd0: 6e61 7269 6573 206d 6170 7069 6e67 2073  naries mapping s
+00044de0: 697a 6573 2074 6f20 6261 6e64 7769 6474  izes to bandwidt
+00044df0: 6873 2e20 2054 6865 7365 2062 616e 6477  hs.  These bandw
+00044e00: 6964 7468 7320 6172 650a 2020 2020 2020  idths are.      
+00044e10: 2020 2020 2020 6176 6572 6167 6564 206f        averaged o
+00044e20: 7665 7220 6d61 6e79 2077 6f72 6b65 7273  ver many workers
+00044e30: 2072 756e 6e69 6e67 2063 6f6d 7075 7461   running computa
+00044e40: 7469 6f6e 7320 6163 726f 7373 2074 6865  tions across the
+00044e50: 2063 6c75 7374 6572 2e0a 2020 2020 2020   cluster..      
+00044e60: 2020 2222 220a 2020 2020 2020 2020 6f75    """.        ou
+00044e70: 743a 2064 6963 745b 7374 722c 2064 6566  t: dict[str, def
+00044e80: 6175 6c74 6469 6374 5b73 7472 2c20 6c69  aultdict[str, li
+00044e90: 7374 5b66 6c6f 6174 5d5d 5d20 3d20 7b0a  st[float]]] = {.
+00044ea0: 2020 2020 2020 2020 2020 2020 6e61 6d65              name
+00044eb0: 3a20 6465 6661 756c 7464 6963 7428 6c69  : defaultdict(li
+00044ec0: 7374 2920 666f 7220 6e61 6d65 2069 6e20  st) for name in 
+00044ed0: 5b22 6469 736b 222c 2022 6d65 6d6f 7279  ["disk", "memory
+00044ee0: 222c 2022 6e65 7477 6f72 6b22 5d0a 2020  ", "network"].  
+00044ef0: 2020 2020 2020 7d0a 0a20 2020 2020 2020        }..       
+00044f00: 2023 2064 6973 6b0a 2020 2020 2020 2020   # disk.        
+00044f10: 7265 7375 6c74 203d 2061 7761 6974 2073  result = await s
+00044f20: 656c 662e 6272 6f61 6463 6173 7428 6d73  elf.broadcast(ms
+00044f30: 673d 7b22 6f70 223a 2022 6265 6e63 686d  g={"op": "benchm
+00044f40: 6172 6b5f 6469 736b 227d 290a 2020 2020  ark_disk"}).    
+00044f50: 2020 2020 666f 7220 6420 696e 2072 6573      for d in res
+00044f60: 756c 742e 7661 6c75 6573 2829 3a0a 2020  ult.values():.  
+00044f70: 2020 2020 2020 2020 2020 666f 7220 7369            for si
+00044f80: 7a65 2c20 6475 7261 7469 6f6e 2069 6e20  ze, duration in 
+00044f90: 642e 6974 656d 7328 293a 0a20 2020 2020  d.items():.     
+00044fa0: 2020 2020 2020 2020 2020 206f 7574 5b22             out["
+00044fb0: 6469 736b 225d 5b73 697a 655d 2e61 7070  disk"][size].app
+00044fc0: 656e 6428 6475 7261 7469 6f6e 290a 0a20  end(duration).. 
+00044fd0: 2020 2020 2020 2023 206d 656d 6f72 790a         # memory.
+00044fe0: 2020 2020 2020 2020 7265 7375 6c74 203d          result =
+00044ff0: 2061 7761 6974 2073 656c 662e 6272 6f61   await self.broa
+00045000: 6463 6173 7428 6d73 673d 7b22 6f70 223a  dcast(msg={"op":
+00045010: 2022 6265 6e63 686d 6172 6b5f 6d65 6d6f   "benchmark_memo
+00045020: 7279 227d 290a 2020 2020 2020 2020 666f  ry"}).        fo
+00045030: 7220 6420 696e 2072 6573 756c 742e 7661  r d in result.va
+00045040: 6c75 6573 2829 3a0a 2020 2020 2020 2020  lues():.        
+00045050: 2020 2020 666f 7220 7369 7a65 2c20 6475      for size, du
+00045060: 7261 7469 6f6e 2069 6e20 642e 6974 656d  ration in d.item
+00045070: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00045080: 2020 2020 206f 7574 5b22 6d65 6d6f 7279       out["memory
+00045090: 225d 5b73 697a 655d 2e61 7070 656e 6428  "][size].append(
+000450a0: 6475 7261 7469 6f6e 290a 0a20 2020 2020  duration)..     
+000450b0: 2020 2023 206e 6574 776f 726b 0a20 2020     # network.   
+000450c0: 2020 2020 2077 6f72 6b65 7273 203d 206c       workers = l
+000450d0: 6973 7428 7365 6c66 2e77 6f72 6b65 7273  ist(self.workers
+000450e0: 290a 2020 2020 2020 2020 2320 4f6e 2061  ).        # On a
+000450f0: 6e20 6164 6170 7469 7665 2063 6c75 7374  n adaptive clust
+00045100: 6572 2c20 6966 206d 756c 7469 706c 6520  er, if multiple 
+00045110: 776f 726b 6572 7320 6172 6520 7374 6172  workers are star
+00045120: 7465 6420 6f6e 2074 6865 2073 616d 6520  ted on the same 
+00045130: 7068 7973 6963 616c 2068 6f73 742c 0a20  physical host,. 
+00045140: 2020 2020 2020 2023 2074 6865 7920 6172         # they ar
+00045150: 6520 6d6f 7265 206c 696b 656c 7920 746f  e more likely to
+00045160: 2063 6f6e 6e65 6374 2074 6f20 7468 6520   connect to the 
+00045170: 5363 6865 6475 6c65 7220 696e 2073 6571  Scheduler in seq
+00045180: 7565 6e63 652c 2065 6e64 696e 6720 7570  uence, ending up
+00045190: 206e 6578 7420 746f 0a20 2020 2020 2020   next to.       
+000451a0: 2023 2065 6163 6820 6f74 6865 7220 696e   # each other in
+000451b0: 2074 6869 7320 6c69 7374 2e0a 2020 2020   this list..    
+000451c0: 2020 2020 2320 5468 6520 7472 616e 7366      # The transf
+000451d0: 6572 2073 7065 6564 2077 6974 6869 6e20  er speed within 
+000451e0: 7375 6368 2063 6c75 7374 6572 7320 6f66  such clusters of
+000451f0: 2077 6f72 6b65 7273 2077 696c 6c20 6265   workers will be
+00045200: 2065 6666 6563 7469 7665 6c79 2074 6861   effectively tha
+00045210: 7420 6f66 0a20 2020 2020 2020 2023 206c  t of.        # l
+00045220: 6f63 616c 686f 7374 2e20 5468 6973 2063  ocalhost. This c
+00045230: 6f75 6c64 2068 6170 7065 6e20 6163 726f  ould happen acro
+00045240: 7373 2064 6966 6665 7265 6e74 2056 4d73  ss different VMs
+00045250: 2061 6e64 2f6f 7220 646f 636b 6572 2069   and/or docker i
+00045260: 6d61 6765 732c 2073 6f0a 2020 2020 2020  mages, so.      
+00045270: 2020 2320 696d 706c 656d 656e 7469 6e67    # implementing
+00045280: 206c 6f67 6963 2062 6173 6564 206f 6e20   logic based on 
+00045290: 4950 2061 6464 7265 7373 6573 2077 6f75  IP addresses wou
+000452a0: 6c64 206e 6f74 206e 6563 6573 7361 7269  ld not necessari
+000452b0: 6c79 2068 656c 702e 0a20 2020 2020 2020  ly help..       
+000452c0: 2023 2052 616e 646f 6d69 7a65 2074 6865   # Randomize the
+000452d0: 2063 6f6e 6e65 6374 696f 6e73 2074 6f20   connections to 
+000452e0: 6576 656e 206f 7574 2074 6865 206d 6561  even out the mea
+000452f0: 6e20 6d65 6173 7572 6573 2e0a 2020 2020  n measures..    
+00045300: 2020 2020 7261 6e64 6f6d 2e73 6875 6666      random.shuff
+00045310: 6c65 2877 6f72 6b65 7273 290a 2020 2020  le(workers).    
+00045320: 2020 2020 6675 7475 7265 7320 3d20 5b0a      futures = [.
+00045330: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00045340: 2e72 7063 2861 292e 6265 6e63 686d 6172  .rpc(a).benchmar
+00045350: 6b5f 6e65 7477 6f72 6b28 6164 6472 6573  k_network(addres
+00045360: 733d 6229 2066 6f72 2061 2c20 6220 696e  s=b) for a, b in
+00045370: 2070 6172 7469 7469 6f6e 2832 2c20 776f   partition(2, wo
+00045380: 726b 6572 7329 0a20 2020 2020 2020 205d  rkers).        ]
+00045390: 0a20 2020 2020 2020 2072 6573 706f 6e73  .        respons
+000453a0: 6573 203d 2061 7761 6974 2061 7379 6e63  es = await async
+000453b0: 696f 2e67 6174 6865 7228 2a66 7574 7572  io.gather(*futur
+000453c0: 6573 290a 0a20 2020 2020 2020 2066 6f72  es)..        for
+000453d0: 2064 2069 6e20 7265 7370 6f6e 7365 733a   d in responses:
+000453e0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000453f0: 2073 697a 652c 2064 7572 6174 696f 6e20   size, duration 
+00045400: 696e 2064 2e69 7465 6d73 2829 3a0a 2020  in d.items():.  
+00045410: 2020 2020 2020 2020 2020 2020 2020 6f75                ou
+00045420: 745b 226e 6574 776f 726b 225d 5b73 697a  t["network"][siz
+00045430: 655d 2e61 7070 656e 6428 6475 7261 7469  e].append(durati
+00045440: 6f6e 290a 0a20 2020 2020 2020 2072 6573  on)..        res
+00045450: 756c 7420 3d20 7b7d 0a20 2020 2020 2020  ult = {}.       
+00045460: 2066 6f72 206d 6f64 6520 696e 206f 7574   for mode in out
+00045470: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00045480: 7375 6c74 5b6d 6f64 655d 203d 207b 0a20  sult[mode] = {. 
+00045490: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000454a0: 697a 653a 2073 756d 2864 7572 6174 696f  ize: sum(duratio
+000454b0: 6e73 2920 2f20 6c65 6e28 6475 7261 7469  ns) / len(durati
+000454c0: 6f6e 7329 0a20 2020 2020 2020 2020 2020  ons).           
+000454d0: 2020 2020 2066 6f72 2073 697a 652c 2064       for size, d
+000454e0: 7572 6174 696f 6e73 2069 6e20 6f75 745b  urations in out[
+000454f0: 6d6f 6465 5d2e 6974 656d 7328 290a 2020  mode].items().  
+00045500: 2020 2020 2020 2020 2020 7d0a 0a20 2020            }..   
+00045510: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+00045520: 6c74 0a0a 2020 2020 406c 6f67 5f65 7272  lt..    @log_err
+00045530: 6f72 730a 2020 2020 6465 6620 6765 745f  ors.    def get_
+00045540: 6e62 7974 6573 280a 2020 2020 2020 2020  nbytes(.        
+00045550: 7365 6c66 2c20 6b65 7973 3a20 4974 6572  self, keys: Iter
+00045560: 6162 6c65 5b4b 6579 5d20 7c20 4e6f 6e65  able[Key] | None
+00045570: 203d 204e 6f6e 652c 2073 756d 6d61 7279   = None, summary
+00045580: 3a20 626f 6f6c 203d 2054 7275 650a 2020  : bool = True.  
+00045590: 2020 2920 2d3e 2064 6963 745b 4b65 792c    ) -> dict[Key,
+000455a0: 2069 6e74 5d3a 0a20 2020 2020 2020 2069   int]:.        i
+000455b0: 6620 6b65 7973 2069 7320 6e6f 7420 4e6f  f keys is not No
+000455c0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+000455d0: 7265 7375 6c74 203d 207b 6b3a 2073 656c  result = {k: sel
+000455e0: 662e 7461 736b 735b 6b5d 2e6e 6279 7465  f.tasks[k].nbyte
+000455f0: 7320 666f 7220 6b20 696e 206b 6579 737d  s for k in keys}
+00045600: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00045610: 2020 2020 2020 2020 2020 2072 6573 756c             resul
+00045620: 7420 3d20 7b6b 3a20 7473 2e6e 6279 7465  t = {k: ts.nbyte
+00045630: 7320 666f 7220 6b2c 2074 7320 696e 2073  s for k, ts in s
+00045640: 656c 662e 7461 736b 732e 6974 656d 7328  elf.tasks.items(
+00045650: 2920 6966 2074 732e 6e62 7974 6573 203e  ) if ts.nbytes >
+00045660: 3d20 307d 0a0a 2020 2020 2020 2020 6966  = 0}..        if
+00045670: 2073 756d 6d61 7279 3a0a 2020 2020 2020   summary:.      
+00045680: 2020 2020 2020 6f75 743a 2064 6566 6175        out: defau
+00045690: 6c74 6469 6374 5b4b 6579 2c20 696e 745d  ltdict[Key, int]
+000456a0: 203d 2064 6566 6175 6c74 6469 6374 2869   = defaultdict(i
+000456b0: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
+000456c0: 666f 7220 6b2c 2076 2069 6e20 7265 7375  for k, v in resu
+000456d0: 6c74 2e69 7465 6d73 2829 3a0a 2020 2020  lt.items():.    
+000456e0: 2020 2020 2020 2020 2020 2020 6f75 745b              out[
+000456f0: 6b65 795f 7370 6c69 7428 6b29 5d20 2b3d  key_split(k)] +=
+00045700: 2076 0a20 2020 2020 2020 2020 2020 2072   v.            r
+00045710: 6573 756c 7420 3d20 6469 6374 286f 7574  esult = dict(out
+00045720: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00045730: 6e20 7265 7375 6c74 0a0a 2020 2020 6465  n result..    de
+00045740: 6620 7275 6e5f 6675 6e63 7469 6f6e 280a  f run_function(.
+00045750: 2020 2020 2020 2020 7365 6c66 2c0a 2020          self,.  
+00045760: 2020 2020 2020 636f 6d6d 3a20 436f 6d6d        comm: Comm
+00045770: 2c0a 2020 2020 2020 2020 6675 6e63 7469  ,.        functi
+00045780: 6f6e 3a20 4361 6c6c 6162 6c65 2c0a 2020  on: Callable,.  
+00045790: 2020 2020 2020 6172 6773 3a20 7475 706c        args: tupl
+000457a0: 6520 3d20 2829 2c0a 2020 2020 2020 2020  e = (),.        
+000457b0: 6b77 6172 6773 3a20 6469 6374 207c 204e  kwargs: dict | N
+000457c0: 6f6e 6520 3d20 4e6f 6e65 2c0a 2020 2020  one = None,.    
+000457d0: 2020 2020 7761 6974 3a20 626f 6f6c 203d      wait: bool =
+000457e0: 2054 7275 652c 0a20 2020 2029 202d 3e20   True,.    ) -> 
+000457f0: 416e 793a 0a20 2020 2020 2020 2022 2222  Any:.        """
+00045800: 5275 6e20 6120 6675 6e63 7469 6f6e 2077  Run a function w
+00045810: 6974 6869 6e20 7468 6973 2070 726f 6365  ithin this proce
+00045820: 7373 0a0a 2020 2020 2020 2020 5365 6520  ss..        See 
+00045830: 416c 736f 0a20 2020 2020 2020 202d 2d2d  Also.        ---
+00045840: 2d2d 2d2d 2d0a 2020 2020 2020 2020 436c  -----.        Cl
+00045850: 6965 6e74 2e72 756e 5f6f 6e5f 7363 6865  ient.run_on_sche
+00045860: 6475 6c65 720a 2020 2020 2020 2020 2222  duler.        ""
+00045870: 220a 2020 2020 2020 2020 6672 6f6d 2064  ".        from d
+00045880: 6973 7472 6962 7574 6564 2e77 6f72 6b65  istributed.worke
+00045890: 7220 696d 706f 7274 2072 756e 0a0a 2020  r import run..  
+000458a0: 2020 2020 2020 6b77 6172 6773 203d 206b        kwargs = k
+000458b0: 7761 7267 7320 6f72 207b 7d0a 2020 2020  wargs or {}.    
+000458c0: 2020 2020 7365 6c66 2e6c 6f67 5f65 7665      self.log_eve
+000458d0: 6e74 2822 616c 6c22 2c20 7b22 6163 7469  nt("all", {"acti
+000458e0: 6f6e 223a 2022 7275 6e2d 6675 6e63 7469  on": "run-functi
+000458f0: 6f6e 222c 2022 6675 6e63 7469 6f6e 223a  on", "function":
+00045900: 2066 756e 6374 696f 6e7d 290a 2020 2020   function}).    
+00045910: 2020 2020 7265 7475 726e 2072 756e 2873      return run(s
+00045920: 656c 662c 2063 6f6d 6d2c 2066 756e 6374  elf, comm, funct
+00045930: 696f 6e3d 6675 6e63 7469 6f6e 2c20 6172  ion=function, ar
+00045940: 6773 3d61 7267 732c 206b 7761 7267 733d  gs=args, kwargs=
+00045950: 6b77 6172 6773 2c20 7761 6974 3d77 6169  kwargs, wait=wai
+00045960: 7429 0a0a 2020 2020 6465 6620 7365 745f  t)..    def set_
+00045970: 6d65 7461 6461 7461 2873 656c 662c 206b  metadata(self, k
+00045980: 6579 733a 206c 6973 745b 4b65 795d 2c20  eys: list[Key], 
+00045990: 7661 6c75 653a 206f 626a 6563 7420 3d20  value: object = 
+000459a0: 4e6f 6e65 2920 2d3e 204e 6f6e 653a 0a20  None) -> None:. 
+000459b0: 2020 2020 2020 206d 6574 6164 6174 6120         metadata 
+000459c0: 3d20 7365 6c66 2e74 6173 6b5f 6d65 7461  = self.task_meta
+000459d0: 6461 7461 0a20 2020 2020 2020 2066 6f72  data.        for
+000459e0: 206b 6579 2069 6e20 6b65 7973 5b3a 2d31   key in keys[:-1
+000459f0: 5d3a 0a20 2020 2020 2020 2020 2020 2069  ]:.            i
+00045a00: 6620 6b65 7920 6e6f 7420 696e 206d 6574  f key not in met
+00045a10: 6164 6174 6120 6f72 206e 6f74 2069 7369  adata or not isi
+00045a20: 6e73 7461 6e63 6528 6d65 7461 6461 7461  nstance(metadata
+00045a30: 5b6b 6579 5d2c 2028 6469 6374 2c20 6c69  [key], (dict, li
+00045a40: 7374 2929 3a0a 2020 2020 2020 2020 2020  st)):.          
+00045a50: 2020 2020 2020 6d65 7461 6461 7461 5b6b        metadata[k
+00045a60: 6579 5d20 3d20 7b7d 0a20 2020 2020 2020  ey] = {}.       
+00045a70: 2020 2020 206d 6574 6164 6174 6120 3d20       metadata = 
+00045a80: 6d65 7461 6461 7461 5b6b 6579 5d0a 2020  metadata[key].  
+00045a90: 2020 2020 2020 6d65 7461 6461 7461 5b6b        metadata[k
+00045aa0: 6579 735b 2d31 5d5d 203d 2076 616c 7565  eys[-1]] = value
+00045ab0: 0a0a 2020 2020 6465 6620 6765 745f 6d65  ..    def get_me
+00045ac0: 7461 6461 7461 2873 656c 662c 206b 6579  tadata(self, key
+00045ad0: 733a 206c 6973 745b 4b65 795d 2c20 6465  s: list[Key], de
+00045ae0: 6661 756c 743a 2041 6e79 203d 206e 6f5f  fault: Any = no_
+00045af0: 6465 6661 756c 7429 202d 3e20 416e 793a  default) -> Any:
+00045b00: 0a20 2020 2020 2020 206d 6574 6164 6174  .        metadat
+00045b10: 6120 3d20 7365 6c66 2e74 6173 6b5f 6d65  a = self.task_me
+00045b20: 7461 6461 7461 0a20 2020 2020 2020 2074  tadata.        t
+00045b30: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00045b40: 666f 7220 6b65 7920 696e 206b 6579 733a  for key in keys:
+00045b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045b60: 206d 6574 6164 6174 6120 3d20 6d65 7461   metadata = meta
+00045b70: 6461 7461 5b6b 6579 5d0a 2020 2020 2020  data[key].      
+00045b80: 2020 2020 2020 7265 7475 726e 206d 6574        return met
+00045b90: 6164 6174 610a 2020 2020 2020 2020 6578  adata.        ex
+00045ba0: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
+00045bb0: 2020 2020 2020 2020 2020 2069 6620 6465             if de
+00045bc0: 6661 756c 7420 6973 206e 6f74 206e 6f5f  fault is not no_
+00045bd0: 6465 6661 756c 743a 0a20 2020 2020 2020  default:.       
+00045be0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00045bf0: 6465 6661 756c 740a 2020 2020 2020 2020  default.        
+00045c00: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00045c10: 2020 2020 2020 2020 2020 7261 6973 650a            raise.
+00045c20: 0a20 2020 2064 6566 2073 6574 5f72 6573  .    def set_res
+00045c30: 7472 6963 7469 6f6e 7328 7365 6c66 2c20  trictions(self, 
+00045c40: 776f 726b 6572 3a20 6469 6374 5b4b 6579  worker: dict[Key
+00045c50: 2c20 436f 6c6c 6563 7469 6f6e 5b73 7472  , Collection[str
+00045c60: 5d20 7c20 7374 7220 7c20 4e6f 6e65 5d29  ] | str | None])
+00045c70: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00045c80: 2020 666f 7220 6b65 792c 2072 6573 7472    for key, restr
+00045c90: 6963 7469 6f6e 7320 696e 2077 6f72 6b65  ictions in worke
+00045ca0: 722e 6974 656d 7328 293a 0a20 2020 2020  r.items():.     
+00045cb0: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+00045cc0: 2e74 6173 6b73 5b6b 6579 5d0a 2020 2020  .tasks[key].    
+00045cd0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00045ce0: 7461 6e63 6528 7265 7374 7269 6374 696f  tance(restrictio
+00045cf0: 6e73 2c20 7374 7229 3a0a 2020 2020 2020  ns, str):.      
+00045d00: 2020 2020 2020 2020 2020 7265 7374 7269            restri
+00045d10: 6374 696f 6e73 203d 207b 7265 7374 7269  ctions = {restri
+00045d20: 6374 696f 6e73 7d0a 2020 2020 2020 2020  ctions}.        
+00045d30: 2020 2020 7473 2e77 6f72 6b65 725f 7265      ts.worker_re
+00045d40: 7374 7269 6374 696f 6e73 203d 2073 6574  strictions = set
+00045d50: 2872 6573 7472 6963 7469 6f6e 7329 2069  (restrictions) i
+00045d60: 6620 7265 7374 7269 6374 696f 6e73 2065  f restrictions e
+00045d70: 6c73 6520 4e6f 6e65 0a0a 2020 2020 406c  lse None..    @l
+00045d80: 6f67 5f65 7272 6f72 730a 2020 2020 6465  og_errors.    de
+00045d90: 6620 6765 745f 7461 736b 5f70 7265 6669  f get_task_prefi
+00045da0: 785f 7374 6174 6573 2873 656c 6629 202d  x_states(self) -
+00045db0: 3e20 6469 6374 5b73 7472 2c20 6469 6374  > dict[str, dict
+00045dc0: 5b73 7472 2c20 696e 745d 5d3a 0a20 2020  [str, int]]:.   
+00045dd0: 2020 2020 2073 7461 7465 203d 207b 7d0a       state = {}.
+00045de0: 0a20 2020 2020 2020 2066 6f72 2074 7020  .        for tp 
+00045df0: 696e 2073 656c 662e 7461 736b 5f70 7265  in self.task_pre
+00045e00: 6669 7865 732e 7661 6c75 6573 2829 3a0a  fixes.values():.
+00045e10: 2020 2020 2020 2020 2020 2020 6163 7469              acti
+00045e20: 7665 5f73 7461 7465 7320 3d20 7470 2e61  ve_states = tp.a
+00045e30: 6374 6976 655f 7374 6174 6573 0a20 2020  ctive_states.   
+00045e40: 2020 2020 2020 2020 2073 733a 206c 6973           ss: lis
+00045e50: 745b 5461 736b 5374 6174 6553 7461 7465  t[TaskStateState
+00045e60: 5d20 3d20 5b0a 2020 2020 2020 2020 2020  ] = [.          
+00045e70: 2020 2020 2020 226d 656d 6f72 7922 2c0a        "memory",.
+00045e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045e90: 2265 7272 6564 222c 0a20 2020 2020 2020  "erred",.       
+00045ea0: 2020 2020 2020 2020 2022 7265 6c65 6173           "releas
+00045eb0: 6564 222c 0a20 2020 2020 2020 2020 2020  ed",.           
+00045ec0: 2020 2020 2022 7072 6f63 6573 7369 6e67       "processing
+00045ed0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00045ee0: 2020 2022 7761 6974 696e 6722 2c0a 2020     "waiting",.  
+00045ef0: 2020 2020 2020 2020 2020 5d0a 2020 2020            ].    
+00045f00: 2020 2020 2020 2020 6966 2061 6e79 2861          if any(a
+00045f10: 6374 6976 655f 7374 6174 6573 2e67 6574  ctive_states.get
+00045f20: 2873 2920 666f 7220 7320 696e 2073 7329  (s) for s in ss)
+00045f30: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00045f40: 2020 7374 6174 655b 7470 2e6e 616d 655d    state[tp.name]
+00045f50: 203d 207b 0a20 2020 2020 2020 2020 2020   = {.           
+00045f60: 2020 2020 2020 2020 2022 6d65 6d6f 7279           "memory
+00045f70: 223a 2061 6374 6976 655f 7374 6174 6573  ": active_states
+00045f80: 5b22 6d65 6d6f 7279 225d 2c0a 2020 2020  ["memory"],.    
+00045f90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00045fa0: 2265 7272 6564 223a 2061 6374 6976 655f  "erred": active_
+00045fb0: 7374 6174 6573 5b22 6572 7265 6422 5d2c  states["erred"],
+00045fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00045fd0: 2020 2020 2022 7265 6c65 6173 6564 223a       "released":
+00045fe0: 2061 6374 6976 655f 7374 6174 6573 5b22   active_states["
+00045ff0: 7265 6c65 6173 6564 225d 2c0a 2020 2020  released"],.    
+00046000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046010: 2270 726f 6365 7373 696e 6722 3a20 6163  "processing": ac
+00046020: 7469 7665 5f73 7461 7465 735b 2270 726f  tive_states["pro
+00046030: 6365 7373 696e 6722 5d2c 0a20 2020 2020  cessing"],.     
+00046040: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00046050: 7761 6974 696e 6722 3a20 6163 7469 7665  waiting": active
+00046060: 5f73 7461 7465 735b 2277 6169 7469 6e67  _states["waiting
+00046070: 225d 2c0a 2020 2020 2020 2020 2020 2020  "],.            
+00046080: 2020 2020 7d0a 0a20 2020 2020 2020 2072      }..        r
+00046090: 6574 7572 6e20 7374 6174 650a 0a20 2020  eturn state..   
+000460a0: 2064 6566 2067 6574 5f74 6173 6b5f 7374   def get_task_st
+000460b0: 6174 7573 2873 656c 662c 206b 6579 733a  atus(self, keys:
+000460c0: 2049 7465 7261 626c 655b 4b65 795d 2920   Iterable[Key]) 
+000460d0: 2d3e 2064 6963 745b 4b65 792c 2054 6173  -> dict[Key, Tas
+000460e0: 6b53 7461 7465 5374 6174 6520 7c20 4e6f  kStateState | No
+000460f0: 6e65 5d3a 0a20 2020 2020 2020 2072 6574  ne]:.        ret
+00046100: 7572 6e20 7b0a 2020 2020 2020 2020 2020  urn {.          
+00046110: 2020 6b65 793a 2028 7365 6c66 2e74 6173    key: (self.tas
+00046120: 6b73 5b6b 6579 5d2e 7374 6174 6520 6966  ks[key].state if
+00046130: 206b 6579 2069 6e20 7365 6c66 2e74 6173   key in self.tas
+00046140: 6b73 2065 6c73 6520 4e6f 6e65 2920 666f  ks else None) fo
+00046150: 7220 6b65 7920 696e 206b 6579 730a 2020  r key in keys.  
+00046160: 2020 2020 2020 7d0a 0a20 2020 2064 6566        }..    def
+00046170: 2067 6574 5f74 6173 6b5f 7374 7265 616d   get_task_stream
+00046180: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+00046190: 2020 2020 2020 2020 7374 6172 743a 2073          start: s
+000461a0: 7472 207c 2066 6c6f 6174 207c 204e 6f6e  tr | float | Non
+000461b0: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2020  e = None,.      
+000461c0: 2020 7374 6f70 3a20 7374 7220 7c20 666c    stop: str | fl
+000461d0: 6f61 7420 7c20 4e6f 6e65 203d 204e 6f6e  oat | None = Non
+000461e0: 652c 0a20 2020 2020 2020 2063 6f75 6e74  e,.        count
+000461f0: 3a20 696e 7420 7c20 4e6f 6e65 203d 204e  : int | None = N
+00046200: 6f6e 652c 0a20 2020 2029 202d 3e20 6c69  one,.    ) -> li
+00046210: 7374 3a0a 2020 2020 2020 2020 6672 6f6d  st:.        from
+00046220: 2064 6973 7472 6962 7574 6564 2e64 6961   distributed.dia
+00046230: 676e 6f73 7469 6373 2e74 6173 6b5f 7374  gnostics.task_st
+00046240: 7265 616d 2069 6d70 6f72 7420 5461 736b  ream import Task
+00046250: 5374 7265 616d 506c 7567 696e 0a0a 2020  StreamPlugin..  
+00046260: 2020 2020 2020 6966 2054 6173 6b53 7472        if TaskStr
+00046270: 6561 6d50 6c75 6769 6e2e 6e61 6d65 206e  eamPlugin.name n
+00046280: 6f74 2069 6e20 7365 6c66 2e70 6c75 6769  ot in self.plugi
+00046290: 6e73 3a0a 2020 2020 2020 2020 2020 2020  ns:.            
+000462a0: 7365 6c66 2e61 6464 5f70 6c75 6769 6e28  self.add_plugin(
+000462b0: 5461 736b 5374 7265 616d 506c 7567 696e  TaskStreamPlugin
+000462c0: 2873 656c 6629 290a 0a20 2020 2020 2020  (self))..       
+000462d0: 2070 6c75 6769 6e20 3d20 6361 7374 2854   plugin = cast(T
+000462e0: 6173 6b53 7472 6561 6d50 6c75 6769 6e2c  askStreamPlugin,
+000462f0: 2073 656c 662e 706c 7567 696e 735b 5461   self.plugins[Ta
+00046300: 736b 5374 7265 616d 506c 7567 696e 2e6e  skStreamPlugin.n
+00046310: 616d 655d 290a 0a20 2020 2020 2020 2072  ame])..        r
+00046320: 6574 7572 6e20 706c 7567 696e 2e63 6f6c  eturn plugin.col
+00046330: 6c65 6374 2873 7461 7274 3d73 7461 7274  lect(start=start
+00046340: 2c20 7374 6f70 3d73 746f 702c 2063 6f75  , stop=stop, cou
+00046350: 6e74 3d63 6f75 6e74 290a 0a20 2020 2064  nt=count)..    d
+00046360: 6566 2073 7461 7274 5f74 6173 6b5f 6d65  ef start_task_me
+00046370: 7461 6461 7461 2873 656c 662c 206e 616d  tadata(self, nam
+00046380: 653a 2073 7472 2920 2d3e 204e 6f6e 653a  e: str) -> None:
+00046390: 0a20 2020 2020 2020 2070 6c75 6769 6e20  .        plugin 
+000463a0: 3d20 436f 6c6c 6563 7454 6173 6b4d 6574  = CollectTaskMet
+000463b0: 6144 6174 6150 6c75 6769 6e28 7363 6865  aDataPlugin(sche
+000463c0: 6475 6c65 723d 7365 6c66 2c20 6e61 6d65  duler=self, name
+000463d0: 3d6e 616d 6529 0a20 2020 2020 2020 2073  =name).        s
+000463e0: 656c 662e 6164 645f 706c 7567 696e 2870  elf.add_plugin(p
+000463f0: 6c75 6769 6e29 0a0a 2020 2020 6465 6620  lugin)..    def 
+00046400: 7374 6f70 5f74 6173 6b5f 6d65 7461 6461  stop_task_metada
+00046410: 7461 2873 656c 662c 206e 616d 653a 2073  ta(self, name: s
+00046420: 7472 207c 204e 6f6e 6520 3d20 4e6f 6e65  tr | None = None
+00046430: 2920 2d3e 2064 6963 743a 0a20 2020 2020  ) -> dict:.     
+00046440: 2020 2070 6c75 6769 6e73 203d 205b 0a20     plugins = [. 
+00046450: 2020 2020 2020 2020 2020 2070 0a20 2020             p.   
+00046460: 2020 2020 2020 2020 2066 6f72 2070 2069           for p i
+00046470: 6e20 6c69 7374 2873 656c 662e 706c 7567  n list(self.plug
+00046480: 696e 732e 7661 6c75 6573 2829 290a 2020  ins.values()).  
+00046490: 2020 2020 2020 2020 2020 6966 2069 7369            if isi
+000464a0: 6e73 7461 6e63 6528 702c 2043 6f6c 6c65  nstance(p, Colle
+000464b0: 6374 5461 736b 4d65 7461 4461 7461 506c  ctTaskMetaDataPl
+000464c0: 7567 696e 2920 616e 6420 702e 6e61 6d65  ugin) and p.name
+000464d0: 203d 3d20 6e61 6d65 0a20 2020 2020 2020   == name.       
+000464e0: 205d 0a20 2020 2020 2020 2069 6620 6c65   ].        if le
+000464f0: 6e28 706c 7567 696e 7329 2021 3d20 313a  n(plugins) != 1:
+00046500: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00046510: 7365 2056 616c 7565 4572 726f 7228 0a20  se ValueError(. 
+00046520: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00046530: 4578 7065 6374 6564 2074 6f20 6669 6e64  Expected to find
+00046540: 2065 7861 6374 6c79 206f 6e65 2043 6f6c   exactly one Col
+00046550: 6c65 6374 5461 736b 4d65 7461 4461 7461  lectTaskMetaData
+00046560: 506c 7567 696e 2022 0a20 2020 2020 2020  Plugin ".       
+00046570: 2020 2020 2020 2020 2066 2277 6974 6820           f"with 
+00046580: 6e61 6d65 207b 6e61 6d65 7d20 6275 7420  name {name} but 
+00046590: 666f 756e 6420 7b6c 656e 2870 6c75 6769  found {len(plugi
+000465a0: 6e73 297d 2e22 0a20 2020 2020 2020 2020  ns)}.".         
+000465b0: 2020 2029 0a0a 2020 2020 2020 2020 706c     )..        pl
+000465c0: 7567 696e 203d 2070 6c75 6769 6e73 5b30  ugin = plugins[0
+000465d0: 5d0a 2020 2020 2020 2020 7365 6c66 2e72  ].        self.r
+000465e0: 656d 6f76 655f 706c 7567 696e 286e 616d  emove_plugin(nam
+000465f0: 653d 706c 7567 696e 2e6e 616d 6529 0a20  e=plugin.name). 
+00046600: 2020 2020 2020 2072 6574 7572 6e20 7b22         return {"
+00046610: 6d65 7461 6461 7461 223a 2070 6c75 6769  metadata": plugi
+00046620: 6e2e 6d65 7461 6461 7461 2c20 2273 7461  n.metadata, "sta
+00046630: 7465 223a 2070 6c75 6769 6e2e 7374 6174  te": plugin.stat
+00046640: 657d 0a0a 2020 2020 6173 796e 6320 6465  e}..    async de
+00046650: 6620 7265 6769 7374 6572 5f77 6f72 6b65  f register_worke
+00046660: 725f 706c 7567 696e 280a 2020 2020 2020  r_plugin(.      
+00046670: 2020 7365 6c66 2c20 636f 6d6d 3a20 4e6f    self, comm: No
+00046680: 6e65 2c20 706c 7567 696e 3a20 6279 7465  ne, plugin: byte
+00046690: 732c 206e 616d 653a 2073 7472 2c20 6964  s, name: str, id
+000466a0: 656d 706f 7465 6e74 3a20 626f 6f6c 207c  empotent: bool |
+000466b0: 204e 6f6e 6520 3d20 4e6f 6e65 0a20 2020   None = None.   
+000466c0: 2029 202d 3e20 6469 6374 5b73 7472 2c20   ) -> dict[str, 
+000466d0: 4f4b 4d65 7373 6167 655d 3a0a 2020 2020  OKMessage]:.    
+000466e0: 2020 2020 2222 2252 6567 6973 7465 7273      """Registers
+000466f0: 2061 2077 6f72 6b65 7220 706c 7567 696e   a worker plugin
+00046700: 206f 6e20 616c 6c20 7275 6e6e 696e 6720   on all running 
+00046710: 616e 6420 6675 7475 7265 2077 6f72 6b65  and future worke
+00046720: 7273 2222 220a 2020 2020 2020 2020 6c6f  rs""".        lo
+00046730: 6767 6572 2e69 6e66 6f28 2252 6567 6973  gger.info("Regis
+00046740: 7465 7269 6e67 2057 6f72 6b65 7220 706c  tering Worker pl
+00046750: 7567 696e 2025 7322 2c20 6e61 6d65 290a  ugin %s", name).
+00046760: 2020 2020 2020 2020 6966 2069 6465 6d70          if idemp
+00046770: 6f74 656e 7420 6973 204e 6f6e 653a 0a20  otent is None:. 
+00046780: 2020 2020 2020 2020 2020 2077 6172 6e69             warni
+00046790: 6e67 732e 7761 726e 280a 2020 2020 2020  ngs.warn(.      
+000467a0: 2020 2020 2020 2020 2020 2254 6865 2073            "The s
+000467b0: 6967 6e61 7475 7265 206f 6620 6053 6368  ignature of `Sch
+000467c0: 6564 756c 6572 2e72 6567 6973 7465 725f  eduler.register_
+000467d0: 776f 726b 6572 5f70 6c75 6769 6e60 206e  worker_plugin` n
+000467e0: 6f77 2072 6571 7569 7265 7320 220a 2020  ow requires ".  
+000467f0: 2020 2020 2020 2020 2020 2020 2020 2260                "`
+00046800: 6964 656d 706f 7465 6e74 602e 204e 6f74  idempotent`. Not
+00046810: 2069 6e63 6c75 6469 6e67 2060 6964 656d   including `idem
+00046820: 706f 7465 6e74 6020 696e 2074 6865 2073  potent` in the s
+00046830: 6967 6e61 7475 7265 2077 696c 6c20 6e6f  ignature will no
+00046840: 206c 6f6e 6765 7220 220a 2020 2020 2020   longer ".      
+00046850: 2020 2020 2020 2020 2020 2262 6520 7375            "be su
+00046860: 7070 6f72 7465 6420 696e 2066 7574 7572  pported in futur
+00046870: 6520 7665 7273 696f 6e73 2e22 2c0a 2020  e versions.",.  
+00046880: 2020 2020 2020 2020 2020 2020 2020 4675                Fu
+00046890: 7475 7265 5761 726e 696e 672c 0a20 2020  tureWarning,.   
+000468a0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+000468b0: 2020 2020 2020 2069 6465 6d70 6f74 656e         idempoten
+000468c0: 7420 3d20 4661 6c73 650a 2020 2020 2020  t = False.      
+000468d0: 2020 6966 206e 616d 6520 696e 2073 656c    if name in sel
+000468e0: 662e 776f 726b 6572 5f70 6c75 6769 6e73  f.worker_plugins
+000468f0: 2061 6e64 2069 6465 6d70 6f74 656e 743a   and idempotent:
+00046900: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00046910: 7572 6e20 7b7d 0a0a 2020 2020 2020 2020  urn {}..        
+00046920: 7365 6c66 2e77 6f72 6b65 725f 706c 7567  self.worker_plug
+00046930: 696e 735b 6e61 6d65 5d20 3d20 706c 7567  ins[name] = plug
+00046940: 696e 0a0a 2020 2020 2020 2020 7265 7370  in..        resp
+00046950: 6f6e 7365 7320 3d20 6177 6169 7420 7365  onses = await se
+00046960: 6c66 2e62 726f 6164 6361 7374 280a 2020  lf.broadcast(.  
+00046970: 2020 2020 2020 2020 2020 6d73 673d 6469            msg=di
+00046980: 6374 286f 703d 2270 6c75 6769 6e2d 6164  ct(op="plugin-ad
+00046990: 6422 2c20 706c 7567 696e 3d70 6c75 6769  d", plugin=plugi
+000469a0: 6e2c 206e 616d 653d 6e61 6d65 290a 2020  n, name=name).  
+000469b0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+000469c0: 7265 7475 726e 2072 6573 706f 6e73 6573  return responses
+000469d0: 0a0a 2020 2020 6173 796e 6320 6465 6620  ..    async def 
+000469e0: 756e 7265 6769 7374 6572 5f77 6f72 6b65  unregister_worke
+000469f0: 725f 706c 7567 696e 280a 2020 2020 2020  r_plugin(.      
+00046a00: 2020 7365 6c66 2c20 636f 6d6d 3a20 4e6f    self, comm: No
+00046a10: 6e65 2c20 6e61 6d65 3a20 7374 720a 2020  ne, name: str.  
+00046a20: 2020 2920 2d3e 2064 6963 745b 7374 722c    ) -> dict[str,
+00046a30: 2045 7272 6f72 4d65 7373 6167 6520 7c20   ErrorMessage | 
+00046a40: 4f4b 4d65 7373 6167 655d 3a0a 2020 2020  OKMessage]:.    
+00046a50: 2020 2020 2222 2255 6e72 6567 6973 7465      """Unregiste
+00046a60: 7273 2061 2077 6f72 6b65 7220 706c 7567  rs a worker plug
+00046a70: 696e 2222 220a 2020 2020 2020 2020 7472  in""".        tr
+00046a80: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+00046a90: 656c 662e 776f 726b 6572 5f70 6c75 6769  elf.worker_plugi
+00046aa0: 6e73 2e70 6f70 286e 616d 6529 0a20 2020  ns.pop(name).   
+00046ab0: 2020 2020 2065 7863 6570 7420 4b65 7945       except KeyE
+00046ac0: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00046ad0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+00046ae0: 6f72 2866 2254 6865 2077 6f72 6b65 7220  or(f"The worker 
+00046af0: 706c 7567 696e 207b 6e61 6d65 7d20 646f  plugin {name} do
+00046b00: 6573 206e 6f74 2065 7869 7374 2229 0a0a  es not exist")..
+00046b10: 2020 2020 2020 2020 7265 7370 6f6e 7365          response
+00046b20: 7320 3d20 6177 6169 7420 7365 6c66 2e62  s = await self.b
+00046b30: 726f 6164 6361 7374 286d 7367 3d64 6963  roadcast(msg=dic
+00046b40: 7428 6f70 3d22 706c 7567 696e 2d72 656d  t(op="plugin-rem
+00046b50: 6f76 6522 2c20 6e61 6d65 3d6e 616d 6529  ove", name=name)
+00046b60: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00046b70: 2072 6573 706f 6e73 6573 0a0a 2020 2020   responses..    
+00046b80: 6173 796e 6320 6465 6620 7265 6769 7374  async def regist
+00046b90: 6572 5f6e 616e 6e79 5f70 6c75 6769 6e28  er_nanny_plugin(
+00046ba0: 0a20 2020 2020 2020 2073 656c 662c 2063  .        self, c
+00046bb0: 6f6d 6d3a 204e 6f6e 652c 2070 6c75 6769  omm: None, plugi
+00046bc0: 6e3a 2062 7974 6573 2c20 6e61 6d65 3a20  n: bytes, name: 
+00046bd0: 7374 722c 2069 6465 6d70 6f74 656e 743a  str, idempotent:
+00046be0: 2062 6f6f 6c20 7c20 4e6f 6e65 203d 204e   bool | None = N
+00046bf0: 6f6e 650a 2020 2020 2920 2d3e 2064 6963  one.    ) -> dic
+00046c00: 745b 7374 722c 204f 4b4d 6573 7361 6765  t[str, OKMessage
+00046c10: 5d3a 0a20 2020 2020 2020 2022 2222 5265  ]:.        """Re
+00046c20: 6769 7374 6572 7320 6120 6e61 6e6e 7920  gisters a nanny 
+00046c30: 706c 7567 696e 206f 6e20 616c 6c20 7275  plugin on all ru
+00046c40: 6e6e 696e 6720 616e 6420 6675 7475 7265  nning and future
+00046c50: 206e 616e 6e69 6573 2222 220a 2020 2020   nannies""".    
+00046c60: 2020 2020 6c6f 6767 6572 2e69 6e66 6f28      logger.info(
+00046c70: 2252 6567 6973 7465 7269 6e67 204e 616e  "Registering Nan
+00046c80: 6e79 2070 6c75 6769 6e20 2573 222c 206e  ny plugin %s", n
+00046c90: 616d 6529 0a0a 2020 2020 2020 2020 6966  ame)..        if
+00046ca0: 2069 6465 6d70 6f74 656e 7420 6973 204e   idempotent is N
+00046cb0: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
+00046cc0: 2077 6172 6e69 6e67 732e 7761 726e 280a   warnings.warn(.
+00046cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00046ce0: 2254 6865 2073 6967 6e61 7475 7265 206f  "The signature o
+00046cf0: 6620 6053 6368 6564 756c 6572 2e72 6567  f `Scheduler.reg
+00046d00: 6973 7465 725f 6e61 6e6e 795f 706c 7567  ister_nanny_plug
+00046d10: 696e 6020 6e6f 7720 7265 7175 6972 6573  in` now requires
+00046d20: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
+00046d30: 2020 2022 6069 6465 6d70 6f74 656e 7460     "`idempotent`
+00046d40: 2e20 4e6f 7420 696e 636c 7564 696e 6720  . Not including 
+00046d50: 6069 6465 6d70 6f74 656e 7460 2069 6e20  `idempotent` in 
+00046d60: 7468 6520 7369 676e 6174 7572 6520 7769  the signature wi
+00046d70: 6c6c 206e 6f20 6c6f 6e67 6572 2022 0a20  ll no longer ". 
+00046d80: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+00046d90: 6265 2073 7570 706f 7274 6564 2069 6e20  be supported in 
+00046da0: 6675 7475 7265 2076 6572 7369 6f6e 732e  future versions.
+00046db0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00046dc0: 2020 2046 7574 7572 6557 6172 6e69 6e67     FutureWarning
+00046dd0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+00046de0: 2020 2020 2020 2020 2020 2020 6964 656d              idem
+00046df0: 706f 7465 6e74 203d 2046 616c 7365 0a0a  potent = False..
+00046e00: 2020 2020 2020 2020 6966 206e 616d 6520          if name 
+00046e10: 696e 2073 656c 662e 6e61 6e6e 795f 706c  in self.nanny_pl
+00046e20: 7567 696e 7320 616e 6420 6964 656d 706f  ugins and idempo
+00046e30: 7465 6e74 3a0a 2020 2020 2020 2020 2020  tent:.          
+00046e40: 2020 7265 7475 726e 207b 7d0a 0a20 2020    return {}..   
+00046e50: 2020 2020 2073 656c 662e 6e61 6e6e 795f       self.nanny_
+00046e60: 706c 7567 696e 735b 6e61 6d65 5d20 3d20  plugins[name] = 
+00046e70: 706c 7567 696e 0a20 2020 2020 2020 2061  plugin.        a
+00046e80: 7379 6e63 2077 6974 6820 7365 6c66 2e5f  sync with self._
+00046e90: 7374 6172 7469 6e67 5f6e 616e 6e69 6573  starting_nannies
+00046ea0: 5f63 6f6e 643a 0a20 2020 2020 2020 2020  _cond:.         
+00046eb0: 2020 2069 6620 7365 6c66 2e5f 7374 6172     if self._star
+00046ec0: 7469 6e67 5f6e 616e 6e69 6573 3a0a 2020  ting_nannies:.  
+00046ed0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00046ee0: 6767 6572 2e69 6e66 6f28 2257 6169 7469  gger.info("Waiti
+00046ef0: 6e67 2066 6f72 204e 616e 6e69 6573 2074  ng for Nannies t
+00046f00: 6f20 7374 6172 7420 2573 222c 2073 656c  o start %s", sel
+00046f10: 662e 5f73 7461 7274 696e 675f 6e61 6e6e  f._starting_nann
+00046f20: 6965 7329 0a20 2020 2020 2020 2020 2020  ies).           
+00046f30: 2061 7761 6974 2073 656c 662e 5f73 7461   await self._sta
+00046f40: 7274 696e 675f 6e61 6e6e 6965 735f 636f  rting_nannies_co
+00046f50: 6e64 2e77 6169 745f 666f 7228 0a20 2020  nd.wait_for(.   
+00046f60: 2020 2020 2020 2020 2020 2020 206c 616d               lam
+00046f70: 6264 613a 206e 6f74 2073 656c 662e 5f73  bda: not self._s
+00046f80: 7461 7274 696e 675f 6e61 6e6e 6965 730a  tarting_nannies.
+00046f90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00046fa0: 2020 2020 2020 2020 2020 7265 7370 6f6e            respon
+00046fb0: 7365 7320 3d20 6177 6169 7420 7365 6c66  ses = await self
+00046fc0: 2e62 726f 6164 6361 7374 280a 2020 2020  .broadcast(.    
+00046fd0: 2020 2020 2020 2020 2020 2020 6d73 673d              msg=
+00046fe0: 6469 6374 286f 703d 2270 6c75 6769 6e5f  dict(op="plugin_
+00046ff0: 6164 6422 2c20 706c 7567 696e 3d70 6c75  add", plugin=plu
+00047000: 6769 6e2c 206e 616d 653d 6e61 6d65 292c  gin, name=name),
+00047010: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00047020: 206e 616e 6e79 3d54 7275 652c 0a20 2020   nanny=True,.   
+00047030: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00047040: 2020 2020 2020 2072 6574 7572 6e20 7265         return re
+00047050: 7370 6f6e 7365 730a 0a20 2020 2061 7379  sponses..    asy
+00047060: 6e63 2064 6566 2075 6e72 6567 6973 7465  nc def unregiste
+00047070: 725f 6e61 6e6e 795f 706c 7567 696e 280a  r_nanny_plugin(.
+00047080: 2020 2020 2020 2020 7365 6c66 2c20 636f          self, co
+00047090: 6d6d 3a20 4e6f 6e65 2c20 6e61 6d65 3a20  mm: None, name: 
+000470a0: 7374 720a 2020 2020 2920 2d3e 2064 6963  str.    ) -> dic
+000470b0: 745b 7374 722c 2045 7272 6f72 4d65 7373  t[str, ErrorMess
+000470c0: 6167 6520 7c20 4f4b 4d65 7373 6167 655d  age | OKMessage]
+000470d0: 3a0a 2020 2020 2020 2020 2222 2255 6e72  :.        """Unr
+000470e0: 6567 6973 7465 7273 2061 2077 6f72 6b65  egisters a worke
+000470f0: 7220 706c 7567 696e 2222 220a 2020 2020  r plugin""".    
+00047100: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00047110: 2020 2020 2073 656c 662e 6e61 6e6e 795f       self.nanny_
+00047120: 706c 7567 696e 732e 706f 7028 6e61 6d65  plugins.pop(name
+00047130: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
+00047140: 204b 6579 4572 726f 723a 0a20 2020 2020   KeyError:.     
+00047150: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+00047160: 7565 4572 726f 7228 6622 5468 6520 6e61  ueError(f"The na
+00047170: 6e6e 7920 706c 7567 696e 207b 6e61 6d65  nny plugin {name
+00047180: 7d20 646f 6573 206e 6f74 2065 7869 7374  } does not exist
+00047190: 2229 0a0a 2020 2020 2020 2020 7265 7370  ")..        resp
+000471a0: 6f6e 7365 7320 3d20 6177 6169 7420 7365  onses = await se
+000471b0: 6c66 2e62 726f 6164 6361 7374 280a 2020  lf.broadcast(.  
+000471c0: 2020 2020 2020 2020 2020 6d73 673d 6469            msg=di
+000471d0: 6374 286f 703d 2270 6c75 6769 6e5f 7265  ct(op="plugin_re
+000471e0: 6d6f 7665 222c 206e 616d 653d 6e61 6d65  move", name=name
+000471f0: 292c 206e 616e 6e79 3d54 7275 650a 2020  ), nanny=True.  
+00047200: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00047210: 7265 7475 726e 2072 6573 706f 6e73 6573  return responses
+00047220: 0a0a 2020 2020 6465 6620 7472 616e 7369  ..    def transi
+00047230: 7469 6f6e 280a 2020 2020 2020 2020 7365  tion(.        se
+00047240: 6c66 2c0a 2020 2020 2020 2020 6b65 793a  lf,.        key:
+00047250: 204b 6579 2c0a 2020 2020 2020 2020 6669   Key,.        fi
+00047260: 6e69 7368 3a20 5461 736b 5374 6174 6553  nish: TaskStateS
+00047270: 7461 7465 2c0a 2020 2020 2020 2020 7374  tate,.        st
+00047280: 696d 756c 7573 5f69 643a 2073 7472 2c0a  imulus_id: str,.
+00047290: 2020 2020 2020 2020 2a2a 6b77 6172 6773          **kwargs
+000472a0: 3a20 416e 792c 0a20 2020 2029 202d 3e20  : Any,.    ) -> 
+000472b0: 5265 6373 3a0a 2020 2020 2020 2020 2222  Recs:.        ""
+000472c0: 2254 7261 6e73 6974 696f 6e20 6120 6b65  "Transition a ke
+000472d0: 7920 6672 6f6d 2069 7473 2063 7572 7265  y from its curre
+000472e0: 6e74 2073 7461 7465 2074 6f20 7468 6520  nt state to the 
+000472f0: 6669 6e69 7368 2073 7461 7465 0a0a 2020  finish state..  
+00047300: 2020 2020 2020 4578 616d 706c 6573 0a20        Examples. 
+00047310: 2020 2020 2020 202d 2d2d 2d2d 2d2d 2d0a         --------.
+00047320: 2020 2020 2020 2020 3e3e 3e20 7365 6c66          >>> self
+00047330: 2e74 7261 6e73 6974 696f 6e28 2778 272c  .transition('x',
+00047340: 2027 7761 6974 696e 6727 290a 2020 2020   'waiting').    
+00047350: 2020 2020 7b27 7827 3a20 2770 726f 6365      {'x': 'proce
+00047360: 7373 696e 6727 7d0a 0a20 2020 2020 2020  ssing'}..       
+00047370: 2052 6574 7572 6e73 0a20 2020 2020 2020   Returns.       
+00047380: 202d 2d2d 2d2d 2d2d 0a20 2020 2020 2020   -------.       
+00047390: 2044 6963 7469 6f6e 6172 7920 6f66 2072   Dictionary of r
+000473a0: 6563 6f6d 6d65 6e64 6174 696f 6e73 2066  ecommendations f
+000473b0: 6f72 2066 7574 7572 6520 7472 616e 7369  or future transi
+000473c0: 7469 6f6e 730a 0a20 2020 2020 2020 2053  tions..        S
+000473d0: 6565 2041 6c73 6f0a 2020 2020 2020 2020  ee Also.        
+000473e0: 2d2d 2d2d 2d2d 2d2d 0a20 2020 2020 2020  --------.       
+000473f0: 2053 6368 6564 756c 6572 2e74 7261 6e73   Scheduler.trans
+00047400: 6974 696f 6e73 3a20 7472 616e 7369 7469  itions: transiti
+00047410: 7665 2076 6572 7369 6f6e 206f 6620 7468  ve version of th
+00047420: 6973 2066 756e 6374 696f 6e0a 2020 2020  is function.    
+00047430: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00047440: 7265 636f 6d6d 656e 6461 7469 6f6e 732c  recommendations,
+00047450: 2063 6c69 656e 745f 6d73 6773 2c20 776f   client_msgs, wo
+00047460: 726b 6572 5f6d 7367 7320 3d20 7365 6c66  rker_msgs = self
+00047470: 2e5f 7472 616e 7369 7469 6f6e 280a 2020  ._transition(.  
+00047480: 2020 2020 2020 2020 2020 6b65 792c 2066            key, f
+00047490: 696e 6973 682c 2073 7469 6d75 6c75 735f  inish, stimulus_
+000474a0: 6964 2c20 2a2a 6b77 6172 6773 0a20 2020  id, **kwargs.   
+000474b0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+000474c0: 656c 662e 7365 6e64 5f61 6c6c 2863 6c69  elf.send_all(cli
+000474d0: 656e 745f 6d73 6773 2c20 776f 726b 6572  ent_msgs, worker
+000474e0: 5f6d 7367 7329 0a20 2020 2020 2020 2072  _msgs).        r
+000474f0: 6574 7572 6e20 7265 636f 6d6d 656e 6461  eturn recommenda
+00047500: 7469 6f6e 730a 0a20 2020 2064 6566 2074  tions..    def t
+00047510: 7261 6e73 6974 696f 6e73 2873 656c 662c  ransitions(self,
+00047520: 2072 6563 6f6d 6d65 6e64 6174 696f 6e73   recommendations
+00047530: 3a20 5265 6373 2c20 7374 696d 756c 7573  : Recs, stimulus
+00047540: 5f69 643a 2073 7472 2920 2d3e 204e 6f6e  _id: str) -> Non
+00047550: 653a 0a20 2020 2020 2020 2022 2222 5072  e:.        """Pr
+00047560: 6f63 6573 7320 7472 616e 7369 7469 6f6e  ocess transition
+00047570: 7320 756e 7469 6c20 6e6f 6e65 2061 7265  s until none are
+00047580: 206c 6566 740a 0a20 2020 2020 2020 2054   left..        T
+00047590: 6869 7320 696e 636c 7564 6573 2066 6565  his includes fee
+000475a0: 6462 6163 6b20 6672 6f6d 2070 7265 7669  dback from previ
+000475b0: 6f75 7320 7472 616e 7369 7469 6f6e 7320  ous transitions 
+000475c0: 616e 6420 636f 6e74 696e 7565 7320 756e  and continues un
+000475d0: 7469 6c20 7765 0a20 2020 2020 2020 2072  til we.        r
+000475e0: 6561 6368 2061 2073 7465 6164 7920 7374  each a steady st
+000475f0: 6174 650a 2020 2020 2020 2020 2222 220a  ate.        """.
+00047600: 2020 2020 2020 2020 636c 6965 6e74 5f6d          client_m
+00047610: 7367 733a 204d 7367 7320 3d20 7b7d 0a20  sgs: Msgs = {}. 
+00047620: 2020 2020 2020 2077 6f72 6b65 725f 6d73         worker_ms
+00047630: 6773 3a20 4d73 6773 203d 207b 7d0a 2020  gs: Msgs = {}.  
+00047640: 2020 2020 2020 7365 6c66 2e5f 7472 616e        self._tran
+00047650: 7369 7469 6f6e 7328 7265 636f 6d6d 656e  sitions(recommen
+00047660: 6461 7469 6f6e 732c 2063 6c69 656e 745f  dations, client_
+00047670: 6d73 6773 2c20 776f 726b 6572 5f6d 7367  msgs, worker_msg
+00047680: 732c 2073 7469 6d75 6c75 735f 6964 290a  s, stimulus_id).
+00047690: 2020 2020 2020 2020 7365 6c66 2e73 656e          self.sen
+000476a0: 645f 616c 6c28 636c 6965 6e74 5f6d 7367  d_all(client_msg
+000476b0: 732c 2077 6f72 6b65 725f 6d73 6773 290a  s, worker_msgs).
+000476c0: 0a20 2020 2061 7379 6e63 2064 6566 2067  .    async def g
+000476d0: 6574 5f73 746f 7279 2873 656c 662c 206b  et_story(self, k
+000476e0: 6579 735f 6f72 5f73 7469 6d75 6c69 3a20  eys_or_stimuli: 
+000476f0: 4974 6572 6162 6c65 5b4b 6579 207c 2073  Iterable[Key | s
+00047700: 7472 5d29 202d 3e20 6c69 7374 5b54 7261  tr]) -> list[Tra
+00047710: 6e73 6974 696f 6e5d 3a0a 2020 2020 2020  nsition]:.      
+00047720: 2020 2222 2252 5043 2068 6f6f 6b20 666f    """RPC hook fo
+00047730: 7220 3a6d 6574 683a 6053 6368 6564 756c  r :meth:`Schedul
+00047740: 6572 5374 6174 652e 7374 6f72 7960 2e0a  erState.story`..
+00047750: 0a20 2020 2020 2020 204e 6f74 6520 7468  .        Note th
+00047760: 6174 2074 6865 206d 7367 7061 636b 2073  at the msgpack s
+00047770: 6572 6961 6c69 7a61 7469 6f6e 2f64 6573  erialization/des
+00047780: 6572 6961 6c69 7a61 7469 6f6e 2072 6f75  erialization rou
+00047790: 6e64 2d74 7269 7020 7769 6c6c 2074 7261  nd-trip will tra
+000477a0: 6e73 666f 726d 0a20 2020 2020 2020 2074  nsform.        t
+000477b0: 6865 203a 636c 6173 733a 6054 7261 6e73  he :class:`Trans
+000477c0: 6974 696f 6e60 206e 616d 6564 7475 706c  ition` namedtupl
+000477d0: 6573 2069 6e74 6f20 7265 6775 6c61 7220  es into regular 
+000477e0: 7475 706c 6573 2e0a 2020 2020 2020 2020  tuples..        
+000477f0: 2222 220a 2020 2020 2020 2020 7265 7475  """.        retu
+00047800: 726e 2073 656c 662e 7374 6f72 7928 2a6b  rn self.story(*k
+00047810: 6579 735f 6f72 5f73 7469 6d75 6c69 290a  eys_or_stimuli).
+00047820: 0a20 2020 2064 6566 205f 7265 7363 6865  .    def _resche
+00047830: 6475 6c65 280a 2020 2020 2020 2020 7365  dule(.        se
+00047840: 6c66 2c20 6b65 793a 204b 6579 2c20 776f  lf, key: Key, wo
+00047850: 726b 6572 3a20 7374 7220 7c20 4e6f 6e65  rker: str | None
+00047860: 203d 204e 6f6e 652c 202a 2c20 7374 696d   = None, *, stim
+00047870: 756c 7573 5f69 643a 2073 7472 0a20 2020  ulus_id: str.   
+00047880: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+00047890: 2020 2020 2222 2252 6573 6368 6564 756c      """Reschedul
+000478a0: 6520 6120 7461 736b 2e0a 0a20 2020 2020  e a task...     
+000478b0: 2020 2054 6869 7320 6675 6e63 7469 6f6e     This function
+000478c0: 2073 686f 756c 6420 6f6e 6c79 2062 6520   should only be 
+000478d0: 7573 6564 2077 6865 6e20 7468 6520 7461  used when the ta
+000478e0: 736b 2068 6173 2061 6c72 6561 6479 2062  sk has already b
+000478f0: 6565 6e20 7265 6c65 6173 6564 2069 6e0a  een released in.
+00047900: 2020 2020 2020 2020 736f 6d65 2077 6179          some way
+00047910: 206f 6e20 7468 6520 776f 726b 6572 2069   on the worker i
+00047920: 7427 7320 6173 7369 676e 6564 2074 6f20  t's assigned to 
+00047930: e280 9420 6569 7468 6572 2076 6961 2063  ... either via c
+00047940: 616e 6365 6c6c 6174 696f 6e20 6f72 2061  ancellation or a
+00047950: 0a20 2020 2020 2020 2052 6573 6368 6564  .        Resched
+00047960: 756c 6520 6578 6365 7074 696f 6e20 e280  ule exception ..
+00047970: 9420 616e 6420 796f 7520 6172 6520 6365  . and you are ce
+00047980: 7274 6169 6e20 7468 6520 776f 726b 6572  rtain the worker
+00047990: 2077 696c 6c20 6e6f 7420 7365 6e64 2061   will not send a
+000479a0: 6e79 2066 7572 7468 6572 0a20 2020 2020  ny further.     
+000479b0: 2020 2075 7064 6174 6573 2061 626f 7574     updates about
+000479c0: 2074 6865 2074 6173 6b20 746f 2074 6865   the task to the
+000479d0: 2073 6368 6564 756c 6572 2e0a 2020 2020   scheduler..    
+000479e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000479f0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+00047a00: 2074 7320 3d20 7365 6c66 2e74 6173 6b73   ts = self.tasks
+00047a10: 5b6b 6579 5d0a 2020 2020 2020 2020 6578  [key].        ex
+00047a20: 6365 7074 204b 6579 4572 726f 723a 0a20  cept KeyError:. 
+00047a30: 2020 2020 2020 2020 2020 206c 6f67 6765             logge
+00047a40: 722e 7761 726e 696e 6728 0a20 2020 2020  r.warning(.     
+00047a50: 2020 2020 2020 2020 2020 2066 2241 7474             f"Att
+00047a60: 656d 7074 696e 6720 746f 2072 6573 6368  empting to resch
+00047a70: 6564 756c 6520 7461 736b 207b 6b65 7921  edule task {key!
+00047a80: 727d 2c20 7768 6963 6820 7761 7320 6e6f  r}, which was no
+00047a90: 7420 220a 2020 2020 2020 2020 2020 2020  t ".            
+00047aa0: 2020 2020 2266 6f75 6e64 206f 6e20 7468      "found on th
+00047ab0: 6520 7363 6865 6475 6c65 722e 2041 626f  e scheduler. Abo
+00047ac0: 7274 696e 6720 7265 7363 6865 6475 6c65  rting reschedule
+00047ad0: 2e22 0a20 2020 2020 2020 2020 2020 2029  .".            )
+00047ae0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00047af0: 7572 6e0a 2020 2020 2020 2020 6966 2074  urn.        if t
+00047b00: 732e 7374 6174 6520 213d 2022 7072 6f63  s.state != "proc
+00047b10: 6573 7369 6e67 223a 0a20 2020 2020 2020  essing":.       
+00047b20: 2020 2020 2072 6574 7572 6e0a 2020 2020       return.    
+00047b30: 2020 2020 6966 2077 6f72 6b65 7220 616e      if worker an
+00047b40: 6420 7473 2e70 726f 6365 7373 696e 675f  d ts.processing_
+00047b50: 6f6e 2061 6e64 2074 732e 7072 6f63 6573  on and ts.proces
+00047b60: 7369 6e67 5f6f 6e2e 6164 6472 6573 7320  sing_on.address 
+00047b70: 213d 2077 6f72 6b65 723a 0a20 2020 2020  != worker:.     
+00047b80: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00047b90: 2020 2020 2020 2320 7472 616e 7369 7469        # transiti
+00047ba0: 6f6e 5f70 726f 6365 7373 696e 675f 7265  on_processing_re
+00047bb0: 6c65 6173 6564 2077 696c 6c20 696d 6d65  leased will imme
+00047bc0: 6469 6174 656c 7920 7375 6767 6573 7420  diately suggest 
+00047bd0: 616e 2061 6464 6974 696f 6e61 6c0a 2020  an additional.  
+00047be0: 2020 2020 2020 2320 7472 616e 7369 7469        # transiti
+00047bf0: 6f6e 2074 6f20 7761 6974 696e 6720 6966  on to waiting if
+00047c00: 2074 6865 2074 6173 6b20 6861 7320 616e   the task has an
+00047c10: 7920 7761 6974 6572 7320 6f72 2063 6c69  y waiters or cli
+00047c20: 656e 7473 2068 6f6c 6469 6e67 2061 2066  ents holding a f
+00047c30: 7574 7572 652e 0a20 2020 2020 2020 2073  uture..        s
+00047c40: 656c 662e 7472 616e 7369 7469 6f6e 7328  elf.transitions(
+00047c50: 7b6b 6579 3a20 2272 656c 6561 7365 6422  {key: "released"
+00047c60: 7d2c 2073 7469 6d75 6c75 735f 6964 3d73  }, stimulus_id=s
+00047c70: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
+00047c80: 2023 2323 2323 2323 2323 2323 2323 2323   ###############
+00047c90: 2323 2323 2323 0a20 2020 2023 2055 7469  ######.    # Uti
+00047ca0: 6c69 7479 2066 756e 6374 696f 6e73 2023  lity functions #
+00047cb0: 0a20 2020 2023 2323 2323 2323 2323 2323  .    ###########
+00047cc0: 2323 2323 2323 2323 2323 0a0a 2020 2020  ##########..    
+00047cd0: 6465 6620 6164 645f 7265 736f 7572 6365  def add_resource
+00047ce0: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+00047cf0: 2077 6f72 6b65 723a 2073 7472 2c20 7265   worker: str, re
+00047d00: 736f 7572 6365 733a 2064 6963 7420 7c20  sources: dict | 
+00047d10: 4e6f 6e65 203d 204e 6f6e 650a 2020 2020  None = None.    
+00047d20: 2920 2d3e 204c 6974 6572 616c 5b22 4f4b  ) -> Literal["OK
+00047d30: 225d 3a0a 2020 2020 2020 2020 7773 203d  "]:.        ws =
+00047d40: 2073 656c 662e 776f 726b 6572 735b 776f   self.workers[wo
+00047d50: 726b 6572 5d0a 2020 2020 2020 2020 6966  rker].        if
+00047d60: 2072 6573 6f75 7263 6573 3a0a 2020 2020   resources:.    
+00047d70: 2020 2020 2020 2020 7773 2e72 6573 6f75          ws.resou
+00047d80: 7263 6573 2e75 7064 6174 6528 7265 736f  rces.update(reso
+00047d90: 7572 6365 7329 0a20 2020 2020 2020 2077  urces).        w
+00047da0: 732e 7573 6564 5f72 6573 6f75 7263 6573  s.used_resources
+00047db0: 203d 207b 7d0a 2020 2020 2020 2020 666f   = {}.        fo
+00047dc0: 7220 7265 736f 7572 6365 2c20 7175 616e  r resource, quan
+00047dd0: 7469 7479 2069 6e20 7773 2e72 6573 6f75  tity in ws.resou
+00047de0: 7263 6573 2e69 7465 6d73 2829 3a0a 2020  rces.items():.  
+00047df0: 2020 2020 2020 2020 2020 7773 2e75 7365            ws.use
+00047e00: 645f 7265 736f 7572 6365 735b 7265 736f  d_resources[reso
+00047e10: 7572 6365 5d20 3d20 300a 2020 2020 2020  urce] = 0.      
+00047e20: 2020 2020 2020 6472 203d 2073 656c 662e        dr = self.
+00047e30: 7265 736f 7572 6365 732e 6765 7428 7265  resources.get(re
+00047e40: 736f 7572 6365 2c20 4e6f 6e65 290a 2020  source, None).  
+00047e50: 2020 2020 2020 2020 2020 6966 2064 7220            if dr 
+00047e60: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
+00047e70: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+00047e80: 736f 7572 6365 735b 7265 736f 7572 6365  sources[resource
+00047e90: 5d20 3d20 6472 203d 207b 7d0a 2020 2020  ] = dr = {}.    
+00047ea0: 2020 2020 2020 2020 6472 5b77 6f72 6b65          dr[worke
+00047eb0: 725d 203d 2071 7561 6e74 6974 790a 2020  r] = quantity.  
+00047ec0: 2020 2020 2020 7265 7475 726e 2022 4f4b        return "OK
+00047ed0: 220a 0a20 2020 2064 6566 2072 656d 6f76  "..    def remov
+00047ee0: 655f 7265 736f 7572 6365 7328 7365 6c66  e_resources(self
+00047ef0: 2c20 776f 726b 6572 3a20 7374 7229 202d  , worker: str) -
+00047f00: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00047f10: 7773 203d 2073 656c 662e 776f 726b 6572  ws = self.worker
+00047f20: 735b 776f 726b 6572 5d0a 2020 2020 2020  s[worker].      
+00047f30: 2020 666f 7220 7265 736f 7572 6365 2069    for resource i
+00047f40: 6e20 7773 2e72 6573 6f75 7263 6573 3a0a  n ws.resources:.
+00047f50: 2020 2020 2020 2020 2020 2020 6472 203d              dr =
+00047f60: 2073 656c 662e 7265 736f 7572 6365 732e   self.resources.
+00047f70: 7365 7464 6566 6175 6c74 2872 6573 6f75  setdefault(resou
+00047f80: 7263 652c 207b 7d29 0a20 2020 2020 2020  rce, {}).       
+00047f90: 2020 2020 2064 656c 2064 725b 776f 726b       del dr[work
+00047fa0: 6572 5d0a 0a20 2020 2064 6566 2063 6f65  er]..    def coe
+00047fb0: 7263 655f 6164 6472 6573 7328 7365 6c66  rce_address(self
+00047fc0: 2c20 6164 6472 3a20 7374 7220 7c20 7475  , addr: str | tu
+00047fd0: 706c 652c 2072 6573 6f6c 7665 3a20 626f  ple, resolve: bo
+00047fe0: 6f6c 203d 2054 7275 6529 202d 3e20 7374  ol = True) -> st
+00047ff0: 723a 0a20 2020 2020 2020 2022 2222 0a20  r:.        """. 
+00048000: 2020 2020 2020 2043 6f65 7263 6520 706f         Coerce po
+00048010: 7373 6962 6c65 2069 6e70 7574 2061 6464  ssible input add
+00048020: 7265 7373 6573 2074 6f20 6361 6e6f 6e69  resses to canoni
+00048030: 6361 6c20 666f 726d 2e0a 2020 2020 2020  cal form..      
+00048040: 2020 2a72 6573 6f6c 7665 2a20 6361 6e20    *resolve* can 
+00048050: 6265 2064 6973 6162 6c65 6420 666f 7220  be disabled for 
+00048060: 7465 7374 696e 6720 7769 7468 2066 616b  testing with fak
+00048070: 6520 686f 7374 6e61 6d65 732e 0a0a 2020  e hostnames...  
+00048080: 2020 2020 2020 4861 6e64 6c65 7320 7374        Handles st
+00048090: 7269 6e67 732c 2074 7570 6c65 732c 206f  rings, tuples, o
+000480a0: 7220 616c 6961 7365 732e 0a20 2020 2020  r aliases..     
+000480b0: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+000480c0: 2058 5858 2068 6f77 206d 616e 7920 6164   XXX how many ad
+000480d0: 6472 6573 732d 7061 7273 696e 6720 726f  dress-parsing ro
+000480e0: 7574 696e 6573 2064 6f20 7765 2068 6176  utines do we hav
+000480f0: 653f 0a20 2020 2020 2020 2069 6620 6164  e?.        if ad
+00048100: 6472 2069 6e20 7365 6c66 2e61 6c69 6173  dr in self.alias
+00048110: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+00048120: 6164 6472 203d 2073 656c 662e 616c 6961  addr = self.alia
+00048130: 7365 735b 6164 6472 5d0a 2020 2020 2020  ses[addr].      
+00048140: 2020 6966 2069 7369 6e73 7461 6e63 6528    if isinstance(
+00048150: 6164 6472 2c20 7475 706c 6529 3a0a 2020  addr, tuple):.  
+00048160: 2020 2020 2020 2020 2020 6164 6472 203d            addr =
+00048170: 2075 6e70 6172 7365 5f68 6f73 745f 706f   unparse_host_po
+00048180: 7274 282a 6164 6472 290a 2020 2020 2020  rt(*addr).      
+00048190: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+000481a0: 6e63 6528 6164 6472 2c20 7374 7229 3a0a  nce(addr, str):.
+000481b0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+000481c0: 6520 5479 7065 4572 726f 7228 6622 6164  e TypeError(f"ad
+000481d0: 6472 6573 7365 7320 7368 6f75 6c64 2062  dresses should b
+000481e0: 6520 7374 7269 6e67 7320 6f72 2074 7570  e strings or tup
+000481f0: 6c65 732c 2067 6f74 207b 6164 6472 2172  les, got {addr!r
+00048200: 7d22 290a 0a20 2020 2020 2020 2069 6620  }")..        if 
+00048210: 7265 736f 6c76 653a 0a20 2020 2020 2020  resolve:.       
+00048220: 2020 2020 2061 6464 7220 3d20 7265 736f       addr = reso
+00048230: 6c76 655f 6164 6472 6573 7328 6164 6472  lve_address(addr
+00048240: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00048250: 2020 2020 2020 2020 2020 2020 6164 6472              addr
+00048260: 203d 206e 6f72 6d61 6c69 7a65 5f61 6464   = normalize_add
+00048270: 7265 7373 2861 6464 7229 0a0a 2020 2020  ress(addr)..    
+00048280: 2020 2020 7265 7475 726e 2061 6464 720a      return addr.
+00048290: 0a20 2020 2064 6566 2077 6f72 6b65 7273  .    def workers
+000482a0: 5f6c 6973 7428 7365 6c66 2c20 776f 726b  _list(self, work
+000482b0: 6572 733a 2049 7465 7261 626c 655b 7374  ers: Iterable[st
+000482c0: 725d 207c 204e 6f6e 6529 202d 3e20 6c69  r] | None) -> li
+000482d0: 7374 5b73 7472 5d3a 0a20 2020 2020 2020  st[str]:.       
+000482e0: 2022 2222 0a20 2020 2020 2020 204c 6973   """.        Lis
+000482f0: 7420 6f66 2071 7561 6c69 6679 696e 6720  t of qualifying 
+00048300: 776f 726b 6572 730a 0a20 2020 2020 2020  workers..       
+00048310: 2054 616b 6573 2061 206c 6973 7420 6f66   Takes a list of
+00048320: 2077 6f72 6b65 7220 6164 6472 6573 7365   worker addresse
+00048330: 7320 6f72 2068 6f73 746e 616d 6573 2e0a  s or hostnames..
+00048340: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
+00048350: 6120 6c69 7374 206f 6620 616c 6c20 776f  a list of all wo
+00048360: 726b 6572 2061 6464 7265 7373 6573 2074  rker addresses t
+00048370: 6861 7420 6d61 7463 680a 2020 2020 2020  hat match.      
+00048380: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+00048390: 2077 6f72 6b65 7273 2069 7320 4e6f 6e65   workers is None
+000483a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000483b0: 7475 726e 206c 6973 7428 7365 6c66 2e77  turn list(self.w
+000483c0: 6f72 6b65 7273 290a 0a20 2020 2020 2020  orkers)..       
+000483d0: 206f 7574 203d 2073 6574 2829 0a20 2020   out = set().   
+000483e0: 2020 2020 2066 6f72 2077 2069 6e20 776f       for w in wo
+000483f0: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
+00048400: 2020 2069 6620 223a 2220 696e 2077 3a0a     if ":" in w:.
+00048410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00048420: 6f75 742e 6164 6428 7729 0a20 2020 2020  out.add(w).     
+00048430: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00048440: 2020 2020 2020 2020 2020 2020 206f 7574               out
+00048450: 2e75 7064 6174 6528 7b77 7720 666f 7220  .update({ww for 
+00048460: 7777 2069 6e20 7365 6c66 2e77 6f72 6b65  ww in self.worke
+00048470: 7273 2069 6620 7720 696e 2077 777d 2920  rs if w in ww}) 
+00048480: 2023 2054 4f44 4f3a 2071 7561 6472 6174   # TODO: quadrat
+00048490: 6963 0a20 2020 2020 2020 2072 6574 7572  ic.        retur
+000484a0: 6e20 6c69 7374 286f 7574 290a 0a20 2020  n list(out)..   
+000484b0: 2061 7379 6e63 2064 6566 2067 6574 5f70   async def get_p
+000484c0: 726f 6669 6c65 280a 2020 2020 2020 2020  rofile(.        
+000484d0: 7365 6c66 2c0a 2020 2020 2020 2020 636f  self,.        co
+000484e0: 6d6d 3d4e 6f6e 652c 0a20 2020 2020 2020  mm=None,.       
+000484f0: 2077 6f72 6b65 7273 3d4e 6f6e 652c 0a20   workers=None,. 
+00048500: 2020 2020 2020 2073 6368 6564 756c 6572         scheduler
+00048510: 3d46 616c 7365 2c0a 2020 2020 2020 2020  =False,.        
+00048520: 7365 7276 6572 3d46 616c 7365 2c0a 2020  server=False,.  
+00048530: 2020 2020 2020 6d65 7267 655f 776f 726b        merge_work
+00048540: 6572 733d 5472 7565 2c0a 2020 2020 2020  ers=True,.      
+00048550: 2020 7374 6172 743d 4e6f 6e65 2c0a 2020    start=None,.  
+00048560: 2020 2020 2020 7374 6f70 3d4e 6f6e 652c        stop=None,
+00048570: 0a20 2020 2020 2020 206b 6579 3d4e 6f6e  .        key=Non
+00048580: 652c 0a20 2020 2029 3a0a 2020 2020 2020  e,.    ):.      
+00048590: 2020 6966 2077 6f72 6b65 7273 2069 7320    if workers is 
+000485a0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+000485b0: 2020 776f 726b 6572 7320 3d20 7365 6c66    workers = self
+000485c0: 2e77 6f72 6b65 7273 0a20 2020 2020 2020  .workers.       
+000485d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000485e0: 2020 2077 6f72 6b65 7273 203d 2073 6574     workers = set
+000485f0: 2873 656c 662e 776f 726b 6572 7329 2026  (self.workers) &
+00048600: 2073 6574 2877 6f72 6b65 7273 290a 0a20   set(workers).. 
+00048610: 2020 2020 2020 2069 6620 7363 6865 6475         if schedu
+00048620: 6c65 723a 0a20 2020 2020 2020 2020 2020  ler:.           
+00048630: 2072 6574 7572 6e20 7072 6f66 696c 652e   return profile.
+00048640: 6765 745f 7072 6f66 696c 6528 7365 6c66  get_profile(self
+00048650: 2e69 6f5f 6c6f 6f70 2e70 726f 6669 6c65  .io_loop.profile
+00048660: 2c20 7374 6172 743d 7374 6172 742c 2073  , start=start, s
+00048670: 746f 703d 7374 6f70 290a 0a20 2020 2020  top=stop)..     
+00048680: 2020 2072 6573 756c 7473 203d 2061 7761     results = awa
+00048690: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
+000486a0: 7228 0a20 2020 2020 2020 2020 2020 202a  r(.            *
+000486b0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000486c0: 2020 7365 6c66 2e72 7063 2877 292e 7072    self.rpc(w).pr
+000486d0: 6f66 696c 6528 7374 6172 743d 7374 6172  ofile(start=star
+000486e0: 742c 2073 746f 703d 7374 6f70 2c20 6b65  t, stop=stop, ke
+000486f0: 793d 6b65 792c 2073 6572 7665 723d 7365  y=key, server=se
+00048700: 7276 6572 290a 2020 2020 2020 2020 2020  rver).          
+00048710: 2020 2020 2020 666f 7220 7720 696e 2077        for w in w
+00048720: 6f72 6b65 7273 0a20 2020 2020 2020 2020  orkers.         
+00048730: 2020 2029 2c0a 2020 2020 2020 2020 2020     ),.          
+00048740: 2020 7265 7475 726e 5f65 7863 6570 7469    return_excepti
+00048750: 6f6e 733d 5472 7565 2c0a 2020 2020 2020  ons=True,.      
+00048760: 2020 290a 0a20 2020 2020 2020 2072 6573    )..        res
+00048770: 756c 7473 203d 205b 7220 666f 7220 7220  ults = [r for r 
+00048780: 696e 2072 6573 756c 7473 2069 6620 6e6f  in results if no
+00048790: 7420 6973 696e 7374 616e 6365 2872 2c20  t isinstance(r, 
+000487a0: 4578 6365 7074 696f 6e29 5d0a 0a20 2020  Exception)]..   
+000487b0: 2020 2020 2069 6620 6d65 7267 655f 776f       if merge_wo
+000487c0: 726b 6572 733a 0a20 2020 2020 2020 2020  rkers:.         
+000487d0: 2020 2072 6573 706f 6e73 6520 3d20 7072     response = pr
+000487e0: 6f66 696c 652e 6d65 7267 6528 2a72 6573  ofile.merge(*res
+000487f0: 756c 7473 290a 2020 2020 2020 2020 656c  ults).        el
+00048800: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00048810: 7265 7370 6f6e 7365 203d 2064 6963 7428  response = dict(
+00048820: 7a69 7028 776f 726b 6572 732c 2072 6573  zip(workers, res
+00048830: 756c 7473 2929 0a20 2020 2020 2020 2072  ults)).        r
+00048840: 6574 7572 6e20 7265 7370 6f6e 7365 0a0a  eturn response..
+00048850: 2020 2020 6173 796e 6320 6465 6620 6765      async def ge
+00048860: 745f 7072 6f66 696c 655f 6d65 7461 6461  t_profile_metada
+00048870: 7461 280a 2020 2020 2020 2020 7365 6c66  ta(.        self
+00048880: 2c0a 2020 2020 2020 2020 776f 726b 6572  ,.        worker
+00048890: 733a 2049 7465 7261 626c 655b 7374 725d  s: Iterable[str]
+000488a0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
+000488b0: 2020 2020 2020 2020 7374 6172 743a 2066          start: f
+000488c0: 6c6f 6174 203d 2030 2c0a 2020 2020 2020  loat = 0,.      
+000488d0: 2020 7374 6f70 3a20 666c 6f61 7420 7c20    stop: float | 
+000488e0: 4e6f 6e65 203d 204e 6f6e 652c 0a20 2020  None = None,.   
+000488f0: 2020 2020 2070 726f 6669 6c65 5f63 7963       profile_cyc
+00048900: 6c65 5f69 6e74 6572 7661 6c3a 2073 7472  le_interval: str
+00048910: 207c 2066 6c6f 6174 207c 204e 6f6e 6520   | float | None 
+00048920: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
+00048930: 2064 6963 745b 7374 722c 2041 6e79 5d3a   dict[str, Any]:
+00048940: 0a20 2020 2020 2020 2064 7420 3d20 7072  .        dt = pr
+00048950: 6f66 696c 655f 6379 636c 655f 696e 7465  ofile_cycle_inte
+00048960: 7276 616c 206f 7220 6461 736b 2e63 6f6e  rval or dask.con
+00048970: 6669 672e 6765 7428 0a20 2020 2020 2020  fig.get(.       
+00048980: 2020 2020 2022 6469 7374 7269 6275 7465       "distribute
+00048990: 642e 776f 726b 6572 2e70 726f 6669 6c65  d.worker.profile
+000489a0: 2e63 7963 6c65 220a 2020 2020 2020 2020  .cycle".        
+000489b0: 290a 2020 2020 2020 2020 6474 203d 2070  ).        dt = p
+000489c0: 6172 7365 5f74 696d 6564 656c 7461 2864  arse_timedelta(d
+000489d0: 742c 2064 6566 6175 6c74 3d22 6d73 2229  t, default="ms")
+000489e0: 0a0a 2020 2020 2020 2020 6966 2077 6f72  ..        if wor
+000489f0: 6b65 7273 2069 7320 4e6f 6e65 3a0a 2020  kers is None:.  
+00048a00: 2020 2020 2020 2020 2020 776f 726b 6572            worker
+00048a10: 7320 3d20 7365 6c66 2e77 6f72 6b65 7273  s = self.workers
+00048a20: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00048a30: 2020 2020 2020 2020 2020 2077 6f72 6b65             worke
+00048a40: 7273 203d 2073 6574 2873 656c 662e 776f  rs = set(self.wo
+00048a50: 726b 6572 7329 2026 2073 6574 2877 6f72  rkers) & set(wor
+00048a60: 6b65 7273 290a 2020 2020 2020 2020 7265  kers).        re
+00048a70: 7375 6c74 733a 2053 6571 7565 6e63 655b  sults: Sequence[
+00048a80: 416e 795d 203d 2061 7761 6974 2061 7379  Any] = await asy
+00048a90: 6e63 696f 2e67 6174 6865 7228 0a20 2020  ncio.gather(.   
+00048aa0: 2020 2020 2020 2020 202a 2873 656c 662e           *(self.
+00048ab0: 7270 6328 7729 2e70 726f 6669 6c65 5f6d  rpc(w).profile_m
+00048ac0: 6574 6164 6174 6128 7374 6172 743d 7374  etadata(start=st
+00048ad0: 6172 742c 2073 746f 703d 7374 6f70 2920  art, stop=stop) 
+00048ae0: 666f 7220 7720 696e 2077 6f72 6b65 7273  for w in workers
+00048af0: 292c 0a20 2020 2020 2020 2020 2020 2072  ),.            r
+00048b00: 6574 7572 6e5f 6578 6365 7074 696f 6e73  eturn_exceptions
+00048b10: 3d54 7275 652c 0a20 2020 2020 2020 2029  =True,.        )
+00048b20: 0a0a 2020 2020 2020 2020 7265 7375 6c74  ..        result
+00048b30: 7320 3d20 5b72 2066 6f72 2072 2069 6e20  s = [r for r in 
+00048b40: 7265 7375 6c74 7320 6966 206e 6f74 2069  results if not i
+00048b50: 7369 6e73 7461 6e63 6528 722c 2045 7863  sinstance(r, Exc
+00048b60: 6570 7469 6f6e 295d 0a20 2020 2020 2020  eption)].       
+00048b70: 2063 6f75 6e74 7320 3d20 5b0a 2020 2020   counts = [.    
+00048b80: 2020 2020 2020 2020 2874 696d 652c 2073          (time, s
+00048b90: 756d 2870 6c75 636b 2831 2c20 6772 6f75  um(pluck(1, grou
+00048ba0: 7029 2929 0a20 2020 2020 2020 2020 2020  p))).           
+00048bb0: 2066 6f72 2074 696d 652c 2067 726f 7570   for time, group
+00048bc0: 2069 6e20 6974 6572 746f 6f6c 732e 6772   in itertools.gr
+00048bd0: 6f75 7062 7928 0a20 2020 2020 2020 2020  oupby(.         
+00048be0: 2020 2020 2020 206d 6572 6765 5f73 6f72         merge_sor
+00048bf0: 7465 6428 0a20 2020 2020 2020 2020 2020  ted(.           
+00048c00: 2020 2020 2020 2020 202a 2876 5b22 636f           *(v["co
+00048c10: 756e 7473 225d 2066 6f72 2076 2069 6e20  unts"] for v in 
+00048c20: 7265 7375 6c74 7329 2c0a 2020 2020 2020  results),.      
+00048c30: 2020 2020 2020 2020 2020 292c 0a20 2020            ),.   
+00048c40: 2020 2020 2020 2020 2020 2020 206c 616d               lam
+00048c50: 6264 6120 743a 2074 5b30 5d20 2f2f 2064  bda t: t[0] // d
+00048c60: 7420 2a20 6474 2c0a 2020 2020 2020 2020  t * dt,.        
+00048c70: 2020 2020 290a 2020 2020 2020 2020 5d0a      ).        ].
+00048c80: 0a20 2020 2020 2020 206b 6579 733a 2064  .        keys: d
+00048c90: 6963 745b 4b65 792c 206c 6973 745b 6c69  ict[Key, list[li
+00048ca0: 7374 5d5d 203d 207b 0a20 2020 2020 2020  st]] = {.       
+00048cb0: 2020 2020 206b 3a20 5b5d 2066 6f72 2076       k: [] for v
+00048cc0: 2069 6e20 7265 7375 6c74 7320 666f 7220   in results for 
+00048cd0: 742c 2064 2069 6e20 765b 226b 6579 7322  t, d in v["keys"
+00048ce0: 5d20 666f 7220 6b20 696e 2064 0a20 2020  ] for k in d.   
+00048cf0: 2020 2020 207d 0a0a 2020 2020 2020 2020       }..        
+00048d00: 6772 6f75 7073 3120 3d20 5b76 5b22 6b65  groups1 = [v["ke
+00048d10: 7973 225d 2066 6f72 2076 2069 6e20 7265  ys"] for v in re
+00048d20: 7375 6c74 735d 0a20 2020 2020 2020 2067  sults].        g
+00048d30: 726f 7570 7332 203d 206c 6973 7428 6d65  roups2 = list(me
+00048d40: 7267 655f 736f 7274 6564 282a 6772 6f75  rge_sorted(*grou
+00048d50: 7073 312c 206b 6579 3d66 6972 7374 2929  ps1, key=first))
+00048d60: 0a0a 2020 2020 2020 2020 6c61 7374 203d  ..        last =
+00048d70: 2030 0a20 2020 2020 2020 2066 6f72 2074   0.        for t
+00048d80: 2c20 6420 696e 2067 726f 7570 7332 3a0a  , d in groups2:.
+00048d90: 2020 2020 2020 2020 2020 2020 7474 203d              tt =
+00048da0: 2074 202f 2f20 6474 202a 2064 740a 2020   t // dt * dt.  
+00048db0: 2020 2020 2020 2020 2020 6966 2074 7420            if tt 
+00048dc0: 3e20 6c61 7374 3a0a 2020 2020 2020 2020  > last:.        
+00048dd0: 2020 2020 2020 2020 6c61 7374 203d 2074          last = t
+00048de0: 740a 2020 2020 2020 2020 2020 2020 2020  t.              
+00048df0: 2020 666f 7220 7620 696e 206b 6579 732e    for v in keys.
+00048e00: 7661 6c75 6573 2829 3a0a 2020 2020 2020  values():.      
+00048e10: 2020 2020 2020 2020 2020 2020 2020 762e                v.
+00048e20: 6170 7065 6e64 285b 7474 2c20 305d 290a  append([tt, 0]).
+00048e30: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00048e40: 6b2c 2076 2069 6e20 642e 6974 656d 7328  k, v in d.items(
+00048e50: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00048e60: 2020 206b 6579 735b 6b5d 5b2d 315d 5b31     keys[k][-1][1
+00048e70: 5d20 2b3d 2076 0a0a 2020 2020 2020 2020  ] += v..        
+00048e80: 7265 7475 726e 207b 2263 6f75 6e74 7322  return {"counts"
+00048e90: 3a20 636f 756e 7473 2c20 226b 6579 7322  : counts, "keys"
+00048ea0: 3a20 6b65 7973 7d0a 0a20 2020 2061 7379  : keys}..    asy
+00048eb0: 6e63 2064 6566 2070 6572 666f 726d 616e  nc def performan
+00048ec0: 6365 5f72 6570 6f72 7428 0a20 2020 2020  ce_report(.     
+00048ed0: 2020 2073 656c 662c 2073 7461 7274 3a20     self, start: 
+00048ee0: 666c 6f61 742c 206c 6173 745f 636f 756e  float, last_coun
+00048ef0: 743a 2069 6e74 2c20 636f 6465 3a20 7374  t: int, code: st
+00048f00: 7220 3d20 2222 2c20 6d6f 6465 3a20 7374  r = "", mode: st
+00048f10: 7220 7c20 4e6f 6e65 203d 204e 6f6e 650a  r | None = None.
+00048f20: 2020 2020 2920 2d3e 2073 7472 3a0a 2020      ) -> str:.  
+00048f30: 2020 2020 2020 7374 6f70 203d 2074 696d        stop = tim
+00048f40: 6528 290a 2020 2020 2020 2020 2320 5072  e().        # Pr
+00048f50: 6f66 696c 6573 0a20 2020 2020 2020 2063  ofiles.        c
+00048f60: 6f6d 7075 7465 2c20 7363 6865 6475 6c65  ompute, schedule
+00048f70: 722c 2077 6f72 6b65 7273 203d 2061 7761  r, workers = awa
+00048f80: 6974 2061 7379 6e63 696f 2e67 6174 6865  it asyncio.gathe
+00048f90: 7228 0a20 2020 2020 2020 2020 2020 202a  r(.            *
+00048fa0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
+00048fb0: 2020 7365 6c66 2e67 6574 5f70 726f 6669    self.get_profi
+00048fc0: 6c65 2873 7461 7274 3d73 7461 7274 292c  le(start=start),
+00048fd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00048fe0: 2073 656c 662e 6765 745f 7072 6f66 696c   self.get_profil
+00048ff0: 6528 7363 6865 6475 6c65 723d 5472 7565  e(scheduler=True
+00049000: 2c20 7374 6172 743d 7374 6172 7429 2c0a  , start=start),.
+00049010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00049020: 7365 6c66 2e67 6574 5f70 726f 6669 6c65  self.get_profile
+00049030: 2873 6572 7665 723d 5472 7565 2c20 7374  (server=True, st
+00049040: 6172 743d 7374 6172 7429 2c0a 2020 2020  art=start),.    
+00049050: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
+00049060: 2020 290a 2020 2020 2020 2020 6672 6f6d    ).        from
+00049070: 2064 6973 7472 6962 7574 6564 2069 6d70   distributed imp
+00049080: 6f72 7420 7072 6f66 696c 650a 0a20 2020  ort profile..   
+00049090: 2020 2020 2064 6566 2070 726f 6669 6c65       def profile
+000490a0: 5f74 6f5f 6669 6775 7265 2873 7461 7465  _to_figure(state
+000490b0: 293a 0a20 2020 2020 2020 2020 2020 2064  ):.            d
+000490c0: 6174 6120 3d20 7072 6f66 696c 652e 706c  ata = profile.pl
+000490d0: 6f74 5f64 6174 6128 7374 6174 6529 0a20  ot_data(state). 
+000490e0: 2020 2020 2020 2020 2020 2066 6967 7572             figur
+000490f0: 652c 2073 6f75 7263 6520 3d20 7072 6f66  e, source = prof
+00049100: 696c 652e 706c 6f74 5f66 6967 7572 6528  ile.plot_figure(
+00049110: 6461 7461 2c20 7369 7a69 6e67 5f6d 6f64  data, sizing_mod
+00049120: 653d 2273 7472 6574 6368 5f62 6f74 6822  e="stretch_both"
+00049130: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00049140: 7475 726e 2066 6967 7572 650a 0a20 2020  turn figure..   
+00049150: 2020 2020 2063 6f6d 7075 7465 2c20 7363       compute, sc
+00049160: 6865 6475 6c65 722c 2077 6f72 6b65 7273  heduler, workers
+00049170: 203d 206d 6170 280a 2020 2020 2020 2020   = map(.        
+00049180: 2020 2020 7072 6f66 696c 655f 746f 5f66      profile_to_f
+00049190: 6967 7572 652c 2028 636f 6d70 7574 652c  igure, (compute,
+000491a0: 2073 6368 6564 756c 6572 2c20 776f 726b   scheduler, work
+000491b0: 6572 7329 0a20 2020 2020 2020 2029 0a0a  ers).        )..
+000491c0: 2020 2020 2020 2020 2320 5461 736b 2073          # Task s
+000491d0: 7472 6561 6d0a 2020 2020 2020 2020 7461  tream.        ta
+000491e0: 736b 5f73 7472 6561 6d20 3d20 7365 6c66  sk_stream = self
+000491f0: 2e67 6574 5f74 6173 6b5f 7374 7265 616d  .get_task_stream
+00049200: 2873 7461 7274 3d73 7461 7274 290a 2020  (start=start).  
+00049210: 2020 2020 2020 746f 7461 6c5f 7461 736b        total_task
+00049220: 7320 3d20 6c65 6e28 7461 736b 5f73 7472  s = len(task_str
+00049230: 6561 6d29 0a20 2020 2020 2020 2074 696d  eam).        tim
+00049240: 6573 7065 6e74 3a20 6465 6661 756c 7464  espent: defaultd
+00049250: 6963 745b 7374 722c 2066 6c6f 6174 5d20  ict[str, float] 
+00049260: 3d20 6465 6661 756c 7464 6963 7428 666c  = defaultdict(fl
+00049270: 6f61 7429 0a20 2020 2020 2020 2066 6f72  oat).        for
+00049280: 2064 2069 6e20 7461 736b 5f73 7472 6561   d in task_strea
+00049290: 6d3a 0a20 2020 2020 2020 2020 2020 2066  m:.            f
+000492a0: 6f72 2078 2069 6e20 645b 2273 7461 7274  or x in d["start
+000492b0: 7374 6f70 7322 5d3a 0a20 2020 2020 2020  stops"]:.       
+000492c0: 2020 2020 2020 2020 2074 696d 6573 7065           timespe
+000492d0: 6e74 5b78 5b22 6163 7469 6f6e 225d 5d20  nt[x["action"]] 
+000492e0: 2b3d 2078 5b22 7374 6f70 225d 202d 2078  += x["stop"] - x
+000492f0: 5b22 7374 6172 7422 5d0a 2020 2020 2020  ["start"].      
+00049300: 2020 7461 736b 735f 7469 6d69 6e67 7320    tasks_timings 
+00049310: 3d20 2222 0a20 2020 2020 2020 2066 6f72  = "".        for
+00049320: 206b 2069 6e20 736f 7274 6564 2874 696d   k in sorted(tim
+00049330: 6573 7065 6e74 2e6b 6579 7328 2929 3a0a  espent.keys()):.
+00049340: 2020 2020 2020 2020 2020 2020 7461 736b              task
+00049350: 735f 7469 6d69 6e67 7320 2b3d 2066 225c  s_timings += f"\
+00049360: 6e3c 6c69 3e20 7b6b 7d20 7469 6d65 3a20  n<li> {k} time: 
+00049370: 7b66 6f72 6d61 745f 7469 6d65 2874 696d  {format_time(tim
+00049380: 6573 7065 6e74 5b6b 5d29 7d20 3c2f 6c69  espent[k])} </li
+00049390: 3e22 0a0a 2020 2020 2020 2020 6672 6f6d  >"..        from
+000493a0: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+000493b0: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
+000493c0: 732e 7363 6865 6475 6c65 7220 696d 706f  s.scheduler impo
+000493d0: 7274 2074 6173 6b5f 7374 7265 616d 5f66  rt task_stream_f
+000493e0: 6967 7572 650a 2020 2020 2020 2020 6672  igure.        fr
+000493f0: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
+00049400: 6961 676e 6f73 7469 6373 2e74 6173 6b5f  iagnostics.task_
+00049410: 7374 7265 616d 2069 6d70 6f72 7420 7265  stream import re
+00049420: 6374 616e 676c 6573 0a0a 2020 2020 2020  ctangles..      
+00049430: 2020 7265 6374 7320 3d20 7265 6374 616e    rects = rectan
+00049440: 676c 6573 2874 6173 6b5f 7374 7265 616d  gles(task_stream
+00049450: 290a 2020 2020 2020 2020 736f 7572 6365  ).        source
+00049460: 2c20 7461 736b 5f73 7472 6561 6d20 3d20  , task_stream = 
+00049470: 7461 736b 5f73 7472 6561 6d5f 6669 6775  task_stream_figu
+00049480: 7265 2873 697a 696e 675f 6d6f 6465 3d22  re(sizing_mode="
+00049490: 7374 7265 7463 685f 626f 7468 2229 0a20  stretch_both"). 
+000494a0: 2020 2020 2020 2073 6f75 7263 652e 6461         source.da
+000494b0: 7461 2e75 7064 6174 6528 7265 6374 7329  ta.update(rects)
+000494c0: 0a0a 2020 2020 2020 2020 2320 4261 6e64  ..        # Band
+000494d0: 7769 6474 680a 2020 2020 2020 2020 6672  width.        fr
+000494e0: 6f6d 2064 6973 7472 6962 7574 6564 2e64  om distributed.d
+000494f0: 6173 6862 6f61 7264 2e63 6f6d 706f 6e65  ashboard.compone
+00049500: 6e74 732e 7363 6865 6475 6c65 7220 696d  nts.scheduler im
+00049510: 706f 7274 2028 0a20 2020 2020 2020 2020  port (.         
+00049520: 2020 2042 616e 6477 6964 7468 5479 7065     BandwidthType
+00049530: 732c 0a20 2020 2020 2020 2020 2020 2042  s,.            B
+00049540: 616e 6477 6964 7468 576f 726b 6572 732c  andwidthWorkers,
+00049550: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00049560: 2020 2020 6261 6e64 7769 6474 685f 776f      bandwidth_wo
+00049570: 726b 6572 7320 3d20 4261 6e64 7769 6474  rkers = Bandwidt
+00049580: 6857 6f72 6b65 7273 2873 656c 662c 2073  hWorkers(self, s
+00049590: 697a 696e 675f 6d6f 6465 3d22 7374 7265  izing_mode="stre
+000495a0: 7463 685f 626f 7468 2229 0a20 2020 2020  tch_both").     
+000495b0: 2020 2062 616e 6477 6964 7468 5f77 6f72     bandwidth_wor
+000495c0: 6b65 7273 2e75 7064 6174 6528 290a 2020  kers.update().  
+000495d0: 2020 2020 2020 6261 6e64 7769 6474 685f        bandwidth_
+000495e0: 7479 7065 7320 3d20 4261 6e64 7769 6474  types = Bandwidt
+000495f0: 6854 7970 6573 2873 656c 662c 2073 697a  hTypes(self, siz
+00049600: 696e 675f 6d6f 6465 3d22 7374 7265 7463  ing_mode="stretc
+00049610: 685f 626f 7468 2229 0a20 2020 2020 2020  h_both").       
+00049620: 2062 616e 6477 6964 7468 5f74 7970 6573   bandwidth_types
+00049630: 2e75 7064 6174 6528 290a 0a20 2020 2020  .update()..     
+00049640: 2020 2023 2053 7973 7465 6d20 6d6f 6e69     # System moni
+00049650: 746f 720a 2020 2020 2020 2020 6672 6f6d  tor.        from
+00049660: 2064 6973 7472 6962 7574 6564 2e64 6173   distributed.das
+00049670: 6862 6f61 7264 2e63 6f6d 706f 6e65 6e74  hboard.component
+00049680: 732e 7368 6172 6564 2069 6d70 6f72 7420  s.shared import 
+00049690: 5379 7374 656d 4d6f 6e69 746f 720a 0a20  SystemMonitor.. 
+000496a0: 2020 2020 2020 2073 7973 6d6f 6e20 3d20         sysmon = 
+000496b0: 5379 7374 656d 4d6f 6e69 746f 7228 7365  SystemMonitor(se
+000496c0: 6c66 2c20 6c61 7374 5f63 6f75 6e74 3d6c  lf, last_count=l
+000496d0: 6173 745f 636f 756e 742c 2073 697a 696e  ast_count, sizin
+000496e0: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+000496f0: 626f 7468 2229 0a20 2020 2020 2020 2073  both").        s
+00049700: 7973 6d6f 6e2e 7570 6461 7465 2829 0a0a  ysmon.update()..
+00049710: 2020 2020 2020 2020 2320 5363 6865 6475          # Schedu
+00049720: 6c65 7220 6c6f 6773 0a20 2020 2020 2020  ler logs.       
+00049730: 2066 726f 6d20 6469 7374 7269 6275 7465   from distribute
+00049740: 642e 6461 7368 626f 6172 642e 636f 6d70  d.dashboard.comp
+00049750: 6f6e 656e 7473 2e73 6368 6564 756c 6572  onents.scheduler
+00049760: 2069 6d70 6f72 7420 280a 2020 2020 2020   import (.      
+00049770: 2020 2020 2020 5f42 4f4b 4548 5f53 5459        _BOKEH_STY
+00049780: 4c45 535f 4b57 4152 4753 2c0a 2020 2020  LES_KWARGS,.    
+00049790: 2020 2020 2020 2020 5363 6865 6475 6c65          Schedule
+000497a0: 724c 6f67 732c 0a20 2020 2020 2020 2029  rLogs,.        )
+000497b0: 0a0a 2020 2020 2020 2020 6c6f 6773 203d  ..        logs =
+000497c0: 2053 6368 6564 756c 6572 4c6f 6773 2873   SchedulerLogs(s
+000497d0: 656c 662c 2073 7461 7274 3d73 7461 7274  elf, start=start
+000497e0: 290a 0a20 2020 2020 2020 2066 726f 6d20  )..        from 
+000497f0: 626f 6b65 682e 6d6f 6465 6c73 2069 6d70  bokeh.models imp
+00049800: 6f72 7420 4469 762c 2054 6162 730a 0a20  ort Div, Tabs.. 
+00049810: 2020 2020 2020 2069 6d70 6f72 7420 6469         import di
+00049820: 7374 7269 6275 7465 640a 2020 2020 2020  stributed.      
+00049830: 2020 6672 6f6d 2064 6973 7472 6962 7574    from distribut
+00049840: 6564 2e64 6173 6862 6f61 7264 2e63 6f72  ed.dashboard.cor
+00049850: 6520 696d 706f 7274 2054 6162 5061 6e65  e import TabPane
+00049860: 6c0a 0a20 2020 2020 2020 2023 2048 544d  l..        # HTM
+00049870: 4c0a 2020 2020 2020 2020 6874 6d6c 203d  L.        html =
+00049880: 2022 2222 0a20 2020 2020 2020 203c 6831   """.        <h1
+00049890: 3e20 4461 736b 2050 6572 666f 726d 616e  > Dask Performan
+000498a0: 6365 2052 6570 6f72 7420 3c2f 6831 3e0a  ce Report </h1>.
+000498b0: 0a20 2020 2020 2020 203c 693e 2053 656c  .        <i> Sel
+000498c0: 6563 7420 6469 6666 6572 656e 7420 7461  ect different ta
+000498d0: 6273 206f 6e20 7468 6520 746f 7020 666f  bs on the top fo
+000498e0: 7220 6164 6469 7469 6f6e 616c 2069 6e66  r additional inf
+000498f0: 6f72 6d61 7469 6f6e 203c 2f69 3e0a 0a20  ormation </i>.. 
+00049900: 2020 2020 2020 203c 6832 3e20 4475 7261         <h2> Dura
+00049910: 7469 6f6e 3a20 7b74 696d 657d 203c 2f68  tion: {time} </h
+00049920: 323e 0a20 2020 2020 2020 203c 6832 3e20  2>.        <h2> 
+00049930: 5461 736b 7320 496e 666f 726d 6174 696f  Tasks Informatio
+00049940: 6e20 3c2f 6832 3e0a 2020 2020 2020 2020  n </h2>.        
+00049950: 3c75 6c3e 0a20 2020 2020 2020 2020 3c6c  <ul>.         <l
+00049960: 693e 206e 756d 6265 7220 6f66 2074 6173  i> number of tas
+00049970: 6b73 3a20 7b6e 7461 736b 737d 203c 2f6c  ks: {ntasks} </l
+00049980: 693e 0a20 2020 2020 2020 2020 7b74 6173  i>.         {tas
+00049990: 6b73 5f74 696d 696e 6773 7d0a 2020 2020  ks_timings}.    
+000499a0: 2020 2020 3c2f 756c 3e0a 0a20 2020 2020      </ul>..     
+000499b0: 2020 203c 6832 3e20 5363 6865 6475 6c65     <h2> Schedule
+000499c0: 7220 496e 666f 726d 6174 696f 6e20 3c2f  r Information </
+000499d0: 6832 3e0a 2020 2020 2020 2020 3c75 6c3e  h2>.        <ul>
+000499e0: 0a20 2020 2020 2020 2020 203c 6c69 3e20  .          <li> 
+000499f0: 4164 6472 6573 733a 207b 6164 6472 6573  Address: {addres
+00049a00: 737d 203c 2f6c 693e 0a20 2020 2020 2020  s} </li>.       
+00049a10: 2020 203c 6c69 3e20 576f 726b 6572 733a     <li> Workers:
+00049a20: 207b 6e77 6f72 6b65 7273 7d20 3c2f 6c69   {nworkers} </li
+00049a30: 3e0a 2020 2020 2020 2020 2020 3c6c 693e  >.          <li>
+00049a40: 2054 6872 6561 6473 3a20 7b74 6872 6561   Threads: {threa
+00049a50: 6473 7d20 3c2f 6c69 3e0a 2020 2020 2020  ds} </li>.      
+00049a60: 2020 2020 3c6c 693e 204d 656d 6f72 793a      <li> Memory:
+00049a70: 207b 6d65 6d6f 7279 7d20 3c2f 6c69 3e0a   {memory} </li>.
+00049a80: 2020 2020 2020 2020 2020 3c6c 693e 2044            <li> D
+00049a90: 6173 6b20 5665 7273 696f 6e3a 207b 6461  ask Version: {da
+00049aa0: 736b 5f76 6572 7369 6f6e 7d20 3c2f 6c69  sk_version} </li
+00049ab0: 3e0a 2020 2020 2020 2020 2020 3c6c 693e  >.          <li>
+00049ac0: 2044 6173 6b2e 4469 7374 7269 6275 7465   Dask.Distribute
+00049ad0: 6420 5665 7273 696f 6e3a 207b 6469 7374  d Version: {dist
+00049ae0: 7269 6275 7465 645f 7665 7273 696f 6e7d  ributed_version}
+00049af0: 203c 2f6c 693e 0a20 2020 2020 2020 203c   </li>.        <
+00049b00: 2f75 6c3e 0a0a 2020 2020 2020 2020 3c68  /ul>..        <h
+00049b10: 323e 2043 616c 6c69 6e67 2043 6f64 6520  2> Calling Code 
+00049b20: 3c2f 6832 3e0a 2020 2020 2020 2020 3c70  </h2>.        <p
+00049b30: 7265 3e0a 7b63 6f64 657d 0a20 2020 2020  re>.{code}.     
+00049b40: 2020 203c 2f70 7265 3e0a 2020 2020 2020     </pre>.      
+00049b50: 2020 2222 222e 666f 726d 6174 280a 2020    """.format(.  
+00049b60: 2020 2020 2020 2020 2020 7469 6d65 3d66            time=f
+00049b70: 6f72 6d61 745f 7469 6d65 2873 746f 7020  ormat_time(stop 
+00049b80: 2d20 7374 6172 7429 2c0a 2020 2020 2020  - start),.      
+00049b90: 2020 2020 2020 6e74 6173 6b73 3d74 6f74        ntasks=tot
+00049ba0: 616c 5f74 6173 6b73 2c0a 2020 2020 2020  al_tasks,.      
+00049bb0: 2020 2020 2020 7461 736b 735f 7469 6d69        tasks_timi
+00049bc0: 6e67 733d 7461 736b 735f 7469 6d69 6e67  ngs=tasks_timing
+00049bd0: 732c 0a20 2020 2020 2020 2020 2020 2061  s,.            a
+00049be0: 6464 7265 7373 3d73 656c 662e 6164 6472  ddress=self.addr
+00049bf0: 6573 732c 0a20 2020 2020 2020 2020 2020  ess,.           
+00049c00: 206e 776f 726b 6572 733d 6c65 6e28 7365   nworkers=len(se
+00049c10: 6c66 2e77 6f72 6b65 7273 292c 0a20 2020  lf.workers),.   
+00049c20: 2020 2020 2020 2020 2074 6872 6561 6473           threads
+00049c30: 3d73 756d 2877 732e 6e74 6872 6561 6473  =sum(ws.nthreads
+00049c40: 2066 6f72 2077 7320 696e 2073 656c 662e   for ws in self.
+00049c50: 776f 726b 6572 732e 7661 6c75 6573 2829  workers.values()
+00049c60: 292c 0a20 2020 2020 2020 2020 2020 206d  ),.            m
+00049c70: 656d 6f72 793d 666f 726d 6174 5f62 7974  emory=format_byt
+00049c80: 6573 2873 756d 2877 732e 6d65 6d6f 7279  es(sum(ws.memory
+00049c90: 5f6c 696d 6974 2066 6f72 2077 7320 696e  _limit for ws in
+00049ca0: 2073 656c 662e 776f 726b 6572 732e 7661   self.workers.va
+00049cb0: 6c75 6573 2829 2929 2c0a 2020 2020 2020  lues())),.      
+00049cc0: 2020 2020 2020 636f 6465 3d63 6f64 652c        code=code,
+00049cd0: 0a20 2020 2020 2020 2020 2020 2064 6173  .            das
+00049ce0: 6b5f 7665 7273 696f 6e3d 6461 736b 2e5f  k_version=dask._
+00049cf0: 5f76 6572 7369 6f6e 5f5f 2c0a 2020 2020  _version__,.    
+00049d00: 2020 2020 2020 2020 6469 7374 7269 6275          distribu
+00049d10: 7465 645f 7665 7273 696f 6e3d 6469 7374  ted_version=dist
+00049d20: 7269 6275 7465 642e 5f5f 7665 7273 696f  ributed.__versio
+00049d30: 6e5f 5f2c 0a20 2020 2020 2020 2029 0a20  n__,.        ). 
+00049d40: 2020 2020 2020 2068 746d 6c20 3d20 4469         html = Di
+00049d50: 7628 7465 7874 3d68 746d 6c2c 202a 2a5f  v(text=html, **_
+00049d60: 424f 4b45 485f 5354 594c 4553 5f4b 5741  BOKEH_STYLES_KWA
+00049d70: 5247 5329 0a0a 2020 2020 2020 2020 6874  RGS)..        ht
+00049d80: 6d6c 203d 2054 6162 5061 6e65 6c28 6368  ml = TabPanel(ch
+00049d90: 696c 643d 6874 6d6c 2c20 7469 746c 653d  ild=html, title=
+00049da0: 2253 756d 6d61 7279 2229 0a20 2020 2020  "Summary").     
+00049db0: 2020 2063 6f6d 7075 7465 203d 2054 6162     compute = Tab
+00049dc0: 5061 6e65 6c28 6368 696c 643d 636f 6d70  Panel(child=comp
+00049dd0: 7574 652c 2074 6974 6c65 3d22 576f 726b  ute, title="Work
+00049de0: 6572 2050 726f 6669 6c65 2028 636f 6d70  er Profile (comp
+00049df0: 7574 6529 2229 0a20 2020 2020 2020 2077  ute)").        w
+00049e00: 6f72 6b65 7273 203d 2054 6162 5061 6e65  orkers = TabPane
+00049e10: 6c28 6368 696c 643d 776f 726b 6572 732c  l(child=workers,
+00049e20: 2074 6974 6c65 3d22 576f 726b 6572 2050   title="Worker P
+00049e30: 726f 6669 6c65 2028 6164 6d69 6e69 7374  rofile (administ
+00049e40: 7261 7469 7665 2922 290a 2020 2020 2020  rative)").      
+00049e50: 2020 7363 6865 6475 6c65 7220 3d20 5461    scheduler = Ta
+00049e60: 6250 616e 656c 280a 2020 2020 2020 2020  bPanel(.        
+00049e70: 2020 2020 6368 696c 643d 7363 6865 6475      child=schedu
+00049e80: 6c65 722c 2074 6974 6c65 3d22 5363 6865  ler, title="Sche
+00049e90: 6475 6c65 7220 5072 6f66 696c 6520 2861  duler Profile (a
+00049ea0: 646d 696e 6973 7472 6174 6976 6529 220a  dministrative)".
+00049eb0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+00049ec0: 2020 7461 736b 5f73 7472 6561 6d20 3d20    task_stream = 
+00049ed0: 5461 6250 616e 656c 2863 6869 6c64 3d74  TabPanel(child=t
+00049ee0: 6173 6b5f 7374 7265 616d 2c20 7469 746c  ask_stream, titl
+00049ef0: 653d 2254 6173 6b20 5374 7265 616d 2229  e="Task Stream")
+00049f00: 0a20 2020 2020 2020 2062 616e 6477 6964  .        bandwid
+00049f10: 7468 5f77 6f72 6b65 7273 203d 2054 6162  th_workers = Tab
+00049f20: 5061 6e65 6c28 0a20 2020 2020 2020 2020  Panel(.         
+00049f30: 2020 2063 6869 6c64 3d62 616e 6477 6964     child=bandwid
+00049f40: 7468 5f77 6f72 6b65 7273 2e72 6f6f 742c  th_workers.root,
+00049f50: 2074 6974 6c65 3d22 4261 6e64 7769 6474   title="Bandwidt
+00049f60: 6820 2857 6f72 6b65 7273 2922 0a20 2020  h (Workers)".   
+00049f70: 2020 2020 2029 0a20 2020 2020 2020 2062       ).        b
+00049f80: 616e 6477 6964 7468 5f74 7970 6573 203d  andwidth_types =
+00049f90: 2054 6162 5061 6e65 6c28 0a20 2020 2020   TabPanel(.     
+00049fa0: 2020 2020 2020 2063 6869 6c64 3d62 616e         child=ban
+00049fb0: 6477 6964 7468 5f74 7970 6573 2e72 6f6f  dwidth_types.roo
+00049fc0: 742c 2074 6974 6c65 3d22 4261 6e64 7769  t, title="Bandwi
+00049fd0: 6474 6820 2854 7970 6573 2922 0a20 2020  dth (Types)".   
+00049fe0: 2020 2020 2029 0a20 2020 2020 2020 2073       ).        s
+00049ff0: 7973 7465 6d20 3d20 5461 6250 616e 656c  ystem = TabPanel
+0004a000: 2863 6869 6c64 3d73 7973 6d6f 6e2e 726f  (child=sysmon.ro
+0004a010: 6f74 2c20 7469 746c 653d 2253 7973 7465  ot, title="Syste
+0004a020: 6d22 290a 2020 2020 2020 2020 6c6f 6773  m").        logs
+0004a030: 203d 2054 6162 5061 6e65 6c28 6368 696c   = TabPanel(chil
+0004a040: 643d 6c6f 6773 2e72 6f6f 742c 2074 6974  d=logs.root, tit
+0004a050: 6c65 3d22 5363 6865 6475 6c65 7220 4c6f  le="Scheduler Lo
+0004a060: 6773 2229 0a0a 2020 2020 2020 2020 7461  gs")..        ta
+0004a070: 6273 203d 2054 6162 7328 0a20 2020 2020  bs = Tabs(.     
+0004a080: 2020 2020 2020 2074 6162 733d 5b0a 2020         tabs=[.  
+0004a090: 2020 2020 2020 2020 2020 2020 2020 6874                ht
+0004a0a0: 6d6c 2c0a 2020 2020 2020 2020 2020 2020  ml,.            
+0004a0b0: 2020 2020 7461 736b 5f73 7472 6561 6d2c      task_stream,
+0004a0c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004a0d0: 2073 7973 7465 6d2c 0a20 2020 2020 2020   system,.       
+0004a0e0: 2020 2020 2020 2020 206c 6f67 732c 0a20           logs,. 
+0004a0f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0004a100: 6f6d 7075 7465 2c0a 2020 2020 2020 2020  ompute,.        
+0004a110: 2020 2020 2020 2020 776f 726b 6572 732c          workers,
+0004a120: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004a130: 2073 6368 6564 756c 6572 2c0a 2020 2020   scheduler,.    
+0004a140: 2020 2020 2020 2020 2020 2020 6261 6e64              band
+0004a150: 7769 6474 685f 776f 726b 6572 732c 0a20  width_workers,. 
+0004a160: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0004a170: 616e 6477 6964 7468 5f74 7970 6573 2c0a  andwidth_types,.
+0004a180: 2020 2020 2020 2020 2020 2020 5d2c 0a20              ],. 
+0004a190: 2020 2020 2020 2020 2020 2073 697a 696e             sizin
+0004a1a0: 675f 6d6f 6465 3d22 7374 7265 7463 685f  g_mode="stretch_
+0004a1b0: 626f 7468 222c 0a20 2020 2020 2020 2029  both",.        )
+0004a1c0: 0a0a 2020 2020 2020 2020 6672 6f6d 2062  ..        from b
+0004a1d0: 6f6b 6568 2e63 6f72 652e 7465 6d70 6c61  okeh.core.templa
+0004a1e0: 7465 7320 696d 706f 7274 2067 6574 5f65  tes import get_e
+0004a1f0: 6e76 0a20 2020 2020 2020 2066 726f 6d20  nv.        from 
+0004a200: 626f 6b65 682e 706c 6f74 7469 6e67 2069  bokeh.plotting i
+0004a210: 6d70 6f72 7420 6f75 7470 7574 5f66 696c  mport output_fil
+0004a220: 652c 2073 6176 650a 0a20 2020 2020 2020  e, save..       
+0004a230: 2077 6974 6820 746d 7066 696c 6528 6578   with tmpfile(ex
+0004a240: 7465 6e73 696f 6e3d 222e 6874 6d6c 2229  tension=".html")
+0004a250: 2061 7320 666e 3a0a 2020 2020 2020 2020   as fn:.        
+0004a260: 2020 2020 6f75 7470 7574 5f66 696c 6528      output_file(
+0004a270: 6669 6c65 6e61 6d65 3d66 6e2c 2074 6974  filename=fn, tit
+0004a280: 6c65 3d22 4461 736b 2050 6572 666f 726d  le="Dask Perform
+0004a290: 616e 6365 2052 6570 6f72 7422 2c20 6d6f  ance Report", mo
+0004a2a0: 6465 3d6d 6f64 6529 0a20 2020 2020 2020  de=mode).       
+0004a2b0: 2020 2020 2074 656d 706c 6174 655f 6469       template_di
+0004a2c0: 7265 6374 6f72 7920 3d20 6f73 2e70 6174  rectory = os.pat
+0004a2d0: 682e 6a6f 696e 280a 2020 2020 2020 2020  h.join(.        
+0004a2e0: 2020 2020 2020 2020 6f73 2e70 6174 682e          os.path.
+0004a2f0: 6469 726e 616d 6528 6f73 2e70 6174 682e  dirname(os.path.
+0004a300: 6162 7370 6174 6828 5f5f 6669 6c65 5f5f  abspath(__file__
+0004a310: 2929 2c20 2264 6173 6862 6f61 7264 222c  )), "dashboard",
+0004a320: 2022 7465 6d70 6c61 7465 7322 0a20 2020   "templates".   
+0004a330: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0004a340: 2020 2020 2020 2074 656d 706c 6174 655f         template_
+0004a350: 656e 7669 726f 6e6d 656e 7420 3d20 6765  environment = ge
+0004a360: 745f 656e 7628 290a 2020 2020 2020 2020  t_env().        
+0004a370: 2020 2020 7465 6d70 6c61 7465 5f65 6e76      template_env
+0004a380: 6972 6f6e 6d65 6e74 2e6c 6f61 6465 722e  ironment.loader.
+0004a390: 7365 6172 6368 7061 7468 2e61 7070 656e  searchpath.appen
+0004a3a0: 6428 7465 6d70 6c61 7465 5f64 6972 6563  d(template_direc
+0004a3b0: 746f 7279 290a 2020 2020 2020 2020 2020  tory).          
+0004a3c0: 2020 7465 6d70 6c61 7465 203d 2074 656d    template = tem
+0004a3d0: 706c 6174 655f 656e 7669 726f 6e6d 656e  plate_environmen
+0004a3e0: 742e 6765 745f 7465 6d70 6c61 7465 2822  t.get_template("
+0004a3f0: 7065 7266 6f72 6d61 6e63 655f 7265 706f  performance_repo
+0004a400: 7274 2e68 746d 6c22 290a 2020 2020 2020  rt.html").      
+0004a410: 2020 2020 2020 7361 7665 2874 6162 732c        save(tabs,
+0004a420: 2066 696c 656e 616d 653d 666e 2c20 7465   filename=fn, te
+0004a430: 6d70 6c61 7465 3d74 656d 706c 6174 6529  mplate=template)
+0004a440: 0a0a 2020 2020 2020 2020 2020 2020 7769  ..            wi
+0004a450: 7468 206f 7065 6e28 666e 2920 6173 2066  th open(fn) as f
+0004a460: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004a470: 2020 6461 7461 203d 2066 2e72 6561 6428    data = f.read(
+0004a480: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+0004a490: 6e20 6461 7461 0a0a 2020 2020 6173 796e  n data..    asyn
+0004a4a0: 6320 6465 6620 6765 745f 776f 726b 6572  c def get_worker
+0004a4b0: 5f6c 6f67 7328 7365 6c66 2c20 6e3d 4e6f  _logs(self, n=No
+0004a4c0: 6e65 2c20 776f 726b 6572 733d 4e6f 6e65  ne, workers=None
+0004a4d0: 2c20 6e61 6e6e 793d 4661 6c73 6529 3a0a  , nanny=False):.
+0004a4e0: 2020 2020 2020 2020 7265 7375 6c74 7320          results 
+0004a4f0: 3d20 6177 6169 7420 7365 6c66 2e62 726f  = await self.bro
+0004a500: 6164 6361 7374 280a 2020 2020 2020 2020  adcast(.        
+0004a510: 2020 2020 6d73 673d 7b22 6f70 223a 2022      msg={"op": "
+0004a520: 6765 745f 6c6f 6773 222c 2022 6e22 3a20  get_logs", "n": 
+0004a530: 6e7d 2c20 776f 726b 6572 733d 776f 726b  n}, workers=work
+0004a540: 6572 732c 206e 616e 6e79 3d6e 616e 6e79  ers, nanny=nanny
+0004a550: 0a20 2020 2020 2020 2029 0a20 2020 2020  .        ).     
+0004a560: 2020 2072 6574 7572 6e20 7265 7375 6c74     return result
+0004a570: 730a 0a20 2020 2064 6566 206c 6f67 5f65  s..    def log_e
+0004a580: 7665 6e74 2873 656c 662c 2074 6f70 6963  vent(self, topic
+0004a590: 3a20 7374 7220 7c20 436f 6c6c 6563 7469  : str | Collecti
+0004a5a0: 6f6e 5b73 7472 5d2c 206d 7367 3a20 416e  on[str], msg: An
+0004a5b0: 7929 202d 3e20 4e6f 6e65 3a0a 2020 2020  y) -> None:.    
+0004a5c0: 2020 2020 2222 224c 6f67 2061 6e20 6576      """Log an ev
+0004a5d0: 656e 7420 756e 6465 7220 6120 6769 7665  ent under a give
+0004a5e0: 6e20 746f 7069 630a 0a20 2020 2020 2020  n topic..       
+0004a5f0: 2050 6172 616d 6574 6572 730a 2020 2020   Parameters.    
+0004a600: 2020 2020 2d2d 2d2d 2d2d 2d2d 2d2d 0a20      ----------. 
+0004a610: 2020 2020 2020 2074 6f70 6963 203a 2073         topic : s
+0004a620: 7472 2c20 6c69 7374 5b73 7472 5d0a 2020  tr, list[str].  
+0004a630: 2020 2020 2020 2020 2020 4e61 6d65 206f            Name o
+0004a640: 6620 7468 6520 746f 7069 6320 756e 6465  f the topic unde
+0004a650: 7220 7768 6963 6820 746f 206c 6f67 2061  r which to log a
+0004a660: 6e20 6576 656e 742e 2054 6f20 6c6f 6720  n event. To log 
+0004a670: 7468 6520 7361 6d65 0a20 2020 2020 2020  the same.       
+0004a680: 2020 2020 2065 7665 6e74 2075 6e64 6572       event under
+0004a690: 206d 756c 7469 706c 6520 746f 7069 6373   multiple topics
+0004a6a0: 2c20 7061 7373 2061 206c 6973 7420 6f66  , pass a list of
+0004a6b0: 2074 6f70 6963 206e 616d 6573 2e0a 2020   topic names..  
+0004a6c0: 2020 2020 2020 6d73 670a 2020 2020 2020        msg.      
+0004a6d0: 2020 2020 2020 4576 656e 7420 6d65 7373        Event mess
+0004a6e0: 6167 6520 746f 206c 6f67 2e20 4e6f 7465  age to log. Note
+0004a6f0: 2074 6869 7320 6d75 7374 2062 6520 6d73   this must be ms
+0004a700: 6770 6163 6b20 7365 7269 616c 697a 6162  gpack serializab
+0004a710: 6c65 2e0a 0a20 2020 2020 2020 2053 6565  le...        See
+0004a720: 2061 6c73 6f0a 2020 2020 2020 2020 2d2d   also.        --
+0004a730: 2d2d 2d2d 2d2d 0a20 2020 2020 2020 2043  ------.        C
+0004a740: 6c69 656e 742e 6c6f 675f 6576 656e 740a  lient.log_event.
+0004a750: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0004a760: 2020 2020 6576 656e 7420 3d20 2874 696d      event = (tim
+0004a770: 6528 292c 206d 7367 290a 2020 2020 2020  e(), msg).      
+0004a780: 2020 6966 206e 6f74 2069 7369 6e73 7461    if not isinsta
+0004a790: 6e63 6528 746f 7069 632c 2073 7472 293a  nce(topic, str):
+0004a7a0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0004a7b0: 2074 2069 6e20 746f 7069 633a 0a20 2020   t in topic:.   
+0004a7c0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0004a7d0: 662e 6576 656e 7473 5b74 5d2e 6170 7065  f.events[t].appe
+0004a7e0: 6e64 2865 7665 6e74 290a 2020 2020 2020  nd(event).      
+0004a7f0: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+0004a800: 7665 6e74 5f63 6f75 6e74 735b 745d 202b  vent_counts[t] +
+0004a810: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
+0004a820: 2020 2020 7365 6c66 2e5f 7265 706f 7274      self._report
+0004a830: 5f65 7665 6e74 2874 2c20 6576 656e 7429  _event(t, event)
+0004a840: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0004a850: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0004a860: 6576 656e 7473 5b74 6f70 6963 5d2e 6170  events[topic].ap
+0004a870: 7065 6e64 2865 7665 6e74 290a 2020 2020  pend(event).    
+0004a880: 2020 2020 2020 2020 7365 6c66 2e65 7665          self.eve
+0004a890: 6e74 5f63 6f75 6e74 735b 746f 7069 635d  nt_counts[topic]
+0004a8a0: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+0004a8b0: 2020 7365 6c66 2e5f 7265 706f 7274 5f65    self._report_e
+0004a8c0: 7665 6e74 2874 6f70 6963 2c20 6576 656e  vent(topic, even
+0004a8d0: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
+0004a8e0: 666f 7220 706c 7567 696e 2069 6e20 6c69  for plugin in li
+0004a8f0: 7374 2873 656c 662e 706c 7567 696e 732e  st(self.plugins.
+0004a900: 7661 6c75 6573 2829 293a 0a20 2020 2020  values()):.     
+0004a910: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+0004a920: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004a930: 2020 2020 706c 7567 696e 2e6c 6f67 5f65      plugin.log_e
+0004a940: 7665 6e74 2874 6f70 6963 2c20 6d73 6729  vent(topic, msg)
+0004a950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004a960: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+0004a970: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+0004a980: 2020 2020 2020 206c 6f67 6765 722e 696e         logger.in
+0004a990: 666f 2822 506c 7567 696e 2066 6169 6c65  fo("Plugin faile
+0004a9a0: 6420 7769 7468 2065 7863 6570 7469 6f6e  d with exception
+0004a9b0: 222c 2065 7863 5f69 6e66 6f3d 5472 7565  ", exc_info=True
+0004a9c0: 290a 0a20 2020 2064 6566 205f 7265 706f  )..    def _repo
+0004a9d0: 7274 5f65 7665 6e74 2873 656c 662c 206e  rt_event(self, n
+0004a9e0: 616d 652c 2065 7665 6e74 293a 0a20 2020  ame, event):.   
+0004a9f0: 2020 2020 206d 7367 203d 207b 0a20 2020       msg = {.   
+0004aa00: 2020 2020 2020 2020 2022 6f70 223a 2022           "op": "
+0004aa10: 6576 656e 7422 2c0a 2020 2020 2020 2020  event",.        
+0004aa20: 2020 2020 2274 6f70 6963 223a 206e 616d      "topic": nam
+0004aa30: 652c 0a20 2020 2020 2020 2020 2020 2022  e,.            "
+0004aa40: 6576 656e 7422 3a20 6576 656e 742c 0a20  event": event,. 
+0004aa50: 2020 2020 2020 207d 0a20 2020 2020 2020         }.       
+0004aa60: 2063 6c69 656e 745f 6d73 6773 203d 207b   client_msgs = {
+0004aa70: 636c 6965 6e74 3a20 5b6d 7367 5d20 666f  client: [msg] fo
+0004aa80: 7220 636c 6965 6e74 2069 6e20 7365 6c66  r client in self
+0004aa90: 2e65 7665 6e74 5f73 7562 7363 7269 6265  .event_subscribe
+0004aaa0: 725b 6e61 6d65 5d7d 0a20 2020 2020 2020  r[name]}.       
+0004aab0: 2073 656c 662e 7365 6e64 5f61 6c6c 2863   self.send_all(c
+0004aac0: 6c69 656e 745f 6d73 6773 2c20 776f 726b  lient_msgs, work
+0004aad0: 6572 5f6d 7367 733d 7b7d 290a 0a20 2020  er_msgs={})..   
+0004aae0: 2064 6566 2073 7562 7363 7269 6265 5f74   def subscribe_t
+0004aaf0: 6f70 6963 2873 656c 662c 2074 6f70 6963  opic(self, topic
+0004ab00: 2c20 636c 6965 6e74 293a 0a20 2020 2020  , client):.     
+0004ab10: 2020 2073 656c 662e 6576 656e 745f 7375     self.event_su
+0004ab20: 6273 6372 6962 6572 5b74 6f70 6963 5d2e  bscriber[topic].
+0004ab30: 6164 6428 636c 6965 6e74 290a 0a20 2020  add(client)..   
+0004ab40: 2064 6566 2075 6e73 7562 7363 7269 6265   def unsubscribe
+0004ab50: 5f74 6f70 6963 2873 656c 662c 2074 6f70  _topic(self, top
+0004ab60: 6963 2c20 636c 6965 6e74 293a 0a20 2020  ic, client):.   
+0004ab70: 2020 2020 2073 656c 662e 6576 656e 745f       self.event_
+0004ab80: 7375 6273 6372 6962 6572 5b74 6f70 6963  subscriber[topic
+0004ab90: 5d2e 6469 7363 6172 6428 636c 6965 6e74  ].discard(client
+0004aba0: 290a 0a20 2020 2064 6566 2067 6574 5f65  )..    def get_e
+0004abb0: 7665 6e74 7328 7365 6c66 2c20 746f 7069  vents(self, topi
+0004abc0: 633d 4e6f 6e65 293a 0a20 2020 2020 2020  c=None):.       
+0004abd0: 2069 6620 746f 7069 6320 6973 206e 6f74   if topic is not
+0004abe0: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0004abf0: 2020 2072 6574 7572 6e20 7475 706c 6528     return tuple(
+0004ac00: 7365 6c66 2e65 7665 6e74 735b 746f 7069  self.events[topi
+0004ac10: 635d 290a 2020 2020 2020 2020 656c 7365  c]).        else
+0004ac20: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0004ac30: 7475 726e 2076 616c 6d61 7028 7475 706c  turn valmap(tupl
+0004ac40: 652c 2073 656c 662e 6576 656e 7473 290a  e, self.events).
+0004ac50: 0a20 2020 2061 7379 6e63 2064 6566 2067  .    async def g
+0004ac60: 6574 5f77 6f72 6b65 725f 6d6f 6e69 746f  et_worker_monito
+0004ac70: 725f 696e 666f 2873 656c 662c 2072 6563  r_info(self, rec
+0004ac80: 656e 743d 4661 6c73 652c 2073 7461 7274  ent=False, start
+0004ac90: 733d 4e6f 6e65 293a 0a20 2020 2020 2020  s=None):.       
+0004aca0: 2069 6620 7374 6172 7473 2069 7320 4e6f   if starts is No
+0004acb0: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+0004acc0: 7374 6172 7473 203d 207b 7d0a 2020 2020  starts = {}.    
+0004acd0: 2020 2020 7265 7375 6c74 7320 3d20 6177      results = aw
+0004ace0: 6169 7420 6173 796e 6369 6f2e 6761 7468  ait asyncio.gath
+0004acf0: 6572 280a 2020 2020 2020 2020 2020 2020  er(.            
+0004ad00: 2a28 0a20 2020 2020 2020 2020 2020 2020  *(.             
+0004ad10: 2020 2073 656c 662e 7270 6328 7729 2e67     self.rpc(w).g
+0004ad20: 6574 5f6d 6f6e 6974 6f72 5f69 6e66 6f28  et_monitor_info(
+0004ad30: 7265 6365 6e74 3d72 6563 656e 742c 2073  recent=recent, s
+0004ad40: 7461 7274 3d73 7461 7274 732e 6765 7428  tart=starts.get(
+0004ad50: 772c 2030 2929 0a20 2020 2020 2020 2020  w, 0)).         
+0004ad60: 2020 2020 2020 2066 6f72 2077 2069 6e20         for w in 
+0004ad70: 7365 6c66 2e77 6f72 6b65 7273 0a20 2020  self.workers.   
+0004ad80: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+0004ad90: 2020 2029 0a20 2020 2020 2020 2072 6574     ).        ret
+0004ada0: 7572 6e20 6469 6374 287a 6970 2873 656c  urn dict(zip(sel
+0004adb0: 662e 776f 726b 6572 732c 2072 6573 756c  f.workers, resul
+0004adc0: 7473 2929 0a0a 2020 2020 2323 2323 2323  ts))..    ######
+0004add0: 2323 2323 230a 2020 2020 2320 436c 6561  #####.    # Clea
+0004ade0: 6e75 7020 230a 2020 2020 2323 2323 2323  nup #.    ######
+0004adf0: 2323 2323 230a 0a20 2020 2061 7379 6e63  #####..    async
+0004ae00: 2064 6566 2063 6865 636b 5f77 6f72 6b65   def check_worke
+0004ae10: 725f 7474 6c28 7365 6c66 293a 0a20 2020  r_ttl(self):.   
+0004ae20: 2020 2020 206e 6f77 203d 2074 696d 6528       now = time(
+0004ae30: 290a 2020 2020 2020 2020 7374 696d 756c  ).        stimul
+0004ae40: 7573 5f69 6420 3d20 6622 6368 6563 6b2d  us_id = f"check-
+0004ae50: 776f 726b 6572 2d74 746c 2d7b 6e6f 777d  worker-ttl-{now}
+0004ae60: 220a 2020 2020 2020 2020 666f 7220 7773  ".        for ws
+0004ae70: 2069 6e20 7365 6c66 2e77 6f72 6b65 7273   in self.workers
+0004ae80: 2e76 616c 7565 7328 293a 0a20 2020 2020  .values():.     
+0004ae90: 2020 2020 2020 2069 6620 2877 732e 6c61         if (ws.la
+0004aea0: 7374 5f73 6565 6e20 3c20 6e6f 7720 2d20  st_seen < now - 
+0004aeb0: 7365 6c66 2e77 6f72 6b65 725f 7474 6c29  self.worker_ttl)
+0004aec0: 2061 6e64 2028 0a20 2020 2020 2020 2020   and (.         
+0004aed0: 2020 2020 2020 2077 732e 6c61 7374 5f73         ws.last_s
+0004aee0: 6565 6e20 3c20 6e6f 7720 2d20 3130 202a  een < now - 10 *
+0004aef0: 2068 6561 7274 6265 6174 5f69 6e74 6572   heartbeat_inter
+0004af00: 7661 6c28 6c65 6e28 7365 6c66 2e77 6f72  val(len(self.wor
+0004af10: 6b65 7273 2929 0a20 2020 2020 2020 2020  kers)).         
+0004af20: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+0004af30: 2020 2020 2020 6c6f 6767 6572 2e77 6172        logger.war
+0004af40: 6e69 6e67 280a 2020 2020 2020 2020 2020  ning(.          
+0004af50: 2020 2020 2020 2020 2020 2257 6f72 6b65            "Worke
+0004af60: 7220 6661 696c 6564 2074 6f20 6865 6172  r failed to hear
+0004af70: 7462 6561 7420 7769 7468 696e 2025 7320  tbeat within %s 
+0004af80: 7365 636f 6e64 732e 2043 6c6f 7369 6e67  seconds. Closing
+0004af90: 3a20 2573 222c 0a20 2020 2020 2020 2020  : %s",.         
+0004afa0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0004afb0: 776f 726b 6572 5f74 746c 2c0a 2020 2020  worker_ttl,.    
+0004afc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004afd0: 7773 2c0a 2020 2020 2020 2020 2020 2020  ws,.            
+0004afe0: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0004aff0: 2020 2020 2020 6177 6169 7420 7365 6c66        await self
+0004b000: 2e72 656d 6f76 655f 776f 726b 6572 2861  .remove_worker(a
+0004b010: 6464 7265 7373 3d77 732e 6164 6472 6573  ddress=ws.addres
+0004b020: 732c 2073 7469 6d75 6c75 735f 6964 3d73  s, stimulus_id=s
+0004b030: 7469 6d75 6c75 735f 6964 290a 0a20 2020  timulus_id)..   
+0004b040: 2064 6566 2063 6865 636b 5f69 646c 6528   def check_idle(
+0004b050: 7365 6c66 2920 2d3e 2066 6c6f 6174 207c  self) -> float |
+0004b060: 204e 6f6e 653a 0a20 2020 2020 2020 2069   None:.        i
+0004b070: 6620 7365 6c66 2e73 7461 7475 7320 696e  f self.status in
+0004b080: 2028 5374 6174 7573 2e63 6c6f 7369 6e67   (Status.closing
+0004b090: 2c20 5374 6174 7573 2e63 6c6f 7365 6429  , Status.closed)
+0004b0a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0004b0b0: 7475 726e 204e 6f6e 6520 2023 2070 7261  turn None  # pra
+0004b0c0: 676d 613a 206e 6f63 6f76 6572 0a0a 2020  gma: nocover..  
+0004b0d0: 2020 2020 2020 6966 2073 656c 662e 7472        if self.tr
+0004b0e0: 616e 7369 7469 6f6e 5f63 6f75 6e74 6572  ansition_counter
+0004b0f0: 2021 3d20 7365 6c66 2e5f 6964 6c65 5f74   != self._idle_t
+0004b100: 7261 6e73 6974 696f 6e5f 636f 756e 7465  ransition_counte
+0004b110: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
+0004b120: 656c 662e 5f69 646c 655f 7472 616e 7369  elf._idle_transi
+0004b130: 7469 6f6e 5f63 6f75 6e74 6572 203d 2073  tion_counter = s
+0004b140: 656c 662e 7472 616e 7369 7469 6f6e 5f63  elf.transition_c
+0004b150: 6f75 6e74 6572 0a20 2020 2020 2020 2020  ounter.         
+0004b160: 2020 2073 656c 662e 6964 6c65 5f73 696e     self.idle_sin
+0004b170: 6365 203d 204e 6f6e 650a 2020 2020 2020  ce = None.      
+0004b180: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
+0004b190: 650a 0a20 2020 2020 2020 2069 6620 280a  e..        if (.
+0004b1a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0004b1b0: 2e71 7565 7565 640a 2020 2020 2020 2020  .queued.        
+0004b1c0: 2020 2020 6f72 2073 656c 662e 756e 7275      or self.unru
+0004b1d0: 6e6e 6162 6c65 0a20 2020 2020 2020 2020  nnable.         
+0004b1e0: 2020 206f 7220 616e 7928 7773 2e70 726f     or any(ws.pro
+0004b1f0: 6365 7373 696e 6720 666f 7220 7773 2069  cessing for ws i
+0004b200: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
+0004b210: 616c 7565 7328 2929 0a20 2020 2020 2020  alues()).       
+0004b220: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+0004b230: 7365 6c66 2e69 646c 655f 7369 6e63 6520  self.idle_since 
+0004b240: 3d20 4e6f 6e65 0a20 2020 2020 2020 2020  = None.         
+0004b250: 2020 2072 6574 7572 6e20 4e6f 6e65 0a0a     return None..
+0004b260: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+0004b270: 656c 662e 6964 6c65 5f73 696e 6365 3a0a  elf.idle_since:.
+0004b280: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0004b290: 2e69 646c 655f 7369 6e63 6520 3d20 7469  .idle_since = ti
+0004b2a0: 6d65 2829 0a20 2020 2020 2020 2020 2020  me().           
+0004b2b0: 2072 6574 7572 6e20 7365 6c66 2e69 646c   return self.idl
+0004b2c0: 655f 7369 6e63 650a 0a20 2020 2020 2020  e_since..       
+0004b2d0: 2069 6620 7365 6c66 2e6a 7570 7974 6572   if self.jupyter
+0004b2e0: 3a0a 2020 2020 2020 2020 2020 2020 6c61  :.            la
+0004b2f0: 7374 5f61 6374 6976 6974 7920 3d20 280a  st_activity = (.
+0004b300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004b310: 7365 6c66 2e5f 6a75 7079 7465 725f 7365  self._jupyter_se
+0004b320: 7276 6572 5f61 7070 6c69 6361 7469 6f6e  rver_application
+0004b330: 2e77 6562 5f61 7070 2e6c 6173 745f 6163  .web_app.last_ac
+0004b340: 7469 7669 7479 2829 2e74 696d 6573 7461  tivity().timesta
+0004b350: 6d70 2829 0a20 2020 2020 2020 2020 2020  mp().           
+0004b360: 2029 0a20 2020 2020 2020 2020 2020 2069   ).            i
+0004b370: 6620 6c61 7374 5f61 6374 6976 6974 7920  f last_activity 
+0004b380: 3e20 7365 6c66 2e69 646c 655f 7369 6e63  > self.idle_sinc
+0004b390: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0004b3a0: 2020 2073 656c 662e 6964 6c65 5f73 696e     self.idle_sin
+0004b3b0: 6365 203d 206c 6173 745f 6163 7469 7669  ce = last_activi
+0004b3c0: 7479 0a20 2020 2020 2020 2020 2020 2020  ty.             
+0004b3d0: 2020 2072 6574 7572 6e20 7365 6c66 2e69     return self.i
+0004b3e0: 646c 655f 7369 6e63 650a 0a20 2020 2020  dle_since..     
+0004b3f0: 2020 2069 6620 7365 6c66 2e69 646c 655f     if self.idle_
+0004b400: 7469 6d65 6f75 743a 0a20 2020 2020 2020  timeout:.       
+0004b410: 2020 2020 2069 6620 7469 6d65 2829 203e       if time() >
+0004b420: 2073 656c 662e 6964 6c65 5f73 696e 6365   self.idle_since
+0004b430: 202b 2073 656c 662e 6964 6c65 5f74 696d   + self.idle_tim
+0004b440: 656f 7574 3a0a 2020 2020 2020 2020 2020  eout:.          
+0004b450: 2020 2020 2020 6173 7365 7274 2073 656c        assert sel
+0004b460: 662e 6964 6c65 5f73 696e 6365 0a20 2020  f.idle_since.   
+0004b470: 2020 2020 2020 2020 2020 2020 206c 6f67               log
+0004b480: 6765 722e 696e 666f 280a 2020 2020 2020  ger.info(.      
+0004b490: 2020 2020 2020 2020 2020 2020 2020 2253                "S
+0004b4a0: 6368 6564 756c 6572 2063 6c6f 7369 6e67  cheduler closing
+0004b4b0: 2061 6674 6572 2062 6569 6e67 2069 646c   after being idl
+0004b4c0: 6520 666f 7220 2573 222c 0a20 2020 2020  e for %s",.     
+0004b4d0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0004b4e0: 6f72 6d61 745f 7469 6d65 2873 656c 662e  ormat_time(self.
+0004b4f0: 6964 6c65 5f74 696d 656f 7574 292c 0a20  idle_timeout),. 
+0004b500: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+0004b510: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004b520: 2073 656c 662e 5f6f 6e67 6f69 6e67 5f62   self._ongoing_b
+0004b530: 6163 6b67 726f 756e 645f 7461 736b 732e  ackground_tasks.
+0004b540: 6361 6c6c 5f73 6f6f 6e28 7365 6c66 2e63  call_soon(self.c
+0004b550: 6c6f 7365 290a 2020 2020 2020 2020 7265  lose).        re
+0004b560: 7475 726e 2073 656c 662e 6964 6c65 5f73  turn self.idle_s
+0004b570: 696e 6365 0a0a 2020 2020 6465 6620 5f63  ince..    def _c
+0004b580: 6865 636b 5f6e 6f5f 776f 726b 6572 7328  heck_no_workers(
+0004b590: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
+0004b5a0: 2020 2020 2020 2022 2222 5368 7574 2064         """Shut d
+0004b5b0: 6f77 6e20 7468 6520 7363 6865 6475 6c65  own the schedule
+0004b5c0: 7220 6966 2074 6865 7265 2068 6176 6520  r if there have 
+0004b5d0: 6265 656e 2074 6173 6b73 2072 6561 6479  been tasks ready
+0004b5e0: 2074 6f20 7275 6e20 7768 6963 6820 6861   to run which ha
+0004b5f0: 7665 0a20 2020 2020 2020 206e 6f77 6865  ve.        nowhe
+0004b600: 7265 2074 6f20 7275 6e20 666f 7220 6064  re to run for `d
+0004b610: 6973 7472 6962 7574 6564 2e73 6368 6564  istributed.sched
+0004b620: 756c 6572 2e6e 6f2d 776f 726b 6572 732d  uler.no-workers-
+0004b630: 7469 6d65 6f75 7460 2c20 616e 6420 7468  timeout`, and th
+0004b640: 6572 650a 2020 2020 2020 2020 6172 656e  ere.        aren
+0004b650: 2774 206f 7468 6572 2074 6173 6b73 2072  't other tasks r
+0004b660: 756e 6e69 6e67 2e0a 2020 2020 2020 2020  unning..        
+0004b670: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
+0004b680: 656c 662e 7374 6174 7573 2069 6e20 2853  elf.status in (S
+0004b690: 7461 7475 732e 636c 6f73 696e 672c 2053  tatus.closing, S
+0004b6a0: 7461 7475 732e 636c 6f73 6564 293a 0a20  tatus.closed):. 
+0004b6b0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0004b6c0: 6e20 2023 2070 7261 676d 613a 206e 6f63  n  # pragma: noc
+0004b6d0: 6f76 6572 0a0a 2020 2020 2020 2020 6966  over..        if
+0004b6e0: 2028 0a20 2020 2020 2020 2020 2020 2028   (.            (
+0004b6f0: 6e6f 7420 7365 6c66 2e71 7565 7565 6420  not self.queued 
+0004b700: 616e 6420 6e6f 7420 7365 6c66 2e75 6e72  and not self.unr
+0004b710: 756e 6e61 626c 6529 0a20 2020 2020 2020  unnable).       
+0004b720: 2020 2020 206f 7220 2873 656c 662e 7175       or (self.qu
+0004b730: 6575 6564 2061 6e64 2073 656c 662e 776f  eued and self.wo
+0004b740: 726b 6572 7329 0a20 2020 2020 2020 2020  rkers).         
+0004b750: 2020 206f 7220 616e 7928 7773 2e70 726f     or any(ws.pro
+0004b760: 6365 7373 696e 6720 666f 7220 7773 2069  cessing for ws i
+0004b770: 6e20 7365 6c66 2e77 6f72 6b65 7273 2e76  n self.workers.v
+0004b780: 616c 7565 7328 2929 0a20 2020 2020 2020  alues()).       
+0004b790: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
+0004b7a0: 7365 6c66 2e5f 6e6f 5f77 6f72 6b65 7273  self._no_workers
+0004b7b0: 5f73 696e 6365 203d 204e 6f6e 650a 2020  _since = None.  
+0004b7c0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0004b7d0: 0a0a 2020 2020 2020 2020 2320 312e 2054  ..        # 1. T
+0004b7e0: 6865 7265 2061 7265 2071 7565 7565 6420  here are queued 
+0004b7f0: 6f72 2075 6e72 756e 6e61 626c 6520 7461  or unrunnable ta
+0004b800: 736b 7320 616e 6420 6e6f 2077 6f72 6b65  sks and no worke
+0004b810: 7273 2061 7420 616c 6c0a 2020 2020 2020  rs at all.      
+0004b820: 2020 2320 322e 2054 6865 7265 2061 7265    # 2. There are
+0004b830: 2075 6e72 756e 6e61 626c 6520 7461 736b   unrunnable task
+0004b840: 7320 616e 6420 6e6f 2077 6f72 6b65 7273  s and no workers
+0004b850: 2073 6174 6973 6679 2074 6865 6972 2072   satisfy their r
+0004b860: 6573 7472 6963 7469 6f6e 730a 2020 2020  estrictions.    
+0004b870: 2020 2020 2320 284f 6e6c 7920 726f 6f74      # (Only root
+0004b880: 6973 6820 7461 736b 7320 6361 6e20 6265  ish tasks can be
+0004b890: 2071 7565 7565 642c 2061 6e64 2072 6f6f   queued, and roo
+0004b8a0: 7469 7368 2074 6173 6b73 2063 616e 2774  tish tasks can't
+0004b8b0: 2068 6176 6520 7265 7374 7269 6374 696f   have restrictio
+0004b8c0: 6e73 290a 0a20 2020 2020 2020 2069 6620  ns)..        if 
+0004b8d0: 6e6f 7420 7365 6c66 2e5f 6e6f 5f77 6f72  not self._no_wor
+0004b8e0: 6b65 7273 5f73 696e 6365 3a0a 2020 2020  kers_since:.    
+0004b8f0: 2020 2020 2020 2020 7365 6c66 2e5f 6e6f          self._no
+0004b900: 5f77 6f72 6b65 7273 5f73 696e 6365 203d  _workers_since =
+0004b910: 2074 696d 6528 290a 2020 2020 2020 2020   time().        
+0004b920: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
+0004b930: 2020 2020 6966 2028 0a20 2020 2020 2020      if (.       
+0004b940: 2020 2020 2073 656c 662e 6e6f 5f77 6f72       self.no_wor
+0004b950: 6b65 7273 5f74 696d 656f 7574 0a20 2020  kers_timeout.   
+0004b960: 2020 2020 2020 2020 2061 6e64 2074 696d           and tim
+0004b970: 6528 2920 3e20 7365 6c66 2e5f 6e6f 5f77  e() > self._no_w
+0004b980: 6f72 6b65 7273 5f73 696e 6365 202b 2073  orkers_since + s
+0004b990: 656c 662e 6e6f 5f77 6f72 6b65 7273 5f74  elf.no_workers_t
+0004b9a0: 696d 656f 7574 0a20 2020 2020 2020 2029  imeout.        )
+0004b9b0: 3a0a 2020 2020 2020 2020 2020 2020 6c6f  :.            lo
+0004b9c0: 6767 6572 2e69 6e66 6f28 0a20 2020 2020  gger.info(.     
+0004b9d0: 2020 2020 2020 2020 2020 2022 5461 736b             "Task
+0004b9e0: 7320 6861 7665 2062 6565 6e20 7769 7468  s have been with
+0004b9f0: 6f75 7420 616e 7920 776f 726b 6572 7320  out any workers 
+0004ba00: 746f 2072 756e 2074 6865 6d20 666f 7220  to run them for 
+0004ba10: 2573 3b20 220a 2020 2020 2020 2020 2020  %s; ".          
+0004ba20: 2020 2020 2020 2273 6875 7474 696e 6720        "shutting 
+0004ba30: 7363 6865 6475 6c65 7220 646f 776e 222c  scheduler down",
+0004ba40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004ba50: 2066 6f72 6d61 745f 7469 6d65 2873 656c   format_time(sel
+0004ba60: 662e 6e6f 5f77 6f72 6b65 7273 5f74 696d  f.no_workers_tim
+0004ba70: 656f 7574 292c 0a20 2020 2020 2020 2020  eout),.         
+0004ba80: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+0004ba90: 2073 656c 662e 5f6f 6e67 6f69 6e67 5f62   self._ongoing_b
+0004baa0: 6163 6b67 726f 756e 645f 7461 736b 732e  ackground_tasks.
+0004bab0: 6361 6c6c 5f73 6f6f 6e28 7365 6c66 2e63  call_soon(self.c
+0004bac0: 6c6f 7365 290a 0a20 2020 2064 6566 2061  lose)..    def a
+0004bad0: 6461 7074 6976 655f 7461 7267 6574 2873  daptive_target(s
+0004bae0: 656c 662c 2074 6172 6765 745f 6475 7261  elf, target_dura
+0004baf0: 7469 6f6e 3d4e 6f6e 6529 3a0a 2020 2020  tion=None):.    
+0004bb00: 2020 2020 2222 2244 6573 6972 6564 206e      """Desired n
+0004bb10: 756d 6265 7220 6f66 2077 6f72 6b65 7273  umber of workers
+0004bb20: 2062 6173 6564 206f 6e20 7468 6520 6375   based on the cu
+0004bb30: 7272 656e 7420 776f 726b 6c6f 6164 0a0a  rrent workload..
+0004bb40: 2020 2020 2020 2020 5468 6973 206c 6f6f          This loo
+0004bb50: 6b73 2061 7420 7468 6520 6375 7272 656e  ks at the curren
+0004bb60: 7420 7275 6e6e 696e 6720 7461 736b 7320  t running tasks 
+0004bb70: 616e 6420 6d65 6d6f 7279 2075 7365 2c20  and memory use, 
+0004bb80: 616e 6420 7265 7475 726e 7320 610a 2020  and returns a.  
+0004bb90: 2020 2020 2020 6e75 6d62 6572 206f 6620        number of 
+0004bba0: 6465 7369 7265 6420 776f 726b 6572 732e  desired workers.
+0004bbb0: 2020 5468 6973 2069 7320 6f66 7465 6e20    This is often 
+0004bbc0: 7573 6564 2062 7920 6164 6170 7469 7665  used by adaptive
+0004bbd0: 2073 6368 6564 756c 696e 672e 0a0a 2020   scheduling...  
+0004bbe0: 2020 2020 2020 5061 7261 6d65 7465 7273        Parameters
+0004bbf0: 0a20 2020 2020 2020 202d 2d2d 2d2d 2d2d  .        -------
+0004bc00: 2d2d 2d0a 2020 2020 2020 2020 7461 7267  ---.        targ
+0004bc10: 6574 5f64 7572 6174 696f 6e20 3a20 7374  et_duration : st
+0004bc20: 720a 2020 2020 2020 2020 2020 2020 4120  r.            A 
+0004bc30: 6465 7369 7265 6420 6475 7261 7469 6f6e  desired duration
+0004bc40: 206f 6620 7469 6d65 2066 6f72 2063 6f6d   of time for com
+0004bc50: 7075 7461 7469 6f6e 7320 746f 2074 616b  putations to tak
+0004bc60: 652e 2020 5468 6973 2061 6666 6563 7473  e.  This affects
+0004bc70: 0a20 2020 2020 2020 2020 2020 2068 6f77  .            how
+0004bc80: 2072 6170 6964 6c79 2074 6865 2073 6368   rapidly the sch
+0004bc90: 6564 756c 6572 2077 696c 6c20 6173 6b20  eduler will ask 
+0004bca0: 746f 2073 6361 6c65 2e0a 0a20 2020 2020  to scale...     
+0004bcb0: 2020 2053 6565 2041 6c73 6f0a 2020 2020     See Also.    
+0004bcc0: 2020 2020 2d2d 2d2d 2d2d 2d2d 0a20 2020      --------.   
+0004bcd0: 2020 2020 2064 6973 7472 6962 7574 6564       distributed
+0004bce0: 2e64 6570 6c6f 792e 4164 6170 7469 7665  .deploy.Adaptive
+0004bcf0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0004bd00: 2020 2020 2069 6620 7461 7267 6574 5f64       if target_d
+0004bd10: 7572 6174 696f 6e20 6973 204e 6f6e 653a  uration is None:
+0004bd20: 0a20 2020 2020 2020 2020 2020 2074 6172  .            tar
+0004bd30: 6765 745f 6475 7261 7469 6f6e 203d 2064  get_duration = d
+0004bd40: 6173 6b2e 636f 6e66 6967 2e67 6574 2822  ask.config.get("
+0004bd50: 6469 7374 7269 6275 7465 642e 6164 6170  distributed.adap
+0004bd60: 7469 7665 2e74 6172 6765 742d 6475 7261  tive.target-dura
+0004bd70: 7469 6f6e 2229 0a20 2020 2020 2020 2074  tion").        t
+0004bd80: 6172 6765 745f 6475 7261 7469 6f6e 203d  arget_duration =
+0004bd90: 2070 6172 7365 5f74 696d 6564 656c 7461   parse_timedelta
+0004bda0: 2874 6172 6765 745f 6475 7261 7469 6f6e  (target_duration
+0004bdb0: 290a 0a20 2020 2020 2020 2023 2043 5055  )..        # CPU
+0004bdc0: 0a20 2020 2020 2020 2071 7565 7565 6420  .        queued 
+0004bdd0: 3d20 7461 6b65 2831 3030 2c20 636f 6e63  = take(100, conc
+0004bde0: 6174 285b 7365 6c66 2e71 7565 7565 642c  at([self.queued,
+0004bdf0: 2073 656c 662e 756e 7275 6e6e 6162 6c65   self.unrunnable
+0004be00: 5d29 290a 2020 2020 2020 2020 7175 6575  ])).        queu
+0004be10: 6564 5f6f 6363 7570 616e 6379 203d 2030  ed_occupancy = 0
+0004be20: 0a20 2020 2020 2020 2066 6f72 2074 7320  .        for ts 
+0004be30: 696e 2071 7565 7565 643a 0a20 2020 2020  in queued:.     
+0004be40: 2020 2020 2020 2069 6620 7473 2e70 7265         if ts.pre
+0004be50: 6669 782e 6475 7261 7469 6f6e 5f61 7665  fix.duration_ave
+0004be60: 7261 6765 203d 3d20 2d31 3a0a 2020 2020  rage == -1:.    
+0004be70: 2020 2020 2020 2020 2020 2020 7175 6575              queu
+0004be80: 6564 5f6f 6363 7570 616e 6379 202b 3d20  ed_occupancy += 
+0004be90: 7365 6c66 2e55 4e4b 4e4f 574e 5f54 4153  self.UNKNOWN_TAS
+0004bea0: 4b5f 4455 5241 5449 4f4e 0a20 2020 2020  K_DURATION.     
+0004beb0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0004bec0: 2020 2020 2020 2020 2020 2020 2071 7565               que
+0004bed0: 7565 645f 6f63 6375 7061 6e63 7920 2b3d  ued_occupancy +=
+0004bee0: 2074 732e 7072 6566 6978 2e64 7572 6174   ts.prefix.durat
+0004bef0: 696f 6e5f 6176 6572 6167 650a 0a20 2020  ion_average..   
+0004bf00: 2020 2020 2074 6173 6b73 5f72 6561 6479       tasks_ready
+0004bf10: 203d 206c 656e 2873 656c 662e 7175 6575   = len(self.queu
+0004bf20: 6564 2920 2b20 6c65 6e28 7365 6c66 2e75  ed) + len(self.u
+0004bf30: 6e72 756e 6e61 626c 6529 0a20 2020 2020  nrunnable).     
+0004bf40: 2020 2069 6620 7461 736b 735f 7265 6164     if tasks_read
+0004bf50: 7920 3e20 3130 303a 0a20 2020 2020 2020  y > 100:.       
+0004bf60: 2020 2020 2071 7565 7565 645f 6f63 6375       queued_occu
+0004bf70: 7061 6e63 7920 2a3d 2074 6173 6b73 5f72  pancy *= tasks_r
+0004bf80: 6561 6479 202f 2031 3030 0a0a 2020 2020  eady / 100..    
+0004bf90: 2020 2020 6370 7520 3d20 6d61 7468 2e63      cpu = math.c
+0004bfa0: 6569 6c28 2873 656c 662e 746f 7461 6c5f  eil((self.total_
+0004bfb0: 6f63 6375 7061 6e63 7920 2b20 7175 6575  occupancy + queu
+0004bfc0: 6564 5f6f 6363 7570 616e 6379 2920 2f20  ed_occupancy) / 
+0004bfd0: 7461 7267 6574 5f64 7572 6174 696f 6e29  target_duration)
+0004bfe0: 0a0a 2020 2020 2020 2020 2320 4176 6f69  ..        # Avoi
+0004bff0: 6420 6120 6665 7720 6c6f 6e67 2074 6173  d a few long tas
+0004c000: 6b73 2066 726f 6d20 6173 6b69 6e67 2066  ks from asking f
+0004c010: 6f72 206d 616e 7920 636f 7265 730a 2020  or many cores.  
+0004c020: 2020 2020 2020 666f 7220 7773 2069 6e20        for ws in 
+0004c030: 7365 6c66 2e77 6f72 6b65 7273 2e76 616c  self.workers.val
+0004c040: 7565 7328 293a 0a20 2020 2020 2020 2020  ues():.         
+0004c050: 2020 2069 6620 7461 736b 735f 7265 6164     if tasks_read
+0004c060: 7920 3e20 6370 753a 0a20 2020 2020 2020  y > cpu:.       
+0004c070: 2020 2020 2020 2020 2062 7265 616b 0a20           break. 
+0004c080: 2020 2020 2020 2020 2020 2074 6173 6b73             tasks
+0004c090: 5f72 6561 6479 202b 3d20 6c65 6e28 7773  _ready += len(ws
+0004c0a0: 2e70 726f 6365 7373 696e 6729 0a20 2020  .processing).   
+0004c0b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0004c0c0: 2020 2020 2020 2063 7075 203d 206d 696e         cpu = min
+0004c0d0: 2874 6173 6b73 5f72 6561 6479 2c20 6370  (tasks_ready, cp
+0004c0e0: 7529 0a0a 2020 2020 2020 2020 2320 4469  u)..        # Di
+0004c0f0: 7669 6465 2062 7920 6176 6572 6167 6520  vide by average 
+0004c100: 6e74 6872 6561 6473 2070 6572 2077 6f72  nthreads per wor
+0004c110: 6b65 720a 2020 2020 2020 2020 6966 2073  ker.        if s
+0004c120: 656c 662e 776f 726b 6572 733a 0a20 2020  elf.workers:.   
+0004c130: 2020 2020 2020 2020 206e 7468 7265 6164           nthread
+0004c140: 7320 3d20 7375 6d28 7773 2e6e 7468 7265  s = sum(ws.nthre
+0004c150: 6164 7320 666f 7220 7773 2069 6e20 7365  ads for ws in se
+0004c160: 6c66 2e77 6f72 6b65 7273 2e76 616c 7565  lf.workers.value
+0004c170: 7328 2929 0a20 2020 2020 2020 2020 2020  s()).           
+0004c180: 2063 7075 203d 206d 6174 682e 6365 696c   cpu = math.ceil
+0004c190: 2863 7075 202f 206e 7468 7265 6164 7320  (cpu / nthreads 
+0004c1a0: 2a20 6c65 6e28 7365 6c66 2e77 6f72 6b65  * len(self.worke
+0004c1b0: 7273 2929 0a0a 2020 2020 2020 2020 6966  rs))..        if
+0004c1c0: 2028 7365 6c66 2e75 6e72 756e 6e61 626c   (self.unrunnabl
+0004c1d0: 6520 6f72 2073 656c 662e 7175 6575 6564  e or self.queued
+0004c1e0: 2920 616e 6420 6e6f 7420 7365 6c66 2e77  ) and not self.w
+0004c1f0: 6f72 6b65 7273 3a0a 2020 2020 2020 2020  orkers:.        
+0004c200: 2020 2020 6370 7520 3d20 6d61 7828 312c      cpu = max(1,
+0004c210: 2063 7075 290a 0a20 2020 2020 2020 2023   cpu)..        #
+0004c220: 2061 6464 206d 6f72 6520 776f 726b 6572   add more worker
+0004c230: 7320 6966 206d 6f72 6520 7468 616e 2036  s if more than 6
+0004c240: 3025 206f 6620 6d65 6d6f 7279 2069 7320  0% of memory is 
+0004c250: 7573 6564 0a20 2020 2020 2020 206c 696d  used.        lim
+0004c260: 6974 203d 2073 756d 2877 732e 6d65 6d6f  it = sum(ws.memo
+0004c270: 7279 5f6c 696d 6974 2066 6f72 2077 7320  ry_limit for ws 
+0004c280: 696e 2073 656c 662e 776f 726b 6572 732e  in self.workers.
+0004c290: 7661 6c75 6573 2829 290a 2020 2020 2020  values()).      
+0004c2a0: 2020 7573 6564 203d 2073 756d 2877 732e    used = sum(ws.
+0004c2b0: 6e62 7974 6573 2066 6f72 2077 7320 696e  nbytes for ws in
+0004c2c0: 2073 656c 662e 776f 726b 6572 732e 7661   self.workers.va
+0004c2d0: 6c75 6573 2829 290a 2020 2020 2020 2020  lues()).        
+0004c2e0: 6d65 6d6f 7279 203d 2030 0a20 2020 2020  memory = 0.     
+0004c2f0: 2020 2069 6620 7573 6564 203e 2030 2e36     if used > 0.6
+0004c300: 202a 206c 696d 6974 2061 6e64 206c 696d   * limit and lim
+0004c310: 6974 203e 2030 3a0a 2020 2020 2020 2020  it > 0:.        
+0004c320: 2020 2020 6d65 6d6f 7279 203d 2032 202a      memory = 2 *
+0004c330: 206c 656e 2873 656c 662e 776f 726b 6572   len(self.worker
+0004c340: 7329 0a0a 2020 2020 2020 2020 7461 7267  s)..        targ
+0004c350: 6574 203d 206d 6178 286d 656d 6f72 792c  et = max(memory,
+0004c360: 2063 7075 290a 2020 2020 2020 2020 6966   cpu).        if
+0004c370: 2074 6172 6765 7420 3e3d 206c 656e 2873   target >= len(s
+0004c380: 656c 662e 776f 726b 6572 7329 3a0a 2020  elf.workers):.  
+0004c390: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0004c3a0: 2074 6172 6765 740a 2020 2020 2020 2020   target.        
+0004c3b0: 656c 7365 3a20 2023 2053 6361 6c65 2064  else:  # Scale d
+0004c3c0: 6f77 6e3f 0a20 2020 2020 2020 2020 2020  own?.           
+0004c3d0: 2074 6f5f 636c 6f73 6520 3d20 7365 6c66   to_close = self
+0004c3e0: 2e77 6f72 6b65 7273 5f74 6f5f 636c 6f73  .workers_to_clos
+0004c3f0: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0004c400: 7265 7475 726e 206c 656e 2873 656c 662e  return len(self.
+0004c410: 776f 726b 6572 7329 202d 206c 656e 2874  workers) - len(t
+0004c420: 6f5f 636c 6f73 6529 0a0a 2020 2020 6465  o_close)..    de
+0004c430: 6620 7265 7175 6573 745f 6163 7175 6972  f request_acquir
+0004c440: 655f 7265 706c 6963 6173 280a 2020 2020  e_replicas(.    
+0004c450: 2020 2020 7365 6c66 2c20 6164 6472 3a20      self, addr: 
+0004c460: 7374 722c 206b 6579 733a 2049 7465 7261  str, keys: Itera
+0004c470: 626c 655b 4b65 795d 2c20 2a2c 2073 7469  ble[Key], *, sti
+0004c480: 6d75 6c75 735f 6964 3a20 7374 720a 2020  mulus_id: str.  
+0004c490: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+0004c4a0: 2020 2020 2022 2222 4173 796e 6368 726f       """Asynchro
+0004c4b0: 6e6f 7573 6c79 2061 736b 2061 2077 6f72  nously ask a wor
+0004c4c0: 6b65 7220 746f 2061 6371 7569 7265 2061  ker to acquire a
+0004c4d0: 2072 6570 6c69 6361 206f 6620 7468 6520   replica of the 
+0004c4e0: 6c69 7374 6564 206b 6579 7320 6672 6f6d  listed keys from
+0004c4f0: 0a20 2020 2020 2020 206f 7468 6572 2077  .        other w
+0004c500: 6f72 6b65 7273 2e20 5468 6973 2069 7320  orkers. This is 
+0004c510: 6120 6669 7265 2d61 6e64 2d66 6f72 6765  a fire-and-forge
+0004c520: 7420 6f70 6572 6174 696f 6e20 7768 6963  t operation whic
+0004c530: 6820 6f66 6665 7273 206e 6f20 6665 6564  h offers no feed
+0004c540: 6261 636b 2066 6f72 0a20 2020 2020 2020  back for.       
+0004c550: 2073 7563 6365 7373 206f 7220 6661 696c   success or fail
+0004c560: 7572 652c 2061 6e64 2069 7320 696e 7465  ure, and is inte
+0004c570: 6e64 6564 2066 6f72 2068 6f75 7365 6b65  nded for houseke
+0004c580: 6570 696e 6720 616e 6420 6e6f 7420 666f  eping and not fo
+0004c590: 7220 636f 6d70 7574 6174 696f 6e2e 0a20  r computation.. 
+0004c5a0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0004c5b0: 2020 2077 686f 5f68 6173 203d 207b 7d0a     who_has = {}.
+0004c5c0: 2020 2020 2020 2020 6e62 7974 6573 203d          nbytes =
+0004c5d0: 207b 7d0a 2020 2020 2020 2020 666f 7220   {}.        for 
+0004c5e0: 6b65 7920 696e 206b 6579 733a 0a20 2020  key in keys:.   
+0004c5f0: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
+0004c600: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
+0004c610: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0004c620: 2074 732e 7768 6f5f 6861 730a 2020 2020   ts.who_has.    
+0004c630: 2020 2020 2020 2020 7768 6f5f 6861 735b          who_has[
+0004c640: 6b65 795d 203d 205b 7773 2e61 6464 7265  key] = [ws.addre
+0004c650: 7373 2066 6f72 2077 7320 696e 2074 732e  ss for ws in ts.
+0004c660: 7768 6f5f 6861 7320 6f72 2028 295d 0a20  who_has or ()]. 
+0004c670: 2020 2020 2020 2020 2020 206e 6279 7465             nbyte
+0004c680: 735b 6b65 795d 203d 2074 732e 6e62 7974  s[key] = ts.nbyt
+0004c690: 6573 0a0a 2020 2020 2020 2020 7365 6c66  es..        self
+0004c6a0: 2e73 7472 6561 6d5f 636f 6d6d 735b 6164  .stream_comms[ad
+0004c6b0: 6472 5d2e 7365 6e64 280a 2020 2020 2020  dr].send(.      
+0004c6c0: 2020 2020 2020 7b0a 2020 2020 2020 2020        {.        
+0004c6d0: 2020 2020 2020 2020 226f 7022 3a20 2261          "op": "a
+0004c6e0: 6371 7569 7265 2d72 6570 6c69 6361 7322  cquire-replicas"
+0004c6f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0004c700: 2020 2277 686f 5f68 6173 223a 2077 686f    "who_has": who
+0004c710: 5f68 6173 2c0a 2020 2020 2020 2020 2020  _has,.          
+0004c720: 2020 2020 2020 226e 6279 7465 7322 3a20        "nbytes": 
+0004c730: 6e62 7974 6573 2c0a 2020 2020 2020 2020  nbytes,.        
+0004c740: 2020 2020 2020 2020 2273 7469 6d75 6c75          "stimulu
+0004c750: 735f 6964 223a 2073 7469 6d75 6c75 735f  s_id": stimulus_
+0004c760: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
+0004c770: 7d2c 0a20 2020 2020 2020 2029 0a0a 2020  },.        )..  
+0004c780: 2020 6465 6620 7265 7175 6573 745f 7265    def request_re
+0004c790: 6d6f 7665 5f72 6570 6c69 6361 7328 0a20  move_replicas(. 
+0004c7a0: 2020 2020 2020 2073 656c 662c 2061 6464         self, add
+0004c7b0: 723a 2073 7472 2c20 6b65 7973 3a20 6c69  r: str, keys: li
+0004c7c0: 7374 5b4b 6579 5d2c 202a 2c20 7374 696d  st[Key], *, stim
+0004c7d0: 756c 7573 5f69 643a 2073 7472 0a20 2020  ulus_id: str.   
+0004c7e0: 2029 202d 3e20 4e6f 6e65 3a0a 2020 2020   ) -> None:.    
+0004c7f0: 2020 2020 2222 2241 7379 6e63 6872 6f6e      """Asynchron
+0004c800: 6f75 736c 7920 6173 6b20 6120 776f 726b  ously ask a work
+0004c810: 6572 2074 6f20 6469 7363 6172 6420 6974  er to discard it
+0004c820: 7320 7265 706c 6963 6120 6f66 2074 6865  s replica of the
+0004c830: 206c 6973 7465 6420 6b65 7973 2e0a 2020   listed keys..  
+0004c840: 2020 2020 2020 5468 6973 206d 7573 7420        This must 
+0004c850: 6e65 7665 7220 6265 2075 7365 6420 746f  never be used to
+0004c860: 2064 6573 7472 6f79 2074 6865 206c 6173   destroy the las
+0004c870: 7420 7265 706c 6963 6120 6f66 2061 206b  t replica of a k
+0004c880: 6579 2e20 5468 6973 2069 7320 610a 2020  ey. This is a.  
+0004c890: 2020 2020 2020 6669 7265 2d61 6e64 2d66        fire-and-f
+0004c8a0: 6f72 6765 7420 6f70 6572 6174 696f 6e2c  orget operation,
+0004c8b0: 2069 6e74 656e 6465 6420 666f 7220 686f   intended for ho
+0004c8c0: 7573 656b 6565 7069 6e67 2061 6e64 206e  usekeeping and n
+0004c8d0: 6f74 2066 6f72 2063 6f6d 7075 7461 7469  ot for computati
+0004c8e0: 6f6e 2e0a 0a20 2020 2020 2020 2054 6865  on...        The
+0004c8f0: 2072 6570 6c69 6361 2064 6973 6170 7065   replica disappe
+0004c900: 6172 7320 696d 6d65 6469 6174 656c 7920  ars immediately 
+0004c910: 6672 6f6d 2054 6173 6b53 7461 7465 2e77  from TaskState.w
+0004c920: 686f 5f68 6173 206f 6e20 7468 6520 5363  ho_has on the Sc
+0004c930: 6865 6475 6c65 7220 7369 6465 3b0a 2020  heduler side;.  
+0004c940: 2020 2020 2020 6966 2074 6865 2077 6f72        if the wor
+0004c950: 6b65 7220 7265 6675 7365 7320 746f 2064  ker refuses to d
+0004c960: 656c 6574 652c 2065 2e67 2e20 6265 6361  elete, e.g. beca
+0004c970: 7573 6520 7468 6520 7461 736b 2069 7320  use the task is 
+0004c980: 6120 6465 7065 6e64 656e 6379 206f 660a  a dependency of.
+0004c990: 2020 2020 2020 2020 616e 6f74 6865 7220          another 
+0004c9a0: 7461 736b 2072 756e 6e69 6e67 206f 6e20  task running on 
+0004c9b0: 6974 2c20 6974 2077 696c 6c20 2861 6c73  it, it will (als
+0004c9c0: 6f20 6173 796e 6368 726f 6e6f 7573 6c79  o asynchronously
+0004c9d0: 2920 696e 666f 726d 2074 6865 2073 6368  ) inform the sch
+0004c9e0: 6564 756c 6572 0a20 2020 2020 2020 2074  eduler.        t
+0004c9f0: 6f20 7265 2d61 6464 2069 7473 656c 6620  o re-add itself 
+0004ca00: 746f 2077 686f 5f68 6173 2e20 4966 2074  to who_has. If t
+0004ca10: 6865 2077 6f72 6b65 7220 6167 7265 6573  he worker agrees
+0004ca20: 2074 6f20 6469 7363 6172 6420 7468 6520   to discard the 
+0004ca30: 7461 736b 2c20 7468 6572 6520 6973 0a20  task, there is. 
+0004ca40: 2020 2020 2020 206e 6f20 6665 6564 6261         no feedba
+0004ca50: 636b 2e0a 2020 2020 2020 2020 2222 220a  ck..        """.
+0004ca60: 2020 2020 2020 2020 7773 203d 2073 656c          ws = sel
+0004ca70: 662e 776f 726b 6572 735b 6164 6472 5d0a  f.workers[addr].
+0004ca80: 0a20 2020 2020 2020 2023 2054 6865 2073  .        # The s
+0004ca90: 6368 6564 756c 6572 2069 6d6d 6564 6961  cheduler immedia
+0004caa0: 7465 6c79 2066 6f72 6765 7473 2061 626f  tely forgets abo
+0004cab0: 7574 2074 6865 2072 6570 6c69 6361 2061  ut the replica a
+0004cac0: 6e64 2073 7567 6765 7374 7320 7468 6520  nd suggests the 
+0004cad0: 776f 726b 6572 2074 6f0a 2020 2020 2020  worker to.      
+0004cae0: 2020 2320 6472 6f70 2069 742e 2054 6865    # drop it. The
+0004caf0: 2077 6f72 6b65 7220 6d61 7920 7265 6675   worker may refu
+0004cb00: 7365 2c20 6174 2077 6869 6368 2070 6f69  se, at which poi
+0004cb10: 6e74 2069 7420 7769 6c6c 2073 656e 6420  nt it will send 
+0004cb20: 6261 636b 2061 6e20 6164 642d 6b65 7973  back an add-keys
+0004cb30: 0a20 2020 2020 2020 2023 206d 6573 7361  .        # messa
+0004cb40: 6765 2074 6f20 7265 696e 7374 6174 6520  ge to reinstate 
+0004cb50: 6974 2e0a 2020 2020 2020 2020 666f 7220  it..        for 
+0004cb60: 6b65 7920 696e 206b 6579 733a 0a20 2020  key in keys:.   
+0004cb70: 2020 2020 2020 2020 2074 7320 3d20 7365           ts = se
+0004cb80: 6c66 2e74 6173 6b73 5b6b 6579 5d0a 2020  lf.tasks[key].  
+0004cb90: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0004cba0: 662e 7661 6c69 6461 7465 3a0a 2020 2020  f.validate:.    
+0004cbb0: 2020 2020 2020 2020 2020 2020 2320 446f              # Do
+0004cbc0: 206e 6f74 2064 6573 7472 6f79 2074 6865   not destroy the
+0004cbd0: 206c 6173 7420 636f 7079 0a20 2020 2020   last copy.     
+0004cbe0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0004cbf0: 7420 7473 2e77 686f 5f68 6173 0a20 2020  t ts.who_has.   
+0004cc00: 2020 2020 2020 2020 2020 2020 2061 7373               ass
+0004cc10: 6572 7420 6c65 6e28 7473 2e77 686f 5f68  ert len(ts.who_h
+0004cc20: 6173 2920 3e20 310a 2020 2020 2020 2020  as) > 1.        
+0004cc30: 2020 2020 7365 6c66 2e72 656d 6f76 655f      self.remove_
+0004cc40: 7265 706c 6963 6128 7473 2c20 7773 290a  replica(ts, ws).
+0004cc50: 0a20 2020 2020 2020 2073 656c 662e 7374  .        self.st
+0004cc60: 7265 616d 5f63 6f6d 6d73 5b61 6464 725d  ream_comms[addr]
+0004cc70: 2e73 656e 6428 0a20 2020 2020 2020 2020  .send(.         
+0004cc80: 2020 207b 0a20 2020 2020 2020 2020 2020     {.           
+0004cc90: 2020 2020 2022 6f70 223a 2022 7265 6d6f       "op": "remo
+0004cca0: 7665 2d72 6570 6c69 6361 7322 2c0a 2020  ve-replicas",.  
+0004ccb0: 2020 2020 2020 2020 2020 2020 2020 226b                "k
+0004ccc0: 6579 7322 3a20 6b65 7973 2c0a 2020 2020  eys": keys,.    
+0004ccd0: 2020 2020 2020 2020 2020 2020 2273 7469              "sti
+0004cce0: 6d75 6c75 735f 6964 223a 2073 7469 6d75  mulus_id": stimu
+0004ccf0: 6c75 735f 6964 2c0a 2020 2020 2020 2020  lus_id,.        
+0004cd00: 2020 2020 7d0a 2020 2020 2020 2020 290a      }.        ).
+0004cd10: 0a0a 6465 6620 5f74 6173 6b5f 746f 5f72  ..def _task_to_r
+0004cd20: 6570 6f72 745f 6d73 6728 7473 3a20 5461  eport_msg(ts: Ta
+0004cd30: 736b 5374 6174 6529 202d 3e20 6469 6374  skState) -> dict
+0004cd40: 5b73 7472 2c20 416e 795d 207c 204e 6f6e  [str, Any] | Non
+0004cd50: 653a 0a20 2020 2069 6620 7473 2e73 7461  e:.    if ts.sta
+0004cd60: 7465 203d 3d20 2266 6f72 676f 7474 656e  te == "forgotten
+0004cd70: 223a 0a20 2020 2020 2020 2072 6574 7572  ":.        retur
+0004cd80: 6e20 7b22 6f70 223a 2022 6361 6e63 656c  n {"op": "cancel
+0004cd90: 6c65 642d 6b65 7973 222c 2022 6b65 7973  led-keys", "keys
+0004cda0: 223a 205b 7473 2e6b 6579 5d7d 0a20 2020  ": [ts.key]}.   
+0004cdb0: 2065 6c69 6620 7473 2e73 7461 7465 203d   elif ts.state =
+0004cdc0: 3d20 226d 656d 6f72 7922 3a0a 2020 2020  = "memory":.    
+0004cdd0: 2020 2020 7265 7475 726e 207b 226f 7022      return {"op"
+0004cde0: 3a20 226b 6579 2d69 6e2d 6d65 6d6f 7279  : "key-in-memory
+0004cdf0: 222c 2022 6b65 7922 3a20 7473 2e6b 6579  ", "key": ts.key
+0004ce00: 7d0a 2020 2020 656c 6966 2074 732e 7374  }.    elif ts.st
+0004ce10: 6174 6520 3d3d 2022 6572 7265 6422 3a0a  ate == "erred":.
+0004ce20: 2020 2020 2020 2020 6661 696c 696e 675f          failing_
+0004ce30: 7473 203d 2074 732e 6578 6365 7074 696f  ts = ts.exceptio
+0004ce40: 6e5f 626c 616d 650a 2020 2020 2020 2020  n_blame.        
+0004ce50: 6173 7365 7274 2066 6169 6c69 6e67 5f74  assert failing_t
+0004ce60: 730a 2020 2020 2020 2020 7265 7475 726e  s.        return
+0004ce70: 207b 0a20 2020 2020 2020 2020 2020 2022   {.            "
+0004ce80: 6f70 223a 2022 7461 736b 2d65 7272 6564  op": "task-erred
+0004ce90: 222c 0a20 2020 2020 2020 2020 2020 2022  ",.            "
+0004cea0: 6b65 7922 3a20 7473 2e6b 6579 2c0a 2020  key": ts.key,.  
+0004ceb0: 2020 2020 2020 2020 2020 2265 7863 6570            "excep
+0004cec0: 7469 6f6e 223a 2066 6169 6c69 6e67 5f74  tion": failing_t
+0004ced0: 732e 6578 6365 7074 696f 6e2c 0a20 2020  s.exception,.   
+0004cee0: 2020 2020 2020 2020 2022 7472 6163 6562           "traceb
+0004cef0: 6163 6b22 3a20 6661 696c 696e 675f 7473  ack": failing_ts
+0004cf00: 2e74 7261 6365 6261 636b 2c0a 2020 2020  .traceback,.    
+0004cf10: 2020 2020 7d0a 2020 2020 656c 7365 3a0a      }.    else:.
+0004cf20: 2020 2020 2020 2020 7265 7475 726e 204e          return N
+0004cf30: 6f6e 650a 0a0a 6465 6620 5f74 6173 6b5f  one...def _task_
+0004cf40: 746f 5f63 6c69 656e 745f 6d73 6773 2874  to_client_msgs(t
+0004cf50: 733a 2054 6173 6b53 7461 7465 2920 2d3e  s: TaskState) ->
+0004cf60: 204d 7367 733a 0a20 2020 2069 6620 7473   Msgs:.    if ts
+0004cf70: 2e77 686f 5f77 616e 7473 3a0a 2020 2020  .who_wants:.    
+0004cf80: 2020 2020 7265 706f 7274 5f6d 7367 203d      report_msg =
+0004cf90: 205f 7461 736b 5f74 6f5f 7265 706f 7274   _task_to_report
+0004cfa0: 5f6d 7367 2874 7329 0a20 2020 2020 2020  _msg(ts).       
+0004cfb0: 2069 6620 7265 706f 7274 5f6d 7367 2069   if report_msg i
+0004cfc0: 7320 6e6f 7420 4e6f 6e65 3a0a 2020 2020  s not None:.    
+0004cfd0: 2020 2020 2020 2020 7265 7475 726e 207b          return {
+0004cfe0: 6373 2e63 6c69 656e 745f 6b65 793a 205b  cs.client_key: [
+0004cff0: 7265 706f 7274 5f6d 7367 5d20 666f 7220  report_msg] for 
+0004d000: 6373 2069 6e20 7473 2e77 686f 5f77 616e  cs in ts.who_wan
+0004d010: 7473 7d0a 2020 2020 7265 7475 726e 207b  ts}.    return {
+0004d020: 7d0a 0a0a 6465 6620 6465 6369 6465 5f77  }...def decide_w
+0004d030: 6f72 6b65 7228 0a20 2020 2074 733a 2054  orker(.    ts: T
+0004d040: 6173 6b53 7461 7465 2c0a 2020 2020 616c  askState,.    al
+0004d050: 6c5f 776f 726b 6572 733a 2073 6574 5b57  l_workers: set[W
+0004d060: 6f72 6b65 7253 7461 7465 5d2c 0a20 2020  orkerState],.   
+0004d070: 2076 616c 6964 5f77 6f72 6b65 7273 3a20   valid_workers: 
+0004d080: 7365 745b 576f 726b 6572 5374 6174 655d  set[WorkerState]
+0004d090: 207c 204e 6f6e 652c 0a20 2020 206f 626a   | None,.    obj
+0004d0a0: 6563 7469 7665 3a20 4361 6c6c 6162 6c65  ective: Callable
+0004d0b0: 5b5b 576f 726b 6572 5374 6174 655d 2c20  [[WorkerState], 
+0004d0c0: 416e 795d 2c0a 2920 2d3e 2057 6f72 6b65  Any],.) -> Worke
+0004d0d0: 7253 7461 7465 207c 204e 6f6e 653a 0a20  rState | None:. 
+0004d0e0: 2020 2022 2222 0a20 2020 2044 6563 6964     """.    Decid
+0004d0f0: 6520 7768 6963 6820 776f 726b 6572 2073  e which worker s
+0004d100: 686f 756c 6420 7461 6b65 2074 6173 6b20  hould take task 
+0004d110: 2a74 732a 2e0a 0a20 2020 2057 6520 6368  *ts*...    We ch
+0004d120: 6f6f 7365 2074 6865 2077 6f72 6b65 7220  oose the worker 
+0004d130: 7468 6174 2068 6173 2074 6865 2064 6174  that has the dat
+0004d140: 6120 6f6e 2077 6869 6368 202a 7473 2a20  a on which *ts* 
+0004d150: 6465 7065 6e64 732e 0a0a 2020 2020 4966  depends...    If
+0004d160: 2073 6576 6572 616c 2077 6f72 6b65 7273   several workers
+0004d170: 2068 6176 6520 6465 7065 6e64 656e 6369   have dependenci
+0004d180: 6573 2074 6865 6e20 7765 2063 686f 6f73  es then we choos
+0004d190: 6520 7468 6520 6c65 7373 2d62 7573 7920  e the less-busy 
+0004d1a0: 776f 726b 6572 2e0a 0a20 2020 204f 7074  worker...    Opt
+0004d1b0: 696f 6e61 6c6c 7920 7072 6f76 6964 6520  ionally provide 
+0004d1c0: 2a76 616c 6964 5f77 6f72 6b65 7273 2a20  *valid_workers* 
+0004d1d0: 6f66 2077 6865 7265 206a 6f62 7320 6172  of where jobs ar
+0004d1e0: 6520 616c 6c6f 7765 6420 746f 206f 6363  e allowed to occ
+0004d1f0: 7572 0a20 2020 2028 6966 2061 6c6c 2077  ur.    (if all w
+0004d200: 6f72 6b65 7273 2061 7265 2061 6c6c 6f77  orkers are allow
+0004d210: 6564 2074 6f20 7461 6b65 2074 6865 2074  ed to take the t
+0004d220: 6173 6b2c 2070 6173 7320 4e6f 6e65 2069  ask, pass None i
+0004d230: 6e73 7465 6164 292e 0a0a 2020 2020 4966  nstead)...    If
+0004d240: 2074 6865 2074 6173 6b20 7265 7175 6972   the task requir
+0004d250: 6573 2064 6174 6120 636f 6d6d 756e 6963  es data communic
+0004d260: 6174 696f 6e20 6265 6361 7573 6520 6e6f  ation because no
+0004d270: 2065 6c69 6769 626c 6520 776f 726b 6572   eligible worker
+0004d280: 2068 6173 0a20 2020 2061 6c6c 2074 6865   has.    all the
+0004d290: 2064 6570 656e 6465 6e63 6965 7320 616c   dependencies al
+0004d2a0: 7265 6164 792c 2074 6865 6e20 7765 2063  ready, then we c
+0004d2b0: 686f 6f73 6520 746f 206d 696e 696d 697a  hoose to minimiz
+0004d2c0: 6520 7468 6520 6e75 6d62 6572 0a20 2020  e the number.   
+0004d2d0: 206f 6620 6279 7465 7320 7365 6e74 2062   of bytes sent b
+0004d2e0: 6574 7765 656e 2077 6f72 6b65 7273 2e20  etween workers. 
+0004d2f0: 2054 6869 7320 6973 2064 6574 6572 6d69   This is determi
+0004d300: 6e65 6420 6279 2063 616c 6c69 6e67 2074  ned by calling t
+0004d310: 6865 0a20 2020 202a 6f62 6a65 6374 6976  he.    *objectiv
+0004d320: 652a 2066 756e 6374 696f 6e2e 0a20 2020  e* function..   
+0004d330: 2022 2222 0a20 2020 2061 7373 6572 7420   """.    assert 
+0004d340: 616c 6c28 6474 732e 7768 6f5f 6861 7320  all(dts.who_has 
+0004d350: 666f 7220 6474 7320 696e 2074 732e 6465  for dts in ts.de
+0004d360: 7065 6e64 656e 6369 6573 290a 2020 2020  pendencies).    
+0004d370: 6966 2074 732e 6163 746f 723a 0a20 2020  if ts.actor:.   
+0004d380: 2020 2020 2063 616e 6469 6461 7465 7320       candidates 
+0004d390: 3d20 616c 6c5f 776f 726b 6572 732e 636f  = all_workers.co
+0004d3a0: 7079 2829 0a20 2020 2065 6c73 653a 0a20  py().    else:. 
+0004d3b0: 2020 2020 2020 2063 616e 6469 6461 7465         candidate
+0004d3c0: 7320 3d20 7b77 7773 2066 6f72 2064 7473  s = {wws for dts
+0004d3d0: 2069 6e20 7473 2e64 6570 656e 6465 6e63   in ts.dependenc
+0004d3e0: 6965 7320 666f 7220 7777 7320 696e 2064  ies for wws in d
+0004d3f0: 7473 2e77 686f 5f68 6173 206f 7220 2829  ts.who_has or ()
+0004d400: 7d0a 2020 2020 2020 2020 6361 6e64 6964  }.        candid
+0004d410: 6174 6573 2026 3d20 616c 6c5f 776f 726b  ates &= all_work
+0004d420: 6572 730a 2020 2020 6966 2076 616c 6964  ers.    if valid
+0004d430: 5f77 6f72 6b65 7273 2069 7320 4e6f 6e65  _workers is None
+0004d440: 3a0a 2020 2020 2020 2020 6966 206e 6f74  :.        if not
+0004d450: 2063 616e 6469 6461 7465 733a 0a20 2020   candidates:.   
+0004d460: 2020 2020 2020 2020 2063 616e 6469 6461           candida
+0004d470: 7465 7320 3d20 616c 6c5f 776f 726b 6572  tes = all_worker
+0004d480: 732e 636f 7079 2829 0a20 2020 2065 6c73  s.copy().    els
+0004d490: 653a 0a20 2020 2020 2020 2063 616e 6469  e:.        candi
+0004d4a0: 6461 7465 7320 263d 2076 616c 6964 5f77  dates &= valid_w
+0004d4b0: 6f72 6b65 7273 0a20 2020 2020 2020 2069  orkers.        i
+0004d4c0: 6620 6e6f 7420 6361 6e64 6964 6174 6573  f not candidates
+0004d4d0: 3a0a 2020 2020 2020 2020 2020 2020 6361  :.            ca
+0004d4e0: 6e64 6964 6174 6573 203d 2076 616c 6964  ndidates = valid
+0004d4f0: 5f77 6f72 6b65 7273 0a20 2020 2020 2020  _workers.       
+0004d500: 2020 2020 2069 6620 6e6f 7420 6361 6e64       if not cand
+0004d510: 6964 6174 6573 3a0a 2020 2020 2020 2020  idates:.        
+0004d520: 2020 2020 2020 2020 6966 2074 732e 6c6f          if ts.lo
+0004d530: 6f73 655f 7265 7374 7269 6374 696f 6e73  ose_restrictions
+0004d540: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0004d550: 2020 2020 2020 7265 7475 726e 2064 6563        return dec
+0004d560: 6964 655f 776f 726b 6572 2874 732c 2061  ide_worker(ts, a
+0004d570: 6c6c 5f77 6f72 6b65 7273 2c20 4e6f 6e65  ll_workers, None
+0004d580: 2c20 6f62 6a65 6374 6976 6529 0a0a 2020  , objective)..  
+0004d590: 2020 6966 206e 6f74 2063 616e 6469 6461    if not candida
+0004d5a0: 7465 733a 0a20 2020 2020 2020 2072 6574  tes:.        ret
+0004d5b0: 7572 6e20 4e6f 6e65 0a20 2020 2065 6c69  urn None.    eli
+0004d5c0: 6620 6c65 6e28 6361 6e64 6964 6174 6573  f len(candidates
+0004d5d0: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+0004d5e0: 7265 7475 726e 206e 6578 7428 6974 6572  return next(iter
+0004d5f0: 2863 616e 6469 6461 7465 7329 290a 2020  (candidates)).  
+0004d600: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0004d610: 7265 7475 726e 206d 696e 2863 616e 6469  return min(candi
+0004d620: 6461 7465 732c 206b 6579 3d6f 626a 6563  dates, key=objec
+0004d630: 7469 7665 290a 0a0a 6465 6620 7661 6c69  tive)...def vali
+0004d640: 6461 7465 5f74 6173 6b5f 7374 6174 6528  date_task_state(
+0004d650: 7473 3a20 5461 736b 5374 6174 6529 202d  ts: TaskState) -
+0004d660: 3e20 4e6f 6e65 3a0a 2020 2020 2222 2256  > None:.    """V
+0004d670: 616c 6964 6174 6520 7468 6520 6769 7665  alidate the give
+0004d680: 6e20 5461 736b 5374 6174 6522 2222 0a20  n TaskState""". 
+0004d690: 2020 2061 7373 6572 7420 7473 2e73 7461     assert ts.sta
+0004d6a0: 7465 2069 6e20 414c 4c5f 5441 534b 5f53  te in ALL_TASK_S
+0004d6b0: 5441 5445 532c 2074 730a 0a20 2020 2069  TATES, ts..    i
+0004d6c0: 6620 7473 2e77 6169 7469 6e67 5f6f 6e3a  f ts.waiting_on:
+0004d6d0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+0004d6e0: 7473 2e77 6169 7469 6e67 5f6f 6e2e 6973  ts.waiting_on.is
+0004d6f0: 7375 6273 6574 2874 732e 6465 7065 6e64  subset(ts.depend
+0004d700: 656e 6369 6573 292c 2028 0a20 2020 2020  encies), (.     
+0004d710: 2020 2020 2020 2022 7761 6974 696e 6720         "waiting 
+0004d720: 6e6f 7420 7375 6273 6574 206f 6620 6465  not subset of de
+0004d730: 7065 6e64 656e 6369 6573 222c 0a20 2020  pendencies",.   
+0004d740: 2020 2020 2020 2020 2073 7472 2874 732e           str(ts.
+0004d750: 7761 6974 696e 675f 6f6e 292c 0a20 2020  waiting_on),.   
+0004d760: 2020 2020 2020 2020 2073 7472 2874 732e           str(ts.
+0004d770: 6465 7065 6e64 656e 6369 6573 292c 0a20  dependencies),. 
+0004d780: 2020 2020 2020 2029 0a20 2020 2069 6620         ).    if 
+0004d790: 7473 2e77 6169 7465 7273 3a0a 2020 2020  ts.waiters:.    
+0004d7a0: 2020 2020 6173 7365 7274 2074 732e 7761      assert ts.wa
+0004d7b0: 6974 6572 732e 6973 7375 6273 6574 2874  iters.issubset(t
+0004d7c0: 732e 6465 7065 6e64 656e 7473 292c 2028  s.dependents), (
+0004d7d0: 0a20 2020 2020 2020 2020 2020 2022 7761  .            "wa
+0004d7e0: 6974 6572 7320 6e6f 7420 7375 6273 6574  iters not subset
+0004d7f0: 206f 6620 6465 7065 6e64 656e 7473 222c   of dependents",
+0004d800: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+0004d810: 2874 732e 7761 6974 6572 7329 2c0a 2020  (ts.waiters),.  
+0004d820: 2020 2020 2020 2020 2020 7374 7228 7473            str(ts
+0004d830: 2e64 6570 656e 6465 6e74 7329 2c0a 2020  .dependents),.  
+0004d840: 2020 2020 2020 290a 0a20 2020 2066 6f72        )..    for
+0004d850: 2064 7473 2069 6e20 7473 2e77 6169 7469   dts in ts.waiti
+0004d860: 6e67 5f6f 6e20 6f72 2028 293a 0a20 2020  ng_on or ():.   
+0004d870: 2020 2020 2061 7373 6572 7420 6e6f 7420       assert not 
+0004d880: 6474 732e 7768 6f5f 6861 732c 2028 2277  dts.who_has, ("w
+0004d890: 6169 7469 6e67 206f 6e20 696e 2d6d 656d  aiting on in-mem
+0004d8a0: 6f72 7920 6465 7022 2c20 7374 7228 7473  ory dep", str(ts
+0004d8b0: 292c 2073 7472 2864 7473 2929 0a20 2020  ), str(dts)).   
+0004d8c0: 2020 2020 2061 7373 6572 7420 6474 732e       assert dts.
+0004d8d0: 7374 6174 6520 213d 2022 7265 6c65 6173  state != "releas
+0004d8e0: 6564 222c 2028 2277 6169 7469 6e67 206f  ed", ("waiting o
+0004d8f0: 6e20 7265 6c65 6173 6564 2064 6570 222c  n released dep",
+0004d900: 2073 7472 2874 7329 2c20 7374 7228 6474   str(ts), str(dt
+0004d910: 7329 290a 2020 2020 666f 7220 6474 7320  s)).    for dts 
+0004d920: 696e 2074 732e 6465 7065 6e64 656e 6369  in ts.dependenci
+0004d930: 6573 3a0a 2020 2020 2020 2020 6173 7365  es:.        asse
+0004d940: 7274 2074 7320 696e 2064 7473 2e64 6570  rt ts in dts.dep
+0004d950: 656e 6465 6e74 732c 2028 0a20 2020 2020  endents, (.     
+0004d960: 2020 2020 2020 2022 6e6f 7420 696e 2064         "not in d
+0004d970: 6570 656e 6465 6e63 7927 7320 6465 7065  ependency's depe
+0004d980: 6e64 656e 7473 222c 0a20 2020 2020 2020  ndents",.       
+0004d990: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
+0004d9a0: 2020 2020 2020 2020 2020 7374 7228 6474            str(dt
+0004d9b0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+0004d9c0: 7374 7228 6474 732e 6465 7065 6e64 656e  str(dts.dependen
+0004d9d0: 7473 292c 0a20 2020 2020 2020 2029 0a20  ts),.        ). 
+0004d9e0: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
+0004d9f0: 7465 2069 6e20 2822 7761 6974 696e 6722  te in ("waiting"
+0004da00: 2c20 2271 7565 7565 6422 2c20 2270 726f  , "queued", "pro
+0004da10: 6365 7373 696e 6722 2c20 226e 6f2d 776f  cessing", "no-wo
+0004da20: 726b 6572 2229 3a0a 2020 2020 2020 2020  rker"):.        
+0004da30: 2020 2020 6173 7365 7274 2074 732e 7761      assert ts.wa
+0004da40: 6974 696e 675f 6f6e 2061 6e64 2064 7473  iting_on and dts
+0004da50: 2069 6e20 7473 2e77 6169 7469 6e67 5f6f   in ts.waiting_o
+0004da60: 6e20 6f72 2064 7473 2e77 686f 5f68 6173  n or dts.who_has
+0004da70: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+0004da80: 2020 2020 2264 6570 206d 6973 7369 6e67      "dep missing
+0004da90: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0004daa0: 2020 2073 7472 2874 7329 2c0a 2020 2020     str(ts),.    
+0004dab0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+0004dac0: 6474 7329 2c0a 2020 2020 2020 2020 2020  dts),.          
+0004dad0: 2020 290a 2020 2020 2020 2020 6173 7365    ).        asse
+0004dae0: 7274 2064 7473 2e73 7461 7465 2021 3d20  rt dts.state != 
+0004daf0: 2266 6f72 676f 7474 656e 220a 0a20 2020  "forgotten"..   
+0004db00: 2066 6f72 2064 7473 2069 6e20 7473 2e77   for dts in ts.w
+0004db10: 6169 7465 7273 206f 7220 2829 3a0a 2020  aiters or ():.  
+0004db20: 2020 2020 2020 6173 7365 7274 2064 7473        assert dts
+0004db30: 2e73 7461 7465 2069 6e20 2822 7761 6974  .state in ("wait
+0004db40: 696e 6722 2c20 2271 7565 7565 6422 2c20  ing", "queued", 
+0004db50: 2270 726f 6365 7373 696e 6722 2c20 226e  "processing", "n
+0004db60: 6f2d 776f 726b 6572 2229 2c20 280a 2020  o-worker"), (.  
+0004db70: 2020 2020 2020 2020 2020 2277 6169 7465            "waite
+0004db80: 7220 6e6f 7420 696e 2070 6c61 7922 2c0a  r not in play",.
+0004db90: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+0004dba0: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+0004dbb0: 2073 7472 2864 7473 292c 0a20 2020 2020   str(dts),.     
+0004dbc0: 2020 2029 0a20 2020 2066 6f72 2064 7473     ).    for dts
+0004dbd0: 2069 6e20 7473 2e64 6570 656e 6465 6e74   in ts.dependent
+0004dbe0: 733a 0a20 2020 2020 2020 2061 7373 6572  s:.        asser
+0004dbf0: 7420 7473 2069 6e20 6474 732e 6465 7065  t ts in dts.depe
+0004dc00: 6e64 656e 6369 6573 2c20 280a 2020 2020  ndencies, (.    
+0004dc10: 2020 2020 2020 2020 226e 6f74 2069 6e20          "not in 
+0004dc20: 6465 7065 6e64 656e 7427 7320 6465 7065  dependent's depe
+0004dc30: 6e64 656e 6369 6573 222c 0a20 2020 2020  ndencies",.     
+0004dc40: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
+0004dc50: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+0004dc60: 6474 7329 2c0a 2020 2020 2020 2020 2020  dts),.          
+0004dc70: 2020 7374 7228 6474 732e 6465 7065 6e64    str(dts.depend
+0004dc80: 656e 6369 6573 292c 0a20 2020 2020 2020  encies),.       
+0004dc90: 2029 0a20 2020 2020 2020 2061 7373 6572   ).        asser
+0004dca0: 7420 6474 732e 7374 6174 6520 213d 2022  t dts.state != "
+0004dcb0: 666f 7267 6f74 7465 6e22 0a0a 2020 2020  forgotten"..    
+0004dcc0: 6173 7365 7274 2028 7473 2e70 726f 6365  assert (ts.proce
+0004dcd0: 7373 696e 675f 6f6e 2069 7320 6e6f 7420  ssing_on is not 
+0004dce0: 4e6f 6e65 2920 3d3d 2028 7473 2e73 7461  None) == (ts.sta
+0004dcf0: 7465 203d 3d20 2270 726f 6365 7373 696e  te == "processin
+0004dd00: 6722 290a 2020 2020 6173 7365 7274 2062  g").    assert b
+0004dd10: 6f6f 6c28 7473 2e77 686f 5f68 6173 2920  ool(ts.who_has) 
+0004dd20: 3d3d 2028 7473 2e73 7461 7465 203d 3d20  == (ts.state == 
+0004dd30: 226d 656d 6f72 7922 292c 2028 7473 2c20  "memory"), (ts, 
+0004dd40: 7473 2e77 686f 5f68 6173 2c20 7473 2e73  ts.who_has, ts.s
+0004dd50: 7461 7465 290a 0a20 2020 2069 6620 7473  tate)..    if ts
+0004dd60: 2e73 7461 7465 203d 3d20 2271 7565 7565  .state == "queue
+0004dd70: 6422 3a0a 2020 2020 2020 2020 6173 7365  d":.        asse
+0004dd80: 7274 206e 6f74 2074 732e 7072 6f63 6573  rt not ts.proces
+0004dd90: 7369 6e67 5f6f 6e0a 2020 2020 2020 2020  sing_on.        
+0004dda0: 6173 7365 7274 206e 6f74 2074 732e 7768  assert not ts.wh
+0004ddb0: 6f5f 6861 730a 2020 2020 2020 2020 6173  o_has.        as
+0004ddc0: 7365 7274 2061 6c6c 2864 7473 2e77 686f  sert all(dts.who
+0004ddd0: 5f68 6173 2066 6f72 2064 7473 2069 6e20  _has for dts in 
+0004dde0: 7473 2e64 6570 656e 6465 6e63 6965 7329  ts.dependencies)
+0004ddf0: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+0004de00: 2274 6173 6b20 7175 6575 6564 2077 6974  "task queued wit
+0004de10: 686f 7574 2061 6c6c 2064 6570 7322 2c0a  hout all deps",.
+0004de20: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+0004de30: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+0004de40: 2073 7472 2874 732e 6465 7065 6e64 656e   str(ts.dependen
+0004de50: 6369 6573 292c 0a20 2020 2020 2020 2029  cies),.        )
+0004de60: 0a0a 2020 2020 6966 2074 732e 7374 6174  ..    if ts.stat
+0004de70: 6520 3d3d 2022 7072 6f63 6573 7369 6e67  e == "processing
+0004de80: 223a 0a20 2020 2020 2020 2061 7373 6572  ":.        asser
+0004de90: 7420 616c 6c28 6474 732e 7768 6f5f 6861  t all(dts.who_ha
+0004dea0: 7320 666f 7220 6474 7320 696e 2074 732e  s for dts in ts.
+0004deb0: 6465 7065 6e64 656e 6369 6573 292c 2028  dependencies), (
+0004dec0: 0a20 2020 2020 2020 2020 2020 2022 7461  .            "ta
+0004ded0: 736b 2070 726f 6365 7373 696e 6720 7769  sk processing wi
+0004dee0: 7468 6f75 7420 616c 6c20 6465 7073 222c  thout all deps",
+0004def0: 0a20 2020 2020 2020 2020 2020 2073 7472  .            str
+0004df00: 2874 7329 2c0a 2020 2020 2020 2020 2020  (ts),.          
+0004df10: 2020 7374 7228 7473 2e64 6570 656e 6465    str(ts.depende
+0004df20: 6e63 6965 7329 2c0a 2020 2020 2020 2020  ncies),.        
+0004df30: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+0004df40: 206e 6f74 2074 732e 7761 6974 696e 675f   not ts.waiting_
+0004df50: 6f6e 0a0a 2020 2020 6966 2074 732e 7768  on..    if ts.wh
+0004df60: 6f5f 6861 733a 0a20 2020 2020 2020 2061  o_has:.        a
+0004df70: 7373 6572 7420 7473 2e77 6169 7465 7273  ssert ts.waiters
+0004df80: 206f 7220 7473 2e77 686f 5f77 616e 7473   or ts.who_wants
+0004df90: 2c20 280a 2020 2020 2020 2020 2020 2020  , (.            
+0004dfa0: 2275 6e6e 6565 6465 6420 7461 736b 2069  "unneeded task i
+0004dfb0: 6e20 6d65 6d6f 7279 222c 0a20 2020 2020  n memory",.     
+0004dfc0: 2020 2020 2020 2073 7472 2874 7329 2c0a         str(ts),.
+0004dfd0: 2020 2020 2020 2020 2020 2020 7374 7228              str(
+0004dfe0: 7473 2e77 686f 5f68 6173 292c 0a20 2020  ts.who_has),.   
+0004dff0: 2020 2020 2029 0a20 2020 2020 2020 2069       ).        i
+0004e000: 6620 7473 2e72 756e 5f73 7065 633a 2020  f ts.run_spec:  
+0004e010: 2320 7761 7320 636f 6d70 7574 6564 0a20  # was computed. 
+0004e020: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+0004e030: 7420 7473 2e74 7970 650a 2020 2020 2020  t ts.type.      
+0004e040: 2020 2020 2020 6173 7365 7274 2069 7369        assert isi
+0004e050: 6e73 7461 6e63 6528 7473 2e74 7970 652c  nstance(ts.type,
+0004e060: 2073 7472 290a 2020 2020 2020 2020 6173   str).        as
+0004e070: 7365 7274 206e 6f74 2061 6e79 280a 2020  sert not any(.  
+0004e080: 2020 2020 2020 2020 2020 5b0a 2020 2020            [.    
+0004e090: 2020 2020 2020 2020 2020 2020 7473 2069              ts i
+0004e0a0: 6e20 6474 732e 7761 6974 696e 675f 6f6e  n dts.waiting_on
+0004e0b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004e0c0: 2066 6f72 2064 7473 2069 6e20 7473 2e64   for dts in ts.d
+0004e0d0: 6570 656e 6465 6e74 730a 2020 2020 2020  ependents.      
+0004e0e0: 2020 2020 2020 2020 2020 6966 2064 7473            if dts
+0004e0f0: 2e77 6169 7469 6e67 5f6f 6e20 6973 206e  .waiting_on is n
+0004e100: 6f74 204e 6f6e 650a 2020 2020 2020 2020  ot None.        
+0004e110: 2020 2020 5d0a 2020 2020 2020 2020 290a      ].        ).
+0004e120: 2020 2020 2020 2020 666f 7220 7773 2069          for ws i
+0004e130: 6e20 7473 2e77 686f 5f68 6173 3a0a 2020  n ts.who_has:.  
+0004e140: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0004e150: 2074 7320 696e 2077 732e 6861 735f 7768   ts in ws.has_wh
+0004e160: 6174 2c20 280a 2020 2020 2020 2020 2020  at, (.          
+0004e170: 2020 2020 2020 226e 6f74 2069 6e20 7768        "not in wh
+0004e180: 6f5f 6861 7327 2068 6173 5f77 6861 7422  o_has' has_what"
+0004e190: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0004e1a0: 2020 7374 7228 7473 292c 0a20 2020 2020    str(ts),.     
+0004e1b0: 2020 2020 2020 2020 2020 2073 7472 2877             str(w
+0004e1c0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+0004e1d0: 2020 2020 7374 7228 7773 2e68 6173 5f77      str(ws.has_w
+0004e1e0: 6861 7429 2c0a 2020 2020 2020 2020 2020  hat),.          
+0004e1f0: 2020 290a 0a20 2020 2066 6f72 2063 7320    )..    for cs 
+0004e200: 696e 2074 732e 7768 6f5f 7761 6e74 7320  in ts.who_wants 
+0004e210: 6f72 2028 293a 0a20 2020 2020 2020 2061  or ():.        a
+0004e220: 7373 6572 7420 7473 2069 6e20 6373 2e77  ssert ts in cs.w
+0004e230: 616e 7473 5f77 6861 742c 2028 0a20 2020  ants_what, (.   
+0004e240: 2020 2020 2020 2020 2022 6e6f 7420 696e           "not in
+0004e250: 2077 686f 5f77 616e 7473 2720 7761 6e74   who_wants' want
+0004e260: 735f 7768 6174 222c 0a20 2020 2020 2020  s_what",.       
+0004e270: 2020 2020 2073 7472 2874 7329 2c0a 2020       str(ts),.  
+0004e280: 2020 2020 2020 2020 2020 7374 7228 6373            str(cs
+0004e290: 292c 0a20 2020 2020 2020 2020 2020 2073  ),.            s
+0004e2a0: 7472 2863 732e 7761 6e74 735f 7768 6174  tr(cs.wants_what
+0004e2b0: 292c 0a20 2020 2020 2020 2029 0a0a 2020  ),.        )..  
+0004e2c0: 2020 6966 2074 732e 6163 746f 723a 0a20    if ts.actor:. 
+0004e2d0: 2020 2020 2020 2069 6620 7473 2e73 7461         if ts.sta
+0004e2e0: 7465 203d 3d20 226d 656d 6f72 7922 3a0a  te == "memory":.
+0004e2f0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+0004e300: 7274 2074 732e 7768 6f5f 6861 730a 2020  rt ts.who_has.  
+0004e310: 2020 2020 2020 2020 2020 6173 7365 7274            assert
+0004e320: 2073 756d 2874 7320 696e 2077 732e 6163   sum(ts in ws.ac
+0004e330: 746f 7273 2066 6f72 2077 7320 696e 2074  tors for ws in t
+0004e340: 732e 7768 6f5f 6861 7329 203d 3d20 310a  s.who_has) == 1.
+0004e350: 2020 2020 2020 2020 6966 2074 732e 7374          if ts.st
+0004e360: 6174 6520 3d3d 2022 7072 6f63 6573 7369  ate == "processi
+0004e370: 6e67 223a 0a20 2020 2020 2020 2020 2020  ng":.           
+0004e380: 2061 7373 6572 7420 7473 2e70 726f 6365   assert ts.proce
+0004e390: 7373 696e 675f 6f6e 0a20 2020 2020 2020  ssing_on.       
+0004e3a0: 2020 2020 2061 7373 6572 7420 7473 2069       assert ts i
+0004e3b0: 6e20 7473 2e70 726f 6365 7373 696e 675f  n ts.processing_
+0004e3c0: 6f6e 2e61 6374 6f72 730a 2020 2020 2020  on.actors.      
+0004e3d0: 2020 6173 7365 7274 2074 732e 7374 6174    assert ts.stat
+0004e3e0: 6520 213d 2022 7175 6575 6564 220a 0a0a  e != "queued"...
+0004e3f0: 6465 6620 7661 6c69 6461 7465 5f77 6f72  def validate_wor
+0004e400: 6b65 725f 7374 6174 6528 7773 3a20 576f  ker_state(ws: Wo
+0004e410: 726b 6572 5374 6174 6529 202d 3e20 4e6f  rkerState) -> No
+0004e420: 6e65 3a0a 2020 2020 666f 7220 7473 2069  ne:.    for ts i
+0004e430: 6e20 7773 2e68 6173 5f77 6861 7420 6f72  n ws.has_what or
+0004e440: 2028 293a 0a20 2020 2020 2020 2061 7373   ():.        ass
+0004e450: 6572 7420 7473 2e77 686f 5f68 6173 0a20  ert ts.who_has. 
+0004e460: 2020 2020 2020 2061 7373 6572 7420 7773         assert ws
+0004e470: 2069 6e20 7473 2e77 686f 5f68 6173 2c20   in ts.who_has, 
+0004e480: 280a 2020 2020 2020 2020 2020 2020 226e  (.            "n
+0004e490: 6f74 2069 6e20 6861 735f 7768 6174 2720  ot in has_what' 
+0004e4a0: 7768 6f5f 6861 7322 2c0a 2020 2020 2020  who_has",.      
+0004e4b0: 2020 2020 2020 7374 7228 7773 292c 0a20        str(ws),. 
+0004e4c0: 2020 2020 2020 2020 2020 2073 7472 2874             str(t
+0004e4d0: 7329 2c0a 2020 2020 2020 2020 2020 2020  s),.            
+0004e4e0: 7374 7228 7473 2e77 686f 5f68 6173 292c  str(ts.who_has),
+0004e4f0: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+0004e500: 666f 7220 7473 2069 6e20 7773 2e61 6374  for ts in ws.act
+0004e510: 6f72 733a 0a20 2020 2020 2020 2061 7373  ors:.        ass
+0004e520: 6572 7420 7473 2e73 7461 7465 2069 6e20  ert ts.state in 
+0004e530: 2822 6d65 6d6f 7279 222c 2022 7072 6f63  ("memory", "proc
+0004e540: 6573 7369 6e67 2229 0a0a 0a64 6566 2076  essing")...def v
+0004e550: 616c 6964 6174 655f 7374 6174 6528 0a20  alidate_state(. 
+0004e560: 2020 2074 6173 6b73 3a20 6469 6374 5b4b     tasks: dict[K
+0004e570: 6579 2c20 5461 736b 5374 6174 655d 2c0a  ey, TaskState],.
+0004e580: 2020 2020 776f 726b 6572 733a 2064 6963      workers: dic
+0004e590: 745b 7374 722c 2057 6f72 6b65 7253 7461  t[str, WorkerSta
+0004e5a0: 7465 5d2c 0a20 2020 2063 6c69 656e 7473  te],.    clients
+0004e5b0: 3a20 6469 6374 5b73 7472 2c20 436c 6965  : dict[str, Clie
+0004e5c0: 6e74 5374 6174 655d 2c0a 2920 2d3e 204e  ntState],.) -> N
+0004e5d0: 6f6e 653a 0a20 2020 2022 2222 5661 6c69  one:.    """Vali
+0004e5e0: 6461 7465 2061 2063 7572 7265 6e74 2072  date a current r
+0004e5f0: 756e 7469 6d65 2073 7461 7465 2e0a 0a20  untime state... 
+0004e600: 2020 2054 6869 7320 7065 7266 6f72 6d73     This performs
+0004e610: 2061 2073 6571 7565 6e63 6520 6f66 2063   a sequence of c
+0004e620: 6865 636b 7320 6f6e 2074 6865 2065 6e74  hecks on the ent
+0004e630: 6972 6520 6772 6170 682c 2072 756e 6e69  ire graph, runni
+0004e640: 6e67 2069 6e20 6162 6f75 7420 6c69 6e65  ng in about line
+0004e650: 6172 0a20 2020 2074 696d 652e 2054 6869  ar.    time. Thi
+0004e660: 7320 7261 6973 6573 2061 7373 6572 7420  s raises assert 
+0004e670: 6572 726f 7273 2069 6620 616e 7974 6869  errors if anythi
+0004e680: 6e67 2064 6f65 736e 2774 2063 6865 636b  ng doesn't check
+0004e690: 206f 7574 2e0a 2020 2020 2222 220a 2020   out..    """.  
+0004e6a0: 2020 666f 7220 7473 2069 6e20 7461 736b    for ts in task
+0004e6b0: 732e 7661 6c75 6573 2829 3a0a 2020 2020  s.values():.    
+0004e6c0: 2020 2020 7661 6c69 6461 7465 5f74 6173      validate_tas
+0004e6d0: 6b5f 7374 6174 6528 7473 290a 0a20 2020  k_state(ts)..   
+0004e6e0: 2066 6f72 2077 7320 696e 2077 6f72 6b65   for ws in worke
+0004e6f0: 7273 2e76 616c 7565 7328 293a 0a20 2020  rs.values():.   
+0004e700: 2020 2020 2076 616c 6964 6174 655f 776f       validate_wo
+0004e710: 726b 6572 5f73 7461 7465 2877 7329 0a0a  rker_state(ws)..
+0004e720: 2020 2020 666f 7220 6373 2069 6e20 636c      for cs in cl
+0004e730: 6965 6e74 732e 7661 6c75 6573 2829 3a0a  ients.values():.
+0004e740: 2020 2020 2020 2020 666f 7220 7473 2069          for ts i
+0004e750: 6e20 6373 2e77 616e 7473 5f77 6861 7420  n cs.wants_what 
+0004e760: 6f72 2028 293a 0a20 2020 2020 2020 2020  or ():.         
+0004e770: 2020 2061 7373 6572 7420 7473 2e77 686f     assert ts.who
+0004e780: 5f77 616e 7473 0a20 2020 2020 2020 2020  _wants.         
+0004e790: 2020 2061 7373 6572 7420 6373 2069 6e20     assert cs in 
+0004e7a0: 7473 2e77 686f 5f77 616e 7473 2c20 280a  ts.who_wants, (.
+0004e7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e7c0: 226e 6f74 2069 6e20 7761 6e74 735f 7768  "not in wants_wh
+0004e7d0: 6174 2720 7768 6f5f 7761 6e74 7322 2c0a  at' who_wants",.
+0004e7e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004e7f0: 7374 7228 6373 292c 0a20 2020 2020 2020  str(cs),.       
+0004e800: 2020 2020 2020 2020 2073 7472 2874 7329           str(ts)
+0004e810: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0004e820: 2020 7374 7228 7473 2e77 686f 5f77 616e    str(ts.who_wan
+0004e830: 7473 292c 0a20 2020 2020 2020 2020 2020  ts),.           
+0004e840: 2029 0a0a 0a64 6566 2068 6561 7274 6265   )...def heartbe
+0004e850: 6174 5f69 6e74 6572 7661 6c28 6e3a 2069  at_interval(n: i
+0004e860: 6e74 2920 2d3e 2066 6c6f 6174 3a0a 2020  nt) -> float:.  
+0004e870: 2020 2222 2249 6e74 6572 7661 6c20 696e    """Interval in
+0004e880: 2073 6563 6f6e 6473 2074 6861 7420 7765   seconds that we
+0004e890: 2064 6573 6972 6520 6865 6172 7462 6561   desire heartbea
+0004e8a0: 7473 2062 6173 6564 206f 6e20 6e75 6d62  ts based on numb
+0004e8b0: 6572 206f 6620 776f 726b 6572 7322 2222  er of workers"""
+0004e8c0: 0a20 2020 2069 6620 6e20 3c3d 2031 303a  .    if n <= 10:
+0004e8d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0004e8e0: 302e 350a 2020 2020 656c 6966 206e 203c  0.5.    elif n <
+0004e8f0: 2035 303a 0a20 2020 2020 2020 2072 6574   50:.        ret
+0004e900: 7572 6e20 310a 2020 2020 656c 6966 206e  urn 1.    elif n
+0004e910: 203c 2032 3030 3a0a 2020 2020 2020 2020   < 200:.        
+0004e920: 7265 7475 726e 2032 0a20 2020 2065 6c73  return 2.    els
+0004e930: 653a 0a20 2020 2020 2020 2023 204e 6f20  e:.        # No 
+0004e940: 6d6f 7265 2074 6861 6e20 3230 3020 6865  more than 200 he
+0004e950: 6172 7462 6561 7473 2061 2073 6563 6f6e  artbeats a secon
+0004e960: 6420 7363 616c 6564 2062 7920 776f 726b  d scaled by work
+0004e970: 6572 730a 2020 2020 2020 2020 7265 7475  ers.        retu
+0004e980: 726e 206e 202f 2032 3030 202b 2031 0a0a  rn n / 200 + 1..
+0004e990: 0a64 6566 205f 7461 736b 5f73 6c6f 7473  .def _task_slots
+0004e9a0: 5f61 7661 696c 6162 6c65 2877 733a 2057  _available(ws: W
+0004e9b0: 6f72 6b65 7253 7461 7465 2c20 7361 7475  orkerState, satu
+0004e9c0: 7261 7469 6f6e 5f66 6163 746f 723a 2066  ration_factor: f
+0004e9d0: 6c6f 6174 2920 2d3e 2069 6e74 3a0a 2020  loat) -> int:.  
+0004e9e0: 2020 2222 224e 756d 6265 7220 6f66 2074    """Number of t
+0004e9f0: 6173 6b73 2074 6861 7420 6361 6e20 6265  asks that can be
+0004ea00: 2073 656e 7420 746f 2074 6869 7320 776f   sent to this wo
+0004ea10: 726b 6572 2077 6974 686f 7574 206f 7665  rker without ove
+0004ea20: 7273 6174 7572 6174 696e 6720 6974 2222  rsaturating it""
+0004ea30: 220a 2020 2020 6173 7365 7274 206e 6f74  ".    assert not
+0004ea40: 206d 6174 682e 6973 696e 6628 7361 7475   math.isinf(satu
+0004ea50: 7261 7469 6f6e 5f66 6163 746f 7229 0a20  ration_factor). 
+0004ea60: 2020 2072 6574 7572 6e20 6d61 7828 6d61     return max(ma
+0004ea70: 7468 2e63 6569 6c28 7361 7475 7261 7469  th.ceil(saturati
+0004ea80: 6f6e 5f66 6163 746f 7220 2a20 7773 2e6e  on_factor * ws.n
+0004ea90: 7468 7265 6164 7329 2c20 3129 202d 2028  threads), 1) - (
+0004eaa0: 0a20 2020 2020 2020 206c 656e 2877 732e  .        len(ws.
+0004eab0: 7072 6f63 6573 7369 6e67 2920 2d20 6c65  processing) - le
+0004eac0: 6e28 7773 2e6c 6f6e 675f 7275 6e6e 696e  n(ws.long_runnin
+0004ead0: 6729 0a20 2020 2029 0a0a 0a64 6566 205f  g).    )...def _
+0004eae0: 776f 726b 6572 5f66 756c 6c28 7773 3a20  worker_full(ws: 
+0004eaf0: 576f 726b 6572 5374 6174 652c 2073 6174  WorkerState, sat
+0004eb00: 7572 6174 696f 6e5f 6661 6374 6f72 3a20  uration_factor: 
+0004eb10: 666c 6f61 7429 202d 3e20 626f 6f6c 3a0a  float) -> bool:.
+0004eb20: 2020 2020 6966 206d 6174 682e 6973 696e      if math.isin
+0004eb30: 6628 7361 7475 7261 7469 6f6e 5f66 6163  f(saturation_fac
+0004eb40: 746f 7229 3a0a 2020 2020 2020 2020 7265  tor):.        re
+0004eb50: 7475 726e 2046 616c 7365 0a20 2020 2072  turn False.    r
+0004eb60: 6574 7572 6e20 5f74 6173 6b5f 736c 6f74  eturn _task_slot
+0004eb70: 735f 6176 6169 6c61 626c 6528 7773 2c20  s_available(ws, 
+0004eb80: 7361 7475 7261 7469 6f6e 5f66 6163 746f  saturation_facto
+0004eb90: 7229 203c 3d20 300a 0a0a 636c 6173 7320  r) <= 0...class 
+0004eba0: 4b69 6c6c 6564 576f 726b 6572 2845 7863  KilledWorker(Exc
+0004ebb0: 6570 7469 6f6e 293a 0a20 2020 2064 6566  eption):.    def
+0004ebc0: 205f 5f69 6e69 745f 5f28 7365 6c66 2c20   __init__(self, 
+0004ebd0: 7461 736b 3a20 4b65 792c 206c 6173 745f  task: Key, last_
+0004ebe0: 776f 726b 6572 3a20 576f 726b 6572 5374  worker: WorkerSt
+0004ebf0: 6174 652c 2061 6c6c 6f77 6564 5f66 6169  ate, allowed_fai
+0004ec00: 6c75 7265 733a 2069 6e74 293a 0a20 2020  lures: int):.   
+0004ec10: 2020 2020 2073 7570 6572 2829 2e5f 5f69       super().__i
+0004ec20: 6e69 745f 5f28 7461 736b 2c20 6c61 7374  nit__(task, last
+0004ec30: 5f77 6f72 6b65 722c 2061 6c6c 6f77 6564  _worker, allowed
+0004ec40: 5f66 6169 6c75 7265 7329 0a0a 2020 2020  _failures)..    
+0004ec50: 4070 726f 7065 7274 790a 2020 2020 6465  @property.    de
+0004ec60: 6620 7461 736b 2873 656c 6629 202d 3e20  f task(self) -> 
+0004ec70: 4b65 793a 0a20 2020 2020 2020 2072 6574  Key:.        ret
+0004ec80: 7572 6e20 7365 6c66 2e61 7267 735b 305d  urn self.args[0]
+0004ec90: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+0004eca0: 2020 2020 6465 6620 6c61 7374 5f77 6f72      def last_wor
+0004ecb0: 6b65 7228 7365 6c66 2920 2d3e 2057 6f72  ker(self) -> Wor
+0004ecc0: 6b65 7253 7461 7465 3a0a 2020 2020 2020  kerState:.      
+0004ecd0: 2020 7265 7475 726e 2073 656c 662e 6172    return self.ar
+0004ece0: 6773 5b31 5d0a 0a20 2020 2040 7072 6f70  gs[1]..    @prop
+0004ecf0: 6572 7479 0a20 2020 2064 6566 2061 6c6c  erty.    def all
+0004ed00: 6f77 6564 5f66 6169 6c75 7265 7328 7365  owed_failures(se
+0004ed10: 6c66 2920 2d3e 2069 6e74 3a0a 2020 2020  lf) -> int:.    
+0004ed20: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0004ed30: 6172 6773 5b32 5d0a 0a20 2020 2064 6566  args[2]..    def
+0004ed40: 205f 5f73 7472 5f5f 2873 656c 6629 202d   __str__(self) -
+0004ed50: 3e20 7374 723a 0a20 2020 2020 2020 2072  > str:.        r
+0004ed60: 6574 7572 6e20 280a 2020 2020 2020 2020  eturn (.        
+0004ed70: 2020 2020 6622 4174 7465 6d70 7465 6420      f"Attempted 
+0004ed80: 746f 2072 756e 2074 6173 6b20 7b73 656c  to run task {sel
+0004ed90: 662e 7461 736b 2172 7d20 6f6e 207b 7365  f.task!r} on {se
+0004eda0: 6c66 2e61 6c6c 6f77 6564 5f66 6169 6c75  lf.allowed_failu
+0004edb0: 7265 7320 2b20 317d 2022 0a20 2020 2020  res + 1} ".     
+0004edc0: 2020 2020 2020 2022 6469 6666 6572 656e         "differen
+0004edd0: 7420 776f 726b 6572 732c 2062 7574 2061  t workers, but a
+0004ede0: 6c6c 2074 686f 7365 2077 6f72 6b65 7273  ll those workers
+0004edf0: 2064 6965 6420 7768 696c 6520 7275 6e6e   died while runn
+0004ee00: 696e 6720 6974 2e20 220a 2020 2020 2020  ing it. ".      
+0004ee10: 2020 2020 2020 6622 5468 6520 6c61 7374        f"The last
+0004ee20: 2077 6f72 6b65 7220 7468 6174 2061 7474   worker that att
+0004ee30: 656d 7074 2074 6f20 7275 6e20 7468 6520  empt to run the 
+0004ee40: 7461 736b 2077 6173 207b 7365 6c66 2e6c  task was {self.l
+0004ee50: 6173 745f 776f 726b 6572 2e61 6464 7265  ast_worker.addre
+0004ee60: 7373 7d2e 2022 0a20 2020 2020 2020 2020  ss}. ".         
+0004ee70: 2020 2022 496e 7370 6563 7469 6e67 2077     "Inspecting w
+0004ee80: 6f72 6b65 7220 6c6f 6773 2069 7320 6f66  orker logs is of
+0004ee90: 7465 6e20 6120 676f 6f64 206e 6578 7420  ten a good next 
+0004eea0: 7374 6570 2074 6f20 6469 6167 6e6f 7365  step to diagnose
+0004eeb0: 2077 6861 7420 7765 6e74 2077 726f 6e67   what went wrong
+0004eec0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
+0004eed0: 2246 6f72 206d 6f72 6520 696e 666f 726d  "For more inform
+0004eee0: 6174 696f 6e20 7365 6520 6874 7470 733a  ation see https:
+0004eef0: 2f2f 6469 7374 7269 6275 7465 642e 6461  //distributed.da
+0004ef00: 736b 2e6f 7267 2f65 6e2f 7374 6162 6c65  sk.org/en/stable
+0004ef10: 2f6b 696c 6c65 642e 6874 6d6c 2e22 0a20  /killed.html.". 
+0004ef20: 2020 2020 2020 2029 0a0a 0a63 6c61 7373         )...class
+0004ef30: 2057 6f72 6b65 7253 7461 7475 7350 6c75   WorkerStatusPlu
+0004ef40: 6769 6e28 5363 6865 6475 6c65 7250 6c75  gin(SchedulerPlu
+0004ef50: 6769 6e29 3a0a 2020 2020 2222 2241 2070  gin):.    """A p
+0004ef60: 6c75 6769 6e20 746f 2073 6861 7265 2077  lugin to share w
+0004ef70: 6f72 6b65 7220 7374 6174 7573 2077 6974  orker status wit
+0004ef80: 6820 6120 7265 6d6f 7465 206f 6273 6572  h a remote obser
+0004ef90: 7665 720a 0a20 2020 2054 6869 7320 6973  ver..    This is
+0004efa0: 2075 7365 6420 696e 2063 6c75 7374 6572   used in cluster
+0004efb0: 206d 616e 6167 6572 7320 746f 206b 6565   managers to kee
+0004efc0: 7020 7570 6461 7465 6420 6162 6f75 7420  p updated about 
+0004efd0: 7468 6520 7374 6174 7573 206f 6620 7468  the status of th
+0004efe0: 6520 7363 6865 6475 6c65 722e 0a20 2020  e scheduler..   
+0004eff0: 2022 2222 0a0a 2020 2020 6e61 6d65 3a20   """..    name: 
+0004f000: 436c 6173 7356 6172 5b73 7472 5d20 3d20  ClassVar[str] = 
+0004f010: 2277 6f72 6b65 722d 7374 6174 7573 220a  "worker-status".
+0004f020: 2020 2020 6263 6f6d 6d3a 2042 6174 6368      bcomm: Batch
+0004f030: 6564 5365 6e64 0a0a 2020 2020 6465 6620  edSend..    def 
+0004f040: 5f5f 696e 6974 5f5f 2873 656c 662c 2073  __init__(self, s
+0004f050: 6368 6564 756c 6572 3a20 5363 6865 6475  cheduler: Schedu
+0004f060: 6c65 722c 2063 6f6d 6d3a 2043 6f6d 6d29  ler, comm: Comm)
+0004f070: 3a0a 2020 2020 2020 2020 7365 6c66 2e62  :.        self.b
+0004f080: 636f 6d6d 203d 2042 6174 6368 6564 5365  comm = BatchedSe
+0004f090: 6e64 2869 6e74 6572 7661 6c3d 2235 6d73  nd(interval="5ms
+0004f0a0: 2229 0a20 2020 2020 2020 2073 656c 662e  ").        self.
+0004f0b0: 6263 6f6d 6d2e 7374 6172 7428 636f 6d6d  bcomm.start(comm
+0004f0c0: 290a 2020 2020 2020 2020 7363 6865 6475  ).        schedu
+0004f0d0: 6c65 722e 6164 645f 706c 7567 696e 2873  ler.add_plugin(s
+0004f0e0: 656c 6629 0a0a 2020 2020 6465 6620 6164  elf)..    def ad
+0004f0f0: 645f 776f 726b 6572 2873 656c 662c 2073  d_worker(self, s
+0004f100: 6368 6564 756c 6572 3a20 5363 6865 6475  cheduler: Schedu
+0004f110: 6c65 722c 2077 6f72 6b65 723a 2073 7472  ler, worker: str
+0004f120: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+0004f130: 2020 2069 6465 6e74 203d 2073 6368 6564     ident = sched
+0004f140: 756c 6572 2e77 6f72 6b65 7273 5b77 6f72  uler.workers[wor
+0004f150: 6b65 725d 2e69 6465 6e74 6974 7928 290a  ker].identity().
+0004f160: 2020 2020 2020 2020 6465 6c20 6964 656e          del iden
+0004f170: 745b 226d 6574 7269 6373 225d 0a20 2020  t["metrics"].   
+0004f180: 2020 2020 2064 656c 2069 6465 6e74 5b22       del ident["
+0004f190: 6c61 7374 5f73 6565 6e22 5d0a 2020 2020  last_seen"].    
+0004f1a0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0004f1b0: 2020 2020 2073 656c 662e 6263 6f6d 6d2e       self.bcomm.
+0004f1c0: 7365 6e64 285b 2261 6464 222c 207b 2277  send(["add", {"w
+0004f1d0: 6f72 6b65 7273 223a 207b 776f 726b 6572  orkers": {worker
+0004f1e0: 3a20 6964 656e 747d 7d5d 290a 2020 2020  : ident}}]).    
+0004f1f0: 2020 2020 6578 6365 7074 2043 6f6d 6d43      except CommC
+0004f200: 6c6f 7365 6445 7272 6f72 3a0a 2020 2020  losedError:.    
+0004f210: 2020 2020 2020 2020 7363 6865 6475 6c65          schedule
+0004f220: 722e 7265 6d6f 7665 5f70 6c75 6769 6e28  r.remove_plugin(
+0004f230: 6e61 6d65 3d73 656c 662e 6e61 6d65 290a  name=self.name).
+0004f240: 0a20 2020 2064 6566 2072 656d 6f76 655f  .    def remove_
+0004f250: 776f 726b 6572 2873 656c 662c 2073 6368  worker(self, sch
+0004f260: 6564 756c 6572 3a20 5363 6865 6475 6c65  eduler: Schedule
+0004f270: 722c 2077 6f72 6b65 723a 2073 7472 2c20  r, worker: str, 
+0004f280: 2a2a 6b77 6172 6773 3a20 416e 7929 202d  **kwargs: Any) -
+0004f290: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+0004f2a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0004f2b0: 2073 656c 662e 6263 6f6d 6d2e 7365 6e64   self.bcomm.send
+0004f2c0: 285b 2272 656d 6f76 6522 2c20 776f 726b  (["remove", work
+0004f2d0: 6572 5d29 0a20 2020 2020 2020 2065 7863  er]).        exc
+0004f2e0: 6570 7420 436f 6d6d 436c 6f73 6564 4572  ept CommClosedEr
+0004f2f0: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0004f300: 2073 6368 6564 756c 6572 2e72 656d 6f76   scheduler.remov
+0004f310: 655f 706c 7567 696e 286e 616d 653d 7365  e_plugin(name=se
+0004f320: 6c66 2e6e 616d 6529 0a0a 2020 2020 6465  lf.name)..    de
+0004f330: 6620 7465 6172 646f 776e 2873 656c 6629  f teardown(self)
+0004f340: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0004f350: 2020 7365 6c66 2e62 636f 6d6d 2e63 6c6f    self.bcomm.clo
+0004f360: 7365 2829 0a0a 0a63 6c61 7373 2043 6f6c  se()...class Col
+0004f370: 6c65 6374 5461 736b 4d65 7461 4461 7461  lectTaskMetaData
+0004f380: 506c 7567 696e 2853 6368 6564 756c 6572  Plugin(Scheduler
+0004f390: 506c 7567 696e 293a 0a20 2020 2073 6368  Plugin):.    sch
+0004f3a0: 6564 756c 6572 3a20 5363 6865 6475 6c65  eduler: Schedule
+0004f3b0: 720a 2020 2020 6e61 6d65 3a20 7374 720a  r.    name: str.
+0004f3c0: 2020 2020 6b65 7973 3a20 7365 745b 4b65      keys: set[Ke
+0004f3d0: 795d 0a20 2020 206d 6574 6164 6174 613a  y].    metadata:
+0004f3e0: 2064 6963 745b 4b65 792c 2041 6e79 5d0a   dict[Key, Any].
+0004f3f0: 2020 2020 7374 6174 653a 2064 6963 745b      state: dict[
+0004f400: 4b65 792c 2054 6173 6b53 7461 7465 5374  Key, TaskStateSt
+0004f410: 6174 655d 0a0a 2020 2020 6465 6620 5f5f  ate]..    def __
+0004f420: 696e 6974 5f5f 2873 656c 662c 2073 6368  init__(self, sch
+0004f430: 6564 756c 6572 3a20 5363 6865 6475 6c65  eduler: Schedule
+0004f440: 722c 206e 616d 653a 2073 7472 293a 0a20  r, name: str):. 
+0004f450: 2020 2020 2020 2073 656c 662e 7363 6865         self.sche
+0004f460: 6475 6c65 7220 3d20 7363 6865 6475 6c65  duler = schedule
+0004f470: 720a 2020 2020 2020 2020 7365 6c66 2e6e  r.        self.n
+0004f480: 616d 6520 3d20 6e61 6d65 0a20 2020 2020  ame = name.     
+0004f490: 2020 2073 656c 662e 6b65 7973 203d 2073     self.keys = s
+0004f4a0: 6574 2829 0a20 2020 2020 2020 2073 656c  et().        sel
+0004f4b0: 662e 6d65 7461 6461 7461 203d 207b 7d0a  f.metadata = {}.
+0004f4c0: 2020 2020 2020 2020 7365 6c66 2e73 7461          self.sta
+0004f4d0: 7465 203d 207b 7d0a 0a20 2020 2064 6566  te = {}..    def
+0004f4e0: 2075 7064 6174 655f 6772 6170 6828 0a20   update_graph(. 
+0004f4f0: 2020 2020 2020 2073 656c 662c 0a20 2020         self,.   
+0004f500: 2020 2020 2073 6368 6564 756c 6572 3a20       scheduler: 
+0004f510: 5363 6865 6475 6c65 722c 0a20 2020 2020  Scheduler,.     
+0004f520: 2020 202a 2c0a 2020 2020 2020 2020 6b65     *,.        ke
+0004f530: 7973 3a20 7365 745b 4b65 795d 2c0a 2020  ys: set[Key],.  
+0004f540: 2020 2020 2020 2a2a 6b77 6172 6773 3a20        **kwargs: 
+0004f550: 416e 792c 0a20 2020 2029 202d 3e20 4e6f  Any,.    ) -> No
+0004f560: 6e65 3a0a 2020 2020 2020 2020 7365 6c66  ne:.        self
+0004f570: 2e6b 6579 732e 7570 6461 7465 286b 6579  .keys.update(key
+0004f580: 7329 0a0a 2020 2020 6465 6620 7472 616e  s)..    def tran
+0004f590: 7369 7469 6f6e 280a 2020 2020 2020 2020  sition(.        
+0004f5a0: 7365 6c66 2c0a 2020 2020 2020 2020 6b65  self,.        ke
+0004f5b0: 793a 204b 6579 2c0a 2020 2020 2020 2020  y: Key,.        
+0004f5c0: 7374 6172 743a 2054 6173 6b53 7461 7465  start: TaskState
+0004f5d0: 5374 6174 652c 0a20 2020 2020 2020 2066  State,.        f
+0004f5e0: 696e 6973 683a 2054 6173 6b53 7461 7465  inish: TaskState
+0004f5f0: 5374 6174 652c 0a20 2020 2020 2020 202a  State,.        *
+0004f600: 6172 6773 3a20 416e 792c 0a20 2020 2020  args: Any,.     
+0004f610: 2020 202a 2a6b 7761 7267 733a 2041 6e79     **kwargs: Any
+0004f620: 2c0a 2020 2020 2920 2d3e 204e 6f6e 653a  ,.    ) -> None:
+0004f630: 0a20 2020 2020 2020 2069 6620 6669 6e69  .        if fini
+0004f640: 7368 2069 6e20 2822 6d65 6d6f 7279 222c  sh in ("memory",
+0004f650: 2022 6572 7265 6422 293a 0a20 2020 2020   "erred"):.     
+0004f660: 2020 2020 2020 2074 7320 3d20 7365 6c66         ts = self
+0004f670: 2e73 6368 6564 756c 6572 2e74 6173 6b73  .scheduler.tasks
+0004f680: 2e67 6574 286b 6579 290a 2020 2020 2020  .get(key).      
+0004f690: 2020 2020 2020 6966 2074 7320 6973 206e        if ts is n
+0004f6a0: 6f74 204e 6f6e 6520 616e 6420 7473 2e6b  ot None and ts.k
+0004f6b0: 6579 2069 6e20 7365 6c66 2e6b 6579 733a  ey in self.keys:
+0004f6c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004f6d0: 2073 656c 662e 6d65 7461 6461 7461 5b6b   self.metadata[k
+0004f6e0: 6579 5d20 3d20 7473 2e6d 6574 6164 6174  ey] = ts.metadat
+0004f6f0: 610a 2020 2020 2020 2020 2020 2020 2020  a.              
+0004f700: 2020 7365 6c66 2e73 7461 7465 5b6b 6579    self.state[key
+0004f710: 5d20 3d20 6669 6e69 7368 0a20 2020 2020  ] = finish.     
+0004f720: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0004f730: 6b65 7973 2e64 6973 6361 7264 286b 6579  keys.discard(key
+0004f740: 290a 0a0a 6465 6620 5f6d 6174 6572 6961  )...def _materia
+0004f750: 6c69 7a65 5f67 7261 7068 280a 2020 2020  lize_graph(.    
+0004f760: 6772 6170 683a 2048 6967 684c 6576 656c  graph: HighLevel
+0004f770: 4772 6170 682c 2067 6c6f 6261 6c5f 616e  Graph, global_an
+0004f780: 6e6f 7461 7469 6f6e 733a 2064 6963 745b  notations: dict[
+0004f790: 7374 722c 2041 6e79 5d0a 2920 2d3e 2074  str, Any].) -> t
+0004f7a0: 7570 6c65 5b64 6963 745b 4b65 792c 2054  uple[dict[Key, T
+0004f7b0: 5f72 756e 7370 6563 5d2c 2064 6963 745b  _runspec], dict[
+0004f7c0: 4b65 792c 2073 6574 5b4b 6579 5d5d 2c20  Key, set[Key]], 
+0004f7d0: 6469 6374 5b73 7472 2c20 6469 6374 5b4b  dict[str, dict[K
+0004f7e0: 6579 2c20 416e 795d 5d5d 3a0a 2020 2020  ey, Any]]]:.    
+0004f7f0: 6473 6b20 3d20 656e 7375 7265 5f64 6963  dsk = ensure_dic
+0004f800: 7428 6772 6170 6829 0a20 2020 2066 6f72  t(graph).    for
+0004f810: 206b 2069 6e20 6473 6b3a 0a20 2020 2020   k in dsk:.     
+0004f820: 2020 2076 616c 6964 6174 655f 6b65 7928     validate_key(
+0004f830: 6b29 0a20 2020 2061 6e6e 6f74 6174 696f  k).    annotatio
+0004f840: 6e73 5f62 795f 7479 7065 3a20 6465 6661  ns_by_type: defa
+0004f850: 756c 7464 6963 745b 7374 722c 2064 6963  ultdict[str, dic
+0004f860: 745b 4b65 792c 2041 6e79 5d5d 203d 2064  t[Key, Any]] = d
+0004f870: 6566 6175 6c74 6469 6374 2864 6963 7429  efaultdict(dict)
+0004f880: 0a20 2020 2066 6f72 2061 6e6e 6f74 6174  .    for annotat
+0004f890: 696f 6e73 5f74 7970 652c 2076 616c 7565  ions_type, value
+0004f8a0: 2069 6e20 676c 6f62 616c 5f61 6e6e 6f74   in global_annot
+0004f8b0: 6174 696f 6e73 2e69 7465 6d73 2829 3a0a  ations.items():.
+0004f8c0: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
+0004f8d0: 6f6e 735f 6279 5f74 7970 655b 616e 6e6f  ons_by_type[anno
+0004f8e0: 7461 7469 6f6e 735f 7479 7065 5d2e 7570  tations_type].up
+0004f8f0: 6461 7465 280a 2020 2020 2020 2020 2020  date(.          
+0004f900: 2020 7b6b 3a20 2876 616c 7565 286b 2920    {k: (value(k) 
+0004f910: 6966 2063 616c 6c61 626c 6528 7661 6c75  if callable(valu
+0004f920: 6529 2065 6c73 6520 7661 6c75 6529 2066  e) else value) f
+0004f930: 6f72 206b 2069 6e20 6473 6b7d 0a20 2020  or k in dsk}.   
+0004f940: 2020 2020 2029 0a0a 2020 2020 666f 7220       )..    for 
+0004f950: 6c61 7965 7220 696e 2067 7261 7068 2e6c  layer in graph.l
+0004f960: 6179 6572 732e 7661 6c75 6573 2829 3a0a  ayers.values():.
+0004f970: 2020 2020 2020 2020 6966 206c 6179 6572          if layer
+0004f980: 2e61 6e6e 6f74 6174 696f 6e73 3a0a 2020  .annotations:.  
+0004f990: 2020 2020 2020 2020 2020 616e 6e6f 7420            annot 
+0004f9a0: 3d20 6c61 7965 722e 616e 6e6f 7461 7469  = layer.annotati
+0004f9b0: 6f6e 730a 2020 2020 2020 2020 2020 2020  ons.            
+0004f9c0: 666f 7220 616e 6e6f 745f 7479 7065 2c20  for annot_type, 
+0004f9d0: 7661 6c75 6520 696e 2061 6e6e 6f74 2e69  value in annot.i
+0004f9e0: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+0004f9f0: 2020 2020 2020 2020 616e 6e6f 7461 7469          annotati
+0004fa00: 6f6e 735f 6279 5f74 7970 655b 616e 6e6f  ons_by_type[anno
+0004fa10: 745f 7479 7065 5d2e 7570 6461 7465 280a  t_type].update(.
+0004fa20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0004fa30: 2020 2020 7b6b 3a20 2876 616c 7565 286b      {k: (value(k
+0004fa40: 2920 6966 2063 616c 6c61 626c 6528 7661  ) if callable(va
+0004fa50: 6c75 6529 2065 6c73 6520 7661 6c75 6529  lue) else value)
+0004fa60: 2066 6f72 206b 2069 6e20 6c61 7965 727d   for k in layer}
+0004fa70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0004fa80: 2029 0a20 2020 2064 6570 656e 6465 6e63   ).    dependenc
+0004fa90: 6965 732c 205f 203d 2067 6574 5f64 6570  ies, _ = get_dep
+0004faa0: 7328 6473 6b29 0a0a 2020 2020 2320 5265  s(dsk)..    # Re
+0004fab0: 6d6f 7665 2060 4675 7475 7265 6020 6f62  move `Future` ob
+0004fac0: 6a65 6374 7320 6672 6f6d 2067 7261 7068  jects from graph
+0004fad0: 2061 6e64 206e 6f74 6520 616e 7920 6675   and note any fu
+0004fae0: 7475 7265 2064 6570 656e 6465 6e63 6965  ture dependencie
+0004faf0: 730a 2020 2020 6473 6b32 203d 207b 7d0a  s.    dsk2 = {}.
+0004fb00: 2020 2020 6675 745f 6465 7073 203d 207b      fut_deps = {
+0004fb10: 7d0a 2020 2020 666f 7220 6b2c 2076 2069  }.    for k, v i
+0004fb20: 6e20 6473 6b2e 6974 656d 7328 293a 0a20  n dsk.items():. 
+0004fb30: 2020 2020 2020 2076 2c20 6675 7473 203d         v, futs =
+0004fb40: 2075 6e70 6163 6b5f 7265 6d6f 7465 6461   unpack_remoteda
+0004fb50: 7461 2876 2c20 6279 7465 5f6b 6579 733d  ta(v, byte_keys=
+0004fb60: 5472 7565 290a 2020 2020 2020 2020 6966  True).        if
+0004fb70: 2066 7574 733a 0a20 2020 2020 2020 2020   futs:.         
+0004fb80: 2020 2066 7574 5f64 6570 735b 6b5d 203d     fut_deps[k] =
+0004fb90: 2066 7574 730a 0a20 2020 2020 2020 2023   futs..        #
+0004fba0: 2052 656d 6f76 6520 616c 6961 7365 7320   Remove aliases 
+0004fbb0: 7b78 3a20 787d 2e0a 2020 2020 2020 2020  {x: x}..        
+0004fbc0: 2320 4649 584d 453a 2054 6869 7320 6973  # FIXME: This is
+0004fbd0: 2061 6e20 6172 7469 6661 6374 2067 656e   an artifact gen
+0004fbe0: 6572 6174 6564 2062 7920 756e 7061 636b  erated by unpack
+0004fbf0: 5f72 656d 6f74 6564 6174 6120 7768 656e  _remotedata when
+0004fc00: 2075 7369 6e67 2070 6572 7369 7374 6564   using persisted
+0004fc10: 0a20 2020 2020 2020 2023 2063 6f6c 6c65  .        # colle
+0004fc20: 6374 696f 6e73 2e20 5468 6572 6520 7368  ctions. There sh
+0004fc30: 6f75 6c64 2062 6520 6120 6265 7474 6572  ould be a better
+0004fc40: 2077 6179 2074 6f20 6163 6869 6576 6520   way to achieve 
+0004fc50: 7468 6174 2074 6173 6b73 2061 7265 206e  that tasks are n
+0004fc60: 6f74 2073 656c 660a 2020 2020 2020 2020  ot self.        
+0004fc70: 2320 7265 6665 7265 6e63 696e 6720 7468  # referencing th
+0004fc80: 656d 7365 6c76 6573 2e0a 2020 2020 2020  emselves..      
+0004fc90: 2020 6966 206e 6f74 2069 736b 6579 2876    if not iskey(v
+0004fca0: 2920 6f72 2076 2021 3d20 6b3a 0a20 2020  ) or v != k:.   
+0004fcb0: 2020 2020 2020 2020 2064 736b 325b 6b5d           dsk2[k]
+0004fcc0: 203d 2076 0a0a 2020 2020 6473 6b20 3d20   = v..    dsk = 
+0004fcd0: 6473 6b32 0a0a 2020 2020 2320 2d20 4164  dsk2..    # - Ad
+0004fce0: 6420 696e 2064 6570 7320 666f 7220 616e  d in deps for an
+0004fcf0: 7920 7461 736b 7320 7468 6174 2064 6570  y tasks that dep
+0004fd00: 656e 6420 6f6e 2066 7574 7572 6573 0a20  end on futures. 
+0004fd10: 2020 2066 6f72 206b 2c20 6675 7475 7265     for k, future
+0004fd20: 7320 696e 2066 7574 5f64 6570 732e 6974  s in fut_deps.it
+0004fd30: 656d 7328 293a 0a20 2020 2020 2020 2064  ems():.        d
+0004fd40: 6570 656e 6465 6e63 6965 735b 6b5d 2e75  ependencies[k].u
+0004fd50: 7064 6174 6528 662e 6b65 7920 666f 7220  pdate(f.key for 
+0004fd60: 6620 696e 2066 7574 7572 6573 290a 0a20  f in futures).. 
+0004fd70: 2020 2023 2052 656d 6f76 6520 616e 7920     # Remove any 
+0004fd80: 7365 6c66 2d64 6570 656e 6465 6e63 6965  self-dependencie
+0004fd90: 7320 2868 6170 7065 6e73 206f 6e20 7465  s (happens on te
+0004fda0: 7374 5f70 7562 6c69 7368 5f62 6167 2829  st_publish_bag()
+0004fdb0: 2061 6e64 206f 7468 6572 7329 0a20 2020   and others).   
+0004fdc0: 2066 6f72 206b 2c20 7620 696e 2064 6570   for k, v in dep
+0004fdd0: 656e 6465 6e63 6965 732e 6974 656d 7328  endencies.items(
+0004fde0: 293a 0a20 2020 2020 2020 2064 6570 7320  ):.        deps 
+0004fdf0: 3d20 7365 7428 7629 0a20 2020 2020 2020  = set(v).       
+0004fe00: 2064 6570 732e 6469 7363 6172 6428 6b29   deps.discard(k)
+0004fe10: 0a20 2020 2020 2020 2064 6570 656e 6465  .        depende
+0004fe20: 6e63 6965 735b 6b5d 203d 2064 6570 730a  ncies[k] = deps.
+0004fe30: 0a20 2020 2064 736b 203d 2076 616c 6d61  .    dsk = valma
+0004fe40: 7028 5f6e 6f72 6d61 6c69 7a65 5f74 6173  p(_normalize_tas
+0004fe50: 6b2c 2064 736b 290a 2020 2020 7265 7475  k, dsk).    retu
+0004fe60: 726e 2064 736b 2c20 6465 7065 6e64 656e  rn dsk, dependen
+0004fe70: 6369 6573 2c20 616e 6e6f 7461 7469 6f6e  cies, annotation
+0004fe80: 735f 6279 5f74 7970 650a                 s_by_type.
```

### Comparing `distributed-2024.3.1/distributed/security.py` & `distributed-2024.4.0/distributed/security.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/semaphore.py` & `distributed-2024.4.0/distributed/semaphore.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/__init__.py` & `distributed-2024.4.0/distributed/shuffle/__init__.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_arrow.py` & `distributed-2024.4.0/distributed/shuffle/_arrow.py`

 * *Files 5% similar despite different names*

```diff
@@ -89,15 +89,19 @@
         # meta might not be aware of the actual categories so the two dtype objects are not equal
         # Also, the categories_dtype does not properly roundtrip through Arrow
         if isinstance(actual, pd.CategoricalDtype) and isinstance(
             dtype, pd.CategoricalDtype
         ):
             continue
         reconciled_dtypes[column] = find_common_type([actual, dtype])
-    return df.astype(reconciled_dtypes, copy=False)
+
+    from dask.dataframe._compat import PANDAS_GE_300
+
+    kwargs = {} if PANDAS_GE_300 else {"copy": False}
+    return df.astype(reconciled_dtypes, **kwargs)
 
 
 def buffers_to_table(data: list[tuple[int, bytes]]) -> pa.Table:
     import numpy as np
     import pyarrow as pa
 
     """Convert a list of arrow buffers and a schema to an Arrow Table"""
```

### Comparing `distributed-2024.3.1/distributed/shuffle/_buffer.py` & `distributed-2024.4.0/distributed/shuffle/_buffer.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_comms.py` & `distributed-2024.4.0/distributed/shuffle/_comms.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_core.py` & `distributed-2024.4.0/distributed/shuffle/_core.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_disk.py` & `distributed-2024.4.0/distributed/shuffle/_disk.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_limiter.py` & `distributed-2024.4.0/distributed/shuffle/_limiter.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_memory.py` & `distributed-2024.4.0/distributed/shuffle/_memory.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_merge.py` & `distributed-2024.4.0/distributed/shuffle/_merge.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_pickle.py` & `distributed-2024.4.0/distributed/shuffle/_pickle.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_rechunk.py` & `distributed-2024.4.0/distributed/shuffle/_rechunk.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_scheduler_plugin.py` & `distributed-2024.4.0/distributed/shuffle/_scheduler_plugin.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_shuffle.py` & `distributed-2024.4.0/distributed/shuffle/_shuffle.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/shuffle/_worker_plugin.py` & `distributed-2024.4.0/distributed/shuffle/_worker_plugin.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/sizeof.py` & `distributed-2024.4.0/distributed/sizeof.py`

 * *Files 12% similar despite different names*

```diff
@@ -1,23 +1,24 @@
 from __future__ import annotations
 
 import logging
 
 from dask.sizeof import sizeof
-from dask.utils import format_bytes
+from dask.utils import format_bytes, typename
 
 logger = logging.getLogger(__name__)
 
 
 def safe_sizeof(obj: object, default_size: float = 1e6) -> int:
     """Safe variant of sizeof that captures and logs exceptions
 
     This returns a default size of 1e6 if the sizeof function fails
     """
     try:
         return sizeof(obj)
     except Exception:
         logger.warning(
-            f"Sizeof calculation failed. Defaulting to {format_bytes(int(default_size))}",
+            f"Sizeof calculation for object of type '{typename(obj)}' failed. "
+            f"Defaulting to {format_bytes(int(default_size))}",
             exc_info=True,
         )
         return int(default_size)
```

### Comparing `distributed-2024.3.1/distributed/spans.py` & `distributed-2024.4.0/distributed/spans.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/spill.py` & `distributed-2024.4.0/distributed/spill.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/stealing.py` & `distributed-2024.4.0/distributed/stealing.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/system.py` & `distributed-2024.4.0/distributed/system.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/system_monitor.py` & `distributed-2024.4.0/distributed/system_monitor.py`

 * *Files 2% similar despite different names*

```diff
@@ -125,14 +125,15 @@
         if not WINDOWS:
             self.quantities["num_fds"] = deque(maxlen=maxlen)
 
         if nvml.device_get_count() > 0:
             gpu_extra = nvml.one_time()
             self.gpu_name = gpu_extra["name"]
             self.gpu_memory_total = gpu_extra["memory-total"]
+            self.quantities["gpu-memory-total"] = deque(maxlen=1)
             self.quantities["gpu_utilization"] = deque(maxlen=maxlen)
             self.quantities["gpu_memory_used"] = deque(maxlen=maxlen)
         else:
             self.gpu_name = None
             self.gpu_memory_total = -1
 
         self.update()
@@ -203,14 +204,15 @@
 
         # Note: WINDOWS constant doesn't work with `mypy --platform win32`
         if sys.platform != "win32":
             result["num_fds"] = self.proc.num_fds()
 
         if self.gpu_name:
             gpu_metrics = nvml.real_time()
+            result["gpu-memory-total"] = self.gpu_memory_total
             result["gpu_utilization"] = gpu_metrics["utilization"]
             result["gpu_memory_used"] = gpu_metrics["memory-used"]
 
         for name, v in result.items():
             if name != "count":
                 self.quantities[name].append(v)
```

### Comparing `distributed-2024.3.1/distributed/threadpoolexecutor.py` & `distributed-2024.4.0/distributed/threadpoolexecutor.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/utils.py` & `distributed-2024.4.0/distributed/utils.py`

 * *Files 2% similar despite different names*

```diff
@@ -1837,60 +1837,81 @@
 
     return _python_shutting_down
 
 
 class Deadline:
     """Utility class tracking a deadline and the progress toward it"""
 
-    #: Expiry time of the deadline in seconds since the epoch
+    #: Expiry time of the deadline in seconds since the start of the monotonic timer
     #: or None if the deadline never expires
-    expires_at: float | None
+    expires_at_mono: float | None
     #: Seconds since the epoch when the deadline was created
+    started_at_mono: float
+    #: Seconds since the start of the monotonic timer when the deadline was created
     started_at: float
 
+    __slots__ = tuple(__annotations__)
+
     def __init__(self, expires_at: float | None = None):
-        self.expires_at = expires_at
         self.started_at = time()
+        self.started_at_mono = monotonic()
+        if expires_at is not None:
+            self.expires_at_mono = expires_at - self.started_at + self.started_at_mono
+        else:
+            self.expires_at_mono = None
 
     @classmethod
     def after(cls, duration: float | None = None) -> Deadline:
         """Create a new ``Deadline`` that expires in ``duration`` seconds
-        or never if ``duration`` is None"""
-        started_at = time()
-        expires_at = duration + started_at if duration is not None else duration
-        deadline = cls(expires_at)
-        deadline.started_at = started_at
-        return deadline
+        or never if ``duration`` is None
+        """
+        inst = cls()
+        if duration is not None:
+            inst.expires_at_mono = inst.started_at_mono + duration
+        return inst
+
+    @property
+    def expires_at(self) -> float | None:
+        """Expiry time of the deadline in seconds since the unix epoch
+        or None if the deadline never expires.
+
+        Note that this can change over time if the wall clock is adjusted by the OS.
+        """
+        if (exp := self.expires_at_mono) is None:
+            return None
+        return exp - monotonic() + time()
 
     @property
     def duration(self) -> float | None:
         """Seconds between the creation and expiration time of the deadline
-        if the deadline expires, None otherwise"""
-        if self.expires_at is None:
+        if the deadline expires, None otherwise
+        """
+        if (exp := self.expires_at_mono) is None:
             return None
-        return self.expires_at - self.started_at
+        return exp - self.started_at_mono
 
     @property
     def expires(self) -> bool:
         """Whether the deadline ever expires"""
-        return self.expires_at is not None
+        return self.expires_at_mono is not None
 
     @property
     def elapsed(self) -> float:
         """Seconds that elapsed since the deadline was created"""
-        return time() - self.started_at
+        return monotonic() - self.started_at_mono
 
     @property
     def remaining(self) -> float | None:
         """Seconds remaining until the deadline expires if an expiry time is set,
-        None otherwise"""
-        if self.expires_at is None:
+        None otherwise
+        """
+        if (exp := self.expires_at_mono) is None:
             return None
         else:
-            return max(0, self.expires_at - time())
+            return max(0, exp - monotonic())
 
     @property
     def expired(self) -> bool:
         """Whether the deadline has already expired"""
         return self.remaining == 0
```

### Comparing `distributed-2024.3.1/distributed/utils_comm.py` & `distributed-2024.4.0/distributed/utils_comm.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/utils_perf.py` & `distributed-2024.4.0/distributed/utils_perf.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/utils_test.py` & `distributed-2024.4.0/distributed/utils_test.py`

 * *Files 1% similar despite different names*

```diff
@@ -2392,14 +2392,38 @@
     try:
         yield locked_comm
     finally:
         write_event.set()
         bcomm.comm = orig_comm
 
 
+class BlockedInstantiateNanny(Nanny):
+    def __init__(self, *args, **kwargs):
+        super().__init__(*args, **kwargs)
+        self.in_instantiate = asyncio.Event()
+        self.wait_instantiate = asyncio.Event()
+
+    async def instantiate(self):
+        self.in_instantiate.set()
+        await self.wait_instantiate.wait()
+        return await super().instantiate()
+
+
+class BlockedKillNanny(Nanny):
+    def __init__(self, *args, **kwargs):
+        super().__init__(*args, **kwargs)
+        self.in_kill = asyncio.Event()
+        self.wait_kill = asyncio.Event()
+
+    async def kill(self, **kwargs):
+        self.in_kill.set()
+        await self.wait_kill.wait()
+        return await super().kill(**kwargs)
+
+
 async def wait_for_state(
     key: Key,
     state: str | Collection[str],
     dask_worker: Worker | Scheduler,
     *,
     interval: float = 0.01,
 ) -> None:
```

### Comparing `distributed-2024.3.1/distributed/variable.py` & `distributed-2024.4.0/distributed/variable.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/versions.py` & `distributed-2024.4.0/distributed/versions.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/widgets/templates/client.html.j2` & `distributed-2024.4.0/distributed/widgets/templates/client.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/widgets/templates/cluster.html.j2` & `distributed-2024.4.0/distributed/widgets/templates/cluster.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/widgets/templates/computation.html.j2` & `distributed-2024.4.0/distributed/widgets/templates/computation.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/widgets/templates/future.html.j2` & `distributed-2024.4.0/distributed/widgets/templates/future.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/widgets/templates/has_what.html.j2` & `distributed-2024.4.0/distributed/widgets/templates/has_what.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/widgets/templates/log.html.j2` & `distributed-2024.4.0/distributed/widgets/templates/log.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/widgets/templates/process_interface.html.j2` & `distributed-2024.4.0/distributed/widgets/templates/process_interface.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/widgets/templates/scheduler_info.html.j2` & `distributed-2024.4.0/distributed/widgets/templates/scheduler_info.html.j2`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/worker.py` & `distributed-2024.4.0/distributed/worker.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/worker_client.py` & `distributed-2024.4.0/distributed/worker_client.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/worker_memory.py` & `distributed-2024.4.0/distributed/worker_memory.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed/worker_state_machine.py` & `distributed-2024.4.0/distributed/worker_state_machine.py`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/distributed.egg-info/PKG-INFO` & `distributed-2024.4.0/distributed.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: distributed
-Version: 2024.3.1
+Version: 2024.4.0
 Summary: Distributed scheduler for Dask
 Maintainer-email: Matthew Rocklin <mrocklin@gmail.com>
 License: BSD-3-Clause
 Project-URL: Homepage, https://distributed.dask.org
 Project-URL: Source, https://github.com/dask/distributed
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Developers
@@ -22,15 +22,15 @@
 Classifier: Topic :: System :: Distributed Computing
 Requires-Python: >=3.9
 Description-Content-Type: text/x-rst
 License-File: LICENSE.txt
 License-File: AUTHORS.md
 Requires-Dist: click>=8.0
 Requires-Dist: cloudpickle>=1.5.0
-Requires-Dist: dask==2024.3.1
+Requires-Dist: dask==2024.4.0
 Requires-Dist: jinja2>=2.10.3
 Requires-Dist: locket>=1.0.0
 Requires-Dist: msgpack>=1.0.0
 Requires-Dist: packaging>=20.0
 Requires-Dist: psutil>=5.7.2
 Requires-Dist: pyyaml>=5.3.1
 Requires-Dist: sortedcontainers>=2.0.5
```

### Comparing `distributed-2024.3.1/distributed.egg-info/SOURCES.txt` & `distributed-2024.4.0/distributed.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/active_memory_manager.rst` & `distributed-2024.4.0/docs/source/active_memory_manager.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/actors.rst` & `distributed-2024.4.0/docs/source/actors.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/api.rst` & `distributed-2024.4.0/docs/source/api.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/asynchronous.rst` & `distributed-2024.4.0/docs/source/asynchronous.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/changelog.rst` & `distributed-2024.4.0/docs/source/changelog.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/client.rst` & `distributed-2024.4.0/docs/source/client.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/communications.rst` & `distributed-2024.4.0/docs/source/communications.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/develop.rst` & `distributed-2024.4.0/docs/source/develop.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/diagnosing-performance.rst` & `distributed-2024.4.0/docs/source/diagnosing-performance.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/efficiency.rst` & `distributed-2024.4.0/docs/source/efficiency.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/examples/word-count.rst` & `distributed-2024.4.0/docs/source/examples/word-count.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/faq.rst` & `distributed-2024.4.0/docs/source/faq.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/fine-performance-metrics.rst` & `distributed-2024.4.0/docs/source/fine-performance-metrics.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/foundations.rst` & `distributed-2024.4.0/docs/source/foundations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/http_services.rst` & `distributed-2024.4.0/docs/source/http_services.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/index.rst` & `distributed-2024.4.0/docs/source/index.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/install.rst` & `distributed-2024.4.0/docs/source/install.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/journey.rst` & `distributed-2024.4.0/docs/source/journey.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/killed.rst` & `distributed-2024.4.0/docs/source/killed.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/limitations.rst` & `distributed-2024.4.0/docs/source/limitations.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/locality.rst` & `distributed-2024.4.0/docs/source/locality.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/logging.rst` & `distributed-2024.4.0/docs/source/logging.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/manage-computation.rst` & `distributed-2024.4.0/docs/source/manage-computation.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/memory.rst` & `distributed-2024.4.0/docs/source/memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/plugins.rst` & `distributed-2024.4.0/docs/source/plugins.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/priority.rst` & `distributed-2024.4.0/docs/source/priority.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/prometheus.rst` & `distributed-2024.4.0/docs/source/prometheus.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/protocol.rst` & `distributed-2024.4.0/docs/source/protocol.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/publish.rst` & `distributed-2024.4.0/docs/source/publish.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/quickstart.rst` & `distributed-2024.4.0/docs/source/quickstart.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/related-work.rst` & `distributed-2024.4.0/docs/source/related-work.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/resilience.rst` & `distributed-2024.4.0/docs/source/resilience.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/resources.rst` & `distributed-2024.4.0/docs/source/resources.rst`

 * *Files 23% similar despite different names*

```diff
@@ -139,23 +139,53 @@
 It's worth noting that Dask separately track number of cores and available
 memory as actual resources and uses these in normal scheduling operation.
 
 
 Resources with collections
 --------------------------
 
-You can also use resources with Dask collections, like arrays, dataframes, and
-delayed objects. You can annotate operations on collections with specific resources
-that should be required perform the computation using the dask annotations machinery.
+You can also use resources with Dask collections, like arrays and delayed objects. You
+can annotate operations on collections with specific resources that should be required
+to perform the computation using the dask annotations machinery.
 
 .. code-block:: python
 
-    x = dd.read_csv(...)
+    # Read note below!
+    dask.config.set({"optimization.fuse.active": False})
+    x = da.read_zarr(...)
     with dask.annotate(resources={'GPU': 1}):
-        y = x.map_partitions(func1)
-    z = y.map_partitions(func2)
+        y = x.map_blocks(func1)
+    z = y.map_blocks(func2)
+    z.compute()
 
-    z.compute(optimize_graph=False)
+.. note::
 
-In most cases (such as the case above) the annotations for ``y`` may be lost during
-graph optimization before execution. You can avoid that by passing the
-``optimize_graph=False`` keyword.
+    This feature is currently supported for dataframes only when
+    ``with dask.annotate(...):`` wraps the `compute()` or `persist()` call; in that
+    case, the annotation applies to the whole graph, starting from and excluding
+    any previously persisted collections.
+
+    For other collections, like arrays and delayed objects, annotations can get lost
+    during the optimization phase. To prevent this issue, you must set:
+
+    >>> dask.config.set({"optimization.fuse.active": False})
+
+    Or in dask.yaml:
+
+    .. code-block:: yaml
+
+        optimization:
+          fuse:
+            active: false
+
+    A possible workaround, that also works for dataframes, can be to perform
+    intermediate calls to `persist()`. Note however that this can significantly
+    impact optimizations and reduce overall performance.
+
+    .. code-block:: python
+
+        x = dd.read_parquet(...)
+        with dask.annotate(resources={'GPU': 1}):
+            y = x.map_partitions(func1).persist()
+        z = y.map_partitions(func2)
+        del y  # Release distributed memory for y as soon as possible
+        z.compute()
```

### Comparing `distributed-2024.3.1/docs/source/scheduling-policies.rst` & `distributed-2024.4.0/docs/source/scheduling-policies.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/scheduling-state.rst` & `distributed-2024.4.0/docs/source/scheduling-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/serialization.rst` & `distributed-2024.4.0/docs/source/serialization.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/spans.rst` & `distributed-2024.4.0/docs/source/spans.rst`

 * *Files 14% similar despite different names*

```diff
@@ -22,31 +22,29 @@
 To do so, you should use the :func:`span` context manager inside the client code.
 
 For example:
 
 .. code-block:: python
 
     import dask.config
-    import dask.dataframe as dd
+    import dask.array as da
     from distributed import Client, span
 
+    # Read important note below
     dask.config.set({"optimization.fuse.active": False})
     client = Client()
 
     with span("Alice's workflow"):
         with span("data load"):
-            df = dd.read_parquet(...)
-
+            a = da.read_zarr(...)
         with span("ML preprocessing"):
-            df = preprocess(df)
-
+            a = preprocess(a)
         with span("Model training"):
-            model = train(df)
-
-    model = model.compute()
+            model = train(a)
+        model = model.compute()
 
 Note how the :func:`span` context manager can be nested.
 The example will create the following spans on the scheduler:
 
 - ``("Alice's workflow", )``
 - ``("Alice's workflow", "data load")``
 - ``("Alice's workflow", "ML preprocessing")``
@@ -91,29 +89,52 @@
 
 Additionally, spans can be queried using scheduler extensions or
 :meth:`~distributed.Client.run_on_scheduler`; see :ref:`spans_developer_api`.
 
 
 User API
 --------
-.. warning::
+.. important::
 
-    Spans are based on annotations, and just like annotations they can be lost during
-    optimization. To prevent this issue, you must set
+    Dataframes have a minimum granularity of a single call to `compute()` or `persist()`
+    and can't break it down further into groups of operations - if the example above
+    used dataframes, everything would have been uniformly tagged as "Alice's Workflow",
+    as it is the span that's active during `compute()`.
+
+    In other collections, such as arrays and delayed objects, spans that don't wrap
+    around a call to `compute()` or `persist()` can get lost during the optimization
+    phase. To prevent this issue, you must set
 
     >>> dask.config.set({"optimization.fuse.active": False})
 
     Or in dask.yaml:
 
     .. code-block:: yaml
 
         optimization:
           fuse:
             active: false
 
+    A possible workaround, that also works for dataframes, can be to perform
+    intermediate calls to `persist()`. Note however that this can significantly
+    impact optimizations and reduce overall performance.
+
+    .. code-block:: python
+
+        with span("Alice's workflow"):
+            with span("data load"):
+                a = dd.read_parquet(...).persist()
+            with span("ML preprocessing"):
+                a = preprocess(a).persist()
+                del a  # Release distributed memory for a as soon as possible
+            with span("Model training"):
+                model = train(b).persist()
+                del b  # Release distributed memory for b as soon as possible
+                model = model.compute()
+
 .. autofunction:: span
 
 
 .. _spans_developer_api:
 
 Dask Developer API
 ------------------
```

### Comparing `distributed-2024.3.1/docs/source/task-launch.rst` & `distributed-2024.4.0/docs/source/task-launch.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/tls.rst` & `distributed-2024.4.0/docs/source/tls.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/work-stealing.rst` & `distributed-2024.4.0/docs/source/work-stealing.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/worker-memory.rst` & `distributed-2024.4.0/docs/source/worker-memory.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/worker-state.rst` & `distributed-2024.4.0/docs/source/worker-state.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/docs/source/worker.rst` & `distributed-2024.4.0/docs/source/worker.rst`

 * *Files identical despite different names*

### Comparing `distributed-2024.3.1/pyproject.toml` & `distributed-2024.4.0/pyproject.toml`

 * *Files 0% similar despite different names*

```diff
@@ -24,15 +24,15 @@
     "Topic :: System :: Distributed Computing",
 ]
 readme = "README.rst"
 requires-python = ">=3.9"
 dependencies = [
     "click >= 8.0",
     "cloudpickle >= 1.5.0",
-    "dask == 2024.3.1",
+    "dask == 2024.4.0",
     "jinja2 >= 2.10.3",
     "locket >= 1.0.0",
     "msgpack >= 1.0.0",
     "packaging >= 20.0",
     "psutil >= 5.7.2",
     "pyyaml >= 5.3.1",
     "sortedcontainers >= 2.0.5",
```

